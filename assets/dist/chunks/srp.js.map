{"version":3,"file":"srp.js","sources":["../../src/modules/srp.ts"],"sourcesContent":["import { module, useHttpClient, useUniDirective } from '@windwalker-io/unicorn-next';\r\nimport type { SRPOptions } from '../types/srp';\r\n\r\nconst defaultOptions: SRPOptions = {\r\n  identitySelector: '[data-input-identity]',\r\n  passwordSelector: '[data-input-password]',\r\n  prime: undefined,\r\n  generator: undefined,\r\n  key: undefined,\r\n  size: 256,\r\n  hasher: 'sha256'\r\n};\r\n\r\nclass SRPRegistration {\r\n  identityInput: HTMLInputElement | null;\r\n  passwordInput: HTMLInputElement | null;\r\n  // saltInput: HTMLInputElement;\r\n  // verifierInput: HTMLInputElement;\r\n  options: SRPOptions;\r\n\r\n  public submitting = false;\r\n  public disabledInputs: HTMLInputElement[] = [];\r\n\r\n  constructor(public el: HTMLFormElement, options: Partial<SRPOptions> = {}) {\r\n    this.options = Object.assign({}, defaultOptions, options);\r\n    this.identityInput = this.el.querySelector(this.options.identitySelector);\r\n    this.passwordInput = this.el.querySelector(this.options.passwordSelector);\r\n\r\n    this.init();\r\n  }\r\n\r\n  init() {\r\n    if (!this.identityInput || !this.passwordInput) {\r\n      throw new Error('Identity or password input not found.');\r\n    }\r\n\r\n    this.el.addEventListener('submit', async (e) => {\r\n      if (!this.submitting) {\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n        e.stopImmediatePropagation();\r\n\r\n        await this.register();\r\n\r\n        this.disablePasswords();\r\n\r\n        this.submitting = true;\r\n\r\n        this.el.requestSubmit();\r\n\r\n        return;\r\n      }\r\n    });\r\n\r\n    this.el.addEventListener('invalid', () => {\r\n      this.release();\r\n    }, true);\r\n  }\r\n\r\n  release() {\r\n    this.submitting = false;\r\n\r\n    for (const disabledInput of this.disabledInputs) {\r\n      disabledInput.disabled = false;\r\n    }\r\n  }\r\n\r\n  getPasswordInputs() {\r\n    return [\r\n      this.passwordInput,\r\n      ...this.el.querySelectorAll<HTMLInputElement>('[data-srp-override]')\r\n    ];\r\n  }\r\n\r\n  disablePasswords() {\r\n    this.disabledInputs = [];\r\n\r\n    for (const input of this.getPasswordInputs()) {\r\n      if (input && input.value && !input.disabled) {\r\n        input.disabled = true;\r\n\r\n        this.disabledInputs.push(input);\r\n\r\n        setTimeout(() => {\r\n          input.disabled = false;\r\n        }, 1000);\r\n      }\r\n    }\r\n  }\r\n\r\n  createClient(): InstanceType<typeof SRPClient> {\r\n    const client = SRPClient.create(\r\n      this.options.prime,\r\n      this.options.generator,\r\n      this.options.key,\r\n    );\r\n\r\n    client.setSize(this.options.size);\r\n    client.setHasher(this.options?.hasher);\r\n\r\n    return client;\r\n  }\r\n\r\n  async register() {\r\n    const client = this.createClient();\r\n\r\n    const identity = this.identityInput?.value;\r\n    const password = this.passwordInput?.value;\r\n\r\n    if (!identity || !password) {\r\n      this.getHiddenInput('srp[salt]').value = '';\r\n      this.getHiddenInput('srp[verifier]').value = '';\r\n      return;\r\n    }\r\n\r\n    let { salt, verifier } = await client.register(identity, password);\r\n\r\n    const saltInput = this.getHiddenInput('srp[salt]');\r\n    saltInput.value = salt.toString(16);\r\n\r\n    const verifierInput = this.getHiddenInput('srp[verifier]');\r\n    verifierInput.value = verifier.toString(16);\r\n  }\r\n\r\n  getHiddenInput(name: string) {\r\n    return this.el.querySelector<HTMLInputElement>(`[name=\"${name}\"]`)\r\n      || this.createHiddenInput(name);\r\n  }\r\n\r\n  createHiddenInput(name: string) {\r\n    const input = document.createElement('input');\r\n\r\n    input.type = 'hidden';\r\n    input.name = name;\r\n\r\n    this.el.appendChild(input);\r\n\r\n    return input;\r\n  }\r\n}\r\n\r\nclass SRPLogin {\r\n  identityInput: HTMLInputElement | null;\r\n  passwordInput: HTMLInputElement | null;\r\n  // saltInput: HTMLInputElement | null;\r\n  // verifierInput: HTMLInputElement | null;\r\n\r\n  public fallback = false;\r\n  public submitting = false;\r\n  public submitter: HTMLButtonElement | null = null;\r\n\r\n  public disabledInputs: HTMLInputElement[] = [];\r\n  options: SRPOptions;\r\n\r\n  constructor(public el: HTMLFormElement, options: Partial<SRPOptions> = {}) {\r\n    this.options = Object.assign({}, defaultOptions, options);\r\n\r\n    this.identityInput = this.el.querySelector(this.options.identitySelector);\r\n    this.passwordInput = this.el.querySelector(this.options.passwordSelector);\r\n\r\n    this.init();\r\n  }\r\n\r\n  init() {\r\n    if (!this.identityInput || !this.passwordInput) {\r\n      throw new Error('Identity or password input not found.');\r\n    }\r\n\r\n    this.el.addEventListener('submit', async (e) => {\r\n      this.submitter = e.submitter as HTMLButtonElement;\r\n\r\n      if (!this.submitting) {\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n        e.stopImmediatePropagation();\r\n\r\n        try {\r\n          await this.auth();\r\n        } catch (e) {\r\n          console.warn(e);\r\n        }\r\n\r\n        if (!this.fallback) {\r\n          this.disablePasswords();\r\n        }\r\n\r\n        this.submitting = true;\r\n\r\n        this.el.requestSubmit();\r\n\r\n        return;\r\n      }\r\n    });\r\n\r\n    this.el.addEventListener('invalid', () => {\r\n      this.release();\r\n    }, true);\r\n  }\r\n\r\n  release() {\r\n    if (this.submitter) {\r\n      this.submitter.disabled = false;\r\n    }\r\n\r\n    this.submitting = false;\r\n    this.fallback = false;\r\n    this.getHiddenInput('srp[M2]').value = '';\r\n\r\n    for (const disabledInput of this.disabledInputs) {\r\n      disabledInput.disabled = false;\r\n    }\r\n  }\r\n\r\n  async auth() {\r\n    if (!this.identityInput?.value || !this.passwordInput?.value) {\r\n      return;\r\n    }\r\n\r\n    if (this.submitter) {\r\n      this.submitter.disabled = true;\r\n    }\r\n\r\n    const identity = this.identityInput.value;\r\n    const password = this.passwordInput.value;\r\n\r\n    const client = this.createClient();\r\n    const { get, post } = await useHttpClient();\r\n\r\n    // Challenge\r\n    const res = await get(\r\n      '@auth_ajax/srpChallenge{?identity}',\r\n      {\r\n        vars: {\r\n          identity\r\n        }\r\n      }\r\n    );\r\n\r\n    const r = res.data.data;\r\n\r\n    if (r == null) {\r\n      return;\r\n    }\r\n\r\n    this.fallback = !!r.fallback;\r\n    this.getHiddenInput('srp[fallback]').value = this.fallback ? '1' : '0';\r\n\r\n    if (this.fallback) {\r\n      return;\r\n    }\r\n\r\n    let { salt, B } = r;\r\n\r\n    // Step1\r\n    salt = hexToBigint(salt);\r\n    B = hexToBigint(B);\r\n\r\n    // Step 1\r\n    const a = await client.generateRandomSecret();\r\n    const A = await client.generatePublic(a);\r\n    const x = await client.generatePasswordHash(salt, identity, password);\r\n\r\n    // Step 2\r\n    const u = await client.generateCommonSecret(A, B);\r\n    const S = await client.generatePreMasterSecret(a, B, x, u);\r\n    const K = await client.hash(S);\r\n    const M1 = await client.generateClientSessionProof(identity, salt, A, B, K);\r\n\r\n    const res2 = await post(\r\n      '@auth_ajax/srpAuthenticate',\r\n      {\r\n        identity,\r\n        A: A.toString(16),\r\n        M1: M1.toString(16)\r\n      }\r\n    );\r\n\r\n    const { proof } = res2.data.data;\r\n\r\n    const M2 = await client.generateServerSessionProof(A, M1, K);\r\n\r\n    if (M2 !== hexToBigint(proof)) {\r\n      // Just return\r\n      return;\r\n    }\r\n\r\n    this.getHiddenInput('srp[M2]').value = M2.toString(16);\r\n  }\r\n\r\n  getPasswordInputs() {\r\n    return [\r\n      this.passwordInput,\r\n      ...this.el.querySelectorAll<HTMLInputElement>('[data-srp-override]')\r\n    ];\r\n  }\r\n\r\n  disablePasswords() {\r\n    this.disabledInputs = [];\r\n\r\n    for (const input of this.getPasswordInputs()) {\r\n      if (input && input.value && !input.disabled) {\r\n        input.disabled = true;\r\n\r\n        this.disabledInputs.push(input);\r\n\r\n        setTimeout(() => {\r\n          input.disabled = false;\r\n        }, 1000);\r\n      }\r\n    }\r\n  }\r\n\r\n  createClient(): InstanceType<typeof SRPClient> {\r\n    const client = SRPClient.create(\r\n      this.options.prime,\r\n      this.options.generator,\r\n      this.options.key,\r\n    );\r\n\r\n    client.setSize(this.options.size);\r\n    client.setHasher(this.options.hasher);\r\n\r\n    return client;\r\n  }\r\n\r\n  getHiddenInput(name: string) {\r\n    return this.el.querySelector<HTMLInputElement>(`[name=\"${name}\"]`)\r\n      || this.createHiddenInput(name);\r\n  }\r\n\r\n  createHiddenInput(name: string) {\r\n    const input = document.createElement('input');\r\n\r\n    input.type = 'hidden';\r\n    input.name = name;\r\n\r\n    this.el.appendChild(input);\r\n\r\n    return input;\r\n  }\r\n}\r\n\r\nfunction hexToBigint(hex: string) {\r\n  return BigInt(`0x${hex}`);\r\n}\r\n\r\nuseUniDirective('srp-registration', {\r\n  mounted(el, { value }) {\r\n    const options = JSON.parse(value);\r\n    module(\r\n      el,\r\n      'srp.registration',\r\n      (el) => new SRPRegistration(el as HTMLFormElement, options)\r\n    );\r\n  }\r\n});\r\n\r\nuseUniDirective('srp-login', {\r\n  mounted(el, { value }) {\r\n    const options = JSON.parse(value);\r\n    module(\r\n      el,\r\n      'srp.login',\r\n      (el) => new SRPLogin(el as HTMLFormElement, options)\r\n    );\r\n  }\r\n});\r\n"],"names":["e","module","el"],"mappings":"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"}