import { watch, getCurrentScope, onScopeDispose, customRef, computed, toValue, getCurrentInstance, onUpdated, onMounted, unref, defineComponent, mergeModels, useModel, ref, resolveDirective, createElementBlock, openBlock, createCommentVNode, createTextVNode, createElementVNode, withDirectives, vModelText, withModifiers } from "vue";
import { route, useSystemUri, useHttpClient, simpleAlert } from "@windwalker-io/unicorn-next";
import { _ as _export_sfc } from "./SliderInput.js";
function computedWithControl(source, fn, options = {}) {
  let v = void 0;
  let track;
  let trigger;
  let dirty = true;
  const update = () => {
    dirty = true;
    trigger();
  };
  watch(source, update, { flush: "sync", ...options });
  const get = typeof fn === "function" ? fn : fn.get;
  const set = typeof fn === "function" ? void 0 : fn.set;
  const result = customRef((_track, _trigger) => {
    track = _track;
    trigger = _trigger;
    return {
      get() {
        if (dirty) {
          v = get(v);
          dirty = false;
        }
        track();
        return v;
      },
      set(v2) {
        set == null ? void 0 : set(v2);
      }
    };
  });
  result.trigger = update;
  return result;
}
function tryOnScopeDispose(fn) {
  if (getCurrentScope()) {
    onScopeDispose(fn);
    return true;
  }
  return false;
}
const isClient = typeof window !== "undefined" && typeof document !== "undefined";
typeof WorkerGlobalScope !== "undefined" && globalThis instanceof WorkerGlobalScope;
const toString = Object.prototype.toString;
const isObject = (val) => toString.call(val) === "[object Object]";
function toArray(value) {
  return Array.isArray(value) ? value : [value];
}
function watchImmediate(source, cb, options) {
  return watch(
    source,
    cb,
    {
      ...options,
      immediate: true
    }
  );
}
const defaultWindow = isClient ? window : void 0;
function unrefElement(elRef) {
  var _a;
  const plain = toValue(elRef);
  return (_a = plain == null ? void 0 : plain.$el) != null ? _a : plain;
}
function useEventListener(...args) {
  const cleanups = [];
  const cleanup = () => {
    cleanups.forEach((fn) => fn());
    cleanups.length = 0;
  };
  const register = (el, event, listener, options) => {
    el.addEventListener(event, listener, options);
    return () => el.removeEventListener(event, listener, options);
  };
  const firstParamTargets = computed(() => {
    const test = toArray(toValue(args[0])).filter((e) => e != null);
    return test.every((e) => typeof e !== "string") ? test : void 0;
  });
  const stopWatch = watchImmediate(
    () => {
      var _a, _b;
      return [
        (_b = (_a = firstParamTargets.value) == null ? void 0 : _a.map((e) => unrefElement(e))) != null ? _b : [defaultWindow].filter((e) => e != null),
        toArray(toValue(firstParamTargets.value ? args[1] : args[0])),
        toArray(unref(firstParamTargets.value ? args[2] : args[1])),
        // @ts-expect-error - TypeScript gets the correct types, but somehow still complains
        toValue(firstParamTargets.value ? args[3] : args[2])
      ];
    },
    ([raw_targets, raw_events, raw_listeners, raw_options]) => {
      cleanup();
      if (!(raw_targets == null ? void 0 : raw_targets.length) || !(raw_events == null ? void 0 : raw_events.length) || !(raw_listeners == null ? void 0 : raw_listeners.length))
        return;
      const optionsClone = isObject(raw_options) ? { ...raw_options } : raw_options;
      cleanups.push(
        ...raw_targets.flatMap(
          (el) => raw_events.flatMap(
            (event) => raw_listeners.map((listener) => register(el, event, listener, optionsClone))
          )
        )
      );
    },
    { flush: "post" }
  );
  const stop = () => {
    stopWatch();
    cleanup();
  };
  tryOnScopeDispose(cleanup);
  return stop;
}
function useCurrentElement(rootComponent) {
  const vm = getCurrentInstance();
  const currentElement = computedWithControl(
    () => null,
    () => vm.proxy.$el
  );
  onUpdated(currentElement.trigger);
  onMounted(currentElement.trigger);
  return currentElement;
}
const _sfc_main = /* @__PURE__ */ defineComponent({
  __name: "SingleImage",
  props: /* @__PURE__ */ mergeModels({
    id: {},
    accepted: { default: () => [
      "image/jpeg",
      "image/png",
      "image/gif",
      "image/webp",
      "image/svg",
      "image/svg+xml",
      "image/avif"
    ] }
  }, {
    "modelValue": {
      required: false,
      default: ""
    },
    "modelModifiers": {}
  }),
  emits: ["update:modelValue"],
  setup(__props, { expose: __expose }) {
    __expose();
    const props = __props;
    const url = useModel(__props, "modelValue");
    const loadingImage = ref(route("loading_image"));
    const uploading = ref(false);
    const el = useCurrentElement();
    const accepted = computed(() => props.accepted);
    const uri = useSystemUri();
    onMounted(() => {
      if (!el.value) {
        return;
      }
      el.value.addEventListener("dragover", (event) => {
        event.stopPropagation();
        event.preventDefault();
        el.value.classList.add("c-single-image-uploader--hover");
      });
      el.value.addEventListener("dragleave", (event) => {
        event.stopPropagation();
        event.preventDefault();
        el.value.classList.remove("c-single-image-uploader--hover");
      });
      el.value.addEventListener("drop", (event) => {
        event.stopPropagation();
        event.preventDefault();
        el.value.classList.remove("c-single-image-uploader--hover");
        const files = event.target.files || event.dataTransfer.files;
        uploadFile(files[0]);
      });
    });
    function chooseFile() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = accepted.value.join(",");
      input.style.display = "none";
      input.addEventListener("change", (event) => {
        const files = input.files || event.dataTransfer.files;
        uploadFile(files[0]);
      });
      el.value?.appendChild(input);
      input.click();
      setTimeout(() => {
        input.parentNode?.removeChild(input);
      }, 1e3);
    }
    async function pasteFromButton() {
      try {
        let items = await navigator.clipboard.read();
        const type = items[0].types[1];
        let blob = await items[0].getType(type);
        await uploadFile(new File([blob], "image.png", { type: blob.type }));
      } catch (e) {
        console.warn("Unable to paste this data");
        console.warn(e);
      }
    }
    function pasteFile(event) {
      if (event.clipboardData?.items[0] && event.clipboardData.items[0].kind === "file") {
        event.preventDefault();
        event.stopPropagation();
        const item = event.clipboardData.items[0];
        if (!item) {
          console.error("No paste item");
          return;
        }
        uploadFile(item.getAsFile());
      }
    }
    async function uploadFile(file) {
      if (!checkFile(file)) {
        return;
      }
      const formData = new FormData();
      formData.append("file", file);
      uploading.value = true;
      const { post, isAxiosError } = await useHttpClient();
      try {
        let res = await post("@file_upload", formData);
        let fileUrl = res.data.data.url;
        if (fileUrl.includes(uri.root())) {
          fileUrl = fileUrl.substring(uri.root().length);
        }
        url.value = fileUrl;
      } catch (e) {
        if (isAxiosError(e)) {
          simpleAlert(e.message);
        }
        console.error(e);
      } finally {
        uploading.value = false;
      }
    }
    function checkFile(file) {
      if (accepted.value.indexOf(file.type) < 0) {
        alert("Invalid file format");
        return false;
      }
      return true;
    }
    function clearUrl() {
      url.value = "";
    }
    const previewUrl = computed(() => {
      let fileUrl = url.value;
      if (!fileUrl) {
        return fileUrl;
      }
      if (fileUrl.indexOf("http") !== 0 && fileUrl.indexOf("/") !== 0) {
        return uri.root(fileUrl);
      }
      return fileUrl;
    });
    const __returned__ = { props, url, loadingImage, uploading, el, accepted, uri, chooseFile, pasteFromButton, pasteFile, uploadFile, checkFile, clearUrl, previewUrl };
    Object.defineProperty(__returned__, "__isScriptSetup", { enumerable: false, value: true });
    return __returned__;
  }
});
const _hoisted_1 = {
  ref: "el",
  class: "c-single-image-uploader"
};
const _hoisted_2 = {
  key: 0,
  class: "form-group mb-3 c-single-image-preview text-center"
};
const _hoisted_3 = ["src"];
const _hoisted_4 = {
  key: 1,
  class: "c-single-image-placeholder text-center p-4 mb-3 border rounded"
};
const _hoisted_5 = {
  key: 2,
  class: "form-group mb-3 d-flex align-items-center justify-content-center",
  style: { "min-height": "450px" }
};
const _hoisted_6 = { class: "form-group mb-3" };
const _hoisted_7 = { class: "input-group" };
const _hoisted_8 = ["id", "disabled"];
const _hoisted_9 = ["disabled"];
const _hoisted_10 = ["disabled"];
const _hoisted_11 = ["disabled"];
function _sfc_render(_ctx, _cache, $props, $setup, $data, $options) {
  const _directive_tooltip = resolveDirective("tooltip");
  return openBlock(), createElementBlock("div", _hoisted_1, [
    $setup.url !== "" && !$setup.uploading ? (openBlock(), createElementBlock("div", _hoisted_2, [
      createElementVNode("img", {
        src: $setup.previewUrl,
        alt: "Image",
        class: "img-fluid rounded",
        style: { "max-height": "450px" }
      }, null, 8, _hoisted_3)
    ])) : createCommentVNode("", true),
    _cache[12] || (_cache[12] = createTextVNode()),
    $setup.url === "" && !$setup.uploading ? (openBlock(), createElementBlock("div", _hoisted_4, [..._cache[2] || (_cache[2] = [
      createElementVNode("small", { class: "text-muted" }, "Drag Image Here", -1)
    ])])) : createCommentVNode("", true),
    _cache[13] || (_cache[13] = createTextVNode()),
    $setup.uploading ? (openBlock(), createElementBlock("div", _hoisted_5, [..._cache[3] || (_cache[3] = [
      createElementVNode("div", { class: "spinner-border" }, null, -1)
    ])])) : createCommentVNode("", true),
    _cache[14] || (_cache[14] = createTextVNode()),
    createElementVNode("div", _hoisted_6, [
      createElementVNode("div", _hoisted_7, [
        withDirectives(createElementVNode("input", {
          id: $props.id,
          type: "text",
          "onUpdate:modelValue": _cache[0] || (_cache[0] = ($event) => $setup.url = $event),
          class: "form-control",
          disabled: $setup.uploading,
          onPaste: $setup.pasteFile
        }, null, 40, _hoisted_8), [
          [vModelText, $setup.url]
        ]),
        _cache[7] || (_cache[7] = createTextVNode()),
        createElementVNode("button", {
          type: "button",
          class: "btn btn-primary",
          onClick: _cache[1] || (_cache[1] = ($event) => $setup.chooseFile()),
          disabled: $setup.uploading
        }, [..._cache[4] || (_cache[4] = [
          createElementVNode("i", { class: "fa fa-upload" }, null, -1),
          createTextVNode("\n          Upload\n        ", -1)
        ])], 8, _hoisted_9),
        _cache[8] || (_cache[8] = createTextVNode()),
        withDirectives((openBlock(), createElementBlock("button", {
          type: "button",
          class: "btn btn-primary",
          onClick: $setup.pasteFromButton,
          disabled: $setup.uploading,
          title: "Paste"
        }, [..._cache[5] || (_cache[5] = [
          createElementVNode("span", { class: "fa fa-paste" }, null, -1)
        ])], 8, _hoisted_10)), [
          [_directive_tooltip]
        ]),
        _cache[9] || (_cache[9] = createTextVNode()),
        $setup.url !== "" ? (openBlock(), createElementBlock("button", {
          key: 0,
          type: "button",
          class: "btn btn-primary",
          onClick: withModifiers($setup.clearUrl, ["stop"]),
          disabled: $setup.uploading
        }, [..._cache[6] || (_cache[6] = [
          createElementVNode("span", { class: "fa fa-times" }, null, -1)
        ])], 8, _hoisted_11)) : createCommentVNode("", true)
      ]),
      _cache[10] || (_cache[10] = createTextVNode()),
      _cache[11] || (_cache[11] = createElementVNode("small", { class: "form-text text-muted" }, "\n        Paste image url/file or drag and upload image here.\n      ", -1))
    ])
  ], 512);
}
const SingleImage = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render], ["__file", "SingleImage.vue"]]);
export {
  SingleImage as S,
  useEventListener as u
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2luZ2xlSW1hZ2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uL25vZGVfbW9kdWxlcy9AdnVldXNlL3NoYXJlZC9pbmRleC5tanMiLCIuLi8uLi9ub2RlX21vZHVsZXMvQHZ1ZXVzZS9jb3JlL2luZGV4Lm1qcyIsIi4uLy4uL3NyYy9jb21wb25lbnRzL3BhZ2UtYnVpbGRlci9mb3JtL1NpbmdsZUltYWdlLnZ1ZSJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzaGFsbG93UmVmLCB3YXRjaEVmZmVjdCwgcmVhZG9ubHksIHdhdGNoLCBjdXN0b21SZWYsIGdldEN1cnJlbnRTY29wZSwgb25TY29wZURpc3Bvc2UsIGVmZmVjdFNjb3BlLCBnZXRDdXJyZW50SW5zdGFuY2UsIGhhc0luamVjdGlvbkNvbnRleHQsIGluamVjdCwgcHJvdmlkZSwgcmVmLCBpc1JlZiwgdW5yZWYsIHRvVmFsdWUgYXMgdG9WYWx1ZSQxLCBjb21wdXRlZCwgcmVhY3RpdmUsIHRvUmVmcyBhcyB0b1JlZnMkMSwgdG9SZWYgYXMgdG9SZWYkMSwgc2hhbGxvd1JlYWRvbmx5LCBvbkJlZm9yZU1vdW50LCBuZXh0VGljaywgb25CZWZvcmVVbm1vdW50LCBvbk1vdW50ZWQsIG9uVW5tb3VudGVkLCBpc1JlYWN0aXZlIH0gZnJvbSAndnVlJztcblxuZnVuY3Rpb24gY29tcHV0ZWRFYWdlcihmbiwgb3B0aW9ucykge1xuICB2YXIgX2E7XG4gIGNvbnN0IHJlc3VsdCA9IHNoYWxsb3dSZWYoKTtcbiAgd2F0Y2hFZmZlY3QoKCkgPT4ge1xuICAgIHJlc3VsdC52YWx1ZSA9IGZuKCk7XG4gIH0sIHtcbiAgICAuLi5vcHRpb25zLFxuICAgIGZsdXNoOiAoX2EgPSBvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLmZsdXNoKSAhPSBudWxsID8gX2EgOiBcInN5bmNcIlxuICB9KTtcbiAgcmV0dXJuIHJlYWRvbmx5KHJlc3VsdCk7XG59XG5cbmZ1bmN0aW9uIGNvbXB1dGVkV2l0aENvbnRyb2woc291cmNlLCBmbiwgb3B0aW9ucyA9IHt9KSB7XG4gIGxldCB2ID0gdm9pZCAwO1xuICBsZXQgdHJhY2s7XG4gIGxldCB0cmlnZ2VyO1xuICBsZXQgZGlydHkgPSB0cnVlO1xuICBjb25zdCB1cGRhdGUgPSAoKSA9PiB7XG4gICAgZGlydHkgPSB0cnVlO1xuICAgIHRyaWdnZXIoKTtcbiAgfTtcbiAgd2F0Y2goc291cmNlLCB1cGRhdGUsIHsgZmx1c2g6IFwic3luY1wiLCAuLi5vcHRpb25zIH0pO1xuICBjb25zdCBnZXQgPSB0eXBlb2YgZm4gPT09IFwiZnVuY3Rpb25cIiA/IGZuIDogZm4uZ2V0O1xuICBjb25zdCBzZXQgPSB0eXBlb2YgZm4gPT09IFwiZnVuY3Rpb25cIiA/IHZvaWQgMCA6IGZuLnNldDtcbiAgY29uc3QgcmVzdWx0ID0gY3VzdG9tUmVmKChfdHJhY2ssIF90cmlnZ2VyKSA9PiB7XG4gICAgdHJhY2sgPSBfdHJhY2s7XG4gICAgdHJpZ2dlciA9IF90cmlnZ2VyO1xuICAgIHJldHVybiB7XG4gICAgICBnZXQoKSB7XG4gICAgICAgIGlmIChkaXJ0eSkge1xuICAgICAgICAgIHYgPSBnZXQodik7XG4gICAgICAgICAgZGlydHkgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB0cmFjaygpO1xuICAgICAgICByZXR1cm4gdjtcbiAgICAgIH0sXG4gICAgICBzZXQodjIpIHtcbiAgICAgICAgc2V0ID09IG51bGwgPyB2b2lkIDAgOiBzZXQodjIpO1xuICAgICAgfVxuICAgIH07XG4gIH0pO1xuICByZXN1bHQudHJpZ2dlciA9IHVwZGF0ZTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gdHJ5T25TY29wZURpc3Bvc2UoZm4pIHtcbiAgaWYgKGdldEN1cnJlbnRTY29wZSgpKSB7XG4gICAgb25TY29wZURpc3Bvc2UoZm4pO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIGNyZWF0ZUV2ZW50SG9vaygpIHtcbiAgY29uc3QgZm5zID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTtcbiAgY29uc3Qgb2ZmID0gKGZuKSA9PiB7XG4gICAgZm5zLmRlbGV0ZShmbik7XG4gIH07XG4gIGNvbnN0IGNsZWFyID0gKCkgPT4ge1xuICAgIGZucy5jbGVhcigpO1xuICB9O1xuICBjb25zdCBvbiA9IChmbikgPT4ge1xuICAgIGZucy5hZGQoZm4pO1xuICAgIGNvbnN0IG9mZkZuID0gKCkgPT4gb2ZmKGZuKTtcbiAgICB0cnlPblNjb3BlRGlzcG9zZShvZmZGbik7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9mZjogb2ZmRm5cbiAgICB9O1xuICB9O1xuICBjb25zdCB0cmlnZ2VyID0gKC4uLmFyZ3MpID0+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoQXJyYXkuZnJvbShmbnMpLm1hcCgoZm4pID0+IGZuKC4uLmFyZ3MpKSk7XG4gIH07XG4gIHJldHVybiB7XG4gICAgb24sXG4gICAgb2ZmLFxuICAgIHRyaWdnZXIsXG4gICAgY2xlYXJcbiAgfTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIGNyZWF0ZUdsb2JhbFN0YXRlKHN0YXRlRmFjdG9yeSkge1xuICBsZXQgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgbGV0IHN0YXRlO1xuICBjb25zdCBzY29wZSA9IGVmZmVjdFNjb3BlKHRydWUpO1xuICByZXR1cm4gKC4uLmFyZ3MpID0+IHtcbiAgICBpZiAoIWluaXRpYWxpemVkKSB7XG4gICAgICBzdGF0ZSA9IHNjb3BlLnJ1bigoKSA9PiBzdGF0ZUZhY3RvcnkoLi4uYXJncykpO1xuICAgICAgaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gc3RhdGU7XG4gIH07XG59XG5cbmNvbnN0IGxvY2FsUHJvdmlkZWRTdGF0ZU1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpO1xuXG5jb25zdCBpbmplY3RMb2NhbCA9IC8qIEBfX05PX1NJREVfRUZGRUNUU19fICovICguLi5hcmdzKSA9PiB7XG4gIHZhciBfYTtcbiAgY29uc3Qga2V5ID0gYXJnc1swXTtcbiAgY29uc3QgaW5zdGFuY2UgPSAoX2EgPSBnZXRDdXJyZW50SW5zdGFuY2UoKSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnByb3h5O1xuICBpZiAoaW5zdGFuY2UgPT0gbnVsbCAmJiAhaGFzSW5qZWN0aW9uQ29udGV4dCgpKVxuICAgIHRocm93IG5ldyBFcnJvcihcImluamVjdExvY2FsIG11c3QgYmUgY2FsbGVkIGluIHNldHVwXCIpO1xuICBpZiAoaW5zdGFuY2UgJiYgbG9jYWxQcm92aWRlZFN0YXRlTWFwLmhhcyhpbnN0YW5jZSkgJiYga2V5IGluIGxvY2FsUHJvdmlkZWRTdGF0ZU1hcC5nZXQoaW5zdGFuY2UpKVxuICAgIHJldHVybiBsb2NhbFByb3ZpZGVkU3RhdGVNYXAuZ2V0KGluc3RhbmNlKVtrZXldO1xuICByZXR1cm4gaW5qZWN0KC4uLmFyZ3MpO1xufTtcblxuZnVuY3Rpb24gcHJvdmlkZUxvY2FsKGtleSwgdmFsdWUpIHtcbiAgdmFyIF9hO1xuICBjb25zdCBpbnN0YW5jZSA9IChfYSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpKSA9PSBudWxsID8gdm9pZCAwIDogX2EucHJveHk7XG4gIGlmIChpbnN0YW5jZSA9PSBudWxsKVxuICAgIHRocm93IG5ldyBFcnJvcihcInByb3ZpZGVMb2NhbCBtdXN0IGJlIGNhbGxlZCBpbiBzZXR1cFwiKTtcbiAgaWYgKCFsb2NhbFByb3ZpZGVkU3RhdGVNYXAuaGFzKGluc3RhbmNlKSlcbiAgICBsb2NhbFByb3ZpZGVkU3RhdGVNYXAuc2V0KGluc3RhbmNlLCAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKSk7XG4gIGNvbnN0IGxvY2FsUHJvdmlkZWRTdGF0ZSA9IGxvY2FsUHJvdmlkZWRTdGF0ZU1hcC5nZXQoaW5zdGFuY2UpO1xuICBsb2NhbFByb3ZpZGVkU3RhdGVba2V5XSA9IHZhbHVlO1xuICByZXR1cm4gcHJvdmlkZShrZXksIHZhbHVlKTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIGNyZWF0ZUluamVjdGlvblN0YXRlKGNvbXBvc2FibGUsIG9wdGlvbnMpIHtcbiAgY29uc3Qga2V5ID0gKG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuaW5qZWN0aW9uS2V5KSB8fCBTeW1ib2woY29tcG9zYWJsZS5uYW1lIHx8IFwiSW5qZWN0aW9uU3RhdGVcIik7XG4gIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuZGVmYXVsdFZhbHVlO1xuICBjb25zdCB1c2VQcm92aWRpbmdTdGF0ZSA9ICguLi5hcmdzKSA9PiB7XG4gICAgY29uc3Qgc3RhdGUgPSBjb21wb3NhYmxlKC4uLmFyZ3MpO1xuICAgIHByb3ZpZGVMb2NhbChrZXksIHN0YXRlKTtcbiAgICByZXR1cm4gc3RhdGU7XG4gIH07XG4gIGNvbnN0IHVzZUluamVjdGVkU3RhdGUgPSAoKSA9PiBpbmplY3RMb2NhbChrZXksIGRlZmF1bHRWYWx1ZSk7XG4gIHJldHVybiBbdXNlUHJvdmlkaW5nU3RhdGUsIHVzZUluamVjdGVkU3RhdGVdO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gY3JlYXRlUmVmKHZhbHVlLCBkZWVwKSB7XG4gIGlmIChkZWVwID09PSB0cnVlKSB7XG4gICAgcmV0dXJuIHJlZih2YWx1ZSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHNoYWxsb3dSZWYodmFsdWUpO1xuICB9XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiBjcmVhdGVTaGFyZWRDb21wb3NhYmxlKGNvbXBvc2FibGUpIHtcbiAgbGV0IHN1YnNjcmliZXJzID0gMDtcbiAgbGV0IHN0YXRlO1xuICBsZXQgc2NvcGU7XG4gIGNvbnN0IGRpc3Bvc2UgPSAoKSA9PiB7XG4gICAgc3Vic2NyaWJlcnMgLT0gMTtcbiAgICBpZiAoc2NvcGUgJiYgc3Vic2NyaWJlcnMgPD0gMCkge1xuICAgICAgc2NvcGUuc3RvcCgpO1xuICAgICAgc3RhdGUgPSB2b2lkIDA7XG4gICAgICBzY29wZSA9IHZvaWQgMDtcbiAgICB9XG4gIH07XG4gIHJldHVybiAoLi4uYXJncykgPT4ge1xuICAgIHN1YnNjcmliZXJzICs9IDE7XG4gICAgaWYgKCFzY29wZSkge1xuICAgICAgc2NvcGUgPSBlZmZlY3RTY29wZSh0cnVlKTtcbiAgICAgIHN0YXRlID0gc2NvcGUucnVuKCgpID0+IGNvbXBvc2FibGUoLi4uYXJncykpO1xuICAgIH1cbiAgICB0cnlPblNjb3BlRGlzcG9zZShkaXNwb3NlKTtcbiAgICByZXR1cm4gc3RhdGU7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGV4dGVuZFJlZihyZWYsIGV4dGVuZCwgeyBlbnVtZXJhYmxlID0gZmFsc2UsIHVud3JhcCA9IHRydWUgfSA9IHt9KSB7XG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGV4dGVuZCkpIHtcbiAgICBpZiAoa2V5ID09PSBcInZhbHVlXCIpXG4gICAgICBjb250aW51ZTtcbiAgICBpZiAoaXNSZWYodmFsdWUpICYmIHVud3JhcCkge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJlZiwga2V5LCB7XG4gICAgICAgIGdldCgpIHtcbiAgICAgICAgICByZXR1cm4gdmFsdWUudmFsdWU7XG4gICAgICAgIH0sXG4gICAgICAgIHNldCh2KSB7XG4gICAgICAgICAgdmFsdWUudmFsdWUgPSB2O1xuICAgICAgICB9LFxuICAgICAgICBlbnVtZXJhYmxlXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJlZiwga2V5LCB7IHZhbHVlLCBlbnVtZXJhYmxlIH0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmVmO1xufVxuXG5mdW5jdGlvbiBnZXQob2JqLCBrZXkpIHtcbiAgaWYgKGtleSA9PSBudWxsKVxuICAgIHJldHVybiB1bnJlZihvYmopO1xuICByZXR1cm4gdW5yZWYob2JqKVtrZXldO1xufVxuXG5mdW5jdGlvbiBpc0RlZmluZWQodikge1xuICByZXR1cm4gdW5yZWYodikgIT0gbnVsbDtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIG1ha2VEZXN0cnVjdHVyYWJsZShvYmosIGFycikge1xuICBpZiAodHlwZW9mIFN5bWJvbCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgIGNvbnN0IGNsb25lID0geyAuLi5vYmogfTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY2xvbmUsIFN5bWJvbC5pdGVyYXRvciwge1xuICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICB2YWx1ZSgpIHtcbiAgICAgICAgbGV0IGluZGV4ID0gMDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuZXh0OiAoKSA9PiAoe1xuICAgICAgICAgICAgdmFsdWU6IGFycltpbmRleCsrXSxcbiAgICAgICAgICAgIGRvbmU6IGluZGV4ID4gYXJyLmxlbmd0aFxuICAgICAgICAgIH0pXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGNsb25lO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBPYmplY3QuYXNzaWduKFsuLi5hcnJdLCBvYmopO1xuICB9XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiByZWFjdGlmeShmbiwgb3B0aW9ucykge1xuICBjb25zdCB1bnJlZkZuID0gKG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuY29tcHV0ZWRHZXR0ZXIpID09PSBmYWxzZSA/IHVucmVmIDogdG9WYWx1ZSQxO1xuICByZXR1cm4gZnVuY3Rpb24oLi4uYXJncykge1xuICAgIHJldHVybiBjb21wdXRlZCgoKSA9PiBmbi5hcHBseSh0aGlzLCBhcmdzLm1hcCgoaSkgPT4gdW5yZWZGbihpKSkpKTtcbiAgfTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHJlYWN0aWZ5T2JqZWN0KG9iaiwgb3B0aW9uc09yS2V5cyA9IHt9KSB7XG4gIGxldCBrZXlzID0gW107XG4gIGxldCBvcHRpb25zO1xuICBpZiAoQXJyYXkuaXNBcnJheShvcHRpb25zT3JLZXlzKSkge1xuICAgIGtleXMgPSBvcHRpb25zT3JLZXlzO1xuICB9IGVsc2Uge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zT3JLZXlzO1xuICAgIGNvbnN0IHsgaW5jbHVkZU93blByb3BlcnRpZXMgPSB0cnVlIH0gPSBvcHRpb25zT3JLZXlzO1xuICAgIGtleXMucHVzaCguLi5PYmplY3Qua2V5cyhvYmopKTtcbiAgICBpZiAoaW5jbHVkZU93blByb3BlcnRpZXMpXG4gICAgICBrZXlzLnB1c2goLi4uT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKSk7XG4gIH1cbiAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhcbiAgICBrZXlzLm1hcCgoa2V5KSA9PiB7XG4gICAgICBjb25zdCB2YWx1ZSA9IG9ialtrZXldO1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAga2V5LFxuICAgICAgICB0eXBlb2YgdmFsdWUgPT09IFwiZnVuY3Rpb25cIiA/IHJlYWN0aWZ5KHZhbHVlLmJpbmQob2JqKSwgb3B0aW9ucykgOiB2YWx1ZVxuICAgICAgXTtcbiAgICB9KVxuICApO1xufVxuXG5mdW5jdGlvbiB0b1JlYWN0aXZlKG9iamVjdFJlZikge1xuICBpZiAoIWlzUmVmKG9iamVjdFJlZikpXG4gICAgcmV0dXJuIHJlYWN0aXZlKG9iamVjdFJlZik7XG4gIGNvbnN0IHByb3h5ID0gbmV3IFByb3h5KHt9LCB7XG4gICAgZ2V0KF8sIHAsIHJlY2VpdmVyKSB7XG4gICAgICByZXR1cm4gdW5yZWYoUmVmbGVjdC5nZXQob2JqZWN0UmVmLnZhbHVlLCBwLCByZWNlaXZlcikpO1xuICAgIH0sXG4gICAgc2V0KF8sIHAsIHZhbHVlKSB7XG4gICAgICBpZiAoaXNSZWYob2JqZWN0UmVmLnZhbHVlW3BdKSAmJiAhaXNSZWYodmFsdWUpKVxuICAgICAgICBvYmplY3RSZWYudmFsdWVbcF0udmFsdWUgPSB2YWx1ZTtcbiAgICAgIGVsc2VcbiAgICAgICAgb2JqZWN0UmVmLnZhbHVlW3BdID0gdmFsdWU7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9LFxuICAgIGRlbGV0ZVByb3BlcnR5KF8sIHApIHtcbiAgICAgIHJldHVybiBSZWZsZWN0LmRlbGV0ZVByb3BlcnR5KG9iamVjdFJlZi52YWx1ZSwgcCk7XG4gICAgfSxcbiAgICBoYXMoXywgcCkge1xuICAgICAgcmV0dXJuIFJlZmxlY3QuaGFzKG9iamVjdFJlZi52YWx1ZSwgcCk7XG4gICAgfSxcbiAgICBvd25LZXlzKCkge1xuICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iamVjdFJlZi52YWx1ZSk7XG4gICAgfSxcbiAgICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICBjb25maWd1cmFibGU6IHRydWVcbiAgICAgIH07XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIHJlYWN0aXZlKHByb3h5KTtcbn1cblxuZnVuY3Rpb24gcmVhY3RpdmVDb21wdXRlZChmbikge1xuICByZXR1cm4gdG9SZWFjdGl2ZShjb21wdXRlZChmbikpO1xufVxuXG5mdW5jdGlvbiByZWFjdGl2ZU9taXQob2JqLCAuLi5rZXlzKSB7XG4gIGNvbnN0IGZsYXRLZXlzID0ga2V5cy5mbGF0KCk7XG4gIGNvbnN0IHByZWRpY2F0ZSA9IGZsYXRLZXlzWzBdO1xuICByZXR1cm4gcmVhY3RpdmVDb21wdXRlZCgoKSA9PiB0eXBlb2YgcHJlZGljYXRlID09PSBcImZ1bmN0aW9uXCIgPyBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXModG9SZWZzJDEob2JqKSkuZmlsdGVyKChbaywgdl0pID0+ICFwcmVkaWNhdGUodG9WYWx1ZSQxKHYpLCBrKSkpIDogT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKHRvUmVmcyQxKG9iaikpLmZpbHRlcigoZSkgPT4gIWZsYXRLZXlzLmluY2x1ZGVzKGVbMF0pKSkpO1xufVxuXG5jb25zdCBpc0NsaWVudCA9IHR5cGVvZiB3aW5kb3cgIT09IFwidW5kZWZpbmVkXCIgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSBcInVuZGVmaW5lZFwiO1xuY29uc3QgaXNXb3JrZXIgPSB0eXBlb2YgV29ya2VyR2xvYmFsU2NvcGUgIT09IFwidW5kZWZpbmVkXCIgJiYgZ2xvYmFsVGhpcyBpbnN0YW5jZW9mIFdvcmtlckdsb2JhbFNjb3BlO1xuY29uc3QgaXNEZWYgPSAodmFsKSA9PiB0eXBlb2YgdmFsICE9PSBcInVuZGVmaW5lZFwiO1xuY29uc3Qgbm90TnVsbGlzaCA9ICh2YWwpID0+IHZhbCAhPSBudWxsO1xuY29uc3QgYXNzZXJ0ID0gKGNvbmRpdGlvbiwgLi4uaW5mb3MpID0+IHtcbiAgaWYgKCFjb25kaXRpb24pXG4gICAgY29uc29sZS53YXJuKC4uLmluZm9zKTtcbn07XG5jb25zdCB0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7XG5jb25zdCBpc09iamVjdCA9ICh2YWwpID0+IHRvU3RyaW5nLmNhbGwodmFsKSA9PT0gXCJbb2JqZWN0IE9iamVjdF1cIjtcbmNvbnN0IG5vdyA9ICgpID0+IERhdGUubm93KCk7XG5jb25zdCB0aW1lc3RhbXAgPSAoKSA9PiArRGF0ZS5ub3coKTtcbmNvbnN0IGNsYW1wID0gKG4sIG1pbiwgbWF4KSA9PiBNYXRoLm1pbihtYXgsIE1hdGgubWF4KG1pbiwgbikpO1xuY29uc3Qgbm9vcCA9ICgpID0+IHtcbn07XG5jb25zdCByYW5kID0gKG1pbiwgbWF4KSA9PiB7XG4gIG1pbiA9IE1hdGguY2VpbChtaW4pO1xuICBtYXggPSBNYXRoLmZsb29yKG1heCk7XG4gIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpICsgbWluO1xufTtcbmNvbnN0IGhhc093biA9ICh2YWwsIGtleSkgPT4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbCwga2V5KTtcbmNvbnN0IGlzSU9TID0gLyogQF9fUFVSRV9fICovIGdldElzSU9TKCk7XG5mdW5jdGlvbiBnZXRJc0lPUygpIHtcbiAgdmFyIF9hLCBfYjtcbiAgcmV0dXJuIGlzQ2xpZW50ICYmICgoX2EgPSB3aW5kb3cgPT0gbnVsbCA/IHZvaWQgMCA6IHdpbmRvdy5uYXZpZ2F0b3IpID09IG51bGwgPyB2b2lkIDAgOiBfYS51c2VyQWdlbnQpICYmICgvaVAoPzphZHxob25lfG9kKS8udGVzdCh3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCkgfHwgKChfYiA9IHdpbmRvdyA9PSBudWxsID8gdm9pZCAwIDogd2luZG93Lm5hdmlnYXRvcikgPT0gbnVsbCA/IHZvaWQgMCA6IF9iLm1heFRvdWNoUG9pbnRzKSA+IDIgJiYgL2lQYWR8TWFjaW50b3NoLy50ZXN0KHdpbmRvdyA9PSBudWxsID8gdm9pZCAwIDogd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpKTtcbn1cblxuZnVuY3Rpb24gdG9SZWYoLi4uYXJncykge1xuICBpZiAoYXJncy5sZW5ndGggIT09IDEpXG4gICAgcmV0dXJuIHRvUmVmJDEoLi4uYXJncyk7XG4gIGNvbnN0IHIgPSBhcmdzWzBdO1xuICByZXR1cm4gdHlwZW9mIHIgPT09IFwiZnVuY3Rpb25cIiA/IHJlYWRvbmx5KGN1c3RvbVJlZigoKSA9PiAoeyBnZXQ6IHIsIHNldDogbm9vcCB9KSkpIDogcmVmKHIpO1xufVxuY29uc3QgcmVzb2x2ZVJlZiA9IHRvUmVmO1xuXG5mdW5jdGlvbiByZWFjdGl2ZVBpY2sob2JqLCAuLi5rZXlzKSB7XG4gIGNvbnN0IGZsYXRLZXlzID0ga2V5cy5mbGF0KCk7XG4gIGNvbnN0IHByZWRpY2F0ZSA9IGZsYXRLZXlzWzBdO1xuICByZXR1cm4gcmVhY3RpdmVDb21wdXRlZCgoKSA9PiB0eXBlb2YgcHJlZGljYXRlID09PSBcImZ1bmN0aW9uXCIgPyBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXModG9SZWZzJDEob2JqKSkuZmlsdGVyKChbaywgdl0pID0+IHByZWRpY2F0ZSh0b1ZhbHVlJDEodiksIGspKSkgOiBPYmplY3QuZnJvbUVudHJpZXMoZmxhdEtleXMubWFwKChrKSA9PiBbaywgdG9SZWYob2JqLCBrKV0pKSk7XG59XG5cbmZ1bmN0aW9uIHJlZkF1dG9SZXNldChkZWZhdWx0VmFsdWUsIGFmdGVyTXMgPSAxZTQpIHtcbiAgcmV0dXJuIGN1c3RvbVJlZigodHJhY2ssIHRyaWdnZXIpID0+IHtcbiAgICBsZXQgdmFsdWUgPSB0b1ZhbHVlJDEoZGVmYXVsdFZhbHVlKTtcbiAgICBsZXQgdGltZXI7XG4gICAgY29uc3QgcmVzZXRBZnRlciA9ICgpID0+IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdmFsdWUgPSB0b1ZhbHVlJDEoZGVmYXVsdFZhbHVlKTtcbiAgICAgIHRyaWdnZXIoKTtcbiAgICB9LCB0b1ZhbHVlJDEoYWZ0ZXJNcykpO1xuICAgIHRyeU9uU2NvcGVEaXNwb3NlKCgpID0+IHtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGdldCgpIHtcbiAgICAgICAgdHJhY2soKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgfSxcbiAgICAgIHNldChuZXdWYWx1ZSkge1xuICAgICAgICB2YWx1ZSA9IG5ld1ZhbHVlO1xuICAgICAgICB0cmlnZ2VyKCk7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgIHRpbWVyID0gcmVzZXRBZnRlcigpO1xuICAgICAgfVxuICAgIH07XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVGaWx0ZXJXcmFwcGVyKGZpbHRlciwgZm4pIHtcbiAgZnVuY3Rpb24gd3JhcHBlciguLi5hcmdzKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIFByb21pc2UucmVzb2x2ZShmaWx0ZXIoKCkgPT4gZm4uYXBwbHkodGhpcywgYXJncyksIHsgZm4sIHRoaXNBcmc6IHRoaXMsIGFyZ3MgfSkpLnRoZW4ocmVzb2x2ZSkuY2F0Y2gocmVqZWN0KTtcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gd3JhcHBlcjtcbn1cbmNvbnN0IGJ5cGFzc0ZpbHRlciA9IChpbnZva2UpID0+IHtcbiAgcmV0dXJuIGludm9rZSgpO1xufTtcbmZ1bmN0aW9uIGRlYm91bmNlRmlsdGVyKG1zLCBvcHRpb25zID0ge30pIHtcbiAgbGV0IHRpbWVyO1xuICBsZXQgbWF4VGltZXI7XG4gIGxldCBsYXN0UmVqZWN0b3IgPSBub29wO1xuICBjb25zdCBfY2xlYXJUaW1lb3V0ID0gKHRpbWVyMikgPT4ge1xuICAgIGNsZWFyVGltZW91dCh0aW1lcjIpO1xuICAgIGxhc3RSZWplY3RvcigpO1xuICAgIGxhc3RSZWplY3RvciA9IG5vb3A7XG4gIH07XG4gIGxldCBsYXN0SW52b2tlcjtcbiAgY29uc3QgZmlsdGVyID0gKGludm9rZSkgPT4ge1xuICAgIGNvbnN0IGR1cmF0aW9uID0gdG9WYWx1ZSQxKG1zKTtcbiAgICBjb25zdCBtYXhEdXJhdGlvbiA9IHRvVmFsdWUkMShvcHRpb25zLm1heFdhaXQpO1xuICAgIGlmICh0aW1lcilcbiAgICAgIF9jbGVhclRpbWVvdXQodGltZXIpO1xuICAgIGlmIChkdXJhdGlvbiA8PSAwIHx8IG1heER1cmF0aW9uICE9PSB2b2lkIDAgJiYgbWF4RHVyYXRpb24gPD0gMCkge1xuICAgICAgaWYgKG1heFRpbWVyKSB7XG4gICAgICAgIF9jbGVhclRpbWVvdXQobWF4VGltZXIpO1xuICAgICAgICBtYXhUaW1lciA9IHZvaWQgMDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoaW52b2tlKCkpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGFzdFJlamVjdG9yID0gb3B0aW9ucy5yZWplY3RPbkNhbmNlbCA/IHJlamVjdCA6IHJlc29sdmU7XG4gICAgICBsYXN0SW52b2tlciA9IGludm9rZTtcbiAgICAgIGlmIChtYXhEdXJhdGlvbiAmJiAhbWF4VGltZXIpIHtcbiAgICAgICAgbWF4VGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICBpZiAodGltZXIpXG4gICAgICAgICAgICBfY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICBtYXhUaW1lciA9IHZvaWQgMDtcbiAgICAgICAgICByZXNvbHZlKGxhc3RJbnZva2VyKCkpO1xuICAgICAgICB9LCBtYXhEdXJhdGlvbik7XG4gICAgICB9XG4gICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBpZiAobWF4VGltZXIpXG4gICAgICAgICAgX2NsZWFyVGltZW91dChtYXhUaW1lcik7XG4gICAgICAgIG1heFRpbWVyID0gdm9pZCAwO1xuICAgICAgICByZXNvbHZlKGludm9rZSgpKTtcbiAgICAgIH0sIGR1cmF0aW9uKTtcbiAgICB9KTtcbiAgfTtcbiAgcmV0dXJuIGZpbHRlcjtcbn1cbmZ1bmN0aW9uIHRocm90dGxlRmlsdGVyKC4uLmFyZ3MpIHtcbiAgbGV0IGxhc3RFeGVjID0gMDtcbiAgbGV0IHRpbWVyO1xuICBsZXQgaXNMZWFkaW5nID0gdHJ1ZTtcbiAgbGV0IGxhc3RSZWplY3RvciA9IG5vb3A7XG4gIGxldCBsYXN0VmFsdWU7XG4gIGxldCBtcztcbiAgbGV0IHRyYWlsaW5nO1xuICBsZXQgbGVhZGluZztcbiAgbGV0IHJlamVjdE9uQ2FuY2VsO1xuICBpZiAoIWlzUmVmKGFyZ3NbMF0pICYmIHR5cGVvZiBhcmdzWzBdID09PSBcIm9iamVjdFwiKVxuICAgICh7IGRlbGF5OiBtcywgdHJhaWxpbmcgPSB0cnVlLCBsZWFkaW5nID0gdHJ1ZSwgcmVqZWN0T25DYW5jZWwgPSBmYWxzZSB9ID0gYXJnc1swXSk7XG4gIGVsc2VcbiAgICBbbXMsIHRyYWlsaW5nID0gdHJ1ZSwgbGVhZGluZyA9IHRydWUsIHJlamVjdE9uQ2FuY2VsID0gZmFsc2VdID0gYXJncztcbiAgY29uc3QgY2xlYXIgPSAoKSA9PiB7XG4gICAgaWYgKHRpbWVyKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgdGltZXIgPSB2b2lkIDA7XG4gICAgICBsYXN0UmVqZWN0b3IoKTtcbiAgICAgIGxhc3RSZWplY3RvciA9IG5vb3A7XG4gICAgfVxuICB9O1xuICBjb25zdCBmaWx0ZXIgPSAoX2ludm9rZSkgPT4ge1xuICAgIGNvbnN0IGR1cmF0aW9uID0gdG9WYWx1ZSQxKG1zKTtcbiAgICBjb25zdCBlbGFwc2VkID0gRGF0ZS5ub3coKSAtIGxhc3RFeGVjO1xuICAgIGNvbnN0IGludm9rZSA9ICgpID0+IHtcbiAgICAgIHJldHVybiBsYXN0VmFsdWUgPSBfaW52b2tlKCk7XG4gICAgfTtcbiAgICBjbGVhcigpO1xuICAgIGlmIChkdXJhdGlvbiA8PSAwKSB7XG4gICAgICBsYXN0RXhlYyA9IERhdGUubm93KCk7XG4gICAgICByZXR1cm4gaW52b2tlKCk7XG4gICAgfVxuICAgIGlmIChlbGFwc2VkID4gZHVyYXRpb24gJiYgKGxlYWRpbmcgfHwgIWlzTGVhZGluZykpIHtcbiAgICAgIGxhc3RFeGVjID0gRGF0ZS5ub3coKTtcbiAgICAgIGludm9rZSgpO1xuICAgIH0gZWxzZSBpZiAodHJhaWxpbmcpIHtcbiAgICAgIGxhc3RWYWx1ZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgbGFzdFJlamVjdG9yID0gcmVqZWN0T25DYW5jZWwgPyByZWplY3QgOiByZXNvbHZlO1xuICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGxhc3RFeGVjID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICBpc0xlYWRpbmcgPSB0cnVlO1xuICAgICAgICAgIHJlc29sdmUoaW52b2tlKCkpO1xuICAgICAgICAgIGNsZWFyKCk7XG4gICAgICAgIH0sIE1hdGgubWF4KDAsIGR1cmF0aW9uIC0gZWxhcHNlZCkpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGlmICghbGVhZGluZyAmJiAhdGltZXIpXG4gICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gaXNMZWFkaW5nID0gdHJ1ZSwgZHVyYXRpb24pO1xuICAgIGlzTGVhZGluZyA9IGZhbHNlO1xuICAgIHJldHVybiBsYXN0VmFsdWU7XG4gIH07XG4gIHJldHVybiBmaWx0ZXI7XG59XG5mdW5jdGlvbiBwYXVzYWJsZUZpbHRlcihleHRlbmRGaWx0ZXIgPSBieXBhc3NGaWx0ZXIsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgaW5pdGlhbFN0YXRlID0gXCJhY3RpdmVcIlxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgaXNBY3RpdmUgPSB0b1JlZihpbml0aWFsU3RhdGUgPT09IFwiYWN0aXZlXCIpO1xuICBmdW5jdGlvbiBwYXVzZSgpIHtcbiAgICBpc0FjdGl2ZS52YWx1ZSA9IGZhbHNlO1xuICB9XG4gIGZ1bmN0aW9uIHJlc3VtZSgpIHtcbiAgICBpc0FjdGl2ZS52YWx1ZSA9IHRydWU7XG4gIH1cbiAgY29uc3QgZXZlbnRGaWx0ZXIgPSAoLi4uYXJncykgPT4ge1xuICAgIGlmIChpc0FjdGl2ZS52YWx1ZSlcbiAgICAgIGV4dGVuZEZpbHRlciguLi5hcmdzKTtcbiAgfTtcbiAgcmV0dXJuIHsgaXNBY3RpdmU6IHJlYWRvbmx5KGlzQWN0aXZlKSwgcGF1c2UsIHJlc3VtZSwgZXZlbnRGaWx0ZXIgfTtcbn1cblxuZnVuY3Rpb24gcHJvbWlzZVRpbWVvdXQobXMsIHRocm93T25UaW1lb3V0ID0gZmFsc2UsIHJlYXNvbiA9IFwiVGltZW91dFwiKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgaWYgKHRocm93T25UaW1lb3V0KVxuICAgICAgc2V0VGltZW91dCgoKSA9PiByZWplY3QocmVhc29uKSwgbXMpO1xuICAgIGVsc2VcbiAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpO1xuICB9KTtcbn1cbmZ1bmN0aW9uIGlkZW50aXR5KGFyZykge1xuICByZXR1cm4gYXJnO1xufVxuZnVuY3Rpb24gY3JlYXRlU2luZ2xldG9uUHJvbWlzZShmbikge1xuICBsZXQgX3Byb21pc2U7XG4gIGZ1bmN0aW9uIHdyYXBwZXIoKSB7XG4gICAgaWYgKCFfcHJvbWlzZSlcbiAgICAgIF9wcm9taXNlID0gZm4oKTtcbiAgICByZXR1cm4gX3Byb21pc2U7XG4gIH1cbiAgd3JhcHBlci5yZXNldCA9IGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBfcHJldiA9IF9wcm9taXNlO1xuICAgIF9wcm9taXNlID0gdm9pZCAwO1xuICAgIGlmIChfcHJldilcbiAgICAgIGF3YWl0IF9wcmV2O1xuICB9O1xuICByZXR1cm4gd3JhcHBlcjtcbn1cbmZ1bmN0aW9uIGludm9rZShmbikge1xuICByZXR1cm4gZm4oKTtcbn1cbmZ1bmN0aW9uIGNvbnRhaW5zUHJvcChvYmosIC4uLnByb3BzKSB7XG4gIHJldHVybiBwcm9wcy5zb21lKChrKSA9PiBrIGluIG9iaik7XG59XG5mdW5jdGlvbiBpbmNyZWFzZVdpdGhVbml0KHRhcmdldCwgZGVsdGEpIHtcbiAgdmFyIF9hO1xuICBpZiAodHlwZW9mIHRhcmdldCA9PT0gXCJudW1iZXJcIilcbiAgICByZXR1cm4gdGFyZ2V0ICsgZGVsdGE7XG4gIGNvbnN0IHZhbHVlID0gKChfYSA9IHRhcmdldC5tYXRjaCgvXi0/XFxkK1xcLj9cXGQqLykpID09IG51bGwgPyB2b2lkIDAgOiBfYVswXSkgfHwgXCJcIjtcbiAgY29uc3QgdW5pdCA9IHRhcmdldC5zbGljZSh2YWx1ZS5sZW5ndGgpO1xuICBjb25zdCByZXN1bHQgPSBOdW1iZXIucGFyc2VGbG9hdCh2YWx1ZSkgKyBkZWx0YTtcbiAgaWYgKE51bWJlci5pc05hTihyZXN1bHQpKVxuICAgIHJldHVybiB0YXJnZXQ7XG4gIHJldHVybiByZXN1bHQgKyB1bml0O1xufVxuZnVuY3Rpb24gcHhWYWx1ZShweCkge1xuICByZXR1cm4gcHguZW5kc1dpdGgoXCJyZW1cIikgPyBOdW1iZXIucGFyc2VGbG9hdChweCkgKiAxNiA6IE51bWJlci5wYXJzZUZsb2F0KHB4KTtcbn1cbmZ1bmN0aW9uIG9iamVjdFBpY2sob2JqLCBrZXlzLCBvbWl0VW5kZWZpbmVkID0gZmFsc2UpIHtcbiAgcmV0dXJuIGtleXMucmVkdWNlKChuLCBrKSA9PiB7XG4gICAgaWYgKGsgaW4gb2JqKSB7XG4gICAgICBpZiAoIW9taXRVbmRlZmluZWQgfHwgb2JqW2tdICE9PSB2b2lkIDApXG4gICAgICAgIG5ba10gPSBvYmpba107XG4gICAgfVxuICAgIHJldHVybiBuO1xuICB9LCB7fSk7XG59XG5mdW5jdGlvbiBvYmplY3RPbWl0KG9iaiwga2V5cywgb21pdFVuZGVmaW5lZCA9IGZhbHNlKSB7XG4gIHJldHVybiBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMob2JqKS5maWx0ZXIoKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgIHJldHVybiAoIW9taXRVbmRlZmluZWQgfHwgdmFsdWUgIT09IHZvaWQgMCkgJiYgIWtleXMuaW5jbHVkZXMoa2V5KTtcbiAgfSkpO1xufVxuZnVuY3Rpb24gb2JqZWN0RW50cmllcyhvYmopIHtcbiAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKG9iaik7XG59XG5mdW5jdGlvbiB0b0FycmF5KHZhbHVlKSB7XG4gIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlIDogW3ZhbHVlXTtcbn1cblxuZnVuY3Rpb24gY2FjaGVTdHJpbmdGdW5jdGlvbihmbikge1xuICBjb25zdCBjYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpO1xuICByZXR1cm4gKHN0cikgPT4ge1xuICAgIGNvbnN0IGhpdCA9IGNhY2hlW3N0cl07XG4gICAgcmV0dXJuIGhpdCB8fCAoY2FjaGVbc3RyXSA9IGZuKHN0cikpO1xuICB9O1xufVxuY29uc3QgaHlwaGVuYXRlUkUgPSAvXFxCKFtBLVpdKS9nO1xuY29uc3QgaHlwaGVuYXRlID0gY2FjaGVTdHJpbmdGdW5jdGlvbigoc3RyKSA9PiBzdHIucmVwbGFjZShoeXBoZW5hdGVSRSwgXCItJDFcIikudG9Mb3dlckNhc2UoKSk7XG5jb25zdCBjYW1lbGl6ZVJFID0gLy0oXFx3KS9nO1xuY29uc3QgY2FtZWxpemUgPSBjYWNoZVN0cmluZ0Z1bmN0aW9uKChzdHIpID0+IHtcbiAgcmV0dXJuIHN0ci5yZXBsYWNlKGNhbWVsaXplUkUsIChfLCBjKSA9PiBjID8gYy50b1VwcGVyQ2FzZSgpIDogXCJcIik7XG59KTtcblxuZnVuY3Rpb24gZ2V0TGlmZUN5Y2xlVGFyZ2V0KHRhcmdldCkge1xuICByZXR1cm4gdGFyZ2V0IHx8IGdldEN1cnJlbnRJbnN0YW5jZSgpO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlRGVib3VuY2VGbihmbiwgbXMgPSAyMDAsIG9wdGlvbnMgPSB7fSkge1xuICByZXR1cm4gY3JlYXRlRmlsdGVyV3JhcHBlcihcbiAgICBkZWJvdW5jZUZpbHRlcihtcywgb3B0aW9ucyksXG4gICAgZm5cbiAgKTtcbn1cblxuZnVuY3Rpb24gcmVmRGVib3VuY2VkKHZhbHVlLCBtcyA9IDIwMCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IGRlYm91bmNlZCA9IHJlZih0b1ZhbHVlJDEodmFsdWUpKTtcbiAgY29uc3QgdXBkYXRlciA9IHVzZURlYm91bmNlRm4oKCkgPT4ge1xuICAgIGRlYm91bmNlZC52YWx1ZSA9IHZhbHVlLnZhbHVlO1xuICB9LCBtcywgb3B0aW9ucyk7XG4gIHdhdGNoKHZhbHVlLCAoKSA9PiB1cGRhdGVyKCkpO1xuICByZXR1cm4gc2hhbGxvd1JlYWRvbmx5KGRlYm91bmNlZCk7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiByZWZEZWZhdWx0KHNvdXJjZSwgZGVmYXVsdFZhbHVlKSB7XG4gIHJldHVybiBjb21wdXRlZCh7XG4gICAgZ2V0KCkge1xuICAgICAgdmFyIF9hO1xuICAgICAgcmV0dXJuIChfYSA9IHNvdXJjZS52YWx1ZSkgIT0gbnVsbCA/IF9hIDogZGVmYXVsdFZhbHVlO1xuICAgIH0sXG4gICAgc2V0KHZhbHVlKSB7XG4gICAgICBzb3VyY2UudmFsdWUgPSB2YWx1ZTtcbiAgICB9XG4gIH0pO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlVGhyb3R0bGVGbihmbiwgbXMgPSAyMDAsIHRyYWlsaW5nID0gZmFsc2UsIGxlYWRpbmcgPSB0cnVlLCByZWplY3RPbkNhbmNlbCA9IGZhbHNlKSB7XG4gIHJldHVybiBjcmVhdGVGaWx0ZXJXcmFwcGVyKFxuICAgIHRocm90dGxlRmlsdGVyKG1zLCB0cmFpbGluZywgbGVhZGluZywgcmVqZWN0T25DYW5jZWwpLFxuICAgIGZuXG4gICk7XG59XG5cbmZ1bmN0aW9uIHJlZlRocm90dGxlZCh2YWx1ZSwgZGVsYXkgPSAyMDAsIHRyYWlsaW5nID0gdHJ1ZSwgbGVhZGluZyA9IHRydWUpIHtcbiAgaWYgKGRlbGF5IDw9IDApXG4gICAgcmV0dXJuIHZhbHVlO1xuICBjb25zdCB0aHJvdHRsZWQgPSByZWYodG9WYWx1ZSQxKHZhbHVlKSk7XG4gIGNvbnN0IHVwZGF0ZXIgPSB1c2VUaHJvdHRsZUZuKCgpID0+IHtcbiAgICB0aHJvdHRsZWQudmFsdWUgPSB2YWx1ZS52YWx1ZTtcbiAgfSwgZGVsYXksIHRyYWlsaW5nLCBsZWFkaW5nKTtcbiAgd2F0Y2godmFsdWUsICgpID0+IHVwZGF0ZXIoKSk7XG4gIHJldHVybiB0aHJvdHRsZWQ7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiByZWZXaXRoQ29udHJvbChpbml0aWFsLCBvcHRpb25zID0ge30pIHtcbiAgbGV0IHNvdXJjZSA9IGluaXRpYWw7XG4gIGxldCB0cmFjaztcbiAgbGV0IHRyaWdnZXI7XG4gIGNvbnN0IHJlZiA9IGN1c3RvbVJlZigoX3RyYWNrLCBfdHJpZ2dlcikgPT4ge1xuICAgIHRyYWNrID0gX3RyYWNrO1xuICAgIHRyaWdnZXIgPSBfdHJpZ2dlcjtcbiAgICByZXR1cm4ge1xuICAgICAgZ2V0KCkge1xuICAgICAgICByZXR1cm4gZ2V0KCk7XG4gICAgICB9LFxuICAgICAgc2V0KHYpIHtcbiAgICAgICAgc2V0KHYpO1xuICAgICAgfVxuICAgIH07XG4gIH0pO1xuICBmdW5jdGlvbiBnZXQodHJhY2tpbmcgPSB0cnVlKSB7XG4gICAgaWYgKHRyYWNraW5nKVxuICAgICAgdHJhY2soKTtcbiAgICByZXR1cm4gc291cmNlO1xuICB9XG4gIGZ1bmN0aW9uIHNldCh2YWx1ZSwgdHJpZ2dlcmluZyA9IHRydWUpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGlmICh2YWx1ZSA9PT0gc291cmNlKVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IG9sZCA9IHNvdXJjZTtcbiAgICBpZiAoKChfYSA9IG9wdGlvbnMub25CZWZvcmVDaGFuZ2UpID09IG51bGwgPyB2b2lkIDAgOiBfYS5jYWxsKG9wdGlvbnMsIHZhbHVlLCBvbGQpKSA9PT0gZmFsc2UpXG4gICAgICByZXR1cm47XG4gICAgc291cmNlID0gdmFsdWU7XG4gICAgKF9iID0gb3B0aW9ucy5vbkNoYW5nZWQpID09IG51bGwgPyB2b2lkIDAgOiBfYi5jYWxsKG9wdGlvbnMsIHZhbHVlLCBvbGQpO1xuICAgIGlmICh0cmlnZ2VyaW5nKVxuICAgICAgdHJpZ2dlcigpO1xuICB9XG4gIGNvbnN0IHVudHJhY2tlZEdldCA9ICgpID0+IGdldChmYWxzZSk7XG4gIGNvbnN0IHNpbGVudFNldCA9ICh2KSA9PiBzZXQodiwgZmFsc2UpO1xuICBjb25zdCBwZWVrID0gKCkgPT4gZ2V0KGZhbHNlKTtcbiAgY29uc3QgbGF5ID0gKHYpID0+IHNldCh2LCBmYWxzZSk7XG4gIHJldHVybiBleHRlbmRSZWYoXG4gICAgcmVmLFxuICAgIHtcbiAgICAgIGdldCxcbiAgICAgIHNldCxcbiAgICAgIHVudHJhY2tlZEdldCxcbiAgICAgIHNpbGVudFNldCxcbiAgICAgIHBlZWssXG4gICAgICBsYXlcbiAgICB9LFxuICAgIHsgZW51bWVyYWJsZTogdHJ1ZSB9XG4gICk7XG59XG5jb25zdCBjb250cm9sbGVkUmVmID0gcmVmV2l0aENvbnRyb2w7XG5cbmZ1bmN0aW9uIHNldCguLi5hcmdzKSB7XG4gIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xuICAgIGNvbnN0IFtyZWYsIHZhbHVlXSA9IGFyZ3M7XG4gICAgcmVmLnZhbHVlID0gdmFsdWU7XG4gIH1cbiAgaWYgKGFyZ3MubGVuZ3RoID09PSAzKSB7XG4gICAgY29uc3QgW3RhcmdldCwga2V5LCB2YWx1ZV0gPSBhcmdzO1xuICAgIHRhcmdldFtrZXldID0gdmFsdWU7XG4gIH1cbn1cblxuZnVuY3Rpb24gd2F0Y2hXaXRoRmlsdGVyKHNvdXJjZSwgY2IsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgZXZlbnRGaWx0ZXIgPSBieXBhc3NGaWx0ZXIsXG4gICAgLi4ud2F0Y2hPcHRpb25zXG4gIH0gPSBvcHRpb25zO1xuICByZXR1cm4gd2F0Y2goXG4gICAgc291cmNlLFxuICAgIGNyZWF0ZUZpbHRlcldyYXBwZXIoXG4gICAgICBldmVudEZpbHRlcixcbiAgICAgIGNiXG4gICAgKSxcbiAgICB3YXRjaE9wdGlvbnNcbiAgKTtcbn1cblxuZnVuY3Rpb24gd2F0Y2hQYXVzYWJsZShzb3VyY2UsIGNiLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGV2ZW50RmlsdGVyOiBmaWx0ZXIsXG4gICAgaW5pdGlhbFN0YXRlID0gXCJhY3RpdmVcIixcbiAgICAuLi53YXRjaE9wdGlvbnNcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHsgZXZlbnRGaWx0ZXIsIHBhdXNlLCByZXN1bWUsIGlzQWN0aXZlIH0gPSBwYXVzYWJsZUZpbHRlcihmaWx0ZXIsIHsgaW5pdGlhbFN0YXRlIH0pO1xuICBjb25zdCBzdG9wID0gd2F0Y2hXaXRoRmlsdGVyKFxuICAgIHNvdXJjZSxcbiAgICBjYixcbiAgICB7XG4gICAgICAuLi53YXRjaE9wdGlvbnMsXG4gICAgICBldmVudEZpbHRlclxuICAgIH1cbiAgKTtcbiAgcmV0dXJuIHsgc3RvcCwgcGF1c2UsIHJlc3VtZSwgaXNBY3RpdmUgfTtcbn1cblxuZnVuY3Rpb24gc3luY1JlZihsZWZ0LCByaWdodCwgLi4uW29wdGlvbnNdKSB7XG4gIGNvbnN0IHtcbiAgICBmbHVzaCA9IFwic3luY1wiLFxuICAgIGRlZXAgPSBmYWxzZSxcbiAgICBpbW1lZGlhdGUgPSB0cnVlLFxuICAgIGRpcmVjdGlvbiA9IFwiYm90aFwiLFxuICAgIHRyYW5zZm9ybSA9IHt9XG4gIH0gPSBvcHRpb25zIHx8IHt9O1xuICBjb25zdCB3YXRjaGVycyA9IFtdO1xuICBjb25zdCB0cmFuc2Zvcm1MVFIgPSBcImx0clwiIGluIHRyYW5zZm9ybSAmJiB0cmFuc2Zvcm0ubHRyIHx8ICgodikgPT4gdik7XG4gIGNvbnN0IHRyYW5zZm9ybVJUTCA9IFwicnRsXCIgaW4gdHJhbnNmb3JtICYmIHRyYW5zZm9ybS5ydGwgfHwgKCh2KSA9PiB2KTtcbiAgaWYgKGRpcmVjdGlvbiA9PT0gXCJib3RoXCIgfHwgZGlyZWN0aW9uID09PSBcImx0clwiKSB7XG4gICAgd2F0Y2hlcnMucHVzaCh3YXRjaFBhdXNhYmxlKFxuICAgICAgbGVmdCxcbiAgICAgIChuZXdWYWx1ZSkgPT4ge1xuICAgICAgICB3YXRjaGVycy5mb3JFYWNoKCh3KSA9PiB3LnBhdXNlKCkpO1xuICAgICAgICByaWdodC52YWx1ZSA9IHRyYW5zZm9ybUxUUihuZXdWYWx1ZSk7XG4gICAgICAgIHdhdGNoZXJzLmZvckVhY2goKHcpID0+IHcucmVzdW1lKCkpO1xuICAgICAgfSxcbiAgICAgIHsgZmx1c2gsIGRlZXAsIGltbWVkaWF0ZSB9XG4gICAgKSk7XG4gIH1cbiAgaWYgKGRpcmVjdGlvbiA9PT0gXCJib3RoXCIgfHwgZGlyZWN0aW9uID09PSBcInJ0bFwiKSB7XG4gICAgd2F0Y2hlcnMucHVzaCh3YXRjaFBhdXNhYmxlKFxuICAgICAgcmlnaHQsXG4gICAgICAobmV3VmFsdWUpID0+IHtcbiAgICAgICAgd2F0Y2hlcnMuZm9yRWFjaCgodykgPT4gdy5wYXVzZSgpKTtcbiAgICAgICAgbGVmdC52YWx1ZSA9IHRyYW5zZm9ybVJUTChuZXdWYWx1ZSk7XG4gICAgICAgIHdhdGNoZXJzLmZvckVhY2goKHcpID0+IHcucmVzdW1lKCkpO1xuICAgICAgfSxcbiAgICAgIHsgZmx1c2gsIGRlZXAsIGltbWVkaWF0ZSB9XG4gICAgKSk7XG4gIH1cbiAgY29uc3Qgc3RvcCA9ICgpID0+IHtcbiAgICB3YXRjaGVycy5mb3JFYWNoKCh3KSA9PiB3LnN0b3AoKSk7XG4gIH07XG4gIHJldHVybiBzdG9wO1xufVxuXG5mdW5jdGlvbiBzeW5jUmVmcyhzb3VyY2UsIHRhcmdldHMsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgZmx1c2ggPSBcInN5bmNcIixcbiAgICBkZWVwID0gZmFsc2UsXG4gICAgaW1tZWRpYXRlID0gdHJ1ZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgdGFyZ2V0c0FycmF5ID0gdG9BcnJheSh0YXJnZXRzKTtcbiAgcmV0dXJuIHdhdGNoKFxuICAgIHNvdXJjZSxcbiAgICAobmV3VmFsdWUpID0+IHRhcmdldHNBcnJheS5mb3JFYWNoKCh0YXJnZXQpID0+IHRhcmdldC52YWx1ZSA9IG5ld1ZhbHVlKSxcbiAgICB7IGZsdXNoLCBkZWVwLCBpbW1lZGlhdGUgfVxuICApO1xufVxuXG5mdW5jdGlvbiB0b1JlZnMob2JqZWN0UmVmLCBvcHRpb25zID0ge30pIHtcbiAgaWYgKCFpc1JlZihvYmplY3RSZWYpKVxuICAgIHJldHVybiB0b1JlZnMkMShvYmplY3RSZWYpO1xuICBjb25zdCByZXN1bHQgPSBBcnJheS5pc0FycmF5KG9iamVjdFJlZi52YWx1ZSkgPyBBcnJheS5mcm9tKHsgbGVuZ3RoOiBvYmplY3RSZWYudmFsdWUubGVuZ3RoIH0pIDoge307XG4gIGZvciAoY29uc3Qga2V5IGluIG9iamVjdFJlZi52YWx1ZSkge1xuICAgIHJlc3VsdFtrZXldID0gY3VzdG9tUmVmKCgpID0+ICh7XG4gICAgICBnZXQoKSB7XG4gICAgICAgIHJldHVybiBvYmplY3RSZWYudmFsdWVba2V5XTtcbiAgICAgIH0sXG4gICAgICBzZXQodikge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGNvbnN0IHJlcGxhY2VSZWYgPSAoX2EgPSB0b1ZhbHVlJDEob3B0aW9ucy5yZXBsYWNlUmVmKSkgIT0gbnVsbCA/IF9hIDogdHJ1ZTtcbiAgICAgICAgaWYgKHJlcGxhY2VSZWYpIHtcbiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvYmplY3RSZWYudmFsdWUpKSB7XG4gICAgICAgICAgICBjb25zdCBjb3B5ID0gWy4uLm9iamVjdFJlZi52YWx1ZV07XG4gICAgICAgICAgICBjb3B5W2tleV0gPSB2O1xuICAgICAgICAgICAgb2JqZWN0UmVmLnZhbHVlID0gY29weTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgbmV3T2JqZWN0ID0geyAuLi5vYmplY3RSZWYudmFsdWUsIFtrZXldOiB2IH07XG4gICAgICAgICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YobmV3T2JqZWN0LCBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0UmVmLnZhbHVlKSk7XG4gICAgICAgICAgICBvYmplY3RSZWYudmFsdWUgPSBuZXdPYmplY3Q7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG9iamVjdFJlZi52YWx1ZVtrZXldID0gdjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5jb25zdCB0b1ZhbHVlID0gdG9WYWx1ZSQxO1xuY29uc3QgcmVzb2x2ZVVucmVmID0gdG9WYWx1ZSQxO1xuXG5mdW5jdGlvbiB0cnlPbkJlZm9yZU1vdW50KGZuLCBzeW5jID0gdHJ1ZSwgdGFyZ2V0KSB7XG4gIGNvbnN0IGluc3RhbmNlID0gZ2V0TGlmZUN5Y2xlVGFyZ2V0KHRhcmdldCk7XG4gIGlmIChpbnN0YW5jZSlcbiAgICBvbkJlZm9yZU1vdW50KGZuLCB0YXJnZXQpO1xuICBlbHNlIGlmIChzeW5jKVxuICAgIGZuKCk7XG4gIGVsc2VcbiAgICBuZXh0VGljayhmbik7XG59XG5cbmZ1bmN0aW9uIHRyeU9uQmVmb3JlVW5tb3VudChmbiwgdGFyZ2V0KSB7XG4gIGNvbnN0IGluc3RhbmNlID0gZ2V0TGlmZUN5Y2xlVGFyZ2V0KHRhcmdldCk7XG4gIGlmIChpbnN0YW5jZSlcbiAgICBvbkJlZm9yZVVubW91bnQoZm4sIHRhcmdldCk7XG59XG5cbmZ1bmN0aW9uIHRyeU9uTW91bnRlZChmbiwgc3luYyA9IHRydWUsIHRhcmdldCkge1xuICBjb25zdCBpbnN0YW5jZSA9IGdldExpZmVDeWNsZVRhcmdldCh0YXJnZXQpO1xuICBpZiAoaW5zdGFuY2UpXG4gICAgb25Nb3VudGVkKGZuLCB0YXJnZXQpO1xuICBlbHNlIGlmIChzeW5jKVxuICAgIGZuKCk7XG4gIGVsc2VcbiAgICBuZXh0VGljayhmbik7XG59XG5cbmZ1bmN0aW9uIHRyeU9uVW5tb3VudGVkKGZuLCB0YXJnZXQpIHtcbiAgY29uc3QgaW5zdGFuY2UgPSBnZXRMaWZlQ3ljbGVUYXJnZXQodGFyZ2V0KTtcbiAgaWYgKGluc3RhbmNlKVxuICAgIG9uVW5tb3VudGVkKGZuLCB0YXJnZXQpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVVbnRpbChyLCBpc05vdCA9IGZhbHNlKSB7XG4gIGZ1bmN0aW9uIHRvTWF0Y2goY29uZGl0aW9uLCB7IGZsdXNoID0gXCJzeW5jXCIsIGRlZXAgPSBmYWxzZSwgdGltZW91dCwgdGhyb3dPblRpbWVvdXQgfSA9IHt9KSB7XG4gICAgbGV0IHN0b3AgPSBudWxsO1xuICAgIGNvbnN0IHdhdGNoZXIgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgc3RvcCA9IHdhdGNoKFxuICAgICAgICByLFxuICAgICAgICAodikgPT4ge1xuICAgICAgICAgIGlmIChjb25kaXRpb24odikgIT09IGlzTm90KSB7XG4gICAgICAgICAgICBpZiAoc3RvcClcbiAgICAgICAgICAgICAgc3RvcCgpO1xuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICBuZXh0VGljaygoKSA9PiBzdG9wID09IG51bGwgPyB2b2lkIDAgOiBzdG9wKCkpO1xuICAgICAgICAgICAgcmVzb2x2ZSh2KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBmbHVzaCxcbiAgICAgICAgICBkZWVwLFxuICAgICAgICAgIGltbWVkaWF0ZTogdHJ1ZVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICAgIGNvbnN0IHByb21pc2VzID0gW3dhdGNoZXJdO1xuICAgIGlmICh0aW1lb3V0ICE9IG51bGwpIHtcbiAgICAgIHByb21pc2VzLnB1c2goXG4gICAgICAgIHByb21pc2VUaW1lb3V0KHRpbWVvdXQsIHRocm93T25UaW1lb3V0KS50aGVuKCgpID0+IHRvVmFsdWUkMShyKSkuZmluYWxseSgoKSA9PiBzdG9wID09IG51bGwgPyB2b2lkIDAgOiBzdG9wKCkpXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yYWNlKHByb21pc2VzKTtcbiAgfVxuICBmdW5jdGlvbiB0b0JlKHZhbHVlLCBvcHRpb25zKSB7XG4gICAgaWYgKCFpc1JlZih2YWx1ZSkpXG4gICAgICByZXR1cm4gdG9NYXRjaCgodikgPT4gdiA9PT0gdmFsdWUsIG9wdGlvbnMpO1xuICAgIGNvbnN0IHsgZmx1c2ggPSBcInN5bmNcIiwgZGVlcCA9IGZhbHNlLCB0aW1lb3V0LCB0aHJvd09uVGltZW91dCB9ID0gb3B0aW9ucyAhPSBudWxsID8gb3B0aW9ucyA6IHt9O1xuICAgIGxldCBzdG9wID0gbnVsbDtcbiAgICBjb25zdCB3YXRjaGVyID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIHN0b3AgPSB3YXRjaChcbiAgICAgICAgW3IsIHZhbHVlXSxcbiAgICAgICAgKFt2MSwgdjJdKSA9PiB7XG4gICAgICAgICAgaWYgKGlzTm90ICE9PSAodjEgPT09IHYyKSkge1xuICAgICAgICAgICAgaWYgKHN0b3ApXG4gICAgICAgICAgICAgIHN0b3AoKTtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgbmV4dFRpY2soKCkgPT4gc3RvcCA9PSBudWxsID8gdm9pZCAwIDogc3RvcCgpKTtcbiAgICAgICAgICAgIHJlc29sdmUodjEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGZsdXNoLFxuICAgICAgICAgIGRlZXAsXG4gICAgICAgICAgaW1tZWRpYXRlOiB0cnVlXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gICAgY29uc3QgcHJvbWlzZXMgPSBbd2F0Y2hlcl07XG4gICAgaWYgKHRpbWVvdXQgIT0gbnVsbCkge1xuICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgcHJvbWlzZVRpbWVvdXQodGltZW91dCwgdGhyb3dPblRpbWVvdXQpLnRoZW4oKCkgPT4gdG9WYWx1ZSQxKHIpKS5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgICBzdG9wID09IG51bGwgPyB2b2lkIDAgOiBzdG9wKCk7XG4gICAgICAgICAgcmV0dXJuIHRvVmFsdWUkMShyKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJhY2UocHJvbWlzZXMpO1xuICB9XG4gIGZ1bmN0aW9uIHRvQmVUcnV0aHkob3B0aW9ucykge1xuICAgIHJldHVybiB0b01hdGNoKCh2KSA9PiBCb29sZWFuKHYpLCBvcHRpb25zKTtcbiAgfVxuICBmdW5jdGlvbiB0b0JlTnVsbChvcHRpb25zKSB7XG4gICAgcmV0dXJuIHRvQmUobnVsbCwgb3B0aW9ucyk7XG4gIH1cbiAgZnVuY3Rpb24gdG9CZVVuZGVmaW5lZChvcHRpb25zKSB7XG4gICAgcmV0dXJuIHRvQmUodm9pZCAwLCBvcHRpb25zKTtcbiAgfVxuICBmdW5jdGlvbiB0b0JlTmFOKG9wdGlvbnMpIHtcbiAgICByZXR1cm4gdG9NYXRjaChOdW1iZXIuaXNOYU4sIG9wdGlvbnMpO1xuICB9XG4gIGZ1bmN0aW9uIHRvQ29udGFpbnModmFsdWUsIG9wdGlvbnMpIHtcbiAgICByZXR1cm4gdG9NYXRjaCgodikgPT4ge1xuICAgICAgY29uc3QgYXJyYXkgPSBBcnJheS5mcm9tKHYpO1xuICAgICAgcmV0dXJuIGFycmF5LmluY2x1ZGVzKHZhbHVlKSB8fCBhcnJheS5pbmNsdWRlcyh0b1ZhbHVlJDEodmFsdWUpKTtcbiAgICB9LCBvcHRpb25zKTtcbiAgfVxuICBmdW5jdGlvbiBjaGFuZ2VkKG9wdGlvbnMpIHtcbiAgICByZXR1cm4gY2hhbmdlZFRpbWVzKDEsIG9wdGlvbnMpO1xuICB9XG4gIGZ1bmN0aW9uIGNoYW5nZWRUaW1lcyhuID0gMSwgb3B0aW9ucykge1xuICAgIGxldCBjb3VudCA9IC0xO1xuICAgIHJldHVybiB0b01hdGNoKCgpID0+IHtcbiAgICAgIGNvdW50ICs9IDE7XG4gICAgICByZXR1cm4gY291bnQgPj0gbjtcbiAgICB9LCBvcHRpb25zKTtcbiAgfVxuICBpZiAoQXJyYXkuaXNBcnJheSh0b1ZhbHVlJDEocikpKSB7XG4gICAgY29uc3QgaW5zdGFuY2UgPSB7XG4gICAgICB0b01hdGNoLFxuICAgICAgdG9Db250YWlucyxcbiAgICAgIGNoYW5nZWQsXG4gICAgICBjaGFuZ2VkVGltZXMsXG4gICAgICBnZXQgbm90KCkge1xuICAgICAgICByZXR1cm4gY3JlYXRlVW50aWwociwgIWlzTm90KTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHJldHVybiBpbnN0YW5jZTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBpbnN0YW5jZSA9IHtcbiAgICAgIHRvTWF0Y2gsXG4gICAgICB0b0JlLFxuICAgICAgdG9CZVRydXRoeSxcbiAgICAgIHRvQmVOdWxsLFxuICAgICAgdG9CZU5hTixcbiAgICAgIHRvQmVVbmRlZmluZWQsXG4gICAgICBjaGFuZ2VkLFxuICAgICAgY2hhbmdlZFRpbWVzLFxuICAgICAgZ2V0IG5vdCgpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZVVudGlsKHIsICFpc05vdCk7XG4gICAgICB9XG4gICAgfTtcbiAgICByZXR1cm4gaW5zdGFuY2U7XG4gIH1cbn1cbmZ1bmN0aW9uIHVudGlsKHIpIHtcbiAgcmV0dXJuIGNyZWF0ZVVudGlsKHIpO1xufVxuXG5mdW5jdGlvbiBkZWZhdWx0Q29tcGFyYXRvcih2YWx1ZSwgb3RoVmFsKSB7XG4gIHJldHVybiB2YWx1ZSA9PT0gb3RoVmFsO1xufVxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUFycmF5RGlmZmVyZW5jZSguLi5hcmdzKSB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IGxpc3QgPSBhcmdzWzBdO1xuICBjb25zdCB2YWx1ZXMgPSBhcmdzWzFdO1xuICBsZXQgY29tcGFyZUZuID0gKF9hID0gYXJnc1syXSkgIT0gbnVsbCA/IF9hIDogZGVmYXVsdENvbXBhcmF0b3I7XG4gIGNvbnN0IHtcbiAgICBzeW1tZXRyaWMgPSBmYWxzZVxuICB9ID0gKF9iID0gYXJnc1szXSkgIT0gbnVsbCA/IF9iIDoge307XG4gIGlmICh0eXBlb2YgY29tcGFyZUZuID09PSBcInN0cmluZ1wiKSB7XG4gICAgY29uc3Qga2V5ID0gY29tcGFyZUZuO1xuICAgIGNvbXBhcmVGbiA9ICh2YWx1ZSwgb3RoVmFsKSA9PiB2YWx1ZVtrZXldID09PSBvdGhWYWxba2V5XTtcbiAgfVxuICBjb25zdCBkaWZmMSA9IGNvbXB1dGVkKCgpID0+IHRvVmFsdWUkMShsaXN0KS5maWx0ZXIoKHgpID0+IHRvVmFsdWUkMSh2YWx1ZXMpLmZpbmRJbmRleCgoeSkgPT4gY29tcGFyZUZuKHgsIHkpKSA9PT0gLTEpKTtcbiAgaWYgKHN5bW1ldHJpYykge1xuICAgIGNvbnN0IGRpZmYyID0gY29tcHV0ZWQoKCkgPT4gdG9WYWx1ZSQxKHZhbHVlcykuZmlsdGVyKCh4KSA9PiB0b1ZhbHVlJDEobGlzdCkuZmluZEluZGV4KCh5KSA9PiBjb21wYXJlRm4oeCwgeSkpID09PSAtMSkpO1xuICAgIHJldHVybiBjb21wdXRlZCgoKSA9PiBzeW1tZXRyaWMgPyBbLi4udG9WYWx1ZSQxKGRpZmYxKSwgLi4udG9WYWx1ZSQxKGRpZmYyKV0gOiB0b1ZhbHVlJDEoZGlmZjEpKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZGlmZjE7XG4gIH1cbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUFycmF5RXZlcnkobGlzdCwgZm4pIHtcbiAgcmV0dXJuIGNvbXB1dGVkKCgpID0+IHRvVmFsdWUkMShsaXN0KS5ldmVyeSgoZWxlbWVudCwgaW5kZXgsIGFycmF5KSA9PiBmbih0b1ZhbHVlJDEoZWxlbWVudCksIGluZGV4LCBhcnJheSkpKTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUFycmF5RmlsdGVyKGxpc3QsIGZuKSB7XG4gIHJldHVybiBjb21wdXRlZCgoKSA9PiB0b1ZhbHVlJDEobGlzdCkubWFwKChpKSA9PiB0b1ZhbHVlJDEoaSkpLmZpbHRlcihmbikpO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlQXJyYXlGaW5kKGxpc3QsIGZuKSB7XG4gIHJldHVybiBjb21wdXRlZCgoKSA9PiB0b1ZhbHVlJDEoXG4gICAgdG9WYWx1ZSQxKGxpc3QpLmZpbmQoKGVsZW1lbnQsIGluZGV4LCBhcnJheSkgPT4gZm4odG9WYWx1ZSQxKGVsZW1lbnQpLCBpbmRleCwgYXJyYXkpKVxuICApKTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUFycmF5RmluZEluZGV4KGxpc3QsIGZuKSB7XG4gIHJldHVybiBjb21wdXRlZCgoKSA9PiB0b1ZhbHVlJDEobGlzdCkuZmluZEluZGV4KChlbGVtZW50LCBpbmRleCwgYXJyYXkpID0+IGZuKHRvVmFsdWUkMShlbGVtZW50KSwgaW5kZXgsIGFycmF5KSkpO1xufVxuXG5mdW5jdGlvbiBmaW5kTGFzdChhcnIsIGNiKSB7XG4gIGxldCBpbmRleCA9IGFyci5sZW5ndGg7XG4gIHdoaWxlIChpbmRleC0tID4gMCkge1xuICAgIGlmIChjYihhcnJbaW5kZXhdLCBpbmRleCwgYXJyKSlcbiAgICAgIHJldHVybiBhcnJbaW5kZXhdO1xuICB9XG4gIHJldHVybiB2b2lkIDA7XG59XG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlQXJyYXlGaW5kTGFzdChsaXN0LCBmbikge1xuICByZXR1cm4gY29tcHV0ZWQoKCkgPT4gdG9WYWx1ZSQxKFxuICAgICFBcnJheS5wcm90b3R5cGUuZmluZExhc3QgPyBmaW5kTGFzdCh0b1ZhbHVlJDEobGlzdCksIChlbGVtZW50LCBpbmRleCwgYXJyYXkpID0+IGZuKHRvVmFsdWUkMShlbGVtZW50KSwgaW5kZXgsIGFycmF5KSkgOiB0b1ZhbHVlJDEobGlzdCkuZmluZExhc3QoKGVsZW1lbnQsIGluZGV4LCBhcnJheSkgPT4gZm4odG9WYWx1ZSQxKGVsZW1lbnQpLCBpbmRleCwgYXJyYXkpKVxuICApKTtcbn1cblxuZnVuY3Rpb24gaXNBcnJheUluY2x1ZGVzT3B0aW9ucyhvYmopIHtcbiAgcmV0dXJuIGlzT2JqZWN0KG9iaikgJiYgY29udGFpbnNQcm9wKG9iaiwgXCJmb3JtSW5kZXhcIiwgXCJjb21wYXJhdG9yXCIpO1xufVxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUFycmF5SW5jbHVkZXMoLi4uYXJncykge1xuICB2YXIgX2E7XG4gIGNvbnN0IGxpc3QgPSBhcmdzWzBdO1xuICBjb25zdCB2YWx1ZSA9IGFyZ3NbMV07XG4gIGxldCBjb21wYXJhdG9yID0gYXJnc1syXTtcbiAgbGV0IGZvcm1JbmRleCA9IDA7XG4gIGlmIChpc0FycmF5SW5jbHVkZXNPcHRpb25zKGNvbXBhcmF0b3IpKSB7XG4gICAgZm9ybUluZGV4ID0gKF9hID0gY29tcGFyYXRvci5mcm9tSW5kZXgpICE9IG51bGwgPyBfYSA6IDA7XG4gICAgY29tcGFyYXRvciA9IGNvbXBhcmF0b3IuY29tcGFyYXRvcjtcbiAgfVxuICBpZiAodHlwZW9mIGNvbXBhcmF0b3IgPT09IFwic3RyaW5nXCIpIHtcbiAgICBjb25zdCBrZXkgPSBjb21wYXJhdG9yO1xuICAgIGNvbXBhcmF0b3IgPSAoZWxlbWVudCwgdmFsdWUyKSA9PiBlbGVtZW50W2tleV0gPT09IHRvVmFsdWUkMSh2YWx1ZTIpO1xuICB9XG4gIGNvbXBhcmF0b3IgPSBjb21wYXJhdG9yICE9IG51bGwgPyBjb21wYXJhdG9yIDogKGVsZW1lbnQsIHZhbHVlMikgPT4gZWxlbWVudCA9PT0gdG9WYWx1ZSQxKHZhbHVlMik7XG4gIHJldHVybiBjb21wdXRlZCgoKSA9PiB0b1ZhbHVlJDEobGlzdCkuc2xpY2UoZm9ybUluZGV4KS5zb21lKChlbGVtZW50LCBpbmRleCwgYXJyYXkpID0+IGNvbXBhcmF0b3IoXG4gICAgdG9WYWx1ZSQxKGVsZW1lbnQpLFxuICAgIHRvVmFsdWUkMSh2YWx1ZSksXG4gICAgaW5kZXgsXG4gICAgdG9WYWx1ZSQxKGFycmF5KVxuICApKSk7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VBcnJheUpvaW4obGlzdCwgc2VwYXJhdG9yKSB7XG4gIHJldHVybiBjb21wdXRlZCgoKSA9PiB0b1ZhbHVlJDEobGlzdCkubWFwKChpKSA9PiB0b1ZhbHVlJDEoaSkpLmpvaW4odG9WYWx1ZSQxKHNlcGFyYXRvcikpKTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUFycmF5TWFwKGxpc3QsIGZuKSB7XG4gIHJldHVybiBjb21wdXRlZCgoKSA9PiB0b1ZhbHVlJDEobGlzdCkubWFwKChpKSA9PiB0b1ZhbHVlJDEoaSkpLm1hcChmbikpO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlQXJyYXlSZWR1Y2UobGlzdCwgcmVkdWNlciwgLi4uYXJncykge1xuICBjb25zdCByZWR1Y2VDYWxsYmFjayA9IChzdW0sIHZhbHVlLCBpbmRleCkgPT4gcmVkdWNlcih0b1ZhbHVlJDEoc3VtKSwgdG9WYWx1ZSQxKHZhbHVlKSwgaW5kZXgpO1xuICByZXR1cm4gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGNvbnN0IHJlc29sdmVkID0gdG9WYWx1ZSQxKGxpc3QpO1xuICAgIHJldHVybiBhcmdzLmxlbmd0aCA/IHJlc29sdmVkLnJlZHVjZShyZWR1Y2VDYWxsYmFjaywgdHlwZW9mIGFyZ3NbMF0gPT09IFwiZnVuY3Rpb25cIiA/IHRvVmFsdWUkMShhcmdzWzBdKCkpIDogdG9WYWx1ZSQxKGFyZ3NbMF0pKSA6IHJlc29sdmVkLnJlZHVjZShyZWR1Y2VDYWxsYmFjayk7XG4gIH0pO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlQXJyYXlTb21lKGxpc3QsIGZuKSB7XG4gIHJldHVybiBjb21wdXRlZCgoKSA9PiB0b1ZhbHVlJDEobGlzdCkuc29tZSgoZWxlbWVudCwgaW5kZXgsIGFycmF5KSA9PiBmbih0b1ZhbHVlJDEoZWxlbWVudCksIGluZGV4LCBhcnJheSkpKTtcbn1cblxuZnVuY3Rpb24gdW5pcShhcnJheSkge1xuICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KGFycmF5KSk7XG59XG5mdW5jdGlvbiB1bmlxdWVFbGVtZW50c0J5KGFycmF5LCBmbikge1xuICByZXR1cm4gYXJyYXkucmVkdWNlKChhY2MsIHYpID0+IHtcbiAgICBpZiAoIWFjYy5zb21lKCh4KSA9PiBmbih2LCB4LCBhcnJheSkpKVxuICAgICAgYWNjLnB1c2godik7XG4gICAgcmV0dXJuIGFjYztcbiAgfSwgW10pO1xufVxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUFycmF5VW5pcXVlKGxpc3QsIGNvbXBhcmVGbikge1xuICByZXR1cm4gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGNvbnN0IHJlc29sdmVkTGlzdCA9IHRvVmFsdWUkMShsaXN0KS5tYXAoKGVsZW1lbnQpID0+IHRvVmFsdWUkMShlbGVtZW50KSk7XG4gICAgcmV0dXJuIGNvbXBhcmVGbiA/IHVuaXF1ZUVsZW1lbnRzQnkocmVzb2x2ZWRMaXN0LCBjb21wYXJlRm4pIDogdW5pcShyZXNvbHZlZExpc3QpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gdXNlQ291bnRlcihpbml0aWFsVmFsdWUgPSAwLCBvcHRpb25zID0ge30pIHtcbiAgbGV0IF9pbml0aWFsVmFsdWUgPSB1bnJlZihpbml0aWFsVmFsdWUpO1xuICBjb25zdCBjb3VudCA9IHNoYWxsb3dSZWYoaW5pdGlhbFZhbHVlKTtcbiAgY29uc3Qge1xuICAgIG1heCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSxcbiAgICBtaW4gPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFlcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGluYyA9IChkZWx0YSA9IDEpID0+IGNvdW50LnZhbHVlID0gTWF0aC5tYXgoTWF0aC5taW4obWF4LCBjb3VudC52YWx1ZSArIGRlbHRhKSwgbWluKTtcbiAgY29uc3QgZGVjID0gKGRlbHRhID0gMSkgPT4gY291bnQudmFsdWUgPSBNYXRoLm1pbihNYXRoLm1heChtaW4sIGNvdW50LnZhbHVlIC0gZGVsdGEpLCBtYXgpO1xuICBjb25zdCBnZXQgPSAoKSA9PiBjb3VudC52YWx1ZTtcbiAgY29uc3Qgc2V0ID0gKHZhbCkgPT4gY291bnQudmFsdWUgPSBNYXRoLm1heChtaW4sIE1hdGgubWluKG1heCwgdmFsKSk7XG4gIGNvbnN0IHJlc2V0ID0gKHZhbCA9IF9pbml0aWFsVmFsdWUpID0+IHtcbiAgICBfaW5pdGlhbFZhbHVlID0gdmFsO1xuICAgIHJldHVybiBzZXQodmFsKTtcbiAgfTtcbiAgcmV0dXJuIHsgY291bnQ6IHNoYWxsb3dSZWFkb25seShjb3VudCksIGluYywgZGVjLCBnZXQsIHNldCwgcmVzZXQgfTtcbn1cblxuY29uc3QgUkVHRVhfUEFSU0UgPSAvXihcXGR7NH0pWy0vXT8oXFxkezEsMn0pP1stL10/KFxcZHswLDJ9KVtUXFxzXSooXFxkezEsMn0pPzo/KFxcZHsxLDJ9KT86PyhcXGR7MSwyfSk/Wy46XT8oXFxkKyk/JC9pO1xuY29uc3QgUkVHRVhfRk9STUFUID0gL1tZTURIaG1zXW98XFxbKFteXFxdXSspXFxdfFl7MSw0fXxNezEsNH18RHsxLDJ9fGR7MSw0fXxIezEsMn18aHsxLDJ9fGF7MSwyfXxBezEsMn18bXsxLDJ9fHN7MSwyfXxaezEsMn18ensxLDR9fFNTUy9nO1xuZnVuY3Rpb24gZGVmYXVsdE1lcmlkaWVtKGhvdXJzLCBtaW51dGVzLCBpc0xvd2VyY2FzZSwgaGFzUGVyaW9kKSB7XG4gIGxldCBtID0gaG91cnMgPCAxMiA/IFwiQU1cIiA6IFwiUE1cIjtcbiAgaWYgKGhhc1BlcmlvZClcbiAgICBtID0gbS5zcGxpdChcIlwiKS5yZWR1Y2UoKGFjYywgY3VycikgPT4gYWNjICs9IGAke2N1cnJ9LmAsIFwiXCIpO1xuICByZXR1cm4gaXNMb3dlcmNhc2UgPyBtLnRvTG93ZXJDYXNlKCkgOiBtO1xufVxuZnVuY3Rpb24gZm9ybWF0T3JkaW5hbChudW0pIHtcbiAgY29uc3Qgc3VmZml4ZXMgPSBbXCJ0aFwiLCBcInN0XCIsIFwibmRcIiwgXCJyZFwiXTtcbiAgY29uc3QgdiA9IG51bSAlIDEwMDtcbiAgcmV0dXJuIG51bSArIChzdWZmaXhlc1sodiAtIDIwKSAlIDEwXSB8fCBzdWZmaXhlc1t2XSB8fCBzdWZmaXhlc1swXSk7XG59XG5mdW5jdGlvbiBmb3JtYXREYXRlKGRhdGUsIGZvcm1hdFN0ciwgb3B0aW9ucyA9IHt9KSB7XG4gIHZhciBfYTtcbiAgY29uc3QgeWVhcnMgPSBkYXRlLmdldEZ1bGxZZWFyKCk7XG4gIGNvbnN0IG1vbnRoID0gZGF0ZS5nZXRNb250aCgpO1xuICBjb25zdCBkYXlzID0gZGF0ZS5nZXREYXRlKCk7XG4gIGNvbnN0IGhvdXJzID0gZGF0ZS5nZXRIb3VycygpO1xuICBjb25zdCBtaW51dGVzID0gZGF0ZS5nZXRNaW51dGVzKCk7XG4gIGNvbnN0IHNlY29uZHMgPSBkYXRlLmdldFNlY29uZHMoKTtcbiAgY29uc3QgbWlsbGlzZWNvbmRzID0gZGF0ZS5nZXRNaWxsaXNlY29uZHMoKTtcbiAgY29uc3QgZGF5ID0gZGF0ZS5nZXREYXkoKTtcbiAgY29uc3QgbWVyaWRpZW0gPSAoX2EgPSBvcHRpb25zLmN1c3RvbU1lcmlkaWVtKSAhPSBudWxsID8gX2EgOiBkZWZhdWx0TWVyaWRpZW07XG4gIGNvbnN0IHN0cmlwVGltZVpvbmUgPSAoZGF0ZVN0cmluZykgPT4ge1xuICAgIHZhciBfYTI7XG4gICAgcmV0dXJuIChfYTIgPSBkYXRlU3RyaW5nLnNwbGl0KFwiIFwiKVsxXSkgIT0gbnVsbCA/IF9hMiA6IFwiXCI7XG4gIH07XG4gIGNvbnN0IG1hdGNoZXMgPSB7XG4gICAgWW86ICgpID0+IGZvcm1hdE9yZGluYWwoeWVhcnMpLFxuICAgIFlZOiAoKSA9PiBTdHJpbmcoeWVhcnMpLnNsaWNlKC0yKSxcbiAgICBZWVlZOiAoKSA9PiB5ZWFycyxcbiAgICBNOiAoKSA9PiBtb250aCArIDEsXG4gICAgTW86ICgpID0+IGZvcm1hdE9yZGluYWwobW9udGggKyAxKSxcbiAgICBNTTogKCkgPT4gYCR7bW9udGggKyAxfWAucGFkU3RhcnQoMiwgXCIwXCIpLFxuICAgIE1NTTogKCkgPT4gZGF0ZS50b0xvY2FsZURhdGVTdHJpbmcodG9WYWx1ZSQxKG9wdGlvbnMubG9jYWxlcyksIHsgbW9udGg6IFwic2hvcnRcIiB9KSxcbiAgICBNTU1NOiAoKSA9PiBkYXRlLnRvTG9jYWxlRGF0ZVN0cmluZyh0b1ZhbHVlJDEob3B0aW9ucy5sb2NhbGVzKSwgeyBtb250aDogXCJsb25nXCIgfSksXG4gICAgRDogKCkgPT4gU3RyaW5nKGRheXMpLFxuICAgIERvOiAoKSA9PiBmb3JtYXRPcmRpbmFsKGRheXMpLFxuICAgIEREOiAoKSA9PiBgJHtkYXlzfWAucGFkU3RhcnQoMiwgXCIwXCIpLFxuICAgIEg6ICgpID0+IFN0cmluZyhob3VycyksXG4gICAgSG86ICgpID0+IGZvcm1hdE9yZGluYWwoaG91cnMpLFxuICAgIEhIOiAoKSA9PiBgJHtob3Vyc31gLnBhZFN0YXJ0KDIsIFwiMFwiKSxcbiAgICBoOiAoKSA9PiBgJHtob3VycyAlIDEyIHx8IDEyfWAucGFkU3RhcnQoMSwgXCIwXCIpLFxuICAgIGhvOiAoKSA9PiBmb3JtYXRPcmRpbmFsKGhvdXJzICUgMTIgfHwgMTIpLFxuICAgIGhoOiAoKSA9PiBgJHtob3VycyAlIDEyIHx8IDEyfWAucGFkU3RhcnQoMiwgXCIwXCIpLFxuICAgIG06ICgpID0+IFN0cmluZyhtaW51dGVzKSxcbiAgICBtbzogKCkgPT4gZm9ybWF0T3JkaW5hbChtaW51dGVzKSxcbiAgICBtbTogKCkgPT4gYCR7bWludXRlc31gLnBhZFN0YXJ0KDIsIFwiMFwiKSxcbiAgICBzOiAoKSA9PiBTdHJpbmcoc2Vjb25kcyksXG4gICAgc286ICgpID0+IGZvcm1hdE9yZGluYWwoc2Vjb25kcyksXG4gICAgc3M6ICgpID0+IGAke3NlY29uZHN9YC5wYWRTdGFydCgyLCBcIjBcIiksXG4gICAgU1NTOiAoKSA9PiBgJHttaWxsaXNlY29uZHN9YC5wYWRTdGFydCgzLCBcIjBcIiksXG4gICAgZDogKCkgPT4gZGF5LFxuICAgIGRkOiAoKSA9PiBkYXRlLnRvTG9jYWxlRGF0ZVN0cmluZyh0b1ZhbHVlJDEob3B0aW9ucy5sb2NhbGVzKSwgeyB3ZWVrZGF5OiBcIm5hcnJvd1wiIH0pLFxuICAgIGRkZDogKCkgPT4gZGF0ZS50b0xvY2FsZURhdGVTdHJpbmcodG9WYWx1ZSQxKG9wdGlvbnMubG9jYWxlcyksIHsgd2Vla2RheTogXCJzaG9ydFwiIH0pLFxuICAgIGRkZGQ6ICgpID0+IGRhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKHRvVmFsdWUkMShvcHRpb25zLmxvY2FsZXMpLCB7IHdlZWtkYXk6IFwibG9uZ1wiIH0pLFxuICAgIEE6ICgpID0+IG1lcmlkaWVtKGhvdXJzLCBtaW51dGVzKSxcbiAgICBBQTogKCkgPT4gbWVyaWRpZW0oaG91cnMsIG1pbnV0ZXMsIGZhbHNlLCB0cnVlKSxcbiAgICBhOiAoKSA9PiBtZXJpZGllbShob3VycywgbWludXRlcywgdHJ1ZSksXG4gICAgYWE6ICgpID0+IG1lcmlkaWVtKGhvdXJzLCBtaW51dGVzLCB0cnVlLCB0cnVlKSxcbiAgICB6OiAoKSA9PiBzdHJpcFRpbWVab25lKGRhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKHRvVmFsdWUkMShvcHRpb25zLmxvY2FsZXMpLCB7IHRpbWVab25lTmFtZTogXCJzaG9ydE9mZnNldFwiIH0pKSxcbiAgICB6ejogKCkgPT4gc3RyaXBUaW1lWm9uZShkYXRlLnRvTG9jYWxlRGF0ZVN0cmluZyh0b1ZhbHVlJDEob3B0aW9ucy5sb2NhbGVzKSwgeyB0aW1lWm9uZU5hbWU6IFwic2hvcnRPZmZzZXRcIiB9KSksXG4gICAgenp6OiAoKSA9PiBzdHJpcFRpbWVab25lKGRhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKHRvVmFsdWUkMShvcHRpb25zLmxvY2FsZXMpLCB7IHRpbWVab25lTmFtZTogXCJzaG9ydE9mZnNldFwiIH0pKSxcbiAgICB6enp6OiAoKSA9PiBzdHJpcFRpbWVab25lKGRhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKHRvVmFsdWUkMShvcHRpb25zLmxvY2FsZXMpLCB7IHRpbWVab25lTmFtZTogXCJsb25nT2Zmc2V0XCIgfSkpXG4gIH07XG4gIHJldHVybiBmb3JtYXRTdHIucmVwbGFjZShSRUdFWF9GT1JNQVQsIChtYXRjaCwgJDEpID0+IHtcbiAgICB2YXIgX2EyLCBfYjtcbiAgICByZXR1cm4gKF9iID0gJDEgIT0gbnVsbCA/ICQxIDogKF9hMiA9IG1hdGNoZXNbbWF0Y2hdKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLmNhbGwobWF0Y2hlcykpICE9IG51bGwgPyBfYiA6IG1hdGNoO1xuICB9KTtcbn1cbmZ1bmN0aW9uIG5vcm1hbGl6ZURhdGUoZGF0ZSkge1xuICBpZiAoZGF0ZSA9PT0gbnVsbClcbiAgICByZXR1cm4gbmV3IERhdGUoTnVtYmVyLk5hTik7XG4gIGlmIChkYXRlID09PSB2b2lkIDApXG4gICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpO1xuICBpZiAoZGF0ZSBpbnN0YW5jZW9mIERhdGUpXG4gICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUpO1xuICBpZiAodHlwZW9mIGRhdGUgPT09IFwic3RyaW5nXCIgJiYgIS9aJC9pLnRlc3QoZGF0ZSkpIHtcbiAgICBjb25zdCBkID0gZGF0ZS5tYXRjaChSRUdFWF9QQVJTRSk7XG4gICAgaWYgKGQpIHtcbiAgICAgIGNvbnN0IG0gPSBkWzJdIC0gMSB8fCAwO1xuICAgICAgY29uc3QgbXMgPSAoZFs3XSB8fCBcIjBcIikuc3Vic3RyaW5nKDAsIDMpO1xuICAgICAgcmV0dXJuIG5ldyBEYXRlKGRbMV0sIG0sIGRbM10gfHwgMSwgZFs0XSB8fCAwLCBkWzVdIHx8IDAsIGRbNl0gfHwgMCwgbXMpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gbmV3IERhdGUoZGF0ZSk7XG59XG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlRGF0ZUZvcm1hdChkYXRlLCBmb3JtYXRTdHIgPSBcIkhIOm1tOnNzXCIsIG9wdGlvbnMgPSB7fSkge1xuICByZXR1cm4gY29tcHV0ZWQoKCkgPT4gZm9ybWF0RGF0ZShub3JtYWxpemVEYXRlKHRvVmFsdWUkMShkYXRlKSksIHRvVmFsdWUkMShmb3JtYXRTdHIpLCBvcHRpb25zKSk7XG59XG5cbmZ1bmN0aW9uIHVzZUludGVydmFsRm4oY2IsIGludGVydmFsID0gMWUzLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGltbWVkaWF0ZSA9IHRydWUsXG4gICAgaW1tZWRpYXRlQ2FsbGJhY2sgPSBmYWxzZVxuICB9ID0gb3B0aW9ucztcbiAgbGV0IHRpbWVyID0gbnVsbDtcbiAgY29uc3QgaXNBY3RpdmUgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgZnVuY3Rpb24gY2xlYW4oKSB7XG4gICAgaWYgKHRpbWVyKSB7XG4gICAgICBjbGVhckludGVydmFsKHRpbWVyKTtcbiAgICAgIHRpbWVyID0gbnVsbDtcbiAgICB9XG4gIH1cbiAgZnVuY3Rpb24gcGF1c2UoKSB7XG4gICAgaXNBY3RpdmUudmFsdWUgPSBmYWxzZTtcbiAgICBjbGVhbigpO1xuICB9XG4gIGZ1bmN0aW9uIHJlc3VtZSgpIHtcbiAgICBjb25zdCBpbnRlcnZhbFZhbHVlID0gdG9WYWx1ZSQxKGludGVydmFsKTtcbiAgICBpZiAoaW50ZXJ2YWxWYWx1ZSA8PSAwKVxuICAgICAgcmV0dXJuO1xuICAgIGlzQWN0aXZlLnZhbHVlID0gdHJ1ZTtcbiAgICBpZiAoaW1tZWRpYXRlQ2FsbGJhY2spXG4gICAgICBjYigpO1xuICAgIGNsZWFuKCk7XG4gICAgaWYgKGlzQWN0aXZlLnZhbHVlKVxuICAgICAgdGltZXIgPSBzZXRJbnRlcnZhbChjYiwgaW50ZXJ2YWxWYWx1ZSk7XG4gIH1cbiAgaWYgKGltbWVkaWF0ZSAmJiBpc0NsaWVudClcbiAgICByZXN1bWUoKTtcbiAgaWYgKGlzUmVmKGludGVydmFsKSB8fCB0eXBlb2YgaW50ZXJ2YWwgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIGNvbnN0IHN0b3BXYXRjaCA9IHdhdGNoKGludGVydmFsLCAoKSA9PiB7XG4gICAgICBpZiAoaXNBY3RpdmUudmFsdWUgJiYgaXNDbGllbnQpXG4gICAgICAgIHJlc3VtZSgpO1xuICAgIH0pO1xuICAgIHRyeU9uU2NvcGVEaXNwb3NlKHN0b3BXYXRjaCk7XG4gIH1cbiAgdHJ5T25TY29wZURpc3Bvc2UocGF1c2UpO1xuICByZXR1cm4ge1xuICAgIGlzQWN0aXZlOiBzaGFsbG93UmVhZG9ubHkoaXNBY3RpdmUpLFxuICAgIHBhdXNlLFxuICAgIHJlc3VtZVxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VJbnRlcnZhbChpbnRlcnZhbCA9IDFlMywgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBjb250cm9sczogZXhwb3NlQ29udHJvbHMgPSBmYWxzZSxcbiAgICBpbW1lZGlhdGUgPSB0cnVlLFxuICAgIGNhbGxiYWNrXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBjb3VudGVyID0gc2hhbGxvd1JlZigwKTtcbiAgY29uc3QgdXBkYXRlID0gKCkgPT4gY291bnRlci52YWx1ZSArPSAxO1xuICBjb25zdCByZXNldCA9ICgpID0+IHtcbiAgICBjb3VudGVyLnZhbHVlID0gMDtcbiAgfTtcbiAgY29uc3QgY29udHJvbHMgPSB1c2VJbnRlcnZhbEZuKFxuICAgIGNhbGxiYWNrID8gKCkgPT4ge1xuICAgICAgdXBkYXRlKCk7XG4gICAgICBjYWxsYmFjayhjb3VudGVyLnZhbHVlKTtcbiAgICB9IDogdXBkYXRlLFxuICAgIGludGVydmFsLFxuICAgIHsgaW1tZWRpYXRlIH1cbiAgKTtcbiAgaWYgKGV4cG9zZUNvbnRyb2xzKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvdW50ZXI6IHNoYWxsb3dSZWFkb25seShjb3VudGVyKSxcbiAgICAgIHJlc2V0LFxuICAgICAgLi4uY29udHJvbHNcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBzaGFsbG93UmVhZG9ubHkoY291bnRlcik7XG4gIH1cbn1cblxuZnVuY3Rpb24gdXNlTGFzdENoYW5nZWQoc291cmNlLCBvcHRpb25zID0ge30pIHtcbiAgdmFyIF9hO1xuICBjb25zdCBtcyA9IHNoYWxsb3dSZWYoKF9hID0gb3B0aW9ucy5pbml0aWFsVmFsdWUpICE9IG51bGwgPyBfYSA6IG51bGwpO1xuICB3YXRjaChcbiAgICBzb3VyY2UsXG4gICAgKCkgPT4gbXMudmFsdWUgPSB0aW1lc3RhbXAoKSxcbiAgICBvcHRpb25zXG4gICk7XG4gIHJldHVybiBzaGFsbG93UmVhZG9ubHkobXMpO1xufVxuXG5mdW5jdGlvbiB1c2VUaW1lb3V0Rm4oY2IsIGludGVydmFsLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGltbWVkaWF0ZSA9IHRydWUsXG4gICAgaW1tZWRpYXRlQ2FsbGJhY2sgPSBmYWxzZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgaXNQZW5kaW5nID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGxldCB0aW1lcjtcbiAgZnVuY3Rpb24gY2xlYXIoKSB7XG4gICAgaWYgKHRpbWVyKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgdGltZXIgPSB2b2lkIDA7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIHN0b3AoKSB7XG4gICAgaXNQZW5kaW5nLnZhbHVlID0gZmFsc2U7XG4gICAgY2xlYXIoKTtcbiAgfVxuICBmdW5jdGlvbiBzdGFydCguLi5hcmdzKSB7XG4gICAgaWYgKGltbWVkaWF0ZUNhbGxiYWNrKVxuICAgICAgY2IoKTtcbiAgICBjbGVhcigpO1xuICAgIGlzUGVuZGluZy52YWx1ZSA9IHRydWU7XG4gICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGlzUGVuZGluZy52YWx1ZSA9IGZhbHNlO1xuICAgICAgdGltZXIgPSB2b2lkIDA7XG4gICAgICBjYiguLi5hcmdzKTtcbiAgICB9LCB0b1ZhbHVlJDEoaW50ZXJ2YWwpKTtcbiAgfVxuICBpZiAoaW1tZWRpYXRlKSB7XG4gICAgaXNQZW5kaW5nLnZhbHVlID0gdHJ1ZTtcbiAgICBpZiAoaXNDbGllbnQpXG4gICAgICBzdGFydCgpO1xuICB9XG4gIHRyeU9uU2NvcGVEaXNwb3NlKHN0b3ApO1xuICByZXR1cm4ge1xuICAgIGlzUGVuZGluZzogc2hhbGxvd1JlYWRvbmx5KGlzUGVuZGluZyksXG4gICAgc3RhcnQsXG4gICAgc3RvcFxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VUaW1lb3V0KGludGVydmFsID0gMWUzLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGNvbnRyb2xzOiBleHBvc2VDb250cm9scyA9IGZhbHNlLFxuICAgIGNhbGxiYWNrXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBjb250cm9scyA9IHVzZVRpbWVvdXRGbihcbiAgICBjYWxsYmFjayAhPSBudWxsID8gY2FsbGJhY2sgOiBub29wLFxuICAgIGludGVydmFsLFxuICAgIG9wdGlvbnNcbiAgKTtcbiAgY29uc3QgcmVhZHkgPSBjb21wdXRlZCgoKSA9PiAhY29udHJvbHMuaXNQZW5kaW5nLnZhbHVlKTtcbiAgaWYgKGV4cG9zZUNvbnRyb2xzKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHJlYWR5LFxuICAgICAgLi4uY29udHJvbHNcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiByZWFkeTtcbiAgfVxufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlVG9OdW1iZXIodmFsdWUsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgbWV0aG9kID0gXCJwYXJzZUZsb2F0XCIsXG4gICAgcmFkaXgsXG4gICAgbmFuVG9aZXJvXG4gIH0gPSBvcHRpb25zO1xuICByZXR1cm4gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGxldCByZXNvbHZlZCA9IHRvVmFsdWUkMSh2YWx1ZSk7XG4gICAgaWYgKHR5cGVvZiBtZXRob2QgPT09IFwiZnVuY3Rpb25cIilcbiAgICAgIHJlc29sdmVkID0gbWV0aG9kKHJlc29sdmVkKTtcbiAgICBlbHNlIGlmICh0eXBlb2YgcmVzb2x2ZWQgPT09IFwic3RyaW5nXCIpXG4gICAgICByZXNvbHZlZCA9IE51bWJlclttZXRob2RdKHJlc29sdmVkLCByYWRpeCk7XG4gICAgaWYgKG5hblRvWmVybyAmJiBOdW1iZXIuaXNOYU4ocmVzb2x2ZWQpKVxuICAgICAgcmVzb2x2ZWQgPSAwO1xuICAgIHJldHVybiByZXNvbHZlZDtcbiAgfSk7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VUb1N0cmluZyh2YWx1ZSkge1xuICByZXR1cm4gY29tcHV0ZWQoKCkgPT4gYCR7dG9WYWx1ZSQxKHZhbHVlKX1gKTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZVRvZ2dsZShpbml0aWFsVmFsdWUgPSBmYWxzZSwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB0cnV0aHlWYWx1ZSA9IHRydWUsXG4gICAgZmFsc3lWYWx1ZSA9IGZhbHNlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCB2YWx1ZUlzUmVmID0gaXNSZWYoaW5pdGlhbFZhbHVlKTtcbiAgY29uc3QgX3ZhbHVlID0gc2hhbGxvd1JlZihpbml0aWFsVmFsdWUpO1xuICBmdW5jdGlvbiB0b2dnbGUodmFsdWUpIHtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkge1xuICAgICAgX3ZhbHVlLnZhbHVlID0gdmFsdWU7XG4gICAgICByZXR1cm4gX3ZhbHVlLnZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB0cnV0aHkgPSB0b1ZhbHVlJDEodHJ1dGh5VmFsdWUpO1xuICAgICAgX3ZhbHVlLnZhbHVlID0gX3ZhbHVlLnZhbHVlID09PSB0cnV0aHkgPyB0b1ZhbHVlJDEoZmFsc3lWYWx1ZSkgOiB0cnV0aHk7XG4gICAgICByZXR1cm4gX3ZhbHVlLnZhbHVlO1xuICAgIH1cbiAgfVxuICBpZiAodmFsdWVJc1JlZilcbiAgICByZXR1cm4gdG9nZ2xlO1xuICBlbHNlXG4gICAgcmV0dXJuIFtfdmFsdWUsIHRvZ2dsZV07XG59XG5cbmZ1bmN0aW9uIHdhdGNoQXJyYXkoc291cmNlLCBjYiwgb3B0aW9ucykge1xuICBsZXQgb2xkTGlzdCA9IChvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLmltbWVkaWF0ZSkgPyBbXSA6IFsuLi50eXBlb2Ygc291cmNlID09PSBcImZ1bmN0aW9uXCIgPyBzb3VyY2UoKSA6IEFycmF5LmlzQXJyYXkoc291cmNlKSA/IHNvdXJjZSA6IHRvVmFsdWUkMShzb3VyY2UpXTtcbiAgcmV0dXJuIHdhdGNoKHNvdXJjZSwgKG5ld0xpc3QsIF8sIG9uQ2xlYW51cCkgPT4ge1xuICAgIGNvbnN0IG9sZExpc3RSZW1haW5zID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogb2xkTGlzdC5sZW5ndGggfSk7XG4gICAgY29uc3QgYWRkZWQgPSBbXTtcbiAgICBmb3IgKGNvbnN0IG9iaiBvZiBuZXdMaXN0KSB7XG4gICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb2xkTGlzdC5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoIW9sZExpc3RSZW1haW5zW2ldICYmIG9iaiA9PT0gb2xkTGlzdFtpXSkge1xuICAgICAgICAgIG9sZExpc3RSZW1haW5zW2ldID0gdHJ1ZTtcbiAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghZm91bmQpXG4gICAgICAgIGFkZGVkLnB1c2gob2JqKTtcbiAgICB9XG4gICAgY29uc3QgcmVtb3ZlZCA9IG9sZExpc3QuZmlsdGVyKChfMiwgaSkgPT4gIW9sZExpc3RSZW1haW5zW2ldKTtcbiAgICBjYihuZXdMaXN0LCBvbGRMaXN0LCBhZGRlZCwgcmVtb3ZlZCwgb25DbGVhbnVwKTtcbiAgICBvbGRMaXN0ID0gWy4uLm5ld0xpc3RdO1xuICB9LCBvcHRpb25zKTtcbn1cblxuZnVuY3Rpb24gd2F0Y2hBdE1vc3Qoc291cmNlLCBjYiwgb3B0aW9ucykge1xuICBjb25zdCB7XG4gICAgY291bnQsXG4gICAgLi4ud2F0Y2hPcHRpb25zXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBjdXJyZW50ID0gc2hhbGxvd1JlZigwKTtcbiAgY29uc3Qgc3RvcCA9IHdhdGNoV2l0aEZpbHRlcihcbiAgICBzb3VyY2UsXG4gICAgKC4uLmFyZ3MpID0+IHtcbiAgICAgIGN1cnJlbnQudmFsdWUgKz0gMTtcbiAgICAgIGlmIChjdXJyZW50LnZhbHVlID49IHRvVmFsdWUkMShjb3VudCkpXG4gICAgICAgIG5leHRUaWNrKCgpID0+IHN0b3AoKSk7XG4gICAgICBjYiguLi5hcmdzKTtcbiAgICB9LFxuICAgIHdhdGNoT3B0aW9uc1xuICApO1xuICByZXR1cm4geyBjb3VudDogY3VycmVudCwgc3RvcCB9O1xufVxuXG5mdW5jdGlvbiB3YXRjaERlYm91bmNlZChzb3VyY2UsIGNiLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGRlYm91bmNlID0gMCxcbiAgICBtYXhXYWl0ID0gdm9pZCAwLFxuICAgIC4uLndhdGNoT3B0aW9uc1xuICB9ID0gb3B0aW9ucztcbiAgcmV0dXJuIHdhdGNoV2l0aEZpbHRlcihcbiAgICBzb3VyY2UsXG4gICAgY2IsXG4gICAge1xuICAgICAgLi4ud2F0Y2hPcHRpb25zLFxuICAgICAgZXZlbnRGaWx0ZXI6IGRlYm91bmNlRmlsdGVyKGRlYm91bmNlLCB7IG1heFdhaXQgfSlcbiAgICB9XG4gICk7XG59XG5cbmZ1bmN0aW9uIHdhdGNoRGVlcChzb3VyY2UsIGNiLCBvcHRpb25zKSB7XG4gIHJldHVybiB3YXRjaChcbiAgICBzb3VyY2UsXG4gICAgY2IsXG4gICAge1xuICAgICAgLi4ub3B0aW9ucyxcbiAgICAgIGRlZXA6IHRydWVcbiAgICB9XG4gICk7XG59XG5cbmZ1bmN0aW9uIHdhdGNoSWdub3JhYmxlKHNvdXJjZSwgY2IsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgZXZlbnRGaWx0ZXIgPSBieXBhc3NGaWx0ZXIsXG4gICAgLi4ud2F0Y2hPcHRpb25zXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBmaWx0ZXJlZENiID0gY3JlYXRlRmlsdGVyV3JhcHBlcihcbiAgICBldmVudEZpbHRlcixcbiAgICBjYlxuICApO1xuICBsZXQgaWdub3JlVXBkYXRlcztcbiAgbGV0IGlnbm9yZVByZXZBc3luY1VwZGF0ZXM7XG4gIGxldCBzdG9wO1xuICBpZiAod2F0Y2hPcHRpb25zLmZsdXNoID09PSBcInN5bmNcIikge1xuICAgIGxldCBpZ25vcmUgPSBmYWxzZTtcbiAgICBpZ25vcmVQcmV2QXN5bmNVcGRhdGVzID0gKCkgPT4ge1xuICAgIH07XG4gICAgaWdub3JlVXBkYXRlcyA9ICh1cGRhdGVyKSA9PiB7XG4gICAgICBpZ25vcmUgPSB0cnVlO1xuICAgICAgdXBkYXRlcigpO1xuICAgICAgaWdub3JlID0gZmFsc2U7XG4gICAgfTtcbiAgICBzdG9wID0gd2F0Y2goXG4gICAgICBzb3VyY2UsXG4gICAgICAoLi4uYXJncykgPT4ge1xuICAgICAgICBpZiAoIWlnbm9yZSlcbiAgICAgICAgICBmaWx0ZXJlZENiKC4uLmFyZ3MpO1xuICAgICAgfSxcbiAgICAgIHdhdGNoT3B0aW9uc1xuICAgICk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgZGlzcG9zYWJsZXMgPSBbXTtcbiAgICBsZXQgaWdub3JlQ291bnRlciA9IDA7XG4gICAgbGV0IHN5bmNDb3VudGVyID0gMDtcbiAgICBpZ25vcmVQcmV2QXN5bmNVcGRhdGVzID0gKCkgPT4ge1xuICAgICAgaWdub3JlQ291bnRlciA9IHN5bmNDb3VudGVyO1xuICAgIH07XG4gICAgZGlzcG9zYWJsZXMucHVzaChcbiAgICAgIHdhdGNoKFxuICAgICAgICBzb3VyY2UsXG4gICAgICAgICgpID0+IHtcbiAgICAgICAgICBzeW5jQ291bnRlcisrO1xuICAgICAgICB9LFxuICAgICAgICB7IC4uLndhdGNoT3B0aW9ucywgZmx1c2g6IFwic3luY1wiIH1cbiAgICAgIClcbiAgICApO1xuICAgIGlnbm9yZVVwZGF0ZXMgPSAodXBkYXRlcikgPT4ge1xuICAgICAgY29uc3Qgc3luY0NvdW50ZXJQcmV2ID0gc3luY0NvdW50ZXI7XG4gICAgICB1cGRhdGVyKCk7XG4gICAgICBpZ25vcmVDb3VudGVyICs9IHN5bmNDb3VudGVyIC0gc3luY0NvdW50ZXJQcmV2O1xuICAgIH07XG4gICAgZGlzcG9zYWJsZXMucHVzaChcbiAgICAgIHdhdGNoKFxuICAgICAgICBzb3VyY2UsXG4gICAgICAgICguLi5hcmdzKSA9PiB7XG4gICAgICAgICAgY29uc3QgaWdub3JlID0gaWdub3JlQ291bnRlciA+IDAgJiYgaWdub3JlQ291bnRlciA9PT0gc3luY0NvdW50ZXI7XG4gICAgICAgICAgaWdub3JlQ291bnRlciA9IDA7XG4gICAgICAgICAgc3luY0NvdW50ZXIgPSAwO1xuICAgICAgICAgIGlmIChpZ25vcmUpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgZmlsdGVyZWRDYiguLi5hcmdzKTtcbiAgICAgICAgfSxcbiAgICAgICAgd2F0Y2hPcHRpb25zXG4gICAgICApXG4gICAgKTtcbiAgICBzdG9wID0gKCkgPT4ge1xuICAgICAgZGlzcG9zYWJsZXMuZm9yRWFjaCgoZm4pID0+IGZuKCkpO1xuICAgIH07XG4gIH1cbiAgcmV0dXJuIHsgc3RvcCwgaWdub3JlVXBkYXRlcywgaWdub3JlUHJldkFzeW5jVXBkYXRlcyB9O1xufVxuXG5mdW5jdGlvbiB3YXRjaEltbWVkaWF0ZShzb3VyY2UsIGNiLCBvcHRpb25zKSB7XG4gIHJldHVybiB3YXRjaChcbiAgICBzb3VyY2UsXG4gICAgY2IsXG4gICAge1xuICAgICAgLi4ub3B0aW9ucyxcbiAgICAgIGltbWVkaWF0ZTogdHJ1ZVxuICAgIH1cbiAgKTtcbn1cblxuZnVuY3Rpb24gd2F0Y2hPbmNlKHNvdXJjZSwgY2IsIG9wdGlvbnMpIHtcbiAgcmV0dXJuIHdhdGNoKFxuICAgIHNvdXJjZSxcbiAgICBjYixcbiAgICB7XG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgb25jZTogdHJ1ZVxuICAgIH1cbiAgKTtcbn1cblxuZnVuY3Rpb24gd2F0Y2hUaHJvdHRsZWQoc291cmNlLCBjYiwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB0aHJvdHRsZSA9IDAsXG4gICAgdHJhaWxpbmcgPSB0cnVlLFxuICAgIGxlYWRpbmcgPSB0cnVlLFxuICAgIC4uLndhdGNoT3B0aW9uc1xuICB9ID0gb3B0aW9ucztcbiAgcmV0dXJuIHdhdGNoV2l0aEZpbHRlcihcbiAgICBzb3VyY2UsXG4gICAgY2IsXG4gICAge1xuICAgICAgLi4ud2F0Y2hPcHRpb25zLFxuICAgICAgZXZlbnRGaWx0ZXI6IHRocm90dGxlRmlsdGVyKHRocm90dGxlLCB0cmFpbGluZywgbGVhZGluZylcbiAgICB9XG4gICk7XG59XG5cbmZ1bmN0aW9uIHdhdGNoVHJpZ2dlcmFibGUoc291cmNlLCBjYiwgb3B0aW9ucyA9IHt9KSB7XG4gIGxldCBjbGVhbnVwRm47XG4gIGZ1bmN0aW9uIG9uRWZmZWN0KCkge1xuICAgIGlmICghY2xlYW51cEZuKVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IGZuID0gY2xlYW51cEZuO1xuICAgIGNsZWFudXBGbiA9IHZvaWQgMDtcbiAgICBmbigpO1xuICB9XG4gIGZ1bmN0aW9uIG9uQ2xlYW51cChjYWxsYmFjaykge1xuICAgIGNsZWFudXBGbiA9IGNhbGxiYWNrO1xuICB9XG4gIGNvbnN0IF9jYiA9ICh2YWx1ZSwgb2xkVmFsdWUpID0+IHtcbiAgICBvbkVmZmVjdCgpO1xuICAgIHJldHVybiBjYih2YWx1ZSwgb2xkVmFsdWUsIG9uQ2xlYW51cCk7XG4gIH07XG4gIGNvbnN0IHJlcyA9IHdhdGNoSWdub3JhYmxlKHNvdXJjZSwgX2NiLCBvcHRpb25zKTtcbiAgY29uc3QgeyBpZ25vcmVVcGRhdGVzIH0gPSByZXM7XG4gIGNvbnN0IHRyaWdnZXIgPSAoKSA9PiB7XG4gICAgbGV0IHJlczI7XG4gICAgaWdub3JlVXBkYXRlcygoKSA9PiB7XG4gICAgICByZXMyID0gX2NiKGdldFdhdGNoU291cmNlcyhzb3VyY2UpLCBnZXRPbGRWYWx1ZShzb3VyY2UpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzMjtcbiAgfTtcbiAgcmV0dXJuIHtcbiAgICAuLi5yZXMsXG4gICAgdHJpZ2dlclxuICB9O1xufVxuZnVuY3Rpb24gZ2V0V2F0Y2hTb3VyY2VzKHNvdXJjZXMpIHtcbiAgaWYgKGlzUmVhY3RpdmUoc291cmNlcykpXG4gICAgcmV0dXJuIHNvdXJjZXM7XG4gIGlmIChBcnJheS5pc0FycmF5KHNvdXJjZXMpKVxuICAgIHJldHVybiBzb3VyY2VzLm1hcCgoaXRlbSkgPT4gdG9WYWx1ZSQxKGl0ZW0pKTtcbiAgcmV0dXJuIHRvVmFsdWUkMShzb3VyY2VzKTtcbn1cbmZ1bmN0aW9uIGdldE9sZFZhbHVlKHNvdXJjZSkge1xuICByZXR1cm4gQXJyYXkuaXNBcnJheShzb3VyY2UpID8gc291cmNlLm1hcCgoKSA9PiB2b2lkIDApIDogdm9pZCAwO1xufVxuXG5mdW5jdGlvbiB3aGVuZXZlcihzb3VyY2UsIGNiLCBvcHRpb25zKSB7XG4gIGNvbnN0IHN0b3AgPSB3YXRjaChcbiAgICBzb3VyY2UsXG4gICAgKHYsIG92LCBvbkludmFsaWRhdGUpID0+IHtcbiAgICAgIGlmICh2KSB7XG4gICAgICAgIGlmIChvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLm9uY2UpXG4gICAgICAgICAgbmV4dFRpY2soKCkgPT4gc3RvcCgpKTtcbiAgICAgICAgY2Iodiwgb3YsIG9uSW52YWxpZGF0ZSk7XG4gICAgICB9XG4gICAgfSxcbiAgICB7XG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgb25jZTogZmFsc2VcbiAgICB9XG4gICk7XG4gIHJldHVybiBzdG9wO1xufVxuXG5leHBvcnQgeyBhc3NlcnQsIHJlZkF1dG9SZXNldCBhcyBhdXRvUmVzZXRSZWYsIGJ5cGFzc0ZpbHRlciwgY2FtZWxpemUsIGNsYW1wLCBjb21wdXRlZEVhZ2VyLCBjb21wdXRlZFdpdGhDb250cm9sLCBjb250YWluc1Byb3AsIGNvbXB1dGVkV2l0aENvbnRyb2wgYXMgY29udHJvbGxlZENvbXB1dGVkLCBjb250cm9sbGVkUmVmLCBjcmVhdGVFdmVudEhvb2ssIGNyZWF0ZUZpbHRlcldyYXBwZXIsIGNyZWF0ZUdsb2JhbFN0YXRlLCBjcmVhdGVJbmplY3Rpb25TdGF0ZSwgcmVhY3RpZnkgYXMgY3JlYXRlUmVhY3RpdmVGbiwgY3JlYXRlUmVmLCBjcmVhdGVTaGFyZWRDb21wb3NhYmxlLCBjcmVhdGVTaW5nbGV0b25Qcm9taXNlLCBkZWJvdW5jZUZpbHRlciwgcmVmRGVib3VuY2VkIGFzIGRlYm91bmNlZFJlZiwgd2F0Y2hEZWJvdW5jZWQgYXMgZGVib3VuY2VkV2F0Y2gsIGNvbXB1dGVkRWFnZXIgYXMgZWFnZXJDb21wdXRlZCwgZXh0ZW5kUmVmLCBmb3JtYXREYXRlLCBnZXQsIGdldExpZmVDeWNsZVRhcmdldCwgaGFzT3duLCBoeXBoZW5hdGUsIGlkZW50aXR5LCB3YXRjaElnbm9yYWJsZSBhcyBpZ25vcmFibGVXYXRjaCwgaW5jcmVhc2VXaXRoVW5pdCwgaW5qZWN0TG9jYWwsIGludm9rZSwgaXNDbGllbnQsIGlzRGVmLCBpc0RlZmluZWQsIGlzSU9TLCBpc09iamVjdCwgaXNXb3JrZXIsIG1ha2VEZXN0cnVjdHVyYWJsZSwgbm9vcCwgbm9ybWFsaXplRGF0ZSwgbm90TnVsbGlzaCwgbm93LCBvYmplY3RFbnRyaWVzLCBvYmplY3RPbWl0LCBvYmplY3RQaWNrLCBwYXVzYWJsZUZpbHRlciwgd2F0Y2hQYXVzYWJsZSBhcyBwYXVzYWJsZVdhdGNoLCBwcm9taXNlVGltZW91dCwgcHJvdmlkZUxvY2FsLCBweFZhbHVlLCByYW5kLCByZWFjdGlmeSwgcmVhY3RpZnlPYmplY3QsIHJlYWN0aXZlQ29tcHV0ZWQsIHJlYWN0aXZlT21pdCwgcmVhY3RpdmVQaWNrLCByZWZBdXRvUmVzZXQsIHJlZkRlYm91bmNlZCwgcmVmRGVmYXVsdCwgcmVmVGhyb3R0bGVkLCByZWZXaXRoQ29udHJvbCwgcmVzb2x2ZVJlZiwgcmVzb2x2ZVVucmVmLCBzZXQsIHN5bmNSZWYsIHN5bmNSZWZzLCB0aHJvdHRsZUZpbHRlciwgcmVmVGhyb3R0bGVkIGFzIHRocm90dGxlZFJlZiwgd2F0Y2hUaHJvdHRsZWQgYXMgdGhyb3R0bGVkV2F0Y2gsIHRpbWVzdGFtcCwgdG9BcnJheSwgdG9SZWFjdGl2ZSwgdG9SZWYsIHRvUmVmcywgdG9WYWx1ZSwgdHJ5T25CZWZvcmVNb3VudCwgdHJ5T25CZWZvcmVVbm1vdW50LCB0cnlPbk1vdW50ZWQsIHRyeU9uU2NvcGVEaXNwb3NlLCB0cnlPblVubW91bnRlZCwgdW50aWwsIHVzZUFycmF5RGlmZmVyZW5jZSwgdXNlQXJyYXlFdmVyeSwgdXNlQXJyYXlGaWx0ZXIsIHVzZUFycmF5RmluZCwgdXNlQXJyYXlGaW5kSW5kZXgsIHVzZUFycmF5RmluZExhc3QsIHVzZUFycmF5SW5jbHVkZXMsIHVzZUFycmF5Sm9pbiwgdXNlQXJyYXlNYXAsIHVzZUFycmF5UmVkdWNlLCB1c2VBcnJheVNvbWUsIHVzZUFycmF5VW5pcXVlLCB1c2VDb3VudGVyLCB1c2VEYXRlRm9ybWF0LCByZWZEZWJvdW5jZWQgYXMgdXNlRGVib3VuY2UsIHVzZURlYm91bmNlRm4sIHVzZUludGVydmFsLCB1c2VJbnRlcnZhbEZuLCB1c2VMYXN0Q2hhbmdlZCwgcmVmVGhyb3R0bGVkIGFzIHVzZVRocm90dGxlLCB1c2VUaHJvdHRsZUZuLCB1c2VUaW1lb3V0LCB1c2VUaW1lb3V0Rm4sIHVzZVRvTnVtYmVyLCB1c2VUb1N0cmluZywgdXNlVG9nZ2xlLCB3YXRjaEFycmF5LCB3YXRjaEF0TW9zdCwgd2F0Y2hEZWJvdW5jZWQsIHdhdGNoRGVlcCwgd2F0Y2hJZ25vcmFibGUsIHdhdGNoSW1tZWRpYXRlLCB3YXRjaE9uY2UsIHdhdGNoUGF1c2FibGUsIHdhdGNoVGhyb3R0bGVkLCB3YXRjaFRyaWdnZXJhYmxlLCB3YXRjaFdpdGhGaWx0ZXIsIHdoZW5ldmVyIH07XG4iLCJpbXBvcnQgeyBub29wLCBtYWtlRGVzdHJ1Y3R1cmFibGUsIGNhbWVsaXplLCBpc0NsaWVudCwgdG9BcnJheSwgd2F0Y2hJbW1lZGlhdGUsIGlzT2JqZWN0LCB0cnlPblNjb3BlRGlzcG9zZSwgaXNJT1MsIG5vdE51bGxpc2gsIHRyeU9uTW91bnRlZCwgb2JqZWN0T21pdCwgcHJvbWlzZVRpbWVvdXQsIHVudGlsLCBpbmplY3RMb2NhbCwgcHJvdmlkZUxvY2FsLCBweFZhbHVlLCBpbmNyZWFzZVdpdGhVbml0LCBvYmplY3RFbnRyaWVzLCBjcmVhdGVSZWYsIGNyZWF0ZVNpbmdsZXRvblByb21pc2UsIHVzZVRpbWVvdXRGbiwgcGF1c2FibGVXYXRjaCwgdG9SZWYsIGNyZWF0ZUV2ZW50SG9vaywgdXNlSW50ZXJ2YWxGbiwgY29tcHV0ZWRXaXRoQ29udHJvbCwgdGltZXN0YW1wLCBwYXVzYWJsZUZpbHRlciwgd2F0Y2hJZ25vcmFibGUsIGRlYm91bmNlRmlsdGVyLCBieXBhc3NGaWx0ZXIsIGNyZWF0ZUZpbHRlcldyYXBwZXIsIHRvUmVmcywgd2F0Y2hPbmNlLCBjb250YWluc1Byb3AsIGhhc093biwgdGhyb3R0bGVGaWx0ZXIsIHVzZURlYm91bmNlRm4sIHVzZVRocm90dGxlRm4sIHRyeU9uVW5tb3VudGVkLCBjbGFtcCwgc3luY1JlZiwgb2JqZWN0UGljaywgd2F0Y2hXaXRoRmlsdGVyLCBpZGVudGl0eSwgaXNEZWYsIHdoZW5ldmVyLCBpc1dvcmtlciB9IGZyb20gJ0B2dWV1c2Uvc2hhcmVkJztcbmV4cG9ydCAqIGZyb20gJ0B2dWV1c2Uvc2hhcmVkJztcbmltcG9ydCB7IGlzUmVmLCBzaGFsbG93UmVmLCByZWYsIHdhdGNoRWZmZWN0LCBjb21wdXRlZCwgaW5qZWN0LCBkZWZpbmVDb21wb25lbnQsIGgsIFRyYW5zaXRpb25Hcm91cCwgRnJhZ21lbnQsIHNoYWxsb3dSZWFjdGl2ZSwgdG9WYWx1ZSwgdW5yZWYsIGdldEN1cnJlbnRJbnN0YW5jZSwgb25Nb3VudGVkLCB3YXRjaCwgY3VzdG9tUmVmLCBvblVwZGF0ZWQsIHJlYWRvbmx5LCByZWFjdGl2ZSwgaGFzSW5qZWN0aW9uQ29udGV4dCwgdG9SYXcsIHNoYWxsb3dSZWFkb25seSwgbmV4dFRpY2ssIG1hcmtSYXcsIGdldEN1cnJlbnRTY29wZSwgaXNSZWFkb25seSwgb25CZWZvcmVVcGRhdGUgfSBmcm9tICd2dWUnO1xuXG5mdW5jdGlvbiBjb21wdXRlZEFzeW5jKGV2YWx1YXRpb25DYWxsYmFjaywgaW5pdGlhbFN0YXRlLCBvcHRpb25zT3JSZWYpIHtcbiAgdmFyIF9hO1xuICBsZXQgb3B0aW9ucztcbiAgaWYgKGlzUmVmKG9wdGlvbnNPclJlZikpIHtcbiAgICBvcHRpb25zID0ge1xuICAgICAgZXZhbHVhdGluZzogb3B0aW9uc09yUmVmXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICBvcHRpb25zID0gb3B0aW9uc09yUmVmIHx8IHt9O1xuICB9XG4gIGNvbnN0IHtcbiAgICBsYXp5ID0gZmFsc2UsXG4gICAgZmx1c2ggPSBcInByZVwiLFxuICAgIGV2YWx1YXRpbmcgPSB2b2lkIDAsXG4gICAgc2hhbGxvdyA9IHRydWUsXG4gICAgb25FcnJvciA9IChfYSA9IGdsb2JhbFRoaXMucmVwb3J0RXJyb3IpICE9IG51bGwgPyBfYSA6IG5vb3BcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHN0YXJ0ZWQgPSBzaGFsbG93UmVmKCFsYXp5KTtcbiAgY29uc3QgY3VycmVudCA9IHNoYWxsb3cgPyBzaGFsbG93UmVmKGluaXRpYWxTdGF0ZSkgOiByZWYoaW5pdGlhbFN0YXRlKTtcbiAgbGV0IGNvdW50ZXIgPSAwO1xuICB3YXRjaEVmZmVjdChhc3luYyAob25JbnZhbGlkYXRlKSA9PiB7XG4gICAgaWYgKCFzdGFydGVkLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIGNvdW50ZXIrKztcbiAgICBjb25zdCBjb3VudGVyQXRCZWdpbm5pbmcgPSBjb3VudGVyO1xuICAgIGxldCBoYXNGaW5pc2hlZCA9IGZhbHNlO1xuICAgIGlmIChldmFsdWF0aW5nKSB7XG4gICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgZXZhbHVhdGluZy52YWx1ZSA9IHRydWU7XG4gICAgICB9KTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV2YWx1YXRpb25DYWxsYmFjaygoY2FuY2VsQ2FsbGJhY2spID0+IHtcbiAgICAgICAgb25JbnZhbGlkYXRlKCgpID0+IHtcbiAgICAgICAgICBpZiAoZXZhbHVhdGluZylcbiAgICAgICAgICAgIGV2YWx1YXRpbmcudmFsdWUgPSBmYWxzZTtcbiAgICAgICAgICBpZiAoIWhhc0ZpbmlzaGVkKVxuICAgICAgICAgICAgY2FuY2VsQ2FsbGJhY2soKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICAgIGlmIChjb3VudGVyQXRCZWdpbm5pbmcgPT09IGNvdW50ZXIpXG4gICAgICAgIGN1cnJlbnQudmFsdWUgPSByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgb25FcnJvcihlKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgaWYgKGV2YWx1YXRpbmcgJiYgY291bnRlckF0QmVnaW5uaW5nID09PSBjb3VudGVyKVxuICAgICAgICBldmFsdWF0aW5nLnZhbHVlID0gZmFsc2U7XG4gICAgICBoYXNGaW5pc2hlZCA9IHRydWU7XG4gICAgfVxuICB9LCB7IGZsdXNoIH0pO1xuICBpZiAobGF6eSkge1xuICAgIHJldHVybiBjb21wdXRlZCgoKSA9PiB7XG4gICAgICBzdGFydGVkLnZhbHVlID0gdHJ1ZTtcbiAgICAgIHJldHVybiBjdXJyZW50LnZhbHVlO1xuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBjdXJyZW50O1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXB1dGVkSW5qZWN0KGtleSwgb3B0aW9ucywgZGVmYXVsdFNvdXJjZSwgdHJlYXREZWZhdWx0QXNGYWN0b3J5KSB7XG4gIGxldCBzb3VyY2UgPSBpbmplY3Qoa2V5KTtcbiAgaWYgKGRlZmF1bHRTb3VyY2UpXG4gICAgc291cmNlID0gaW5qZWN0KGtleSwgZGVmYXVsdFNvdXJjZSk7XG4gIGlmICh0cmVhdERlZmF1bHRBc0ZhY3RvcnkpXG4gICAgc291cmNlID0gaW5qZWN0KGtleSwgZGVmYXVsdFNvdXJjZSwgdHJlYXREZWZhdWx0QXNGYWN0b3J5KTtcbiAgaWYgKHR5cGVvZiBvcHRpb25zID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICByZXR1cm4gY29tcHV0ZWQoKG9sZFZhbHVlKSA9PiBvcHRpb25zKHNvdXJjZSwgb2xkVmFsdWUpKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gY29tcHV0ZWQoe1xuICAgICAgZ2V0OiAob2xkVmFsdWUpID0+IG9wdGlvbnMuZ2V0KHNvdXJjZSwgb2xkVmFsdWUpLFxuICAgICAgc2V0OiBvcHRpb25zLnNldFxuICAgIH0pO1xuICB9XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiBjcmVhdGVSZXVzYWJsZVRlbXBsYXRlKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgaW5oZXJpdEF0dHJzID0gdHJ1ZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgcmVuZGVyID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCBkZWZpbmUgPSAvKkBfX1BVUkVfXyovIGRlZmluZUNvbXBvbmVudCh7XG4gICAgc2V0dXAoXywgeyBzbG90cyB9KSB7XG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICByZW5kZXIudmFsdWUgPSBzbG90cy5kZWZhdWx0O1xuICAgICAgfTtcbiAgICB9XG4gIH0pO1xuICBjb25zdCByZXVzZSA9IC8qQF9fUFVSRV9fKi8gZGVmaW5lQ29tcG9uZW50KHtcbiAgICBpbmhlcml0QXR0cnMsXG4gICAgcHJvcHM6IG9wdGlvbnMucHJvcHMsXG4gICAgc2V0dXAocHJvcHMsIHsgYXR0cnMsIHNsb3RzIH0pIHtcbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgaWYgKCFyZW5kZXIudmFsdWUgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09IFwicHJvZHVjdGlvblwiKVxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIltWdWVVc2VdIEZhaWxlZCB0byBmaW5kIHRoZSBkZWZpbml0aW9uIG9mIHJldXNhYmxlIHRlbXBsYXRlXCIpO1xuICAgICAgICBjb25zdCB2bm9kZSA9IChfYSA9IHJlbmRlci52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmNhbGwocmVuZGVyLCB7XG4gICAgICAgICAgLi4ub3B0aW9ucy5wcm9wcyA9PSBudWxsID8ga2V5c1RvQ2FtZWxLZWJhYkNhc2UoYXR0cnMpIDogcHJvcHMsXG4gICAgICAgICAgJHNsb3RzOiBzbG90c1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGluaGVyaXRBdHRycyAmJiAodm5vZGUgPT0gbnVsbCA/IHZvaWQgMCA6IHZub2RlLmxlbmd0aCkgPT09IDEgPyB2bm9kZVswXSA6IHZub2RlO1xuICAgICAgfTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gbWFrZURlc3RydWN0dXJhYmxlKFxuICAgIHsgZGVmaW5lLCByZXVzZSB9LFxuICAgIFtkZWZpbmUsIHJldXNlXVxuICApO1xufVxuZnVuY3Rpb24ga2V5c1RvQ2FtZWxLZWJhYkNhc2Uob2JqKSB7XG4gIGNvbnN0IG5ld09iaiA9IHt9O1xuICBmb3IgKGNvbnN0IGtleSBpbiBvYmopXG4gICAgbmV3T2JqW2NhbWVsaXplKGtleSldID0gb2JqW2tleV07XG4gIHJldHVybiBuZXdPYmo7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiBjcmVhdGVUZW1wbGF0ZVByb21pc2Uob3B0aW9ucyA9IHt9KSB7XG4gIGxldCBpbmRleCA9IDA7XG4gIGNvbnN0IGluc3RhbmNlcyA9IHJlZihbXSk7XG4gIGZ1bmN0aW9uIGNyZWF0ZSguLi5hcmdzKSB7XG4gICAgY29uc3QgcHJvcHMgPSBzaGFsbG93UmVhY3RpdmUoe1xuICAgICAga2V5OiBpbmRleCsrLFxuICAgICAgYXJncyxcbiAgICAgIHByb21pc2U6IHZvaWQgMCxcbiAgICAgIHJlc29sdmU6ICgpID0+IHtcbiAgICAgIH0sXG4gICAgICByZWplY3Q6ICgpID0+IHtcbiAgICAgIH0sXG4gICAgICBpc1Jlc29sdmluZzogZmFsc2UsXG4gICAgICBvcHRpb25zXG4gICAgfSk7XG4gICAgaW5zdGFuY2VzLnZhbHVlLnB1c2gocHJvcHMpO1xuICAgIHByb3BzLnByb21pc2UgPSBuZXcgUHJvbWlzZSgoX3Jlc29sdmUsIF9yZWplY3QpID0+IHtcbiAgICAgIHByb3BzLnJlc29sdmUgPSAodikgPT4ge1xuICAgICAgICBwcm9wcy5pc1Jlc29sdmluZyA9IHRydWU7XG4gICAgICAgIHJldHVybiBfcmVzb2x2ZSh2KTtcbiAgICAgIH07XG4gICAgICBwcm9wcy5yZWplY3QgPSBfcmVqZWN0O1xuICAgIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgcHJvcHMucHJvbWlzZSA9IHZvaWQgMDtcbiAgICAgIGNvbnN0IGluZGV4MiA9IGluc3RhbmNlcy52YWx1ZS5pbmRleE9mKHByb3BzKTtcbiAgICAgIGlmIChpbmRleDIgIT09IC0xKVxuICAgICAgICBpbnN0YW5jZXMudmFsdWUuc3BsaWNlKGluZGV4MiwgMSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHByb3BzLnByb21pc2U7XG4gIH1cbiAgZnVuY3Rpb24gc3RhcnQoLi4uYXJncykge1xuICAgIGlmIChvcHRpb25zLnNpbmdsZXRvbiAmJiBpbnN0YW5jZXMudmFsdWUubGVuZ3RoID4gMClcbiAgICAgIHJldHVybiBpbnN0YW5jZXMudmFsdWVbMF0ucHJvbWlzZTtcbiAgICByZXR1cm4gY3JlYXRlKC4uLmFyZ3MpO1xuICB9XG4gIGNvbnN0IGNvbXBvbmVudCA9IC8qQF9fUFVSRV9fKi8gZGVmaW5lQ29tcG9uZW50KChfLCB7IHNsb3RzIH0pID0+IHtcbiAgICBjb25zdCByZW5kZXJMaXN0ID0gKCkgPT4gaW5zdGFuY2VzLnZhbHVlLm1hcCgocHJvcHMpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIHJldHVybiBoKEZyYWdtZW50LCB7IGtleTogcHJvcHMua2V5IH0sIChfYSA9IHNsb3RzLmRlZmF1bHQpID09IG51bGwgPyB2b2lkIDAgOiBfYS5jYWxsKHNsb3RzLCBwcm9wcykpO1xuICAgIH0pO1xuICAgIGlmIChvcHRpb25zLnRyYW5zaXRpb24pXG4gICAgICByZXR1cm4gKCkgPT4gaChUcmFuc2l0aW9uR3JvdXAsIG9wdGlvbnMudHJhbnNpdGlvbiwgcmVuZGVyTGlzdCk7XG4gICAgcmV0dXJuIHJlbmRlckxpc3Q7XG4gIH0pO1xuICBjb21wb25lbnQuc3RhcnQgPSBzdGFydDtcbiAgcmV0dXJuIGNvbXBvbmVudDtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIGNyZWF0ZVVucmVmRm4oZm4pIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKC4uLmFyZ3MpIHtcbiAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJncy5tYXAoKGkpID0+IHRvVmFsdWUoaSkpKTtcbiAgfTtcbn1cblxuY29uc3QgZGVmYXVsdFdpbmRvdyA9IGlzQ2xpZW50ID8gd2luZG93IDogdm9pZCAwO1xuY29uc3QgZGVmYXVsdERvY3VtZW50ID0gaXNDbGllbnQgPyB3aW5kb3cuZG9jdW1lbnQgOiB2b2lkIDA7XG5jb25zdCBkZWZhdWx0TmF2aWdhdG9yID0gaXNDbGllbnQgPyB3aW5kb3cubmF2aWdhdG9yIDogdm9pZCAwO1xuY29uc3QgZGVmYXVsdExvY2F0aW9uID0gaXNDbGllbnQgPyB3aW5kb3cubG9jYXRpb24gOiB2b2lkIDA7XG5cbmZ1bmN0aW9uIHVucmVmRWxlbWVudChlbFJlZikge1xuICB2YXIgX2E7XG4gIGNvbnN0IHBsYWluID0gdG9WYWx1ZShlbFJlZik7XG4gIHJldHVybiAoX2EgPSBwbGFpbiA9PSBudWxsID8gdm9pZCAwIDogcGxhaW4uJGVsKSAhPSBudWxsID8gX2EgOiBwbGFpbjtcbn1cblxuZnVuY3Rpb24gdXNlRXZlbnRMaXN0ZW5lciguLi5hcmdzKSB7XG4gIGNvbnN0IGNsZWFudXBzID0gW107XG4gIGNvbnN0IGNsZWFudXAgPSAoKSA9PiB7XG4gICAgY2xlYW51cHMuZm9yRWFjaCgoZm4pID0+IGZuKCkpO1xuICAgIGNsZWFudXBzLmxlbmd0aCA9IDA7XG4gIH07XG4gIGNvbnN0IHJlZ2lzdGVyID0gKGVsLCBldmVudCwgbGlzdGVuZXIsIG9wdGlvbnMpID0+IHtcbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lciwgb3B0aW9ucyk7XG4gICAgcmV0dXJuICgpID0+IGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyLCBvcHRpb25zKTtcbiAgfTtcbiAgY29uc3QgZmlyc3RQYXJhbVRhcmdldHMgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgY29uc3QgdGVzdCA9IHRvQXJyYXkodG9WYWx1ZShhcmdzWzBdKSkuZmlsdGVyKChlKSA9PiBlICE9IG51bGwpO1xuICAgIHJldHVybiB0ZXN0LmV2ZXJ5KChlKSA9PiB0eXBlb2YgZSAhPT0gXCJzdHJpbmdcIikgPyB0ZXN0IDogdm9pZCAwO1xuICB9KTtcbiAgY29uc3Qgc3RvcFdhdGNoID0gd2F0Y2hJbW1lZGlhdGUoXG4gICAgKCkgPT4ge1xuICAgICAgdmFyIF9hLCBfYjtcbiAgICAgIHJldHVybiBbXG4gICAgICAgIChfYiA9IChfYSA9IGZpcnN0UGFyYW1UYXJnZXRzLnZhbHVlKSA9PSBudWxsID8gdm9pZCAwIDogX2EubWFwKChlKSA9PiB1bnJlZkVsZW1lbnQoZSkpKSAhPSBudWxsID8gX2IgOiBbZGVmYXVsdFdpbmRvd10uZmlsdGVyKChlKSA9PiBlICE9IG51bGwpLFxuICAgICAgICB0b0FycmF5KHRvVmFsdWUoZmlyc3RQYXJhbVRhcmdldHMudmFsdWUgPyBhcmdzWzFdIDogYXJnc1swXSkpLFxuICAgICAgICB0b0FycmF5KHVucmVmKGZpcnN0UGFyYW1UYXJnZXRzLnZhbHVlID8gYXJnc1syXSA6IGFyZ3NbMV0pKSxcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciAtIFR5cGVTY3JpcHQgZ2V0cyB0aGUgY29ycmVjdCB0eXBlcywgYnV0IHNvbWVob3cgc3RpbGwgY29tcGxhaW5zXG4gICAgICAgIHRvVmFsdWUoZmlyc3RQYXJhbVRhcmdldHMudmFsdWUgPyBhcmdzWzNdIDogYXJnc1syXSlcbiAgICAgIF07XG4gICAgfSxcbiAgICAoW3Jhd190YXJnZXRzLCByYXdfZXZlbnRzLCByYXdfbGlzdGVuZXJzLCByYXdfb3B0aW9uc10pID0+IHtcbiAgICAgIGNsZWFudXAoKTtcbiAgICAgIGlmICghKHJhd190YXJnZXRzID09IG51bGwgPyB2b2lkIDAgOiByYXdfdGFyZ2V0cy5sZW5ndGgpIHx8ICEocmF3X2V2ZW50cyA9PSBudWxsID8gdm9pZCAwIDogcmF3X2V2ZW50cy5sZW5ndGgpIHx8ICEocmF3X2xpc3RlbmVycyA9PSBudWxsID8gdm9pZCAwIDogcmF3X2xpc3RlbmVycy5sZW5ndGgpKVxuICAgICAgICByZXR1cm47XG4gICAgICBjb25zdCBvcHRpb25zQ2xvbmUgPSBpc09iamVjdChyYXdfb3B0aW9ucykgPyB7IC4uLnJhd19vcHRpb25zIH0gOiByYXdfb3B0aW9ucztcbiAgICAgIGNsZWFudXBzLnB1c2goXG4gICAgICAgIC4uLnJhd190YXJnZXRzLmZsYXRNYXAoXG4gICAgICAgICAgKGVsKSA9PiByYXdfZXZlbnRzLmZsYXRNYXAoXG4gICAgICAgICAgICAoZXZlbnQpID0+IHJhd19saXN0ZW5lcnMubWFwKChsaXN0ZW5lcikgPT4gcmVnaXN0ZXIoZWwsIGV2ZW50LCBsaXN0ZW5lciwgb3B0aW9uc0Nsb25lKSlcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSxcbiAgICB7IGZsdXNoOiBcInBvc3RcIiB9XG4gICk7XG4gIGNvbnN0IHN0b3AgPSAoKSA9PiB7XG4gICAgc3RvcFdhdGNoKCk7XG4gICAgY2xlYW51cCgpO1xuICB9O1xuICB0cnlPblNjb3BlRGlzcG9zZShjbGVhbnVwKTtcbiAgcmV0dXJuIHN0b3A7XG59XG5cbmxldCBfaU9TV29ya2Fyb3VuZCA9IGZhbHNlO1xuZnVuY3Rpb24gb25DbGlja091dHNpZGUodGFyZ2V0LCBoYW5kbGVyLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyB3aW5kb3cgPSBkZWZhdWx0V2luZG93LCBpZ25vcmUgPSBbXSwgY2FwdHVyZSA9IHRydWUsIGRldGVjdElmcmFtZSA9IGZhbHNlLCBjb250cm9scyA9IGZhbHNlIH0gPSBvcHRpb25zO1xuICBpZiAoIXdpbmRvdykge1xuICAgIHJldHVybiBjb250cm9scyA/IHsgc3RvcDogbm9vcCwgY2FuY2VsOiBub29wLCB0cmlnZ2VyOiBub29wIH0gOiBub29wO1xuICB9XG4gIGlmIChpc0lPUyAmJiAhX2lPU1dvcmthcm91bmQpIHtcbiAgICBfaU9TV29ya2Fyb3VuZCA9IHRydWU7XG4gICAgY29uc3QgbGlzdGVuZXJPcHRpb25zID0geyBwYXNzaXZlOiB0cnVlIH07XG4gICAgQXJyYXkuZnJvbSh3aW5kb3cuZG9jdW1lbnQuYm9keS5jaGlsZHJlbikuZm9yRWFjaCgoZWwpID0+IGVsLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBub29wLCBsaXN0ZW5lck9wdGlvbnMpKTtcbiAgICB3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBub29wLCBsaXN0ZW5lck9wdGlvbnMpO1xuICB9XG4gIGxldCBzaG91bGRMaXN0ZW4gPSB0cnVlO1xuICBjb25zdCBzaG91bGRJZ25vcmUgPSAoZXZlbnQpID0+IHtcbiAgICByZXR1cm4gdG9WYWx1ZShpZ25vcmUpLnNvbWUoKHRhcmdldDIpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgdGFyZ2V0MiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbSh3aW5kb3cuZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCh0YXJnZXQyKSkuc29tZSgoZWwpID0+IGVsID09PSBldmVudC50YXJnZXQgfHwgZXZlbnQuY29tcG9zZWRQYXRoKCkuaW5jbHVkZXMoZWwpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGVsID0gdW5yZWZFbGVtZW50KHRhcmdldDIpO1xuICAgICAgICByZXR1cm4gZWwgJiYgKGV2ZW50LnRhcmdldCA9PT0gZWwgfHwgZXZlbnQuY29tcG9zZWRQYXRoKCkuaW5jbHVkZXMoZWwpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcbiAgZnVuY3Rpb24gaGFzTXVsdGlwbGVSb290cyh0YXJnZXQyKSB7XG4gICAgY29uc3Qgdm0gPSB0b1ZhbHVlKHRhcmdldDIpO1xuICAgIHJldHVybiB2bSAmJiB2bS4kLnN1YlRyZWUuc2hhcGVGbGFnID09PSAxNjtcbiAgfVxuICBmdW5jdGlvbiBjaGVja011bHRpcGxlUm9vdHModGFyZ2V0MiwgZXZlbnQpIHtcbiAgICBjb25zdCB2bSA9IHRvVmFsdWUodGFyZ2V0Mik7XG4gICAgY29uc3QgY2hpbGRyZW4gPSB2bS4kLnN1YlRyZWUgJiYgdm0uJC5zdWJUcmVlLmNoaWxkcmVuO1xuICAgIGlmIChjaGlsZHJlbiA9PSBudWxsIHx8ICFBcnJheS5pc0FycmF5KGNoaWxkcmVuKSlcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICByZXR1cm4gY2hpbGRyZW4uc29tZSgoY2hpbGQpID0+IGNoaWxkLmVsID09PSBldmVudC50YXJnZXQgfHwgZXZlbnQuY29tcG9zZWRQYXRoKCkuaW5jbHVkZXMoY2hpbGQuZWwpKTtcbiAgfVxuICBjb25zdCBsaXN0ZW5lciA9IChldmVudCkgPT4ge1xuICAgIGNvbnN0IGVsID0gdW5yZWZFbGVtZW50KHRhcmdldCk7XG4gICAgaWYgKGV2ZW50LnRhcmdldCA9PSBudWxsKVxuICAgICAgcmV0dXJuO1xuICAgIGlmICghKGVsIGluc3RhbmNlb2YgRWxlbWVudCkgJiYgaGFzTXVsdGlwbGVSb290cyh0YXJnZXQpICYmIGNoZWNrTXVsdGlwbGVSb290cyh0YXJnZXQsIGV2ZW50KSlcbiAgICAgIHJldHVybjtcbiAgICBpZiAoIWVsIHx8IGVsID09PSBldmVudC50YXJnZXQgfHwgZXZlbnQuY29tcG9zZWRQYXRoKCkuaW5jbHVkZXMoZWwpKVxuICAgICAgcmV0dXJuO1xuICAgIGlmIChcImRldGFpbFwiIGluIGV2ZW50ICYmIGV2ZW50LmRldGFpbCA9PT0gMClcbiAgICAgIHNob3VsZExpc3RlbiA9ICFzaG91bGRJZ25vcmUoZXZlbnQpO1xuICAgIGlmICghc2hvdWxkTGlzdGVuKSB7XG4gICAgICBzaG91bGRMaXN0ZW4gPSB0cnVlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBoYW5kbGVyKGV2ZW50KTtcbiAgfTtcbiAgbGV0IGlzUHJvY2Vzc2luZ0NsaWNrID0gZmFsc2U7XG4gIGNvbnN0IGNsZWFudXAgPSBbXG4gICAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3csIFwiY2xpY2tcIiwgKGV2ZW50KSA9PiB7XG4gICAgICBpZiAoIWlzUHJvY2Vzc2luZ0NsaWNrKSB7XG4gICAgICAgIGlzUHJvY2Vzc2luZ0NsaWNrID0gdHJ1ZTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgaXNQcm9jZXNzaW5nQ2xpY2sgPSBmYWxzZTtcbiAgICAgICAgfSwgMCk7XG4gICAgICAgIGxpc3RlbmVyKGV2ZW50KTtcbiAgICAgIH1cbiAgICB9LCB7IHBhc3NpdmU6IHRydWUsIGNhcHR1cmUgfSksXG4gICAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3csIFwicG9pbnRlcmRvd25cIiwgKGUpID0+IHtcbiAgICAgIGNvbnN0IGVsID0gdW5yZWZFbGVtZW50KHRhcmdldCk7XG4gICAgICBzaG91bGRMaXN0ZW4gPSAhc2hvdWxkSWdub3JlKGUpICYmICEhKGVsICYmICFlLmNvbXBvc2VkUGF0aCgpLmluY2x1ZGVzKGVsKSk7XG4gICAgfSwgeyBwYXNzaXZlOiB0cnVlIH0pLFxuICAgIGRldGVjdElmcmFtZSAmJiB1c2VFdmVudExpc3RlbmVyKHdpbmRvdywgXCJibHVyXCIsIChldmVudCkgPT4ge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgY29uc3QgZWwgPSB1bnJlZkVsZW1lbnQodGFyZ2V0KTtcbiAgICAgICAgaWYgKCgoX2EgPSB3aW5kb3cuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnRhZ05hbWUpID09PSBcIklGUkFNRVwiICYmICEoZWwgPT0gbnVsbCA/IHZvaWQgMCA6IGVsLmNvbnRhaW5zKHdpbmRvdy5kb2N1bWVudC5hY3RpdmVFbGVtZW50KSkpIHtcbiAgICAgICAgICBoYW5kbGVyKGV2ZW50KTtcbiAgICAgICAgfVxuICAgICAgfSwgMCk7XG4gICAgfSwgeyBwYXNzaXZlOiB0cnVlIH0pXG4gIF0uZmlsdGVyKEJvb2xlYW4pO1xuICBjb25zdCBzdG9wID0gKCkgPT4gY2xlYW51cC5mb3JFYWNoKChmbikgPT4gZm4oKSk7XG4gIGlmIChjb250cm9scykge1xuICAgIHJldHVybiB7XG4gICAgICBzdG9wLFxuICAgICAgY2FuY2VsOiAoKSA9PiB7XG4gICAgICAgIHNob3VsZExpc3RlbiA9IGZhbHNlO1xuICAgICAgfSxcbiAgICAgIHRyaWdnZXI6IChldmVudCkgPT4ge1xuICAgICAgICBzaG91bGRMaXN0ZW4gPSB0cnVlO1xuICAgICAgICBsaXN0ZW5lcihldmVudCk7XG4gICAgICAgIHNob3VsZExpc3RlbiA9IGZhbHNlO1xuICAgICAgfVxuICAgIH07XG4gIH1cbiAgcmV0dXJuIHN0b3A7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VNb3VudGVkKCkge1xuICBjb25zdCBpc01vdW50ZWQgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgaW5zdGFuY2UgPSBnZXRDdXJyZW50SW5zdGFuY2UoKTtcbiAgaWYgKGluc3RhbmNlKSB7XG4gICAgb25Nb3VudGVkKCgpID0+IHtcbiAgICAgIGlzTW91bnRlZC52YWx1ZSA9IHRydWU7XG4gICAgfSwgaW5zdGFuY2UpO1xuICB9XG4gIHJldHVybiBpc01vdW50ZWQ7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VTdXBwb3J0ZWQoY2FsbGJhY2spIHtcbiAgY29uc3QgaXNNb3VudGVkID0gdXNlTW91bnRlZCgpO1xuICByZXR1cm4gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGlzTW91bnRlZC52YWx1ZTtcbiAgICByZXR1cm4gQm9vbGVhbihjYWxsYmFjaygpKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHVzZU11dGF0aW9uT2JzZXJ2ZXIodGFyZ2V0LCBjYWxsYmFjaywgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgd2luZG93ID0gZGVmYXVsdFdpbmRvdywgLi4ubXV0YXRpb25PcHRpb25zIH0gPSBvcHRpb25zO1xuICBsZXQgb2JzZXJ2ZXI7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHdpbmRvdyAmJiBcIk11dGF0aW9uT2JzZXJ2ZXJcIiBpbiB3aW5kb3cpO1xuICBjb25zdCBjbGVhbnVwID0gKCkgPT4ge1xuICAgIGlmIChvYnNlcnZlcikge1xuICAgICAgb2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xuICAgICAgb2JzZXJ2ZXIgPSB2b2lkIDA7XG4gICAgfVxuICB9O1xuICBjb25zdCB0YXJnZXRzID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGNvbnN0IHZhbHVlID0gdG9WYWx1ZSh0YXJnZXQpO1xuICAgIGNvbnN0IGl0ZW1zID0gdG9BcnJheSh2YWx1ZSkubWFwKHVucmVmRWxlbWVudCkuZmlsdGVyKG5vdE51bGxpc2gpO1xuICAgIHJldHVybiBuZXcgU2V0KGl0ZW1zKTtcbiAgfSk7XG4gIGNvbnN0IHN0b3BXYXRjaCA9IHdhdGNoKFxuICAgIHRhcmdldHMsXG4gICAgKG5ld1RhcmdldHMpID0+IHtcbiAgICAgIGNsZWFudXAoKTtcbiAgICAgIGlmIChpc1N1cHBvcnRlZC52YWx1ZSAmJiBuZXdUYXJnZXRzLnNpemUpIHtcbiAgICAgICAgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihjYWxsYmFjayk7XG4gICAgICAgIG5ld1RhcmdldHMuZm9yRWFjaCgoZWwpID0+IG9ic2VydmVyLm9ic2VydmUoZWwsIG11dGF0aW9uT3B0aW9ucykpO1xuICAgICAgfVxuICAgIH0sXG4gICAgeyBpbW1lZGlhdGU6IHRydWUsIGZsdXNoOiBcInBvc3RcIiB9XG4gICk7XG4gIGNvbnN0IHRha2VSZWNvcmRzID0gKCkgPT4ge1xuICAgIHJldHVybiBvYnNlcnZlciA9PSBudWxsID8gdm9pZCAwIDogb2JzZXJ2ZXIudGFrZVJlY29yZHMoKTtcbiAgfTtcbiAgY29uc3Qgc3RvcCA9ICgpID0+IHtcbiAgICBzdG9wV2F0Y2goKTtcbiAgICBjbGVhbnVwKCk7XG4gIH07XG4gIHRyeU9uU2NvcGVEaXNwb3NlKHN0b3ApO1xuICByZXR1cm4ge1xuICAgIGlzU3VwcG9ydGVkLFxuICAgIHN0b3AsXG4gICAgdGFrZVJlY29yZHNcbiAgfTtcbn1cblxuZnVuY3Rpb24gb25FbGVtZW50UmVtb3ZhbCh0YXJnZXQsIGNhbGxiYWNrLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3csXG4gICAgZG9jdW1lbnQgPSB3aW5kb3cgPT0gbnVsbCA/IHZvaWQgMCA6IHdpbmRvdy5kb2N1bWVudCxcbiAgICBmbHVzaCA9IFwic3luY1wiXG4gIH0gPSBvcHRpb25zO1xuICBpZiAoIXdpbmRvdyB8fCAhZG9jdW1lbnQpXG4gICAgcmV0dXJuIG5vb3A7XG4gIGxldCBzdG9wRm47XG4gIGNvbnN0IGNsZWFudXBBbmRVcGRhdGUgPSAoZm4pID0+IHtcbiAgICBzdG9wRm4gPT0gbnVsbCA/IHZvaWQgMCA6IHN0b3BGbigpO1xuICAgIHN0b3BGbiA9IGZuO1xuICB9O1xuICBjb25zdCBzdG9wV2F0Y2ggPSB3YXRjaEVmZmVjdCgoKSA9PiB7XG4gICAgY29uc3QgZWwgPSB1bnJlZkVsZW1lbnQodGFyZ2V0KTtcbiAgICBpZiAoZWwpIHtcbiAgICAgIGNvbnN0IHsgc3RvcCB9ID0gdXNlTXV0YXRpb25PYnNlcnZlcihcbiAgICAgICAgZG9jdW1lbnQsXG4gICAgICAgIChtdXRhdGlvbnNMaXN0KSA9PiB7XG4gICAgICAgICAgY29uc3QgdGFyZ2V0UmVtb3ZlZCA9IG11dGF0aW9uc0xpc3QubWFwKChtdXRhdGlvbikgPT4gWy4uLm11dGF0aW9uLnJlbW92ZWROb2Rlc10pLmZsYXQoKS5zb21lKChub2RlKSA9PiBub2RlID09PSBlbCB8fCBub2RlLmNvbnRhaW5zKGVsKSk7XG4gICAgICAgICAgaWYgKHRhcmdldFJlbW92ZWQpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKG11dGF0aW9uc0xpc3QpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHdpbmRvdyxcbiAgICAgICAgICBjaGlsZExpc3Q6IHRydWUsXG4gICAgICAgICAgc3VidHJlZTogdHJ1ZVxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgY2xlYW51cEFuZFVwZGF0ZShzdG9wKTtcbiAgICB9XG4gIH0sIHsgZmx1c2ggfSk7XG4gIGNvbnN0IHN0b3BIYW5kbGUgPSAoKSA9PiB7XG4gICAgc3RvcFdhdGNoKCk7XG4gICAgY2xlYW51cEFuZFVwZGF0ZSgpO1xuICB9O1xuICB0cnlPblNjb3BlRGlzcG9zZShzdG9wSGFuZGxlKTtcbiAgcmV0dXJuIHN0b3BIYW5kbGU7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUtleVByZWRpY2F0ZShrZXlGaWx0ZXIpIHtcbiAgaWYgKHR5cGVvZiBrZXlGaWx0ZXIgPT09IFwiZnVuY3Rpb25cIilcbiAgICByZXR1cm4ga2V5RmlsdGVyO1xuICBlbHNlIGlmICh0eXBlb2Yga2V5RmlsdGVyID09PSBcInN0cmluZ1wiKVxuICAgIHJldHVybiAoZXZlbnQpID0+IGV2ZW50LmtleSA9PT0ga2V5RmlsdGVyO1xuICBlbHNlIGlmIChBcnJheS5pc0FycmF5KGtleUZpbHRlcikpXG4gICAgcmV0dXJuIChldmVudCkgPT4ga2V5RmlsdGVyLmluY2x1ZGVzKGV2ZW50LmtleSk7XG4gIHJldHVybiAoKSA9PiB0cnVlO1xufVxuZnVuY3Rpb24gb25LZXlTdHJva2UoLi4uYXJncykge1xuICBsZXQga2V5O1xuICBsZXQgaGFuZGxlcjtcbiAgbGV0IG9wdGlvbnMgPSB7fTtcbiAgaWYgKGFyZ3MubGVuZ3RoID09PSAzKSB7XG4gICAga2V5ID0gYXJnc1swXTtcbiAgICBoYW5kbGVyID0gYXJnc1sxXTtcbiAgICBvcHRpb25zID0gYXJnc1syXTtcbiAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xuICAgIGlmICh0eXBlb2YgYXJnc1sxXSA9PT0gXCJvYmplY3RcIikge1xuICAgICAga2V5ID0gdHJ1ZTtcbiAgICAgIGhhbmRsZXIgPSBhcmdzWzBdO1xuICAgICAgb3B0aW9ucyA9IGFyZ3NbMV07XG4gICAgfSBlbHNlIHtcbiAgICAgIGtleSA9IGFyZ3NbMF07XG4gICAgICBoYW5kbGVyID0gYXJnc1sxXTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAga2V5ID0gdHJ1ZTtcbiAgICBoYW5kbGVyID0gYXJnc1swXTtcbiAgfVxuICBjb25zdCB7XG4gICAgdGFyZ2V0ID0gZGVmYXVsdFdpbmRvdyxcbiAgICBldmVudE5hbWUgPSBcImtleWRvd25cIixcbiAgICBwYXNzaXZlID0gZmFsc2UsXG4gICAgZGVkdXBlID0gZmFsc2VcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHByZWRpY2F0ZSA9IGNyZWF0ZUtleVByZWRpY2F0ZShrZXkpO1xuICBjb25zdCBsaXN0ZW5lciA9IChlKSA9PiB7XG4gICAgaWYgKGUucmVwZWF0ICYmIHRvVmFsdWUoZGVkdXBlKSlcbiAgICAgIHJldHVybjtcbiAgICBpZiAocHJlZGljYXRlKGUpKVxuICAgICAgaGFuZGxlcihlKTtcbiAgfTtcbiAgcmV0dXJuIHVzZUV2ZW50TGlzdGVuZXIodGFyZ2V0LCBldmVudE5hbWUsIGxpc3RlbmVyLCBwYXNzaXZlKTtcbn1cbmZ1bmN0aW9uIG9uS2V5RG93bihrZXksIGhhbmRsZXIsIG9wdGlvbnMgPSB7fSkge1xuICByZXR1cm4gb25LZXlTdHJva2Uoa2V5LCBoYW5kbGVyLCB7IC4uLm9wdGlvbnMsIGV2ZW50TmFtZTogXCJrZXlkb3duXCIgfSk7XG59XG5mdW5jdGlvbiBvbktleVByZXNzZWQoa2V5LCBoYW5kbGVyLCBvcHRpb25zID0ge30pIHtcbiAgcmV0dXJuIG9uS2V5U3Ryb2tlKGtleSwgaGFuZGxlciwgeyAuLi5vcHRpb25zLCBldmVudE5hbWU6IFwia2V5cHJlc3NcIiB9KTtcbn1cbmZ1bmN0aW9uIG9uS2V5VXAoa2V5LCBoYW5kbGVyLCBvcHRpb25zID0ge30pIHtcbiAgcmV0dXJuIG9uS2V5U3Ryb2tlKGtleSwgaGFuZGxlciwgeyAuLi5vcHRpb25zLCBldmVudE5hbWU6IFwia2V5dXBcIiB9KTtcbn1cblxuY29uc3QgREVGQVVMVF9ERUxBWSA9IDUwMDtcbmNvbnN0IERFRkFVTFRfVEhSRVNIT0xEID0gMTA7XG5mdW5jdGlvbiBvbkxvbmdQcmVzcyh0YXJnZXQsIGhhbmRsZXIsIG9wdGlvbnMpIHtcbiAgdmFyIF9hLCBfYjtcbiAgY29uc3QgZWxlbWVudFJlZiA9IGNvbXB1dGVkKCgpID0+IHVucmVmRWxlbWVudCh0YXJnZXQpKTtcbiAgbGV0IHRpbWVvdXQ7XG4gIGxldCBwb3NTdGFydDtcbiAgbGV0IHN0YXJ0VGltZXN0YW1wO1xuICBsZXQgaGFzTG9uZ1ByZXNzZWQgPSBmYWxzZTtcbiAgZnVuY3Rpb24gY2xlYXIoKSB7XG4gICAgaWYgKHRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgIHRpbWVvdXQgPSB2b2lkIDA7XG4gICAgfVxuICAgIHBvc1N0YXJ0ID0gdm9pZCAwO1xuICAgIHN0YXJ0VGltZXN0YW1wID0gdm9pZCAwO1xuICAgIGhhc0xvbmdQcmVzc2VkID0gZmFsc2U7XG4gIH1cbiAgZnVuY3Rpb24gZ2V0RGVsYXkoZXYpIHtcbiAgICBjb25zdCBkZWxheSA9IG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuZGVsYXk7XG4gICAgaWYgKHR5cGVvZiBkZWxheSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICByZXR1cm4gZGVsYXkoZXYpO1xuICAgIH1cbiAgICByZXR1cm4gZGVsYXkgIT0gbnVsbCA/IGRlbGF5IDogREVGQVVMVF9ERUxBWTtcbiAgfVxuICBmdW5jdGlvbiBvblJlbGVhc2UoZXYpIHtcbiAgICB2YXIgX2EyLCBfYjIsIF9jO1xuICAgIGNvbnN0IFtfc3RhcnRUaW1lc3RhbXAsIF9wb3NTdGFydCwgX2hhc0xvbmdQcmVzc2VkXSA9IFtzdGFydFRpbWVzdGFtcCwgcG9zU3RhcnQsIGhhc0xvbmdQcmVzc2VkXTtcbiAgICBjbGVhcigpO1xuICAgIGlmICghKG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMub25Nb3VzZVVwKSB8fCAhX3Bvc1N0YXJ0IHx8ICFfc3RhcnRUaW1lc3RhbXApXG4gICAgICByZXR1cm47XG4gICAgaWYgKCgoX2EyID0gb3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5tb2RpZmllcnMpID09IG51bGwgPyB2b2lkIDAgOiBfYTIuc2VsZikgJiYgZXYudGFyZ2V0ICE9PSBlbGVtZW50UmVmLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIGlmICgoX2IyID0gb3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5tb2RpZmllcnMpID09IG51bGwgPyB2b2lkIDAgOiBfYjIucHJldmVudClcbiAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgaWYgKChfYyA9IG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMubW9kaWZpZXJzKSA9PSBudWxsID8gdm9pZCAwIDogX2Muc3RvcClcbiAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIGNvbnN0IGR4ID0gZXYueCAtIF9wb3NTdGFydC54O1xuICAgIGNvbnN0IGR5ID0gZXYueSAtIF9wb3NTdGFydC55O1xuICAgIGNvbnN0IGRpc3RhbmNlID0gTWF0aC5zcXJ0KGR4ICogZHggKyBkeSAqIGR5KTtcbiAgICBvcHRpb25zLm9uTW91c2VVcChldi50aW1lU3RhbXAgLSBfc3RhcnRUaW1lc3RhbXAsIGRpc3RhbmNlLCBfaGFzTG9uZ1ByZXNzZWQpO1xuICB9XG4gIGZ1bmN0aW9uIG9uRG93bihldikge1xuICAgIHZhciBfYTIsIF9iMiwgX2M7XG4gICAgaWYgKCgoX2EyID0gb3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5tb2RpZmllcnMpID09IG51bGwgPyB2b2lkIDAgOiBfYTIuc2VsZikgJiYgZXYudGFyZ2V0ICE9PSBlbGVtZW50UmVmLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIGNsZWFyKCk7XG4gICAgaWYgKChfYjIgPSBvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLm1vZGlmaWVycykgPT0gbnVsbCA/IHZvaWQgMCA6IF9iMi5wcmV2ZW50KVxuICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICBpZiAoKF9jID0gb3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5tb2RpZmllcnMpID09IG51bGwgPyB2b2lkIDAgOiBfYy5zdG9wKVxuICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgcG9zU3RhcnQgPSB7XG4gICAgICB4OiBldi54LFxuICAgICAgeTogZXYueVxuICAgIH07XG4gICAgc3RhcnRUaW1lc3RhbXAgPSBldi50aW1lU3RhbXA7XG4gICAgdGltZW91dCA9IHNldFRpbWVvdXQoXG4gICAgICAoKSA9PiB7XG4gICAgICAgIGhhc0xvbmdQcmVzc2VkID0gdHJ1ZTtcbiAgICAgICAgaGFuZGxlcihldik7XG4gICAgICB9LFxuICAgICAgZ2V0RGVsYXkoZXYpXG4gICAgKTtcbiAgfVxuICBmdW5jdGlvbiBvbk1vdmUoZXYpIHtcbiAgICB2YXIgX2EyLCBfYjIsIF9jLCBfZDtcbiAgICBpZiAoKChfYTIgPSBvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLm1vZGlmaWVycykgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5zZWxmKSAmJiBldi50YXJnZXQgIT09IGVsZW1lbnRSZWYudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgaWYgKCFwb3NTdGFydCB8fCAob3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5kaXN0YW5jZVRocmVzaG9sZCkgPT09IGZhbHNlKVxuICAgICAgcmV0dXJuO1xuICAgIGlmICgoX2IyID0gb3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5tb2RpZmllcnMpID09IG51bGwgPyB2b2lkIDAgOiBfYjIucHJldmVudClcbiAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgaWYgKChfYyA9IG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMubW9kaWZpZXJzKSA9PSBudWxsID8gdm9pZCAwIDogX2Muc3RvcClcbiAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIGNvbnN0IGR4ID0gZXYueCAtIHBvc1N0YXJ0Lng7XG4gICAgY29uc3QgZHkgPSBldi55IC0gcG9zU3RhcnQueTtcbiAgICBjb25zdCBkaXN0YW5jZSA9IE1hdGguc3FydChkeCAqIGR4ICsgZHkgKiBkeSk7XG4gICAgaWYgKGRpc3RhbmNlID49ICgoX2QgPSBvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLmRpc3RhbmNlVGhyZXNob2xkKSAhPSBudWxsID8gX2QgOiBERUZBVUxUX1RIUkVTSE9MRCkpXG4gICAgICBjbGVhcigpO1xuICB9XG4gIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHtcbiAgICBjYXB0dXJlOiAoX2EgPSBvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLm1vZGlmaWVycykgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmNhcHR1cmUsXG4gICAgb25jZTogKF9iID0gb3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5tb2RpZmllcnMpID09IG51bGwgPyB2b2lkIDAgOiBfYi5vbmNlXG4gIH07XG4gIGNvbnN0IGNsZWFudXAgPSBbXG4gICAgdXNlRXZlbnRMaXN0ZW5lcihlbGVtZW50UmVmLCBcInBvaW50ZXJkb3duXCIsIG9uRG93biwgbGlzdGVuZXJPcHRpb25zKSxcbiAgICB1c2VFdmVudExpc3RlbmVyKGVsZW1lbnRSZWYsIFwicG9pbnRlcm1vdmVcIiwgb25Nb3ZlLCBsaXN0ZW5lck9wdGlvbnMpLFxuICAgIHVzZUV2ZW50TGlzdGVuZXIoZWxlbWVudFJlZiwgW1wicG9pbnRlcnVwXCIsIFwicG9pbnRlcmxlYXZlXCJdLCBvblJlbGVhc2UsIGxpc3RlbmVyT3B0aW9ucylcbiAgXTtcbiAgY29uc3Qgc3RvcCA9ICgpID0+IGNsZWFudXAuZm9yRWFjaCgoZm4pID0+IGZuKCkpO1xuICByZXR1cm4gc3RvcDtcbn1cblxuZnVuY3Rpb24gaXNGb2N1c2VkRWxlbWVudEVkaXRhYmxlKCkge1xuICBjb25zdCB7IGFjdGl2ZUVsZW1lbnQsIGJvZHkgfSA9IGRvY3VtZW50O1xuICBpZiAoIWFjdGl2ZUVsZW1lbnQpXG4gICAgcmV0dXJuIGZhbHNlO1xuICBpZiAoYWN0aXZlRWxlbWVudCA9PT0gYm9keSlcbiAgICByZXR1cm4gZmFsc2U7XG4gIHN3aXRjaCAoYWN0aXZlRWxlbWVudC50YWdOYW1lKSB7XG4gICAgY2FzZSBcIklOUFVUXCI6XG4gICAgY2FzZSBcIlRFWFRBUkVBXCI6XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICByZXR1cm4gYWN0aXZlRWxlbWVudC5oYXNBdHRyaWJ1dGUoXCJjb250ZW50ZWRpdGFibGVcIik7XG59XG5mdW5jdGlvbiBpc1R5cGVkQ2hhclZhbGlkKHtcbiAga2V5Q29kZSxcbiAgbWV0YUtleSxcbiAgY3RybEtleSxcbiAgYWx0S2V5XG59KSB7XG4gIGlmIChtZXRhS2V5IHx8IGN0cmxLZXkgfHwgYWx0S2V5KVxuICAgIHJldHVybiBmYWxzZTtcbiAgaWYgKGtleUNvZGUgPj0gNDggJiYga2V5Q29kZSA8PSA1NyB8fCBrZXlDb2RlID49IDk2ICYmIGtleUNvZGUgPD0gMTA1KVxuICAgIHJldHVybiB0cnVlO1xuICBpZiAoa2V5Q29kZSA+PSA2NSAmJiBrZXlDb2RlIDw9IDkwKVxuICAgIHJldHVybiB0cnVlO1xuICByZXR1cm4gZmFsc2U7XG59XG5mdW5jdGlvbiBvblN0YXJ0VHlwaW5nKGNhbGxiYWNrLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyBkb2N1bWVudDogZG9jdW1lbnQyID0gZGVmYXVsdERvY3VtZW50IH0gPSBvcHRpb25zO1xuICBjb25zdCBrZXlkb3duID0gKGV2ZW50KSA9PiB7XG4gICAgaWYgKCFpc0ZvY3VzZWRFbGVtZW50RWRpdGFibGUoKSAmJiBpc1R5cGVkQ2hhclZhbGlkKGV2ZW50KSkge1xuICAgICAgY2FsbGJhY2soZXZlbnQpO1xuICAgIH1cbiAgfTtcbiAgaWYgKGRvY3VtZW50MilcbiAgICB1c2VFdmVudExpc3RlbmVyKGRvY3VtZW50MiwgXCJrZXlkb3duXCIsIGtleWRvd24sIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHRlbXBsYXRlUmVmKGtleSwgaW5pdGlhbFZhbHVlID0gbnVsbCkge1xuICBjb25zdCBpbnN0YW5jZSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpO1xuICBsZXQgX3RyaWdnZXIgPSAoKSA9PiB7XG4gIH07XG4gIGNvbnN0IGVsZW1lbnQgPSBjdXN0b21SZWYoKHRyYWNrLCB0cmlnZ2VyKSA9PiB7XG4gICAgX3RyaWdnZXIgPSB0cmlnZ2VyO1xuICAgIHJldHVybiB7XG4gICAgICBnZXQoKSB7XG4gICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgIHRyYWNrKCk7XG4gICAgICAgIHJldHVybiAoX2IgPSAoX2EgPSBpbnN0YW5jZSA9PSBudWxsID8gdm9pZCAwIDogaW5zdGFuY2UucHJveHkpID09IG51bGwgPyB2b2lkIDAgOiBfYS4kcmVmc1trZXldKSAhPSBudWxsID8gX2IgOiBpbml0aWFsVmFsdWU7XG4gICAgICB9LFxuICAgICAgc2V0KCkge1xuICAgICAgfVxuICAgIH07XG4gIH0pO1xuICB0cnlPbk1vdW50ZWQoX3RyaWdnZXIpO1xuICBvblVwZGF0ZWQoX3RyaWdnZXIpO1xuICByZXR1cm4gZWxlbWVudDtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUFjdGl2ZUVsZW1lbnQob3B0aW9ucyA9IHt9KSB7XG4gIHZhciBfYTtcbiAgY29uc3Qge1xuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3csXG4gICAgZGVlcCA9IHRydWUsXG4gICAgdHJpZ2dlck9uUmVtb3ZhbCA9IGZhbHNlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBkb2N1bWVudCA9IChfYSA9IG9wdGlvbnMuZG9jdW1lbnQpICE9IG51bGwgPyBfYSA6IHdpbmRvdyA9PSBudWxsID8gdm9pZCAwIDogd2luZG93LmRvY3VtZW50O1xuICBjb25zdCBnZXREZWVwQWN0aXZlRWxlbWVudCA9ICgpID0+IHtcbiAgICB2YXIgX2EyO1xuICAgIGxldCBlbGVtZW50ID0gZG9jdW1lbnQgPT0gbnVsbCA/IHZvaWQgMCA6IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XG4gICAgaWYgKGRlZXApIHtcbiAgICAgIHdoaWxlIChlbGVtZW50ID09IG51bGwgPyB2b2lkIDAgOiBlbGVtZW50LnNoYWRvd1Jvb3QpXG4gICAgICAgIGVsZW1lbnQgPSAoX2EyID0gZWxlbWVudCA9PSBudWxsID8gdm9pZCAwIDogZWxlbWVudC5zaGFkb3dSb290KSA9PSBudWxsID8gdm9pZCAwIDogX2EyLmFjdGl2ZUVsZW1lbnQ7XG4gICAgfVxuICAgIHJldHVybiBlbGVtZW50O1xuICB9O1xuICBjb25zdCBhY3RpdmVFbGVtZW50ID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCB0cmlnZ2VyID0gKCkgPT4ge1xuICAgIGFjdGl2ZUVsZW1lbnQudmFsdWUgPSBnZXREZWVwQWN0aXZlRWxlbWVudCgpO1xuICB9O1xuICBpZiAod2luZG93KSB7XG4gICAgY29uc3QgbGlzdGVuZXJPcHRpb25zID0ge1xuICAgICAgY2FwdHVyZTogdHJ1ZSxcbiAgICAgIHBhc3NpdmU6IHRydWVcbiAgICB9O1xuICAgIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgICB3aW5kb3csXG4gICAgICBcImJsdXJcIixcbiAgICAgIChldmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQucmVsYXRlZFRhcmdldCAhPT0gbnVsbClcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIHRyaWdnZXIoKTtcbiAgICAgIH0sXG4gICAgICBsaXN0ZW5lck9wdGlvbnNcbiAgICApO1xuICAgIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgICB3aW5kb3csXG4gICAgICBcImZvY3VzXCIsXG4gICAgICB0cmlnZ2VyLFxuICAgICAgbGlzdGVuZXJPcHRpb25zXG4gICAgKTtcbiAgfVxuICBpZiAodHJpZ2dlck9uUmVtb3ZhbCkge1xuICAgIG9uRWxlbWVudFJlbW92YWwoYWN0aXZlRWxlbWVudCwgdHJpZ2dlciwgeyBkb2N1bWVudCB9KTtcbiAgfVxuICB0cmlnZ2VyKCk7XG4gIHJldHVybiBhY3RpdmVFbGVtZW50O1xufVxuXG5mdW5jdGlvbiB1c2VSYWZGbihmbiwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBpbW1lZGlhdGUgPSB0cnVlLFxuICAgIGZwc0xpbWl0ID0gdm9pZCAwLFxuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3csXG4gICAgb25jZSA9IGZhbHNlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBpc0FjdGl2ZSA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBpbnRlcnZhbExpbWl0ID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIHJldHVybiBmcHNMaW1pdCA/IDFlMyAvIHRvVmFsdWUoZnBzTGltaXQpIDogbnVsbDtcbiAgfSk7XG4gIGxldCBwcmV2aW91c0ZyYW1lVGltZXN0YW1wID0gMDtcbiAgbGV0IHJhZklkID0gbnVsbDtcbiAgZnVuY3Rpb24gbG9vcCh0aW1lc3RhbXApIHtcbiAgICBpZiAoIWlzQWN0aXZlLnZhbHVlIHx8ICF3aW5kb3cpXG4gICAgICByZXR1cm47XG4gICAgaWYgKCFwcmV2aW91c0ZyYW1lVGltZXN0YW1wKVxuICAgICAgcHJldmlvdXNGcmFtZVRpbWVzdGFtcCA9IHRpbWVzdGFtcDtcbiAgICBjb25zdCBkZWx0YSA9IHRpbWVzdGFtcCAtIHByZXZpb3VzRnJhbWVUaW1lc3RhbXA7XG4gICAgaWYgKGludGVydmFsTGltaXQudmFsdWUgJiYgZGVsdGEgPCBpbnRlcnZhbExpbWl0LnZhbHVlKSB7XG4gICAgICByYWZJZCA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUobG9vcCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHByZXZpb3VzRnJhbWVUaW1lc3RhbXAgPSB0aW1lc3RhbXA7XG4gICAgZm4oeyBkZWx0YSwgdGltZXN0YW1wIH0pO1xuICAgIGlmIChvbmNlKSB7XG4gICAgICBpc0FjdGl2ZS52YWx1ZSA9IGZhbHNlO1xuICAgICAgcmFmSWQgPSBudWxsO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByYWZJZCA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUobG9vcCk7XG4gIH1cbiAgZnVuY3Rpb24gcmVzdW1lKCkge1xuICAgIGlmICghaXNBY3RpdmUudmFsdWUgJiYgd2luZG93KSB7XG4gICAgICBpc0FjdGl2ZS52YWx1ZSA9IHRydWU7XG4gICAgICBwcmV2aW91c0ZyYW1lVGltZXN0YW1wID0gMDtcbiAgICAgIHJhZklkID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZShsb29wKTtcbiAgICB9XG4gIH1cbiAgZnVuY3Rpb24gcGF1c2UoKSB7XG4gICAgaXNBY3RpdmUudmFsdWUgPSBmYWxzZTtcbiAgICBpZiAocmFmSWQgIT0gbnVsbCAmJiB3aW5kb3cpIHtcbiAgICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZShyYWZJZCk7XG4gICAgICByYWZJZCA9IG51bGw7XG4gICAgfVxuICB9XG4gIGlmIChpbW1lZGlhdGUpXG4gICAgcmVzdW1lKCk7XG4gIHRyeU9uU2NvcGVEaXNwb3NlKHBhdXNlKTtcbiAgcmV0dXJuIHtcbiAgICBpc0FjdGl2ZTogcmVhZG9ubHkoaXNBY3RpdmUpLFxuICAgIHBhdXNlLFxuICAgIHJlc3VtZVxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VBbmltYXRlKHRhcmdldCwga2V5ZnJhbWVzLCBvcHRpb25zKSB7XG4gIGxldCBjb25maWc7XG4gIGxldCBhbmltYXRlT3B0aW9ucztcbiAgaWYgKGlzT2JqZWN0KG9wdGlvbnMpKSB7XG4gICAgY29uZmlnID0gb3B0aW9ucztcbiAgICBhbmltYXRlT3B0aW9ucyA9IG9iamVjdE9taXQob3B0aW9ucywgW1wid2luZG93XCIsIFwiaW1tZWRpYXRlXCIsIFwiY29tbWl0U3R5bGVzXCIsIFwicGVyc2lzdFwiLCBcIm9uUmVhZHlcIiwgXCJvbkVycm9yXCJdKTtcbiAgfSBlbHNlIHtcbiAgICBjb25maWcgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07XG4gICAgYW5pbWF0ZU9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG4gIGNvbnN0IHtcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93LFxuICAgIGltbWVkaWF0ZSA9IHRydWUsXG4gICAgY29tbWl0U3R5bGVzLFxuICAgIHBlcnNpc3QsXG4gICAgcGxheWJhY2tSYXRlOiBfcGxheWJhY2tSYXRlID0gMSxcbiAgICBvblJlYWR5LFxuICAgIG9uRXJyb3IgPSAoZSkgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICB9XG4gIH0gPSBjb25maWc7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHdpbmRvdyAmJiBIVE1MRWxlbWVudCAmJiBcImFuaW1hdGVcIiBpbiBIVE1MRWxlbWVudC5wcm90b3R5cGUpO1xuICBjb25zdCBhbmltYXRlID0gc2hhbGxvd1JlZih2b2lkIDApO1xuICBjb25zdCBzdG9yZSA9IHNoYWxsb3dSZWFjdGl2ZSh7XG4gICAgc3RhcnRUaW1lOiBudWxsLFxuICAgIGN1cnJlbnRUaW1lOiBudWxsLFxuICAgIHRpbWVsaW5lOiBudWxsLFxuICAgIHBsYXliYWNrUmF0ZTogX3BsYXliYWNrUmF0ZSxcbiAgICBwZW5kaW5nOiBmYWxzZSxcbiAgICBwbGF5U3RhdGU6IGltbWVkaWF0ZSA/IFwiaWRsZVwiIDogXCJwYXVzZWRcIixcbiAgICByZXBsYWNlU3RhdGU6IFwiYWN0aXZlXCJcbiAgfSk7XG4gIGNvbnN0IHBlbmRpbmcgPSBjb21wdXRlZCgoKSA9PiBzdG9yZS5wZW5kaW5nKTtcbiAgY29uc3QgcGxheVN0YXRlID0gY29tcHV0ZWQoKCkgPT4gc3RvcmUucGxheVN0YXRlKTtcbiAgY29uc3QgcmVwbGFjZVN0YXRlID0gY29tcHV0ZWQoKCkgPT4gc3RvcmUucmVwbGFjZVN0YXRlKTtcbiAgY29uc3Qgc3RhcnRUaW1lID0gY29tcHV0ZWQoe1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBzdG9yZS5zdGFydFRpbWU7XG4gICAgfSxcbiAgICBzZXQodmFsdWUpIHtcbiAgICAgIHN0b3JlLnN0YXJ0VGltZSA9IHZhbHVlO1xuICAgICAgaWYgKGFuaW1hdGUudmFsdWUpXG4gICAgICAgIGFuaW1hdGUudmFsdWUuc3RhcnRUaW1lID0gdmFsdWU7XG4gICAgfVxuICB9KTtcbiAgY29uc3QgY3VycmVudFRpbWUgPSBjb21wdXRlZCh7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIHN0b3JlLmN1cnJlbnRUaW1lO1xuICAgIH0sXG4gICAgc2V0KHZhbHVlKSB7XG4gICAgICBzdG9yZS5jdXJyZW50VGltZSA9IHZhbHVlO1xuICAgICAgaWYgKGFuaW1hdGUudmFsdWUpIHtcbiAgICAgICAgYW5pbWF0ZS52YWx1ZS5jdXJyZW50VGltZSA9IHZhbHVlO1xuICAgICAgICBzeW5jUmVzdW1lKCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgY29uc3QgdGltZWxpbmUgPSBjb21wdXRlZCh7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIHN0b3JlLnRpbWVsaW5lO1xuICAgIH0sXG4gICAgc2V0KHZhbHVlKSB7XG4gICAgICBzdG9yZS50aW1lbGluZSA9IHZhbHVlO1xuICAgICAgaWYgKGFuaW1hdGUudmFsdWUpXG4gICAgICAgIGFuaW1hdGUudmFsdWUudGltZWxpbmUgPSB2YWx1ZTtcbiAgICB9XG4gIH0pO1xuICBjb25zdCBwbGF5YmFja1JhdGUgPSBjb21wdXRlZCh7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIHN0b3JlLnBsYXliYWNrUmF0ZTtcbiAgICB9LFxuICAgIHNldCh2YWx1ZSkge1xuICAgICAgc3RvcmUucGxheWJhY2tSYXRlID0gdmFsdWU7XG4gICAgICBpZiAoYW5pbWF0ZS52YWx1ZSlcbiAgICAgICAgYW5pbWF0ZS52YWx1ZS5wbGF5YmFja1JhdGUgPSB2YWx1ZTtcbiAgICB9XG4gIH0pO1xuICBjb25zdCBwbGF5ID0gKCkgPT4ge1xuICAgIGlmIChhbmltYXRlLnZhbHVlKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhbmltYXRlLnZhbHVlLnBsYXkoKTtcbiAgICAgICAgc3luY1Jlc3VtZSgpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBzeW5jUGF1c2UoKTtcbiAgICAgICAgb25FcnJvcihlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdXBkYXRlKCk7XG4gICAgfVxuICB9O1xuICBjb25zdCBwYXVzZSA9ICgpID0+IHtcbiAgICB2YXIgX2E7XG4gICAgdHJ5IHtcbiAgICAgIChfYSA9IGFuaW1hdGUudmFsdWUpID09IG51bGwgPyB2b2lkIDAgOiBfYS5wYXVzZSgpO1xuICAgICAgc3luY1BhdXNlKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgb25FcnJvcihlKTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IHJldmVyc2UgPSAoKSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIGlmICghYW5pbWF0ZS52YWx1ZSlcbiAgICAgIHVwZGF0ZSgpO1xuICAgIHRyeSB7XG4gICAgICAoX2EgPSBhbmltYXRlLnZhbHVlKSA9PSBudWxsID8gdm9pZCAwIDogX2EucmV2ZXJzZSgpO1xuICAgICAgc3luY1Jlc3VtZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHN5bmNQYXVzZSgpO1xuICAgICAgb25FcnJvcihlKTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IGZpbmlzaCA9ICgpID0+IHtcbiAgICB2YXIgX2E7XG4gICAgdHJ5IHtcbiAgICAgIChfYSA9IGFuaW1hdGUudmFsdWUpID09IG51bGwgPyB2b2lkIDAgOiBfYS5maW5pc2goKTtcbiAgICAgIHN5bmNQYXVzZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIG9uRXJyb3IoZSk7XG4gICAgfVxuICB9O1xuICBjb25zdCBjYW5jZWwgPSAoKSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIHRyeSB7XG4gICAgICAoX2EgPSBhbmltYXRlLnZhbHVlKSA9PSBudWxsID8gdm9pZCAwIDogX2EuY2FuY2VsKCk7XG4gICAgICBzeW5jUGF1c2UoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBvbkVycm9yKGUpO1xuICAgIH1cbiAgfTtcbiAgd2F0Y2goKCkgPT4gdW5yZWZFbGVtZW50KHRhcmdldCksIChlbCkgPT4ge1xuICAgIGlmIChlbCkge1xuICAgICAgdXBkYXRlKHRydWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhbmltYXRlLnZhbHVlID0gdm9pZCAwO1xuICAgIH1cbiAgfSk7XG4gIHdhdGNoKCgpID0+IGtleWZyYW1lcywgKHZhbHVlKSA9PiB7XG4gICAgaWYgKGFuaW1hdGUudmFsdWUpIHtcbiAgICAgIHVwZGF0ZSgpO1xuICAgICAgY29uc3QgdGFyZ2V0RWwgPSB1bnJlZkVsZW1lbnQodGFyZ2V0KTtcbiAgICAgIGlmICh0YXJnZXRFbCkge1xuICAgICAgICBhbmltYXRlLnZhbHVlLmVmZmVjdCA9IG5ldyBLZXlmcmFtZUVmZmVjdChcbiAgICAgICAgICB0YXJnZXRFbCxcbiAgICAgICAgICB0b1ZhbHVlKHZhbHVlKSxcbiAgICAgICAgICBhbmltYXRlT3B0aW9uc1xuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfSwgeyBkZWVwOiB0cnVlIH0pO1xuICB0cnlPbk1vdW50ZWQoKCkgPT4gdXBkYXRlKHRydWUpLCBmYWxzZSk7XG4gIHRyeU9uU2NvcGVEaXNwb3NlKGNhbmNlbCk7XG4gIGZ1bmN0aW9uIHVwZGF0ZShpbml0KSB7XG4gICAgY29uc3QgZWwgPSB1bnJlZkVsZW1lbnQodGFyZ2V0KTtcbiAgICBpZiAoIWlzU3VwcG9ydGVkLnZhbHVlIHx8ICFlbClcbiAgICAgIHJldHVybjtcbiAgICBpZiAoIWFuaW1hdGUudmFsdWUpXG4gICAgICBhbmltYXRlLnZhbHVlID0gZWwuYW5pbWF0ZSh0b1ZhbHVlKGtleWZyYW1lcyksIGFuaW1hdGVPcHRpb25zKTtcbiAgICBpZiAocGVyc2lzdClcbiAgICAgIGFuaW1hdGUudmFsdWUucGVyc2lzdCgpO1xuICAgIGlmIChfcGxheWJhY2tSYXRlICE9PSAxKVxuICAgICAgYW5pbWF0ZS52YWx1ZS5wbGF5YmFja1JhdGUgPSBfcGxheWJhY2tSYXRlO1xuICAgIGlmIChpbml0ICYmICFpbW1lZGlhdGUpXG4gICAgICBhbmltYXRlLnZhbHVlLnBhdXNlKCk7XG4gICAgZWxzZVxuICAgICAgc3luY1Jlc3VtZSgpO1xuICAgIG9uUmVhZHkgPT0gbnVsbCA/IHZvaWQgMCA6IG9uUmVhZHkoYW5pbWF0ZS52YWx1ZSk7XG4gIH1cbiAgY29uc3QgbGlzdGVuZXJPcHRpb25zID0geyBwYXNzaXZlOiB0cnVlIH07XG4gIHVzZUV2ZW50TGlzdGVuZXIoYW5pbWF0ZSwgW1wiY2FuY2VsXCIsIFwiZmluaXNoXCIsIFwicmVtb3ZlXCJdLCBzeW5jUGF1c2UsIGxpc3RlbmVyT3B0aW9ucyk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoYW5pbWF0ZSwgXCJmaW5pc2hcIiwgKCkgPT4ge1xuICAgIHZhciBfYTtcbiAgICBpZiAoY29tbWl0U3R5bGVzKVxuICAgICAgKF9hID0gYW5pbWF0ZS52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmNvbW1pdFN0eWxlcygpO1xuICB9LCBsaXN0ZW5lck9wdGlvbnMpO1xuICBjb25zdCB7IHJlc3VtZTogcmVzdW1lUmVmLCBwYXVzZTogcGF1c2VSZWYgfSA9IHVzZVJhZkZuKCgpID0+IHtcbiAgICBpZiAoIWFuaW1hdGUudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgc3RvcmUucGVuZGluZyA9IGFuaW1hdGUudmFsdWUucGVuZGluZztcbiAgICBzdG9yZS5wbGF5U3RhdGUgPSBhbmltYXRlLnZhbHVlLnBsYXlTdGF0ZTtcbiAgICBzdG9yZS5yZXBsYWNlU3RhdGUgPSBhbmltYXRlLnZhbHVlLnJlcGxhY2VTdGF0ZTtcbiAgICBzdG9yZS5zdGFydFRpbWUgPSBhbmltYXRlLnZhbHVlLnN0YXJ0VGltZTtcbiAgICBzdG9yZS5jdXJyZW50VGltZSA9IGFuaW1hdGUudmFsdWUuY3VycmVudFRpbWU7XG4gICAgc3RvcmUudGltZWxpbmUgPSBhbmltYXRlLnZhbHVlLnRpbWVsaW5lO1xuICAgIHN0b3JlLnBsYXliYWNrUmF0ZSA9IGFuaW1hdGUudmFsdWUucGxheWJhY2tSYXRlO1xuICB9LCB7IGltbWVkaWF0ZTogZmFsc2UgfSk7XG4gIGZ1bmN0aW9uIHN5bmNSZXN1bWUoKSB7XG4gICAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlKVxuICAgICAgcmVzdW1lUmVmKCk7XG4gIH1cbiAgZnVuY3Rpb24gc3luY1BhdXNlKCkge1xuICAgIGlmIChpc1N1cHBvcnRlZC52YWx1ZSAmJiB3aW5kb3cpXG4gICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHBhdXNlUmVmKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIGlzU3VwcG9ydGVkLFxuICAgIGFuaW1hdGUsXG4gICAgLy8gYWN0aW9uc1xuICAgIHBsYXksXG4gICAgcGF1c2UsXG4gICAgcmV2ZXJzZSxcbiAgICBmaW5pc2gsXG4gICAgY2FuY2VsLFxuICAgIC8vIHN0YXRlXG4gICAgcGVuZGluZyxcbiAgICBwbGF5U3RhdGUsXG4gICAgcmVwbGFjZVN0YXRlLFxuICAgIHN0YXJ0VGltZSxcbiAgICBjdXJyZW50VGltZSxcbiAgICB0aW1lbGluZSxcbiAgICBwbGF5YmFja1JhdGVcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlQXN5bmNRdWV1ZSh0YXNrcywgb3B0aW9ucykge1xuICBjb25zdCB7XG4gICAgaW50ZXJydXB0ID0gdHJ1ZSxcbiAgICBvbkVycm9yID0gbm9vcCxcbiAgICBvbkZpbmlzaGVkID0gbm9vcCxcbiAgICBzaWduYWxcbiAgfSA9IG9wdGlvbnMgfHwge307XG4gIGNvbnN0IHByb21pc2VTdGF0ZSA9IHtcbiAgICBhYm9ydGVkOiBcImFib3J0ZWRcIixcbiAgICBmdWxmaWxsZWQ6IFwiZnVsZmlsbGVkXCIsXG4gICAgcGVuZGluZzogXCJwZW5kaW5nXCIsXG4gICAgcmVqZWN0ZWQ6IFwicmVqZWN0ZWRcIlxuICB9O1xuICBjb25zdCBpbml0aWFsUmVzdWx0ID0gQXJyYXkuZnJvbShBcnJheS5mcm9tKHsgbGVuZ3RoOiB0YXNrcy5sZW5ndGggfSksICgpID0+ICh7IHN0YXRlOiBwcm9taXNlU3RhdGUucGVuZGluZywgZGF0YTogbnVsbCB9KSk7XG4gIGNvbnN0IHJlc3VsdCA9IHJlYWN0aXZlKGluaXRpYWxSZXN1bHQpO1xuICBjb25zdCBhY3RpdmVJbmRleCA9IHNoYWxsb3dSZWYoLTEpO1xuICBpZiAoIXRhc2tzIHx8IHRhc2tzLmxlbmd0aCA9PT0gMCkge1xuICAgIG9uRmluaXNoZWQoKTtcbiAgICByZXR1cm4ge1xuICAgICAgYWN0aXZlSW5kZXgsXG4gICAgICByZXN1bHRcbiAgICB9O1xuICB9XG4gIGZ1bmN0aW9uIHVwZGF0ZVJlc3VsdChzdGF0ZSwgcmVzKSB7XG4gICAgYWN0aXZlSW5kZXgudmFsdWUrKztcbiAgICByZXN1bHRbYWN0aXZlSW5kZXgudmFsdWVdLmRhdGEgPSByZXM7XG4gICAgcmVzdWx0W2FjdGl2ZUluZGV4LnZhbHVlXS5zdGF0ZSA9IHN0YXRlO1xuICB9XG4gIHRhc2tzLnJlZHVjZSgocHJldiwgY3VycikgPT4ge1xuICAgIHJldHVybiBwcmV2LnRoZW4oKHByZXZSZXMpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIGlmIChzaWduYWwgPT0gbnVsbCA/IHZvaWQgMCA6IHNpZ25hbC5hYm9ydGVkKSB7XG4gICAgICAgIHVwZGF0ZVJlc3VsdChwcm9taXNlU3RhdGUuYWJvcnRlZCwgbmV3IEVycm9yKFwiYWJvcnRlZFwiKSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICgoKF9hID0gcmVzdWx0W2FjdGl2ZUluZGV4LnZhbHVlXSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnN0YXRlKSA9PT0gcHJvbWlzZVN0YXRlLnJlamVjdGVkICYmIGludGVycnVwdCkge1xuICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGRvbmUgPSBjdXJyKHByZXZSZXMpLnRoZW4oKGN1cnJlbnRSZXMpID0+IHtcbiAgICAgICAgdXBkYXRlUmVzdWx0KHByb21pc2VTdGF0ZS5mdWxmaWxsZWQsIGN1cnJlbnRSZXMpO1xuICAgICAgICBpZiAoYWN0aXZlSW5kZXgudmFsdWUgPT09IHRhc2tzLmxlbmd0aCAtIDEpXG4gICAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgICByZXR1cm4gY3VycmVudFJlcztcbiAgICAgIH0pO1xuICAgICAgaWYgKCFzaWduYWwpXG4gICAgICAgIHJldHVybiBkb25lO1xuICAgICAgcmV0dXJuIFByb21pc2UucmFjZShbZG9uZSwgd2hlbkFib3J0ZWQoc2lnbmFsKV0pO1xuICAgIH0pLmNhdGNoKChlKSA9PiB7XG4gICAgICBpZiAoc2lnbmFsID09IG51bGwgPyB2b2lkIDAgOiBzaWduYWwuYWJvcnRlZCkge1xuICAgICAgICB1cGRhdGVSZXN1bHQocHJvbWlzZVN0YXRlLmFib3J0ZWQsIGUpO1xuICAgICAgICByZXR1cm4gZTtcbiAgICAgIH1cbiAgICAgIHVwZGF0ZVJlc3VsdChwcm9taXNlU3RhdGUucmVqZWN0ZWQsIGUpO1xuICAgICAgb25FcnJvcigpO1xuICAgICAgcmV0dXJuIGU7XG4gICAgfSk7XG4gIH0sIFByb21pc2UucmVzb2x2ZSgpKTtcbiAgcmV0dXJuIHtcbiAgICBhY3RpdmVJbmRleCxcbiAgICByZXN1bHRcbiAgfTtcbn1cbmZ1bmN0aW9uIHdoZW5BYm9ydGVkKHNpZ25hbCkge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKFwiYWJvcnRlZFwiKTtcbiAgICBpZiAoc2lnbmFsLmFib3J0ZWQpXG4gICAgICByZWplY3QoZXJyb3IpO1xuICAgIGVsc2VcbiAgICAgIHNpZ25hbC5hZGRFdmVudExpc3RlbmVyKFwiYWJvcnRcIiwgKCkgPT4gcmVqZWN0KGVycm9yKSwgeyBvbmNlOiB0cnVlIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gdXNlQXN5bmNTdGF0ZShwcm9taXNlLCBpbml0aWFsU3RhdGUsIG9wdGlvbnMpIHtcbiAgdmFyIF9hO1xuICBjb25zdCB7XG4gICAgaW1tZWRpYXRlID0gdHJ1ZSxcbiAgICBkZWxheSA9IDAsXG4gICAgb25FcnJvciA9IChfYSA9IGdsb2JhbFRoaXMucmVwb3J0RXJyb3IpICE9IG51bGwgPyBfYSA6IG5vb3AsXG4gICAgb25TdWNjZXNzID0gbm9vcCxcbiAgICByZXNldE9uRXhlY3V0ZSA9IHRydWUsXG4gICAgc2hhbGxvdyA9IHRydWUsXG4gICAgdGhyb3dFcnJvclxuICB9ID0gb3B0aW9ucyAhPSBudWxsID8gb3B0aW9ucyA6IHt9O1xuICBjb25zdCBzdGF0ZSA9IHNoYWxsb3cgPyBzaGFsbG93UmVmKGluaXRpYWxTdGF0ZSkgOiByZWYoaW5pdGlhbFN0YXRlKTtcbiAgY29uc3QgaXNSZWFkeSA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBpc0xvYWRpbmcgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgZXJyb3IgPSBzaGFsbG93UmVmKHZvaWQgMCk7XG4gIGFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGUoZGVsYXkyID0gMCwgLi4uYXJncykge1xuICAgIGlmIChyZXNldE9uRXhlY3V0ZSlcbiAgICAgIHN0YXRlLnZhbHVlID0gdG9WYWx1ZShpbml0aWFsU3RhdGUpO1xuICAgIGVycm9yLnZhbHVlID0gdm9pZCAwO1xuICAgIGlzUmVhZHkudmFsdWUgPSBmYWxzZTtcbiAgICBpc0xvYWRpbmcudmFsdWUgPSB0cnVlO1xuICAgIGlmIChkZWxheTIgPiAwKVxuICAgICAgYXdhaXQgcHJvbWlzZVRpbWVvdXQoZGVsYXkyKTtcbiAgICBjb25zdCBfcHJvbWlzZSA9IHR5cGVvZiBwcm9taXNlID09PSBcImZ1bmN0aW9uXCIgPyBwcm9taXNlKC4uLmFyZ3MpIDogcHJvbWlzZTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IF9wcm9taXNlO1xuICAgICAgc3RhdGUudmFsdWUgPSBkYXRhO1xuICAgICAgaXNSZWFkeS52YWx1ZSA9IHRydWU7XG4gICAgICBvblN1Y2Nlc3MoZGF0YSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZXJyb3IudmFsdWUgPSBlO1xuICAgICAgb25FcnJvcihlKTtcbiAgICAgIGlmICh0aHJvd0Vycm9yKVxuICAgICAgICB0aHJvdyBlO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBpc0xvYWRpbmcudmFsdWUgPSBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHN0YXRlLnZhbHVlO1xuICB9XG4gIGlmIChpbW1lZGlhdGUpIHtcbiAgICBleGVjdXRlKGRlbGF5KTtcbiAgfVxuICBjb25zdCBzaGVsbCA9IHtcbiAgICBzdGF0ZSxcbiAgICBpc1JlYWR5LFxuICAgIGlzTG9hZGluZyxcbiAgICBlcnJvcixcbiAgICBleGVjdXRlLFxuICAgIGV4ZWN1dGVJbW1lZGlhdGU6ICguLi5hcmdzKSA9PiBleGVjdXRlKDAsIC4uLmFyZ3MpXG4gIH07XG4gIGZ1bmN0aW9uIHdhaXRVbnRpbElzTG9hZGVkKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB1bnRpbChpc0xvYWRpbmcpLnRvQmUoZmFsc2UpLnRoZW4oKCkgPT4gcmVzb2x2ZShzaGVsbCkpLmNhdGNoKHJlamVjdCk7XG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICAuLi5zaGVsbCxcbiAgICB0aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7XG4gICAgICByZXR1cm4gd2FpdFVudGlsSXNMb2FkZWQoKS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKTtcbiAgICB9XG4gIH07XG59XG5cbmNvbnN0IGRlZmF1bHRzID0ge1xuICBhcnJheTogKHYpID0+IEpTT04uc3RyaW5naWZ5KHYpLFxuICBvYmplY3Q6ICh2KSA9PiBKU09OLnN0cmluZ2lmeSh2KSxcbiAgc2V0OiAodikgPT4gSlNPTi5zdHJpbmdpZnkoQXJyYXkuZnJvbSh2KSksXG4gIG1hcDogKHYpID0+IEpTT04uc3RyaW5naWZ5KE9iamVjdC5mcm9tRW50cmllcyh2KSksXG4gIG51bGw6ICgpID0+IFwiXCJcbn07XG5mdW5jdGlvbiBnZXREZWZhdWx0U2VyaWFsaXphdGlvbih0YXJnZXQpIHtcbiAgaWYgKCF0YXJnZXQpXG4gICAgcmV0dXJuIGRlZmF1bHRzLm51bGw7XG4gIGlmICh0YXJnZXQgaW5zdGFuY2VvZiBNYXApXG4gICAgcmV0dXJuIGRlZmF1bHRzLm1hcDtcbiAgZWxzZSBpZiAodGFyZ2V0IGluc3RhbmNlb2YgU2V0KVxuICAgIHJldHVybiBkZWZhdWx0cy5zZXQ7XG4gIGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSlcbiAgICByZXR1cm4gZGVmYXVsdHMuYXJyYXk7XG4gIGVsc2VcbiAgICByZXR1cm4gZGVmYXVsdHMub2JqZWN0O1xufVxuXG5mdW5jdGlvbiB1c2VCYXNlNjQodGFyZ2V0LCBvcHRpb25zKSB7XG4gIGNvbnN0IGJhc2U2NCA9IHNoYWxsb3dSZWYoXCJcIik7XG4gIGNvbnN0IHByb21pc2UgPSBzaGFsbG93UmVmKCk7XG4gIGZ1bmN0aW9uIGV4ZWN1dGUoKSB7XG4gICAgaWYgKCFpc0NsaWVudClcbiAgICAgIHJldHVybjtcbiAgICBwcm9taXNlLnZhbHVlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgX3RhcmdldCA9IHRvVmFsdWUodGFyZ2V0KTtcbiAgICAgICAgaWYgKF90YXJnZXQgPT0gbnVsbCkge1xuICAgICAgICAgIHJlc29sdmUoXCJcIik7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIF90YXJnZXQgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICByZXNvbHZlKGJsb2JUb0Jhc2U2NChuZXcgQmxvYihbX3RhcmdldF0sIHsgdHlwZTogXCJ0ZXh0L3BsYWluXCIgfSkpKTtcbiAgICAgICAgfSBlbHNlIGlmIChfdGFyZ2V0IGluc3RhbmNlb2YgQmxvYikge1xuICAgICAgICAgIHJlc29sdmUoYmxvYlRvQmFzZTY0KF90YXJnZXQpKTtcbiAgICAgICAgfSBlbHNlIGlmIChfdGFyZ2V0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHtcbiAgICAgICAgICByZXNvbHZlKHdpbmRvdy5idG9hKFN0cmluZy5mcm9tQ2hhckNvZGUoLi4ubmV3IFVpbnQ4QXJyYXkoX3RhcmdldCkpKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoX3RhcmdldCBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50KSB7XG4gICAgICAgICAgcmVzb2x2ZShfdGFyZ2V0LnRvRGF0YVVSTChvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLnR5cGUsIG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMucXVhbGl0eSkpO1xuICAgICAgICB9IGVsc2UgaWYgKF90YXJnZXQgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50KSB7XG4gICAgICAgICAgY29uc3QgaW1nID0gX3RhcmdldC5jbG9uZU5vZGUoZmFsc2UpO1xuICAgICAgICAgIGltZy5jcm9zc09yaWdpbiA9IFwiQW5vbnltb3VzXCI7XG4gICAgICAgICAgaW1nTG9hZGVkKGltZykudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xuICAgICAgICAgICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcbiAgICAgICAgICAgIGNhbnZhcy53aWR0aCA9IGltZy53aWR0aDtcbiAgICAgICAgICAgIGNhbnZhcy5oZWlnaHQgPSBpbWcuaGVpZ2h0O1xuICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG4gICAgICAgICAgICByZXNvbHZlKGNhbnZhcy50b0RhdGFVUkwob3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy50eXBlLCBvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLnF1YWxpdHkpKTtcbiAgICAgICAgICB9KS5jYXRjaChyZWplY3QpO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBfdGFyZ2V0ID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgY29uc3QgX3NlcmlhbGl6ZUZuID0gKG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuc2VyaWFsaXplcikgfHwgZ2V0RGVmYXVsdFNlcmlhbGl6YXRpb24oX3RhcmdldCk7XG4gICAgICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IF9zZXJpYWxpemVGbihfdGFyZ2V0KTtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShibG9iVG9CYXNlNjQobmV3IEJsb2IoW3NlcmlhbGl6ZWRdLCB7IHR5cGU6IFwiYXBwbGljYXRpb24vanNvblwiIH0pKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihcInRhcmdldCBpcyB1bnN1cHBvcnRlZCB0eXBlc1wiKSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcHJvbWlzZS52YWx1ZS50aGVuKChyZXMpID0+IHtcbiAgICAgIGJhc2U2NC52YWx1ZSA9IChvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLmRhdGFVcmwpID09PSBmYWxzZSA/IHJlcy5yZXBsYWNlKC9eZGF0YTouKj87YmFzZTY0LC8sIFwiXCIpIDogcmVzO1xuICAgIH0pO1xuICAgIHJldHVybiBwcm9taXNlLnZhbHVlO1xuICB9XG4gIGlmIChpc1JlZih0YXJnZXQpIHx8IHR5cGVvZiB0YXJnZXQgPT09IFwiZnVuY3Rpb25cIilcbiAgICB3YXRjaCh0YXJnZXQsIGV4ZWN1dGUsIHsgaW1tZWRpYXRlOiB0cnVlIH0pO1xuICBlbHNlXG4gICAgZXhlY3V0ZSgpO1xuICByZXR1cm4ge1xuICAgIGJhc2U2NCxcbiAgICBwcm9taXNlLFxuICAgIGV4ZWN1dGVcbiAgfTtcbn1cbmZ1bmN0aW9uIGltZ0xvYWRlZChpbWcpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBpZiAoIWltZy5jb21wbGV0ZSkge1xuICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfTtcbiAgICAgIGltZy5vbmVycm9yID0gcmVqZWN0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfVxuICB9KTtcbn1cbmZ1bmN0aW9uIGJsb2JUb0Jhc2U2NChibG9iKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgZnIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgIGZyLm9ubG9hZCA9IChlKSA9PiB7XG4gICAgICByZXNvbHZlKGUudGFyZ2V0LnJlc3VsdCk7XG4gICAgfTtcbiAgICBmci5vbmVycm9yID0gcmVqZWN0O1xuICAgIGZyLnJlYWRBc0RhdGFVUkwoYmxvYik7XG4gIH0pO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlQmF0dGVyeShvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyBuYXZpZ2F0b3IgPSBkZWZhdWx0TmF2aWdhdG9yIH0gPSBvcHRpb25zO1xuICBjb25zdCBldmVudHMgPSBbXCJjaGFyZ2luZ2NoYW5nZVwiLCBcImNoYXJnaW5ndGltZWNoYW5nZVwiLCBcImRpc2NoYXJnaW5ndGltZWNoYW5nZVwiLCBcImxldmVsY2hhbmdlXCJdO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiBuYXZpZ2F0b3IgJiYgXCJnZXRCYXR0ZXJ5XCIgaW4gbmF2aWdhdG9yICYmIHR5cGVvZiBuYXZpZ2F0b3IuZ2V0QmF0dGVyeSA9PT0gXCJmdW5jdGlvblwiKTtcbiAgY29uc3QgY2hhcmdpbmcgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgY2hhcmdpbmdUaW1lID0gc2hhbGxvd1JlZigwKTtcbiAgY29uc3QgZGlzY2hhcmdpbmdUaW1lID0gc2hhbGxvd1JlZigwKTtcbiAgY29uc3QgbGV2ZWwgPSBzaGFsbG93UmVmKDEpO1xuICBsZXQgYmF0dGVyeTtcbiAgZnVuY3Rpb24gdXBkYXRlQmF0dGVyeUluZm8oKSB7XG4gICAgY2hhcmdpbmcudmFsdWUgPSB0aGlzLmNoYXJnaW5nO1xuICAgIGNoYXJnaW5nVGltZS52YWx1ZSA9IHRoaXMuY2hhcmdpbmdUaW1lIHx8IDA7XG4gICAgZGlzY2hhcmdpbmdUaW1lLnZhbHVlID0gdGhpcy5kaXNjaGFyZ2luZ1RpbWUgfHwgMDtcbiAgICBsZXZlbC52YWx1ZSA9IHRoaXMubGV2ZWw7XG4gIH1cbiAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlKSB7XG4gICAgbmF2aWdhdG9yLmdldEJhdHRlcnkoKS50aGVuKChfYmF0dGVyeSkgPT4ge1xuICAgICAgYmF0dGVyeSA9IF9iYXR0ZXJ5O1xuICAgICAgdXBkYXRlQmF0dGVyeUluZm8uY2FsbChiYXR0ZXJ5KTtcbiAgICAgIHVzZUV2ZW50TGlzdGVuZXIoYmF0dGVyeSwgZXZlbnRzLCB1cGRhdGVCYXR0ZXJ5SW5mbywgeyBwYXNzaXZlOiB0cnVlIH0pO1xuICAgIH0pO1xuICB9XG4gIHJldHVybiB7XG4gICAgaXNTdXBwb3J0ZWQsXG4gICAgY2hhcmdpbmcsXG4gICAgY2hhcmdpbmdUaW1lLFxuICAgIGRpc2NoYXJnaW5nVGltZSxcbiAgICBsZXZlbFxuICB9O1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlQmx1ZXRvb3RoKG9wdGlvbnMpIHtcbiAgbGV0IHtcbiAgICBhY2NlcHRBbGxEZXZpY2VzID0gZmFsc2VcbiAgfSA9IG9wdGlvbnMgfHwge307XG4gIGNvbnN0IHtcbiAgICBmaWx0ZXJzID0gdm9pZCAwLFxuICAgIG9wdGlvbmFsU2VydmljZXMgPSB2b2lkIDAsXG4gICAgbmF2aWdhdG9yID0gZGVmYXVsdE5hdmlnYXRvclxuICB9ID0gb3B0aW9ucyB8fCB7fTtcbiAgY29uc3QgaXNTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gbmF2aWdhdG9yICYmIFwiYmx1ZXRvb3RoXCIgaW4gbmF2aWdhdG9yKTtcbiAgY29uc3QgZGV2aWNlID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCBlcnJvciA9IHNoYWxsb3dSZWYobnVsbCk7XG4gIHdhdGNoKGRldmljZSwgKCkgPT4ge1xuICAgIGNvbm5lY3RUb0JsdWV0b290aEdBVFRTZXJ2ZXIoKTtcbiAgfSk7XG4gIGFzeW5jIGZ1bmN0aW9uIHJlcXVlc3REZXZpY2UoKSB7XG4gICAgaWYgKCFpc1N1cHBvcnRlZC52YWx1ZSlcbiAgICAgIHJldHVybjtcbiAgICBlcnJvci52YWx1ZSA9IG51bGw7XG4gICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPiAwKVxuICAgICAgYWNjZXB0QWxsRGV2aWNlcyA9IGZhbHNlO1xuICAgIHRyeSB7XG4gICAgICBkZXZpY2UudmFsdWUgPSBhd2FpdCAobmF2aWdhdG9yID09IG51bGwgPyB2b2lkIDAgOiBuYXZpZ2F0b3IuYmx1ZXRvb3RoLnJlcXVlc3REZXZpY2Uoe1xuICAgICAgICBhY2NlcHRBbGxEZXZpY2VzLFxuICAgICAgICBmaWx0ZXJzLFxuICAgICAgICBvcHRpb25hbFNlcnZpY2VzXG4gICAgICB9KSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBlcnJvci52YWx1ZSA9IGVycjtcbiAgICB9XG4gIH1cbiAgY29uc3Qgc2VydmVyID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCBpc0Nvbm5lY3RlZCA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBmdW5jdGlvbiByZXNldCgpIHtcbiAgICBpc0Nvbm5lY3RlZC52YWx1ZSA9IGZhbHNlO1xuICAgIGRldmljZS52YWx1ZSA9IHZvaWQgMDtcbiAgICBzZXJ2ZXIudmFsdWUgPSB2b2lkIDA7XG4gIH1cbiAgYXN5bmMgZnVuY3Rpb24gY29ubmVjdFRvQmx1ZXRvb3RoR0FUVFNlcnZlcigpIHtcbiAgICBlcnJvci52YWx1ZSA9IG51bGw7XG4gICAgaWYgKGRldmljZS52YWx1ZSAmJiBkZXZpY2UudmFsdWUuZ2F0dCkge1xuICAgICAgdXNlRXZlbnRMaXN0ZW5lcihkZXZpY2UsIFwiZ2F0dHNlcnZlcmRpc2Nvbm5lY3RlZFwiLCByZXNldCwgeyBwYXNzaXZlOiB0cnVlIH0pO1xuICAgICAgdHJ5IHtcbiAgICAgICAgc2VydmVyLnZhbHVlID0gYXdhaXQgZGV2aWNlLnZhbHVlLmdhdHQuY29ubmVjdCgpO1xuICAgICAgICBpc0Nvbm5lY3RlZC52YWx1ZSA9IHNlcnZlci52YWx1ZS5jb25uZWN0ZWQ7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgZXJyb3IudmFsdWUgPSBlcnI7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHRyeU9uTW91bnRlZCgoKSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIGlmIChkZXZpY2UudmFsdWUpXG4gICAgICAoX2EgPSBkZXZpY2UudmFsdWUuZ2F0dCkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmNvbm5lY3QoKTtcbiAgfSk7XG4gIHRyeU9uU2NvcGVEaXNwb3NlKCgpID0+IHtcbiAgICB2YXIgX2E7XG4gICAgaWYgKGRldmljZS52YWx1ZSlcbiAgICAgIChfYSA9IGRldmljZS52YWx1ZS5nYXR0KSA9PSBudWxsID8gdm9pZCAwIDogX2EuZGlzY29ubmVjdCgpO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBpc0Nvbm5lY3RlZDogcmVhZG9ubHkoaXNDb25uZWN0ZWQpLFxuICAgIC8vIERldmljZTpcbiAgICBkZXZpY2UsXG4gICAgcmVxdWVzdERldmljZSxcbiAgICAvLyBTZXJ2ZXI6XG4gICAgc2VydmVyLFxuICAgIC8vIEVycm9yczpcbiAgICBlcnJvclxuICB9O1xufVxuXG5jb25zdCBzc3JXaWR0aFN5bWJvbCA9IFN5bWJvbChcInZ1ZXVzZS1zc3Itd2lkdGhcIik7XG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlU1NSV2lkdGgoKSB7XG4gIGNvbnN0IHNzcldpZHRoID0gaGFzSW5qZWN0aW9uQ29udGV4dCgpID8gaW5qZWN0TG9jYWwoc3NyV2lkdGhTeW1ib2wsIG51bGwpIDogbnVsbDtcbiAgcmV0dXJuIHR5cGVvZiBzc3JXaWR0aCA9PT0gXCJudW1iZXJcIiA/IHNzcldpZHRoIDogdm9pZCAwO1xufVxuZnVuY3Rpb24gcHJvdmlkZVNTUldpZHRoKHdpZHRoLCBhcHApIHtcbiAgaWYgKGFwcCAhPT0gdm9pZCAwKSB7XG4gICAgYXBwLnByb3ZpZGUoc3NyV2lkdGhTeW1ib2wsIHdpZHRoKTtcbiAgfSBlbHNlIHtcbiAgICBwcm92aWRlTG9jYWwoc3NyV2lkdGhTeW1ib2wsIHdpZHRoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB1c2VNZWRpYVF1ZXJ5KHF1ZXJ5LCBvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyB3aW5kb3cgPSBkZWZhdWx0V2luZG93LCBzc3JXaWR0aCA9IHVzZVNTUldpZHRoKCkgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHdpbmRvdyAmJiBcIm1hdGNoTWVkaWFcIiBpbiB3aW5kb3cgJiYgdHlwZW9mIHdpbmRvdy5tYXRjaE1lZGlhID09PSBcImZ1bmN0aW9uXCIpO1xuICBjb25zdCBzc3JTdXBwb3J0ID0gc2hhbGxvd1JlZih0eXBlb2Ygc3NyV2lkdGggPT09IFwibnVtYmVyXCIpO1xuICBjb25zdCBtZWRpYVF1ZXJ5ID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCBtYXRjaGVzID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IGhhbmRsZXIgPSAoZXZlbnQpID0+IHtcbiAgICBtYXRjaGVzLnZhbHVlID0gZXZlbnQubWF0Y2hlcztcbiAgfTtcbiAgd2F0Y2hFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChzc3JTdXBwb3J0LnZhbHVlKSB7XG4gICAgICBzc3JTdXBwb3J0LnZhbHVlID0gIWlzU3VwcG9ydGVkLnZhbHVlO1xuICAgICAgY29uc3QgcXVlcnlTdHJpbmdzID0gdG9WYWx1ZShxdWVyeSkuc3BsaXQoXCIsXCIpO1xuICAgICAgbWF0Y2hlcy52YWx1ZSA9IHF1ZXJ5U3RyaW5ncy5zb21lKChxdWVyeVN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBub3QgPSBxdWVyeVN0cmluZy5pbmNsdWRlcyhcIm5vdCBhbGxcIik7XG4gICAgICAgIGNvbnN0IG1pbldpZHRoID0gcXVlcnlTdHJpbmcubWF0Y2goL1xcKFxccyptaW4td2lkdGg6XFxzKigtP1xcZCsoPzpcXC5cXGQqKT9bYS16XStcXHMqKVxcKS8pO1xuICAgICAgICBjb25zdCBtYXhXaWR0aCA9IHF1ZXJ5U3RyaW5nLm1hdGNoKC9cXChcXHMqbWF4LXdpZHRoOlxccyooLT9cXGQrKD86XFwuXFxkKik/W2Etel0rXFxzKilcXCkvKTtcbiAgICAgICAgbGV0IHJlcyA9IEJvb2xlYW4obWluV2lkdGggfHwgbWF4V2lkdGgpO1xuICAgICAgICBpZiAobWluV2lkdGggJiYgcmVzKSB7XG4gICAgICAgICAgcmVzID0gc3NyV2lkdGggPj0gcHhWYWx1ZShtaW5XaWR0aFsxXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1heFdpZHRoICYmIHJlcykge1xuICAgICAgICAgIHJlcyA9IHNzcldpZHRoIDw9IHB4VmFsdWUobWF4V2lkdGhbMV0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBub3QgPyAhcmVzIDogcmVzO1xuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghaXNTdXBwb3J0ZWQudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgbWVkaWFRdWVyeS52YWx1ZSA9IHdpbmRvdy5tYXRjaE1lZGlhKHRvVmFsdWUocXVlcnkpKTtcbiAgICBtYXRjaGVzLnZhbHVlID0gbWVkaWFRdWVyeS52YWx1ZS5tYXRjaGVzO1xuICB9KTtcbiAgdXNlRXZlbnRMaXN0ZW5lcihtZWRpYVF1ZXJ5LCBcImNoYW5nZVwiLCBoYW5kbGVyLCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gIHJldHVybiBjb21wdXRlZCgoKSA9PiBtYXRjaGVzLnZhbHVlKTtcbn1cblxuY29uc3QgYnJlYWtwb2ludHNUYWlsd2luZCA9IHtcbiAgXCJzbVwiOiA2NDAsXG4gIFwibWRcIjogNzY4LFxuICBcImxnXCI6IDEwMjQsXG4gIFwieGxcIjogMTI4MCxcbiAgXCIyeGxcIjogMTUzNlxufTtcbmNvbnN0IGJyZWFrcG9pbnRzQm9vdHN0cmFwVjUgPSB7XG4gIHhzOiAwLFxuICBzbTogNTc2LFxuICBtZDogNzY4LFxuICBsZzogOTkyLFxuICB4bDogMTIwMCxcbiAgeHhsOiAxNDAwXG59O1xuY29uc3QgYnJlYWtwb2ludHNWdWV0aWZ5VjIgPSB7XG4gIHhzOiAwLFxuICBzbTogNjAwLFxuICBtZDogOTYwLFxuICBsZzogMTI2NCxcbiAgeGw6IDE5MDRcbn07XG5jb25zdCBicmVha3BvaW50c1Z1ZXRpZnlWMyA9IHtcbiAgeHM6IDAsXG4gIHNtOiA2MDAsXG4gIG1kOiA5NjAsXG4gIGxnOiAxMjgwLFxuICB4bDogMTkyMCxcbiAgeHhsOiAyNTYwXG59O1xuY29uc3QgYnJlYWtwb2ludHNWdWV0aWZ5ID0gYnJlYWtwb2ludHNWdWV0aWZ5VjI7XG5jb25zdCBicmVha3BvaW50c0FudERlc2lnbiA9IHtcbiAgeHM6IDQ4MCxcbiAgc206IDU3NixcbiAgbWQ6IDc2OCxcbiAgbGc6IDk5MixcbiAgeGw6IDEyMDAsXG4gIHh4bDogMTYwMFxufTtcbmNvbnN0IGJyZWFrcG9pbnRzUXVhc2FyID0ge1xuICB4czogMCxcbiAgc206IDYwMCxcbiAgbWQ6IDEwMjQsXG4gIGxnOiAxNDQwLFxuICB4bDogMTkyMFxufTtcbmNvbnN0IGJyZWFrcG9pbnRzU2VtYXRpYyA9IHtcbiAgbW9iaWxlUzogMzIwLFxuICBtb2JpbGVNOiAzNzUsXG4gIG1vYmlsZUw6IDQyNSxcbiAgdGFibGV0OiA3NjgsXG4gIGxhcHRvcDogMTAyNCxcbiAgbGFwdG9wTDogMTQ0MCxcbiAgZGVza3RvcDRLOiAyNTYwXG59O1xuY29uc3QgYnJlYWtwb2ludHNNYXN0ZXJDc3MgPSB7XG4gIFwiM3hzXCI6IDM2MCxcbiAgXCIyeHNcIjogNDgwLFxuICBcInhzXCI6IDYwMCxcbiAgXCJzbVwiOiA3NjgsXG4gIFwibWRcIjogMTAyNCxcbiAgXCJsZ1wiOiAxMjgwLFxuICBcInhsXCI6IDE0NDAsXG4gIFwiMnhsXCI6IDE2MDAsXG4gIFwiM3hsXCI6IDE5MjAsXG4gIFwiNHhsXCI6IDI1NjBcbn07XG5jb25zdCBicmVha3BvaW50c1ByaW1lRmxleCA9IHtcbiAgc206IDU3NixcbiAgbWQ6IDc2OCxcbiAgbGc6IDk5MixcbiAgeGw6IDEyMDBcbn07XG5jb25zdCBicmVha3BvaW50c0VsZW1lbnQgPSB7XG4gIHhzOiAwLFxuICBzbTogNzY4LFxuICBtZDogOTkyLFxuICBsZzogMTIwMCxcbiAgeGw6IDE5MjBcbn07XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VCcmVha3BvaW50cyhicmVha3BvaW50cywgb3B0aW9ucyA9IHt9KSB7XG4gIGZ1bmN0aW9uIGdldFZhbHVlKGssIGRlbHRhKSB7XG4gICAgbGV0IHYgPSB0b1ZhbHVlKGJyZWFrcG9pbnRzW3RvVmFsdWUoayldKTtcbiAgICBpZiAoZGVsdGEgIT0gbnVsbClcbiAgICAgIHYgPSBpbmNyZWFzZVdpdGhVbml0KHYsIGRlbHRhKTtcbiAgICBpZiAodHlwZW9mIHYgPT09IFwibnVtYmVyXCIpXG4gICAgICB2ID0gYCR7dn1weGA7XG4gICAgcmV0dXJuIHY7XG4gIH1cbiAgY29uc3QgeyB3aW5kb3cgPSBkZWZhdWx0V2luZG93LCBzdHJhdGVneSA9IFwibWluLXdpZHRoXCIsIHNzcldpZHRoID0gdXNlU1NSV2lkdGgoKSB9ID0gb3B0aW9ucztcbiAgY29uc3Qgc3NyU3VwcG9ydCA9IHR5cGVvZiBzc3JXaWR0aCA9PT0gXCJudW1iZXJcIjtcbiAgY29uc3QgbW91bnRlZCA9IHNzclN1cHBvcnQgPyBzaGFsbG93UmVmKGZhbHNlKSA6IHsgdmFsdWU6IHRydWUgfTtcbiAgaWYgKHNzclN1cHBvcnQpIHtcbiAgICB0cnlPbk1vdW50ZWQoKCkgPT4gbW91bnRlZC52YWx1ZSA9ICEhd2luZG93KTtcbiAgfVxuICBmdW5jdGlvbiBtYXRjaChxdWVyeSwgc2l6ZSkge1xuICAgIGlmICghbW91bnRlZC52YWx1ZSAmJiBzc3JTdXBwb3J0KSB7XG4gICAgICByZXR1cm4gcXVlcnkgPT09IFwibWluXCIgPyBzc3JXaWR0aCA+PSBweFZhbHVlKHNpemUpIDogc3NyV2lkdGggPD0gcHhWYWx1ZShzaXplKTtcbiAgICB9XG4gICAgaWYgKCF3aW5kb3cpXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgcmV0dXJuIHdpbmRvdy5tYXRjaE1lZGlhKGAoJHtxdWVyeX0td2lkdGg6ICR7c2l6ZX0pYCkubWF0Y2hlcztcbiAgfVxuICBjb25zdCBncmVhdGVyT3JFcXVhbCA9IChrKSA9PiB7XG4gICAgcmV0dXJuIHVzZU1lZGlhUXVlcnkoKCkgPT4gYChtaW4td2lkdGg6ICR7Z2V0VmFsdWUoayl9KWAsIG9wdGlvbnMpO1xuICB9O1xuICBjb25zdCBzbWFsbGVyT3JFcXVhbCA9IChrKSA9PiB7XG4gICAgcmV0dXJuIHVzZU1lZGlhUXVlcnkoKCkgPT4gYChtYXgtd2lkdGg6ICR7Z2V0VmFsdWUoayl9KWAsIG9wdGlvbnMpO1xuICB9O1xuICBjb25zdCBzaG9ydGN1dE1ldGhvZHMgPSBPYmplY3Qua2V5cyhicmVha3BvaW50cykucmVkdWNlKChzaG9ydGN1dHMsIGspID0+IHtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc2hvcnRjdXRzLCBrLCB7XG4gICAgICBnZXQ6ICgpID0+IHN0cmF0ZWd5ID09PSBcIm1pbi13aWR0aFwiID8gZ3JlYXRlck9yRXF1YWwoaykgOiBzbWFsbGVyT3JFcXVhbChrKSxcbiAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICBjb25maWd1cmFibGU6IHRydWVcbiAgICB9KTtcbiAgICByZXR1cm4gc2hvcnRjdXRzO1xuICB9LCB7fSk7XG4gIGZ1bmN0aW9uIGN1cnJlbnQoKSB7XG4gICAgY29uc3QgcG9pbnRzID0gT2JqZWN0LmtleXMoYnJlYWtwb2ludHMpLm1hcCgoaykgPT4gW2ssIHNob3J0Y3V0TWV0aG9kc1trXSwgcHhWYWx1ZShnZXRWYWx1ZShrKSldKS5zb3J0KChhLCBiKSA9PiBhWzJdIC0gYlsyXSk7XG4gICAgcmV0dXJuIGNvbXB1dGVkKCgpID0+IHBvaW50cy5maWx0ZXIoKFssIHZdKSA9PiB2LnZhbHVlKS5tYXAoKFtrXSkgPT4gaykpO1xuICB9XG4gIHJldHVybiBPYmplY3QuYXNzaWduKHNob3J0Y3V0TWV0aG9kcywge1xuICAgIGdyZWF0ZXJPckVxdWFsLFxuICAgIHNtYWxsZXJPckVxdWFsLFxuICAgIGdyZWF0ZXIoaykge1xuICAgICAgcmV0dXJuIHVzZU1lZGlhUXVlcnkoKCkgPT4gYChtaW4td2lkdGg6ICR7Z2V0VmFsdWUoaywgMC4xKX0pYCwgb3B0aW9ucyk7XG4gICAgfSxcbiAgICBzbWFsbGVyKGspIHtcbiAgICAgIHJldHVybiB1c2VNZWRpYVF1ZXJ5KCgpID0+IGAobWF4LXdpZHRoOiAke2dldFZhbHVlKGssIC0wLjEpfSlgLCBvcHRpb25zKTtcbiAgICB9LFxuICAgIGJldHdlZW4oYSwgYikge1xuICAgICAgcmV0dXJuIHVzZU1lZGlhUXVlcnkoKCkgPT4gYChtaW4td2lkdGg6ICR7Z2V0VmFsdWUoYSl9KSBhbmQgKG1heC13aWR0aDogJHtnZXRWYWx1ZShiLCAtMC4xKX0pYCwgb3B0aW9ucyk7XG4gICAgfSxcbiAgICBpc0dyZWF0ZXIoaykge1xuICAgICAgcmV0dXJuIG1hdGNoKFwibWluXCIsIGdldFZhbHVlKGssIDAuMSkpO1xuICAgIH0sXG4gICAgaXNHcmVhdGVyT3JFcXVhbChrKSB7XG4gICAgICByZXR1cm4gbWF0Y2goXCJtaW5cIiwgZ2V0VmFsdWUoaykpO1xuICAgIH0sXG4gICAgaXNTbWFsbGVyKGspIHtcbiAgICAgIHJldHVybiBtYXRjaChcIm1heFwiLCBnZXRWYWx1ZShrLCAtMC4xKSk7XG4gICAgfSxcbiAgICBpc1NtYWxsZXJPckVxdWFsKGspIHtcbiAgICAgIHJldHVybiBtYXRjaChcIm1heFwiLCBnZXRWYWx1ZShrKSk7XG4gICAgfSxcbiAgICBpc0luQmV0d2VlbihhLCBiKSB7XG4gICAgICByZXR1cm4gbWF0Y2goXCJtaW5cIiwgZ2V0VmFsdWUoYSkpICYmIG1hdGNoKFwibWF4XCIsIGdldFZhbHVlKGIsIC0wLjEpKTtcbiAgICB9LFxuICAgIGN1cnJlbnQsXG4gICAgYWN0aXZlKCkge1xuICAgICAgY29uc3QgYnBzID0gY3VycmVudCgpO1xuICAgICAgcmV0dXJuIGNvbXB1dGVkKCgpID0+IGJwcy52YWx1ZS5sZW5ndGggPT09IDAgPyBcIlwiIDogYnBzLnZhbHVlLmF0KHN0cmF0ZWd5ID09PSBcIm1pbi13aWR0aFwiID8gLTEgOiAwKSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gdXNlQnJvYWRjYXN0Q2hhbm5lbChvcHRpb25zKSB7XG4gIGNvbnN0IHtcbiAgICBuYW1lLFxuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3dcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHdpbmRvdyAmJiBcIkJyb2FkY2FzdENoYW5uZWxcIiBpbiB3aW5kb3cpO1xuICBjb25zdCBpc0Nsb3NlZCA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBjaGFubmVsID0gcmVmKCk7XG4gIGNvbnN0IGRhdGEgPSByZWYoKTtcbiAgY29uc3QgZXJyb3IgPSBzaGFsbG93UmVmKG51bGwpO1xuICBjb25zdCBwb3N0ID0gKGRhdGEyKSA9PiB7XG4gICAgaWYgKGNoYW5uZWwudmFsdWUpXG4gICAgICBjaGFubmVsLnZhbHVlLnBvc3RNZXNzYWdlKGRhdGEyKTtcbiAgfTtcbiAgY29uc3QgY2xvc2UgPSAoKSA9PiB7XG4gICAgaWYgKGNoYW5uZWwudmFsdWUpXG4gICAgICBjaGFubmVsLnZhbHVlLmNsb3NlKCk7XG4gICAgaXNDbG9zZWQudmFsdWUgPSB0cnVlO1xuICB9O1xuICBpZiAoaXNTdXBwb3J0ZWQudmFsdWUpIHtcbiAgICB0cnlPbk1vdW50ZWQoKCkgPT4ge1xuICAgICAgZXJyb3IudmFsdWUgPSBudWxsO1xuICAgICAgY2hhbm5lbC52YWx1ZSA9IG5ldyBCcm9hZGNhc3RDaGFubmVsKG5hbWUpO1xuICAgICAgY29uc3QgbGlzdGVuZXJPcHRpb25zID0ge1xuICAgICAgICBwYXNzaXZlOiB0cnVlXG4gICAgICB9O1xuICAgICAgdXNlRXZlbnRMaXN0ZW5lcihjaGFubmVsLCBcIm1lc3NhZ2VcIiwgKGUpID0+IHtcbiAgICAgICAgZGF0YS52YWx1ZSA9IGUuZGF0YTtcbiAgICAgIH0sIGxpc3RlbmVyT3B0aW9ucyk7XG4gICAgICB1c2VFdmVudExpc3RlbmVyKGNoYW5uZWwsIFwibWVzc2FnZWVycm9yXCIsIChlKSA9PiB7XG4gICAgICAgIGVycm9yLnZhbHVlID0gZTtcbiAgICAgIH0sIGxpc3RlbmVyT3B0aW9ucyk7XG4gICAgICB1c2VFdmVudExpc3RlbmVyKGNoYW5uZWwsIFwiY2xvc2VcIiwgKCkgPT4ge1xuICAgICAgICBpc0Nsb3NlZC52YWx1ZSA9IHRydWU7XG4gICAgICB9LCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgIH0pO1xuICB9XG4gIHRyeU9uU2NvcGVEaXNwb3NlKCgpID0+IHtcbiAgICBjbG9zZSgpO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBjaGFubmVsLFxuICAgIGRhdGEsXG4gICAgcG9zdCxcbiAgICBjbG9zZSxcbiAgICBlcnJvcixcbiAgICBpc0Nsb3NlZFxuICB9O1xufVxuXG5jb25zdCBXUklUQUJMRV9QUk9QRVJUSUVTID0gW1xuICBcImhhc2hcIixcbiAgXCJob3N0XCIsXG4gIFwiaG9zdG5hbWVcIixcbiAgXCJocmVmXCIsXG4gIFwicGF0aG5hbWVcIixcbiAgXCJwb3J0XCIsXG4gIFwicHJvdG9jb2xcIixcbiAgXCJzZWFyY2hcIlxuXTtcbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VCcm93c2VyTG9jYXRpb24ob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgd2luZG93ID0gZGVmYXVsdFdpbmRvdyB9ID0gb3B0aW9ucztcbiAgY29uc3QgcmVmcyA9IE9iamVjdC5mcm9tRW50cmllcyhcbiAgICBXUklUQUJMRV9QUk9QRVJUSUVTLm1hcCgoa2V5KSA9PiBba2V5LCByZWYoKV0pXG4gICk7XG4gIGZvciAoY29uc3QgW2tleSwgcmVmXSBvZiBvYmplY3RFbnRyaWVzKHJlZnMpKSB7XG4gICAgd2F0Y2gocmVmLCAodmFsdWUpID0+IHtcbiAgICAgIGlmICghKHdpbmRvdyA9PSBudWxsID8gdm9pZCAwIDogd2luZG93LmxvY2F0aW9uKSB8fCB3aW5kb3cubG9jYXRpb25ba2V5XSA9PT0gdmFsdWUpXG4gICAgICAgIHJldHVybjtcbiAgICAgIHdpbmRvdy5sb2NhdGlvbltrZXldID0gdmFsdWU7XG4gICAgfSk7XG4gIH1cbiAgY29uc3QgYnVpbGRTdGF0ZSA9ICh0cmlnZ2VyKSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIGNvbnN0IHsgc3RhdGU6IHN0YXRlMiwgbGVuZ3RoIH0gPSAod2luZG93ID09IG51bGwgPyB2b2lkIDAgOiB3aW5kb3cuaGlzdG9yeSkgfHwge307XG4gICAgY29uc3QgeyBvcmlnaW4gfSA9ICh3aW5kb3cgPT0gbnVsbCA/IHZvaWQgMCA6IHdpbmRvdy5sb2NhdGlvbikgfHwge307XG4gICAgZm9yIChjb25zdCBrZXkgb2YgV1JJVEFCTEVfUFJPUEVSVElFUylcbiAgICAgIHJlZnNba2V5XS52YWx1ZSA9IChfYSA9IHdpbmRvdyA9PSBudWxsID8gdm9pZCAwIDogd2luZG93LmxvY2F0aW9uKSA9PSBudWxsID8gdm9pZCAwIDogX2Fba2V5XTtcbiAgICByZXR1cm4gcmVhY3RpdmUoe1xuICAgICAgdHJpZ2dlcixcbiAgICAgIHN0YXRlOiBzdGF0ZTIsXG4gICAgICBsZW5ndGgsXG4gICAgICBvcmlnaW4sXG4gICAgICAuLi5yZWZzXG4gICAgfSk7XG4gIH07XG4gIGNvbnN0IHN0YXRlID0gcmVmKGJ1aWxkU3RhdGUoXCJsb2FkXCIpKTtcbiAgaWYgKHdpbmRvdykge1xuICAgIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHsgcGFzc2l2ZTogdHJ1ZSB9O1xuICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcInBvcHN0YXRlXCIsICgpID0+IHN0YXRlLnZhbHVlID0gYnVpbGRTdGF0ZShcInBvcHN0YXRlXCIpLCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcImhhc2hjaGFuZ2VcIiwgKCkgPT4gc3RhdGUudmFsdWUgPSBidWlsZFN0YXRlKFwiaGFzaGNoYW5nZVwiKSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgfVxuICByZXR1cm4gc3RhdGU7XG59XG5cbmZ1bmN0aW9uIHVzZUNhY2hlZChyZWZWYWx1ZSwgY29tcGFyYXRvciA9IChhLCBiKSA9PiBhID09PSBiLCBvcHRpb25zKSB7XG4gIGNvbnN0IHsgZGVlcFJlZnMgPSB0cnVlLCAuLi53YXRjaE9wdGlvbnMgfSA9IG9wdGlvbnMgfHwge307XG4gIGNvbnN0IGNhY2hlZFZhbHVlID0gY3JlYXRlUmVmKHJlZlZhbHVlLnZhbHVlLCBkZWVwUmVmcyk7XG4gIHdhdGNoKCgpID0+IHJlZlZhbHVlLnZhbHVlLCAodmFsdWUpID0+IHtcbiAgICBpZiAoIWNvbXBhcmF0b3IodmFsdWUsIGNhY2hlZFZhbHVlLnZhbHVlKSlcbiAgICAgIGNhY2hlZFZhbHVlLnZhbHVlID0gdmFsdWU7XG4gIH0sIHdhdGNoT3B0aW9ucyk7XG4gIHJldHVybiBjYWNoZWRWYWx1ZTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZVBlcm1pc3Npb24ocGVybWlzc2lvbkRlc2MsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgY29udHJvbHMgPSBmYWxzZSxcbiAgICBuYXZpZ2F0b3IgPSBkZWZhdWx0TmF2aWdhdG9yXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiBuYXZpZ2F0b3IgJiYgXCJwZXJtaXNzaW9uc1wiIGluIG5hdmlnYXRvcik7XG4gIGNvbnN0IHBlcm1pc3Npb25TdGF0dXMgPSBzaGFsbG93UmVmKCk7XG4gIGNvbnN0IGRlc2MgPSB0eXBlb2YgcGVybWlzc2lvbkRlc2MgPT09IFwic3RyaW5nXCIgPyB7IG5hbWU6IHBlcm1pc3Npb25EZXNjIH0gOiBwZXJtaXNzaW9uRGVzYztcbiAgY29uc3Qgc3RhdGUgPSBzaGFsbG93UmVmKCk7XG4gIGNvbnN0IHVwZGF0ZSA9ICgpID0+IHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIHN0YXRlLnZhbHVlID0gKF9iID0gKF9hID0gcGVybWlzc2lvblN0YXR1cy52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnN0YXRlKSAhPSBudWxsID8gX2IgOiBcInByb21wdFwiO1xuICB9O1xuICB1c2VFdmVudExpc3RlbmVyKHBlcm1pc3Npb25TdGF0dXMsIFwiY2hhbmdlXCIsIHVwZGF0ZSwgeyBwYXNzaXZlOiB0cnVlIH0pO1xuICBjb25zdCBxdWVyeSA9IGNyZWF0ZVNpbmdsZXRvblByb21pc2UoYXN5bmMgKCkgPT4ge1xuICAgIGlmICghaXNTdXBwb3J0ZWQudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgaWYgKCFwZXJtaXNzaW9uU3RhdHVzLnZhbHVlKSB7XG4gICAgICB0cnkge1xuICAgICAgICBwZXJtaXNzaW9uU3RhdHVzLnZhbHVlID0gYXdhaXQgbmF2aWdhdG9yLnBlcm1pc3Npb25zLnF1ZXJ5KGRlc2MpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBwZXJtaXNzaW9uU3RhdHVzLnZhbHVlID0gdm9pZCAwO1xuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgdXBkYXRlKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChjb250cm9scylcbiAgICAgIHJldHVybiB0b1JhdyhwZXJtaXNzaW9uU3RhdHVzLnZhbHVlKTtcbiAgfSk7XG4gIHF1ZXJ5KCk7XG4gIGlmIChjb250cm9scykge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0ZSxcbiAgICAgIGlzU3VwcG9ydGVkLFxuICAgICAgcXVlcnlcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBzdGF0ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiB1c2VDbGlwYm9hcmQob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBuYXZpZ2F0b3IgPSBkZWZhdWx0TmF2aWdhdG9yLFxuICAgIHJlYWQgPSBmYWxzZSxcbiAgICBzb3VyY2UsXG4gICAgY29waWVkRHVyaW5nID0gMTUwMCxcbiAgICBsZWdhY3kgPSBmYWxzZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgaXNDbGlwYm9hcmRBcGlTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gbmF2aWdhdG9yICYmIFwiY2xpcGJvYXJkXCIgaW4gbmF2aWdhdG9yKTtcbiAgY29uc3QgcGVybWlzc2lvblJlYWQgPSB1c2VQZXJtaXNzaW9uKFwiY2xpcGJvYXJkLXJlYWRcIik7XG4gIGNvbnN0IHBlcm1pc3Npb25Xcml0ZSA9IHVzZVBlcm1pc3Npb24oXCJjbGlwYm9hcmQtd3JpdGVcIik7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gY29tcHV0ZWQoKCkgPT4gaXNDbGlwYm9hcmRBcGlTdXBwb3J0ZWQudmFsdWUgfHwgbGVnYWN5KTtcbiAgY29uc3QgdGV4dCA9IHNoYWxsb3dSZWYoXCJcIik7XG4gIGNvbnN0IGNvcGllZCA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCB0aW1lb3V0ID0gdXNlVGltZW91dEZuKCgpID0+IGNvcGllZC52YWx1ZSA9IGZhbHNlLCBjb3BpZWREdXJpbmcsIHsgaW1tZWRpYXRlOiBmYWxzZSB9KTtcbiAgYXN5bmMgZnVuY3Rpb24gdXBkYXRlVGV4dCgpIHtcbiAgICBsZXQgdXNlTGVnYWN5ID0gIShpc0NsaXBib2FyZEFwaVN1cHBvcnRlZC52YWx1ZSAmJiBpc0FsbG93ZWQocGVybWlzc2lvblJlYWQudmFsdWUpKTtcbiAgICBpZiAoIXVzZUxlZ2FjeSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGV4dC52YWx1ZSA9IGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQucmVhZFRleHQoKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdXNlTGVnYWN5ID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHVzZUxlZ2FjeSkge1xuICAgICAgdGV4dC52YWx1ZSA9IGxlZ2FjeVJlYWQoKTtcbiAgICB9XG4gIH1cbiAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlICYmIHJlYWQpXG4gICAgdXNlRXZlbnRMaXN0ZW5lcihbXCJjb3B5XCIsIFwiY3V0XCJdLCB1cGRhdGVUZXh0LCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gIGFzeW5jIGZ1bmN0aW9uIGNvcHkodmFsdWUgPSB0b1ZhbHVlKHNvdXJjZSkpIHtcbiAgICBpZiAoaXNTdXBwb3J0ZWQudmFsdWUgJiYgdmFsdWUgIT0gbnVsbCkge1xuICAgICAgbGV0IHVzZUxlZ2FjeSA9ICEoaXNDbGlwYm9hcmRBcGlTdXBwb3J0ZWQudmFsdWUgJiYgaXNBbGxvd2VkKHBlcm1pc3Npb25Xcml0ZS52YWx1ZSkpO1xuICAgICAgaWYgKCF1c2VMZWdhY3kpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh2YWx1ZSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICB1c2VMZWdhY3kgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAodXNlTGVnYWN5KVxuICAgICAgICBsZWdhY3lDb3B5KHZhbHVlKTtcbiAgICAgIHRleHQudmFsdWUgPSB2YWx1ZTtcbiAgICAgIGNvcGllZC52YWx1ZSA9IHRydWU7XG4gICAgICB0aW1lb3V0LnN0YXJ0KCk7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIGxlZ2FjeUNvcHkodmFsdWUpIHtcbiAgICBjb25zdCB0YSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJ0ZXh0YXJlYVwiKTtcbiAgICB0YS52YWx1ZSA9IHZhbHVlICE9IG51bGwgPyB2YWx1ZSA6IFwiXCI7XG4gICAgdGEuc3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XG4gICAgdGEuc3R5bGUub3BhY2l0eSA9IFwiMFwiO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGEpO1xuICAgIHRhLnNlbGVjdCgpO1xuICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKFwiY29weVwiKTtcbiAgICB0YS5yZW1vdmUoKTtcbiAgfVxuICBmdW5jdGlvbiBsZWdhY3lSZWFkKCkge1xuICAgIHZhciBfYSwgX2IsIF9jO1xuICAgIHJldHVybiAoX2MgPSAoX2IgPSAoX2EgPSBkb2N1bWVudCA9PSBudWxsID8gdm9pZCAwIDogZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKSA9PSBudWxsID8gdm9pZCAwIDogX2EuY2FsbChkb2N1bWVudCkpID09IG51bGwgPyB2b2lkIDAgOiBfYi50b1N0cmluZygpKSAhPSBudWxsID8gX2MgOiBcIlwiO1xuICB9XG4gIGZ1bmN0aW9uIGlzQWxsb3dlZChzdGF0dXMpIHtcbiAgICByZXR1cm4gc3RhdHVzID09PSBcImdyYW50ZWRcIiB8fCBzdGF0dXMgPT09IFwicHJvbXB0XCI7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICB0ZXh0LFxuICAgIGNvcGllZCxcbiAgICBjb3B5XG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZUNsaXBib2FyZEl0ZW1zKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgbmF2aWdhdG9yID0gZGVmYXVsdE5hdmlnYXRvcixcbiAgICByZWFkID0gZmFsc2UsXG4gICAgc291cmNlLFxuICAgIGNvcGllZER1cmluZyA9IDE1MDBcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IG5hdmlnYXRvciAmJiBcImNsaXBib2FyZFwiIGluIG5hdmlnYXRvcik7XG4gIGNvbnN0IGNvbnRlbnQgPSByZWYoW10pO1xuICBjb25zdCBjb3BpZWQgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgdGltZW91dCA9IHVzZVRpbWVvdXRGbigoKSA9PiBjb3BpZWQudmFsdWUgPSBmYWxzZSwgY29waWVkRHVyaW5nLCB7IGltbWVkaWF0ZTogZmFsc2UgfSk7XG4gIGZ1bmN0aW9uIHVwZGF0ZUNvbnRlbnQoKSB7XG4gICAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlKSB7XG4gICAgICBuYXZpZ2F0b3IuY2xpcGJvYXJkLnJlYWQoKS50aGVuKChpdGVtcykgPT4ge1xuICAgICAgICBjb250ZW50LnZhbHVlID0gaXRlbXM7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlICYmIHJlYWQpIHtcbiAgICB1c2VFdmVudExpc3RlbmVyKFtcImNvcHlcIiwgXCJjdXRcIl0sIHVwZGF0ZUNvbnRlbnQsIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgfVxuICBhc3luYyBmdW5jdGlvbiBjb3B5KHZhbHVlID0gdG9WYWx1ZShzb3VyY2UpKSB7XG4gICAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlICYmIHZhbHVlICE9IG51bGwpIHtcbiAgICAgIGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGUodmFsdWUpO1xuICAgICAgY29udGVudC52YWx1ZSA9IHZhbHVlO1xuICAgICAgY29waWVkLnZhbHVlID0gdHJ1ZTtcbiAgICAgIHRpbWVvdXQuc3RhcnQoKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBjb250ZW50OiBzaGFsbG93UmVhZG9ubHkoY29udGVudCksXG4gICAgY29waWVkOiByZWFkb25seShjb3BpZWQpLFxuICAgIGNvcHksXG4gICAgcmVhZDogdXBkYXRlQ29udGVudFxuICB9O1xufVxuXG5mdW5jdGlvbiBjbG9uZUZuSlNPTihzb3VyY2UpIHtcbiAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc291cmNlKSk7XG59XG5mdW5jdGlvbiB1c2VDbG9uZWQoc291cmNlLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3QgY2xvbmVkID0gcmVmKHt9KTtcbiAgY29uc3QgaXNNb2RpZmllZCA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBsZXQgX2xhc3RTeW5jID0gZmFsc2U7XG4gIGNvbnN0IHtcbiAgICBtYW51YWwsXG4gICAgY2xvbmUgPSBjbG9uZUZuSlNPTixcbiAgICAvLyB3YXRjaCBvcHRpb25zXG4gICAgZGVlcCA9IHRydWUsXG4gICAgaW1tZWRpYXRlID0gdHJ1ZVxuICB9ID0gb3B0aW9ucztcbiAgd2F0Y2goY2xvbmVkLCAoKSA9PiB7XG4gICAgaWYgKF9sYXN0U3luYykge1xuICAgICAgX2xhc3RTeW5jID0gZmFsc2U7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlzTW9kaWZpZWQudmFsdWUgPSB0cnVlO1xuICB9LCB7XG4gICAgZGVlcDogdHJ1ZSxcbiAgICBmbHVzaDogXCJzeW5jXCJcbiAgfSk7XG4gIGZ1bmN0aW9uIHN5bmMoKSB7XG4gICAgX2xhc3RTeW5jID0gdHJ1ZTtcbiAgICBpc01vZGlmaWVkLnZhbHVlID0gZmFsc2U7XG4gICAgY2xvbmVkLnZhbHVlID0gY2xvbmUodG9WYWx1ZShzb3VyY2UpKTtcbiAgfVxuICBpZiAoIW1hbnVhbCAmJiAoaXNSZWYoc291cmNlKSB8fCB0eXBlb2Ygc291cmNlID09PSBcImZ1bmN0aW9uXCIpKSB7XG4gICAgd2F0Y2goc291cmNlLCBzeW5jLCB7XG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgZGVlcCxcbiAgICAgIGltbWVkaWF0ZVxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHN5bmMoKTtcbiAgfVxuICByZXR1cm4geyBjbG9uZWQsIGlzTW9kaWZpZWQsIHN5bmMgfTtcbn1cblxuY29uc3QgX2dsb2JhbCA9IHR5cGVvZiBnbG9iYWxUaGlzICE9PSBcInVuZGVmaW5lZFwiID8gZ2xvYmFsVGhpcyA6IHR5cGVvZiB3aW5kb3cgIT09IFwidW5kZWZpbmVkXCIgPyB3aW5kb3cgOiB0eXBlb2YgZ2xvYmFsICE9PSBcInVuZGVmaW5lZFwiID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09IFwidW5kZWZpbmVkXCIgPyBzZWxmIDoge307XG5jb25zdCBnbG9iYWxLZXkgPSBcIl9fdnVldXNlX3Nzcl9oYW5kbGVyc19fXCI7XG5jb25zdCBoYW5kbGVycyA9IC8qIEBfX1BVUkVfXyAqLyBnZXRIYW5kbGVycygpO1xuZnVuY3Rpb24gZ2V0SGFuZGxlcnMoKSB7XG4gIGlmICghKGdsb2JhbEtleSBpbiBfZ2xvYmFsKSlcbiAgICBfZ2xvYmFsW2dsb2JhbEtleV0gPSBfZ2xvYmFsW2dsb2JhbEtleV0gfHwge307XG4gIHJldHVybiBfZ2xvYmFsW2dsb2JhbEtleV07XG59XG5mdW5jdGlvbiBnZXRTU1JIYW5kbGVyKGtleSwgZmFsbGJhY2spIHtcbiAgcmV0dXJuIGhhbmRsZXJzW2tleV0gfHwgZmFsbGJhY2s7XG59XG5mdW5jdGlvbiBzZXRTU1JIYW5kbGVyKGtleSwgZm4pIHtcbiAgaGFuZGxlcnNba2V5XSA9IGZuO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlUHJlZmVycmVkRGFyayhvcHRpb25zKSB7XG4gIHJldHVybiB1c2VNZWRpYVF1ZXJ5KFwiKHByZWZlcnMtY29sb3Itc2NoZW1lOiBkYXJrKVwiLCBvcHRpb25zKTtcbn1cblxuZnVuY3Rpb24gZ3Vlc3NTZXJpYWxpemVyVHlwZShyYXdJbml0KSB7XG4gIHJldHVybiByYXdJbml0ID09IG51bGwgPyBcImFueVwiIDogcmF3SW5pdCBpbnN0YW5jZW9mIFNldCA/IFwic2V0XCIgOiByYXdJbml0IGluc3RhbmNlb2YgTWFwID8gXCJtYXBcIiA6IHJhd0luaXQgaW5zdGFuY2VvZiBEYXRlID8gXCJkYXRlXCIgOiB0eXBlb2YgcmF3SW5pdCA9PT0gXCJib29sZWFuXCIgPyBcImJvb2xlYW5cIiA6IHR5cGVvZiByYXdJbml0ID09PSBcInN0cmluZ1wiID8gXCJzdHJpbmdcIiA6IHR5cGVvZiByYXdJbml0ID09PSBcIm9iamVjdFwiID8gXCJvYmplY3RcIiA6ICFOdW1iZXIuaXNOYU4ocmF3SW5pdCkgPyBcIm51bWJlclwiIDogXCJhbnlcIjtcbn1cblxuY29uc3QgU3RvcmFnZVNlcmlhbGl6ZXJzID0ge1xuICBib29sZWFuOiB7XG4gICAgcmVhZDogKHYpID0+IHYgPT09IFwidHJ1ZVwiLFxuICAgIHdyaXRlOiAodikgPT4gU3RyaW5nKHYpXG4gIH0sXG4gIG9iamVjdDoge1xuICAgIHJlYWQ6ICh2KSA9PiBKU09OLnBhcnNlKHYpLFxuICAgIHdyaXRlOiAodikgPT4gSlNPTi5zdHJpbmdpZnkodilcbiAgfSxcbiAgbnVtYmVyOiB7XG4gICAgcmVhZDogKHYpID0+IE51bWJlci5wYXJzZUZsb2F0KHYpLFxuICAgIHdyaXRlOiAodikgPT4gU3RyaW5nKHYpXG4gIH0sXG4gIGFueToge1xuICAgIHJlYWQ6ICh2KSA9PiB2LFxuICAgIHdyaXRlOiAodikgPT4gU3RyaW5nKHYpXG4gIH0sXG4gIHN0cmluZzoge1xuICAgIHJlYWQ6ICh2KSA9PiB2LFxuICAgIHdyaXRlOiAodikgPT4gU3RyaW5nKHYpXG4gIH0sXG4gIG1hcDoge1xuICAgIHJlYWQ6ICh2KSA9PiBuZXcgTWFwKEpTT04ucGFyc2UodikpLFxuICAgIHdyaXRlOiAodikgPT4gSlNPTi5zdHJpbmdpZnkoQXJyYXkuZnJvbSh2LmVudHJpZXMoKSkpXG4gIH0sXG4gIHNldDoge1xuICAgIHJlYWQ6ICh2KSA9PiBuZXcgU2V0KEpTT04ucGFyc2UodikpLFxuICAgIHdyaXRlOiAodikgPT4gSlNPTi5zdHJpbmdpZnkoQXJyYXkuZnJvbSh2KSlcbiAgfSxcbiAgZGF0ZToge1xuICAgIHJlYWQ6ICh2KSA9PiBuZXcgRGF0ZSh2KSxcbiAgICB3cml0ZTogKHYpID0+IHYudG9JU09TdHJpbmcoKVxuICB9XG59O1xuY29uc3QgY3VzdG9tU3RvcmFnZUV2ZW50TmFtZSA9IFwidnVldXNlLXN0b3JhZ2VcIjtcbmZ1bmN0aW9uIHVzZVN0b3JhZ2Uoa2V5LCBkZWZhdWx0cywgc3RvcmFnZSwgb3B0aW9ucyA9IHt9KSB7XG4gIHZhciBfYTtcbiAgY29uc3Qge1xuICAgIGZsdXNoID0gXCJwcmVcIixcbiAgICBkZWVwID0gdHJ1ZSxcbiAgICBsaXN0ZW5Ub1N0b3JhZ2VDaGFuZ2VzID0gdHJ1ZSxcbiAgICB3cml0ZURlZmF1bHRzID0gdHJ1ZSxcbiAgICBtZXJnZURlZmF1bHRzID0gZmFsc2UsXG4gICAgc2hhbGxvdyxcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93LFxuICAgIGV2ZW50RmlsdGVyLFxuICAgIG9uRXJyb3IgPSAoZSkgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICB9LFxuICAgIGluaXRPbk1vdW50ZWRcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGRhdGEgPSAoc2hhbGxvdyA/IHNoYWxsb3dSZWYgOiByZWYpKHR5cGVvZiBkZWZhdWx0cyA9PT0gXCJmdW5jdGlvblwiID8gZGVmYXVsdHMoKSA6IGRlZmF1bHRzKTtcbiAgY29uc3Qga2V5Q29tcHV0ZWQgPSBjb21wdXRlZCgoKSA9PiB0b1ZhbHVlKGtleSkpO1xuICBpZiAoIXN0b3JhZ2UpIHtcbiAgICB0cnkge1xuICAgICAgc3RvcmFnZSA9IGdldFNTUkhhbmRsZXIoXCJnZXREZWZhdWx0U3RvcmFnZVwiLCAoKSA9PiB7XG4gICAgICAgIHZhciBfYTI7XG4gICAgICAgIHJldHVybiAoX2EyID0gZGVmYXVsdFdpbmRvdykgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5sb2NhbFN0b3JhZ2U7XG4gICAgICB9KSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIG9uRXJyb3IoZSk7XG4gICAgfVxuICB9XG4gIGlmICghc3RvcmFnZSlcbiAgICByZXR1cm4gZGF0YTtcbiAgY29uc3QgcmF3SW5pdCA9IHRvVmFsdWUoZGVmYXVsdHMpO1xuICBjb25zdCB0eXBlID0gZ3Vlc3NTZXJpYWxpemVyVHlwZShyYXdJbml0KTtcbiAgY29uc3Qgc2VyaWFsaXplciA9IChfYSA9IG9wdGlvbnMuc2VyaWFsaXplcikgIT0gbnVsbCA/IF9hIDogU3RvcmFnZVNlcmlhbGl6ZXJzW3R5cGVdO1xuICBjb25zdCB7IHBhdXNlOiBwYXVzZVdhdGNoLCByZXN1bWU6IHJlc3VtZVdhdGNoIH0gPSBwYXVzYWJsZVdhdGNoKFxuICAgIGRhdGEsXG4gICAgKG5ld1ZhbHVlKSA9PiB3cml0ZShuZXdWYWx1ZSksXG4gICAgeyBmbHVzaCwgZGVlcCwgZXZlbnRGaWx0ZXIgfVxuICApO1xuICB3YXRjaChrZXlDb21wdXRlZCwgKCkgPT4gdXBkYXRlKCksIHsgZmx1c2ggfSk7XG4gIGxldCBmaXJzdE1vdW50ZWQgPSBmYWxzZTtcbiAgY29uc3Qgb25TdG9yYWdlRXZlbnQgPSAoZXYpID0+IHtcbiAgICBpZiAoaW5pdE9uTW91bnRlZCAmJiAhZmlyc3RNb3VudGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHVwZGF0ZShldik7XG4gIH07XG4gIGNvbnN0IG9uU3RvcmFnZUN1c3RvbUV2ZW50ID0gKGV2KSA9PiB7XG4gICAgaWYgKGluaXRPbk1vdW50ZWQgJiYgIWZpcnN0TW91bnRlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB1cGRhdGVGcm9tQ3VzdG9tRXZlbnQoZXYpO1xuICB9O1xuICBpZiAod2luZG93ICYmIGxpc3RlblRvU3RvcmFnZUNoYW5nZXMpIHtcbiAgICBpZiAoc3RvcmFnZSBpbnN0YW5jZW9mIFN0b3JhZ2UpXG4gICAgICB1c2VFdmVudExpc3RlbmVyKHdpbmRvdywgXCJzdG9yYWdlXCIsIG9uU3RvcmFnZUV2ZW50LCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gICAgZWxzZVxuICAgICAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3csIGN1c3RvbVN0b3JhZ2VFdmVudE5hbWUsIG9uU3RvcmFnZUN1c3RvbUV2ZW50KTtcbiAgfVxuICBpZiAoaW5pdE9uTW91bnRlZCkge1xuICAgIHRyeU9uTW91bnRlZCgoKSA9PiB7XG4gICAgICBmaXJzdE1vdW50ZWQgPSB0cnVlO1xuICAgICAgdXBkYXRlKCk7XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgdXBkYXRlKCk7XG4gIH1cbiAgZnVuY3Rpb24gZGlzcGF0Y2hXcml0ZUV2ZW50KG9sZFZhbHVlLCBuZXdWYWx1ZSkge1xuICAgIGlmICh3aW5kb3cpIHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSB7XG4gICAgICAgIGtleToga2V5Q29tcHV0ZWQudmFsdWUsXG4gICAgICAgIG9sZFZhbHVlLFxuICAgICAgICBuZXdWYWx1ZSxcbiAgICAgICAgc3RvcmFnZUFyZWE6IHN0b3JhZ2VcbiAgICAgIH07XG4gICAgICB3aW5kb3cuZGlzcGF0Y2hFdmVudChzdG9yYWdlIGluc3RhbmNlb2YgU3RvcmFnZSA/IG5ldyBTdG9yYWdlRXZlbnQoXCJzdG9yYWdlXCIsIHBheWxvYWQpIDogbmV3IEN1c3RvbUV2ZW50KGN1c3RvbVN0b3JhZ2VFdmVudE5hbWUsIHtcbiAgICAgICAgZGV0YWlsOiBwYXlsb2FkXG4gICAgICB9KSk7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIHdyaXRlKHYpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgb2xkVmFsdWUgPSBzdG9yYWdlLmdldEl0ZW0oa2V5Q29tcHV0ZWQudmFsdWUpO1xuICAgICAgaWYgKHYgPT0gbnVsbCkge1xuICAgICAgICBkaXNwYXRjaFdyaXRlRXZlbnQob2xkVmFsdWUsIG51bGwpO1xuICAgICAgICBzdG9yYWdlLnJlbW92ZUl0ZW0oa2V5Q29tcHV0ZWQudmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IHNlcmlhbGl6ZXIud3JpdGUodik7XG4gICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gc2VyaWFsaXplZCkge1xuICAgICAgICAgIHN0b3JhZ2Uuc2V0SXRlbShrZXlDb21wdXRlZC52YWx1ZSwgc2VyaWFsaXplZCk7XG4gICAgICAgICAgZGlzcGF0Y2hXcml0ZUV2ZW50KG9sZFZhbHVlLCBzZXJpYWxpemVkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIG9uRXJyb3IoZSk7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIHJlYWQoZXZlbnQpIHtcbiAgICBjb25zdCByYXdWYWx1ZSA9IGV2ZW50ID8gZXZlbnQubmV3VmFsdWUgOiBzdG9yYWdlLmdldEl0ZW0oa2V5Q29tcHV0ZWQudmFsdWUpO1xuICAgIGlmIChyYXdWYWx1ZSA9PSBudWxsKSB7XG4gICAgICBpZiAod3JpdGVEZWZhdWx0cyAmJiByYXdJbml0ICE9IG51bGwpXG4gICAgICAgIHN0b3JhZ2Uuc2V0SXRlbShrZXlDb21wdXRlZC52YWx1ZSwgc2VyaWFsaXplci53cml0ZShyYXdJbml0KSk7XG4gICAgICByZXR1cm4gcmF3SW5pdDtcbiAgICB9IGVsc2UgaWYgKCFldmVudCAmJiBtZXJnZURlZmF1bHRzKSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHNlcmlhbGl6ZXIucmVhZChyYXdWYWx1ZSk7XG4gICAgICBpZiAodHlwZW9mIG1lcmdlRGVmYXVsdHMgPT09IFwiZnVuY3Rpb25cIilcbiAgICAgICAgcmV0dXJuIG1lcmdlRGVmYXVsdHModmFsdWUsIHJhd0luaXQpO1xuICAgICAgZWxzZSBpZiAodHlwZSA9PT0gXCJvYmplY3RcIiAmJiAhQXJyYXkuaXNBcnJheSh2YWx1ZSkpXG4gICAgICAgIHJldHVybiB7IC4uLnJhd0luaXQsIC4uLnZhbHVlIH07XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgcmF3VmFsdWUgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiByYXdWYWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHNlcmlhbGl6ZXIucmVhZChyYXdWYWx1ZSk7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIHVwZGF0ZShldmVudCkge1xuICAgIGlmIChldmVudCAmJiBldmVudC5zdG9yYWdlQXJlYSAhPT0gc3RvcmFnZSlcbiAgICAgIHJldHVybjtcbiAgICBpZiAoZXZlbnQgJiYgZXZlbnQua2V5ID09IG51bGwpIHtcbiAgICAgIGRhdGEudmFsdWUgPSByYXdJbml0O1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoZXZlbnQgJiYgZXZlbnQua2V5ICE9PSBrZXlDb21wdXRlZC52YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBwYXVzZVdhdGNoKCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWREYXRhID0gc2VyaWFsaXplci53cml0ZShkYXRhLnZhbHVlKTtcbiAgICAgIGlmIChldmVudCA9PT0gdm9pZCAwIHx8IChldmVudCA9PSBudWxsID8gdm9pZCAwIDogZXZlbnQubmV3VmFsdWUpICE9PSBzZXJpYWxpemVkRGF0YSkge1xuICAgICAgICBkYXRhLnZhbHVlID0gcmVhZChldmVudCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgb25FcnJvcihlKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgaWYgKGV2ZW50KVxuICAgICAgICBuZXh0VGljayhyZXN1bWVXYXRjaCk7XG4gICAgICBlbHNlXG4gICAgICAgIHJlc3VtZVdhdGNoKCk7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIHVwZGF0ZUZyb21DdXN0b21FdmVudChldmVudCkge1xuICAgIHVwZGF0ZShldmVudC5kZXRhaWwpO1xuICB9XG4gIHJldHVybiBkYXRhO1xufVxuXG5jb25zdCBDU1NfRElTQUJMRV9UUkFOUyA9IFwiKiwqOjpiZWZvcmUsKjo6YWZ0ZXJ7LXdlYmtpdC10cmFuc2l0aW9uOm5vbmUhaW1wb3J0YW50Oy1tb3otdHJhbnNpdGlvbjpub25lIWltcG9ydGFudDstby10cmFuc2l0aW9uOm5vbmUhaW1wb3J0YW50Oy1tcy10cmFuc2l0aW9uOm5vbmUhaW1wb3J0YW50O3RyYW5zaXRpb246bm9uZSFpbXBvcnRhbnR9XCI7XG5mdW5jdGlvbiB1c2VDb2xvck1vZGUob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBzZWxlY3RvciA9IFwiaHRtbFwiLFxuICAgIGF0dHJpYnV0ZSA9IFwiY2xhc3NcIixcbiAgICBpbml0aWFsVmFsdWUgPSBcImF1dG9cIixcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93LFxuICAgIHN0b3JhZ2UsXG4gICAgc3RvcmFnZUtleSA9IFwidnVldXNlLWNvbG9yLXNjaGVtZVwiLFxuICAgIGxpc3RlblRvU3RvcmFnZUNoYW5nZXMgPSB0cnVlLFxuICAgIHN0b3JhZ2VSZWYsXG4gICAgZW1pdEF1dG8sXG4gICAgZGlzYWJsZVRyYW5zaXRpb24gPSB0cnVlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBtb2RlcyA9IHtcbiAgICBhdXRvOiBcIlwiLFxuICAgIGxpZ2h0OiBcImxpZ2h0XCIsXG4gICAgZGFyazogXCJkYXJrXCIsXG4gICAgLi4ub3B0aW9ucy5tb2RlcyB8fCB7fVxuICB9O1xuICBjb25zdCBwcmVmZXJyZWREYXJrID0gdXNlUHJlZmVycmVkRGFyayh7IHdpbmRvdyB9KTtcbiAgY29uc3Qgc3lzdGVtID0gY29tcHV0ZWQoKCkgPT4gcHJlZmVycmVkRGFyay52YWx1ZSA/IFwiZGFya1wiIDogXCJsaWdodFwiKTtcbiAgY29uc3Qgc3RvcmUgPSBzdG9yYWdlUmVmIHx8IChzdG9yYWdlS2V5ID09IG51bGwgPyB0b1JlZihpbml0aWFsVmFsdWUpIDogdXNlU3RvcmFnZShzdG9yYWdlS2V5LCBpbml0aWFsVmFsdWUsIHN0b3JhZ2UsIHsgd2luZG93LCBsaXN0ZW5Ub1N0b3JhZ2VDaGFuZ2VzIH0pKTtcbiAgY29uc3Qgc3RhdGUgPSBjb21wdXRlZCgoKSA9PiBzdG9yZS52YWx1ZSA9PT0gXCJhdXRvXCIgPyBzeXN0ZW0udmFsdWUgOiBzdG9yZS52YWx1ZSk7XG4gIGNvbnN0IHVwZGF0ZUhUTUxBdHRycyA9IGdldFNTUkhhbmRsZXIoXG4gICAgXCJ1cGRhdGVIVE1MQXR0cnNcIixcbiAgICAoc2VsZWN0b3IyLCBhdHRyaWJ1dGUyLCB2YWx1ZSkgPT4ge1xuICAgICAgY29uc3QgZWwgPSB0eXBlb2Ygc2VsZWN0b3IyID09PSBcInN0cmluZ1wiID8gd2luZG93ID09IG51bGwgPyB2b2lkIDAgOiB3aW5kb3cuZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvcjIpIDogdW5yZWZFbGVtZW50KHNlbGVjdG9yMik7XG4gICAgICBpZiAoIWVsKVxuICAgICAgICByZXR1cm47XG4gICAgICBjb25zdCBjbGFzc2VzVG9BZGQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpO1xuICAgICAgY29uc3QgY2xhc3Nlc1RvUmVtb3ZlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTtcbiAgICAgIGxldCBhdHRyaWJ1dGVUb0NoYW5nZSA9IG51bGw7XG4gICAgICBpZiAoYXR0cmlidXRlMiA9PT0gXCJjbGFzc1wiKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnQgPSB2YWx1ZS5zcGxpdCgvXFxzL2cpO1xuICAgICAgICBPYmplY3QudmFsdWVzKG1vZGVzKS5mbGF0TWFwKChpKSA9PiAoaSB8fCBcIlwiKS5zcGxpdCgvXFxzL2cpKS5maWx0ZXIoQm9vbGVhbikuZm9yRWFjaCgodikgPT4ge1xuICAgICAgICAgIGlmIChjdXJyZW50LmluY2x1ZGVzKHYpKVxuICAgICAgICAgICAgY2xhc3Nlc1RvQWRkLmFkZCh2KTtcbiAgICAgICAgICBlbHNlXG4gICAgICAgICAgICBjbGFzc2VzVG9SZW1vdmUuYWRkKHYpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF0dHJpYnV0ZVRvQ2hhbmdlID0geyBrZXk6IGF0dHJpYnV0ZTIsIHZhbHVlIH07XG4gICAgICB9XG4gICAgICBpZiAoY2xhc3Nlc1RvQWRkLnNpemUgPT09IDAgJiYgY2xhc3Nlc1RvUmVtb3ZlLnNpemUgPT09IDAgJiYgYXR0cmlidXRlVG9DaGFuZ2UgPT09IG51bGwpXG4gICAgICAgIHJldHVybjtcbiAgICAgIGxldCBzdHlsZTtcbiAgICAgIGlmIChkaXNhYmxlVHJhbnNpdGlvbikge1xuICAgICAgICBzdHlsZSA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3R5bGVcIik7XG4gICAgICAgIHN0eWxlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKENTU19ESVNBQkxFX1RSQU5TKSk7XG4gICAgICAgIHdpbmRvdy5kb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgYyBvZiBjbGFzc2VzVG9BZGQpIHtcbiAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChjKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgYyBvZiBjbGFzc2VzVG9SZW1vdmUpIHtcbiAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjKTtcbiAgICAgIH1cbiAgICAgIGlmIChhdHRyaWJ1dGVUb0NoYW5nZSkge1xuICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlVG9DaGFuZ2Uua2V5LCBhdHRyaWJ1dGVUb0NoYW5nZS52YWx1ZSk7XG4gICAgICB9XG4gICAgICBpZiAoZGlzYWJsZVRyYW5zaXRpb24pIHtcbiAgICAgICAgd2luZG93LmdldENvbXB1dGVkU3R5bGUoc3R5bGUpLm9wYWNpdHk7XG4gICAgICAgIGRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc3R5bGUpO1xuICAgICAgfVxuICAgIH1cbiAgKTtcbiAgZnVuY3Rpb24gZGVmYXVsdE9uQ2hhbmdlZChtb2RlKSB7XG4gICAgdmFyIF9hO1xuICAgIHVwZGF0ZUhUTUxBdHRycyhzZWxlY3RvciwgYXR0cmlidXRlLCAoX2EgPSBtb2Rlc1ttb2RlXSkgIT0gbnVsbCA/IF9hIDogbW9kZSk7XG4gIH1cbiAgZnVuY3Rpb24gb25DaGFuZ2VkKG1vZGUpIHtcbiAgICBpZiAob3B0aW9ucy5vbkNoYW5nZWQpXG4gICAgICBvcHRpb25zLm9uQ2hhbmdlZChtb2RlLCBkZWZhdWx0T25DaGFuZ2VkKTtcbiAgICBlbHNlXG4gICAgICBkZWZhdWx0T25DaGFuZ2VkKG1vZGUpO1xuICB9XG4gIHdhdGNoKHN0YXRlLCBvbkNoYW5nZWQsIHsgZmx1c2g6IFwicG9zdFwiLCBpbW1lZGlhdGU6IHRydWUgfSk7XG4gIHRyeU9uTW91bnRlZCgoKSA9PiBvbkNoYW5nZWQoc3RhdGUudmFsdWUpKTtcbiAgY29uc3QgYXV0byA9IGNvbXB1dGVkKHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gZW1pdEF1dG8gPyBzdG9yZS52YWx1ZSA6IHN0YXRlLnZhbHVlO1xuICAgIH0sXG4gICAgc2V0KHYpIHtcbiAgICAgIHN0b3JlLnZhbHVlID0gdjtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gT2JqZWN0LmFzc2lnbihhdXRvLCB7IHN0b3JlLCBzeXN0ZW0sIHN0YXRlIH0pO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlQ29uZmlybURpYWxvZyhyZXZlYWxlZCA9IHNoYWxsb3dSZWYoZmFsc2UpKSB7XG4gIGNvbnN0IGNvbmZpcm1Ib29rID0gY3JlYXRlRXZlbnRIb29rKCk7XG4gIGNvbnN0IGNhbmNlbEhvb2sgPSBjcmVhdGVFdmVudEhvb2soKTtcbiAgY29uc3QgcmV2ZWFsSG9vayA9IGNyZWF0ZUV2ZW50SG9vaygpO1xuICBsZXQgX3Jlc29sdmUgPSBub29wO1xuICBjb25zdCByZXZlYWwgPSAoZGF0YSkgPT4ge1xuICAgIHJldmVhbEhvb2sudHJpZ2dlcihkYXRhKTtcbiAgICByZXZlYWxlZC52YWx1ZSA9IHRydWU7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICBfcmVzb2x2ZSA9IHJlc29sdmU7XG4gICAgfSk7XG4gIH07XG4gIGNvbnN0IGNvbmZpcm0gPSAoZGF0YSkgPT4ge1xuICAgIHJldmVhbGVkLnZhbHVlID0gZmFsc2U7XG4gICAgY29uZmlybUhvb2sudHJpZ2dlcihkYXRhKTtcbiAgICBfcmVzb2x2ZSh7IGRhdGEsIGlzQ2FuY2VsZWQ6IGZhbHNlIH0pO1xuICB9O1xuICBjb25zdCBjYW5jZWwgPSAoZGF0YSkgPT4ge1xuICAgIHJldmVhbGVkLnZhbHVlID0gZmFsc2U7XG4gICAgY2FuY2VsSG9vay50cmlnZ2VyKGRhdGEpO1xuICAgIF9yZXNvbHZlKHsgZGF0YSwgaXNDYW5jZWxlZDogdHJ1ZSB9KTtcbiAgfTtcbiAgcmV0dXJuIHtcbiAgICBpc1JldmVhbGVkOiBjb21wdXRlZCgoKSA9PiByZXZlYWxlZC52YWx1ZSksXG4gICAgcmV2ZWFsLFxuICAgIGNvbmZpcm0sXG4gICAgY2FuY2VsLFxuICAgIG9uUmV2ZWFsOiByZXZlYWxIb29rLm9uLFxuICAgIG9uQ29uZmlybTogY29uZmlybUhvb2sub24sXG4gICAgb25DYW5jZWw6IGNhbmNlbEhvb2sub25cbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlQ291bnRkb3duKGluaXRpYWxDb3VudGRvd24sIG9wdGlvbnMpIHtcbiAgdmFyIF9hLCBfYjtcbiAgY29uc3QgcmVtYWluaW5nID0gc2hhbGxvd1JlZih0b1ZhbHVlKGluaXRpYWxDb3VudGRvd24pKTtcbiAgY29uc3QgaW50ZXJ2YWxDb250cm9sbGVyID0gdXNlSW50ZXJ2YWxGbigoKSA9PiB7XG4gICAgdmFyIF9hMiwgX2IyO1xuICAgIGNvbnN0IHZhbHVlID0gcmVtYWluaW5nLnZhbHVlIC0gMTtcbiAgICByZW1haW5pbmcudmFsdWUgPSB2YWx1ZSA8IDAgPyAwIDogdmFsdWU7XG4gICAgKF9hMiA9IG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMub25UaWNrKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLmNhbGwob3B0aW9ucyk7XG4gICAgaWYgKHJlbWFpbmluZy52YWx1ZSA8PSAwKSB7XG4gICAgICBpbnRlcnZhbENvbnRyb2xsZXIucGF1c2UoKTtcbiAgICAgIChfYjIgPSBvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLm9uQ29tcGxldGUpID09IG51bGwgPyB2b2lkIDAgOiBfYjIuY2FsbChvcHRpb25zKTtcbiAgICB9XG4gIH0sIChfYSA9IG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuaW50ZXJ2YWwpICE9IG51bGwgPyBfYSA6IDFlMywgeyBpbW1lZGlhdGU6IChfYiA9IG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuaW1tZWRpYXRlKSAhPSBudWxsID8gX2IgOiBmYWxzZSB9KTtcbiAgY29uc3QgcmVzZXQgPSAoY291bnRkb3duKSA9PiB7XG4gICAgdmFyIF9hMjtcbiAgICByZW1haW5pbmcudmFsdWUgPSAoX2EyID0gdG9WYWx1ZShjb3VudGRvd24pKSAhPSBudWxsID8gX2EyIDogdG9WYWx1ZShpbml0aWFsQ291bnRkb3duKTtcbiAgfTtcbiAgY29uc3Qgc3RvcCA9ICgpID0+IHtcbiAgICBpbnRlcnZhbENvbnRyb2xsZXIucGF1c2UoKTtcbiAgICByZXNldCgpO1xuICB9O1xuICBjb25zdCByZXN1bWUgPSAoKSA9PiB7XG4gICAgaWYgKCFpbnRlcnZhbENvbnRyb2xsZXIuaXNBY3RpdmUudmFsdWUpIHtcbiAgICAgIGlmIChyZW1haW5pbmcudmFsdWUgPiAwKSB7XG4gICAgICAgIGludGVydmFsQ29udHJvbGxlci5yZXN1bWUoKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIGNvbnN0IHN0YXJ0ID0gKGNvdW50ZG93bikgPT4ge1xuICAgIHJlc2V0KGNvdW50ZG93bik7XG4gICAgaW50ZXJ2YWxDb250cm9sbGVyLnJlc3VtZSgpO1xuICB9O1xuICByZXR1cm4ge1xuICAgIHJlbWFpbmluZyxcbiAgICByZXNldCxcbiAgICBzdG9wLFxuICAgIHN0YXJ0LFxuICAgIHBhdXNlOiBpbnRlcnZhbENvbnRyb2xsZXIucGF1c2UsXG4gICAgcmVzdW1lLFxuICAgIGlzQWN0aXZlOiBpbnRlcnZhbENvbnRyb2xsZXIuaXNBY3RpdmVcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlQ3NzVmFyKHByb3AsIHRhcmdldCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgd2luZG93ID0gZGVmYXVsdFdpbmRvdywgaW5pdGlhbFZhbHVlLCBvYnNlcnZlID0gZmFsc2UgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHZhcmlhYmxlID0gc2hhbGxvd1JlZihpbml0aWFsVmFsdWUpO1xuICBjb25zdCBlbFJlZiA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICB2YXIgX2E7XG4gICAgcmV0dXJuIHVucmVmRWxlbWVudCh0YXJnZXQpIHx8ICgoX2EgPSB3aW5kb3cgPT0gbnVsbCA/IHZvaWQgMCA6IHdpbmRvdy5kb2N1bWVudCkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmRvY3VtZW50RWxlbWVudCk7XG4gIH0pO1xuICBmdW5jdGlvbiB1cGRhdGVDc3NWYXIoKSB7XG4gICAgdmFyIF9hO1xuICAgIGNvbnN0IGtleSA9IHRvVmFsdWUocHJvcCk7XG4gICAgY29uc3QgZWwgPSB0b1ZhbHVlKGVsUmVmKTtcbiAgICBpZiAoZWwgJiYgd2luZG93ICYmIGtleSkge1xuICAgICAgY29uc3QgdmFsdWUgPSAoX2EgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCkuZ2V0UHJvcGVydHlWYWx1ZShrZXkpKSA9PSBudWxsID8gdm9pZCAwIDogX2EudHJpbSgpO1xuICAgICAgdmFyaWFibGUudmFsdWUgPSB2YWx1ZSB8fCB2YXJpYWJsZS52YWx1ZSB8fCBpbml0aWFsVmFsdWU7XG4gICAgfVxuICB9XG4gIGlmIChvYnNlcnZlKSB7XG4gICAgdXNlTXV0YXRpb25PYnNlcnZlcihlbFJlZiwgdXBkYXRlQ3NzVmFyLCB7XG4gICAgICBhdHRyaWJ1dGVGaWx0ZXI6IFtcInN0eWxlXCIsIFwiY2xhc3NcIl0sXG4gICAgICB3aW5kb3dcbiAgICB9KTtcbiAgfVxuICB3YXRjaChcbiAgICBbZWxSZWYsICgpID0+IHRvVmFsdWUocHJvcCldLFxuICAgIChfLCBvbGQpID0+IHtcbiAgICAgIGlmIChvbGRbMF0gJiYgb2xkWzFdKVxuICAgICAgICBvbGRbMF0uc3R5bGUucmVtb3ZlUHJvcGVydHkob2xkWzFdKTtcbiAgICAgIHVwZGF0ZUNzc1ZhcigpO1xuICAgIH0sXG4gICAgeyBpbW1lZGlhdGU6IHRydWUgfVxuICApO1xuICB3YXRjaChcbiAgICBbdmFyaWFibGUsIGVsUmVmXSxcbiAgICAoW3ZhbCwgZWxdKSA9PiB7XG4gICAgICBjb25zdCByYXdfcHJvcCA9IHRvVmFsdWUocHJvcCk7XG4gICAgICBpZiAoKGVsID09IG51bGwgPyB2b2lkIDAgOiBlbC5zdHlsZSkgJiYgcmF3X3Byb3ApIHtcbiAgICAgICAgaWYgKHZhbCA9PSBudWxsKVxuICAgICAgICAgIGVsLnN0eWxlLnJlbW92ZVByb3BlcnR5KHJhd19wcm9wKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KHJhd19wcm9wLCB2YWwpO1xuICAgICAgfVxuICAgIH0sXG4gICAgeyBpbW1lZGlhdGU6IHRydWUgfVxuICApO1xuICByZXR1cm4gdmFyaWFibGU7XG59XG5cbmZ1bmN0aW9uIHVzZUN1cnJlbnRFbGVtZW50KHJvb3RDb21wb25lbnQpIHtcbiAgY29uc3Qgdm0gPSBnZXRDdXJyZW50SW5zdGFuY2UoKTtcbiAgY29uc3QgY3VycmVudEVsZW1lbnQgPSBjb21wdXRlZFdpdGhDb250cm9sKFxuICAgICgpID0+IG51bGwsXG4gICAgKCkgPT4gcm9vdENvbXBvbmVudCA/IHVucmVmRWxlbWVudChyb290Q29tcG9uZW50KSA6IHZtLnByb3h5LiRlbFxuICApO1xuICBvblVwZGF0ZWQoY3VycmVudEVsZW1lbnQudHJpZ2dlcik7XG4gIG9uTW91bnRlZChjdXJyZW50RWxlbWVudC50cmlnZ2VyKTtcbiAgcmV0dXJuIGN1cnJlbnRFbGVtZW50O1xufVxuXG5mdW5jdGlvbiB1c2VDeWNsZUxpc3QobGlzdCwgb3B0aW9ucykge1xuICBjb25zdCBzdGF0ZSA9IHNoYWxsb3dSZWYoZ2V0SW5pdGlhbFZhbHVlKCkpO1xuICBjb25zdCBsaXN0UmVmID0gdG9SZWYobGlzdCk7XG4gIGNvbnN0IGluZGV4ID0gY29tcHV0ZWQoe1xuICAgIGdldCgpIHtcbiAgICAgIHZhciBfYTtcbiAgICAgIGNvbnN0IHRhcmdldExpc3QgPSBsaXN0UmVmLnZhbHVlO1xuICAgICAgbGV0IGluZGV4MiA9IChvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLmdldEluZGV4T2YpID8gb3B0aW9ucy5nZXRJbmRleE9mKHN0YXRlLnZhbHVlLCB0YXJnZXRMaXN0KSA6IHRhcmdldExpc3QuaW5kZXhPZihzdGF0ZS52YWx1ZSk7XG4gICAgICBpZiAoaW5kZXgyIDwgMClcbiAgICAgICAgaW5kZXgyID0gKF9hID0gb3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5mYWxsYmFja0luZGV4KSAhPSBudWxsID8gX2EgOiAwO1xuICAgICAgcmV0dXJuIGluZGV4MjtcbiAgICB9LFxuICAgIHNldCh2KSB7XG4gICAgICBzZXQodik7XG4gICAgfVxuICB9KTtcbiAgZnVuY3Rpb24gc2V0KGkpIHtcbiAgICBjb25zdCB0YXJnZXRMaXN0ID0gbGlzdFJlZi52YWx1ZTtcbiAgICBjb25zdCBsZW5ndGggPSB0YXJnZXRMaXN0Lmxlbmd0aDtcbiAgICBjb25zdCBpbmRleDIgPSAoaSAlIGxlbmd0aCArIGxlbmd0aCkgJSBsZW5ndGg7XG4gICAgY29uc3QgdmFsdWUgPSB0YXJnZXRMaXN0W2luZGV4Ml07XG4gICAgc3RhdGUudmFsdWUgPSB2YWx1ZTtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cbiAgZnVuY3Rpb24gc2hpZnQoZGVsdGEgPSAxKSB7XG4gICAgcmV0dXJuIHNldChpbmRleC52YWx1ZSArIGRlbHRhKTtcbiAgfVxuICBmdW5jdGlvbiBuZXh0KG4gPSAxKSB7XG4gICAgcmV0dXJuIHNoaWZ0KG4pO1xuICB9XG4gIGZ1bmN0aW9uIHByZXYobiA9IDEpIHtcbiAgICByZXR1cm4gc2hpZnQoLW4pO1xuICB9XG4gIGZ1bmN0aW9uIGdldEluaXRpYWxWYWx1ZSgpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIHJldHVybiAoX2IgPSB0b1ZhbHVlKChfYSA9IG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuaW5pdGlhbFZhbHVlKSAhPSBudWxsID8gX2EgOiB0b1ZhbHVlKGxpc3QpWzBdKSkgIT0gbnVsbCA/IF9iIDogdm9pZCAwO1xuICB9XG4gIHdhdGNoKGxpc3RSZWYsICgpID0+IHNldChpbmRleC52YWx1ZSkpO1xuICByZXR1cm4ge1xuICAgIHN0YXRlLFxuICAgIGluZGV4LFxuICAgIG5leHQsXG4gICAgcHJldixcbiAgICBnbzogc2V0XG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZURhcmsob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB2YWx1ZURhcmsgPSBcImRhcmtcIixcbiAgICB2YWx1ZUxpZ2h0ID0gXCJcIlxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgbW9kZSA9IHVzZUNvbG9yTW9kZSh7XG4gICAgLi4ub3B0aW9ucyxcbiAgICBvbkNoYW5nZWQ6IChtb2RlMiwgZGVmYXVsdEhhbmRsZXIpID0+IHtcbiAgICAgIHZhciBfYTtcbiAgICAgIGlmIChvcHRpb25zLm9uQ2hhbmdlZClcbiAgICAgICAgKF9hID0gb3B0aW9ucy5vbkNoYW5nZWQpID09IG51bGwgPyB2b2lkIDAgOiBfYS5jYWxsKG9wdGlvbnMsIG1vZGUyID09PSBcImRhcmtcIiwgZGVmYXVsdEhhbmRsZXIsIG1vZGUyKTtcbiAgICAgIGVsc2VcbiAgICAgICAgZGVmYXVsdEhhbmRsZXIobW9kZTIpO1xuICAgIH0sXG4gICAgbW9kZXM6IHtcbiAgICAgIGRhcms6IHZhbHVlRGFyayxcbiAgICAgIGxpZ2h0OiB2YWx1ZUxpZ2h0XG4gICAgfVxuICB9KTtcbiAgY29uc3Qgc3lzdGVtID0gY29tcHV0ZWQoKCkgPT4gbW9kZS5zeXN0ZW0udmFsdWUpO1xuICBjb25zdCBpc0RhcmsgPSBjb21wdXRlZCh7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIG1vZGUudmFsdWUgPT09IFwiZGFya1wiO1xuICAgIH0sXG4gICAgc2V0KHYpIHtcbiAgICAgIGNvbnN0IG1vZGVWYWwgPSB2ID8gXCJkYXJrXCIgOiBcImxpZ2h0XCI7XG4gICAgICBpZiAoc3lzdGVtLnZhbHVlID09PSBtb2RlVmFsKVxuICAgICAgICBtb2RlLnZhbHVlID0gXCJhdXRvXCI7XG4gICAgICBlbHNlXG4gICAgICAgIG1vZGUudmFsdWUgPSBtb2RlVmFsO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiBpc0Rhcms7XG59XG5cbmZ1bmN0aW9uIGZuQnlwYXNzKHYpIHtcbiAgcmV0dXJuIHY7XG59XG5mdW5jdGlvbiBmblNldFNvdXJjZShzb3VyY2UsIHZhbHVlKSB7XG4gIHJldHVybiBzb3VyY2UudmFsdWUgPSB2YWx1ZTtcbn1cbmZ1bmN0aW9uIGRlZmF1bHREdW1wKGNsb25lKSB7XG4gIHJldHVybiBjbG9uZSA/IHR5cGVvZiBjbG9uZSA9PT0gXCJmdW5jdGlvblwiID8gY2xvbmUgOiBjbG9uZUZuSlNPTiA6IGZuQnlwYXNzO1xufVxuZnVuY3Rpb24gZGVmYXVsdFBhcnNlKGNsb25lKSB7XG4gIHJldHVybiBjbG9uZSA/IHR5cGVvZiBjbG9uZSA9PT0gXCJmdW5jdGlvblwiID8gY2xvbmUgOiBjbG9uZUZuSlNPTiA6IGZuQnlwYXNzO1xufVxuZnVuY3Rpb24gdXNlTWFudWFsUmVmSGlzdG9yeShzb3VyY2UsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgY2xvbmUgPSBmYWxzZSxcbiAgICBkdW1wID0gZGVmYXVsdER1bXAoY2xvbmUpLFxuICAgIHBhcnNlID0gZGVmYXVsdFBhcnNlKGNsb25lKSxcbiAgICBzZXRTb3VyY2UgPSBmblNldFNvdXJjZVxuICB9ID0gb3B0aW9ucztcbiAgZnVuY3Rpb24gX2NyZWF0ZUhpc3RvcnlSZWNvcmQoKSB7XG4gICAgcmV0dXJuIG1hcmtSYXcoe1xuICAgICAgc25hcHNob3Q6IGR1bXAoc291cmNlLnZhbHVlKSxcbiAgICAgIHRpbWVzdGFtcDogdGltZXN0YW1wKClcbiAgICB9KTtcbiAgfVxuICBjb25zdCBsYXN0ID0gcmVmKF9jcmVhdGVIaXN0b3J5UmVjb3JkKCkpO1xuICBjb25zdCB1bmRvU3RhY2sgPSByZWYoW10pO1xuICBjb25zdCByZWRvU3RhY2sgPSByZWYoW10pO1xuICBjb25zdCBfc2V0U291cmNlID0gKHJlY29yZCkgPT4ge1xuICAgIHNldFNvdXJjZShzb3VyY2UsIHBhcnNlKHJlY29yZC5zbmFwc2hvdCkpO1xuICAgIGxhc3QudmFsdWUgPSByZWNvcmQ7XG4gIH07XG4gIGNvbnN0IGNvbW1pdCA9ICgpID0+IHtcbiAgICB1bmRvU3RhY2sudmFsdWUudW5zaGlmdChsYXN0LnZhbHVlKTtcbiAgICBsYXN0LnZhbHVlID0gX2NyZWF0ZUhpc3RvcnlSZWNvcmQoKTtcbiAgICBpZiAob3B0aW9ucy5jYXBhY2l0eSAmJiB1bmRvU3RhY2sudmFsdWUubGVuZ3RoID4gb3B0aW9ucy5jYXBhY2l0eSlcbiAgICAgIHVuZG9TdGFjay52YWx1ZS5zcGxpY2Uob3B0aW9ucy5jYXBhY2l0eSwgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZKTtcbiAgICBpZiAocmVkb1N0YWNrLnZhbHVlLmxlbmd0aClcbiAgICAgIHJlZG9TdGFjay52YWx1ZS5zcGxpY2UoMCwgcmVkb1N0YWNrLnZhbHVlLmxlbmd0aCk7XG4gIH07XG4gIGNvbnN0IGNsZWFyID0gKCkgPT4ge1xuICAgIHVuZG9TdGFjay52YWx1ZS5zcGxpY2UoMCwgdW5kb1N0YWNrLnZhbHVlLmxlbmd0aCk7XG4gICAgcmVkb1N0YWNrLnZhbHVlLnNwbGljZSgwLCByZWRvU3RhY2sudmFsdWUubGVuZ3RoKTtcbiAgfTtcbiAgY29uc3QgdW5kbyA9ICgpID0+IHtcbiAgICBjb25zdCBzdGF0ZSA9IHVuZG9TdGFjay52YWx1ZS5zaGlmdCgpO1xuICAgIGlmIChzdGF0ZSkge1xuICAgICAgcmVkb1N0YWNrLnZhbHVlLnVuc2hpZnQobGFzdC52YWx1ZSk7XG4gICAgICBfc2V0U291cmNlKHN0YXRlKTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IHJlZG8gPSAoKSA9PiB7XG4gICAgY29uc3Qgc3RhdGUgPSByZWRvU3RhY2sudmFsdWUuc2hpZnQoKTtcbiAgICBpZiAoc3RhdGUpIHtcbiAgICAgIHVuZG9TdGFjay52YWx1ZS51bnNoaWZ0KGxhc3QudmFsdWUpO1xuICAgICAgX3NldFNvdXJjZShzdGF0ZSk7XG4gICAgfVxuICB9O1xuICBjb25zdCByZXNldCA9ICgpID0+IHtcbiAgICBfc2V0U291cmNlKGxhc3QudmFsdWUpO1xuICB9O1xuICBjb25zdCBoaXN0b3J5ID0gY29tcHV0ZWQoKCkgPT4gW2xhc3QudmFsdWUsIC4uLnVuZG9TdGFjay52YWx1ZV0pO1xuICBjb25zdCBjYW5VbmRvID0gY29tcHV0ZWQoKCkgPT4gdW5kb1N0YWNrLnZhbHVlLmxlbmd0aCA+IDApO1xuICBjb25zdCBjYW5SZWRvID0gY29tcHV0ZWQoKCkgPT4gcmVkb1N0YWNrLnZhbHVlLmxlbmd0aCA+IDApO1xuICByZXR1cm4ge1xuICAgIHNvdXJjZSxcbiAgICB1bmRvU3RhY2ssXG4gICAgcmVkb1N0YWNrLFxuICAgIGxhc3QsXG4gICAgaGlzdG9yeSxcbiAgICBjYW5VbmRvLFxuICAgIGNhblJlZG8sXG4gICAgY2xlYXIsXG4gICAgY29tbWl0LFxuICAgIHJlc2V0LFxuICAgIHVuZG8sXG4gICAgcmVkb1xuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VSZWZIaXN0b3J5KHNvdXJjZSwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBkZWVwID0gZmFsc2UsXG4gICAgZmx1c2ggPSBcInByZVwiLFxuICAgIGV2ZW50RmlsdGVyLFxuICAgIHNob3VsZENvbW1pdCA9ICgpID0+IHRydWVcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHtcbiAgICBldmVudEZpbHRlcjogY29tcG9zZWRGaWx0ZXIsXG4gICAgcGF1c2UsXG4gICAgcmVzdW1lOiByZXN1bWVUcmFja2luZyxcbiAgICBpc0FjdGl2ZTogaXNUcmFja2luZ1xuICB9ID0gcGF1c2FibGVGaWx0ZXIoZXZlbnRGaWx0ZXIpO1xuICBsZXQgbGFzdFJhd1ZhbHVlID0gc291cmNlLnZhbHVlO1xuICBjb25zdCB7XG4gICAgaWdub3JlVXBkYXRlcyxcbiAgICBpZ25vcmVQcmV2QXN5bmNVcGRhdGVzLFxuICAgIHN0b3BcbiAgfSA9IHdhdGNoSWdub3JhYmxlKFxuICAgIHNvdXJjZSxcbiAgICBjb21taXQsXG4gICAgeyBkZWVwLCBmbHVzaCwgZXZlbnRGaWx0ZXI6IGNvbXBvc2VkRmlsdGVyIH1cbiAgKTtcbiAgZnVuY3Rpb24gc2V0U291cmNlKHNvdXJjZTIsIHZhbHVlKSB7XG4gICAgaWdub3JlUHJldkFzeW5jVXBkYXRlcygpO1xuICAgIGlnbm9yZVVwZGF0ZXMoKCkgPT4ge1xuICAgICAgc291cmNlMi52YWx1ZSA9IHZhbHVlO1xuICAgICAgbGFzdFJhd1ZhbHVlID0gdmFsdWU7XG4gICAgfSk7XG4gIH1cbiAgY29uc3QgbWFudWFsSGlzdG9yeSA9IHVzZU1hbnVhbFJlZkhpc3Rvcnkoc291cmNlLCB7IC4uLm9wdGlvbnMsIGNsb25lOiBvcHRpb25zLmNsb25lIHx8IGRlZXAsIHNldFNvdXJjZSB9KTtcbiAgY29uc3QgeyBjbGVhciwgY29tbWl0OiBtYW51YWxDb21taXQgfSA9IG1hbnVhbEhpc3Rvcnk7XG4gIGZ1bmN0aW9uIGNvbW1pdCgpIHtcbiAgICBpZ25vcmVQcmV2QXN5bmNVcGRhdGVzKCk7XG4gICAgaWYgKCFzaG91bGRDb21taXQobGFzdFJhd1ZhbHVlLCBzb3VyY2UudmFsdWUpKVxuICAgICAgcmV0dXJuO1xuICAgIGxhc3RSYXdWYWx1ZSA9IHNvdXJjZS52YWx1ZTtcbiAgICBtYW51YWxDb21taXQoKTtcbiAgfVxuICBmdW5jdGlvbiByZXN1bWUoY29tbWl0Tm93KSB7XG4gICAgcmVzdW1lVHJhY2tpbmcoKTtcbiAgICBpZiAoY29tbWl0Tm93KVxuICAgICAgY29tbWl0KCk7XG4gIH1cbiAgZnVuY3Rpb24gYmF0Y2goZm4pIHtcbiAgICBsZXQgY2FuY2VsZWQgPSBmYWxzZTtcbiAgICBjb25zdCBjYW5jZWwgPSAoKSA9PiBjYW5jZWxlZCA9IHRydWU7XG4gICAgaWdub3JlVXBkYXRlcygoKSA9PiB7XG4gICAgICBmbihjYW5jZWwpO1xuICAgIH0pO1xuICAgIGlmICghY2FuY2VsZWQpXG4gICAgICBjb21taXQoKTtcbiAgfVxuICBmdW5jdGlvbiBkaXNwb3NlKCkge1xuICAgIHN0b3AoKTtcbiAgICBjbGVhcigpO1xuICB9XG4gIHJldHVybiB7XG4gICAgLi4ubWFudWFsSGlzdG9yeSxcbiAgICBpc1RyYWNraW5nLFxuICAgIHBhdXNlLFxuICAgIHJlc3VtZSxcbiAgICBjb21taXQsXG4gICAgYmF0Y2gsXG4gICAgZGlzcG9zZVxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VEZWJvdW5jZWRSZWZIaXN0b3J5KHNvdXJjZSwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IGZpbHRlciA9IG9wdGlvbnMuZGVib3VuY2UgPyBkZWJvdW5jZUZpbHRlcihvcHRpb25zLmRlYm91bmNlKSA6IHZvaWQgMDtcbiAgY29uc3QgaGlzdG9yeSA9IHVzZVJlZkhpc3Rvcnkoc291cmNlLCB7IC4uLm9wdGlvbnMsIGV2ZW50RmlsdGVyOiBmaWx0ZXIgfSk7XG4gIHJldHVybiB7XG4gICAgLi4uaGlzdG9yeVxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VEZXZpY2VNb3Rpb24ob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93LFxuICAgIHJlcXVlc3RQZXJtaXNzaW9ucyA9IGZhbHNlLFxuICAgIGV2ZW50RmlsdGVyID0gYnlwYXNzRmlsdGVyXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiB0eXBlb2YgRGV2aWNlTW90aW9uRXZlbnQgIT09IFwidW5kZWZpbmVkXCIpO1xuICBjb25zdCByZXF1aXJlUGVybWlzc2lvbnMgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gaXNTdXBwb3J0ZWQudmFsdWUgJiYgXCJyZXF1ZXN0UGVybWlzc2lvblwiIGluIERldmljZU1vdGlvbkV2ZW50ICYmIHR5cGVvZiBEZXZpY2VNb3Rpb25FdmVudC5yZXF1ZXN0UGVybWlzc2lvbiA9PT0gXCJmdW5jdGlvblwiKTtcbiAgY29uc3QgcGVybWlzc2lvbkdyYW50ZWQgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgYWNjZWxlcmF0aW9uID0gcmVmKHsgeDogbnVsbCwgeTogbnVsbCwgejogbnVsbCB9KTtcbiAgY29uc3Qgcm90YXRpb25SYXRlID0gcmVmKHsgYWxwaGE6IG51bGwsIGJldGE6IG51bGwsIGdhbW1hOiBudWxsIH0pO1xuICBjb25zdCBpbnRlcnZhbCA9IHNoYWxsb3dSZWYoMCk7XG4gIGNvbnN0IGFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHkgPSByZWYoe1xuICAgIHg6IG51bGwsXG4gICAgeTogbnVsbCxcbiAgICB6OiBudWxsXG4gIH0pO1xuICBmdW5jdGlvbiBpbml0KCkge1xuICAgIGlmICh3aW5kb3cpIHtcbiAgICAgIGNvbnN0IG9uRGV2aWNlTW90aW9uID0gY3JlYXRlRmlsdGVyV3JhcHBlcihcbiAgICAgICAgZXZlbnRGaWx0ZXIsXG4gICAgICAgIChldmVudCkgPT4ge1xuICAgICAgICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mLCBfZywgX2gsIF9pO1xuICAgICAgICAgIGFjY2VsZXJhdGlvbi52YWx1ZSA9IHtcbiAgICAgICAgICAgIHg6ICgoX2EgPSBldmVudC5hY2NlbGVyYXRpb24pID09IG51bGwgPyB2b2lkIDAgOiBfYS54KSB8fCBudWxsLFxuICAgICAgICAgICAgeTogKChfYiA9IGV2ZW50LmFjY2VsZXJhdGlvbikgPT0gbnVsbCA/IHZvaWQgMCA6IF9iLnkpIHx8IG51bGwsXG4gICAgICAgICAgICB6OiAoKF9jID0gZXZlbnQuYWNjZWxlcmF0aW9uKSA9PSBudWxsID8gdm9pZCAwIDogX2MueikgfHwgbnVsbFxuICAgICAgICAgIH07XG4gICAgICAgICAgYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eS52YWx1ZSA9IHtcbiAgICAgICAgICAgIHg6ICgoX2QgPSBldmVudC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5KSA9PSBudWxsID8gdm9pZCAwIDogX2QueCkgfHwgbnVsbCxcbiAgICAgICAgICAgIHk6ICgoX2UgPSBldmVudC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5KSA9PSBudWxsID8gdm9pZCAwIDogX2UueSkgfHwgbnVsbCxcbiAgICAgICAgICAgIHo6ICgoX2YgPSBldmVudC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5KSA9PSBudWxsID8gdm9pZCAwIDogX2YueikgfHwgbnVsbFxuICAgICAgICAgIH07XG4gICAgICAgICAgcm90YXRpb25SYXRlLnZhbHVlID0ge1xuICAgICAgICAgICAgYWxwaGE6ICgoX2cgPSBldmVudC5yb3RhdGlvblJhdGUpID09IG51bGwgPyB2b2lkIDAgOiBfZy5hbHBoYSkgfHwgbnVsbCxcbiAgICAgICAgICAgIGJldGE6ICgoX2ggPSBldmVudC5yb3RhdGlvblJhdGUpID09IG51bGwgPyB2b2lkIDAgOiBfaC5iZXRhKSB8fCBudWxsLFxuICAgICAgICAgICAgZ2FtbWE6ICgoX2kgPSBldmVudC5yb3RhdGlvblJhdGUpID09IG51bGwgPyB2b2lkIDAgOiBfaS5nYW1tYSkgfHwgbnVsbFxuICAgICAgICAgIH07XG4gICAgICAgICAgaW50ZXJ2YWwudmFsdWUgPSBldmVudC5pbnRlcnZhbDtcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcImRldmljZW1vdGlvblwiLCBvbkRldmljZU1vdGlvbiwgeyBwYXNzaXZlOiB0cnVlIH0pO1xuICAgIH1cbiAgfVxuICBjb25zdCBlbnN1cmVQZXJtaXNzaW9ucyA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoIXJlcXVpcmVQZXJtaXNzaW9ucy52YWx1ZSlcbiAgICAgIHBlcm1pc3Npb25HcmFudGVkLnZhbHVlID0gdHJ1ZTtcbiAgICBpZiAocGVybWlzc2lvbkdyYW50ZWQudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgaWYgKHJlcXVpcmVQZXJtaXNzaW9ucy52YWx1ZSkge1xuICAgICAgY29uc3QgcmVxdWVzdFBlcm1pc3Npb24gPSBEZXZpY2VNb3Rpb25FdmVudC5yZXF1ZXN0UGVybWlzc2lvbjtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdFBlcm1pc3Npb24oKTtcbiAgICAgICAgaWYgKHJlc3BvbnNlID09PSBcImdyYW50ZWRcIikge1xuICAgICAgICAgIHBlcm1pc3Npb25HcmFudGVkLnZhbHVlID0gdHJ1ZTtcbiAgICAgICAgICBpbml0KCk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlKSB7XG4gICAgaWYgKHJlcXVlc3RQZXJtaXNzaW9ucyAmJiByZXF1aXJlUGVybWlzc2lvbnMudmFsdWUpIHtcbiAgICAgIGVuc3VyZVBlcm1pc3Npb25zKCkudGhlbigoKSA9PiBpbml0KCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpbml0KCk7XG4gICAgfVxuICB9XG4gIHJldHVybiB7XG4gICAgYWNjZWxlcmF0aW9uLFxuICAgIGFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHksXG4gICAgcm90YXRpb25SYXRlLFxuICAgIGludGVydmFsLFxuICAgIGlzU3VwcG9ydGVkLFxuICAgIHJlcXVpcmVQZXJtaXNzaW9ucyxcbiAgICBlbnN1cmVQZXJtaXNzaW9ucyxcbiAgICBwZXJtaXNzaW9uR3JhbnRlZFxuICB9O1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlRGV2aWNlT3JpZW50YXRpb24ob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgd2luZG93ID0gZGVmYXVsdFdpbmRvdyB9ID0gb3B0aW9ucztcbiAgY29uc3QgaXNTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gd2luZG93ICYmIFwiRGV2aWNlT3JpZW50YXRpb25FdmVudFwiIGluIHdpbmRvdyk7XG4gIGNvbnN0IGlzQWJzb2x1dGUgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgYWxwaGEgPSBzaGFsbG93UmVmKG51bGwpO1xuICBjb25zdCBiZXRhID0gc2hhbGxvd1JlZihudWxsKTtcbiAgY29uc3QgZ2FtbWEgPSBzaGFsbG93UmVmKG51bGwpO1xuICBpZiAod2luZG93ICYmIGlzU3VwcG9ydGVkLnZhbHVlKSB7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3csIFwiZGV2aWNlb3JpZW50YXRpb25cIiwgKGV2ZW50KSA9PiB7XG4gICAgICBpc0Fic29sdXRlLnZhbHVlID0gZXZlbnQuYWJzb2x1dGU7XG4gICAgICBhbHBoYS52YWx1ZSA9IGV2ZW50LmFscGhhO1xuICAgICAgYmV0YS52YWx1ZSA9IGV2ZW50LmJldGE7XG4gICAgICBnYW1tYS52YWx1ZSA9IGV2ZW50LmdhbW1hO1xuICAgIH0sIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgfVxuICByZXR1cm4ge1xuICAgIGlzU3VwcG9ydGVkLFxuICAgIGlzQWJzb2x1dGUsXG4gICAgYWxwaGEsXG4gICAgYmV0YSxcbiAgICBnYW1tYVxuICB9O1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlRGV2aWNlUGl4ZWxSYXRpbyhvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3dcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHBpeGVsUmF0aW8gPSBzaGFsbG93UmVmKDEpO1xuICBjb25zdCBxdWVyeSA9IHVzZU1lZGlhUXVlcnkoKCkgPT4gYChyZXNvbHV0aW9uOiAke3BpeGVsUmF0aW8udmFsdWV9ZHBweClgLCBvcHRpb25zKTtcbiAgbGV0IHN0b3AgPSBub29wO1xuICBpZiAod2luZG93KSB7XG4gICAgc3RvcCA9IHdhdGNoSW1tZWRpYXRlKHF1ZXJ5LCAoKSA9PiBwaXhlbFJhdGlvLnZhbHVlID0gd2luZG93LmRldmljZVBpeGVsUmF0aW8pO1xuICB9XG4gIHJldHVybiB7XG4gICAgcGl4ZWxSYXRpbzogcmVhZG9ubHkocGl4ZWxSYXRpbyksXG4gICAgc3RvcFxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VEZXZpY2VzTGlzdChvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIG5hdmlnYXRvciA9IGRlZmF1bHROYXZpZ2F0b3IsXG4gICAgcmVxdWVzdFBlcm1pc3Npb25zID0gZmFsc2UsXG4gICAgY29uc3RyYWludHMgPSB7IGF1ZGlvOiB0cnVlLCB2aWRlbzogdHJ1ZSB9LFxuICAgIG9uVXBkYXRlZFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgZGV2aWNlcyA9IHJlZihbXSk7XG4gIGNvbnN0IHZpZGVvSW5wdXRzID0gY29tcHV0ZWQoKCkgPT4gZGV2aWNlcy52YWx1ZS5maWx0ZXIoKGkpID0+IGkua2luZCA9PT0gXCJ2aWRlb2lucHV0XCIpKTtcbiAgY29uc3QgYXVkaW9JbnB1dHMgPSBjb21wdXRlZCgoKSA9PiBkZXZpY2VzLnZhbHVlLmZpbHRlcigoaSkgPT4gaS5raW5kID09PSBcImF1ZGlvaW5wdXRcIikpO1xuICBjb25zdCBhdWRpb091dHB1dHMgPSBjb21wdXRlZCgoKSA9PiBkZXZpY2VzLnZhbHVlLmZpbHRlcigoaSkgPT4gaS5raW5kID09PSBcImF1ZGlvb3V0cHV0XCIpKTtcbiAgY29uc3QgaXNTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gbmF2aWdhdG9yICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMgJiYgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKTtcbiAgY29uc3QgcGVybWlzc2lvbkdyYW50ZWQgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgbGV0IHN0cmVhbTtcbiAgYXN5bmMgZnVuY3Rpb24gdXBkYXRlKCkge1xuICAgIGlmICghaXNTdXBwb3J0ZWQudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgZGV2aWNlcy52YWx1ZSA9IGF3YWl0IG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcygpO1xuICAgIG9uVXBkYXRlZCA9PSBudWxsID8gdm9pZCAwIDogb25VcGRhdGVkKGRldmljZXMudmFsdWUpO1xuICAgIGlmIChzdHJlYW0pIHtcbiAgICAgIHN0cmVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKCh0KSA9PiB0LnN0b3AoKSk7XG4gICAgICBzdHJlYW0gPSBudWxsO1xuICAgIH1cbiAgfVxuICBhc3luYyBmdW5jdGlvbiBlbnN1cmVQZXJtaXNzaW9ucygpIHtcbiAgICBjb25zdCBkZXZpY2VOYW1lID0gY29uc3RyYWludHMudmlkZW8gPyBcImNhbWVyYVwiIDogXCJtaWNyb3Bob25lXCI7XG4gICAgaWYgKCFpc1N1cHBvcnRlZC52YWx1ZSlcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICBpZiAocGVybWlzc2lvbkdyYW50ZWQudmFsdWUpXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICBjb25zdCB7IHN0YXRlLCBxdWVyeSB9ID0gdXNlUGVybWlzc2lvbihkZXZpY2VOYW1lLCB7IGNvbnRyb2xzOiB0cnVlIH0pO1xuICAgIGF3YWl0IHF1ZXJ5KCk7XG4gICAgaWYgKHN0YXRlLnZhbHVlICE9PSBcImdyYW50ZWRcIikge1xuICAgICAgbGV0IGdyYW50ZWQgPSB0cnVlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgYWxsRGV2aWNlcyA9IGF3YWl0IG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcygpO1xuICAgICAgICBjb25zdCBoYXNDYW1lcmEgPSBhbGxEZXZpY2VzLnNvbWUoKGRldmljZSkgPT4gZGV2aWNlLmtpbmQgPT09IFwidmlkZW9pbnB1dFwiKTtcbiAgICAgICAgY29uc3QgaGFzTWljcm9waG9uZSA9IGFsbERldmljZXMuc29tZSgoZGV2aWNlKSA9PiBkZXZpY2Uua2luZCA9PT0gXCJhdWRpb2lucHV0XCIgfHwgZGV2aWNlLmtpbmQgPT09IFwiYXVkaW9vdXRwdXRcIik7XG4gICAgICAgIGNvbnN0cmFpbnRzLnZpZGVvID0gaGFzQ2FtZXJhID8gY29uc3RyYWludHMudmlkZW8gOiBmYWxzZTtcbiAgICAgICAgY29uc3RyYWludHMuYXVkaW8gPSBoYXNNaWNyb3Bob25lID8gY29uc3RyYWludHMuYXVkaW8gOiBmYWxzZTtcbiAgICAgICAgc3RyZWFtID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoY29uc3RyYWludHMpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBzdHJlYW0gPSBudWxsO1xuICAgICAgICBncmFudGVkID0gZmFsc2U7XG4gICAgICB9XG4gICAgICB1cGRhdGUoKTtcbiAgICAgIHBlcm1pc3Npb25HcmFudGVkLnZhbHVlID0gZ3JhbnRlZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcGVybWlzc2lvbkdyYW50ZWQudmFsdWUgPSB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gcGVybWlzc2lvbkdyYW50ZWQudmFsdWU7XG4gIH1cbiAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlKSB7XG4gICAgaWYgKHJlcXVlc3RQZXJtaXNzaW9ucylcbiAgICAgIGVuc3VyZVBlcm1pc3Npb25zKCk7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcihuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLCBcImRldmljZWNoYW5nZVwiLCB1cGRhdGUsIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgICB1cGRhdGUoKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIGRldmljZXMsXG4gICAgZW5zdXJlUGVybWlzc2lvbnMsXG4gICAgcGVybWlzc2lvbkdyYW50ZWQsXG4gICAgdmlkZW9JbnB1dHMsXG4gICAgYXVkaW9JbnB1dHMsXG4gICAgYXVkaW9PdXRwdXRzLFxuICAgIGlzU3VwcG9ydGVkXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZURpc3BsYXlNZWRpYShvcHRpb25zID0ge30pIHtcbiAgdmFyIF9hO1xuICBjb25zdCBlbmFibGVkID0gc2hhbGxvd1JlZigoX2EgPSBvcHRpb25zLmVuYWJsZWQpICE9IG51bGwgPyBfYSA6IGZhbHNlKTtcbiAgY29uc3QgdmlkZW8gPSBvcHRpb25zLnZpZGVvO1xuICBjb25zdCBhdWRpbyA9IG9wdGlvbnMuYXVkaW87XG4gIGNvbnN0IHsgbmF2aWdhdG9yID0gZGVmYXVsdE5hdmlnYXRvciB9ID0gb3B0aW9ucztcbiAgY29uc3QgaXNTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4ge1xuICAgIHZhciBfYTI7XG4gICAgcmV0dXJuIChfYTIgPSBuYXZpZ2F0b3IgPT0gbnVsbCA/IHZvaWQgMCA6IG5hdmlnYXRvci5tZWRpYURldmljZXMpID09IG51bGwgPyB2b2lkIDAgOiBfYTIuZ2V0RGlzcGxheU1lZGlhO1xuICB9KTtcbiAgY29uc3QgY29uc3RyYWludCA9IHsgYXVkaW8sIHZpZGVvIH07XG4gIGNvbnN0IHN0cmVhbSA9IHNoYWxsb3dSZWYoKTtcbiAgYXN5bmMgZnVuY3Rpb24gX3N0YXJ0KCkge1xuICAgIHZhciBfYTI7XG4gICAgaWYgKCFpc1N1cHBvcnRlZC52YWx1ZSB8fCBzdHJlYW0udmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgc3RyZWFtLnZhbHVlID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXREaXNwbGF5TWVkaWEoY29uc3RyYWludCk7XG4gICAgKF9hMiA9IHN0cmVhbS52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5nZXRUcmFja3MoKS5mb3JFYWNoKCh0KSA9PiB1c2VFdmVudExpc3RlbmVyKHQsIFwiZW5kZWRcIiwgc3RvcCwgeyBwYXNzaXZlOiB0cnVlIH0pKTtcbiAgICByZXR1cm4gc3RyZWFtLnZhbHVlO1xuICB9XG4gIGFzeW5jIGZ1bmN0aW9uIF9zdG9wKCkge1xuICAgIHZhciBfYTI7XG4gICAgKF9hMiA9IHN0cmVhbS52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5nZXRUcmFja3MoKS5mb3JFYWNoKCh0KSA9PiB0LnN0b3AoKSk7XG4gICAgc3RyZWFtLnZhbHVlID0gdm9pZCAwO1xuICB9XG4gIGZ1bmN0aW9uIHN0b3AoKSB7XG4gICAgX3N0b3AoKTtcbiAgICBlbmFibGVkLnZhbHVlID0gZmFsc2U7XG4gIH1cbiAgYXN5bmMgZnVuY3Rpb24gc3RhcnQoKSB7XG4gICAgYXdhaXQgX3N0YXJ0KCk7XG4gICAgaWYgKHN0cmVhbS52YWx1ZSlcbiAgICAgIGVuYWJsZWQudmFsdWUgPSB0cnVlO1xuICAgIHJldHVybiBzdHJlYW0udmFsdWU7XG4gIH1cbiAgd2F0Y2goXG4gICAgZW5hYmxlZCxcbiAgICAodikgPT4ge1xuICAgICAgaWYgKHYpXG4gICAgICAgIF9zdGFydCgpO1xuICAgICAgZWxzZVxuICAgICAgICBfc3RvcCgpO1xuICAgIH0sXG4gICAgeyBpbW1lZGlhdGU6IHRydWUgfVxuICApO1xuICByZXR1cm4ge1xuICAgIGlzU3VwcG9ydGVkLFxuICAgIHN0cmVhbSxcbiAgICBzdGFydCxcbiAgICBzdG9wLFxuICAgIGVuYWJsZWRcbiAgfTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZURvY3VtZW50VmlzaWJpbGl0eShvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyBkb2N1bWVudCA9IGRlZmF1bHREb2N1bWVudCB9ID0gb3B0aW9ucztcbiAgaWYgKCFkb2N1bWVudClcbiAgICByZXR1cm4gc2hhbGxvd1JlZihcInZpc2libGVcIik7XG4gIGNvbnN0IHZpc2liaWxpdHkgPSBzaGFsbG93UmVmKGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoZG9jdW1lbnQsIFwidmlzaWJpbGl0eWNoYW5nZVwiLCAoKSA9PiB7XG4gICAgdmlzaWJpbGl0eS52YWx1ZSA9IGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZTtcbiAgfSwgeyBwYXNzaXZlOiB0cnVlIH0pO1xuICByZXR1cm4gdmlzaWJpbGl0eTtcbn1cblxuZnVuY3Rpb24gdXNlRHJhZ2dhYmxlKHRhcmdldCwgb3B0aW9ucyA9IHt9KSB7XG4gIHZhciBfYTtcbiAgY29uc3Qge1xuICAgIHBvaW50ZXJUeXBlcyxcbiAgICBwcmV2ZW50RGVmYXVsdCxcbiAgICBzdG9wUHJvcGFnYXRpb24sXG4gICAgZXhhY3QsXG4gICAgb25Nb3ZlLFxuICAgIG9uRW5kLFxuICAgIG9uU3RhcnQsXG4gICAgaW5pdGlhbFZhbHVlLFxuICAgIGF4aXMgPSBcImJvdGhcIixcbiAgICBkcmFnZ2luZ0VsZW1lbnQgPSBkZWZhdWx0V2luZG93LFxuICAgIGNvbnRhaW5lckVsZW1lbnQsXG4gICAgaGFuZGxlOiBkcmFnZ2luZ0hhbmRsZSA9IHRhcmdldCxcbiAgICBidXR0b25zID0gWzBdXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBwb3NpdGlvbiA9IHJlZihcbiAgICAoX2EgPSB0b1ZhbHVlKGluaXRpYWxWYWx1ZSkpICE9IG51bGwgPyBfYSA6IHsgeDogMCwgeTogMCB9XG4gICk7XG4gIGNvbnN0IHByZXNzZWREZWx0YSA9IHJlZigpO1xuICBjb25zdCBmaWx0ZXJFdmVudCA9IChlKSA9PiB7XG4gICAgaWYgKHBvaW50ZXJUeXBlcylcbiAgICAgIHJldHVybiBwb2ludGVyVHlwZXMuaW5jbHVkZXMoZS5wb2ludGVyVHlwZSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG4gIGNvbnN0IGhhbmRsZUV2ZW50ID0gKGUpID0+IHtcbiAgICBpZiAodG9WYWx1ZShwcmV2ZW50RGVmYXVsdCkpXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgaWYgKHRvVmFsdWUoc3RvcFByb3BhZ2F0aW9uKSlcbiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gIH07XG4gIGNvbnN0IHN0YXJ0ID0gKGUpID0+IHtcbiAgICB2YXIgX2EyO1xuICAgIGlmICghdG9WYWx1ZShidXR0b25zKS5pbmNsdWRlcyhlLmJ1dHRvbikpXG4gICAgICByZXR1cm47XG4gICAgaWYgKHRvVmFsdWUob3B0aW9ucy5kaXNhYmxlZCkgfHwgIWZpbHRlckV2ZW50KGUpKVxuICAgICAgcmV0dXJuO1xuICAgIGlmICh0b1ZhbHVlKGV4YWN0KSAmJiBlLnRhcmdldCAhPT0gdG9WYWx1ZSh0YXJnZXQpKVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRvVmFsdWUoY29udGFpbmVyRWxlbWVudCk7XG4gICAgY29uc3QgY29udGFpbmVyUmVjdCA9IChfYTIgPSBjb250YWluZXIgPT0gbnVsbCA/IHZvaWQgMCA6IGNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QpID09IG51bGwgPyB2b2lkIDAgOiBfYTIuY2FsbChjb250YWluZXIpO1xuICAgIGNvbnN0IHRhcmdldFJlY3QgPSB0b1ZhbHVlKHRhcmdldCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3QgcG9zID0ge1xuICAgICAgeDogZS5jbGllbnRYIC0gKGNvbnRhaW5lciA/IHRhcmdldFJlY3QubGVmdCAtIGNvbnRhaW5lclJlY3QubGVmdCArIGNvbnRhaW5lci5zY3JvbGxMZWZ0IDogdGFyZ2V0UmVjdC5sZWZ0KSxcbiAgICAgIHk6IGUuY2xpZW50WSAtIChjb250YWluZXIgPyB0YXJnZXRSZWN0LnRvcCAtIGNvbnRhaW5lclJlY3QudG9wICsgY29udGFpbmVyLnNjcm9sbFRvcCA6IHRhcmdldFJlY3QudG9wKVxuICAgIH07XG4gICAgaWYgKChvblN0YXJ0ID09IG51bGwgPyB2b2lkIDAgOiBvblN0YXJ0KHBvcywgZSkpID09PSBmYWxzZSlcbiAgICAgIHJldHVybjtcbiAgICBwcmVzc2VkRGVsdGEudmFsdWUgPSBwb3M7XG4gICAgaGFuZGxlRXZlbnQoZSk7XG4gIH07XG4gIGNvbnN0IG1vdmUgPSAoZSkgPT4ge1xuICAgIGlmICh0b1ZhbHVlKG9wdGlvbnMuZGlzYWJsZWQpIHx8ICFmaWx0ZXJFdmVudChlKSlcbiAgICAgIHJldHVybjtcbiAgICBpZiAoIXByZXNzZWREZWx0YS52YWx1ZSlcbiAgICAgIHJldHVybjtcbiAgICBjb25zdCBjb250YWluZXIgPSB0b1ZhbHVlKGNvbnRhaW5lckVsZW1lbnQpO1xuICAgIGNvbnN0IHRhcmdldFJlY3QgPSB0b1ZhbHVlKHRhcmdldCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgbGV0IHsgeCwgeSB9ID0gcG9zaXRpb24udmFsdWU7XG4gICAgaWYgKGF4aXMgPT09IFwieFwiIHx8IGF4aXMgPT09IFwiYm90aFwiKSB7XG4gICAgICB4ID0gZS5jbGllbnRYIC0gcHJlc3NlZERlbHRhLnZhbHVlLng7XG4gICAgICBpZiAoY29udGFpbmVyKVxuICAgICAgICB4ID0gTWF0aC5taW4oTWF0aC5tYXgoMCwgeCksIGNvbnRhaW5lci5zY3JvbGxXaWR0aCAtIHRhcmdldFJlY3Qud2lkdGgpO1xuICAgIH1cbiAgICBpZiAoYXhpcyA9PT0gXCJ5XCIgfHwgYXhpcyA9PT0gXCJib3RoXCIpIHtcbiAgICAgIHkgPSBlLmNsaWVudFkgLSBwcmVzc2VkRGVsdGEudmFsdWUueTtcbiAgICAgIGlmIChjb250YWluZXIpXG4gICAgICAgIHkgPSBNYXRoLm1pbihNYXRoLm1heCgwLCB5KSwgY29udGFpbmVyLnNjcm9sbEhlaWdodCAtIHRhcmdldFJlY3QuaGVpZ2h0KTtcbiAgICB9XG4gICAgcG9zaXRpb24udmFsdWUgPSB7XG4gICAgICB4LFxuICAgICAgeVxuICAgIH07XG4gICAgb25Nb3ZlID09IG51bGwgPyB2b2lkIDAgOiBvbk1vdmUocG9zaXRpb24udmFsdWUsIGUpO1xuICAgIGhhbmRsZUV2ZW50KGUpO1xuICB9O1xuICBjb25zdCBlbmQgPSAoZSkgPT4ge1xuICAgIGlmICh0b1ZhbHVlKG9wdGlvbnMuZGlzYWJsZWQpIHx8ICFmaWx0ZXJFdmVudChlKSlcbiAgICAgIHJldHVybjtcbiAgICBpZiAoIXByZXNzZWREZWx0YS52YWx1ZSlcbiAgICAgIHJldHVybjtcbiAgICBwcmVzc2VkRGVsdGEudmFsdWUgPSB2b2lkIDA7XG4gICAgb25FbmQgPT0gbnVsbCA/IHZvaWQgMCA6IG9uRW5kKHBvc2l0aW9uLnZhbHVlLCBlKTtcbiAgICBoYW5kbGVFdmVudChlKTtcbiAgfTtcbiAgaWYgKGlzQ2xpZW50KSB7XG4gICAgY29uc3QgY29uZmlnID0gKCkgPT4ge1xuICAgICAgdmFyIF9hMjtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNhcHR1cmU6IChfYTIgPSBvcHRpb25zLmNhcHR1cmUpICE9IG51bGwgPyBfYTIgOiB0cnVlLFxuICAgICAgICBwYXNzaXZlOiAhdG9WYWx1ZShwcmV2ZW50RGVmYXVsdClcbiAgICAgIH07XG4gICAgfTtcbiAgICB1c2VFdmVudExpc3RlbmVyKGRyYWdnaW5nSGFuZGxlLCBcInBvaW50ZXJkb3duXCIsIHN0YXJ0LCBjb25maWcpO1xuICAgIHVzZUV2ZW50TGlzdGVuZXIoZHJhZ2dpbmdFbGVtZW50LCBcInBvaW50ZXJtb3ZlXCIsIG1vdmUsIGNvbmZpZyk7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcihkcmFnZ2luZ0VsZW1lbnQsIFwicG9pbnRlcnVwXCIsIGVuZCwgY29uZmlnKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIC4uLnRvUmVmcyhwb3NpdGlvbiksXG4gICAgcG9zaXRpb24sXG4gICAgaXNEcmFnZ2luZzogY29tcHV0ZWQoKCkgPT4gISFwcmVzc2VkRGVsdGEudmFsdWUpLFxuICAgIHN0eWxlOiBjb21wdXRlZChcbiAgICAgICgpID0+IGBsZWZ0OiR7cG9zaXRpb24udmFsdWUueH1weDt0b3A6JHtwb3NpdGlvbi52YWx1ZS55fXB4O2BcbiAgICApXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZURyb3Bab25lKHRhcmdldCwgb3B0aW9ucyA9IHt9KSB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IGlzT3ZlckRyb3Bab25lID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IGZpbGVzID0gc2hhbGxvd1JlZihudWxsKTtcbiAgbGV0IGNvdW50ZXIgPSAwO1xuICBsZXQgaXNWYWxpZCA9IHRydWU7XG4gIGlmIChpc0NsaWVudCkge1xuICAgIGNvbnN0IF9vcHRpb25zID0gdHlwZW9mIG9wdGlvbnMgPT09IFwiZnVuY3Rpb25cIiA/IHsgb25Ecm9wOiBvcHRpb25zIH0gOiBvcHRpb25zO1xuICAgIGNvbnN0IG11bHRpcGxlID0gKF9hID0gX29wdGlvbnMubXVsdGlwbGUpICE9IG51bGwgPyBfYSA6IHRydWU7XG4gICAgY29uc3QgcHJldmVudERlZmF1bHRGb3JVbmhhbmRsZWQgPSAoX2IgPSBfb3B0aW9ucy5wcmV2ZW50RGVmYXVsdEZvclVuaGFuZGxlZCkgIT0gbnVsbCA/IF9iIDogZmFsc2U7XG4gICAgY29uc3QgZ2V0RmlsZXMgPSAoZXZlbnQpID0+IHtcbiAgICAgIHZhciBfYTIsIF9iMjtcbiAgICAgIGNvbnN0IGxpc3QgPSBBcnJheS5mcm9tKChfYjIgPSAoX2EyID0gZXZlbnQuZGF0YVRyYW5zZmVyKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLmZpbGVzKSAhPSBudWxsID8gX2IyIDogW10pO1xuICAgICAgcmV0dXJuIGxpc3QubGVuZ3RoID09PSAwID8gbnVsbCA6IG11bHRpcGxlID8gbGlzdCA6IFtsaXN0WzBdXTtcbiAgICB9O1xuICAgIGNvbnN0IGNoZWNrRGF0YVR5cGVzID0gKHR5cGVzKSA9PiB7XG4gICAgICBjb25zdCBkYXRhVHlwZXMgPSB1bnJlZihfb3B0aW9ucy5kYXRhVHlwZXMpO1xuICAgICAgaWYgKHR5cGVvZiBkYXRhVHlwZXMgPT09IFwiZnVuY3Rpb25cIilcbiAgICAgICAgcmV0dXJuIGRhdGFUeXBlcyh0eXBlcyk7XG4gICAgICBpZiAoIShkYXRhVHlwZXMgPT0gbnVsbCA/IHZvaWQgMCA6IGRhdGFUeXBlcy5sZW5ndGgpKVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIGlmICh0eXBlcy5sZW5ndGggPT09IDApXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIHJldHVybiB0eXBlcy5ldmVyeShcbiAgICAgICAgKHR5cGUpID0+IGRhdGFUeXBlcy5zb21lKChhbGxvd2VkVHlwZSkgPT4gdHlwZS5pbmNsdWRlcyhhbGxvd2VkVHlwZSkpXG4gICAgICApO1xuICAgIH07XG4gICAgY29uc3QgY2hlY2tWYWxpZGl0eSA9IChpdGVtcykgPT4ge1xuICAgICAgY29uc3QgdHlwZXMgPSBBcnJheS5mcm9tKGl0ZW1zICE9IG51bGwgPyBpdGVtcyA6IFtdKS5tYXAoKGl0ZW0pID0+IGl0ZW0udHlwZSk7XG4gICAgICBjb25zdCBkYXRhVHlwZXNWYWxpZCA9IGNoZWNrRGF0YVR5cGVzKHR5cGVzKTtcbiAgICAgIGNvbnN0IG11bHRpcGxlRmlsZXNWYWxpZCA9IG11bHRpcGxlIHx8IGl0ZW1zLmxlbmd0aCA8PSAxO1xuICAgICAgcmV0dXJuIGRhdGFUeXBlc1ZhbGlkICYmIG11bHRpcGxlRmlsZXNWYWxpZDtcbiAgICB9O1xuICAgIGNvbnN0IGlzU2FmYXJpID0gKCkgPT4gL14oPzooPyFjaHJvbWV8YW5kcm9pZCkuKSpzYWZhcmkvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpICYmICEoXCJjaHJvbWVcIiBpbiB3aW5kb3cpO1xuICAgIGNvbnN0IGhhbmRsZURyYWdFdmVudCA9IChldmVudCwgZXZlbnRUeXBlKSA9PiB7XG4gICAgICB2YXIgX2EyLCBfYjIsIF9jLCBfZCwgX2UsIF9mO1xuICAgICAgY29uc3QgZGF0YVRyYW5zZmVySXRlbUxpc3QgPSAoX2EyID0gZXZlbnQuZGF0YVRyYW5zZmVyKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLml0ZW1zO1xuICAgICAgaXNWYWxpZCA9IChfYjIgPSBkYXRhVHJhbnNmZXJJdGVtTGlzdCAmJiBjaGVja1ZhbGlkaXR5KGRhdGFUcmFuc2Zlckl0ZW1MaXN0KSkgIT0gbnVsbCA/IF9iMiA6IGZhbHNlO1xuICAgICAgaWYgKHByZXZlbnREZWZhdWx0Rm9yVW5oYW5kbGVkKSB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB9XG4gICAgICBpZiAoIWlzU2FmYXJpKCkgJiYgIWlzVmFsaWQpIHtcbiAgICAgICAgaWYgKGV2ZW50LmRhdGFUcmFuc2Zlcikge1xuICAgICAgICAgIGV2ZW50LmRhdGFUcmFuc2Zlci5kcm9wRWZmZWN0ID0gXCJub25lXCI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGlmIChldmVudC5kYXRhVHJhbnNmZXIpIHtcbiAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLmRyb3BFZmZlY3QgPSBcImNvcHlcIjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGN1cnJlbnRGaWxlcyA9IGdldEZpbGVzKGV2ZW50KTtcbiAgICAgIHN3aXRjaCAoZXZlbnRUeXBlKSB7XG4gICAgICAgIGNhc2UgXCJlbnRlclwiOlxuICAgICAgICAgIGNvdW50ZXIgKz0gMTtcbiAgICAgICAgICBpc092ZXJEcm9wWm9uZS52YWx1ZSA9IHRydWU7XG4gICAgICAgICAgKF9jID0gX29wdGlvbnMub25FbnRlcikgPT0gbnVsbCA/IHZvaWQgMCA6IF9jLmNhbGwoX29wdGlvbnMsIG51bGwsIGV2ZW50KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcIm92ZXJcIjpcbiAgICAgICAgICAoX2QgPSBfb3B0aW9ucy5vbk92ZXIpID09IG51bGwgPyB2b2lkIDAgOiBfZC5jYWxsKF9vcHRpb25zLCBudWxsLCBldmVudCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgXCJsZWF2ZVwiOlxuICAgICAgICAgIGNvdW50ZXIgLT0gMTtcbiAgICAgICAgICBpZiAoY291bnRlciA9PT0gMClcbiAgICAgICAgICAgIGlzT3ZlckRyb3Bab25lLnZhbHVlID0gZmFsc2U7XG4gICAgICAgICAgKF9lID0gX29wdGlvbnMub25MZWF2ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9lLmNhbGwoX29wdGlvbnMsIG51bGwsIGV2ZW50KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcImRyb3BcIjpcbiAgICAgICAgICBjb3VudGVyID0gMDtcbiAgICAgICAgICBpc092ZXJEcm9wWm9uZS52YWx1ZSA9IGZhbHNlO1xuICAgICAgICAgIGlmIChpc1ZhbGlkKSB7XG4gICAgICAgICAgICBmaWxlcy52YWx1ZSA9IGN1cnJlbnRGaWxlcztcbiAgICAgICAgICAgIChfZiA9IF9vcHRpb25zLm9uRHJvcCkgPT0gbnVsbCA/IHZvaWQgMCA6IF9mLmNhbGwoX29wdGlvbnMsIGN1cnJlbnRGaWxlcywgZXZlbnQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9O1xuICAgIHVzZUV2ZW50TGlzdGVuZXIodGFyZ2V0LCBcImRyYWdlbnRlclwiLCAoZXZlbnQpID0+IGhhbmRsZURyYWdFdmVudChldmVudCwgXCJlbnRlclwiKSk7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcih0YXJnZXQsIFwiZHJhZ292ZXJcIiwgKGV2ZW50KSA9PiBoYW5kbGVEcmFnRXZlbnQoZXZlbnQsIFwib3ZlclwiKSk7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcih0YXJnZXQsIFwiZHJhZ2xlYXZlXCIsIChldmVudCkgPT4gaGFuZGxlRHJhZ0V2ZW50KGV2ZW50LCBcImxlYXZlXCIpKTtcbiAgICB1c2VFdmVudExpc3RlbmVyKHRhcmdldCwgXCJkcm9wXCIsIChldmVudCkgPT4gaGFuZGxlRHJhZ0V2ZW50KGV2ZW50LCBcImRyb3BcIikpO1xuICB9XG4gIHJldHVybiB7XG4gICAgZmlsZXMsXG4gICAgaXNPdmVyRHJvcFpvbmVcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlUmVzaXplT2JzZXJ2ZXIodGFyZ2V0LCBjYWxsYmFjaywgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgd2luZG93ID0gZGVmYXVsdFdpbmRvdywgLi4ub2JzZXJ2ZXJPcHRpb25zIH0gPSBvcHRpb25zO1xuICBsZXQgb2JzZXJ2ZXI7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHdpbmRvdyAmJiBcIlJlc2l6ZU9ic2VydmVyXCIgaW4gd2luZG93KTtcbiAgY29uc3QgY2xlYW51cCA9ICgpID0+IHtcbiAgICBpZiAob2JzZXJ2ZXIpIHtcbiAgICAgIG9ic2VydmVyLmRpc2Nvbm5lY3QoKTtcbiAgICAgIG9ic2VydmVyID0gdm9pZCAwO1xuICAgIH1cbiAgfTtcbiAgY29uc3QgdGFyZ2V0cyA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICBjb25zdCBfdGFyZ2V0cyA9IHRvVmFsdWUodGFyZ2V0KTtcbiAgICByZXR1cm4gQXJyYXkuaXNBcnJheShfdGFyZ2V0cykgPyBfdGFyZ2V0cy5tYXAoKGVsKSA9PiB1bnJlZkVsZW1lbnQoZWwpKSA6IFt1bnJlZkVsZW1lbnQoX3RhcmdldHMpXTtcbiAgfSk7XG4gIGNvbnN0IHN0b3BXYXRjaCA9IHdhdGNoKFxuICAgIHRhcmdldHMsXG4gICAgKGVscykgPT4ge1xuICAgICAgY2xlYW51cCgpO1xuICAgICAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlICYmIHdpbmRvdykge1xuICAgICAgICBvYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcihjYWxsYmFjayk7XG4gICAgICAgIGZvciAoY29uc3QgX2VsIG9mIGVscykge1xuICAgICAgICAgIGlmIChfZWwpXG4gICAgICAgICAgICBvYnNlcnZlci5vYnNlcnZlKF9lbCwgb2JzZXJ2ZXJPcHRpb25zKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gICAgeyBpbW1lZGlhdGU6IHRydWUsIGZsdXNoOiBcInBvc3RcIiB9XG4gICk7XG4gIGNvbnN0IHN0b3AgPSAoKSA9PiB7XG4gICAgY2xlYW51cCgpO1xuICAgIHN0b3BXYXRjaCgpO1xuICB9O1xuICB0cnlPblNjb3BlRGlzcG9zZShzdG9wKTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBzdG9wXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZUVsZW1lbnRCb3VuZGluZyh0YXJnZXQsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgcmVzZXQgPSB0cnVlLFxuICAgIHdpbmRvd1Jlc2l6ZSA9IHRydWUsXG4gICAgd2luZG93U2Nyb2xsID0gdHJ1ZSxcbiAgICBpbW1lZGlhdGUgPSB0cnVlLFxuICAgIHVwZGF0ZVRpbWluZyA9IFwic3luY1wiXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBoZWlnaHQgPSBzaGFsbG93UmVmKDApO1xuICBjb25zdCBib3R0b20gPSBzaGFsbG93UmVmKDApO1xuICBjb25zdCBsZWZ0ID0gc2hhbGxvd1JlZigwKTtcbiAgY29uc3QgcmlnaHQgPSBzaGFsbG93UmVmKDApO1xuICBjb25zdCB0b3AgPSBzaGFsbG93UmVmKDApO1xuICBjb25zdCB3aWR0aCA9IHNoYWxsb3dSZWYoMCk7XG4gIGNvbnN0IHggPSBzaGFsbG93UmVmKDApO1xuICBjb25zdCB5ID0gc2hhbGxvd1JlZigwKTtcbiAgZnVuY3Rpb24gcmVjYWxjdWxhdGUoKSB7XG4gICAgY29uc3QgZWwgPSB1bnJlZkVsZW1lbnQodGFyZ2V0KTtcbiAgICBpZiAoIWVsKSB7XG4gICAgICBpZiAocmVzZXQpIHtcbiAgICAgICAgaGVpZ2h0LnZhbHVlID0gMDtcbiAgICAgICAgYm90dG9tLnZhbHVlID0gMDtcbiAgICAgICAgbGVmdC52YWx1ZSA9IDA7XG4gICAgICAgIHJpZ2h0LnZhbHVlID0gMDtcbiAgICAgICAgdG9wLnZhbHVlID0gMDtcbiAgICAgICAgd2lkdGgudmFsdWUgPSAwO1xuICAgICAgICB4LnZhbHVlID0gMDtcbiAgICAgICAgeS52YWx1ZSA9IDA7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHJlY3QgPSBlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBoZWlnaHQudmFsdWUgPSByZWN0LmhlaWdodDtcbiAgICBib3R0b20udmFsdWUgPSByZWN0LmJvdHRvbTtcbiAgICBsZWZ0LnZhbHVlID0gcmVjdC5sZWZ0O1xuICAgIHJpZ2h0LnZhbHVlID0gcmVjdC5yaWdodDtcbiAgICB0b3AudmFsdWUgPSByZWN0LnRvcDtcbiAgICB3aWR0aC52YWx1ZSA9IHJlY3Qud2lkdGg7XG4gICAgeC52YWx1ZSA9IHJlY3QueDtcbiAgICB5LnZhbHVlID0gcmVjdC55O1xuICB9XG4gIGZ1bmN0aW9uIHVwZGF0ZSgpIHtcbiAgICBpZiAodXBkYXRlVGltaW5nID09PSBcInN5bmNcIilcbiAgICAgIHJlY2FsY3VsYXRlKCk7XG4gICAgZWxzZSBpZiAodXBkYXRlVGltaW5nID09PSBcIm5leHQtZnJhbWVcIilcbiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiByZWNhbGN1bGF0ZSgpKTtcbiAgfVxuICB1c2VSZXNpemVPYnNlcnZlcih0YXJnZXQsIHVwZGF0ZSk7XG4gIHdhdGNoKCgpID0+IHVucmVmRWxlbWVudCh0YXJnZXQpLCAoZWxlKSA9PiAhZWxlICYmIHVwZGF0ZSgpKTtcbiAgdXNlTXV0YXRpb25PYnNlcnZlcih0YXJnZXQsIHVwZGF0ZSwge1xuICAgIGF0dHJpYnV0ZUZpbHRlcjogW1wic3R5bGVcIiwgXCJjbGFzc1wiXVxuICB9KTtcbiAgaWYgKHdpbmRvd1Njcm9sbClcbiAgICB1c2VFdmVudExpc3RlbmVyKFwic2Nyb2xsXCIsIHVwZGF0ZSwgeyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH0pO1xuICBpZiAod2luZG93UmVzaXplKVxuICAgIHVzZUV2ZW50TGlzdGVuZXIoXCJyZXNpemVcIiwgdXBkYXRlLCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gIHRyeU9uTW91bnRlZCgoKSA9PiB7XG4gICAgaWYgKGltbWVkaWF0ZSlcbiAgICAgIHVwZGF0ZSgpO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBoZWlnaHQsXG4gICAgYm90dG9tLFxuICAgIGxlZnQsXG4gICAgcmlnaHQsXG4gICAgdG9wLFxuICAgIHdpZHRoLFxuICAgIHgsXG4gICAgeSxcbiAgICB1cGRhdGVcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlRWxlbWVudEJ5UG9pbnQob3B0aW9ucykge1xuICBjb25zdCB7XG4gICAgeCxcbiAgICB5LFxuICAgIGRvY3VtZW50ID0gZGVmYXVsdERvY3VtZW50LFxuICAgIG11bHRpcGxlLFxuICAgIGludGVydmFsID0gXCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWVcIixcbiAgICBpbW1lZGlhdGUgPSB0cnVlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiB7XG4gICAgaWYgKHRvVmFsdWUobXVsdGlwbGUpKVxuICAgICAgcmV0dXJuIGRvY3VtZW50ICYmIFwiZWxlbWVudHNGcm9tUG9pbnRcIiBpbiBkb2N1bWVudDtcbiAgICByZXR1cm4gZG9jdW1lbnQgJiYgXCJlbGVtZW50RnJvbVBvaW50XCIgaW4gZG9jdW1lbnQ7XG4gIH0pO1xuICBjb25zdCBlbGVtZW50ID0gc2hhbGxvd1JlZihudWxsKTtcbiAgY29uc3QgY2IgPSAoKSA9PiB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBlbGVtZW50LnZhbHVlID0gdG9WYWx1ZShtdWx0aXBsZSkgPyAoX2EgPSBkb2N1bWVudCA9PSBudWxsID8gdm9pZCAwIDogZG9jdW1lbnQuZWxlbWVudHNGcm9tUG9pbnQodG9WYWx1ZSh4KSwgdG9WYWx1ZSh5KSkpICE9IG51bGwgPyBfYSA6IFtdIDogKF9iID0gZG9jdW1lbnQgPT0gbnVsbCA/IHZvaWQgMCA6IGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQodG9WYWx1ZSh4KSwgdG9WYWx1ZSh5KSkpICE9IG51bGwgPyBfYiA6IG51bGw7XG4gIH07XG4gIGNvbnN0IGNvbnRyb2xzID0gaW50ZXJ2YWwgPT09IFwicmVxdWVzdEFuaW1hdGlvbkZyYW1lXCIgPyB1c2VSYWZGbihjYiwgeyBpbW1lZGlhdGUgfSkgOiB1c2VJbnRlcnZhbEZuKGNiLCBpbnRlcnZhbCwgeyBpbW1lZGlhdGUgfSk7XG4gIHJldHVybiB7XG4gICAgaXNTdXBwb3J0ZWQsXG4gICAgZWxlbWVudCxcbiAgICAuLi5jb250cm9sc1xuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VFbGVtZW50SG92ZXIoZWwsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgZGVsYXlFbnRlciA9IDAsXG4gICAgZGVsYXlMZWF2ZSA9IDAsXG4gICAgdHJpZ2dlck9uUmVtb3ZhbCA9IGZhbHNlLFxuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3dcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGlzSG92ZXJlZCA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBsZXQgdGltZXI7XG4gIGNvbnN0IHRvZ2dsZSA9IChlbnRlcmluZykgPT4ge1xuICAgIGNvbnN0IGRlbGF5ID0gZW50ZXJpbmcgPyBkZWxheUVudGVyIDogZGVsYXlMZWF2ZTtcbiAgICBpZiAodGltZXIpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICB0aW1lciA9IHZvaWQgMDtcbiAgICB9XG4gICAgaWYgKGRlbGF5KVxuICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IGlzSG92ZXJlZC52YWx1ZSA9IGVudGVyaW5nLCBkZWxheSk7XG4gICAgZWxzZVxuICAgICAgaXNIb3ZlcmVkLnZhbHVlID0gZW50ZXJpbmc7XG4gIH07XG4gIGlmICghd2luZG93KVxuICAgIHJldHVybiBpc0hvdmVyZWQ7XG4gIHVzZUV2ZW50TGlzdGVuZXIoZWwsIFwibW91c2VlbnRlclwiLCAoKSA9PiB0b2dnbGUodHJ1ZSksIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgdXNlRXZlbnRMaXN0ZW5lcihlbCwgXCJtb3VzZWxlYXZlXCIsICgpID0+IHRvZ2dsZShmYWxzZSksIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgaWYgKHRyaWdnZXJPblJlbW92YWwpIHtcbiAgICBvbkVsZW1lbnRSZW1vdmFsKFxuICAgICAgY29tcHV0ZWQoKCkgPT4gdW5yZWZFbGVtZW50KGVsKSksXG4gICAgICAoKSA9PiB0b2dnbGUoZmFsc2UpXG4gICAgKTtcbiAgfVxuICByZXR1cm4gaXNIb3ZlcmVkO1xufVxuXG5mdW5jdGlvbiB1c2VFbGVtZW50U2l6ZSh0YXJnZXQsIGluaXRpYWxTaXplID0geyB3aWR0aDogMCwgaGVpZ2h0OiAwIH0sIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7IHdpbmRvdyA9IGRlZmF1bHRXaW5kb3csIGJveCA9IFwiY29udGVudC1ib3hcIiB9ID0gb3B0aW9ucztcbiAgY29uc3QgaXNTVkcgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICByZXR1cm4gKF9iID0gKF9hID0gdW5yZWZFbGVtZW50KHRhcmdldCkpID09IG51bGwgPyB2b2lkIDAgOiBfYS5uYW1lc3BhY2VVUkkpID09IG51bGwgPyB2b2lkIDAgOiBfYi5pbmNsdWRlcyhcInN2Z1wiKTtcbiAgfSk7XG4gIGNvbnN0IHdpZHRoID0gc2hhbGxvd1JlZihpbml0aWFsU2l6ZS53aWR0aCk7XG4gIGNvbnN0IGhlaWdodCA9IHNoYWxsb3dSZWYoaW5pdGlhbFNpemUuaGVpZ2h0KTtcbiAgY29uc3QgeyBzdG9wOiBzdG9wMSB9ID0gdXNlUmVzaXplT2JzZXJ2ZXIoXG4gICAgdGFyZ2V0LFxuICAgIChbZW50cnldKSA9PiB7XG4gICAgICBjb25zdCBib3hTaXplID0gYm94ID09PSBcImJvcmRlci1ib3hcIiA/IGVudHJ5LmJvcmRlckJveFNpemUgOiBib3ggPT09IFwiY29udGVudC1ib3hcIiA/IGVudHJ5LmNvbnRlbnRCb3hTaXplIDogZW50cnkuZGV2aWNlUGl4ZWxDb250ZW50Qm94U2l6ZTtcbiAgICAgIGlmICh3aW5kb3cgJiYgaXNTVkcudmFsdWUpIHtcbiAgICAgICAgY29uc3QgJGVsZW0gPSB1bnJlZkVsZW1lbnQodGFyZ2V0KTtcbiAgICAgICAgaWYgKCRlbGVtKSB7XG4gICAgICAgICAgY29uc3QgcmVjdCA9ICRlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICAgIHdpZHRoLnZhbHVlID0gcmVjdC53aWR0aDtcbiAgICAgICAgICBoZWlnaHQudmFsdWUgPSByZWN0LmhlaWdodDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGJveFNpemUpIHtcbiAgICAgICAgICBjb25zdCBmb3JtYXRCb3hTaXplID0gdG9BcnJheShib3hTaXplKTtcbiAgICAgICAgICB3aWR0aC52YWx1ZSA9IGZvcm1hdEJveFNpemUucmVkdWNlKChhY2MsIHsgaW5saW5lU2l6ZSB9KSA9PiBhY2MgKyBpbmxpbmVTaXplLCAwKTtcbiAgICAgICAgICBoZWlnaHQudmFsdWUgPSBmb3JtYXRCb3hTaXplLnJlZHVjZSgoYWNjLCB7IGJsb2NrU2l6ZSB9KSA9PiBhY2MgKyBibG9ja1NpemUsIDApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHdpZHRoLnZhbHVlID0gZW50cnkuY29udGVudFJlY3Qud2lkdGg7XG4gICAgICAgICAgaGVpZ2h0LnZhbHVlID0gZW50cnkuY29udGVudFJlY3QuaGVpZ2h0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSxcbiAgICBvcHRpb25zXG4gICk7XG4gIHRyeU9uTW91bnRlZCgoKSA9PiB7XG4gICAgY29uc3QgZWxlID0gdW5yZWZFbGVtZW50KHRhcmdldCk7XG4gICAgaWYgKGVsZSkge1xuICAgICAgd2lkdGgudmFsdWUgPSBcIm9mZnNldFdpZHRoXCIgaW4gZWxlID8gZWxlLm9mZnNldFdpZHRoIDogaW5pdGlhbFNpemUud2lkdGg7XG4gICAgICBoZWlnaHQudmFsdWUgPSBcIm9mZnNldEhlaWdodFwiIGluIGVsZSA/IGVsZS5vZmZzZXRIZWlnaHQgOiBpbml0aWFsU2l6ZS5oZWlnaHQ7XG4gICAgfVxuICB9KTtcbiAgY29uc3Qgc3RvcDIgPSB3YXRjaChcbiAgICAoKSA9PiB1bnJlZkVsZW1lbnQodGFyZ2V0KSxcbiAgICAoZWxlKSA9PiB7XG4gICAgICB3aWR0aC52YWx1ZSA9IGVsZSA/IGluaXRpYWxTaXplLndpZHRoIDogMDtcbiAgICAgIGhlaWdodC52YWx1ZSA9IGVsZSA/IGluaXRpYWxTaXplLmhlaWdodCA6IDA7XG4gICAgfVxuICApO1xuICBmdW5jdGlvbiBzdG9wKCkge1xuICAgIHN0b3AxKCk7XG4gICAgc3RvcDIoKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIHdpZHRoLFxuICAgIGhlaWdodCxcbiAgICBzdG9wXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZUludGVyc2VjdGlvbk9ic2VydmVyKHRhcmdldCwgY2FsbGJhY2ssIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgcm9vdCxcbiAgICByb290TWFyZ2luID0gXCIwcHhcIixcbiAgICB0aHJlc2hvbGQgPSAwLFxuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3csXG4gICAgaW1tZWRpYXRlID0gdHJ1ZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgaXNTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gd2luZG93ICYmIFwiSW50ZXJzZWN0aW9uT2JzZXJ2ZXJcIiBpbiB3aW5kb3cpO1xuICBjb25zdCB0YXJnZXRzID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGNvbnN0IF90YXJnZXQgPSB0b1ZhbHVlKHRhcmdldCk7XG4gICAgcmV0dXJuIHRvQXJyYXkoX3RhcmdldCkubWFwKHVucmVmRWxlbWVudCkuZmlsdGVyKG5vdE51bGxpc2gpO1xuICB9KTtcbiAgbGV0IGNsZWFudXAgPSBub29wO1xuICBjb25zdCBpc0FjdGl2ZSA9IHNoYWxsb3dSZWYoaW1tZWRpYXRlKTtcbiAgY29uc3Qgc3RvcFdhdGNoID0gaXNTdXBwb3J0ZWQudmFsdWUgPyB3YXRjaChcbiAgICAoKSA9PiBbdGFyZ2V0cy52YWx1ZSwgdW5yZWZFbGVtZW50KHJvb3QpLCBpc0FjdGl2ZS52YWx1ZV0sXG4gICAgKFt0YXJnZXRzMiwgcm9vdDJdKSA9PiB7XG4gICAgICBjbGVhbnVwKCk7XG4gICAgICBpZiAoIWlzQWN0aXZlLnZhbHVlKVxuICAgICAgICByZXR1cm47XG4gICAgICBpZiAoIXRhcmdldHMyLmxlbmd0aClcbiAgICAgICAgcmV0dXJuO1xuICAgICAgY29uc3Qgb2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoXG4gICAgICAgIGNhbGxiYWNrLFxuICAgICAgICB7XG4gICAgICAgICAgcm9vdDogdW5yZWZFbGVtZW50KHJvb3QyKSxcbiAgICAgICAgICByb290TWFyZ2luLFxuICAgICAgICAgIHRocmVzaG9sZFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgdGFyZ2V0czIuZm9yRWFjaCgoZWwpID0+IGVsICYmIG9ic2VydmVyLm9ic2VydmUoZWwpKTtcbiAgICAgIGNsZWFudXAgPSAoKSA9PiB7XG4gICAgICAgIG9ic2VydmVyLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgY2xlYW51cCA9IG5vb3A7XG4gICAgICB9O1xuICAgIH0sXG4gICAgeyBpbW1lZGlhdGUsIGZsdXNoOiBcInBvc3RcIiB9XG4gICkgOiBub29wO1xuICBjb25zdCBzdG9wID0gKCkgPT4ge1xuICAgIGNsZWFudXAoKTtcbiAgICBzdG9wV2F0Y2goKTtcbiAgICBpc0FjdGl2ZS52YWx1ZSA9IGZhbHNlO1xuICB9O1xuICB0cnlPblNjb3BlRGlzcG9zZShzdG9wKTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBpc0FjdGl2ZSxcbiAgICBwYXVzZSgpIHtcbiAgICAgIGNsZWFudXAoKTtcbiAgICAgIGlzQWN0aXZlLnZhbHVlID0gZmFsc2U7XG4gICAgfSxcbiAgICByZXN1bWUoKSB7XG4gICAgICBpc0FjdGl2ZS52YWx1ZSA9IHRydWU7XG4gICAgfSxcbiAgICBzdG9wXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZUVsZW1lbnRWaXNpYmlsaXR5KGVsZW1lbnQsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgd2luZG93ID0gZGVmYXVsdFdpbmRvdyxcbiAgICBzY3JvbGxUYXJnZXQsXG4gICAgdGhyZXNob2xkID0gMCxcbiAgICByb290TWFyZ2luLFxuICAgIG9uY2UgPSBmYWxzZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgZWxlbWVudElzVmlzaWJsZSA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCB7IHN0b3AgfSA9IHVzZUludGVyc2VjdGlvbk9ic2VydmVyKFxuICAgIGVsZW1lbnQsXG4gICAgKGludGVyc2VjdGlvbk9ic2VydmVyRW50cmllcykgPT4ge1xuICAgICAgbGV0IGlzSW50ZXJzZWN0aW5nID0gZWxlbWVudElzVmlzaWJsZS52YWx1ZTtcbiAgICAgIGxldCBsYXRlc3RUaW1lID0gMDtcbiAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgaW50ZXJzZWN0aW9uT2JzZXJ2ZXJFbnRyaWVzKSB7XG4gICAgICAgIGlmIChlbnRyeS50aW1lID49IGxhdGVzdFRpbWUpIHtcbiAgICAgICAgICBsYXRlc3RUaW1lID0gZW50cnkudGltZTtcbiAgICAgICAgICBpc0ludGVyc2VjdGluZyA9IGVudHJ5LmlzSW50ZXJzZWN0aW5nO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBlbGVtZW50SXNWaXNpYmxlLnZhbHVlID0gaXNJbnRlcnNlY3Rpbmc7XG4gICAgICBpZiAob25jZSkge1xuICAgICAgICB3YXRjaE9uY2UoZWxlbWVudElzVmlzaWJsZSwgKCkgPT4ge1xuICAgICAgICAgIHN0b3AoKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSxcbiAgICB7XG4gICAgICByb290OiBzY3JvbGxUYXJnZXQsXG4gICAgICB3aW5kb3csXG4gICAgICB0aHJlc2hvbGQsXG4gICAgICByb290TWFyZ2luOiB0b1ZhbHVlKHJvb3RNYXJnaW4pXG4gICAgfVxuICApO1xuICByZXR1cm4gZWxlbWVudElzVmlzaWJsZTtcbn1cblxuY29uc3QgZXZlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTtcblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUV2ZW50QnVzKGtleSkge1xuICBjb25zdCBzY29wZSA9IGdldEN1cnJlbnRTY29wZSgpO1xuICBmdW5jdGlvbiBvbihsaXN0ZW5lcikge1xuICAgIHZhciBfYTtcbiAgICBjb25zdCBsaXN0ZW5lcnMgPSBldmVudHMuZ2V0KGtleSkgfHwgLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTtcbiAgICBsaXN0ZW5lcnMuYWRkKGxpc3RlbmVyKTtcbiAgICBldmVudHMuc2V0KGtleSwgbGlzdGVuZXJzKTtcbiAgICBjb25zdCBfb2ZmID0gKCkgPT4gb2ZmKGxpc3RlbmVyKTtcbiAgICAoX2EgPSBzY29wZSA9PSBudWxsID8gdm9pZCAwIDogc2NvcGUuY2xlYW51cHMpID09IG51bGwgPyB2b2lkIDAgOiBfYS5wdXNoKF9vZmYpO1xuICAgIHJldHVybiBfb2ZmO1xuICB9XG4gIGZ1bmN0aW9uIG9uY2UobGlzdGVuZXIpIHtcbiAgICBmdW5jdGlvbiBfbGlzdGVuZXIoLi4uYXJncykge1xuICAgICAgb2ZmKF9saXN0ZW5lcik7XG4gICAgICBsaXN0ZW5lciguLi5hcmdzKTtcbiAgICB9XG4gICAgcmV0dXJuIG9uKF9saXN0ZW5lcik7XG4gIH1cbiAgZnVuY3Rpb24gb2ZmKGxpc3RlbmVyKSB7XG4gICAgY29uc3QgbGlzdGVuZXJzID0gZXZlbnRzLmdldChrZXkpO1xuICAgIGlmICghbGlzdGVuZXJzKVxuICAgICAgcmV0dXJuO1xuICAgIGxpc3RlbmVycy5kZWxldGUobGlzdGVuZXIpO1xuICAgIGlmICghbGlzdGVuZXJzLnNpemUpXG4gICAgICByZXNldCgpO1xuICB9XG4gIGZ1bmN0aW9uIHJlc2V0KCkge1xuICAgIGV2ZW50cy5kZWxldGUoa2V5KTtcbiAgfVxuICBmdW5jdGlvbiBlbWl0KGV2ZW50LCBwYXlsb2FkKSB7XG4gICAgdmFyIF9hO1xuICAgIChfYSA9IGV2ZW50cy5nZXQoa2V5KSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmZvckVhY2goKHYpID0+IHYoZXZlbnQsIHBheWxvYWQpKTtcbiAgfVxuICByZXR1cm4geyBvbiwgb25jZSwgb2ZmLCBlbWl0LCByZXNldCB9O1xufVxuXG5mdW5jdGlvbiByZXNvbHZlTmVzdGVkT3B0aW9ucyQxKG9wdGlvbnMpIHtcbiAgaWYgKG9wdGlvbnMgPT09IHRydWUpXG4gICAgcmV0dXJuIHt9O1xuICByZXR1cm4gb3B0aW9ucztcbn1cbmZ1bmN0aW9uIHVzZUV2ZW50U291cmNlKHVybCwgZXZlbnRzID0gW10sIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCBldmVudCA9IHNoYWxsb3dSZWYobnVsbCk7XG4gIGNvbnN0IGRhdGEgPSBzaGFsbG93UmVmKG51bGwpO1xuICBjb25zdCBzdGF0dXMgPSBzaGFsbG93UmVmKFwiQ09OTkVDVElOR1wiKTtcbiAgY29uc3QgZXZlbnRTb3VyY2UgPSByZWYobnVsbCk7XG4gIGNvbnN0IGVycm9yID0gc2hhbGxvd1JlZihudWxsKTtcbiAgY29uc3QgdXJsUmVmID0gdG9SZWYodXJsKTtcbiAgY29uc3QgbGFzdEV2ZW50SWQgPSBzaGFsbG93UmVmKG51bGwpO1xuICBsZXQgZXhwbGljaXRseUNsb3NlZCA9IGZhbHNlO1xuICBsZXQgcmV0cmllZCA9IDA7XG4gIGNvbnN0IHtcbiAgICB3aXRoQ3JlZGVudGlhbHMgPSBmYWxzZSxcbiAgICBpbW1lZGlhdGUgPSB0cnVlLFxuICAgIGF1dG9Db25uZWN0ID0gdHJ1ZSxcbiAgICBhdXRvUmVjb25uZWN0LFxuICAgIHNlcmlhbGl6ZXIgPSB7XG4gICAgICByZWFkOiAodikgPT4gdlxuICAgIH1cbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGNsb3NlID0gKCkgPT4ge1xuICAgIGlmIChpc0NsaWVudCAmJiBldmVudFNvdXJjZS52YWx1ZSkge1xuICAgICAgZXZlbnRTb3VyY2UudmFsdWUuY2xvc2UoKTtcbiAgICAgIGV2ZW50U291cmNlLnZhbHVlID0gbnVsbDtcbiAgICAgIHN0YXR1cy52YWx1ZSA9IFwiQ0xPU0VEXCI7XG4gICAgICBleHBsaWNpdGx5Q2xvc2VkID0gdHJ1ZTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IF9pbml0ID0gKCkgPT4ge1xuICAgIGlmIChleHBsaWNpdGx5Q2xvc2VkIHx8IHR5cGVvZiB1cmxSZWYudmFsdWUgPT09IFwidW5kZWZpbmVkXCIpXG4gICAgICByZXR1cm47XG4gICAgY29uc3QgZXMgPSBuZXcgRXZlbnRTb3VyY2UodXJsUmVmLnZhbHVlLCB7IHdpdGhDcmVkZW50aWFscyB9KTtcbiAgICBzdGF0dXMudmFsdWUgPSBcIkNPTk5FQ1RJTkdcIjtcbiAgICBldmVudFNvdXJjZS52YWx1ZSA9IGVzO1xuICAgIGVzLm9ub3BlbiA9ICgpID0+IHtcbiAgICAgIHN0YXR1cy52YWx1ZSA9IFwiT1BFTlwiO1xuICAgICAgZXJyb3IudmFsdWUgPSBudWxsO1xuICAgIH07XG4gICAgZXMub25lcnJvciA9IChlKSA9PiB7XG4gICAgICBzdGF0dXMudmFsdWUgPSBcIkNMT1NFRFwiO1xuICAgICAgZXJyb3IudmFsdWUgPSBlO1xuICAgICAgaWYgKGVzLnJlYWR5U3RhdGUgPT09IDIgJiYgIWV4cGxpY2l0bHlDbG9zZWQgJiYgYXV0b1JlY29ubmVjdCkge1xuICAgICAgICBlcy5jbG9zZSgpO1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgcmV0cmllcyA9IC0xLFxuICAgICAgICAgIGRlbGF5ID0gMWUzLFxuICAgICAgICAgIG9uRmFpbGVkXG4gICAgICAgIH0gPSByZXNvbHZlTmVzdGVkT3B0aW9ucyQxKGF1dG9SZWNvbm5lY3QpO1xuICAgICAgICByZXRyaWVkICs9IDE7XG4gICAgICAgIGlmICh0eXBlb2YgcmV0cmllcyA9PT0gXCJudW1iZXJcIiAmJiAocmV0cmllcyA8IDAgfHwgcmV0cmllZCA8IHJldHJpZXMpKVxuICAgICAgICAgIHNldFRpbWVvdXQoX2luaXQsIGRlbGF5KTtcbiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHJldHJpZXMgPT09IFwiZnVuY3Rpb25cIiAmJiByZXRyaWVzKCkpXG4gICAgICAgICAgc2V0VGltZW91dChfaW5pdCwgZGVsYXkpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgb25GYWlsZWQgPT0gbnVsbCA/IHZvaWQgMCA6IG9uRmFpbGVkKCk7XG4gICAgICB9XG4gICAgfTtcbiAgICBlcy5vbm1lc3NhZ2UgPSAoZSkgPT4ge1xuICAgICAgdmFyIF9hO1xuICAgICAgZXZlbnQudmFsdWUgPSBudWxsO1xuICAgICAgZGF0YS52YWx1ZSA9IChfYSA9IHNlcmlhbGl6ZXIucmVhZChlLmRhdGEpKSAhPSBudWxsID8gX2EgOiBudWxsO1xuICAgICAgbGFzdEV2ZW50SWQudmFsdWUgPSBlLmxhc3RFdmVudElkO1xuICAgIH07XG4gICAgZm9yIChjb25zdCBldmVudF9uYW1lIG9mIGV2ZW50cykge1xuICAgICAgdXNlRXZlbnRMaXN0ZW5lcihlcywgZXZlbnRfbmFtZSwgKGUpID0+IHtcbiAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgZXZlbnQudmFsdWUgPSBldmVudF9uYW1lO1xuICAgICAgICBkYXRhLnZhbHVlID0gKF9hID0gc2VyaWFsaXplci5yZWFkKGUuZGF0YSkpICE9IG51bGwgPyBfYSA6IG51bGw7XG4gICAgICAgIGxhc3RFdmVudElkLnZhbHVlID0gKF9iID0gZS5sYXN0RXZlbnRJZCkgIT0gbnVsbCA/IF9iIDogbnVsbDtcbiAgICAgIH0sIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IG9wZW4gPSAoKSA9PiB7XG4gICAgaWYgKCFpc0NsaWVudClcbiAgICAgIHJldHVybjtcbiAgICBjbG9zZSgpO1xuICAgIGV4cGxpY2l0bHlDbG9zZWQgPSBmYWxzZTtcbiAgICByZXRyaWVkID0gMDtcbiAgICBfaW5pdCgpO1xuICB9O1xuICBpZiAoaW1tZWRpYXRlKVxuICAgIG9wZW4oKTtcbiAgaWYgKGF1dG9Db25uZWN0KVxuICAgIHdhdGNoKHVybFJlZiwgb3Blbik7XG4gIHRyeU9uU2NvcGVEaXNwb3NlKGNsb3NlKTtcbiAgcmV0dXJuIHtcbiAgICBldmVudFNvdXJjZSxcbiAgICBldmVudCxcbiAgICBkYXRhLFxuICAgIHN0YXR1cyxcbiAgICBlcnJvcixcbiAgICBvcGVuLFxuICAgIGNsb3NlLFxuICAgIGxhc3RFdmVudElkXG4gIH07XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VFeWVEcm9wcGVyKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7IGluaXRpYWxWYWx1ZSA9IFwiXCIgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHR5cGVvZiB3aW5kb3cgIT09IFwidW5kZWZpbmVkXCIgJiYgXCJFeWVEcm9wcGVyXCIgaW4gd2luZG93KTtcbiAgY29uc3Qgc1JHQkhleCA9IHNoYWxsb3dSZWYoaW5pdGlhbFZhbHVlKTtcbiAgYXN5bmMgZnVuY3Rpb24gb3BlbihvcGVuT3B0aW9ucykge1xuICAgIGlmICghaXNTdXBwb3J0ZWQudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgY29uc3QgZXllRHJvcHBlciA9IG5ldyB3aW5kb3cuRXllRHJvcHBlcigpO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV5ZURyb3BwZXIub3BlbihvcGVuT3B0aW9ucyk7XG4gICAgc1JHQkhleC52YWx1ZSA9IHJlc3VsdC5zUkdCSGV4O1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbiAgcmV0dXJuIHsgaXNTdXBwb3J0ZWQsIHNSR0JIZXgsIG9wZW4gfTtcbn1cblxuZnVuY3Rpb24gdXNlRmF2aWNvbihuZXdJY29uID0gbnVsbCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBiYXNlVXJsID0gXCJcIixcbiAgICByZWwgPSBcImljb25cIixcbiAgICBkb2N1bWVudCA9IGRlZmF1bHREb2N1bWVudFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgZmF2aWNvbiA9IHRvUmVmKG5ld0ljb24pO1xuICBjb25zdCBhcHBseUljb24gPSAoaWNvbikgPT4ge1xuICAgIGNvbnN0IGVsZW1lbnRzID0gZG9jdW1lbnQgPT0gbnVsbCA/IHZvaWQgMCA6IGRvY3VtZW50LmhlYWQucXVlcnlTZWxlY3RvckFsbChgbGlua1tyZWwqPVwiJHtyZWx9XCJdYCk7XG4gICAgaWYgKCFlbGVtZW50cyB8fCBlbGVtZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudCA9PSBudWxsID8gdm9pZCAwIDogZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImxpbmtcIik7XG4gICAgICBpZiAobGluaykge1xuICAgICAgICBsaW5rLnJlbCA9IHJlbDtcbiAgICAgICAgbGluay5ocmVmID0gYCR7YmFzZVVybH0ke2ljb259YDtcbiAgICAgICAgbGluay50eXBlID0gYGltYWdlLyR7aWNvbi5zcGxpdChcIi5cIikucG9wKCl9YDtcbiAgICAgICAgZG9jdW1lbnQgPT0gbnVsbCA/IHZvaWQgMCA6IGRvY3VtZW50LmhlYWQuYXBwZW5kKGxpbmspO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBlbGVtZW50cyA9PSBudWxsID8gdm9pZCAwIDogZWxlbWVudHMuZm9yRWFjaCgoZWwpID0+IGVsLmhyZWYgPSBgJHtiYXNlVXJsfSR7aWNvbn1gKTtcbiAgfTtcbiAgd2F0Y2goXG4gICAgZmF2aWNvbixcbiAgICAoaSwgbykgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBpID09PSBcInN0cmluZ1wiICYmIGkgIT09IG8pXG4gICAgICAgIGFwcGx5SWNvbihpKTtcbiAgICB9LFxuICAgIHsgaW1tZWRpYXRlOiB0cnVlIH1cbiAgKTtcbiAgcmV0dXJuIGZhdmljb247XG59XG5cbmNvbnN0IHBheWxvYWRNYXBwaW5nID0ge1xuICBqc29uOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgdGV4dDogXCJ0ZXh0L3BsYWluXCJcbn07XG5mdW5jdGlvbiBpc0ZldGNoT3B0aW9ucyhvYmopIHtcbiAgcmV0dXJuIG9iaiAmJiBjb250YWluc1Byb3Aob2JqLCBcImltbWVkaWF0ZVwiLCBcInJlZmV0Y2hcIiwgXCJpbml0aWFsRGF0YVwiLCBcInRpbWVvdXRcIiwgXCJiZWZvcmVGZXRjaFwiLCBcImFmdGVyRmV0Y2hcIiwgXCJvbkZldGNoRXJyb3JcIiwgXCJmZXRjaFwiLCBcInVwZGF0ZURhdGFPbkVycm9yXCIpO1xufVxuY29uc3QgcmVBYnNvbHV0ZSA9IC9eKD86W2Etel1bYS16XFxkK1xcLS5dKjopP1xcL1xcLy9pO1xuZnVuY3Rpb24gaXNBYnNvbHV0ZVVSTCh1cmwpIHtcbiAgcmV0dXJuIHJlQWJzb2x1dGUudGVzdCh1cmwpO1xufVxuZnVuY3Rpb24gaGVhZGVyc1RvT2JqZWN0KGhlYWRlcnMpIHtcbiAgaWYgKHR5cGVvZiBIZWFkZXJzICE9PSBcInVuZGVmaW5lZFwiICYmIGhlYWRlcnMgaW5zdGFuY2VvZiBIZWFkZXJzKVxuICAgIHJldHVybiBPYmplY3QuZnJvbUVudHJpZXMoaGVhZGVycy5lbnRyaWVzKCkpO1xuICByZXR1cm4gaGVhZGVycztcbn1cbmZ1bmN0aW9uIGNvbWJpbmVDYWxsYmFja3MoY29tYmluYXRpb24sIC4uLmNhbGxiYWNrcykge1xuICBpZiAoY29tYmluYXRpb24gPT09IFwib3ZlcndyaXRlXCIpIHtcbiAgICByZXR1cm4gYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgbGV0IGNhbGxiYWNrO1xuICAgICAgZm9yIChsZXQgaSA9IGNhbGxiYWNrcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICBpZiAoY2FsbGJhY2tzW2ldICE9IG51bGwpIHtcbiAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGNhbGxiYWNrKVxuICAgICAgICByZXR1cm4geyAuLi5jdHgsIC4uLmF3YWl0IGNhbGxiYWNrKGN0eCkgfTtcbiAgICAgIHJldHVybiBjdHg7XG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgZm9yIChjb25zdCBjYWxsYmFjayBvZiBjYWxsYmFja3MpIHtcbiAgICAgICAgaWYgKGNhbGxiYWNrKVxuICAgICAgICAgIGN0eCA9IHsgLi4uY3R4LCAuLi5hd2FpdCBjYWxsYmFjayhjdHgpIH07XG4gICAgICB9XG4gICAgICByZXR1cm4gY3R4O1xuICAgIH07XG4gIH1cbn1cbmZ1bmN0aW9uIGNyZWF0ZUZldGNoKGNvbmZpZyA9IHt9KSB7XG4gIGNvbnN0IF9jb21iaW5hdGlvbiA9IGNvbmZpZy5jb21iaW5hdGlvbiB8fCBcImNoYWluXCI7XG4gIGNvbnN0IF9vcHRpb25zID0gY29uZmlnLm9wdGlvbnMgfHwge307XG4gIGNvbnN0IF9mZXRjaE9wdGlvbnMgPSBjb25maWcuZmV0Y2hPcHRpb25zIHx8IHt9O1xuICBmdW5jdGlvbiB1c2VGYWN0b3J5RmV0Y2godXJsLCAuLi5hcmdzKSB7XG4gICAgY29uc3QgY29tcHV0ZWRVcmwgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgICBjb25zdCBiYXNlVXJsID0gdG9WYWx1ZShjb25maWcuYmFzZVVybCk7XG4gICAgICBjb25zdCB0YXJnZXRVcmwgPSB0b1ZhbHVlKHVybCk7XG4gICAgICByZXR1cm4gYmFzZVVybCAmJiAhaXNBYnNvbHV0ZVVSTCh0YXJnZXRVcmwpID8gam9pblBhdGhzKGJhc2VVcmwsIHRhcmdldFVybCkgOiB0YXJnZXRVcmw7XG4gICAgfSk7XG4gICAgbGV0IG9wdGlvbnMgPSBfb3B0aW9ucztcbiAgICBsZXQgZmV0Y2hPcHRpb25zID0gX2ZldGNoT3B0aW9ucztcbiAgICBpZiAoYXJncy5sZW5ndGggPiAwKSB7XG4gICAgICBpZiAoaXNGZXRjaE9wdGlvbnMoYXJnc1swXSkpIHtcbiAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICAgIC4uLmFyZ3NbMF0sXG4gICAgICAgICAgYmVmb3JlRmV0Y2g6IGNvbWJpbmVDYWxsYmFja3MoX2NvbWJpbmF0aW9uLCBfb3B0aW9ucy5iZWZvcmVGZXRjaCwgYXJnc1swXS5iZWZvcmVGZXRjaCksXG4gICAgICAgICAgYWZ0ZXJGZXRjaDogY29tYmluZUNhbGxiYWNrcyhfY29tYmluYXRpb24sIF9vcHRpb25zLmFmdGVyRmV0Y2gsIGFyZ3NbMF0uYWZ0ZXJGZXRjaCksXG4gICAgICAgICAgb25GZXRjaEVycm9yOiBjb21iaW5lQ2FsbGJhY2tzKF9jb21iaW5hdGlvbiwgX29wdGlvbnMub25GZXRjaEVycm9yLCBhcmdzWzBdLm9uRmV0Y2hFcnJvcilcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZldGNoT3B0aW9ucyA9IHtcbiAgICAgICAgICAuLi5mZXRjaE9wdGlvbnMsXG4gICAgICAgICAgLi4uYXJnc1swXSxcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAuLi5oZWFkZXJzVG9PYmplY3QoZmV0Y2hPcHRpb25zLmhlYWRlcnMpIHx8IHt9LFxuICAgICAgICAgICAgLi4uaGVhZGVyc1RvT2JqZWN0KGFyZ3NbMF0uaGVhZGVycykgfHwge31cbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChhcmdzLmxlbmd0aCA+IDEgJiYgaXNGZXRjaE9wdGlvbnMoYXJnc1sxXSkpIHtcbiAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgIC4uLmFyZ3NbMV0sXG4gICAgICAgIGJlZm9yZUZldGNoOiBjb21iaW5lQ2FsbGJhY2tzKF9jb21iaW5hdGlvbiwgX29wdGlvbnMuYmVmb3JlRmV0Y2gsIGFyZ3NbMV0uYmVmb3JlRmV0Y2gpLFxuICAgICAgICBhZnRlckZldGNoOiBjb21iaW5lQ2FsbGJhY2tzKF9jb21iaW5hdGlvbiwgX29wdGlvbnMuYWZ0ZXJGZXRjaCwgYXJnc1sxXS5hZnRlckZldGNoKSxcbiAgICAgICAgb25GZXRjaEVycm9yOiBjb21iaW5lQ2FsbGJhY2tzKF9jb21iaW5hdGlvbiwgX29wdGlvbnMub25GZXRjaEVycm9yLCBhcmdzWzFdLm9uRmV0Y2hFcnJvcilcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB1c2VGZXRjaChjb21wdXRlZFVybCwgZmV0Y2hPcHRpb25zLCBvcHRpb25zKTtcbiAgfVxuICByZXR1cm4gdXNlRmFjdG9yeUZldGNoO1xufVxuZnVuY3Rpb24gdXNlRmV0Y2godXJsLCAuLi5hcmdzKSB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IHN1cHBvcnRzQWJvcnQgPSB0eXBlb2YgQWJvcnRDb250cm9sbGVyID09PSBcImZ1bmN0aW9uXCI7XG4gIGxldCBmZXRjaE9wdGlvbnMgPSB7fTtcbiAgbGV0IG9wdGlvbnMgPSB7XG4gICAgaW1tZWRpYXRlOiB0cnVlLFxuICAgIHJlZmV0Y2g6IGZhbHNlLFxuICAgIHRpbWVvdXQ6IDAsXG4gICAgdXBkYXRlRGF0YU9uRXJyb3I6IGZhbHNlXG4gIH07XG4gIGNvbnN0IGNvbmZpZyA9IHtcbiAgICBtZXRob2Q6IFwiR0VUXCIsXG4gICAgdHlwZTogXCJ0ZXh0XCIsXG4gICAgcGF5bG9hZDogdm9pZCAwXG4gIH07XG4gIGlmIChhcmdzLmxlbmd0aCA+IDApIHtcbiAgICBpZiAoaXNGZXRjaE9wdGlvbnMoYXJnc1swXSkpXG4gICAgICBvcHRpb25zID0geyAuLi5vcHRpb25zLCAuLi5hcmdzWzBdIH07XG4gICAgZWxzZVxuICAgICAgZmV0Y2hPcHRpb25zID0gYXJnc1swXTtcbiAgfVxuICBpZiAoYXJncy5sZW5ndGggPiAxKSB7XG4gICAgaWYgKGlzRmV0Y2hPcHRpb25zKGFyZ3NbMV0pKVxuICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgLi4uYXJnc1sxXSB9O1xuICB9XG4gIGNvbnN0IHtcbiAgICBmZXRjaCA9IChfYiA9IChfYSA9IGRlZmF1bHRXaW5kb3cpID09IG51bGwgPyB2b2lkIDAgOiBfYS5mZXRjaCkgIT0gbnVsbCA/IF9iIDogZ2xvYmFsVGhpcyA9PSBudWxsID8gdm9pZCAwIDogZ2xvYmFsVGhpcy5mZXRjaCxcbiAgICBpbml0aWFsRGF0YSxcbiAgICB0aW1lb3V0XG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCByZXNwb25zZUV2ZW50ID0gY3JlYXRlRXZlbnRIb29rKCk7XG4gIGNvbnN0IGVycm9yRXZlbnQgPSBjcmVhdGVFdmVudEhvb2soKTtcbiAgY29uc3QgZmluYWxseUV2ZW50ID0gY3JlYXRlRXZlbnRIb29rKCk7XG4gIGNvbnN0IGlzRmluaXNoZWQgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgaXNGZXRjaGluZyA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBhYm9ydGVkID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IHN0YXR1c0NvZGUgPSBzaGFsbG93UmVmKG51bGwpO1xuICBjb25zdCByZXNwb25zZSA9IHNoYWxsb3dSZWYobnVsbCk7XG4gIGNvbnN0IGVycm9yID0gc2hhbGxvd1JlZihudWxsKTtcbiAgY29uc3QgZGF0YSA9IHNoYWxsb3dSZWYoaW5pdGlhbERhdGEgfHwgbnVsbCk7XG4gIGNvbnN0IGNhbkFib3J0ID0gY29tcHV0ZWQoKCkgPT4gc3VwcG9ydHNBYm9ydCAmJiBpc0ZldGNoaW5nLnZhbHVlKTtcbiAgbGV0IGNvbnRyb2xsZXI7XG4gIGxldCB0aW1lcjtcbiAgY29uc3QgYWJvcnQgPSAocmVhc29uKSA9PiB7XG4gICAgaWYgKHN1cHBvcnRzQWJvcnQpIHtcbiAgICAgIGNvbnRyb2xsZXIgPT0gbnVsbCA/IHZvaWQgMCA6IGNvbnRyb2xsZXIuYWJvcnQocmVhc29uKTtcbiAgICAgIGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgICBjb250cm9sbGVyLnNpZ25hbC5vbmFib3J0ID0gKCkgPT4gYWJvcnRlZC52YWx1ZSA9IHRydWU7XG4gICAgICBmZXRjaE9wdGlvbnMgPSB7XG4gICAgICAgIC4uLmZldGNoT3B0aW9ucyxcbiAgICAgICAgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbFxuICAgICAgfTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IGxvYWRpbmcgPSAoaXNMb2FkaW5nKSA9PiB7XG4gICAgaXNGZXRjaGluZy52YWx1ZSA9IGlzTG9hZGluZztcbiAgICBpc0ZpbmlzaGVkLnZhbHVlID0gIWlzTG9hZGluZztcbiAgfTtcbiAgaWYgKHRpbWVvdXQpXG4gICAgdGltZXIgPSB1c2VUaW1lb3V0Rm4oYWJvcnQsIHRpbWVvdXQsIHsgaW1tZWRpYXRlOiBmYWxzZSB9KTtcbiAgbGV0IGV4ZWN1dGVDb3VudGVyID0gMDtcbiAgY29uc3QgZXhlY3V0ZSA9IGFzeW5jICh0aHJvd09uRmFpbGVkID0gZmFsc2UpID0+IHtcbiAgICB2YXIgX2EyLCBfYjI7XG4gICAgYWJvcnQoKTtcbiAgICBsb2FkaW5nKHRydWUpO1xuICAgIGVycm9yLnZhbHVlID0gbnVsbDtcbiAgICBzdGF0dXNDb2RlLnZhbHVlID0gbnVsbDtcbiAgICBhYm9ydGVkLnZhbHVlID0gZmFsc2U7XG4gICAgZXhlY3V0ZUNvdW50ZXIgKz0gMTtcbiAgICBjb25zdCBjdXJyZW50RXhlY3V0ZUNvdW50ZXIgPSBleGVjdXRlQ291bnRlcjtcbiAgICBjb25zdCBkZWZhdWx0RmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiBjb25maWcubWV0aG9kLFxuICAgICAgaGVhZGVyczoge31cbiAgICB9O1xuICAgIGNvbnN0IHBheWxvYWQgPSB0b1ZhbHVlKGNvbmZpZy5wYXlsb2FkKTtcbiAgICBpZiAocGF5bG9hZCkge1xuICAgICAgY29uc3QgaGVhZGVycyA9IGhlYWRlcnNUb09iamVjdChkZWZhdWx0RmV0Y2hPcHRpb25zLmhlYWRlcnMpO1xuICAgICAgY29uc3QgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocGF5bG9hZCk7XG4gICAgICBpZiAoIWNvbmZpZy5wYXlsb2FkVHlwZSAmJiBwYXlsb2FkICYmIChwcm90byA9PT0gT2JqZWN0LnByb3RvdHlwZSB8fCBBcnJheS5pc0FycmF5KHByb3RvKSkgJiYgIShwYXlsb2FkIGluc3RhbmNlb2YgRm9ybURhdGEpKVxuICAgICAgICBjb25maWcucGF5bG9hZFR5cGUgPSBcImpzb25cIjtcbiAgICAgIGlmIChjb25maWcucGF5bG9hZFR5cGUpXG4gICAgICAgIGhlYWRlcnNbXCJDb250ZW50LVR5cGVcIl0gPSAoX2EyID0gcGF5bG9hZE1hcHBpbmdbY29uZmlnLnBheWxvYWRUeXBlXSkgIT0gbnVsbCA/IF9hMiA6IGNvbmZpZy5wYXlsb2FkVHlwZTtcbiAgICAgIGRlZmF1bHRGZXRjaE9wdGlvbnMuYm9keSA9IGNvbmZpZy5wYXlsb2FkVHlwZSA9PT0gXCJqc29uXCIgPyBKU09OLnN0cmluZ2lmeShwYXlsb2FkKSA6IHBheWxvYWQ7XG4gICAgfVxuICAgIGxldCBpc0NhbmNlbGVkID0gZmFsc2U7XG4gICAgY29uc3QgY29udGV4dCA9IHtcbiAgICAgIHVybDogdG9WYWx1ZSh1cmwpLFxuICAgICAgb3B0aW9uczoge1xuICAgICAgICAuLi5kZWZhdWx0RmV0Y2hPcHRpb25zLFxuICAgICAgICAuLi5mZXRjaE9wdGlvbnNcbiAgICAgIH0sXG4gICAgICBjYW5jZWw6ICgpID0+IHtcbiAgICAgICAgaXNDYW5jZWxlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfTtcbiAgICBpZiAob3B0aW9ucy5iZWZvcmVGZXRjaClcbiAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwgYXdhaXQgb3B0aW9ucy5iZWZvcmVGZXRjaChjb250ZXh0KSk7XG4gICAgaWYgKGlzQ2FuY2VsZWQgfHwgIWZldGNoKSB7XG4gICAgICBsb2FkaW5nKGZhbHNlKTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG4gICAgfVxuICAgIGxldCByZXNwb25zZURhdGEgPSBudWxsO1xuICAgIGlmICh0aW1lcilcbiAgICAgIHRpbWVyLnN0YXJ0KCk7XG4gICAgcmV0dXJuIGZldGNoKFxuICAgICAgY29udGV4dC51cmwsXG4gICAgICB7XG4gICAgICAgIC4uLmRlZmF1bHRGZXRjaE9wdGlvbnMsXG4gICAgICAgIC4uLmNvbnRleHQub3B0aW9ucyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIC4uLmhlYWRlcnNUb09iamVjdChkZWZhdWx0RmV0Y2hPcHRpb25zLmhlYWRlcnMpLFxuICAgICAgICAgIC4uLmhlYWRlcnNUb09iamVjdCgoX2IyID0gY29udGV4dC5vcHRpb25zKSA9PSBudWxsID8gdm9pZCAwIDogX2IyLmhlYWRlcnMpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApLnRoZW4oYXN5bmMgKGZldGNoUmVzcG9uc2UpID0+IHtcbiAgICAgIHJlc3BvbnNlLnZhbHVlID0gZmV0Y2hSZXNwb25zZTtcbiAgICAgIHN0YXR1c0NvZGUudmFsdWUgPSBmZXRjaFJlc3BvbnNlLnN0YXR1cztcbiAgICAgIHJlc3BvbnNlRGF0YSA9IGF3YWl0IGZldGNoUmVzcG9uc2UuY2xvbmUoKVtjb25maWcudHlwZV0oKTtcbiAgICAgIGlmICghZmV0Y2hSZXNwb25zZS5vaykge1xuICAgICAgICBkYXRhLnZhbHVlID0gaW5pdGlhbERhdGEgfHwgbnVsbDtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZldGNoUmVzcG9uc2Uuc3RhdHVzVGV4dCk7XG4gICAgICB9XG4gICAgICBpZiAob3B0aW9ucy5hZnRlckZldGNoKSB7XG4gICAgICAgICh7IGRhdGE6IHJlc3BvbnNlRGF0YSB9ID0gYXdhaXQgb3B0aW9ucy5hZnRlckZldGNoKHtcbiAgICAgICAgICBkYXRhOiByZXNwb25zZURhdGEsXG4gICAgICAgICAgcmVzcG9uc2U6IGZldGNoUmVzcG9uc2UsXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICBleGVjdXRlXG4gICAgICAgIH0pKTtcbiAgICAgIH1cbiAgICAgIGRhdGEudmFsdWUgPSByZXNwb25zZURhdGE7XG4gICAgICByZXNwb25zZUV2ZW50LnRyaWdnZXIoZmV0Y2hSZXNwb25zZSk7XG4gICAgICByZXR1cm4gZmV0Y2hSZXNwb25zZTtcbiAgICB9KS5jYXRjaChhc3luYyAoZmV0Y2hFcnJvcikgPT4ge1xuICAgICAgbGV0IGVycm9yRGF0YSA9IGZldGNoRXJyb3IubWVzc2FnZSB8fCBmZXRjaEVycm9yLm5hbWU7XG4gICAgICBpZiAob3B0aW9ucy5vbkZldGNoRXJyb3IpIHtcbiAgICAgICAgKHsgZXJyb3I6IGVycm9yRGF0YSwgZGF0YTogcmVzcG9uc2VEYXRhIH0gPSBhd2FpdCBvcHRpb25zLm9uRmV0Y2hFcnJvcih7XG4gICAgICAgICAgZGF0YTogcmVzcG9uc2VEYXRhLFxuICAgICAgICAgIGVycm9yOiBmZXRjaEVycm9yLFxuICAgICAgICAgIHJlc3BvbnNlOiByZXNwb25zZS52YWx1ZSxcbiAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgIGV4ZWN1dGVcbiAgICAgICAgfSkpO1xuICAgICAgfVxuICAgICAgZXJyb3IudmFsdWUgPSBlcnJvckRhdGE7XG4gICAgICBpZiAob3B0aW9ucy51cGRhdGVEYXRhT25FcnJvcilcbiAgICAgICAgZGF0YS52YWx1ZSA9IHJlc3BvbnNlRGF0YTtcbiAgICAgIGVycm9yRXZlbnQudHJpZ2dlcihmZXRjaEVycm9yKTtcbiAgICAgIGlmICh0aHJvd09uRmFpbGVkKVxuICAgICAgICB0aHJvdyBmZXRjaEVycm9yO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSkuZmluYWxseSgoKSA9PiB7XG4gICAgICBpZiAoY3VycmVudEV4ZWN1dGVDb3VudGVyID09PSBleGVjdXRlQ291bnRlcilcbiAgICAgICAgbG9hZGluZyhmYWxzZSk7XG4gICAgICBpZiAodGltZXIpXG4gICAgICAgIHRpbWVyLnN0b3AoKTtcbiAgICAgIGZpbmFsbHlFdmVudC50cmlnZ2VyKG51bGwpO1xuICAgIH0pO1xuICB9O1xuICBjb25zdCByZWZldGNoID0gdG9SZWYob3B0aW9ucy5yZWZldGNoKTtcbiAgd2F0Y2goXG4gICAgW1xuICAgICAgcmVmZXRjaCxcbiAgICAgIHRvUmVmKHVybClcbiAgICBdLFxuICAgIChbcmVmZXRjaDJdKSA9PiByZWZldGNoMiAmJiBleGVjdXRlKCksXG4gICAgeyBkZWVwOiB0cnVlIH1cbiAgKTtcbiAgY29uc3Qgc2hlbGwgPSB7XG4gICAgaXNGaW5pc2hlZDogcmVhZG9ubHkoaXNGaW5pc2hlZCksXG4gICAgaXNGZXRjaGluZzogcmVhZG9ubHkoaXNGZXRjaGluZyksXG4gICAgc3RhdHVzQ29kZSxcbiAgICByZXNwb25zZSxcbiAgICBlcnJvcixcbiAgICBkYXRhLFxuICAgIGNhbkFib3J0LFxuICAgIGFib3J0ZWQsXG4gICAgYWJvcnQsXG4gICAgZXhlY3V0ZSxcbiAgICBvbkZldGNoUmVzcG9uc2U6IHJlc3BvbnNlRXZlbnQub24sXG4gICAgb25GZXRjaEVycm9yOiBlcnJvckV2ZW50Lm9uLFxuICAgIG9uRmV0Y2hGaW5hbGx5OiBmaW5hbGx5RXZlbnQub24sXG4gICAgLy8gbWV0aG9kXG4gICAgZ2V0OiBzZXRNZXRob2QoXCJHRVRcIiksXG4gICAgcHV0OiBzZXRNZXRob2QoXCJQVVRcIiksXG4gICAgcG9zdDogc2V0TWV0aG9kKFwiUE9TVFwiKSxcbiAgICBkZWxldGU6IHNldE1ldGhvZChcIkRFTEVURVwiKSxcbiAgICBwYXRjaDogc2V0TWV0aG9kKFwiUEFUQ0hcIiksXG4gICAgaGVhZDogc2V0TWV0aG9kKFwiSEVBRFwiKSxcbiAgICBvcHRpb25zOiBzZXRNZXRob2QoXCJPUFRJT05TXCIpLFxuICAgIC8vIHR5cGVcbiAgICBqc29uOiBzZXRUeXBlKFwianNvblwiKSxcbiAgICB0ZXh0OiBzZXRUeXBlKFwidGV4dFwiKSxcbiAgICBibG9iOiBzZXRUeXBlKFwiYmxvYlwiKSxcbiAgICBhcnJheUJ1ZmZlcjogc2V0VHlwZShcImFycmF5QnVmZmVyXCIpLFxuICAgIGZvcm1EYXRhOiBzZXRUeXBlKFwiZm9ybURhdGFcIilcbiAgfTtcbiAgZnVuY3Rpb24gc2V0TWV0aG9kKG1ldGhvZCkge1xuICAgIHJldHVybiAocGF5bG9hZCwgcGF5bG9hZFR5cGUpID0+IHtcbiAgICAgIGlmICghaXNGZXRjaGluZy52YWx1ZSkge1xuICAgICAgICBjb25maWcubWV0aG9kID0gbWV0aG9kO1xuICAgICAgICBjb25maWcucGF5bG9hZCA9IHBheWxvYWQ7XG4gICAgICAgIGNvbmZpZy5wYXlsb2FkVHlwZSA9IHBheWxvYWRUeXBlO1xuICAgICAgICBpZiAoaXNSZWYoY29uZmlnLnBheWxvYWQpKSB7XG4gICAgICAgICAgd2F0Y2goXG4gICAgICAgICAgICBbXG4gICAgICAgICAgICAgIHJlZmV0Y2gsXG4gICAgICAgICAgICAgIHRvUmVmKGNvbmZpZy5wYXlsb2FkKVxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIChbcmVmZXRjaDJdKSA9PiByZWZldGNoMiAmJiBleGVjdXRlKCksXG4gICAgICAgICAgICB7IGRlZXA6IHRydWUgfVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5zaGVsbCxcbiAgICAgICAgICB0aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gd2FpdFVudGlsRmluaXNoZWQoKS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICByZXR1cm4gdm9pZCAwO1xuICAgIH07XG4gIH1cbiAgZnVuY3Rpb24gd2FpdFVudGlsRmluaXNoZWQoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHVudGlsKGlzRmluaXNoZWQpLnRvQmUodHJ1ZSkudGhlbigoKSA9PiByZXNvbHZlKHNoZWxsKSkuY2F0Y2gocmVqZWN0KTtcbiAgICB9KTtcbiAgfVxuICBmdW5jdGlvbiBzZXRUeXBlKHR5cGUpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgaWYgKCFpc0ZldGNoaW5nLnZhbHVlKSB7XG4gICAgICAgIGNvbmZpZy50eXBlID0gdHlwZTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5zaGVsbCxcbiAgICAgICAgICB0aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gd2FpdFVudGlsRmluaXNoZWQoKS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICByZXR1cm4gdm9pZCAwO1xuICAgIH07XG4gIH1cbiAgaWYgKG9wdGlvbnMuaW1tZWRpYXRlKVxuICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZXhlY3V0ZSgpKTtcbiAgcmV0dXJuIHtcbiAgICAuLi5zaGVsbCxcbiAgICB0aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7XG4gICAgICByZXR1cm4gd2FpdFVudGlsRmluaXNoZWQoKS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKTtcbiAgICB9XG4gIH07XG59XG5mdW5jdGlvbiBqb2luUGF0aHMoc3RhcnQsIGVuZCkge1xuICBpZiAoIXN0YXJ0LmVuZHNXaXRoKFwiL1wiKSAmJiAhZW5kLnN0YXJ0c1dpdGgoXCIvXCIpKSB7XG4gICAgcmV0dXJuIGAke3N0YXJ0fS8ke2VuZH1gO1xuICB9XG4gIGlmIChzdGFydC5lbmRzV2l0aChcIi9cIikgJiYgZW5kLnN0YXJ0c1dpdGgoXCIvXCIpKSB7XG4gICAgcmV0dXJuIGAke3N0YXJ0LnNsaWNlKDAsIC0xKX0ke2VuZH1gO1xuICB9XG4gIHJldHVybiBgJHtzdGFydH0ke2VuZH1gO1xufVxuXG5jb25zdCBERUZBVUxUX09QVElPTlMgPSB7XG4gIG11bHRpcGxlOiB0cnVlLFxuICBhY2NlcHQ6IFwiKlwiLFxuICByZXNldDogZmFsc2UsXG4gIGRpcmVjdG9yeTogZmFsc2Vcbn07XG5mdW5jdGlvbiBwcmVwYXJlSW5pdGlhbEZpbGVzKGZpbGVzKSB7XG4gIGlmICghZmlsZXMpXG4gICAgcmV0dXJuIG51bGw7XG4gIGlmIChmaWxlcyBpbnN0YW5jZW9mIEZpbGVMaXN0KVxuICAgIHJldHVybiBmaWxlcztcbiAgY29uc3QgZHQgPSBuZXcgRGF0YVRyYW5zZmVyKCk7XG4gIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgIGR0Lml0ZW1zLmFkZChmaWxlKTtcbiAgfVxuICByZXR1cm4gZHQuZmlsZXM7XG59XG5mdW5jdGlvbiB1c2VGaWxlRGlhbG9nKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgZG9jdW1lbnQgPSBkZWZhdWx0RG9jdW1lbnRcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGZpbGVzID0gcmVmKHByZXBhcmVJbml0aWFsRmlsZXMob3B0aW9ucy5pbml0aWFsRmlsZXMpKTtcbiAgY29uc3QgeyBvbjogb25DaGFuZ2UsIHRyaWdnZXI6IGNoYW5nZVRyaWdnZXIgfSA9IGNyZWF0ZUV2ZW50SG9vaygpO1xuICBjb25zdCB7IG9uOiBvbkNhbmNlbCwgdHJpZ2dlcjogY2FuY2VsVHJpZ2dlciB9ID0gY3JlYXRlRXZlbnRIb29rKCk7XG4gIGNvbnN0IGlucHV0UmVmID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIHZhciBfYTtcbiAgICBjb25zdCBpbnB1dCA9IChfYSA9IHVucmVmRWxlbWVudChvcHRpb25zLmlucHV0KSkgIT0gbnVsbCA/IF9hIDogZG9jdW1lbnQgPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiaW5wdXRcIikgOiB2b2lkIDA7XG4gICAgaWYgKGlucHV0KSB7XG4gICAgICBpbnB1dC50eXBlID0gXCJmaWxlXCI7XG4gICAgICBpbnB1dC5vbmNoYW5nZSA9IChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBldmVudC50YXJnZXQ7XG4gICAgICAgIGZpbGVzLnZhbHVlID0gcmVzdWx0LmZpbGVzO1xuICAgICAgICBjaGFuZ2VUcmlnZ2VyKGZpbGVzLnZhbHVlKTtcbiAgICAgIH07XG4gICAgICBpbnB1dC5vbmNhbmNlbCA9ICgpID0+IHtcbiAgICAgICAgY2FuY2VsVHJpZ2dlcigpO1xuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIGlucHV0O1xuICB9KTtcbiAgY29uc3QgcmVzZXQgPSAoKSA9PiB7XG4gICAgZmlsZXMudmFsdWUgPSBudWxsO1xuICAgIGlmIChpbnB1dFJlZi52YWx1ZSAmJiBpbnB1dFJlZi52YWx1ZS52YWx1ZSkge1xuICAgICAgaW5wdXRSZWYudmFsdWUudmFsdWUgPSBcIlwiO1xuICAgICAgY2hhbmdlVHJpZ2dlcihudWxsKTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IGFwcGx5T3B0aW9ucyA9IChvcHRpb25zMikgPT4ge1xuICAgIGNvbnN0IGVsID0gaW5wdXRSZWYudmFsdWU7XG4gICAgaWYgKCFlbClcbiAgICAgIHJldHVybjtcbiAgICBlbC5tdWx0aXBsZSA9IHRvVmFsdWUob3B0aW9uczIubXVsdGlwbGUpO1xuICAgIGVsLmFjY2VwdCA9IHRvVmFsdWUob3B0aW9uczIuYWNjZXB0KTtcbiAgICBlbC53ZWJraXRkaXJlY3RvcnkgPSB0b1ZhbHVlKG9wdGlvbnMyLmRpcmVjdG9yeSk7XG4gICAgaWYgKGhhc093bihvcHRpb25zMiwgXCJjYXB0dXJlXCIpKVxuICAgICAgZWwuY2FwdHVyZSA9IHRvVmFsdWUob3B0aW9uczIuY2FwdHVyZSk7XG4gIH07XG4gIGNvbnN0IG9wZW4gPSAobG9jYWxPcHRpb25zKSA9PiB7XG4gICAgY29uc3QgZWwgPSBpbnB1dFJlZi52YWx1ZTtcbiAgICBpZiAoIWVsKVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IG1lcmdlZE9wdGlvbnMgPSB7XG4gICAgICAuLi5ERUZBVUxUX09QVElPTlMsXG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgLi4ubG9jYWxPcHRpb25zXG4gICAgfTtcbiAgICBhcHBseU9wdGlvbnMobWVyZ2VkT3B0aW9ucyk7XG4gICAgaWYgKHRvVmFsdWUobWVyZ2VkT3B0aW9ucy5yZXNldCkpXG4gICAgICByZXNldCgpO1xuICAgIGVsLmNsaWNrKCk7XG4gIH07XG4gIHdhdGNoRWZmZWN0KCgpID0+IHtcbiAgICBhcHBseU9wdGlvbnMob3B0aW9ucyk7XG4gIH0pO1xuICByZXR1cm4ge1xuICAgIGZpbGVzOiByZWFkb25seShmaWxlcyksXG4gICAgb3BlbixcbiAgICByZXNldCxcbiAgICBvbkNhbmNlbCxcbiAgICBvbkNoYW5nZVxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VGaWxlU3lzdGVtQWNjZXNzKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgd2luZG93OiBfd2luZG93ID0gZGVmYXVsdFdpbmRvdyxcbiAgICBkYXRhVHlwZSA9IFwiVGV4dFwiXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCB3aW5kb3cgPSBfd2luZG93O1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiB3aW5kb3cgJiYgXCJzaG93U2F2ZUZpbGVQaWNrZXJcIiBpbiB3aW5kb3cgJiYgXCJzaG93T3BlbkZpbGVQaWNrZXJcIiBpbiB3aW5kb3cpO1xuICBjb25zdCBmaWxlSGFuZGxlID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCBkYXRhID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCBmaWxlID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCBmaWxlTmFtZSA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIHJldHVybiAoX2IgPSAoX2EgPSBmaWxlLnZhbHVlKSA9PSBudWxsID8gdm9pZCAwIDogX2EubmFtZSkgIT0gbnVsbCA/IF9iIDogXCJcIjtcbiAgfSk7XG4gIGNvbnN0IGZpbGVNSU1FID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIHZhciBfYSwgX2I7XG4gICAgcmV0dXJuIChfYiA9IChfYSA9IGZpbGUudmFsdWUpID09IG51bGwgPyB2b2lkIDAgOiBfYS50eXBlKSAhPSBudWxsID8gX2IgOiBcIlwiO1xuICB9KTtcbiAgY29uc3QgZmlsZVNpemUgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICByZXR1cm4gKF9iID0gKF9hID0gZmlsZS52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnNpemUpICE9IG51bGwgPyBfYiA6IDA7XG4gIH0pO1xuICBjb25zdCBmaWxlTGFzdE1vZGlmaWVkID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIHZhciBfYSwgX2I7XG4gICAgcmV0dXJuIChfYiA9IChfYSA9IGZpbGUudmFsdWUpID09IG51bGwgPyB2b2lkIDAgOiBfYS5sYXN0TW9kaWZpZWQpICE9IG51bGwgPyBfYiA6IDA7XG4gIH0pO1xuICBhc3luYyBmdW5jdGlvbiBvcGVuKF9vcHRpb25zID0ge30pIHtcbiAgICBpZiAoIWlzU3VwcG9ydGVkLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IFtoYW5kbGVdID0gYXdhaXQgd2luZG93LnNob3dPcGVuRmlsZVBpY2tlcih7IC4uLnRvVmFsdWUob3B0aW9ucyksIC4uLl9vcHRpb25zIH0pO1xuICAgIGZpbGVIYW5kbGUudmFsdWUgPSBoYW5kbGU7XG4gICAgYXdhaXQgdXBkYXRlRGF0YSgpO1xuICB9XG4gIGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZShfb3B0aW9ucyA9IHt9KSB7XG4gICAgaWYgKCFpc1N1cHBvcnRlZC52YWx1ZSlcbiAgICAgIHJldHVybjtcbiAgICBmaWxlSGFuZGxlLnZhbHVlID0gYXdhaXQgd2luZG93LnNob3dTYXZlRmlsZVBpY2tlcih7IC4uLm9wdGlvbnMsIC4uLl9vcHRpb25zIH0pO1xuICAgIGRhdGEudmFsdWUgPSB2b2lkIDA7XG4gICAgYXdhaXQgdXBkYXRlRGF0YSgpO1xuICB9XG4gIGFzeW5jIGZ1bmN0aW9uIHNhdmUoX29wdGlvbnMgPSB7fSkge1xuICAgIGlmICghaXNTdXBwb3J0ZWQudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgaWYgKCFmaWxlSGFuZGxlLnZhbHVlKVxuICAgICAgcmV0dXJuIHNhdmVBcyhfb3B0aW9ucyk7XG4gICAgaWYgKGRhdGEudmFsdWUpIHtcbiAgICAgIGNvbnN0IHdyaXRhYmxlU3RyZWFtID0gYXdhaXQgZmlsZUhhbmRsZS52YWx1ZS5jcmVhdGVXcml0YWJsZSgpO1xuICAgICAgYXdhaXQgd3JpdGFibGVTdHJlYW0ud3JpdGUoZGF0YS52YWx1ZSk7XG4gICAgICBhd2FpdCB3cml0YWJsZVN0cmVhbS5jbG9zZSgpO1xuICAgIH1cbiAgICBhd2FpdCB1cGRhdGVGaWxlKCk7XG4gIH1cbiAgYXN5bmMgZnVuY3Rpb24gc2F2ZUFzKF9vcHRpb25zID0ge30pIHtcbiAgICBpZiAoIWlzU3VwcG9ydGVkLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIGZpbGVIYW5kbGUudmFsdWUgPSBhd2FpdCB3aW5kb3cuc2hvd1NhdmVGaWxlUGlja2VyKHsgLi4ub3B0aW9ucywgLi4uX29wdGlvbnMgfSk7XG4gICAgaWYgKGRhdGEudmFsdWUpIHtcbiAgICAgIGNvbnN0IHdyaXRhYmxlU3RyZWFtID0gYXdhaXQgZmlsZUhhbmRsZS52YWx1ZS5jcmVhdGVXcml0YWJsZSgpO1xuICAgICAgYXdhaXQgd3JpdGFibGVTdHJlYW0ud3JpdGUoZGF0YS52YWx1ZSk7XG4gICAgICBhd2FpdCB3cml0YWJsZVN0cmVhbS5jbG9zZSgpO1xuICAgIH1cbiAgICBhd2FpdCB1cGRhdGVGaWxlKCk7XG4gIH1cbiAgYXN5bmMgZnVuY3Rpb24gdXBkYXRlRmlsZSgpIHtcbiAgICB2YXIgX2E7XG4gICAgZmlsZS52YWx1ZSA9IGF3YWl0ICgoX2EgPSBmaWxlSGFuZGxlLnZhbHVlKSA9PSBudWxsID8gdm9pZCAwIDogX2EuZ2V0RmlsZSgpKTtcbiAgfVxuICBhc3luYyBmdW5jdGlvbiB1cGRhdGVEYXRhKCkge1xuICAgIHZhciBfYSwgX2I7XG4gICAgYXdhaXQgdXBkYXRlRmlsZSgpO1xuICAgIGNvbnN0IHR5cGUgPSB0b1ZhbHVlKGRhdGFUeXBlKTtcbiAgICBpZiAodHlwZSA9PT0gXCJUZXh0XCIpXG4gICAgICBkYXRhLnZhbHVlID0gYXdhaXQgKChfYSA9IGZpbGUudmFsdWUpID09IG51bGwgPyB2b2lkIDAgOiBfYS50ZXh0KCkpO1xuICAgIGVsc2UgaWYgKHR5cGUgPT09IFwiQXJyYXlCdWZmZXJcIilcbiAgICAgIGRhdGEudmFsdWUgPSBhd2FpdCAoKF9iID0gZmlsZS52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9iLmFycmF5QnVmZmVyKCkpO1xuICAgIGVsc2UgaWYgKHR5cGUgPT09IFwiQmxvYlwiKVxuICAgICAgZGF0YS52YWx1ZSA9IGZpbGUudmFsdWU7XG4gIH1cbiAgd2F0Y2goKCkgPT4gdG9WYWx1ZShkYXRhVHlwZSksIHVwZGF0ZURhdGEpO1xuICByZXR1cm4ge1xuICAgIGlzU3VwcG9ydGVkLFxuICAgIGRhdGEsXG4gICAgZmlsZSxcbiAgICBmaWxlTmFtZSxcbiAgICBmaWxlTUlNRSxcbiAgICBmaWxlU2l6ZSxcbiAgICBmaWxlTGFzdE1vZGlmaWVkLFxuICAgIG9wZW4sXG4gICAgY3JlYXRlLFxuICAgIHNhdmUsXG4gICAgc2F2ZUFzLFxuICAgIHVwZGF0ZURhdGFcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlRm9jdXModGFyZ2V0LCBvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyBpbml0aWFsVmFsdWUgPSBmYWxzZSwgZm9jdXNWaXNpYmxlID0gZmFsc2UsIHByZXZlbnRTY3JvbGwgPSBmYWxzZSB9ID0gb3B0aW9ucztcbiAgY29uc3QgaW5uZXJGb2N1c2VkID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IHRhcmdldEVsZW1lbnQgPSBjb21wdXRlZCgoKSA9PiB1bnJlZkVsZW1lbnQodGFyZ2V0KSk7XG4gIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHsgcGFzc2l2ZTogdHJ1ZSB9O1xuICB1c2VFdmVudExpc3RlbmVyKHRhcmdldEVsZW1lbnQsIFwiZm9jdXNcIiwgKGV2ZW50KSA9PiB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBpZiAoIWZvY3VzVmlzaWJsZSB8fCAoKF9iID0gKF9hID0gZXZlbnQudGFyZ2V0KS5tYXRjaGVzKSA9PSBudWxsID8gdm9pZCAwIDogX2IuY2FsbChfYSwgXCI6Zm9jdXMtdmlzaWJsZVwiKSkpXG4gICAgICBpbm5lckZvY3VzZWQudmFsdWUgPSB0cnVlO1xuICB9LCBsaXN0ZW5lck9wdGlvbnMpO1xuICB1c2VFdmVudExpc3RlbmVyKHRhcmdldEVsZW1lbnQsIFwiYmx1clwiLCAoKSA9PiBpbm5lckZvY3VzZWQudmFsdWUgPSBmYWxzZSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgY29uc3QgZm9jdXNlZCA9IGNvbXB1dGVkKHtcbiAgICBnZXQ6ICgpID0+IGlubmVyRm9jdXNlZC52YWx1ZSxcbiAgICBzZXQodmFsdWUpIHtcbiAgICAgIHZhciBfYSwgX2I7XG4gICAgICBpZiAoIXZhbHVlICYmIGlubmVyRm9jdXNlZC52YWx1ZSlcbiAgICAgICAgKF9hID0gdGFyZ2V0RWxlbWVudC52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmJsdXIoKTtcbiAgICAgIGVsc2UgaWYgKHZhbHVlICYmICFpbm5lckZvY3VzZWQudmFsdWUpXG4gICAgICAgIChfYiA9IHRhcmdldEVsZW1lbnQudmFsdWUpID09IG51bGwgPyB2b2lkIDAgOiBfYi5mb2N1cyh7IHByZXZlbnRTY3JvbGwgfSk7XG4gICAgfVxuICB9KTtcbiAgd2F0Y2goXG4gICAgdGFyZ2V0RWxlbWVudCxcbiAgICAoKSA9PiB7XG4gICAgICBmb2N1c2VkLnZhbHVlID0gaW5pdGlhbFZhbHVlO1xuICAgIH0sXG4gICAgeyBpbW1lZGlhdGU6IHRydWUsIGZsdXNoOiBcInBvc3RcIiB9XG4gICk7XG4gIHJldHVybiB7IGZvY3VzZWQgfTtcbn1cblxuY29uc3QgRVZFTlRfRk9DVVNfSU4gPSBcImZvY3VzaW5cIjtcbmNvbnN0IEVWRU5UX0ZPQ1VTX09VVCA9IFwiZm9jdXNvdXRcIjtcbmNvbnN0IFBTRVVET19DTEFTU19GT0NVU19XSVRISU4gPSBcIjpmb2N1cy13aXRoaW5cIjtcbmZ1bmN0aW9uIHVzZUZvY3VzV2l0aGluKHRhcmdldCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgd2luZG93ID0gZGVmYXVsdFdpbmRvdyB9ID0gb3B0aW9ucztcbiAgY29uc3QgdGFyZ2V0RWxlbWVudCA9IGNvbXB1dGVkKCgpID0+IHVucmVmRWxlbWVudCh0YXJnZXQpKTtcbiAgY29uc3QgX2ZvY3VzZWQgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgZm9jdXNlZCA9IGNvbXB1dGVkKCgpID0+IF9mb2N1c2VkLnZhbHVlKTtcbiAgY29uc3QgYWN0aXZlRWxlbWVudCA9IHVzZUFjdGl2ZUVsZW1lbnQob3B0aW9ucyk7XG4gIGlmICghd2luZG93IHx8ICFhY3RpdmVFbGVtZW50LnZhbHVlKSB7XG4gICAgcmV0dXJuIHsgZm9jdXNlZCB9O1xuICB9XG4gIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHsgcGFzc2l2ZTogdHJ1ZSB9O1xuICB1c2VFdmVudExpc3RlbmVyKHRhcmdldEVsZW1lbnQsIEVWRU5UX0ZPQ1VTX0lOLCAoKSA9PiBfZm9jdXNlZC52YWx1ZSA9IHRydWUsIGxpc3RlbmVyT3B0aW9ucyk7XG4gIHVzZUV2ZW50TGlzdGVuZXIodGFyZ2V0RWxlbWVudCwgRVZFTlRfRk9DVVNfT1VULCAoKSA9PiB7XG4gICAgdmFyIF9hLCBfYiwgX2M7XG4gICAgcmV0dXJuIF9mb2N1c2VkLnZhbHVlID0gKF9jID0gKF9iID0gKF9hID0gdGFyZ2V0RWxlbWVudC52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLm1hdGNoZXMpID09IG51bGwgPyB2b2lkIDAgOiBfYi5jYWxsKF9hLCBQU0VVRE9fQ0xBU1NfRk9DVVNfV0lUSElOKSkgIT0gbnVsbCA/IF9jIDogZmFsc2U7XG4gIH0sIGxpc3RlbmVyT3B0aW9ucyk7XG4gIHJldHVybiB7IGZvY3VzZWQgfTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUZwcyhvcHRpb25zKSB7XG4gIHZhciBfYTtcbiAgY29uc3QgZnBzID0gc2hhbGxvd1JlZigwKTtcbiAgaWYgKHR5cGVvZiBwZXJmb3JtYW5jZSA9PT0gXCJ1bmRlZmluZWRcIilcbiAgICByZXR1cm4gZnBzO1xuICBjb25zdCBldmVyeSA9IChfYSA9IG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuZXZlcnkpICE9IG51bGwgPyBfYSA6IDEwO1xuICBsZXQgbGFzdCA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICBsZXQgdGlja3MgPSAwO1xuICB1c2VSYWZGbigoKSA9PiB7XG4gICAgdGlja3MgKz0gMTtcbiAgICBpZiAodGlja3MgPj0gZXZlcnkpIHtcbiAgICAgIGNvbnN0IG5vdyA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgICAgY29uc3QgZGlmZiA9IG5vdyAtIGxhc3Q7XG4gICAgICBmcHMudmFsdWUgPSBNYXRoLnJvdW5kKDFlMyAvIChkaWZmIC8gdGlja3MpKTtcbiAgICAgIGxhc3QgPSBub3c7XG4gICAgICB0aWNrcyA9IDA7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIGZwcztcbn1cblxuY29uc3QgZXZlbnRIYW5kbGVycyA9IFtcbiAgXCJmdWxsc2NyZWVuY2hhbmdlXCIsXG4gIFwid2Via2l0ZnVsbHNjcmVlbmNoYW5nZVwiLFxuICBcIndlYmtpdGVuZGZ1bGxzY3JlZW5cIixcbiAgXCJtb3pmdWxsc2NyZWVuY2hhbmdlXCIsXG4gIFwiTVNGdWxsc2NyZWVuQ2hhbmdlXCJcbl07XG5mdW5jdGlvbiB1c2VGdWxsc2NyZWVuKHRhcmdldCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBkb2N1bWVudCA9IGRlZmF1bHREb2N1bWVudCxcbiAgICBhdXRvRXhpdCA9IGZhbHNlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCB0YXJnZXRSZWYgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIHJldHVybiAoX2EgPSB1bnJlZkVsZW1lbnQodGFyZ2V0KSkgIT0gbnVsbCA/IF9hIDogZG9jdW1lbnQgPT0gbnVsbCA/IHZvaWQgMCA6IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDtcbiAgfSk7XG4gIGNvbnN0IGlzRnVsbHNjcmVlbiA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCByZXF1ZXN0TWV0aG9kID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIHJldHVybiBbXG4gICAgICBcInJlcXVlc3RGdWxsc2NyZWVuXCIsXG4gICAgICBcIndlYmtpdFJlcXVlc3RGdWxsc2NyZWVuXCIsXG4gICAgICBcIndlYmtpdEVudGVyRnVsbHNjcmVlblwiLFxuICAgICAgXCJ3ZWJraXRFbnRlckZ1bGxTY3JlZW5cIixcbiAgICAgIFwid2Via2l0UmVxdWVzdEZ1bGxTY3JlZW5cIixcbiAgICAgIFwibW96UmVxdWVzdEZ1bGxTY3JlZW5cIixcbiAgICAgIFwibXNSZXF1ZXN0RnVsbHNjcmVlblwiXG4gICAgXS5maW5kKChtKSA9PiBkb2N1bWVudCAmJiBtIGluIGRvY3VtZW50IHx8IHRhcmdldFJlZi52YWx1ZSAmJiBtIGluIHRhcmdldFJlZi52YWx1ZSk7XG4gIH0pO1xuICBjb25zdCBleGl0TWV0aG9kID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIHJldHVybiBbXG4gICAgICBcImV4aXRGdWxsc2NyZWVuXCIsXG4gICAgICBcIndlYmtpdEV4aXRGdWxsc2NyZWVuXCIsXG4gICAgICBcIndlYmtpdEV4aXRGdWxsU2NyZWVuXCIsXG4gICAgICBcIndlYmtpdENhbmNlbEZ1bGxTY3JlZW5cIixcbiAgICAgIFwibW96Q2FuY2VsRnVsbFNjcmVlblwiLFxuICAgICAgXCJtc0V4aXRGdWxsc2NyZWVuXCJcbiAgICBdLmZpbmQoKG0pID0+IGRvY3VtZW50ICYmIG0gaW4gZG9jdW1lbnQgfHwgdGFyZ2V0UmVmLnZhbHVlICYmIG0gaW4gdGFyZ2V0UmVmLnZhbHVlKTtcbiAgfSk7XG4gIGNvbnN0IGZ1bGxzY3JlZW5FbmFibGVkID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIHJldHVybiBbXG4gICAgICBcImZ1bGxTY3JlZW5cIixcbiAgICAgIFwid2Via2l0SXNGdWxsU2NyZWVuXCIsXG4gICAgICBcIndlYmtpdERpc3BsYXlpbmdGdWxsc2NyZWVuXCIsXG4gICAgICBcIm1vekZ1bGxTY3JlZW5cIixcbiAgICAgIFwibXNGdWxsc2NyZWVuRWxlbWVudFwiXG4gICAgXS5maW5kKChtKSA9PiBkb2N1bWVudCAmJiBtIGluIGRvY3VtZW50IHx8IHRhcmdldFJlZi52YWx1ZSAmJiBtIGluIHRhcmdldFJlZi52YWx1ZSk7XG4gIH0pO1xuICBjb25zdCBmdWxsc2NyZWVuRWxlbWVudE1ldGhvZCA9IFtcbiAgICBcImZ1bGxzY3JlZW5FbGVtZW50XCIsXG4gICAgXCJ3ZWJraXRGdWxsc2NyZWVuRWxlbWVudFwiLFxuICAgIFwibW96RnVsbFNjcmVlbkVsZW1lbnRcIixcbiAgICBcIm1zRnVsbHNjcmVlbkVsZW1lbnRcIlxuICBdLmZpbmQoKG0pID0+IGRvY3VtZW50ICYmIG0gaW4gZG9jdW1lbnQpO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiB0YXJnZXRSZWYudmFsdWUgJiYgZG9jdW1lbnQgJiYgcmVxdWVzdE1ldGhvZC52YWx1ZSAhPT0gdm9pZCAwICYmIGV4aXRNZXRob2QudmFsdWUgIT09IHZvaWQgMCAmJiBmdWxsc2NyZWVuRW5hYmxlZC52YWx1ZSAhPT0gdm9pZCAwKTtcbiAgY29uc3QgaXNDdXJyZW50RWxlbWVudEZ1bGxTY3JlZW4gPSAoKSA9PiB7XG4gICAgaWYgKGZ1bGxzY3JlZW5FbGVtZW50TWV0aG9kKVxuICAgICAgcmV0dXJuIChkb2N1bWVudCA9PSBudWxsID8gdm9pZCAwIDogZG9jdW1lbnRbZnVsbHNjcmVlbkVsZW1lbnRNZXRob2RdKSA9PT0gdGFyZ2V0UmVmLnZhbHVlO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcbiAgY29uc3QgaXNFbGVtZW50RnVsbFNjcmVlbiA9ICgpID0+IHtcbiAgICBpZiAoZnVsbHNjcmVlbkVuYWJsZWQudmFsdWUpIHtcbiAgICAgIGlmIChkb2N1bWVudCAmJiBkb2N1bWVudFtmdWxsc2NyZWVuRW5hYmxlZC52YWx1ZV0gIT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gZG9jdW1lbnRbZnVsbHNjcmVlbkVuYWJsZWQudmFsdWVdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0MiA9IHRhcmdldFJlZi52YWx1ZTtcbiAgICAgICAgaWYgKCh0YXJnZXQyID09IG51bGwgPyB2b2lkIDAgOiB0YXJnZXQyW2Z1bGxzY3JlZW5FbmFibGVkLnZhbHVlXSkgIT0gbnVsbCkge1xuICAgICAgICAgIHJldHVybiBCb29sZWFuKHRhcmdldDJbZnVsbHNjcmVlbkVuYWJsZWQudmFsdWVdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG4gIGFzeW5jIGZ1bmN0aW9uIGV4aXQoKSB7XG4gICAgaWYgKCFpc1N1cHBvcnRlZC52YWx1ZSB8fCAhaXNGdWxsc2NyZWVuLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIGlmIChleGl0TWV0aG9kLnZhbHVlKSB7XG4gICAgICBpZiAoKGRvY3VtZW50ID09IG51bGwgPyB2b2lkIDAgOiBkb2N1bWVudFtleGl0TWV0aG9kLnZhbHVlXSkgIT0gbnVsbCkge1xuICAgICAgICBhd2FpdCBkb2N1bWVudFtleGl0TWV0aG9kLnZhbHVlXSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0MiA9IHRhcmdldFJlZi52YWx1ZTtcbiAgICAgICAgaWYgKCh0YXJnZXQyID09IG51bGwgPyB2b2lkIDAgOiB0YXJnZXQyW2V4aXRNZXRob2QudmFsdWVdKSAhPSBudWxsKVxuICAgICAgICAgIGF3YWl0IHRhcmdldDJbZXhpdE1ldGhvZC52YWx1ZV0oKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaXNGdWxsc2NyZWVuLnZhbHVlID0gZmFsc2U7XG4gIH1cbiAgYXN5bmMgZnVuY3Rpb24gZW50ZXIoKSB7XG4gICAgaWYgKCFpc1N1cHBvcnRlZC52YWx1ZSB8fCBpc0Z1bGxzY3JlZW4udmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgaWYgKGlzRWxlbWVudEZ1bGxTY3JlZW4oKSlcbiAgICAgIGF3YWl0IGV4aXQoKTtcbiAgICBjb25zdCB0YXJnZXQyID0gdGFyZ2V0UmVmLnZhbHVlO1xuICAgIGlmIChyZXF1ZXN0TWV0aG9kLnZhbHVlICYmICh0YXJnZXQyID09IG51bGwgPyB2b2lkIDAgOiB0YXJnZXQyW3JlcXVlc3RNZXRob2QudmFsdWVdKSAhPSBudWxsKSB7XG4gICAgICBhd2FpdCB0YXJnZXQyW3JlcXVlc3RNZXRob2QudmFsdWVdKCk7XG4gICAgICBpc0Z1bGxzY3JlZW4udmFsdWUgPSB0cnVlO1xuICAgIH1cbiAgfVxuICBhc3luYyBmdW5jdGlvbiB0b2dnbGUoKSB7XG4gICAgYXdhaXQgKGlzRnVsbHNjcmVlbi52YWx1ZSA/IGV4aXQoKSA6IGVudGVyKCkpO1xuICB9XG4gIGNvbnN0IGhhbmRsZXJDYWxsYmFjayA9ICgpID0+IHtcbiAgICBjb25zdCBpc0VsZW1lbnRGdWxsU2NyZWVuVmFsdWUgPSBpc0VsZW1lbnRGdWxsU2NyZWVuKCk7XG4gICAgaWYgKCFpc0VsZW1lbnRGdWxsU2NyZWVuVmFsdWUgfHwgaXNFbGVtZW50RnVsbFNjcmVlblZhbHVlICYmIGlzQ3VycmVudEVsZW1lbnRGdWxsU2NyZWVuKCkpXG4gICAgICBpc0Z1bGxzY3JlZW4udmFsdWUgPSBpc0VsZW1lbnRGdWxsU2NyZWVuVmFsdWU7XG4gIH07XG4gIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHsgY2FwdHVyZTogZmFsc2UsIHBhc3NpdmU6IHRydWUgfTtcbiAgdXNlRXZlbnRMaXN0ZW5lcihkb2N1bWVudCwgZXZlbnRIYW5kbGVycywgaGFuZGxlckNhbGxiYWNrLCBsaXN0ZW5lck9wdGlvbnMpO1xuICB1c2VFdmVudExpc3RlbmVyKCgpID0+IHVucmVmRWxlbWVudCh0YXJnZXRSZWYpLCBldmVudEhhbmRsZXJzLCBoYW5kbGVyQ2FsbGJhY2ssIGxpc3RlbmVyT3B0aW9ucyk7XG4gIHRyeU9uTW91bnRlZChoYW5kbGVyQ2FsbGJhY2ssIGZhbHNlKTtcbiAgaWYgKGF1dG9FeGl0KVxuICAgIHRyeU9uU2NvcGVEaXNwb3NlKGV4aXQpO1xuICByZXR1cm4ge1xuICAgIGlzU3VwcG9ydGVkLFxuICAgIGlzRnVsbHNjcmVlbixcbiAgICBlbnRlcixcbiAgICBleGl0LFxuICAgIHRvZ2dsZVxuICB9O1xufVxuXG5mdW5jdGlvbiBtYXBHYW1lcGFkVG9YYm94MzYwQ29udHJvbGxlcihnYW1lcGFkKSB7XG4gIHJldHVybiBjb21wdXRlZCgoKSA9PiB7XG4gICAgaWYgKGdhbWVwYWQudmFsdWUpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGJ1dHRvbnM6IHtcbiAgICAgICAgICBhOiBnYW1lcGFkLnZhbHVlLmJ1dHRvbnNbMF0sXG4gICAgICAgICAgYjogZ2FtZXBhZC52YWx1ZS5idXR0b25zWzFdLFxuICAgICAgICAgIHg6IGdhbWVwYWQudmFsdWUuYnV0dG9uc1syXSxcbiAgICAgICAgICB5OiBnYW1lcGFkLnZhbHVlLmJ1dHRvbnNbM11cbiAgICAgICAgfSxcbiAgICAgICAgYnVtcGVyOiB7XG4gICAgICAgICAgbGVmdDogZ2FtZXBhZC52YWx1ZS5idXR0b25zWzRdLFxuICAgICAgICAgIHJpZ2h0OiBnYW1lcGFkLnZhbHVlLmJ1dHRvbnNbNV1cbiAgICAgICAgfSxcbiAgICAgICAgdHJpZ2dlcnM6IHtcbiAgICAgICAgICBsZWZ0OiBnYW1lcGFkLnZhbHVlLmJ1dHRvbnNbNl0sXG4gICAgICAgICAgcmlnaHQ6IGdhbWVwYWQudmFsdWUuYnV0dG9uc1s3XVxuICAgICAgICB9LFxuICAgICAgICBzdGljazoge1xuICAgICAgICAgIGxlZnQ6IHtcbiAgICAgICAgICAgIGhvcml6b250YWw6IGdhbWVwYWQudmFsdWUuYXhlc1swXSxcbiAgICAgICAgICAgIHZlcnRpY2FsOiBnYW1lcGFkLnZhbHVlLmF4ZXNbMV0sXG4gICAgICAgICAgICBidXR0b246IGdhbWVwYWQudmFsdWUuYnV0dG9uc1sxMF1cbiAgICAgICAgICB9LFxuICAgICAgICAgIHJpZ2h0OiB7XG4gICAgICAgICAgICBob3Jpem9udGFsOiBnYW1lcGFkLnZhbHVlLmF4ZXNbMl0sXG4gICAgICAgICAgICB2ZXJ0aWNhbDogZ2FtZXBhZC52YWx1ZS5heGVzWzNdLFxuICAgICAgICAgICAgYnV0dG9uOiBnYW1lcGFkLnZhbHVlLmJ1dHRvbnNbMTFdXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBkcGFkOiB7XG4gICAgICAgICAgdXA6IGdhbWVwYWQudmFsdWUuYnV0dG9uc1sxMl0sXG4gICAgICAgICAgZG93bjogZ2FtZXBhZC52YWx1ZS5idXR0b25zWzEzXSxcbiAgICAgICAgICBsZWZ0OiBnYW1lcGFkLnZhbHVlLmJ1dHRvbnNbMTRdLFxuICAgICAgICAgIHJpZ2h0OiBnYW1lcGFkLnZhbHVlLmJ1dHRvbnNbMTVdXG4gICAgICAgIH0sXG4gICAgICAgIGJhY2s6IGdhbWVwYWQudmFsdWUuYnV0dG9uc1s4XSxcbiAgICAgICAgc3RhcnQ6IGdhbWVwYWQudmFsdWUuYnV0dG9uc1s5XVxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH0pO1xufVxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZUdhbWVwYWQob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBuYXZpZ2F0b3IgPSBkZWZhdWx0TmF2aWdhdG9yXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiBuYXZpZ2F0b3IgJiYgXCJnZXRHYW1lcGFkc1wiIGluIG5hdmlnYXRvcik7XG4gIGNvbnN0IGdhbWVwYWRzID0gcmVmKFtdKTtcbiAgY29uc3Qgb25Db25uZWN0ZWRIb29rID0gY3JlYXRlRXZlbnRIb29rKCk7XG4gIGNvbnN0IG9uRGlzY29ubmVjdGVkSG9vayA9IGNyZWF0ZUV2ZW50SG9vaygpO1xuICBjb25zdCBzdGF0ZUZyb21HYW1lcGFkID0gKGdhbWVwYWQpID0+IHtcbiAgICBjb25zdCBoYXB0aWNBY3R1YXRvcnMgPSBbXTtcbiAgICBjb25zdCB2aWJyYXRpb25BY3R1YXRvciA9IFwidmlicmF0aW9uQWN0dWF0b3JcIiBpbiBnYW1lcGFkID8gZ2FtZXBhZC52aWJyYXRpb25BY3R1YXRvciA6IG51bGw7XG4gICAgaWYgKHZpYnJhdGlvbkFjdHVhdG9yKVxuICAgICAgaGFwdGljQWN0dWF0b3JzLnB1c2godmlicmF0aW9uQWN0dWF0b3IpO1xuICAgIGlmIChnYW1lcGFkLmhhcHRpY0FjdHVhdG9ycylcbiAgICAgIGhhcHRpY0FjdHVhdG9ycy5wdXNoKC4uLmdhbWVwYWQuaGFwdGljQWN0dWF0b3JzKTtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IGdhbWVwYWQuaWQsXG4gICAgICBpbmRleDogZ2FtZXBhZC5pbmRleCxcbiAgICAgIGNvbm5lY3RlZDogZ2FtZXBhZC5jb25uZWN0ZWQsXG4gICAgICBtYXBwaW5nOiBnYW1lcGFkLm1hcHBpbmcsXG4gICAgICB0aW1lc3RhbXA6IGdhbWVwYWQudGltZXN0YW1wLFxuICAgICAgdmlicmF0aW9uQWN0dWF0b3I6IGdhbWVwYWQudmlicmF0aW9uQWN0dWF0b3IsXG4gICAgICBoYXB0aWNBY3R1YXRvcnMsXG4gICAgICBheGVzOiBnYW1lcGFkLmF4ZXMubWFwKChheGVzKSA9PiBheGVzKSxcbiAgICAgIGJ1dHRvbnM6IGdhbWVwYWQuYnV0dG9ucy5tYXAoKGJ1dHRvbikgPT4gKHsgcHJlc3NlZDogYnV0dG9uLnByZXNzZWQsIHRvdWNoZWQ6IGJ1dHRvbi50b3VjaGVkLCB2YWx1ZTogYnV0dG9uLnZhbHVlIH0pKVxuICAgIH07XG4gIH07XG4gIGNvbnN0IHVwZGF0ZUdhbWVwYWRTdGF0ZSA9ICgpID0+IHtcbiAgICBjb25zdCBfZ2FtZXBhZHMgPSAobmF2aWdhdG9yID09IG51bGwgPyB2b2lkIDAgOiBuYXZpZ2F0b3IuZ2V0R2FtZXBhZHMoKSkgfHwgW107XG4gICAgZm9yIChjb25zdCBnYW1lcGFkIG9mIF9nYW1lcGFkcykge1xuICAgICAgaWYgKGdhbWVwYWQgJiYgZ2FtZXBhZHMudmFsdWVbZ2FtZXBhZC5pbmRleF0pXG4gICAgICAgIGdhbWVwYWRzLnZhbHVlW2dhbWVwYWQuaW5kZXhdID0gc3RhdGVGcm9tR2FtZXBhZChnYW1lcGFkKTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IHsgaXNBY3RpdmUsIHBhdXNlLCByZXN1bWUgfSA9IHVzZVJhZkZuKHVwZGF0ZUdhbWVwYWRTdGF0ZSk7XG4gIGNvbnN0IG9uR2FtZXBhZENvbm5lY3RlZCA9IChnYW1lcGFkKSA9PiB7XG4gICAgaWYgKCFnYW1lcGFkcy52YWx1ZS5zb21lKCh7IGluZGV4IH0pID0+IGluZGV4ID09PSBnYW1lcGFkLmluZGV4KSkge1xuICAgICAgZ2FtZXBhZHMudmFsdWUucHVzaChzdGF0ZUZyb21HYW1lcGFkKGdhbWVwYWQpKTtcbiAgICAgIG9uQ29ubmVjdGVkSG9vay50cmlnZ2VyKGdhbWVwYWQuaW5kZXgpO1xuICAgIH1cbiAgICByZXN1bWUoKTtcbiAgfTtcbiAgY29uc3Qgb25HYW1lcGFkRGlzY29ubmVjdGVkID0gKGdhbWVwYWQpID0+IHtcbiAgICBnYW1lcGFkcy52YWx1ZSA9IGdhbWVwYWRzLnZhbHVlLmZpbHRlcigoeCkgPT4geC5pbmRleCAhPT0gZ2FtZXBhZC5pbmRleCk7XG4gICAgb25EaXNjb25uZWN0ZWRIb29rLnRyaWdnZXIoZ2FtZXBhZC5pbmRleCk7XG4gIH07XG4gIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHsgcGFzc2l2ZTogdHJ1ZSB9O1xuICB1c2VFdmVudExpc3RlbmVyKFwiZ2FtZXBhZGNvbm5lY3RlZFwiLCAoZSkgPT4gb25HYW1lcGFkQ29ubmVjdGVkKGUuZ2FtZXBhZCksIGxpc3RlbmVyT3B0aW9ucyk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoXCJnYW1lcGFkZGlzY29ubmVjdGVkXCIsIChlKSA9PiBvbkdhbWVwYWREaXNjb25uZWN0ZWQoZS5nYW1lcGFkKSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgdHJ5T25Nb3VudGVkKCgpID0+IHtcbiAgICBjb25zdCBfZ2FtZXBhZHMgPSAobmF2aWdhdG9yID09IG51bGwgPyB2b2lkIDAgOiBuYXZpZ2F0b3IuZ2V0R2FtZXBhZHMoKSkgfHwgW107XG4gICAgZm9yIChjb25zdCBnYW1lcGFkIG9mIF9nYW1lcGFkcykge1xuICAgICAgaWYgKGdhbWVwYWQgJiYgZ2FtZXBhZHMudmFsdWVbZ2FtZXBhZC5pbmRleF0pXG4gICAgICAgIG9uR2FtZXBhZENvbm5lY3RlZChnYW1lcGFkKTtcbiAgICB9XG4gIH0pO1xuICBwYXVzZSgpO1xuICByZXR1cm4ge1xuICAgIGlzU3VwcG9ydGVkLFxuICAgIG9uQ29ubmVjdGVkOiBvbkNvbm5lY3RlZEhvb2sub24sXG4gICAgb25EaXNjb25uZWN0ZWQ6IG9uRGlzY29ubmVjdGVkSG9vay5vbixcbiAgICBnYW1lcGFkcyxcbiAgICBwYXVzZSxcbiAgICByZXN1bWUsXG4gICAgaXNBY3RpdmVcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlR2VvbG9jYXRpb24ob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBlbmFibGVIaWdoQWNjdXJhY3kgPSB0cnVlLFxuICAgIG1heGltdW1BZ2UgPSAzZTQsXG4gICAgdGltZW91dCA9IDI3ZTMsXG4gICAgbmF2aWdhdG9yID0gZGVmYXVsdE5hdmlnYXRvcixcbiAgICBpbW1lZGlhdGUgPSB0cnVlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiBuYXZpZ2F0b3IgJiYgXCJnZW9sb2NhdGlvblwiIGluIG5hdmlnYXRvcik7XG4gIGNvbnN0IGxvY2F0ZWRBdCA9IHNoYWxsb3dSZWYobnVsbCk7XG4gIGNvbnN0IGVycm9yID0gc2hhbGxvd1JlZihudWxsKTtcbiAgY29uc3QgY29vcmRzID0gcmVmKHtcbiAgICBhY2N1cmFjeTogMCxcbiAgICBsYXRpdHVkZTogTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLFxuICAgIGxvbmdpdHVkZTogTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLFxuICAgIGFsdGl0dWRlOiBudWxsLFxuICAgIGFsdGl0dWRlQWNjdXJhY3k6IG51bGwsXG4gICAgaGVhZGluZzogbnVsbCxcbiAgICBzcGVlZDogbnVsbFxuICB9KTtcbiAgZnVuY3Rpb24gdXBkYXRlUG9zaXRpb24ocG9zaXRpb24pIHtcbiAgICBsb2NhdGVkQXQudmFsdWUgPSBwb3NpdGlvbi50aW1lc3RhbXA7XG4gICAgY29vcmRzLnZhbHVlID0gcG9zaXRpb24uY29vcmRzO1xuICAgIGVycm9yLnZhbHVlID0gbnVsbDtcbiAgfVxuICBsZXQgd2F0Y2hlcjtcbiAgZnVuY3Rpb24gcmVzdW1lKCkge1xuICAgIGlmIChpc1N1cHBvcnRlZC52YWx1ZSkge1xuICAgICAgd2F0Y2hlciA9IG5hdmlnYXRvci5nZW9sb2NhdGlvbi53YXRjaFBvc2l0aW9uKFxuICAgICAgICB1cGRhdGVQb3NpdGlvbixcbiAgICAgICAgKGVycikgPT4gZXJyb3IudmFsdWUgPSBlcnIsXG4gICAgICAgIHtcbiAgICAgICAgICBlbmFibGVIaWdoQWNjdXJhY3ksXG4gICAgICAgICAgbWF4aW11bUFnZSxcbiAgICAgICAgICB0aW1lb3V0XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICB9XG4gIGlmIChpbW1lZGlhdGUpXG4gICAgcmVzdW1lKCk7XG4gIGZ1bmN0aW9uIHBhdXNlKCkge1xuICAgIGlmICh3YXRjaGVyICYmIG5hdmlnYXRvcilcbiAgICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5jbGVhcldhdGNoKHdhdGNoZXIpO1xuICB9XG4gIHRyeU9uU2NvcGVEaXNwb3NlKCgpID0+IHtcbiAgICBwYXVzZSgpO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBjb29yZHMsXG4gICAgbG9jYXRlZEF0LFxuICAgIGVycm9yLFxuICAgIHJlc3VtZSxcbiAgICBwYXVzZVxuICB9O1xufVxuXG5jb25zdCBkZWZhdWx0RXZlbnRzJDEgPSBbXCJtb3VzZW1vdmVcIiwgXCJtb3VzZWRvd25cIiwgXCJyZXNpemVcIiwgXCJrZXlkb3duXCIsIFwidG91Y2hzdGFydFwiLCBcIndoZWVsXCJdO1xuY29uc3Qgb25lTWludXRlID0gNmU0O1xuZnVuY3Rpb24gdXNlSWRsZSh0aW1lb3V0ID0gb25lTWludXRlLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGluaXRpYWxTdGF0ZSA9IGZhbHNlLFxuICAgIGxpc3RlbkZvclZpc2liaWxpdHlDaGFuZ2UgPSB0cnVlLFxuICAgIGV2ZW50cyA9IGRlZmF1bHRFdmVudHMkMSxcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93LFxuICAgIGV2ZW50RmlsdGVyID0gdGhyb3R0bGVGaWx0ZXIoNTApXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBpZGxlID0gc2hhbGxvd1JlZihpbml0aWFsU3RhdGUpO1xuICBjb25zdCBsYXN0QWN0aXZlID0gc2hhbGxvd1JlZih0aW1lc3RhbXAoKSk7XG4gIGxldCB0aW1lcjtcbiAgY29uc3QgcmVzZXQgPSAoKSA9PiB7XG4gICAgaWRsZS52YWx1ZSA9IGZhbHNlO1xuICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IGlkbGUudmFsdWUgPSB0cnVlLCB0aW1lb3V0KTtcbiAgfTtcbiAgY29uc3Qgb25FdmVudCA9IGNyZWF0ZUZpbHRlcldyYXBwZXIoXG4gICAgZXZlbnRGaWx0ZXIsXG4gICAgKCkgPT4ge1xuICAgICAgbGFzdEFjdGl2ZS52YWx1ZSA9IHRpbWVzdGFtcCgpO1xuICAgICAgcmVzZXQoKTtcbiAgICB9XG4gICk7XG4gIGlmICh3aW5kb3cpIHtcbiAgICBjb25zdCBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDtcbiAgICBjb25zdCBsaXN0ZW5lck9wdGlvbnMgPSB7IHBhc3NpdmU6IHRydWUgfTtcbiAgICBmb3IgKGNvbnN0IGV2ZW50IG9mIGV2ZW50cylcbiAgICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBldmVudCwgb25FdmVudCwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICBpZiAobGlzdGVuRm9yVmlzaWJpbGl0eUNoYW5nZSkge1xuICAgICAgdXNlRXZlbnRMaXN0ZW5lcihkb2N1bWVudCwgXCJ2aXNpYmlsaXR5Y2hhbmdlXCIsICgpID0+IHtcbiAgICAgICAgaWYgKCFkb2N1bWVudC5oaWRkZW4pXG4gICAgICAgICAgb25FdmVudCgpO1xuICAgICAgfSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICB9XG4gICAgaWYgKCFpbml0aWFsU3RhdGUpXG4gICAgICByZXNldCgpO1xuICB9XG4gIHJldHVybiB7XG4gICAgaWRsZSxcbiAgICBsYXN0QWN0aXZlLFxuICAgIHJlc2V0XG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvYWRJbWFnZShvcHRpb25zKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7XG4gICAgY29uc3QgeyBzcmMsIHNyY3NldCwgc2l6ZXMsIGNsYXNzOiBjbGF6eiwgbG9hZGluZywgY3Jvc3NvcmlnaW4sIHJlZmVycmVyUG9saWN5LCB3aWR0aCwgaGVpZ2h0LCBkZWNvZGluZywgZmV0Y2hQcmlvcml0eSwgaXNtYXAsIHVzZW1hcCB9ID0gb3B0aW9ucztcbiAgICBpbWcuc3JjID0gc3JjO1xuICAgIGlmIChzcmNzZXQgIT0gbnVsbClcbiAgICAgIGltZy5zcmNzZXQgPSBzcmNzZXQ7XG4gICAgaWYgKHNpemVzICE9IG51bGwpXG4gICAgICBpbWcuc2l6ZXMgPSBzaXplcztcbiAgICBpZiAoY2xhenogIT0gbnVsbClcbiAgICAgIGltZy5jbGFzc05hbWUgPSBjbGF6ejtcbiAgICBpZiAobG9hZGluZyAhPSBudWxsKVxuICAgICAgaW1nLmxvYWRpbmcgPSBsb2FkaW5nO1xuICAgIGlmIChjcm9zc29yaWdpbiAhPSBudWxsKVxuICAgICAgaW1nLmNyb3NzT3JpZ2luID0gY3Jvc3NvcmlnaW47XG4gICAgaWYgKHJlZmVycmVyUG9saWN5ICE9IG51bGwpXG4gICAgICBpbWcucmVmZXJyZXJQb2xpY3kgPSByZWZlcnJlclBvbGljeTtcbiAgICBpZiAod2lkdGggIT0gbnVsbClcbiAgICAgIGltZy53aWR0aCA9IHdpZHRoO1xuICAgIGlmIChoZWlnaHQgIT0gbnVsbClcbiAgICAgIGltZy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgaWYgKGRlY29kaW5nICE9IG51bGwpXG4gICAgICBpbWcuZGVjb2RpbmcgPSBkZWNvZGluZztcbiAgICBpZiAoZmV0Y2hQcmlvcml0eSAhPSBudWxsKVxuICAgICAgaW1nLmZldGNoUHJpb3JpdHkgPSBmZXRjaFByaW9yaXR5O1xuICAgIGlmIChpc21hcCAhPSBudWxsKVxuICAgICAgaW1nLmlzTWFwID0gaXNtYXA7XG4gICAgaWYgKHVzZW1hcCAhPSBudWxsKVxuICAgICAgaW1nLnVzZU1hcCA9IHVzZW1hcDtcbiAgICBpbWcub25sb2FkID0gKCkgPT4gcmVzb2x2ZShpbWcpO1xuICAgIGltZy5vbmVycm9yID0gcmVqZWN0O1xuICB9KTtcbn1cbmZ1bmN0aW9uIHVzZUltYWdlKG9wdGlvbnMsIGFzeW5jU3RhdGVPcHRpb25zID0ge30pIHtcbiAgY29uc3Qgc3RhdGUgPSB1c2VBc3luY1N0YXRlKFxuICAgICgpID0+IGxvYWRJbWFnZSh0b1ZhbHVlKG9wdGlvbnMpKSxcbiAgICB2b2lkIDAsXG4gICAge1xuICAgICAgcmVzZXRPbkV4ZWN1dGU6IHRydWUsXG4gICAgICAuLi5hc3luY1N0YXRlT3B0aW9uc1xuICAgIH1cbiAgKTtcbiAgd2F0Y2goXG4gICAgKCkgPT4gdG9WYWx1ZShvcHRpb25zKSxcbiAgICAoKSA9PiBzdGF0ZS5leGVjdXRlKGFzeW5jU3RhdGVPcHRpb25zLmRlbGF5KSxcbiAgICB7IGRlZXA6IHRydWUgfVxuICApO1xuICByZXR1cm4gc3RhdGU7XG59XG5cbmZ1bmN0aW9uIHJlc29sdmVFbGVtZW50KGVsKSB7XG4gIGlmICh0eXBlb2YgV2luZG93ICE9PSBcInVuZGVmaW5lZFwiICYmIGVsIGluc3RhbmNlb2YgV2luZG93KVxuICAgIHJldHVybiBlbC5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7XG4gIGlmICh0eXBlb2YgRG9jdW1lbnQgIT09IFwidW5kZWZpbmVkXCIgJiYgZWwgaW5zdGFuY2VvZiBEb2N1bWVudClcbiAgICByZXR1cm4gZWwuZG9jdW1lbnRFbGVtZW50O1xuICByZXR1cm4gZWw7XG59XG5cbmNvbnN0IEFSUklWRURfU1RBVEVfVEhSRVNIT0xEX1BJWEVMUyA9IDE7XG5mdW5jdGlvbiB1c2VTY3JvbGwoZWxlbWVudCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB0aHJvdHRsZSA9IDAsXG4gICAgaWRsZSA9IDIwMCxcbiAgICBvblN0b3AgPSBub29wLFxuICAgIG9uU2Nyb2xsID0gbm9vcCxcbiAgICBvZmZzZXQgPSB7XG4gICAgICBsZWZ0OiAwLFxuICAgICAgcmlnaHQ6IDAsXG4gICAgICB0b3A6IDAsXG4gICAgICBib3R0b206IDBcbiAgICB9LFxuICAgIG9ic2VydmU6IF9vYnNlcnZlID0ge1xuICAgICAgbXV0YXRpb246IGZhbHNlXG4gICAgfSxcbiAgICBldmVudExpc3RlbmVyT3B0aW9ucyA9IHtcbiAgICAgIGNhcHR1cmU6IGZhbHNlLFxuICAgICAgcGFzc2l2ZTogdHJ1ZVxuICAgIH0sXG4gICAgYmVoYXZpb3IgPSBcImF1dG9cIixcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93LFxuICAgIG9uRXJyb3IgPSAoZSkgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICB9XG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBvYnNlcnZlID0gdHlwZW9mIF9vYnNlcnZlID09PSBcImJvb2xlYW5cIiA/IHtcbiAgICBtdXRhdGlvbjogX29ic2VydmVcbiAgfSA6IF9vYnNlcnZlO1xuICBjb25zdCBpbnRlcm5hbFggPSBzaGFsbG93UmVmKDApO1xuICBjb25zdCBpbnRlcm5hbFkgPSBzaGFsbG93UmVmKDApO1xuICBjb25zdCB4ID0gY29tcHV0ZWQoe1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBpbnRlcm5hbFgudmFsdWU7XG4gICAgfSxcbiAgICBzZXQoeDIpIHtcbiAgICAgIHNjcm9sbFRvKHgyLCB2b2lkIDApO1xuICAgIH1cbiAgfSk7XG4gIGNvbnN0IHkgPSBjb21wdXRlZCh7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGludGVybmFsWS52YWx1ZTtcbiAgICB9LFxuICAgIHNldCh5Mikge1xuICAgICAgc2Nyb2xsVG8odm9pZCAwLCB5Mik7XG4gICAgfVxuICB9KTtcbiAgZnVuY3Rpb24gc2Nyb2xsVG8oX3gsIF95KSB7XG4gICAgdmFyIF9hLCBfYiwgX2MsIF9kO1xuICAgIGlmICghd2luZG93KVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IF9lbGVtZW50ID0gdG9WYWx1ZShlbGVtZW50KTtcbiAgICBpZiAoIV9lbGVtZW50KVxuICAgICAgcmV0dXJuO1xuICAgIChfYyA9IF9lbGVtZW50IGluc3RhbmNlb2YgRG9jdW1lbnQgPyB3aW5kb3cuZG9jdW1lbnQuYm9keSA6IF9lbGVtZW50KSA9PSBudWxsID8gdm9pZCAwIDogX2Muc2Nyb2xsVG8oe1xuICAgICAgdG9wOiAoX2EgPSB0b1ZhbHVlKF95KSkgIT0gbnVsbCA/IF9hIDogeS52YWx1ZSxcbiAgICAgIGxlZnQ6IChfYiA9IHRvVmFsdWUoX3gpKSAhPSBudWxsID8gX2IgOiB4LnZhbHVlLFxuICAgICAgYmVoYXZpb3I6IHRvVmFsdWUoYmVoYXZpb3IpXG4gICAgfSk7XG4gICAgY29uc3Qgc2Nyb2xsQ29udGFpbmVyID0gKChfZCA9IF9lbGVtZW50ID09IG51bGwgPyB2b2lkIDAgOiBfZWxlbWVudC5kb2N1bWVudCkgPT0gbnVsbCA/IHZvaWQgMCA6IF9kLmRvY3VtZW50RWxlbWVudCkgfHwgKF9lbGVtZW50ID09IG51bGwgPyB2b2lkIDAgOiBfZWxlbWVudC5kb2N1bWVudEVsZW1lbnQpIHx8IF9lbGVtZW50O1xuICAgIGlmICh4ICE9IG51bGwpXG4gICAgICBpbnRlcm5hbFgudmFsdWUgPSBzY3JvbGxDb250YWluZXIuc2Nyb2xsTGVmdDtcbiAgICBpZiAoeSAhPSBudWxsKVxuICAgICAgaW50ZXJuYWxZLnZhbHVlID0gc2Nyb2xsQ29udGFpbmVyLnNjcm9sbFRvcDtcbiAgfVxuICBjb25zdCBpc1Njcm9sbGluZyA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBhcnJpdmVkU3RhdGUgPSByZWFjdGl2ZSh7XG4gICAgbGVmdDogdHJ1ZSxcbiAgICByaWdodDogZmFsc2UsXG4gICAgdG9wOiB0cnVlLFxuICAgIGJvdHRvbTogZmFsc2VcbiAgfSk7XG4gIGNvbnN0IGRpcmVjdGlvbnMgPSByZWFjdGl2ZSh7XG4gICAgbGVmdDogZmFsc2UsXG4gICAgcmlnaHQ6IGZhbHNlLFxuICAgIHRvcDogZmFsc2UsXG4gICAgYm90dG9tOiBmYWxzZVxuICB9KTtcbiAgY29uc3Qgb25TY3JvbGxFbmQgPSAoZSkgPT4ge1xuICAgIGlmICghaXNTY3JvbGxpbmcudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgaXNTY3JvbGxpbmcudmFsdWUgPSBmYWxzZTtcbiAgICBkaXJlY3Rpb25zLmxlZnQgPSBmYWxzZTtcbiAgICBkaXJlY3Rpb25zLnJpZ2h0ID0gZmFsc2U7XG4gICAgZGlyZWN0aW9ucy50b3AgPSBmYWxzZTtcbiAgICBkaXJlY3Rpb25zLmJvdHRvbSA9IGZhbHNlO1xuICAgIG9uU3RvcChlKTtcbiAgfTtcbiAgY29uc3Qgb25TY3JvbGxFbmREZWJvdW5jZWQgPSB1c2VEZWJvdW5jZUZuKG9uU2Nyb2xsRW5kLCB0aHJvdHRsZSArIGlkbGUpO1xuICBjb25zdCBzZXRBcnJpdmVkU3RhdGUgPSAodGFyZ2V0KSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIGlmICghd2luZG93KVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IGVsID0gKChfYSA9IHRhcmdldCA9PSBudWxsID8gdm9pZCAwIDogdGFyZ2V0LmRvY3VtZW50KSA9PSBudWxsID8gdm9pZCAwIDogX2EuZG9jdW1lbnRFbGVtZW50KSB8fCAodGFyZ2V0ID09IG51bGwgPyB2b2lkIDAgOiB0YXJnZXQuZG9jdW1lbnRFbGVtZW50KSB8fCB1bnJlZkVsZW1lbnQodGFyZ2V0KTtcbiAgICBjb25zdCB7IGRpc3BsYXksIGZsZXhEaXJlY3Rpb24sIGRpcmVjdGlvbiB9ID0gZ2V0Q29tcHV0ZWRTdHlsZShlbCk7XG4gICAgY29uc3QgZGlyZWN0aW9uTXVsdGlwbGVyID0gZGlyZWN0aW9uID09PSBcInJ0bFwiID8gLTEgOiAxO1xuICAgIGNvbnN0IHNjcm9sbExlZnQgPSBlbC5zY3JvbGxMZWZ0O1xuICAgIGRpcmVjdGlvbnMubGVmdCA9IHNjcm9sbExlZnQgPCBpbnRlcm5hbFgudmFsdWU7XG4gICAgZGlyZWN0aW9ucy5yaWdodCA9IHNjcm9sbExlZnQgPiBpbnRlcm5hbFgudmFsdWU7XG4gICAgY29uc3QgbGVmdCA9IE1hdGguYWJzKHNjcm9sbExlZnQgKiBkaXJlY3Rpb25NdWx0aXBsZXIpIDw9IChvZmZzZXQubGVmdCB8fCAwKTtcbiAgICBjb25zdCByaWdodCA9IE1hdGguYWJzKHNjcm9sbExlZnQgKiBkaXJlY3Rpb25NdWx0aXBsZXIpICsgZWwuY2xpZW50V2lkdGggPj0gZWwuc2Nyb2xsV2lkdGggLSAob2Zmc2V0LnJpZ2h0IHx8IDApIC0gQVJSSVZFRF9TVEFURV9USFJFU0hPTERfUElYRUxTO1xuICAgIGlmIChkaXNwbGF5ID09PSBcImZsZXhcIiAmJiBmbGV4RGlyZWN0aW9uID09PSBcInJvdy1yZXZlcnNlXCIpIHtcbiAgICAgIGFycml2ZWRTdGF0ZS5sZWZ0ID0gcmlnaHQ7XG4gICAgICBhcnJpdmVkU3RhdGUucmlnaHQgPSBsZWZ0O1xuICAgIH0gZWxzZSB7XG4gICAgICBhcnJpdmVkU3RhdGUubGVmdCA9IGxlZnQ7XG4gICAgICBhcnJpdmVkU3RhdGUucmlnaHQgPSByaWdodDtcbiAgICB9XG4gICAgaW50ZXJuYWxYLnZhbHVlID0gc2Nyb2xsTGVmdDtcbiAgICBsZXQgc2Nyb2xsVG9wID0gZWwuc2Nyb2xsVG9wO1xuICAgIGlmICh0YXJnZXQgPT09IHdpbmRvdy5kb2N1bWVudCAmJiAhc2Nyb2xsVG9wKVxuICAgICAgc2Nyb2xsVG9wID0gd2luZG93LmRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wO1xuICAgIGRpcmVjdGlvbnMudG9wID0gc2Nyb2xsVG9wIDwgaW50ZXJuYWxZLnZhbHVlO1xuICAgIGRpcmVjdGlvbnMuYm90dG9tID0gc2Nyb2xsVG9wID4gaW50ZXJuYWxZLnZhbHVlO1xuICAgIGNvbnN0IHRvcCA9IE1hdGguYWJzKHNjcm9sbFRvcCkgPD0gKG9mZnNldC50b3AgfHwgMCk7XG4gICAgY29uc3QgYm90dG9tID0gTWF0aC5hYnMoc2Nyb2xsVG9wKSArIGVsLmNsaWVudEhlaWdodCA+PSBlbC5zY3JvbGxIZWlnaHQgLSAob2Zmc2V0LmJvdHRvbSB8fCAwKSAtIEFSUklWRURfU1RBVEVfVEhSRVNIT0xEX1BJWEVMUztcbiAgICBpZiAoZGlzcGxheSA9PT0gXCJmbGV4XCIgJiYgZmxleERpcmVjdGlvbiA9PT0gXCJjb2x1bW4tcmV2ZXJzZVwiKSB7XG4gICAgICBhcnJpdmVkU3RhdGUudG9wID0gYm90dG9tO1xuICAgICAgYXJyaXZlZFN0YXRlLmJvdHRvbSA9IHRvcDtcbiAgICB9IGVsc2Uge1xuICAgICAgYXJyaXZlZFN0YXRlLnRvcCA9IHRvcDtcbiAgICAgIGFycml2ZWRTdGF0ZS5ib3R0b20gPSBib3R0b207XG4gICAgfVxuICAgIGludGVybmFsWS52YWx1ZSA9IHNjcm9sbFRvcDtcbiAgfTtcbiAgY29uc3Qgb25TY3JvbGxIYW5kbGVyID0gKGUpID0+IHtcbiAgICB2YXIgX2E7XG4gICAgaWYgKCF3aW5kb3cpXG4gICAgICByZXR1cm47XG4gICAgY29uc3QgZXZlbnRUYXJnZXQgPSAoX2EgPSBlLnRhcmdldC5kb2N1bWVudEVsZW1lbnQpICE9IG51bGwgPyBfYSA6IGUudGFyZ2V0O1xuICAgIHNldEFycml2ZWRTdGF0ZShldmVudFRhcmdldCk7XG4gICAgaXNTY3JvbGxpbmcudmFsdWUgPSB0cnVlO1xuICAgIG9uU2Nyb2xsRW5kRGVib3VuY2VkKGUpO1xuICAgIG9uU2Nyb2xsKGUpO1xuICB9O1xuICB1c2VFdmVudExpc3RlbmVyKFxuICAgIGVsZW1lbnQsXG4gICAgXCJzY3JvbGxcIixcbiAgICB0aHJvdHRsZSA/IHVzZVRocm90dGxlRm4ob25TY3JvbGxIYW5kbGVyLCB0aHJvdHRsZSwgdHJ1ZSwgZmFsc2UpIDogb25TY3JvbGxIYW5kbGVyLFxuICAgIGV2ZW50TGlzdGVuZXJPcHRpb25zXG4gICk7XG4gIHRyeU9uTW91bnRlZCgoKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IF9lbGVtZW50ID0gdG9WYWx1ZShlbGVtZW50KTtcbiAgICAgIGlmICghX2VsZW1lbnQpXG4gICAgICAgIHJldHVybjtcbiAgICAgIHNldEFycml2ZWRTdGF0ZShfZWxlbWVudCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgb25FcnJvcihlKTtcbiAgICB9XG4gIH0pO1xuICBpZiAoKG9ic2VydmUgPT0gbnVsbCA/IHZvaWQgMCA6IG9ic2VydmUubXV0YXRpb24pICYmIGVsZW1lbnQgIT0gbnVsbCAmJiBlbGVtZW50ICE9PSB3aW5kb3cgJiYgZWxlbWVudCAhPT0gZG9jdW1lbnQpIHtcbiAgICB1c2VNdXRhdGlvbk9ic2VydmVyKFxuICAgICAgZWxlbWVudCxcbiAgICAgICgpID0+IHtcbiAgICAgICAgY29uc3QgX2VsZW1lbnQgPSB0b1ZhbHVlKGVsZW1lbnQpO1xuICAgICAgICBpZiAoIV9lbGVtZW50KVxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgc2V0QXJyaXZlZFN0YXRlKF9lbGVtZW50KTtcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGF0dHJpYnV0ZXM6IHRydWUsXG4gICAgICAgIGNoaWxkTGlzdDogdHJ1ZSxcbiAgICAgICAgc3VidHJlZTogdHJ1ZVxuICAgICAgfVxuICAgICk7XG4gIH1cbiAgdXNlRXZlbnRMaXN0ZW5lcihcbiAgICBlbGVtZW50LFxuICAgIFwic2Nyb2xsZW5kXCIsXG4gICAgb25TY3JvbGxFbmQsXG4gICAgZXZlbnRMaXN0ZW5lck9wdGlvbnNcbiAgKTtcbiAgcmV0dXJuIHtcbiAgICB4LFxuICAgIHksXG4gICAgaXNTY3JvbGxpbmcsXG4gICAgYXJyaXZlZFN0YXRlLFxuICAgIGRpcmVjdGlvbnMsXG4gICAgbWVhc3VyZSgpIHtcbiAgICAgIGNvbnN0IF9lbGVtZW50ID0gdG9WYWx1ZShlbGVtZW50KTtcbiAgICAgIGlmICh3aW5kb3cgJiYgX2VsZW1lbnQpXG4gICAgICAgIHNldEFycml2ZWRTdGF0ZShfZWxlbWVudCk7XG4gICAgfVxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VJbmZpbml0ZVNjcm9sbChlbGVtZW50LCBvbkxvYWRNb3JlLCBvcHRpb25zID0ge30pIHtcbiAgdmFyIF9hO1xuICBjb25zdCB7XG4gICAgZGlyZWN0aW9uID0gXCJib3R0b21cIixcbiAgICBpbnRlcnZhbCA9IDEwMCxcbiAgICBjYW5Mb2FkTW9yZSA9ICgpID0+IHRydWVcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHN0YXRlID0gcmVhY3RpdmUodXNlU2Nyb2xsKFxuICAgIGVsZW1lbnQsXG4gICAge1xuICAgICAgLi4ub3B0aW9ucyxcbiAgICAgIG9mZnNldDoge1xuICAgICAgICBbZGlyZWN0aW9uXTogKF9hID0gb3B0aW9ucy5kaXN0YW5jZSkgIT0gbnVsbCA/IF9hIDogMCxcbiAgICAgICAgLi4ub3B0aW9ucy5vZmZzZXRcbiAgICAgIH1cbiAgICB9XG4gICkpO1xuICBjb25zdCBwcm9taXNlID0gcmVmKCk7XG4gIGNvbnN0IGlzTG9hZGluZyA9IGNvbXB1dGVkKCgpID0+ICEhcHJvbWlzZS52YWx1ZSk7XG4gIGNvbnN0IG9ic2VydmVkRWxlbWVudCA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICByZXR1cm4gcmVzb2x2ZUVsZW1lbnQodG9WYWx1ZShlbGVtZW50KSk7XG4gIH0pO1xuICBjb25zdCBpc0VsZW1lbnRWaXNpYmxlID0gdXNlRWxlbWVudFZpc2liaWxpdHkob2JzZXJ2ZWRFbGVtZW50KTtcbiAgZnVuY3Rpb24gY2hlY2tBbmRMb2FkKCkge1xuICAgIHN0YXRlLm1lYXN1cmUoKTtcbiAgICBpZiAoIW9ic2VydmVkRWxlbWVudC52YWx1ZSB8fCAhaXNFbGVtZW50VmlzaWJsZS52YWx1ZSB8fCAhY2FuTG9hZE1vcmUob2JzZXJ2ZWRFbGVtZW50LnZhbHVlKSlcbiAgICAgIHJldHVybjtcbiAgICBjb25zdCB7IHNjcm9sbEhlaWdodCwgY2xpZW50SGVpZ2h0LCBzY3JvbGxXaWR0aCwgY2xpZW50V2lkdGggfSA9IG9ic2VydmVkRWxlbWVudC52YWx1ZTtcbiAgICBjb25zdCBpc05hcnJvd2VyID0gZGlyZWN0aW9uID09PSBcImJvdHRvbVwiIHx8IGRpcmVjdGlvbiA9PT0gXCJ0b3BcIiA/IHNjcm9sbEhlaWdodCA8PSBjbGllbnRIZWlnaHQgOiBzY3JvbGxXaWR0aCA8PSBjbGllbnRXaWR0aDtcbiAgICBpZiAoc3RhdGUuYXJyaXZlZFN0YXRlW2RpcmVjdGlvbl0gfHwgaXNOYXJyb3dlcikge1xuICAgICAgaWYgKCFwcm9taXNlLnZhbHVlKSB7XG4gICAgICAgIHByb21pc2UudmFsdWUgPSBQcm9taXNlLmFsbChbXG4gICAgICAgICAgb25Mb2FkTW9yZShzdGF0ZSksXG4gICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgaW50ZXJ2YWwpKVxuICAgICAgICBdKS5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgICBwcm9taXNlLnZhbHVlID0gbnVsbDtcbiAgICAgICAgICBuZXh0VGljaygoKSA9PiBjaGVja0FuZExvYWQoKSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBjb25zdCBzdG9wID0gd2F0Y2goXG4gICAgKCkgPT4gW3N0YXRlLmFycml2ZWRTdGF0ZVtkaXJlY3Rpb25dLCBpc0VsZW1lbnRWaXNpYmxlLnZhbHVlXSxcbiAgICBjaGVja0FuZExvYWQsXG4gICAgeyBpbW1lZGlhdGU6IHRydWUgfVxuICApO1xuICB0cnlPblVubW91bnRlZChzdG9wKTtcbiAgcmV0dXJuIHtcbiAgICBpc0xvYWRpbmcsXG4gICAgcmVzZXQoKSB7XG4gICAgICBuZXh0VGljaygoKSA9PiBjaGVja0FuZExvYWQoKSk7XG4gICAgfVxuICB9O1xufVxuXG5jb25zdCBkZWZhdWx0RXZlbnRzID0gW1wibW91c2Vkb3duXCIsIFwibW91c2V1cFwiLCBcImtleWRvd25cIiwgXCJrZXl1cFwiXTtcbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VLZXlNb2RpZmllcihtb2RpZmllciwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBldmVudHMgPSBkZWZhdWx0RXZlbnRzLFxuICAgIGRvY3VtZW50ID0gZGVmYXVsdERvY3VtZW50LFxuICAgIGluaXRpYWwgPSBudWxsXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBzdGF0ZSA9IHNoYWxsb3dSZWYoaW5pdGlhbCk7XG4gIGlmIChkb2N1bWVudCkge1xuICAgIGV2ZW50cy5mb3JFYWNoKChsaXN0ZW5lckV2ZW50KSA9PiB7XG4gICAgICB1c2VFdmVudExpc3RlbmVyKGRvY3VtZW50LCBsaXN0ZW5lckV2ZW50LCAoZXZ0KSA9PiB7XG4gICAgICAgIGlmICh0eXBlb2YgZXZ0LmdldE1vZGlmaWVyU3RhdGUgPT09IFwiZnVuY3Rpb25cIilcbiAgICAgICAgICBzdGF0ZS52YWx1ZSA9IGV2dC5nZXRNb2RpZmllclN0YXRlKG1vZGlmaWVyKTtcbiAgICAgIH0sIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gc3RhdGU7XG59XG5cbmZ1bmN0aW9uIHVzZUxvY2FsU3RvcmFnZShrZXksIGluaXRpYWxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgd2luZG93ID0gZGVmYXVsdFdpbmRvdyB9ID0gb3B0aW9ucztcbiAgcmV0dXJuIHVzZVN0b3JhZ2Uoa2V5LCBpbml0aWFsVmFsdWUsIHdpbmRvdyA9PSBudWxsID8gdm9pZCAwIDogd2luZG93LmxvY2FsU3RvcmFnZSwgb3B0aW9ucyk7XG59XG5cbmNvbnN0IERlZmF1bHRNYWdpY0tleXNBbGlhc01hcCA9IHtcbiAgY3RybDogXCJjb250cm9sXCIsXG4gIGNvbW1hbmQ6IFwibWV0YVwiLFxuICBjbWQ6IFwibWV0YVwiLFxuICBvcHRpb246IFwiYWx0XCIsXG4gIHVwOiBcImFycm93dXBcIixcbiAgZG93bjogXCJhcnJvd2Rvd25cIixcbiAgbGVmdDogXCJhcnJvd2xlZnRcIixcbiAgcmlnaHQ6IFwiYXJyb3dyaWdodFwiXG59O1xuXG5mdW5jdGlvbiB1c2VNYWdpY0tleXMob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICByZWFjdGl2ZTogdXNlUmVhY3RpdmUgPSBmYWxzZSxcbiAgICB0YXJnZXQgPSBkZWZhdWx0V2luZG93LFxuICAgIGFsaWFzTWFwID0gRGVmYXVsdE1hZ2ljS2V5c0FsaWFzTWFwLFxuICAgIHBhc3NpdmUgPSB0cnVlLFxuICAgIG9uRXZlbnRGaXJlZCA9IG5vb3BcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGN1cnJlbnQgPSByZWFjdGl2ZSgvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKTtcbiAgY29uc3Qgb2JqID0ge1xuICAgIHRvSlNPTigpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9LFxuICAgIGN1cnJlbnRcbiAgfTtcbiAgY29uc3QgcmVmcyA9IHVzZVJlYWN0aXZlID8gcmVhY3RpdmUob2JqKSA6IG9iajtcbiAgY29uc3QgbWV0YURlcHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpO1xuICBjb25zdCBzaGlmdERlcHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpO1xuICBjb25zdCB1c2VkS2V5cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7XG4gIGZ1bmN0aW9uIHNldFJlZnMoa2V5LCB2YWx1ZSkge1xuICAgIGlmIChrZXkgaW4gcmVmcykge1xuICAgICAgaWYgKHVzZVJlYWN0aXZlKVxuICAgICAgICByZWZzW2tleV0gPSB2YWx1ZTtcbiAgICAgIGVsc2VcbiAgICAgICAgcmVmc1trZXldLnZhbHVlID0gdmFsdWU7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIHJlc2V0KCkge1xuICAgIGN1cnJlbnQuY2xlYXIoKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiB1c2VkS2V5cylcbiAgICAgIHNldFJlZnMoa2V5LCBmYWxzZSk7XG4gIH1cbiAgZnVuY3Rpb24gdXBkYXRlUmVmcyhlLCB2YWx1ZSkge1xuICAgIHZhciBfYSwgX2I7XG4gICAgY29uc3Qga2V5ID0gKF9hID0gZS5rZXkpID09IG51bGwgPyB2b2lkIDAgOiBfYS50b0xvd2VyQ2FzZSgpO1xuICAgIGNvbnN0IGNvZGUgPSAoX2IgPSBlLmNvZGUpID09IG51bGwgPyB2b2lkIDAgOiBfYi50b0xvd2VyQ2FzZSgpO1xuICAgIGNvbnN0IHZhbHVlcyA9IFtjb2RlLCBrZXldLmZpbHRlcihCb29sZWFuKTtcbiAgICBpZiAoa2V5KSB7XG4gICAgICBpZiAodmFsdWUpXG4gICAgICAgIGN1cnJlbnQuYWRkKGtleSk7XG4gICAgICBlbHNlXG4gICAgICAgIGN1cnJlbnQuZGVsZXRlKGtleSk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5MiBvZiB2YWx1ZXMpIHtcbiAgICAgIHVzZWRLZXlzLmFkZChrZXkyKTtcbiAgICAgIHNldFJlZnMoa2V5MiwgdmFsdWUpO1xuICAgIH1cbiAgICBpZiAoa2V5ID09PSBcInNoaWZ0XCIgJiYgIXZhbHVlKSB7XG4gICAgICBjb25zdCBzaGlmdERlcHNBcnJheSA9IEFycmF5LmZyb20oc2hpZnREZXBzKTtcbiAgICAgIGNvbnN0IHNoaWZ0SW5kZXggPSBzaGlmdERlcHNBcnJheS5pbmRleE9mKFwic2hpZnRcIik7XG4gICAgICBzaGlmdERlcHNBcnJheS5mb3JFYWNoKChrZXkyLCBpbmRleCkgPT4ge1xuICAgICAgICBpZiAoaW5kZXggPj0gc2hpZnRJbmRleCkge1xuICAgICAgICAgIGN1cnJlbnQuZGVsZXRlKGtleTIpO1xuICAgICAgICAgIHNldFJlZnMoa2V5MiwgZmFsc2UpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHNoaWZ0RGVwcy5jbGVhcigpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGUuZ2V0TW9kaWZpZXJTdGF0ZSA9PT0gXCJmdW5jdGlvblwiICYmIGUuZ2V0TW9kaWZpZXJTdGF0ZShcIlNoaWZ0XCIpICYmIHZhbHVlKSB7XG4gICAgICBbLi4uY3VycmVudCwgLi4udmFsdWVzXS5mb3JFYWNoKChrZXkyKSA9PiBzaGlmdERlcHMuYWRkKGtleTIpKTtcbiAgICB9XG4gICAgaWYgKGtleSA9PT0gXCJtZXRhXCIgJiYgIXZhbHVlKSB7XG4gICAgICBtZXRhRGVwcy5mb3JFYWNoKChrZXkyKSA9PiB7XG4gICAgICAgIGN1cnJlbnQuZGVsZXRlKGtleTIpO1xuICAgICAgICBzZXRSZWZzKGtleTIsIGZhbHNlKTtcbiAgICAgIH0pO1xuICAgICAgbWV0YURlcHMuY2xlYXIoKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlLmdldE1vZGlmaWVyU3RhdGUgPT09IFwiZnVuY3Rpb25cIiAmJiBlLmdldE1vZGlmaWVyU3RhdGUoXCJNZXRhXCIpICYmIHZhbHVlKSB7XG4gICAgICBbLi4uY3VycmVudCwgLi4udmFsdWVzXS5mb3JFYWNoKChrZXkyKSA9PiBtZXRhRGVwcy5hZGQoa2V5MikpO1xuICAgIH1cbiAgfVxuICB1c2VFdmVudExpc3RlbmVyKHRhcmdldCwgXCJrZXlkb3duXCIsIChlKSA9PiB7XG4gICAgdXBkYXRlUmVmcyhlLCB0cnVlKTtcbiAgICByZXR1cm4gb25FdmVudEZpcmVkKGUpO1xuICB9LCB7IHBhc3NpdmUgfSk7XG4gIHVzZUV2ZW50TGlzdGVuZXIodGFyZ2V0LCBcImtleXVwXCIsIChlKSA9PiB7XG4gICAgdXBkYXRlUmVmcyhlLCBmYWxzZSk7XG4gICAgcmV0dXJuIG9uRXZlbnRGaXJlZChlKTtcbiAgfSwgeyBwYXNzaXZlIH0pO1xuICB1c2VFdmVudExpc3RlbmVyKFwiYmx1clwiLCByZXNldCwgeyBwYXNzaXZlIH0pO1xuICB1c2VFdmVudExpc3RlbmVyKFwiZm9jdXNcIiwgcmVzZXQsIHsgcGFzc2l2ZSB9KTtcbiAgY29uc3QgcHJveHkgPSBuZXcgUHJveHkoXG4gICAgcmVmcyxcbiAgICB7XG4gICAgICBnZXQodGFyZ2V0MiwgcHJvcCwgcmVjKSB7XG4gICAgICAgIGlmICh0eXBlb2YgcHJvcCAhPT0gXCJzdHJpbmdcIilcbiAgICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0MiwgcHJvcCwgcmVjKTtcbiAgICAgICAgcHJvcCA9IHByb3AudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKHByb3AgaW4gYWxpYXNNYXApXG4gICAgICAgICAgcHJvcCA9IGFsaWFzTWFwW3Byb3BdO1xuICAgICAgICBpZiAoIShwcm9wIGluIHJlZnMpKSB7XG4gICAgICAgICAgaWYgKC9bK18tXS8udGVzdChwcm9wKSkge1xuICAgICAgICAgICAgY29uc3Qga2V5cyA9IHByb3Auc3BsaXQoL1srXy1dL2cpLm1hcCgoaSkgPT4gaS50cmltKCkpO1xuICAgICAgICAgICAgcmVmc1twcm9wXSA9IGNvbXB1dGVkKCgpID0+IGtleXMubWFwKChrZXkpID0+IHRvVmFsdWUocHJveHlba2V5XSkpLmV2ZXJ5KEJvb2xlYW4pKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVmc1twcm9wXSA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCByID0gUmVmbGVjdC5nZXQodGFyZ2V0MiwgcHJvcCwgcmVjKTtcbiAgICAgICAgcmV0dXJuIHVzZVJlYWN0aXZlID8gdG9WYWx1ZShyKSA6IHI7XG4gICAgICB9XG4gICAgfVxuICApO1xuICByZXR1cm4gcHJveHk7XG59XG5cbmZ1bmN0aW9uIHVzaW5nRWxSZWYoc291cmNlLCBjYikge1xuICBpZiAodG9WYWx1ZShzb3VyY2UpKVxuICAgIGNiKHRvVmFsdWUoc291cmNlKSk7XG59XG5mdW5jdGlvbiB0aW1lUmFuZ2VUb0FycmF5KHRpbWVSYW5nZXMpIHtcbiAgbGV0IHJhbmdlcyA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVSYW5nZXMubGVuZ3RoOyArK2kpXG4gICAgcmFuZ2VzID0gWy4uLnJhbmdlcywgW3RpbWVSYW5nZXMuc3RhcnQoaSksIHRpbWVSYW5nZXMuZW5kKGkpXV07XG4gIHJldHVybiByYW5nZXM7XG59XG5mdW5jdGlvbiB0cmFja3NUb0FycmF5KHRyYWNrcykge1xuICByZXR1cm4gQXJyYXkuZnJvbSh0cmFja3MpLm1hcCgoeyBsYWJlbCwga2luZCwgbGFuZ3VhZ2UsIG1vZGUsIGFjdGl2ZUN1ZXMsIGN1ZXMsIGluQmFuZE1ldGFkYXRhVHJhY2tEaXNwYXRjaFR5cGUgfSwgaWQpID0+ICh7IGlkLCBsYWJlbCwga2luZCwgbGFuZ3VhZ2UsIG1vZGUsIGFjdGl2ZUN1ZXMsIGN1ZXMsIGluQmFuZE1ldGFkYXRhVHJhY2tEaXNwYXRjaFR5cGUgfSkpO1xufVxuY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gIHNyYzogXCJcIixcbiAgdHJhY2tzOiBbXVxufTtcbmZ1bmN0aW9uIHVzZU1lZGlhQ29udHJvbHModGFyZ2V0LCBvcHRpb25zID0ge30pIHtcbiAgdGFyZ2V0ID0gdG9SZWYodGFyZ2V0KTtcbiAgb3B0aW9ucyA9IHtcbiAgICAuLi5kZWZhdWx0T3B0aW9ucyxcbiAgICAuLi5vcHRpb25zXG4gIH07XG4gIGNvbnN0IHtcbiAgICBkb2N1bWVudCA9IGRlZmF1bHREb2N1bWVudFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgbGlzdGVuZXJPcHRpb25zID0geyBwYXNzaXZlOiB0cnVlIH07XG4gIGNvbnN0IGN1cnJlbnRUaW1lID0gc2hhbGxvd1JlZigwKTtcbiAgY29uc3QgZHVyYXRpb24gPSBzaGFsbG93UmVmKDApO1xuICBjb25zdCBzZWVraW5nID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IHZvbHVtZSA9IHNoYWxsb3dSZWYoMSk7XG4gIGNvbnN0IHdhaXRpbmcgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgZW5kZWQgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgcGxheWluZyA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCByYXRlID0gc2hhbGxvd1JlZigxKTtcbiAgY29uc3Qgc3RhbGxlZCA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBidWZmZXJlZCA9IHJlZihbXSk7XG4gIGNvbnN0IHRyYWNrcyA9IHJlZihbXSk7XG4gIGNvbnN0IHNlbGVjdGVkVHJhY2sgPSBzaGFsbG93UmVmKC0xKTtcbiAgY29uc3QgaXNQaWN0dXJlSW5QaWN0dXJlID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IG11dGVkID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IHN1cHBvcnRzUGljdHVyZUluUGljdHVyZSA9IGRvY3VtZW50ICYmIFwicGljdHVyZUluUGljdHVyZUVuYWJsZWRcIiBpbiBkb2N1bWVudDtcbiAgY29uc3Qgc291cmNlRXJyb3JFdmVudCA9IGNyZWF0ZUV2ZW50SG9vaygpO1xuICBjb25zdCBwbGF5YmFja0Vycm9yRXZlbnQgPSBjcmVhdGVFdmVudEhvb2soKTtcbiAgY29uc3QgZGlzYWJsZVRyYWNrID0gKHRyYWNrKSA9PiB7XG4gICAgdXNpbmdFbFJlZih0YXJnZXQsIChlbCkgPT4ge1xuICAgICAgaWYgKHRyYWNrKSB7XG4gICAgICAgIGNvbnN0IGlkID0gdHlwZW9mIHRyYWNrID09PSBcIm51bWJlclwiID8gdHJhY2sgOiB0cmFjay5pZDtcbiAgICAgICAgZWwudGV4dFRyYWNrc1tpZF0ubW9kZSA9IFwiZGlzYWJsZWRcIjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWwudGV4dFRyYWNrcy5sZW5ndGg7ICsraSlcbiAgICAgICAgICBlbC50ZXh0VHJhY2tzW2ldLm1vZGUgPSBcImRpc2FibGVkXCI7XG4gICAgICB9XG4gICAgICBzZWxlY3RlZFRyYWNrLnZhbHVlID0gLTE7XG4gICAgfSk7XG4gIH07XG4gIGNvbnN0IGVuYWJsZVRyYWNrID0gKHRyYWNrLCBkaXNhYmxlVHJhY2tzID0gdHJ1ZSkgPT4ge1xuICAgIHVzaW5nRWxSZWYodGFyZ2V0LCAoZWwpID0+IHtcbiAgICAgIGNvbnN0IGlkID0gdHlwZW9mIHRyYWNrID09PSBcIm51bWJlclwiID8gdHJhY2sgOiB0cmFjay5pZDtcbiAgICAgIGlmIChkaXNhYmxlVHJhY2tzKVxuICAgICAgICBkaXNhYmxlVHJhY2soKTtcbiAgICAgIGVsLnRleHRUcmFja3NbaWRdLm1vZGUgPSBcInNob3dpbmdcIjtcbiAgICAgIHNlbGVjdGVkVHJhY2sudmFsdWUgPSBpZDtcbiAgICB9KTtcbiAgfTtcbiAgY29uc3QgdG9nZ2xlUGljdHVyZUluUGljdHVyZSA9ICgpID0+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdXNpbmdFbFJlZih0YXJnZXQsIGFzeW5jIChlbCkgPT4ge1xuICAgICAgICBpZiAoc3VwcG9ydHNQaWN0dXJlSW5QaWN0dXJlKSB7XG4gICAgICAgICAgaWYgKCFpc1BpY3R1cmVJblBpY3R1cmUudmFsdWUpIHtcbiAgICAgICAgICAgIGVsLnJlcXVlc3RQaWN0dXJlSW5QaWN0dXJlKCkudGhlbihyZXNvbHZlKS5jYXRjaChyZWplY3QpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkb2N1bWVudC5leGl0UGljdHVyZUluUGljdHVyZSgpLnRoZW4ocmVzb2x2ZSkuY2F0Y2gocmVqZWN0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9O1xuICB3YXRjaEVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKCFkb2N1bWVudClcbiAgICAgIHJldHVybjtcbiAgICBjb25zdCBlbCA9IHRvVmFsdWUodGFyZ2V0KTtcbiAgICBpZiAoIWVsKVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IHNyYyA9IHRvVmFsdWUob3B0aW9ucy5zcmMpO1xuICAgIGxldCBzb3VyY2VzID0gW107XG4gICAgaWYgKCFzcmMpXG4gICAgICByZXR1cm47XG4gICAgaWYgKHR5cGVvZiBzcmMgPT09IFwic3RyaW5nXCIpXG4gICAgICBzb3VyY2VzID0gW3sgc3JjIH1dO1xuICAgIGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoc3JjKSlcbiAgICAgIHNvdXJjZXMgPSBzcmM7XG4gICAgZWxzZSBpZiAoaXNPYmplY3Qoc3JjKSlcbiAgICAgIHNvdXJjZXMgPSBbc3JjXTtcbiAgICBlbC5xdWVyeVNlbGVjdG9yQWxsKFwic291cmNlXCIpLmZvckVhY2goKGUpID0+IHtcbiAgICAgIGUucmVtb3ZlKCk7XG4gICAgfSk7XG4gICAgc291cmNlcy5mb3JFYWNoKCh7IHNyYzogc3JjMiwgdHlwZSwgbWVkaWEgfSkgPT4ge1xuICAgICAgY29uc3Qgc291cmNlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNvdXJjZVwiKTtcbiAgICAgIHNvdXJjZS5zZXRBdHRyaWJ1dGUoXCJzcmNcIiwgc3JjMik7XG4gICAgICBzb3VyY2Uuc2V0QXR0cmlidXRlKFwidHlwZVwiLCB0eXBlIHx8IFwiXCIpO1xuICAgICAgc291cmNlLnNldEF0dHJpYnV0ZShcIm1lZGlhXCIsIG1lZGlhIHx8IFwiXCIpO1xuICAgICAgdXNlRXZlbnRMaXN0ZW5lcihzb3VyY2UsIFwiZXJyb3JcIiwgc291cmNlRXJyb3JFdmVudC50cmlnZ2VyLCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgICAgZWwuYXBwZW5kQ2hpbGQoc291cmNlKTtcbiAgICB9KTtcbiAgICBlbC5sb2FkKCk7XG4gIH0pO1xuICB3YXRjaChbdGFyZ2V0LCB2b2x1bWVdLCAoKSA9PiB7XG4gICAgY29uc3QgZWwgPSB0b1ZhbHVlKHRhcmdldCk7XG4gICAgaWYgKCFlbClcbiAgICAgIHJldHVybjtcbiAgICBlbC52b2x1bWUgPSB2b2x1bWUudmFsdWU7XG4gIH0pO1xuICB3YXRjaChbdGFyZ2V0LCBtdXRlZF0sICgpID0+IHtcbiAgICBjb25zdCBlbCA9IHRvVmFsdWUodGFyZ2V0KTtcbiAgICBpZiAoIWVsKVxuICAgICAgcmV0dXJuO1xuICAgIGVsLm11dGVkID0gbXV0ZWQudmFsdWU7XG4gIH0pO1xuICB3YXRjaChbdGFyZ2V0LCByYXRlXSwgKCkgPT4ge1xuICAgIGNvbnN0IGVsID0gdG9WYWx1ZSh0YXJnZXQpO1xuICAgIGlmICghZWwpXG4gICAgICByZXR1cm47XG4gICAgZWwucGxheWJhY2tSYXRlID0gcmF0ZS52YWx1ZTtcbiAgfSk7XG4gIHdhdGNoRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoIWRvY3VtZW50KVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IHRleHRUcmFja3MgPSB0b1ZhbHVlKG9wdGlvbnMudHJhY2tzKTtcbiAgICBjb25zdCBlbCA9IHRvVmFsdWUodGFyZ2V0KTtcbiAgICBpZiAoIXRleHRUcmFja3MgfHwgIXRleHRUcmFja3MubGVuZ3RoIHx8ICFlbClcbiAgICAgIHJldHVybjtcbiAgICBlbC5xdWVyeVNlbGVjdG9yQWxsKFwidHJhY2tcIikuZm9yRWFjaCgoZSkgPT4gZS5yZW1vdmUoKSk7XG4gICAgdGV4dFRyYWNrcy5mb3JFYWNoKCh7IGRlZmF1bHQ6IGlzRGVmYXVsdCwga2luZCwgbGFiZWwsIHNyYywgc3JjTGFuZyB9LCBpKSA9PiB7XG4gICAgICBjb25zdCB0cmFjayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJ0cmFja1wiKTtcbiAgICAgIHRyYWNrLmRlZmF1bHQgPSBpc0RlZmF1bHQgfHwgZmFsc2U7XG4gICAgICB0cmFjay5raW5kID0ga2luZDtcbiAgICAgIHRyYWNrLmxhYmVsID0gbGFiZWw7XG4gICAgICB0cmFjay5zcmMgPSBzcmM7XG4gICAgICB0cmFjay5zcmNsYW5nID0gc3JjTGFuZztcbiAgICAgIGlmICh0cmFjay5kZWZhdWx0KVxuICAgICAgICBzZWxlY3RlZFRyYWNrLnZhbHVlID0gaTtcbiAgICAgIGVsLmFwcGVuZENoaWxkKHRyYWNrKTtcbiAgICB9KTtcbiAgfSk7XG4gIGNvbnN0IHsgaWdub3JlVXBkYXRlczogaWdub3JlQ3VycmVudFRpbWVVcGRhdGVzIH0gPSB3YXRjaElnbm9yYWJsZShjdXJyZW50VGltZSwgKHRpbWUpID0+IHtcbiAgICBjb25zdCBlbCA9IHRvVmFsdWUodGFyZ2V0KTtcbiAgICBpZiAoIWVsKVxuICAgICAgcmV0dXJuO1xuICAgIGVsLmN1cnJlbnRUaW1lID0gdGltZTtcbiAgfSk7XG4gIGNvbnN0IHsgaWdub3JlVXBkYXRlczogaWdub3JlUGxheWluZ1VwZGF0ZXMgfSA9IHdhdGNoSWdub3JhYmxlKHBsYXlpbmcsIChpc1BsYXlpbmcpID0+IHtcbiAgICBjb25zdCBlbCA9IHRvVmFsdWUodGFyZ2V0KTtcbiAgICBpZiAoIWVsKVxuICAgICAgcmV0dXJuO1xuICAgIGlmIChpc1BsYXlpbmcpIHtcbiAgICAgIGVsLnBsYXkoKS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICBwbGF5YmFja0Vycm9yRXZlbnQudHJpZ2dlcihlKTtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBlbC5wYXVzZSgpO1xuICAgIH1cbiAgfSk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgdGFyZ2V0LFxuICAgIFwidGltZXVwZGF0ZVwiLFxuICAgICgpID0+IGlnbm9yZUN1cnJlbnRUaW1lVXBkYXRlcygoKSA9PiBjdXJyZW50VGltZS52YWx1ZSA9IHRvVmFsdWUodGFyZ2V0KS5jdXJyZW50VGltZSksXG4gICAgbGlzdGVuZXJPcHRpb25zXG4gICk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgdGFyZ2V0LFxuICAgIFwiZHVyYXRpb25jaGFuZ2VcIixcbiAgICAoKSA9PiBkdXJhdGlvbi52YWx1ZSA9IHRvVmFsdWUodGFyZ2V0KS5kdXJhdGlvbixcbiAgICBsaXN0ZW5lck9wdGlvbnNcbiAgKTtcbiAgdXNlRXZlbnRMaXN0ZW5lcihcbiAgICB0YXJnZXQsXG4gICAgXCJwcm9ncmVzc1wiLFxuICAgICgpID0+IGJ1ZmZlcmVkLnZhbHVlID0gdGltZVJhbmdlVG9BcnJheSh0b1ZhbHVlKHRhcmdldCkuYnVmZmVyZWQpLFxuICAgIGxpc3RlbmVyT3B0aW9uc1xuICApO1xuICB1c2VFdmVudExpc3RlbmVyKFxuICAgIHRhcmdldCxcbiAgICBcInNlZWtpbmdcIixcbiAgICAoKSA9PiBzZWVraW5nLnZhbHVlID0gdHJ1ZSxcbiAgICBsaXN0ZW5lck9wdGlvbnNcbiAgKTtcbiAgdXNlRXZlbnRMaXN0ZW5lcihcbiAgICB0YXJnZXQsXG4gICAgXCJzZWVrZWRcIixcbiAgICAoKSA9PiBzZWVraW5nLnZhbHVlID0gZmFsc2UsXG4gICAgbGlzdGVuZXJPcHRpb25zXG4gICk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgdGFyZ2V0LFxuICAgIFtcIndhaXRpbmdcIiwgXCJsb2Fkc3RhcnRcIl0sXG4gICAgKCkgPT4ge1xuICAgICAgd2FpdGluZy52YWx1ZSA9IHRydWU7XG4gICAgICBpZ25vcmVQbGF5aW5nVXBkYXRlcygoKSA9PiBwbGF5aW5nLnZhbHVlID0gZmFsc2UpO1xuICAgIH0sXG4gICAgbGlzdGVuZXJPcHRpb25zXG4gICk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgdGFyZ2V0LFxuICAgIFwibG9hZGVkZGF0YVwiLFxuICAgICgpID0+IHdhaXRpbmcudmFsdWUgPSBmYWxzZSxcbiAgICBsaXN0ZW5lck9wdGlvbnNcbiAgKTtcbiAgdXNlRXZlbnRMaXN0ZW5lcihcbiAgICB0YXJnZXQsXG4gICAgXCJwbGF5aW5nXCIsXG4gICAgKCkgPT4ge1xuICAgICAgd2FpdGluZy52YWx1ZSA9IGZhbHNlO1xuICAgICAgZW5kZWQudmFsdWUgPSBmYWxzZTtcbiAgICAgIGlnbm9yZVBsYXlpbmdVcGRhdGVzKCgpID0+IHBsYXlpbmcudmFsdWUgPSB0cnVlKTtcbiAgICB9LFxuICAgIGxpc3RlbmVyT3B0aW9uc1xuICApO1xuICB1c2VFdmVudExpc3RlbmVyKFxuICAgIHRhcmdldCxcbiAgICBcInJhdGVjaGFuZ2VcIixcbiAgICAoKSA9PiByYXRlLnZhbHVlID0gdG9WYWx1ZSh0YXJnZXQpLnBsYXliYWNrUmF0ZSxcbiAgICBsaXN0ZW5lck9wdGlvbnNcbiAgKTtcbiAgdXNlRXZlbnRMaXN0ZW5lcihcbiAgICB0YXJnZXQsXG4gICAgXCJzdGFsbGVkXCIsXG4gICAgKCkgPT4gc3RhbGxlZC52YWx1ZSA9IHRydWUsXG4gICAgbGlzdGVuZXJPcHRpb25zXG4gICk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgdGFyZ2V0LFxuICAgIFwiZW5kZWRcIixcbiAgICAoKSA9PiBlbmRlZC52YWx1ZSA9IHRydWUsXG4gICAgbGlzdGVuZXJPcHRpb25zXG4gICk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgdGFyZ2V0LFxuICAgIFwicGF1c2VcIixcbiAgICAoKSA9PiBpZ25vcmVQbGF5aW5nVXBkYXRlcygoKSA9PiBwbGF5aW5nLnZhbHVlID0gZmFsc2UpLFxuICAgIGxpc3RlbmVyT3B0aW9uc1xuICApO1xuICB1c2VFdmVudExpc3RlbmVyKFxuICAgIHRhcmdldCxcbiAgICBcInBsYXlcIixcbiAgICAoKSA9PiBpZ25vcmVQbGF5aW5nVXBkYXRlcygoKSA9PiBwbGF5aW5nLnZhbHVlID0gdHJ1ZSksXG4gICAgbGlzdGVuZXJPcHRpb25zXG4gICk7XG4gIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgdGFyZ2V0LFxuICAgIFwiZW50ZXJwaWN0dXJlaW5waWN0dXJlXCIsXG4gICAgKCkgPT4gaXNQaWN0dXJlSW5QaWN0dXJlLnZhbHVlID0gdHJ1ZSxcbiAgICBsaXN0ZW5lck9wdGlvbnNcbiAgKTtcbiAgdXNlRXZlbnRMaXN0ZW5lcihcbiAgICB0YXJnZXQsXG4gICAgXCJsZWF2ZXBpY3R1cmVpbnBpY3R1cmVcIixcbiAgICAoKSA9PiBpc1BpY3R1cmVJblBpY3R1cmUudmFsdWUgPSBmYWxzZSxcbiAgICBsaXN0ZW5lck9wdGlvbnNcbiAgKTtcbiAgdXNlRXZlbnRMaXN0ZW5lcihcbiAgICB0YXJnZXQsXG4gICAgXCJ2b2x1bWVjaGFuZ2VcIixcbiAgICAoKSA9PiB7XG4gICAgICBjb25zdCBlbCA9IHRvVmFsdWUodGFyZ2V0KTtcbiAgICAgIGlmICghZWwpXG4gICAgICAgIHJldHVybjtcbiAgICAgIHZvbHVtZS52YWx1ZSA9IGVsLnZvbHVtZTtcbiAgICAgIG11dGVkLnZhbHVlID0gZWwubXV0ZWQ7XG4gICAgfSxcbiAgICBsaXN0ZW5lck9wdGlvbnNcbiAgKTtcbiAgY29uc3QgbGlzdGVuZXJzID0gW107XG4gIGNvbnN0IHN0b3AgPSB3YXRjaChbdGFyZ2V0XSwgKCkgPT4ge1xuICAgIGNvbnN0IGVsID0gdG9WYWx1ZSh0YXJnZXQpO1xuICAgIGlmICghZWwpXG4gICAgICByZXR1cm47XG4gICAgc3RvcCgpO1xuICAgIGxpc3RlbmVyc1swXSA9IHVzZUV2ZW50TGlzdGVuZXIoZWwudGV4dFRyYWNrcywgXCJhZGR0cmFja1wiLCAoKSA9PiB0cmFja3MudmFsdWUgPSB0cmFja3NUb0FycmF5KGVsLnRleHRUcmFja3MpLCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgIGxpc3RlbmVyc1sxXSA9IHVzZUV2ZW50TGlzdGVuZXIoZWwudGV4dFRyYWNrcywgXCJyZW1vdmV0cmFja1wiLCAoKSA9PiB0cmFja3MudmFsdWUgPSB0cmFja3NUb0FycmF5KGVsLnRleHRUcmFja3MpLCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgIGxpc3RlbmVyc1syXSA9IHVzZUV2ZW50TGlzdGVuZXIoZWwudGV4dFRyYWNrcywgXCJjaGFuZ2VcIiwgKCkgPT4gdHJhY2tzLnZhbHVlID0gdHJhY2tzVG9BcnJheShlbC50ZXh0VHJhY2tzKSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgfSk7XG4gIHRyeU9uU2NvcGVEaXNwb3NlKCgpID0+IGxpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcikgPT4gbGlzdGVuZXIoKSkpO1xuICByZXR1cm4ge1xuICAgIGN1cnJlbnRUaW1lLFxuICAgIGR1cmF0aW9uLFxuICAgIHdhaXRpbmcsXG4gICAgc2Vla2luZyxcbiAgICBlbmRlZCxcbiAgICBzdGFsbGVkLFxuICAgIGJ1ZmZlcmVkLFxuICAgIHBsYXlpbmcsXG4gICAgcmF0ZSxcbiAgICAvLyBWb2x1bWVcbiAgICB2b2x1bWUsXG4gICAgbXV0ZWQsXG4gICAgLy8gVHJhY2tzXG4gICAgdHJhY2tzLFxuICAgIHNlbGVjdGVkVHJhY2ssXG4gICAgZW5hYmxlVHJhY2ssXG4gICAgZGlzYWJsZVRyYWNrLFxuICAgIC8vIFBpY3R1cmUgaW4gUGljdHVyZVxuICAgIHN1cHBvcnRzUGljdHVyZUluUGljdHVyZSxcbiAgICB0b2dnbGVQaWN0dXJlSW5QaWN0dXJlLFxuICAgIGlzUGljdHVyZUluUGljdHVyZSxcbiAgICAvLyBFdmVudHNcbiAgICBvblNvdXJjZUVycm9yOiBzb3VyY2VFcnJvckV2ZW50Lm9uLFxuICAgIG9uUGxheWJhY2tFcnJvcjogcGxheWJhY2tFcnJvckV2ZW50Lm9uXG4gIH07XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VNZW1vaXplKHJlc29sdmVyLCBvcHRpb25zKSB7XG4gIGNvbnN0IGluaXRDYWNoZSA9ICgpID0+IHtcbiAgICBpZiAob3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5jYWNoZSlcbiAgICAgIHJldHVybiBzaGFsbG93UmVhY3RpdmUob3B0aW9ucy5jYWNoZSk7XG4gICAgcmV0dXJuIHNoYWxsb3dSZWFjdGl2ZSgvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpKTtcbiAgfTtcbiAgY29uc3QgY2FjaGUgPSBpbml0Q2FjaGUoKTtcbiAgY29uc3QgZ2VuZXJhdGVLZXkgPSAoLi4uYXJncykgPT4gKG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuZ2V0S2V5KSA/IG9wdGlvbnMuZ2V0S2V5KC4uLmFyZ3MpIDogSlNPTi5zdHJpbmdpZnkoYXJncyk7XG4gIGNvbnN0IF9sb2FkRGF0YSA9IChrZXksIC4uLmFyZ3MpID0+IHtcbiAgICBjYWNoZS5zZXQoa2V5LCByZXNvbHZlciguLi5hcmdzKSk7XG4gICAgcmV0dXJuIGNhY2hlLmdldChrZXkpO1xuICB9O1xuICBjb25zdCBsb2FkRGF0YSA9ICguLi5hcmdzKSA9PiBfbG9hZERhdGEoZ2VuZXJhdGVLZXkoLi4uYXJncyksIC4uLmFyZ3MpO1xuICBjb25zdCBkZWxldGVEYXRhID0gKC4uLmFyZ3MpID0+IHtcbiAgICBjYWNoZS5kZWxldGUoZ2VuZXJhdGVLZXkoLi4uYXJncykpO1xuICB9O1xuICBjb25zdCBjbGVhckRhdGEgPSAoKSA9PiB7XG4gICAgY2FjaGUuY2xlYXIoKTtcbiAgfTtcbiAgY29uc3QgbWVtb2l6ZWQgPSAoLi4uYXJncykgPT4ge1xuICAgIGNvbnN0IGtleSA9IGdlbmVyYXRlS2V5KC4uLmFyZ3MpO1xuICAgIGlmIChjYWNoZS5oYXMoa2V5KSlcbiAgICAgIHJldHVybiBjYWNoZS5nZXQoa2V5KTtcbiAgICByZXR1cm4gX2xvYWREYXRhKGtleSwgLi4uYXJncyk7XG4gIH07XG4gIG1lbW9pemVkLmxvYWQgPSBsb2FkRGF0YTtcbiAgbWVtb2l6ZWQuZGVsZXRlID0gZGVsZXRlRGF0YTtcbiAgbWVtb2l6ZWQuY2xlYXIgPSBjbGVhckRhdGE7XG4gIG1lbW9pemVkLmdlbmVyYXRlS2V5ID0gZ2VuZXJhdGVLZXk7XG4gIG1lbW9pemVkLmNhY2hlID0gY2FjaGU7XG4gIHJldHVybiBtZW1vaXplZDtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZU1lbW9yeShvcHRpb25zID0ge30pIHtcbiAgY29uc3QgbWVtb3J5ID0gcmVmKCk7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHR5cGVvZiBwZXJmb3JtYW5jZSAhPT0gXCJ1bmRlZmluZWRcIiAmJiBcIm1lbW9yeVwiIGluIHBlcmZvcm1hbmNlKTtcbiAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlKSB7XG4gICAgY29uc3QgeyBpbnRlcnZhbCA9IDFlMyB9ID0gb3B0aW9ucztcbiAgICB1c2VJbnRlcnZhbEZuKCgpID0+IHtcbiAgICAgIG1lbW9yeS52YWx1ZSA9IHBlcmZvcm1hbmNlLm1lbW9yeTtcbiAgICB9LCBpbnRlcnZhbCwgeyBpbW1lZGlhdGU6IG9wdGlvbnMuaW1tZWRpYXRlLCBpbW1lZGlhdGVDYWxsYmFjazogb3B0aW9ucy5pbW1lZGlhdGVDYWxsYmFjayB9KTtcbiAgfVxuICByZXR1cm4geyBpc1N1cHBvcnRlZCwgbWVtb3J5IH07XG59XG5cbmNvbnN0IFVzZU1vdXNlQnVpbHRpbkV4dHJhY3RvcnMgPSB7XG4gIHBhZ2U6IChldmVudCkgPT4gW2V2ZW50LnBhZ2VYLCBldmVudC5wYWdlWV0sXG4gIGNsaWVudDogKGV2ZW50KSA9PiBbZXZlbnQuY2xpZW50WCwgZXZlbnQuY2xpZW50WV0sXG4gIHNjcmVlbjogKGV2ZW50KSA9PiBbZXZlbnQuc2NyZWVuWCwgZXZlbnQuc2NyZWVuWV0sXG4gIG1vdmVtZW50OiAoZXZlbnQpID0+IGV2ZW50IGluc3RhbmNlb2YgTW91c2VFdmVudCA/IFtldmVudC5tb3ZlbWVudFgsIGV2ZW50Lm1vdmVtZW50WV0gOiBudWxsXG59O1xuZnVuY3Rpb24gdXNlTW91c2Uob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB0eXBlID0gXCJwYWdlXCIsXG4gICAgdG91Y2ggPSB0cnVlLFxuICAgIHJlc2V0T25Ub3VjaEVuZHMgPSBmYWxzZSxcbiAgICBpbml0aWFsVmFsdWUgPSB7IHg6IDAsIHk6IDAgfSxcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93LFxuICAgIHRhcmdldCA9IHdpbmRvdyxcbiAgICBzY3JvbGwgPSB0cnVlLFxuICAgIGV2ZW50RmlsdGVyXG4gIH0gPSBvcHRpb25zO1xuICBsZXQgX3ByZXZNb3VzZUV2ZW50ID0gbnVsbDtcbiAgbGV0IF9wcmV2U2Nyb2xsWCA9IDA7XG4gIGxldCBfcHJldlNjcm9sbFkgPSAwO1xuICBjb25zdCB4ID0gc2hhbGxvd1JlZihpbml0aWFsVmFsdWUueCk7XG4gIGNvbnN0IHkgPSBzaGFsbG93UmVmKGluaXRpYWxWYWx1ZS55KTtcbiAgY29uc3Qgc291cmNlVHlwZSA9IHNoYWxsb3dSZWYobnVsbCk7XG4gIGNvbnN0IGV4dHJhY3RvciA9IHR5cGVvZiB0eXBlID09PSBcImZ1bmN0aW9uXCIgPyB0eXBlIDogVXNlTW91c2VCdWlsdGluRXh0cmFjdG9yc1t0eXBlXTtcbiAgY29uc3QgbW91c2VIYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgY29uc3QgcmVzdWx0ID0gZXh0cmFjdG9yKGV2ZW50KTtcbiAgICBfcHJldk1vdXNlRXZlbnQgPSBldmVudDtcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICBbeC52YWx1ZSwgeS52YWx1ZV0gPSByZXN1bHQ7XG4gICAgICBzb3VyY2VUeXBlLnZhbHVlID0gXCJtb3VzZVwiO1xuICAgIH1cbiAgICBpZiAod2luZG93KSB7XG4gICAgICBfcHJldlNjcm9sbFggPSB3aW5kb3cuc2Nyb2xsWDtcbiAgICAgIF9wcmV2U2Nyb2xsWSA9IHdpbmRvdy5zY3JvbGxZO1xuICAgIH1cbiAgfTtcbiAgY29uc3QgdG91Y2hIYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgaWYgKGV2ZW50LnRvdWNoZXMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gZXh0cmFjdG9yKGV2ZW50LnRvdWNoZXNbMF0pO1xuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICBbeC52YWx1ZSwgeS52YWx1ZV0gPSByZXN1bHQ7XG4gICAgICAgIHNvdXJjZVR5cGUudmFsdWUgPSBcInRvdWNoXCI7XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBjb25zdCBzY3JvbGxIYW5kbGVyID0gKCkgPT4ge1xuICAgIGlmICghX3ByZXZNb3VzZUV2ZW50IHx8ICF3aW5kb3cpXG4gICAgICByZXR1cm47XG4gICAgY29uc3QgcG9zID0gZXh0cmFjdG9yKF9wcmV2TW91c2VFdmVudCk7XG4gICAgaWYgKF9wcmV2TW91c2VFdmVudCBpbnN0YW5jZW9mIE1vdXNlRXZlbnQgJiYgcG9zKSB7XG4gICAgICB4LnZhbHVlID0gcG9zWzBdICsgd2luZG93LnNjcm9sbFggLSBfcHJldlNjcm9sbFg7XG4gICAgICB5LnZhbHVlID0gcG9zWzFdICsgd2luZG93LnNjcm9sbFkgLSBfcHJldlNjcm9sbFk7XG4gICAgfVxuICB9O1xuICBjb25zdCByZXNldCA9ICgpID0+IHtcbiAgICB4LnZhbHVlID0gaW5pdGlhbFZhbHVlLng7XG4gICAgeS52YWx1ZSA9IGluaXRpYWxWYWx1ZS55O1xuICB9O1xuICBjb25zdCBtb3VzZUhhbmRsZXJXcmFwcGVyID0gZXZlbnRGaWx0ZXIgPyAoZXZlbnQpID0+IGV2ZW50RmlsdGVyKCgpID0+IG1vdXNlSGFuZGxlcihldmVudCksIHt9KSA6IChldmVudCkgPT4gbW91c2VIYW5kbGVyKGV2ZW50KTtcbiAgY29uc3QgdG91Y2hIYW5kbGVyV3JhcHBlciA9IGV2ZW50RmlsdGVyID8gKGV2ZW50KSA9PiBldmVudEZpbHRlcigoKSA9PiB0b3VjaEhhbmRsZXIoZXZlbnQpLCB7fSkgOiAoZXZlbnQpID0+IHRvdWNoSGFuZGxlcihldmVudCk7XG4gIGNvbnN0IHNjcm9sbEhhbmRsZXJXcmFwcGVyID0gZXZlbnRGaWx0ZXIgPyAoKSA9PiBldmVudEZpbHRlcigoKSA9PiBzY3JvbGxIYW5kbGVyKCksIHt9KSA6ICgpID0+IHNjcm9sbEhhbmRsZXIoKTtcbiAgaWYgKHRhcmdldCkge1xuICAgIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHsgcGFzc2l2ZTogdHJ1ZSB9O1xuICAgIHVzZUV2ZW50TGlzdGVuZXIodGFyZ2V0LCBbXCJtb3VzZW1vdmVcIiwgXCJkcmFnb3ZlclwiXSwgbW91c2VIYW5kbGVyV3JhcHBlciwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICBpZiAodG91Y2ggJiYgdHlwZSAhPT0gXCJtb3ZlbWVudFwiKSB7XG4gICAgICB1c2VFdmVudExpc3RlbmVyKHRhcmdldCwgW1widG91Y2hzdGFydFwiLCBcInRvdWNobW92ZVwiXSwgdG91Y2hIYW5kbGVyV3JhcHBlciwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICAgIGlmIChyZXNldE9uVG91Y2hFbmRzKVxuICAgICAgICB1c2VFdmVudExpc3RlbmVyKHRhcmdldCwgXCJ0b3VjaGVuZFwiLCByZXNldCwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICB9XG4gICAgaWYgKHNjcm9sbCAmJiB0eXBlID09PSBcInBhZ2VcIilcbiAgICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcInNjcm9sbFwiLCBzY3JvbGxIYW5kbGVyV3JhcHBlciwgbGlzdGVuZXJPcHRpb25zKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIHgsXG4gICAgeSxcbiAgICBzb3VyY2VUeXBlXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZU1vdXNlSW5FbGVtZW50KHRhcmdldCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB3aW5kb3dSZXNpemUgPSB0cnVlLFxuICAgIHdpbmRvd1Njcm9sbCA9IHRydWUsXG4gICAgaGFuZGxlT3V0c2lkZSA9IHRydWUsXG4gICAgd2luZG93ID0gZGVmYXVsdFdpbmRvd1xuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgdHlwZSA9IG9wdGlvbnMudHlwZSB8fCBcInBhZ2VcIjtcbiAgY29uc3QgeyB4LCB5LCBzb3VyY2VUeXBlIH0gPSB1c2VNb3VzZShvcHRpb25zKTtcbiAgY29uc3QgdGFyZ2V0UmVmID0gc2hhbGxvd1JlZih0YXJnZXQgIT0gbnVsbCA/IHRhcmdldCA6IHdpbmRvdyA9PSBudWxsID8gdm9pZCAwIDogd2luZG93LmRvY3VtZW50LmJvZHkpO1xuICBjb25zdCBlbGVtZW50WCA9IHNoYWxsb3dSZWYoMCk7XG4gIGNvbnN0IGVsZW1lbnRZID0gc2hhbGxvd1JlZigwKTtcbiAgY29uc3QgZWxlbWVudFBvc2l0aW9uWCA9IHNoYWxsb3dSZWYoMCk7XG4gIGNvbnN0IGVsZW1lbnRQb3NpdGlvblkgPSBzaGFsbG93UmVmKDApO1xuICBjb25zdCBlbGVtZW50SGVpZ2h0ID0gc2hhbGxvd1JlZigwKTtcbiAgY29uc3QgZWxlbWVudFdpZHRoID0gc2hhbGxvd1JlZigwKTtcbiAgY29uc3QgaXNPdXRzaWRlID0gc2hhbGxvd1JlZih0cnVlKTtcbiAgZnVuY3Rpb24gdXBkYXRlKCkge1xuICAgIGlmICghd2luZG93KVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IGVsID0gdW5yZWZFbGVtZW50KHRhcmdldFJlZik7XG4gICAgaWYgKCFlbCB8fCAhKGVsIGluc3RhbmNlb2YgRWxlbWVudCkpXG4gICAgICByZXR1cm47XG4gICAgY29uc3Qge1xuICAgICAgbGVmdCxcbiAgICAgIHRvcCxcbiAgICAgIHdpZHRoLFxuICAgICAgaGVpZ2h0XG4gICAgfSA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIGVsZW1lbnRQb3NpdGlvblgudmFsdWUgPSBsZWZ0ICsgKHR5cGUgPT09IFwicGFnZVwiID8gd2luZG93LnBhZ2VYT2Zmc2V0IDogMCk7XG4gICAgZWxlbWVudFBvc2l0aW9uWS52YWx1ZSA9IHRvcCArICh0eXBlID09PSBcInBhZ2VcIiA/IHdpbmRvdy5wYWdlWU9mZnNldCA6IDApO1xuICAgIGVsZW1lbnRIZWlnaHQudmFsdWUgPSBoZWlnaHQ7XG4gICAgZWxlbWVudFdpZHRoLnZhbHVlID0gd2lkdGg7XG4gICAgY29uc3QgZWxYID0geC52YWx1ZSAtIGVsZW1lbnRQb3NpdGlvblgudmFsdWU7XG4gICAgY29uc3QgZWxZID0geS52YWx1ZSAtIGVsZW1lbnRQb3NpdGlvblkudmFsdWU7XG4gICAgaXNPdXRzaWRlLnZhbHVlID0gd2lkdGggPT09IDAgfHwgaGVpZ2h0ID09PSAwIHx8IGVsWCA8IDAgfHwgZWxZIDwgMCB8fCBlbFggPiB3aWR0aCB8fCBlbFkgPiBoZWlnaHQ7XG4gICAgaWYgKGhhbmRsZU91dHNpZGUgfHwgIWlzT3V0c2lkZS52YWx1ZSkge1xuICAgICAgZWxlbWVudFgudmFsdWUgPSBlbFg7XG4gICAgICBlbGVtZW50WS52YWx1ZSA9IGVsWTtcbiAgICB9XG4gIH1cbiAgY29uc3Qgc3RvcEZuTGlzdCA9IFtdO1xuICBmdW5jdGlvbiBzdG9wKCkge1xuICAgIHN0b3BGbkxpc3QuZm9yRWFjaCgoZm4pID0+IGZuKCkpO1xuICAgIHN0b3BGbkxpc3QubGVuZ3RoID0gMDtcbiAgfVxuICB0cnlPbk1vdW50ZWQoKCkgPT4ge1xuICAgIHVwZGF0ZSgpO1xuICB9KTtcbiAgaWYgKHdpbmRvdykge1xuICAgIGNvbnN0IHtcbiAgICAgIHN0b3A6IHN0b3BSZXNpemVPYnNlcnZlclxuICAgIH0gPSB1c2VSZXNpemVPYnNlcnZlcih0YXJnZXRSZWYsIHVwZGF0ZSk7XG4gICAgY29uc3Qge1xuICAgICAgc3RvcDogc3RvcE11dGF0aW9uT2JzZXJ2ZXJcbiAgICB9ID0gdXNlTXV0YXRpb25PYnNlcnZlcih0YXJnZXRSZWYsIHVwZGF0ZSwge1xuICAgICAgYXR0cmlidXRlRmlsdGVyOiBbXCJzdHlsZVwiLCBcImNsYXNzXCJdXG4gICAgfSk7XG4gICAgY29uc3Qgc3RvcFdhdGNoID0gd2F0Y2goXG4gICAgICBbdGFyZ2V0UmVmLCB4LCB5XSxcbiAgICAgIHVwZGF0ZVxuICAgICk7XG4gICAgc3RvcEZuTGlzdC5wdXNoKFxuICAgICAgc3RvcFJlc2l6ZU9ic2VydmVyLFxuICAgICAgc3RvcE11dGF0aW9uT2JzZXJ2ZXIsXG4gICAgICBzdG9wV2F0Y2hcbiAgICApO1xuICAgIHVzZUV2ZW50TGlzdGVuZXIoXG4gICAgICBkb2N1bWVudCxcbiAgICAgIFwibW91c2VsZWF2ZVwiLFxuICAgICAgKCkgPT4gaXNPdXRzaWRlLnZhbHVlID0gdHJ1ZSxcbiAgICAgIHsgcGFzc2l2ZTogdHJ1ZSB9XG4gICAgKTtcbiAgICBpZiAod2luZG93U2Nyb2xsKSB7XG4gICAgICBzdG9wRm5MaXN0LnB1c2goXG4gICAgICAgIHVzZUV2ZW50TGlzdGVuZXIoXCJzY3JvbGxcIiwgdXBkYXRlLCB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfSlcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICh3aW5kb3dSZXNpemUpIHtcbiAgICAgIHN0b3BGbkxpc3QucHVzaChcbiAgICAgICAgdXNlRXZlbnRMaXN0ZW5lcihcInJlc2l6ZVwiLCB1cGRhdGUsIHsgcGFzc2l2ZTogdHJ1ZSB9KVxuICAgICAgKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHtcbiAgICB4LFxuICAgIHksXG4gICAgc291cmNlVHlwZSxcbiAgICBlbGVtZW50WCxcbiAgICBlbGVtZW50WSxcbiAgICBlbGVtZW50UG9zaXRpb25YLFxuICAgIGVsZW1lbnRQb3NpdGlvblksXG4gICAgZWxlbWVudEhlaWdodCxcbiAgICBlbGVtZW50V2lkdGgsXG4gICAgaXNPdXRzaWRlLFxuICAgIHN0b3BcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlTW91c2VQcmVzc2VkKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdG91Y2ggPSB0cnVlLFxuICAgIGRyYWcgPSB0cnVlLFxuICAgIGNhcHR1cmUgPSBmYWxzZSxcbiAgICBpbml0aWFsVmFsdWUgPSBmYWxzZSxcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93XG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBwcmVzc2VkID0gc2hhbGxvd1JlZihpbml0aWFsVmFsdWUpO1xuICBjb25zdCBzb3VyY2VUeXBlID0gc2hhbGxvd1JlZihudWxsKTtcbiAgaWYgKCF3aW5kb3cpIHtcbiAgICByZXR1cm4ge1xuICAgICAgcHJlc3NlZCxcbiAgICAgIHNvdXJjZVR5cGVcbiAgICB9O1xuICB9XG4gIGNvbnN0IG9uUHJlc3NlZCA9IChzcmNUeXBlKSA9PiAoZXZlbnQpID0+IHtcbiAgICB2YXIgX2E7XG4gICAgcHJlc3NlZC52YWx1ZSA9IHRydWU7XG4gICAgc291cmNlVHlwZS52YWx1ZSA9IHNyY1R5cGU7XG4gICAgKF9hID0gb3B0aW9ucy5vblByZXNzZWQpID09IG51bGwgPyB2b2lkIDAgOiBfYS5jYWxsKG9wdGlvbnMsIGV2ZW50KTtcbiAgfTtcbiAgY29uc3Qgb25SZWxlYXNlZCA9IChldmVudCkgPT4ge1xuICAgIHZhciBfYTtcbiAgICBwcmVzc2VkLnZhbHVlID0gZmFsc2U7XG4gICAgc291cmNlVHlwZS52YWx1ZSA9IG51bGw7XG4gICAgKF9hID0gb3B0aW9ucy5vblJlbGVhc2VkKSA9PSBudWxsID8gdm9pZCAwIDogX2EuY2FsbChvcHRpb25zLCBldmVudCk7XG4gIH07XG4gIGNvbnN0IHRhcmdldCA9IGNvbXB1dGVkKCgpID0+IHVucmVmRWxlbWVudChvcHRpb25zLnRhcmdldCkgfHwgd2luZG93KTtcbiAgY29uc3QgbGlzdGVuZXJPcHRpb25zID0geyBwYXNzaXZlOiB0cnVlLCBjYXB0dXJlIH07XG4gIHVzZUV2ZW50TGlzdGVuZXIodGFyZ2V0LCBcIm1vdXNlZG93blwiLCBvblByZXNzZWQoXCJtb3VzZVwiKSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3csIFwibW91c2VsZWF2ZVwiLCBvblJlbGVhc2VkLCBsaXN0ZW5lck9wdGlvbnMpO1xuICB1c2VFdmVudExpc3RlbmVyKHdpbmRvdywgXCJtb3VzZXVwXCIsIG9uUmVsZWFzZWQsIGxpc3RlbmVyT3B0aW9ucyk7XG4gIGlmIChkcmFnKSB7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcih0YXJnZXQsIFwiZHJhZ3N0YXJ0XCIsIG9uUHJlc3NlZChcIm1vdXNlXCIpLCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcImRyb3BcIiwgb25SZWxlYXNlZCwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICB1c2VFdmVudExpc3RlbmVyKHdpbmRvdywgXCJkcmFnZW5kXCIsIG9uUmVsZWFzZWQsIGxpc3RlbmVyT3B0aW9ucyk7XG4gIH1cbiAgaWYgKHRvdWNoKSB7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcih0YXJnZXQsIFwidG91Y2hzdGFydFwiLCBvblByZXNzZWQoXCJ0b3VjaFwiKSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICB1c2VFdmVudExpc3RlbmVyKHdpbmRvdywgXCJ0b3VjaGVuZFwiLCBvblJlbGVhc2VkLCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcInRvdWNoY2FuY2VsXCIsIG9uUmVsZWFzZWQsIGxpc3RlbmVyT3B0aW9ucyk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBwcmVzc2VkLFxuICAgIHNvdXJjZVR5cGVcbiAgfTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZU5hdmlnYXRvckxhbmd1YWdlKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7IHdpbmRvdyA9IGRlZmF1bHRXaW5kb3cgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IG5hdmlnYXRvciA9IHdpbmRvdyA9PSBudWxsID8gdm9pZCAwIDogd2luZG93Lm5hdmlnYXRvcjtcbiAgY29uc3QgaXNTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gbmF2aWdhdG9yICYmIFwibGFuZ3VhZ2VcIiBpbiBuYXZpZ2F0b3IpO1xuICBjb25zdCBsYW5ndWFnZSA9IHNoYWxsb3dSZWYobmF2aWdhdG9yID09IG51bGwgPyB2b2lkIDAgOiBuYXZpZ2F0b3IubGFuZ3VhZ2UpO1xuICB1c2VFdmVudExpc3RlbmVyKHdpbmRvdywgXCJsYW5ndWFnZWNoYW5nZVwiLCAoKSA9PiB7XG4gICAgaWYgKG5hdmlnYXRvcilcbiAgICAgIGxhbmd1YWdlLnZhbHVlID0gbmF2aWdhdG9yLmxhbmd1YWdlO1xuICB9LCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gIHJldHVybiB7XG4gICAgaXNTdXBwb3J0ZWQsXG4gICAgbGFuZ3VhZ2VcbiAgfTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZU5ldHdvcmsob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgd2luZG93ID0gZGVmYXVsdFdpbmRvdyB9ID0gb3B0aW9ucztcbiAgY29uc3QgbmF2aWdhdG9yID0gd2luZG93ID09IG51bGwgPyB2b2lkIDAgOiB3aW5kb3cubmF2aWdhdG9yO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiBuYXZpZ2F0b3IgJiYgXCJjb25uZWN0aW9uXCIgaW4gbmF2aWdhdG9yKTtcbiAgY29uc3QgaXNPbmxpbmUgPSBzaGFsbG93UmVmKHRydWUpO1xuICBjb25zdCBzYXZlRGF0YSA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBvZmZsaW5lQXQgPSBzaGFsbG93UmVmKHZvaWQgMCk7XG4gIGNvbnN0IG9ubGluZUF0ID0gc2hhbGxvd1JlZih2b2lkIDApO1xuICBjb25zdCBkb3dubGluayA9IHNoYWxsb3dSZWYodm9pZCAwKTtcbiAgY29uc3QgZG93bmxpbmtNYXggPSBzaGFsbG93UmVmKHZvaWQgMCk7XG4gIGNvbnN0IHJ0dCA9IHNoYWxsb3dSZWYodm9pZCAwKTtcbiAgY29uc3QgZWZmZWN0aXZlVHlwZSA9IHNoYWxsb3dSZWYodm9pZCAwKTtcbiAgY29uc3QgdHlwZSA9IHNoYWxsb3dSZWYoXCJ1bmtub3duXCIpO1xuICBjb25zdCBjb25uZWN0aW9uID0gaXNTdXBwb3J0ZWQudmFsdWUgJiYgbmF2aWdhdG9yLmNvbm5lY3Rpb247XG4gIGZ1bmN0aW9uIHVwZGF0ZU5ldHdvcmtJbmZvcm1hdGlvbigpIHtcbiAgICBpZiAoIW5hdmlnYXRvcilcbiAgICAgIHJldHVybjtcbiAgICBpc09ubGluZS52YWx1ZSA9IG5hdmlnYXRvci5vbkxpbmU7XG4gICAgb2ZmbGluZUF0LnZhbHVlID0gaXNPbmxpbmUudmFsdWUgPyB2b2lkIDAgOiBEYXRlLm5vdygpO1xuICAgIG9ubGluZUF0LnZhbHVlID0gaXNPbmxpbmUudmFsdWUgPyBEYXRlLm5vdygpIDogdm9pZCAwO1xuICAgIGlmIChjb25uZWN0aW9uKSB7XG4gICAgICBkb3dubGluay52YWx1ZSA9IGNvbm5lY3Rpb24uZG93bmxpbms7XG4gICAgICBkb3dubGlua01heC52YWx1ZSA9IGNvbm5lY3Rpb24uZG93bmxpbmtNYXg7XG4gICAgICBlZmZlY3RpdmVUeXBlLnZhbHVlID0gY29ubmVjdGlvbi5lZmZlY3RpdmVUeXBlO1xuICAgICAgcnR0LnZhbHVlID0gY29ubmVjdGlvbi5ydHQ7XG4gICAgICBzYXZlRGF0YS52YWx1ZSA9IGNvbm5lY3Rpb24uc2F2ZURhdGE7XG4gICAgICB0eXBlLnZhbHVlID0gY29ubmVjdGlvbi50eXBlO1xuICAgIH1cbiAgfVxuICBjb25zdCBsaXN0ZW5lck9wdGlvbnMgPSB7IHBhc3NpdmU6IHRydWUgfTtcbiAgaWYgKHdpbmRvdykge1xuICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcIm9mZmxpbmVcIiwgKCkgPT4ge1xuICAgICAgaXNPbmxpbmUudmFsdWUgPSBmYWxzZTtcbiAgICAgIG9mZmxpbmVBdC52YWx1ZSA9IERhdGUubm93KCk7XG4gICAgfSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICB1c2VFdmVudExpc3RlbmVyKHdpbmRvdywgXCJvbmxpbmVcIiwgKCkgPT4ge1xuICAgICAgaXNPbmxpbmUudmFsdWUgPSB0cnVlO1xuICAgICAgb25saW5lQXQudmFsdWUgPSBEYXRlLm5vdygpO1xuICAgIH0sIGxpc3RlbmVyT3B0aW9ucyk7XG4gIH1cbiAgaWYgKGNvbm5lY3Rpb24pXG4gICAgdXNlRXZlbnRMaXN0ZW5lcihjb25uZWN0aW9uLCBcImNoYW5nZVwiLCB1cGRhdGVOZXR3b3JrSW5mb3JtYXRpb24sIGxpc3RlbmVyT3B0aW9ucyk7XG4gIHVwZGF0ZU5ldHdvcmtJbmZvcm1hdGlvbigpO1xuICByZXR1cm4ge1xuICAgIGlzU3VwcG9ydGVkLFxuICAgIGlzT25saW5lOiByZWFkb25seShpc09ubGluZSksXG4gICAgc2F2ZURhdGE6IHJlYWRvbmx5KHNhdmVEYXRhKSxcbiAgICBvZmZsaW5lQXQ6IHJlYWRvbmx5KG9mZmxpbmVBdCksXG4gICAgb25saW5lQXQ6IHJlYWRvbmx5KG9ubGluZUF0KSxcbiAgICBkb3dubGluazogcmVhZG9ubHkoZG93bmxpbmspLFxuICAgIGRvd25saW5rTWF4OiByZWFkb25seShkb3dubGlua01heCksXG4gICAgZWZmZWN0aXZlVHlwZTogcmVhZG9ubHkoZWZmZWN0aXZlVHlwZSksXG4gICAgcnR0OiByZWFkb25seShydHQpLFxuICAgIHR5cGU6IHJlYWRvbmx5KHR5cGUpXG4gIH07XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VOb3cob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBjb250cm9sczogZXhwb3NlQ29udHJvbHMgPSBmYWxzZSxcbiAgICBpbnRlcnZhbCA9IFwicmVxdWVzdEFuaW1hdGlvbkZyYW1lXCIsXG4gICAgaW1tZWRpYXRlID0gdHJ1ZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3Qgbm93ID0gcmVmKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKTtcbiAgY29uc3QgdXBkYXRlID0gKCkgPT4gbm93LnZhbHVlID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCk7XG4gIGNvbnN0IGNvbnRyb2xzID0gaW50ZXJ2YWwgPT09IFwicmVxdWVzdEFuaW1hdGlvbkZyYW1lXCIgPyB1c2VSYWZGbih1cGRhdGUsIHsgaW1tZWRpYXRlIH0pIDogdXNlSW50ZXJ2YWxGbih1cGRhdGUsIGludGVydmFsLCB7IGltbWVkaWF0ZSB9KTtcbiAgaWYgKGV4cG9zZUNvbnRyb2xzKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5vdyxcbiAgICAgIC4uLmNvbnRyb2xzXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbm93O1xuICB9XG59XG5cbmZ1bmN0aW9uIHVzZU9iamVjdFVybChvYmplY3QpIHtcbiAgY29uc3QgdXJsID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCByZWxlYXNlID0gKCkgPT4ge1xuICAgIGlmICh1cmwudmFsdWUpXG4gICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybC52YWx1ZSk7XG4gICAgdXJsLnZhbHVlID0gdm9pZCAwO1xuICB9O1xuICB3YXRjaChcbiAgICAoKSA9PiB0b1ZhbHVlKG9iamVjdCksXG4gICAgKG5ld09iamVjdCkgPT4ge1xuICAgICAgcmVsZWFzZSgpO1xuICAgICAgaWYgKG5ld09iamVjdClcbiAgICAgICAgdXJsLnZhbHVlID0gVVJMLmNyZWF0ZU9iamVjdFVSTChuZXdPYmplY3QpO1xuICAgIH0sXG4gICAgeyBpbW1lZGlhdGU6IHRydWUgfVxuICApO1xuICB0cnlPblNjb3BlRGlzcG9zZShyZWxlYXNlKTtcbiAgcmV0dXJuIHJlYWRvbmx5KHVybCk7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VDbGFtcCh2YWx1ZSwgbWluLCBtYXgpIHtcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJmdW5jdGlvblwiIHx8IGlzUmVhZG9ubHkodmFsdWUpKVxuICAgIHJldHVybiBjb21wdXRlZCgoKSA9PiBjbGFtcCh0b1ZhbHVlKHZhbHVlKSwgdG9WYWx1ZShtaW4pLCB0b1ZhbHVlKG1heCkpKTtcbiAgY29uc3QgX3ZhbHVlID0gcmVmKHZhbHVlKTtcbiAgcmV0dXJuIGNvbXB1dGVkKHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gX3ZhbHVlLnZhbHVlID0gY2xhbXAoX3ZhbHVlLnZhbHVlLCB0b1ZhbHVlKG1pbiksIHRvVmFsdWUobWF4KSk7XG4gICAgfSxcbiAgICBzZXQodmFsdWUyKSB7XG4gICAgICBfdmFsdWUudmFsdWUgPSBjbGFtcCh2YWx1ZTIsIHRvVmFsdWUobWluKSwgdG9WYWx1ZShtYXgpKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiB1c2VPZmZzZXRQYWdpbmF0aW9uKG9wdGlvbnMpIHtcbiAgY29uc3Qge1xuICAgIHRvdGFsID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLFxuICAgIHBhZ2VTaXplID0gMTAsXG4gICAgcGFnZSA9IDEsXG4gICAgb25QYWdlQ2hhbmdlID0gbm9vcCxcbiAgICBvblBhZ2VTaXplQ2hhbmdlID0gbm9vcCxcbiAgICBvblBhZ2VDb3VudENoYW5nZSA9IG5vb3BcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGN1cnJlbnRQYWdlU2l6ZSA9IHVzZUNsYW1wKHBhZ2VTaXplLCAxLCBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkpO1xuICBjb25zdCBwYWdlQ291bnQgPSBjb21wdXRlZCgoKSA9PiBNYXRoLm1heChcbiAgICAxLFxuICAgIE1hdGguY2VpbCh0b1ZhbHVlKHRvdGFsKSAvIHRvVmFsdWUoY3VycmVudFBhZ2VTaXplKSlcbiAgKSk7XG4gIGNvbnN0IGN1cnJlbnRQYWdlID0gdXNlQ2xhbXAocGFnZSwgMSwgcGFnZUNvdW50KTtcbiAgY29uc3QgaXNGaXJzdFBhZ2UgPSBjb21wdXRlZCgoKSA9PiBjdXJyZW50UGFnZS52YWx1ZSA9PT0gMSk7XG4gIGNvbnN0IGlzTGFzdFBhZ2UgPSBjb21wdXRlZCgoKSA9PiBjdXJyZW50UGFnZS52YWx1ZSA9PT0gcGFnZUNvdW50LnZhbHVlKTtcbiAgaWYgKGlzUmVmKHBhZ2UpKSB7XG4gICAgc3luY1JlZihwYWdlLCBjdXJyZW50UGFnZSwge1xuICAgICAgZGlyZWN0aW9uOiBpc1JlYWRvbmx5KHBhZ2UpID8gXCJsdHJcIiA6IFwiYm90aFwiXG4gICAgfSk7XG4gIH1cbiAgaWYgKGlzUmVmKHBhZ2VTaXplKSkge1xuICAgIHN5bmNSZWYocGFnZVNpemUsIGN1cnJlbnRQYWdlU2l6ZSwge1xuICAgICAgZGlyZWN0aW9uOiBpc1JlYWRvbmx5KHBhZ2VTaXplKSA/IFwibHRyXCIgOiBcImJvdGhcIlxuICAgIH0pO1xuICB9XG4gIGZ1bmN0aW9uIHByZXYoKSB7XG4gICAgY3VycmVudFBhZ2UudmFsdWUtLTtcbiAgfVxuICBmdW5jdGlvbiBuZXh0KCkge1xuICAgIGN1cnJlbnRQYWdlLnZhbHVlKys7XG4gIH1cbiAgY29uc3QgcmV0dXJuVmFsdWUgPSB7XG4gICAgY3VycmVudFBhZ2UsXG4gICAgY3VycmVudFBhZ2VTaXplLFxuICAgIHBhZ2VDb3VudCxcbiAgICBpc0ZpcnN0UGFnZSxcbiAgICBpc0xhc3RQYWdlLFxuICAgIHByZXYsXG4gICAgbmV4dFxuICB9O1xuICB3YXRjaChjdXJyZW50UGFnZSwgKCkgPT4ge1xuICAgIG9uUGFnZUNoYW5nZShyZWFjdGl2ZShyZXR1cm5WYWx1ZSkpO1xuICB9KTtcbiAgd2F0Y2goY3VycmVudFBhZ2VTaXplLCAoKSA9PiB7XG4gICAgb25QYWdlU2l6ZUNoYW5nZShyZWFjdGl2ZShyZXR1cm5WYWx1ZSkpO1xuICB9KTtcbiAgd2F0Y2gocGFnZUNvdW50LCAoKSA9PiB7XG4gICAgb25QYWdlQ291bnRDaGFuZ2UocmVhY3RpdmUocmV0dXJuVmFsdWUpKTtcbiAgfSk7XG4gIHJldHVybiByZXR1cm5WYWx1ZTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZU9ubGluZShvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyBpc09ubGluZSB9ID0gdXNlTmV0d29yayhvcHRpb25zKTtcbiAgcmV0dXJuIGlzT25saW5lO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlUGFnZUxlYXZlKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7IHdpbmRvdyA9IGRlZmF1bHRXaW5kb3cgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGlzTGVmdCA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBoYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgaWYgKCF3aW5kb3cpXG4gICAgICByZXR1cm47XG4gICAgZXZlbnQgPSBldmVudCB8fCB3aW5kb3cuZXZlbnQ7XG4gICAgY29uc3QgZnJvbSA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgZXZlbnQudG9FbGVtZW50O1xuICAgIGlzTGVmdC52YWx1ZSA9ICFmcm9tO1xuICB9O1xuICBpZiAod2luZG93KSB7XG4gICAgY29uc3QgbGlzdGVuZXJPcHRpb25zID0geyBwYXNzaXZlOiB0cnVlIH07XG4gICAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3csIFwibW91c2VvdXRcIiwgaGFuZGxlciwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICB1c2VFdmVudExpc3RlbmVyKHdpbmRvdy5kb2N1bWVudCwgXCJtb3VzZWxlYXZlXCIsIGhhbmRsZXIsIGxpc3RlbmVyT3B0aW9ucyk7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3cuZG9jdW1lbnQsIFwibW91c2VlbnRlclwiLCBoYW5kbGVyLCBsaXN0ZW5lck9wdGlvbnMpO1xuICB9XG4gIHJldHVybiBpc0xlZnQ7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VTY3JlZW5PcmllbnRhdGlvbihvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3dcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHdpbmRvdyAmJiBcInNjcmVlblwiIGluIHdpbmRvdyAmJiBcIm9yaWVudGF0aW9uXCIgaW4gd2luZG93LnNjcmVlbik7XG4gIGNvbnN0IHNjcmVlbk9yaWVudGF0aW9uID0gaXNTdXBwb3J0ZWQudmFsdWUgPyB3aW5kb3cuc2NyZWVuLm9yaWVudGF0aW9uIDoge307XG4gIGNvbnN0IG9yaWVudGF0aW9uID0gcmVmKHNjcmVlbk9yaWVudGF0aW9uLnR5cGUpO1xuICBjb25zdCBhbmdsZSA9IHNoYWxsb3dSZWYoc2NyZWVuT3JpZW50YXRpb24uYW5nbGUgfHwgMCk7XG4gIGlmIChpc1N1cHBvcnRlZC52YWx1ZSkge1xuICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcIm9yaWVudGF0aW9uY2hhbmdlXCIsICgpID0+IHtcbiAgICAgIG9yaWVudGF0aW9uLnZhbHVlID0gc2NyZWVuT3JpZW50YXRpb24udHlwZTtcbiAgICAgIGFuZ2xlLnZhbHVlID0gc2NyZWVuT3JpZW50YXRpb24uYW5nbGU7XG4gICAgfSwgeyBwYXNzaXZlOiB0cnVlIH0pO1xuICB9XG4gIGNvbnN0IGxvY2tPcmllbnRhdGlvbiA9ICh0eXBlKSA9PiB7XG4gICAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlICYmIHR5cGVvZiBzY3JlZW5PcmllbnRhdGlvbi5sb2NrID09PSBcImZ1bmN0aW9uXCIpXG4gICAgICByZXR1cm4gc2NyZWVuT3JpZW50YXRpb24ubG9jayh0eXBlKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFwiTm90IHN1cHBvcnRlZFwiKSk7XG4gIH07XG4gIGNvbnN0IHVubG9ja09yaWVudGF0aW9uID0gKCkgPT4ge1xuICAgIGlmIChpc1N1cHBvcnRlZC52YWx1ZSAmJiB0eXBlb2Ygc2NyZWVuT3JpZW50YXRpb24udW5sb2NrID09PSBcImZ1bmN0aW9uXCIpXG4gICAgICBzY3JlZW5PcmllbnRhdGlvbi51bmxvY2soKTtcbiAgfTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBvcmllbnRhdGlvbixcbiAgICBhbmdsZSxcbiAgICBsb2NrT3JpZW50YXRpb24sXG4gICAgdW5sb2NrT3JpZW50YXRpb25cbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlUGFyYWxsYXgodGFyZ2V0LCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGRldmljZU9yaWVudGF0aW9uVGlsdEFkanVzdCA9IChpKSA9PiBpLFxuICAgIGRldmljZU9yaWVudGF0aW9uUm9sbEFkanVzdCA9IChpKSA9PiBpLFxuICAgIG1vdXNlVGlsdEFkanVzdCA9IChpKSA9PiBpLFxuICAgIG1vdXNlUm9sbEFkanVzdCA9IChpKSA9PiBpLFxuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3dcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IG9yaWVudGF0aW9uID0gcmVhY3RpdmUodXNlRGV2aWNlT3JpZW50YXRpb24oeyB3aW5kb3cgfSkpO1xuICBjb25zdCBzY3JlZW5PcmllbnRhdGlvbiA9IHJlYWN0aXZlKHVzZVNjcmVlbk9yaWVudGF0aW9uKHsgd2luZG93IH0pKTtcbiAgY29uc3Qge1xuICAgIGVsZW1lbnRYOiB4LFxuICAgIGVsZW1lbnRZOiB5LFxuICAgIGVsZW1lbnRXaWR0aDogd2lkdGgsXG4gICAgZWxlbWVudEhlaWdodDogaGVpZ2h0XG4gIH0gPSB1c2VNb3VzZUluRWxlbWVudCh0YXJnZXQsIHsgaGFuZGxlT3V0c2lkZTogZmFsc2UsIHdpbmRvdyB9KTtcbiAgY29uc3Qgc291cmNlID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGlmIChvcmllbnRhdGlvbi5pc1N1cHBvcnRlZCAmJiAob3JpZW50YXRpb24uYWxwaGEgIT0gbnVsbCAmJiBvcmllbnRhdGlvbi5hbHBoYSAhPT0gMCB8fCBvcmllbnRhdGlvbi5nYW1tYSAhPSBudWxsICYmIG9yaWVudGF0aW9uLmdhbW1hICE9PSAwKSkge1xuICAgICAgcmV0dXJuIFwiZGV2aWNlT3JpZW50YXRpb25cIjtcbiAgICB9XG4gICAgcmV0dXJuIFwibW91c2VcIjtcbiAgfSk7XG4gIGNvbnN0IHJvbGwgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgaWYgKHNvdXJjZS52YWx1ZSA9PT0gXCJkZXZpY2VPcmllbnRhdGlvblwiKSB7XG4gICAgICBsZXQgdmFsdWU7XG4gICAgICBzd2l0Y2ggKHNjcmVlbk9yaWVudGF0aW9uLm9yaWVudGF0aW9uKSB7XG4gICAgICAgIGNhc2UgXCJsYW5kc2NhcGUtcHJpbWFyeVwiOlxuICAgICAgICAgIHZhbHVlID0gb3JpZW50YXRpb24uZ2FtbWEgLyA5MDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcImxhbmRzY2FwZS1zZWNvbmRhcnlcIjpcbiAgICAgICAgICB2YWx1ZSA9IC1vcmllbnRhdGlvbi5nYW1tYSAvIDkwO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwicG9ydHJhaXQtcHJpbWFyeVwiOlxuICAgICAgICAgIHZhbHVlID0gLW9yaWVudGF0aW9uLmJldGEgLyA5MDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcInBvcnRyYWl0LXNlY29uZGFyeVwiOlxuICAgICAgICAgIHZhbHVlID0gb3JpZW50YXRpb24uYmV0YSAvIDkwO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHZhbHVlID0gLW9yaWVudGF0aW9uLmJldGEgLyA5MDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBkZXZpY2VPcmllbnRhdGlvblJvbGxBZGp1c3QodmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IC0oeS52YWx1ZSAtIGhlaWdodC52YWx1ZSAvIDIpIC8gaGVpZ2h0LnZhbHVlO1xuICAgICAgcmV0dXJuIG1vdXNlUm9sbEFkanVzdCh2YWx1ZSk7XG4gICAgfVxuICB9KTtcbiAgY29uc3QgdGlsdCA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICBpZiAoc291cmNlLnZhbHVlID09PSBcImRldmljZU9yaWVudGF0aW9uXCIpIHtcbiAgICAgIGxldCB2YWx1ZTtcbiAgICAgIHN3aXRjaCAoc2NyZWVuT3JpZW50YXRpb24ub3JpZW50YXRpb24pIHtcbiAgICAgICAgY2FzZSBcImxhbmRzY2FwZS1wcmltYXJ5XCI6XG4gICAgICAgICAgdmFsdWUgPSBvcmllbnRhdGlvbi5iZXRhIC8gOTA7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgXCJsYW5kc2NhcGUtc2Vjb25kYXJ5XCI6XG4gICAgICAgICAgdmFsdWUgPSAtb3JpZW50YXRpb24uYmV0YSAvIDkwO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwicG9ydHJhaXQtcHJpbWFyeVwiOlxuICAgICAgICAgIHZhbHVlID0gb3JpZW50YXRpb24uZ2FtbWEgLyA5MDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcInBvcnRyYWl0LXNlY29uZGFyeVwiOlxuICAgICAgICAgIHZhbHVlID0gLW9yaWVudGF0aW9uLmdhbW1hIC8gOTA7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdmFsdWUgPSBvcmllbnRhdGlvbi5nYW1tYSAvIDkwO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRldmljZU9yaWVudGF0aW9uVGlsdEFkanVzdCh2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gKHgudmFsdWUgLSB3aWR0aC52YWx1ZSAvIDIpIC8gd2lkdGgudmFsdWU7XG4gICAgICByZXR1cm4gbW91c2VUaWx0QWRqdXN0KHZhbHVlKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4geyByb2xsLCB0aWx0LCBzb3VyY2UgfTtcbn1cblxuZnVuY3Rpb24gdXNlUGFyZW50RWxlbWVudChlbGVtZW50ID0gdXNlQ3VycmVudEVsZW1lbnQoKSkge1xuICBjb25zdCBwYXJlbnRFbGVtZW50ID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCB1cGRhdGUgPSAoKSA9PiB7XG4gICAgY29uc3QgZWwgPSB1bnJlZkVsZW1lbnQoZWxlbWVudCk7XG4gICAgaWYgKGVsKVxuICAgICAgcGFyZW50RWxlbWVudC52YWx1ZSA9IGVsLnBhcmVudEVsZW1lbnQ7XG4gIH07XG4gIHRyeU9uTW91bnRlZCh1cGRhdGUpO1xuICB3YXRjaCgoKSA9PiB0b1ZhbHVlKGVsZW1lbnQpLCB1cGRhdGUpO1xuICByZXR1cm4gcGFyZW50RWxlbWVudDtcbn1cblxuZnVuY3Rpb24gdXNlUGVyZm9ybWFuY2VPYnNlcnZlcihvcHRpb25zLCBjYWxsYmFjaykge1xuICBjb25zdCB7XG4gICAgd2luZG93ID0gZGVmYXVsdFdpbmRvdyxcbiAgICBpbW1lZGlhdGUgPSB0cnVlLFxuICAgIC4uLnBlcmZvcm1hbmNlT3B0aW9uc1xuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgaXNTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gd2luZG93ICYmIFwiUGVyZm9ybWFuY2VPYnNlcnZlclwiIGluIHdpbmRvdyk7XG4gIGxldCBvYnNlcnZlcjtcbiAgY29uc3Qgc3RvcCA9ICgpID0+IHtcbiAgICBvYnNlcnZlciA9PSBudWxsID8gdm9pZCAwIDogb2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xuICB9O1xuICBjb25zdCBzdGFydCA9ICgpID0+IHtcbiAgICBpZiAoaXNTdXBwb3J0ZWQudmFsdWUpIHtcbiAgICAgIHN0b3AoKTtcbiAgICAgIG9ic2VydmVyID0gbmV3IFBlcmZvcm1hbmNlT2JzZXJ2ZXIoY2FsbGJhY2spO1xuICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZShwZXJmb3JtYW5jZU9wdGlvbnMpO1xuICAgIH1cbiAgfTtcbiAgdHJ5T25TY29wZURpc3Bvc2Uoc3RvcCk7XG4gIGlmIChpbW1lZGlhdGUpXG4gICAgc3RhcnQoKTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBzdGFydCxcbiAgICBzdG9wXG4gIH07XG59XG5cbmNvbnN0IGRlZmF1bHRTdGF0ZSA9IHtcbiAgeDogMCxcbiAgeTogMCxcbiAgcG9pbnRlcklkOiAwLFxuICBwcmVzc3VyZTogMCxcbiAgdGlsdFg6IDAsXG4gIHRpbHRZOiAwLFxuICB3aWR0aDogMCxcbiAgaGVpZ2h0OiAwLFxuICB0d2lzdDogMCxcbiAgcG9pbnRlclR5cGU6IG51bGxcbn07XG5jb25zdCBrZXlzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5rZXlzKGRlZmF1bHRTdGF0ZSk7XG5mdW5jdGlvbiB1c2VQb2ludGVyKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdGFyZ2V0ID0gZGVmYXVsdFdpbmRvd1xuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgaXNJbnNpZGUgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3Qgc3RhdGUgPSBzaGFsbG93UmVmKG9wdGlvbnMuaW5pdGlhbFZhbHVlIHx8IHt9KTtcbiAgT2JqZWN0LmFzc2lnbihzdGF0ZS52YWx1ZSwgZGVmYXVsdFN0YXRlLCBzdGF0ZS52YWx1ZSk7XG4gIGNvbnN0IGhhbmRsZXIgPSAoZXZlbnQpID0+IHtcbiAgICBpc0luc2lkZS52YWx1ZSA9IHRydWU7XG4gICAgaWYgKG9wdGlvbnMucG9pbnRlclR5cGVzICYmICFvcHRpb25zLnBvaW50ZXJUeXBlcy5pbmNsdWRlcyhldmVudC5wb2ludGVyVHlwZSkpXG4gICAgICByZXR1cm47XG4gICAgc3RhdGUudmFsdWUgPSBvYmplY3RQaWNrKGV2ZW50LCBrZXlzLCBmYWxzZSk7XG4gIH07XG4gIGlmICh0YXJnZXQpIHtcbiAgICBjb25zdCBsaXN0ZW5lck9wdGlvbnMgPSB7IHBhc3NpdmU6IHRydWUgfTtcbiAgICB1c2VFdmVudExpc3RlbmVyKHRhcmdldCwgW1wicG9pbnRlcmRvd25cIiwgXCJwb2ludGVybW92ZVwiLCBcInBvaW50ZXJ1cFwiXSwgaGFuZGxlciwgbGlzdGVuZXJPcHRpb25zKTtcbiAgICB1c2VFdmVudExpc3RlbmVyKHRhcmdldCwgXCJwb2ludGVybGVhdmVcIiwgKCkgPT4gaXNJbnNpZGUudmFsdWUgPSBmYWxzZSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIC4uLnRvUmVmcyhzdGF0ZSksXG4gICAgaXNJbnNpZGVcbiAgfTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZVBvaW50ZXJMb2NrKHRhcmdldCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgZG9jdW1lbnQgPSBkZWZhdWx0RG9jdW1lbnQgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IGRvY3VtZW50ICYmIFwicG9pbnRlckxvY2tFbGVtZW50XCIgaW4gZG9jdW1lbnQpO1xuICBjb25zdCBlbGVtZW50ID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCB0cmlnZ2VyRWxlbWVudCA9IHNoYWxsb3dSZWYoKTtcbiAgbGV0IHRhcmdldEVsZW1lbnQ7XG4gIGlmIChpc1N1cHBvcnRlZC52YWx1ZSkge1xuICAgIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHsgcGFzc2l2ZTogdHJ1ZSB9O1xuICAgIHVzZUV2ZW50TGlzdGVuZXIoZG9jdW1lbnQsIFwicG9pbnRlcmxvY2tjaGFuZ2VcIiwgKCkgPT4ge1xuICAgICAgdmFyIF9hO1xuICAgICAgY29uc3QgY3VycmVudEVsZW1lbnQgPSAoX2EgPSBkb2N1bWVudC5wb2ludGVyTG9ja0VsZW1lbnQpICE9IG51bGwgPyBfYSA6IGVsZW1lbnQudmFsdWU7XG4gICAgICBpZiAodGFyZ2V0RWxlbWVudCAmJiBjdXJyZW50RWxlbWVudCA9PT0gdGFyZ2V0RWxlbWVudCkge1xuICAgICAgICBlbGVtZW50LnZhbHVlID0gZG9jdW1lbnQucG9pbnRlckxvY2tFbGVtZW50O1xuICAgICAgICBpZiAoIWVsZW1lbnQudmFsdWUpXG4gICAgICAgICAgdGFyZ2V0RWxlbWVudCA9IHRyaWdnZXJFbGVtZW50LnZhbHVlID0gbnVsbDtcbiAgICAgIH1cbiAgICB9LCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgIHVzZUV2ZW50TGlzdGVuZXIoZG9jdW1lbnQsIFwicG9pbnRlcmxvY2tlcnJvclwiLCAoKSA9PiB7XG4gICAgICB2YXIgX2E7XG4gICAgICBjb25zdCBjdXJyZW50RWxlbWVudCA9IChfYSA9IGRvY3VtZW50LnBvaW50ZXJMb2NrRWxlbWVudCkgIT0gbnVsbCA/IF9hIDogZWxlbWVudC52YWx1ZTtcbiAgICAgIGlmICh0YXJnZXRFbGVtZW50ICYmIGN1cnJlbnRFbGVtZW50ID09PSB0YXJnZXRFbGVtZW50KSB7XG4gICAgICAgIGNvbnN0IGFjdGlvbiA9IGRvY3VtZW50LnBvaW50ZXJMb2NrRWxlbWVudCA/IFwicmVsZWFzZVwiIDogXCJhY3F1aXJlXCI7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvICR7YWN0aW9ufSBwb2ludGVyIGxvY2suYCk7XG4gICAgICB9XG4gICAgfSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgfVxuICBhc3luYyBmdW5jdGlvbiBsb2NrKGUpIHtcbiAgICB2YXIgX2E7XG4gICAgaWYgKCFpc1N1cHBvcnRlZC52YWx1ZSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlBvaW50ZXIgTG9jayBBUEkgaXMgbm90IHN1cHBvcnRlZCBieSB5b3VyIGJyb3dzZXIuXCIpO1xuICAgIHRyaWdnZXJFbGVtZW50LnZhbHVlID0gZSBpbnN0YW5jZW9mIEV2ZW50ID8gZS5jdXJyZW50VGFyZ2V0IDogbnVsbDtcbiAgICB0YXJnZXRFbGVtZW50ID0gZSBpbnN0YW5jZW9mIEV2ZW50ID8gKF9hID0gdW5yZWZFbGVtZW50KHRhcmdldCkpICE9IG51bGwgPyBfYSA6IHRyaWdnZXJFbGVtZW50LnZhbHVlIDogdW5yZWZFbGVtZW50KGUpO1xuICAgIGlmICghdGFyZ2V0RWxlbWVudClcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlRhcmdldCBlbGVtZW50IHVuZGVmaW5lZC5cIik7XG4gICAgdGFyZ2V0RWxlbWVudC5yZXF1ZXN0UG9pbnRlckxvY2soKTtcbiAgICByZXR1cm4gYXdhaXQgdW50aWwoZWxlbWVudCkudG9CZSh0YXJnZXRFbGVtZW50KTtcbiAgfVxuICBhc3luYyBmdW5jdGlvbiB1bmxvY2soKSB7XG4gICAgaWYgKCFlbGVtZW50LnZhbHVlKVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIGRvY3VtZW50LmV4aXRQb2ludGVyTG9jaygpO1xuICAgIGF3YWl0IHVudGlsKGVsZW1lbnQpLnRvQmVOdWxsKCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBlbGVtZW50LFxuICAgIHRyaWdnZXJFbGVtZW50LFxuICAgIGxvY2ssXG4gICAgdW5sb2NrXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZVBvaW50ZXJTd2lwZSh0YXJnZXQsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB0YXJnZXRSZWYgPSB0b1JlZih0YXJnZXQpO1xuICBjb25zdCB7XG4gICAgdGhyZXNob2xkID0gNTAsXG4gICAgb25Td2lwZSxcbiAgICBvblN3aXBlRW5kLFxuICAgIG9uU3dpcGVTdGFydCxcbiAgICBkaXNhYmxlVGV4dFNlbGVjdCA9IGZhbHNlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBwb3NTdGFydCA9IHJlYWN0aXZlKHsgeDogMCwgeTogMCB9KTtcbiAgY29uc3QgdXBkYXRlUG9zU3RhcnQgPSAoeCwgeSkgPT4ge1xuICAgIHBvc1N0YXJ0LnggPSB4O1xuICAgIHBvc1N0YXJ0LnkgPSB5O1xuICB9O1xuICBjb25zdCBwb3NFbmQgPSByZWFjdGl2ZSh7IHg6IDAsIHk6IDAgfSk7XG4gIGNvbnN0IHVwZGF0ZVBvc0VuZCA9ICh4LCB5KSA9PiB7XG4gICAgcG9zRW5kLnggPSB4O1xuICAgIHBvc0VuZC55ID0geTtcbiAgfTtcbiAgY29uc3QgZGlzdGFuY2VYID0gY29tcHV0ZWQoKCkgPT4gcG9zU3RhcnQueCAtIHBvc0VuZC54KTtcbiAgY29uc3QgZGlzdGFuY2VZID0gY29tcHV0ZWQoKCkgPT4gcG9zU3RhcnQueSAtIHBvc0VuZC55KTtcbiAgY29uc3QgeyBtYXgsIGFicyB9ID0gTWF0aDtcbiAgY29uc3QgaXNUaHJlc2hvbGRFeGNlZWRlZCA9IGNvbXB1dGVkKCgpID0+IG1heChhYnMoZGlzdGFuY2VYLnZhbHVlKSwgYWJzKGRpc3RhbmNlWS52YWx1ZSkpID49IHRocmVzaG9sZCk7XG4gIGNvbnN0IGlzU3dpcGluZyA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBpc1BvaW50ZXJEb3duID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IGRpcmVjdGlvbiA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICBpZiAoIWlzVGhyZXNob2xkRXhjZWVkZWQudmFsdWUpXG4gICAgICByZXR1cm4gXCJub25lXCI7XG4gICAgaWYgKGFicyhkaXN0YW5jZVgudmFsdWUpID4gYWJzKGRpc3RhbmNlWS52YWx1ZSkpIHtcbiAgICAgIHJldHVybiBkaXN0YW5jZVgudmFsdWUgPiAwID8gXCJsZWZ0XCIgOiBcInJpZ2h0XCI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBkaXN0YW5jZVkudmFsdWUgPiAwID8gXCJ1cFwiIDogXCJkb3duXCI7XG4gICAgfVxuICB9KTtcbiAgY29uc3QgZXZlbnRJc0FsbG93ZWQgPSAoZSkgPT4ge1xuICAgIHZhciBfYSwgX2IsIF9jO1xuICAgIGNvbnN0IGlzUmVsZWFzaW5nQnV0dG9uID0gZS5idXR0b25zID09PSAwO1xuICAgIGNvbnN0IGlzUHJpbWFyeUJ1dHRvbiA9IGUuYnV0dG9ucyA9PT0gMTtcbiAgICByZXR1cm4gKF9jID0gKF9iID0gKF9hID0gb3B0aW9ucy5wb2ludGVyVHlwZXMpID09IG51bGwgPyB2b2lkIDAgOiBfYS5pbmNsdWRlcyhlLnBvaW50ZXJUeXBlKSkgIT0gbnVsbCA/IF9iIDogaXNSZWxlYXNpbmdCdXR0b24gfHwgaXNQcmltYXJ5QnV0dG9uKSAhPSBudWxsID8gX2MgOiB0cnVlO1xuICB9O1xuICBjb25zdCBsaXN0ZW5lck9wdGlvbnMgPSB7IHBhc3NpdmU6IHRydWUgfTtcbiAgY29uc3Qgc3RvcHMgPSBbXG4gICAgdXNlRXZlbnRMaXN0ZW5lcih0YXJnZXQsIFwicG9pbnRlcmRvd25cIiwgKGUpID0+IHtcbiAgICAgIGlmICghZXZlbnRJc0FsbG93ZWQoZSkpXG4gICAgICAgIHJldHVybjtcbiAgICAgIGlzUG9pbnRlckRvd24udmFsdWUgPSB0cnVlO1xuICAgICAgY29uc3QgZXZlbnRUYXJnZXQgPSBlLnRhcmdldDtcbiAgICAgIGV2ZW50VGFyZ2V0ID09IG51bGwgPyB2b2lkIDAgOiBldmVudFRhcmdldC5zZXRQb2ludGVyQ2FwdHVyZShlLnBvaW50ZXJJZCk7XG4gICAgICBjb25zdCB7IGNsaWVudFg6IHgsIGNsaWVudFk6IHkgfSA9IGU7XG4gICAgICB1cGRhdGVQb3NTdGFydCh4LCB5KTtcbiAgICAgIHVwZGF0ZVBvc0VuZCh4LCB5KTtcbiAgICAgIG9uU3dpcGVTdGFydCA9PSBudWxsID8gdm9pZCAwIDogb25Td2lwZVN0YXJ0KGUpO1xuICAgIH0sIGxpc3RlbmVyT3B0aW9ucyksXG4gICAgdXNlRXZlbnRMaXN0ZW5lcih0YXJnZXQsIFwicG9pbnRlcm1vdmVcIiwgKGUpID0+IHtcbiAgICAgIGlmICghZXZlbnRJc0FsbG93ZWQoZSkpXG4gICAgICAgIHJldHVybjtcbiAgICAgIGlmICghaXNQb2ludGVyRG93bi52YWx1ZSlcbiAgICAgICAgcmV0dXJuO1xuICAgICAgY29uc3QgeyBjbGllbnRYOiB4LCBjbGllbnRZOiB5IH0gPSBlO1xuICAgICAgdXBkYXRlUG9zRW5kKHgsIHkpO1xuICAgICAgaWYgKCFpc1N3aXBpbmcudmFsdWUgJiYgaXNUaHJlc2hvbGRFeGNlZWRlZC52YWx1ZSlcbiAgICAgICAgaXNTd2lwaW5nLnZhbHVlID0gdHJ1ZTtcbiAgICAgIGlmIChpc1N3aXBpbmcudmFsdWUpXG4gICAgICAgIG9uU3dpcGUgPT0gbnVsbCA/IHZvaWQgMCA6IG9uU3dpcGUoZSk7XG4gICAgfSwgbGlzdGVuZXJPcHRpb25zKSxcbiAgICB1c2VFdmVudExpc3RlbmVyKHRhcmdldCwgXCJwb2ludGVydXBcIiwgKGUpID0+IHtcbiAgICAgIGlmICghZXZlbnRJc0FsbG93ZWQoZSkpXG4gICAgICAgIHJldHVybjtcbiAgICAgIGlmIChpc1N3aXBpbmcudmFsdWUpXG4gICAgICAgIG9uU3dpcGVFbmQgPT0gbnVsbCA/IHZvaWQgMCA6IG9uU3dpcGVFbmQoZSwgZGlyZWN0aW9uLnZhbHVlKTtcbiAgICAgIGlzUG9pbnRlckRvd24udmFsdWUgPSBmYWxzZTtcbiAgICAgIGlzU3dpcGluZy52YWx1ZSA9IGZhbHNlO1xuICAgIH0sIGxpc3RlbmVyT3B0aW9ucylcbiAgXTtcbiAgdHJ5T25Nb3VudGVkKCgpID0+IHtcbiAgICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lLCBfZiwgX2csIF9oO1xuICAgIChfYiA9IChfYSA9IHRhcmdldFJlZi52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnN0eWxlKSA9PSBudWxsID8gdm9pZCAwIDogX2Iuc2V0UHJvcGVydHkoXCJ0b3VjaC1hY3Rpb25cIiwgXCJwYW4teVwiKTtcbiAgICBpZiAoZGlzYWJsZVRleHRTZWxlY3QpIHtcbiAgICAgIChfZCA9IChfYyA9IHRhcmdldFJlZi52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9jLnN0eWxlKSA9PSBudWxsID8gdm9pZCAwIDogX2Quc2V0UHJvcGVydHkoXCItd2Via2l0LXVzZXItc2VsZWN0XCIsIFwibm9uZVwiKTtcbiAgICAgIChfZiA9IChfZSA9IHRhcmdldFJlZi52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9lLnN0eWxlKSA9PSBudWxsID8gdm9pZCAwIDogX2Yuc2V0UHJvcGVydHkoXCItbXMtdXNlci1zZWxlY3RcIiwgXCJub25lXCIpO1xuICAgICAgKF9oID0gKF9nID0gdGFyZ2V0UmVmLnZhbHVlKSA9PSBudWxsID8gdm9pZCAwIDogX2cuc3R5bGUpID09IG51bGwgPyB2b2lkIDAgOiBfaC5zZXRQcm9wZXJ0eShcInVzZXItc2VsZWN0XCIsIFwibm9uZVwiKTtcbiAgICB9XG4gIH0pO1xuICBjb25zdCBzdG9wID0gKCkgPT4gc3RvcHMuZm9yRWFjaCgocykgPT4gcygpKTtcbiAgcmV0dXJuIHtcbiAgICBpc1N3aXBpbmc6IHJlYWRvbmx5KGlzU3dpcGluZyksXG4gICAgZGlyZWN0aW9uOiByZWFkb25seShkaXJlY3Rpb24pLFxuICAgIHBvc1N0YXJ0OiByZWFkb25seShwb3NTdGFydCksXG4gICAgcG9zRW5kOiByZWFkb25seShwb3NFbmQpLFxuICAgIGRpc3RhbmNlWCxcbiAgICBkaXN0YW5jZVksXG4gICAgc3RvcFxuICB9O1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlUHJlZmVycmVkQ29sb3JTY2hlbWUob3B0aW9ucykge1xuICBjb25zdCBpc0xpZ2h0ID0gdXNlTWVkaWFRdWVyeShcIihwcmVmZXJzLWNvbG9yLXNjaGVtZTogbGlnaHQpXCIsIG9wdGlvbnMpO1xuICBjb25zdCBpc0RhcmsgPSB1c2VNZWRpYVF1ZXJ5KFwiKHByZWZlcnMtY29sb3Itc2NoZW1lOiBkYXJrKVwiLCBvcHRpb25zKTtcbiAgcmV0dXJuIGNvbXB1dGVkKCgpID0+IHtcbiAgICBpZiAoaXNEYXJrLnZhbHVlKVxuICAgICAgcmV0dXJuIFwiZGFya1wiO1xuICAgIGlmIChpc0xpZ2h0LnZhbHVlKVxuICAgICAgcmV0dXJuIFwibGlnaHRcIjtcbiAgICByZXR1cm4gXCJuby1wcmVmZXJlbmNlXCI7XG4gIH0pO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlUHJlZmVycmVkQ29udHJhc3Qob3B0aW9ucykge1xuICBjb25zdCBpc01vcmUgPSB1c2VNZWRpYVF1ZXJ5KFwiKHByZWZlcnMtY29udHJhc3Q6IG1vcmUpXCIsIG9wdGlvbnMpO1xuICBjb25zdCBpc0xlc3MgPSB1c2VNZWRpYVF1ZXJ5KFwiKHByZWZlcnMtY29udHJhc3Q6IGxlc3MpXCIsIG9wdGlvbnMpO1xuICBjb25zdCBpc0N1c3RvbSA9IHVzZU1lZGlhUXVlcnkoXCIocHJlZmVycy1jb250cmFzdDogY3VzdG9tKVwiLCBvcHRpb25zKTtcbiAgcmV0dXJuIGNvbXB1dGVkKCgpID0+IHtcbiAgICBpZiAoaXNNb3JlLnZhbHVlKVxuICAgICAgcmV0dXJuIFwibW9yZVwiO1xuICAgIGlmIChpc0xlc3MudmFsdWUpXG4gICAgICByZXR1cm4gXCJsZXNzXCI7XG4gICAgaWYgKGlzQ3VzdG9tLnZhbHVlKVxuICAgICAgcmV0dXJuIFwiY3VzdG9tXCI7XG4gICAgcmV0dXJuIFwibm8tcHJlZmVyZW5jZVwiO1xuICB9KTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZVByZWZlcnJlZExhbmd1YWdlcyhvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyB3aW5kb3cgPSBkZWZhdWx0V2luZG93IH0gPSBvcHRpb25zO1xuICBpZiAoIXdpbmRvdylcbiAgICByZXR1cm4gc2hhbGxvd1JlZihbXCJlblwiXSk7XG4gIGNvbnN0IG5hdmlnYXRvciA9IHdpbmRvdy5uYXZpZ2F0b3I7XG4gIGNvbnN0IHZhbHVlID0gc2hhbGxvd1JlZihuYXZpZ2F0b3IubGFuZ3VhZ2VzKTtcbiAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3csIFwibGFuZ3VhZ2VjaGFuZ2VcIiwgKCkgPT4ge1xuICAgIHZhbHVlLnZhbHVlID0gbmF2aWdhdG9yLmxhbmd1YWdlcztcbiAgfSwgeyBwYXNzaXZlOiB0cnVlIH0pO1xuICByZXR1cm4gdmFsdWU7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VQcmVmZXJyZWRSZWR1Y2VkTW90aW9uKG9wdGlvbnMpIHtcbiAgY29uc3QgaXNSZWR1Y2VkID0gdXNlTWVkaWFRdWVyeShcIihwcmVmZXJzLXJlZHVjZWQtbW90aW9uOiByZWR1Y2UpXCIsIG9wdGlvbnMpO1xuICByZXR1cm4gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGlmIChpc1JlZHVjZWQudmFsdWUpXG4gICAgICByZXR1cm4gXCJyZWR1Y2VcIjtcbiAgICByZXR1cm4gXCJuby1wcmVmZXJlbmNlXCI7XG4gIH0pO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlUHJlZmVycmVkUmVkdWNlZFRyYW5zcGFyZW5jeShvcHRpb25zKSB7XG4gIGNvbnN0IGlzUmVkdWNlZCA9IHVzZU1lZGlhUXVlcnkoXCIocHJlZmVycy1yZWR1Y2VkLXRyYW5zcGFyZW5jeTogcmVkdWNlKVwiLCBvcHRpb25zKTtcbiAgcmV0dXJuIGNvbXB1dGVkKCgpID0+IHtcbiAgICBpZiAoaXNSZWR1Y2VkLnZhbHVlKVxuICAgICAgcmV0dXJuIFwicmVkdWNlXCI7XG4gICAgcmV0dXJuIFwibm8tcHJlZmVyZW5jZVwiO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gdXNlUHJldmlvdXModmFsdWUsIGluaXRpYWxWYWx1ZSkge1xuICBjb25zdCBwcmV2aW91cyA9IHNoYWxsb3dSZWYoaW5pdGlhbFZhbHVlKTtcbiAgd2F0Y2goXG4gICAgdG9SZWYodmFsdWUpLFxuICAgIChfLCBvbGRWYWx1ZSkgPT4ge1xuICAgICAgcHJldmlvdXMudmFsdWUgPSBvbGRWYWx1ZTtcbiAgICB9LFxuICAgIHsgZmx1c2g6IFwic3luY1wiIH1cbiAgKTtcbiAgcmV0dXJuIHJlYWRvbmx5KHByZXZpb3VzKTtcbn1cblxuY29uc3QgdG9wVmFyTmFtZSA9IFwiLS12dWV1c2Utc2FmZS1hcmVhLXRvcFwiO1xuY29uc3QgcmlnaHRWYXJOYW1lID0gXCItLXZ1ZXVzZS1zYWZlLWFyZWEtcmlnaHRcIjtcbmNvbnN0IGJvdHRvbVZhck5hbWUgPSBcIi0tdnVldXNlLXNhZmUtYXJlYS1ib3R0b21cIjtcbmNvbnN0IGxlZnRWYXJOYW1lID0gXCItLXZ1ZXVzZS1zYWZlLWFyZWEtbGVmdFwiO1xuZnVuY3Rpb24gdXNlU2NyZWVuU2FmZUFyZWEoKSB7XG4gIGNvbnN0IHRvcCA9IHNoYWxsb3dSZWYoXCJcIik7XG4gIGNvbnN0IHJpZ2h0ID0gc2hhbGxvd1JlZihcIlwiKTtcbiAgY29uc3QgYm90dG9tID0gc2hhbGxvd1JlZihcIlwiKTtcbiAgY29uc3QgbGVmdCA9IHNoYWxsb3dSZWYoXCJcIik7XG4gIGlmIChpc0NsaWVudCkge1xuICAgIGNvbnN0IHRvcENzc1ZhciA9IHVzZUNzc1Zhcih0b3BWYXJOYW1lKTtcbiAgICBjb25zdCByaWdodENzc1ZhciA9IHVzZUNzc1ZhcihyaWdodFZhck5hbWUpO1xuICAgIGNvbnN0IGJvdHRvbUNzc1ZhciA9IHVzZUNzc1Zhcihib3R0b21WYXJOYW1lKTtcbiAgICBjb25zdCBsZWZ0Q3NzVmFyID0gdXNlQ3NzVmFyKGxlZnRWYXJOYW1lKTtcbiAgICB0b3BDc3NWYXIudmFsdWUgPSBcImVudihzYWZlLWFyZWEtaW5zZXQtdG9wLCAwcHgpXCI7XG4gICAgcmlnaHRDc3NWYXIudmFsdWUgPSBcImVudihzYWZlLWFyZWEtaW5zZXQtcmlnaHQsIDBweClcIjtcbiAgICBib3R0b21Dc3NWYXIudmFsdWUgPSBcImVudihzYWZlLWFyZWEtaW5zZXQtYm90dG9tLCAwcHgpXCI7XG4gICAgbGVmdENzc1Zhci52YWx1ZSA9IFwiZW52KHNhZmUtYXJlYS1pbnNldC1sZWZ0LCAwcHgpXCI7XG4gICAgdHJ5T25Nb3VudGVkKHVwZGF0ZSk7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcihcInJlc2l6ZVwiLCB1c2VEZWJvdW5jZUZuKHVwZGF0ZSksIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgfVxuICBmdW5jdGlvbiB1cGRhdGUoKSB7XG4gICAgdG9wLnZhbHVlID0gZ2V0VmFsdWUodG9wVmFyTmFtZSk7XG4gICAgcmlnaHQudmFsdWUgPSBnZXRWYWx1ZShyaWdodFZhck5hbWUpO1xuICAgIGJvdHRvbS52YWx1ZSA9IGdldFZhbHVlKGJvdHRvbVZhck5hbWUpO1xuICAgIGxlZnQudmFsdWUgPSBnZXRWYWx1ZShsZWZ0VmFyTmFtZSk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICB0b3AsXG4gICAgcmlnaHQsXG4gICAgYm90dG9tLFxuICAgIGxlZnQsXG4gICAgdXBkYXRlXG4gIH07XG59XG5mdW5jdGlvbiBnZXRWYWx1ZShwb3NpdGlvbikge1xuICByZXR1cm4gZ2V0Q29tcHV0ZWRTdHlsZShkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpLmdldFByb3BlcnR5VmFsdWUocG9zaXRpb24pO1xufVxuXG5mdW5jdGlvbiB1c2VTY3JpcHRUYWcoc3JjLCBvbkxvYWRlZCA9IG5vb3AsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgaW1tZWRpYXRlID0gdHJ1ZSxcbiAgICBtYW51YWwgPSBmYWxzZSxcbiAgICB0eXBlID0gXCJ0ZXh0L2phdmFzY3JpcHRcIixcbiAgICBhc3luYyA9IHRydWUsXG4gICAgY3Jvc3NPcmlnaW4sXG4gICAgcmVmZXJyZXJQb2xpY3ksXG4gICAgbm9Nb2R1bGUsXG4gICAgZGVmZXIsXG4gICAgZG9jdW1lbnQgPSBkZWZhdWx0RG9jdW1lbnQsXG4gICAgYXR0cnMgPSB7fSxcbiAgICBub25jZSA9IHZvaWQgMFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3Qgc2NyaXB0VGFnID0gc2hhbGxvd1JlZihudWxsKTtcbiAgbGV0IF9wcm9taXNlID0gbnVsbDtcbiAgY29uc3QgbG9hZFNjcmlwdCA9ICh3YWl0Rm9yU2NyaXB0TG9hZCkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IHJlc29sdmVXaXRoRWxlbWVudCA9IChlbDIpID0+IHtcbiAgICAgIHNjcmlwdFRhZy52YWx1ZSA9IGVsMjtcbiAgICAgIHJlc29sdmUoZWwyKTtcbiAgICAgIHJldHVybiBlbDI7XG4gICAgfTtcbiAgICBpZiAoIWRvY3VtZW50KSB7XG4gICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IHNob3VsZEFwcGVuZCA9IGZhbHNlO1xuICAgIGxldCBlbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHNjcmlwdFtzcmM9XCIke3RvVmFsdWUoc3JjKX1cIl1gKTtcbiAgICBpZiAoIWVsKSB7XG4gICAgICBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzY3JpcHRcIik7XG4gICAgICBlbC50eXBlID0gdHlwZTtcbiAgICAgIGVsLmFzeW5jID0gYXN5bmM7XG4gICAgICBlbC5zcmMgPSB0b1ZhbHVlKHNyYyk7XG4gICAgICBpZiAoZGVmZXIpXG4gICAgICAgIGVsLmRlZmVyID0gZGVmZXI7XG4gICAgICBpZiAoY3Jvc3NPcmlnaW4pXG4gICAgICAgIGVsLmNyb3NzT3JpZ2luID0gY3Jvc3NPcmlnaW47XG4gICAgICBpZiAobm9Nb2R1bGUpXG4gICAgICAgIGVsLm5vTW9kdWxlID0gbm9Nb2R1bGU7XG4gICAgICBpZiAocmVmZXJyZXJQb2xpY3kpXG4gICAgICAgIGVsLnJlZmVycmVyUG9saWN5ID0gcmVmZXJyZXJQb2xpY3k7XG4gICAgICBpZiAobm9uY2UpIHtcbiAgICAgICAgZWwubm9uY2UgPSBub25jZTtcbiAgICAgIH1cbiAgICAgIE9iamVjdC5lbnRyaWVzKGF0dHJzKS5mb3JFYWNoKChbbmFtZSwgdmFsdWVdKSA9PiBlbCA9PSBudWxsID8gdm9pZCAwIDogZWwuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKSk7XG4gICAgICBzaG91bGRBcHBlbmQgPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAoZWwuaGFzQXR0cmlidXRlKFwiZGF0YS1sb2FkZWRcIikpIHtcbiAgICAgIHJlc29sdmVXaXRoRWxlbWVudChlbCk7XG4gICAgfVxuICAgIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHtcbiAgICAgIHBhc3NpdmU6IHRydWVcbiAgICB9O1xuICAgIHVzZUV2ZW50TGlzdGVuZXIoZWwsIFwiZXJyb3JcIiwgKGV2ZW50KSA9PiByZWplY3QoZXZlbnQpLCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgIHVzZUV2ZW50TGlzdGVuZXIoZWwsIFwiYWJvcnRcIiwgKGV2ZW50KSA9PiByZWplY3QoZXZlbnQpLCBsaXN0ZW5lck9wdGlvbnMpO1xuICAgIHVzZUV2ZW50TGlzdGVuZXIoZWwsIFwibG9hZFwiLCAoKSA9PiB7XG4gICAgICBlbC5zZXRBdHRyaWJ1dGUoXCJkYXRhLWxvYWRlZFwiLCBcInRydWVcIik7XG4gICAgICBvbkxvYWRlZChlbCk7XG4gICAgICByZXNvbHZlV2l0aEVsZW1lbnQoZWwpO1xuICAgIH0sIGxpc3RlbmVyT3B0aW9ucyk7XG4gICAgaWYgKHNob3VsZEFwcGVuZClcbiAgICAgIGVsID0gZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChlbCk7XG4gICAgaWYgKCF3YWl0Rm9yU2NyaXB0TG9hZClcbiAgICAgIHJlc29sdmVXaXRoRWxlbWVudChlbCk7XG4gIH0pO1xuICBjb25zdCBsb2FkID0gKHdhaXRGb3JTY3JpcHRMb2FkID0gdHJ1ZSkgPT4ge1xuICAgIGlmICghX3Byb21pc2UpXG4gICAgICBfcHJvbWlzZSA9IGxvYWRTY3JpcHQod2FpdEZvclNjcmlwdExvYWQpO1xuICAgIHJldHVybiBfcHJvbWlzZTtcbiAgfTtcbiAgY29uc3QgdW5sb2FkID0gKCkgPT4ge1xuICAgIGlmICghZG9jdW1lbnQpXG4gICAgICByZXR1cm47XG4gICAgX3Byb21pc2UgPSBudWxsO1xuICAgIGlmIChzY3JpcHRUYWcudmFsdWUpXG4gICAgICBzY3JpcHRUYWcudmFsdWUgPSBudWxsO1xuICAgIGNvbnN0IGVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihgc2NyaXB0W3NyYz1cIiR7dG9WYWx1ZShzcmMpfVwiXWApO1xuICAgIGlmIChlbClcbiAgICAgIGRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoZWwpO1xuICB9O1xuICBpZiAoaW1tZWRpYXRlICYmICFtYW51YWwpXG4gICAgdHJ5T25Nb3VudGVkKGxvYWQpO1xuICBpZiAoIW1hbnVhbClcbiAgICB0cnlPblVubW91bnRlZCh1bmxvYWQpO1xuICByZXR1cm4geyBzY3JpcHRUYWcsIGxvYWQsIHVubG9hZCB9O1xufVxuXG5mdW5jdGlvbiBjaGVja092ZXJmbG93U2Nyb2xsKGVsZSkge1xuICBjb25zdCBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZSk7XG4gIGlmIChzdHlsZS5vdmVyZmxvd1ggPT09IFwic2Nyb2xsXCIgfHwgc3R5bGUub3ZlcmZsb3dZID09PSBcInNjcm9sbFwiIHx8IHN0eWxlLm92ZXJmbG93WCA9PT0gXCJhdXRvXCIgJiYgZWxlLmNsaWVudFdpZHRoIDwgZWxlLnNjcm9sbFdpZHRoIHx8IHN0eWxlLm92ZXJmbG93WSA9PT0gXCJhdXRvXCIgJiYgZWxlLmNsaWVudEhlaWdodCA8IGVsZS5zY3JvbGxIZWlnaHQpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBwYXJlbnQgPSBlbGUucGFyZW50Tm9kZTtcbiAgICBpZiAoIXBhcmVudCB8fCBwYXJlbnQudGFnTmFtZSA9PT0gXCJCT0RZXCIpXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgcmV0dXJuIGNoZWNrT3ZlcmZsb3dTY3JvbGwocGFyZW50KTtcbiAgfVxufVxuZnVuY3Rpb24gcHJldmVudERlZmF1bHQocmF3RXZlbnQpIHtcbiAgY29uc3QgZSA9IHJhd0V2ZW50IHx8IHdpbmRvdy5ldmVudDtcbiAgY29uc3QgX3RhcmdldCA9IGUudGFyZ2V0O1xuICBpZiAoY2hlY2tPdmVyZmxvd1Njcm9sbChfdGFyZ2V0KSlcbiAgICByZXR1cm4gZmFsc2U7XG4gIGlmIChlLnRvdWNoZXMubGVuZ3RoID4gMSlcbiAgICByZXR1cm4gdHJ1ZTtcbiAgaWYgKGUucHJldmVudERlZmF1bHQpXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICByZXR1cm4gZmFsc2U7XG59XG5jb25zdCBlbEluaXRpYWxPdmVyZmxvdyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpO1xuZnVuY3Rpb24gdXNlU2Nyb2xsTG9jayhlbGVtZW50LCBpbml0aWFsU3RhdGUgPSBmYWxzZSkge1xuICBjb25zdCBpc0xvY2tlZCA9IHNoYWxsb3dSZWYoaW5pdGlhbFN0YXRlKTtcbiAgbGV0IHN0b3BUb3VjaE1vdmVMaXN0ZW5lciA9IG51bGw7XG4gIGxldCBpbml0aWFsT3ZlcmZsb3cgPSBcIlwiO1xuICB3YXRjaCh0b1JlZihlbGVtZW50KSwgKGVsKSA9PiB7XG4gICAgY29uc3QgdGFyZ2V0ID0gcmVzb2x2ZUVsZW1lbnQodG9WYWx1ZShlbCkpO1xuICAgIGlmICh0YXJnZXQpIHtcbiAgICAgIGNvbnN0IGVsZSA9IHRhcmdldDtcbiAgICAgIGlmICghZWxJbml0aWFsT3ZlcmZsb3cuZ2V0KGVsZSkpXG4gICAgICAgIGVsSW5pdGlhbE92ZXJmbG93LnNldChlbGUsIGVsZS5zdHlsZS5vdmVyZmxvdyk7XG4gICAgICBpZiAoZWxlLnN0eWxlLm92ZXJmbG93ICE9PSBcImhpZGRlblwiKVxuICAgICAgICBpbml0aWFsT3ZlcmZsb3cgPSBlbGUuc3R5bGUub3ZlcmZsb3c7XG4gICAgICBpZiAoZWxlLnN0eWxlLm92ZXJmbG93ID09PSBcImhpZGRlblwiKVxuICAgICAgICByZXR1cm4gaXNMb2NrZWQudmFsdWUgPSB0cnVlO1xuICAgICAgaWYgKGlzTG9ja2VkLnZhbHVlKVxuICAgICAgICByZXR1cm4gZWxlLnN0eWxlLm92ZXJmbG93ID0gXCJoaWRkZW5cIjtcbiAgICB9XG4gIH0sIHtcbiAgICBpbW1lZGlhdGU6IHRydWVcbiAgfSk7XG4gIGNvbnN0IGxvY2sgPSAoKSA9PiB7XG4gICAgY29uc3QgZWwgPSByZXNvbHZlRWxlbWVudCh0b1ZhbHVlKGVsZW1lbnQpKTtcbiAgICBpZiAoIWVsIHx8IGlzTG9ja2VkLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIGlmIChpc0lPUykge1xuICAgICAgc3RvcFRvdWNoTW92ZUxpc3RlbmVyID0gdXNlRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgZWwsXG4gICAgICAgIFwidG91Y2htb3ZlXCIsXG4gICAgICAgIChlKSA9PiB7XG4gICAgICAgICAgcHJldmVudERlZmF1bHQoZSk7XG4gICAgICAgIH0sXG4gICAgICAgIHsgcGFzc2l2ZTogZmFsc2UgfVxuICAgICAgKTtcbiAgICB9XG4gICAgZWwuc3R5bGUub3ZlcmZsb3cgPSBcImhpZGRlblwiO1xuICAgIGlzTG9ja2VkLnZhbHVlID0gdHJ1ZTtcbiAgfTtcbiAgY29uc3QgdW5sb2NrID0gKCkgPT4ge1xuICAgIGNvbnN0IGVsID0gcmVzb2x2ZUVsZW1lbnQodG9WYWx1ZShlbGVtZW50KSk7XG4gICAgaWYgKCFlbCB8fCAhaXNMb2NrZWQudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgaWYgKGlzSU9TKVxuICAgICAgc3RvcFRvdWNoTW92ZUxpc3RlbmVyID09IG51bGwgPyB2b2lkIDAgOiBzdG9wVG91Y2hNb3ZlTGlzdGVuZXIoKTtcbiAgICBlbC5zdHlsZS5vdmVyZmxvdyA9IGluaXRpYWxPdmVyZmxvdztcbiAgICBlbEluaXRpYWxPdmVyZmxvdy5kZWxldGUoZWwpO1xuICAgIGlzTG9ja2VkLnZhbHVlID0gZmFsc2U7XG4gIH07XG4gIHRyeU9uU2NvcGVEaXNwb3NlKHVubG9jayk7XG4gIHJldHVybiBjb21wdXRlZCh7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGlzTG9ja2VkLnZhbHVlO1xuICAgIH0sXG4gICAgc2V0KHYpIHtcbiAgICAgIGlmICh2KVxuICAgICAgICBsb2NrKCk7XG4gICAgICBlbHNlIHVubG9jaygpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHVzZVNlc3Npb25TdG9yYWdlKGtleSwgaW5pdGlhbFZhbHVlLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyB3aW5kb3cgPSBkZWZhdWx0V2luZG93IH0gPSBvcHRpb25zO1xuICByZXR1cm4gdXNlU3RvcmFnZShrZXksIGluaXRpYWxWYWx1ZSwgd2luZG93ID09IG51bGwgPyB2b2lkIDAgOiB3aW5kb3cuc2Vzc2lvblN0b3JhZ2UsIG9wdGlvbnMpO1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlU2hhcmUoc2hhcmVPcHRpb25zID0ge30sIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7IG5hdmlnYXRvciA9IGRlZmF1bHROYXZpZ2F0b3IgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IF9uYXZpZ2F0b3IgPSBuYXZpZ2F0b3I7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IF9uYXZpZ2F0b3IgJiYgXCJjYW5TaGFyZVwiIGluIF9uYXZpZ2F0b3IpO1xuICBjb25zdCBzaGFyZSA9IGFzeW5jIChvdmVycmlkZU9wdGlvbnMgPSB7fSkgPT4ge1xuICAgIGlmIChpc1N1cHBvcnRlZC52YWx1ZSkge1xuICAgICAgY29uc3QgZGF0YSA9IHtcbiAgICAgICAgLi4udG9WYWx1ZShzaGFyZU9wdGlvbnMpLFxuICAgICAgICAuLi50b1ZhbHVlKG92ZXJyaWRlT3B0aW9ucylcbiAgICAgIH07XG4gICAgICBsZXQgZ3JhbnRlZCA9IHRydWU7XG4gICAgICBpZiAoZGF0YS5maWxlcyAmJiBfbmF2aWdhdG9yLmNhblNoYXJlKVxuICAgICAgICBncmFudGVkID0gX25hdmlnYXRvci5jYW5TaGFyZSh7IGZpbGVzOiBkYXRhLmZpbGVzIH0pO1xuICAgICAgaWYgKGdyYW50ZWQpXG4gICAgICAgIHJldHVybiBfbmF2aWdhdG9yLnNoYXJlKGRhdGEpO1xuICAgIH1cbiAgfTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBzaGFyZVxuICB9O1xufVxuXG5jb25zdCBkZWZhdWx0U29ydEZuID0gKHNvdXJjZSwgY29tcGFyZUZuKSA9PiBzb3VyY2Uuc29ydChjb21wYXJlRm4pO1xuY29uc3QgZGVmYXVsdENvbXBhcmUgPSAoYSwgYikgPT4gYSAtIGI7XG5mdW5jdGlvbiB1c2VTb3J0ZWQoLi4uYXJncykge1xuICB2YXIgX2EsIF9iLCBfYywgX2Q7XG4gIGNvbnN0IFtzb3VyY2VdID0gYXJncztcbiAgbGV0IGNvbXBhcmVGbiA9IGRlZmF1bHRDb21wYXJlO1xuICBsZXQgb3B0aW9ucyA9IHt9O1xuICBpZiAoYXJncy5sZW5ndGggPT09IDIpIHtcbiAgICBpZiAodHlwZW9mIGFyZ3NbMV0gPT09IFwib2JqZWN0XCIpIHtcbiAgICAgIG9wdGlvbnMgPSBhcmdzWzFdO1xuICAgICAgY29tcGFyZUZuID0gKF9hID0gb3B0aW9ucy5jb21wYXJlRm4pICE9IG51bGwgPyBfYSA6IGRlZmF1bHRDb21wYXJlO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb21wYXJlRm4gPSAoX2IgPSBhcmdzWzFdKSAhPSBudWxsID8gX2IgOiBkZWZhdWx0Q29tcGFyZTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoYXJncy5sZW5ndGggPiAyKSB7XG4gICAgY29tcGFyZUZuID0gKF9jID0gYXJnc1sxXSkgIT0gbnVsbCA/IF9jIDogZGVmYXVsdENvbXBhcmU7XG4gICAgb3B0aW9ucyA9IChfZCA9IGFyZ3NbMl0pICE9IG51bGwgPyBfZCA6IHt9O1xuICB9XG4gIGNvbnN0IHtcbiAgICBkaXJ0eSA9IGZhbHNlLFxuICAgIHNvcnRGbiA9IGRlZmF1bHRTb3J0Rm5cbiAgfSA9IG9wdGlvbnM7XG4gIGlmICghZGlydHkpXG4gICAgcmV0dXJuIGNvbXB1dGVkKCgpID0+IHNvcnRGbihbLi4udG9WYWx1ZShzb3VyY2UpXSwgY29tcGFyZUZuKSk7XG4gIHdhdGNoRWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCByZXN1bHQgPSBzb3J0Rm4odG9WYWx1ZShzb3VyY2UpLCBjb21wYXJlRm4pO1xuICAgIGlmIChpc1JlZihzb3VyY2UpKVxuICAgICAgc291cmNlLnZhbHVlID0gcmVzdWx0O1xuICAgIGVsc2VcbiAgICAgIHNvdXJjZS5zcGxpY2UoMCwgc291cmNlLmxlbmd0aCwgLi4ucmVzdWx0KTtcbiAgfSk7XG4gIHJldHVybiBzb3VyY2U7XG59XG5cbmZ1bmN0aW9uIHVzZVNwZWVjaFJlY29nbml0aW9uKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgaW50ZXJpbVJlc3VsdHMgPSB0cnVlLFxuICAgIGNvbnRpbnVvdXMgPSB0cnVlLFxuICAgIG1heEFsdGVybmF0aXZlcyA9IDEsXG4gICAgd2luZG93ID0gZGVmYXVsdFdpbmRvd1xuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgbGFuZyA9IHRvUmVmKG9wdGlvbnMubGFuZyB8fCBcImVuLVVTXCIpO1xuICBjb25zdCBpc0xpc3RlbmluZyA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBpc0ZpbmFsID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IHJlc3VsdCA9IHNoYWxsb3dSZWYoXCJcIik7XG4gIGNvbnN0IGVycm9yID0gc2hhbGxvd1JlZih2b2lkIDApO1xuICBsZXQgcmVjb2duaXRpb247XG4gIGNvbnN0IHN0YXJ0ID0gKCkgPT4ge1xuICAgIGlzTGlzdGVuaW5nLnZhbHVlID0gdHJ1ZTtcbiAgfTtcbiAgY29uc3Qgc3RvcCA9ICgpID0+IHtcbiAgICBpc0xpc3RlbmluZy52YWx1ZSA9IGZhbHNlO1xuICB9O1xuICBjb25zdCB0b2dnbGUgPSAodmFsdWUgPSAhaXNMaXN0ZW5pbmcudmFsdWUpID0+IHtcbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHN0YXJ0KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0b3AoKTtcbiAgICB9XG4gIH07XG4gIGNvbnN0IFNwZWVjaFJlY29nbml0aW9uID0gd2luZG93ICYmICh3aW5kb3cuU3BlZWNoUmVjb2duaXRpb24gfHwgd2luZG93LndlYmtpdFNwZWVjaFJlY29nbml0aW9uKTtcbiAgY29uc3QgaXNTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gU3BlZWNoUmVjb2duaXRpb24pO1xuICBpZiAoaXNTdXBwb3J0ZWQudmFsdWUpIHtcbiAgICByZWNvZ25pdGlvbiA9IG5ldyBTcGVlY2hSZWNvZ25pdGlvbigpO1xuICAgIHJlY29nbml0aW9uLmNvbnRpbnVvdXMgPSBjb250aW51b3VzO1xuICAgIHJlY29nbml0aW9uLmludGVyaW1SZXN1bHRzID0gaW50ZXJpbVJlc3VsdHM7XG4gICAgcmVjb2duaXRpb24ubGFuZyA9IHRvVmFsdWUobGFuZyk7XG4gICAgcmVjb2duaXRpb24ubWF4QWx0ZXJuYXRpdmVzID0gbWF4QWx0ZXJuYXRpdmVzO1xuICAgIHJlY29nbml0aW9uLm9uc3RhcnQgPSAoKSA9PiB7XG4gICAgICBpc0xpc3RlbmluZy52YWx1ZSA9IHRydWU7XG4gICAgICBpc0ZpbmFsLnZhbHVlID0gZmFsc2U7XG4gICAgfTtcbiAgICB3YXRjaChsYW5nLCAobGFuZzIpID0+IHtcbiAgICAgIGlmIChyZWNvZ25pdGlvbiAmJiAhaXNMaXN0ZW5pbmcudmFsdWUpXG4gICAgICAgIHJlY29nbml0aW9uLmxhbmcgPSBsYW5nMjtcbiAgICB9KTtcbiAgICByZWNvZ25pdGlvbi5vbnJlc3VsdCA9IChldmVudCkgPT4ge1xuICAgICAgY29uc3QgY3VycmVudFJlc3VsdCA9IGV2ZW50LnJlc3VsdHNbZXZlbnQucmVzdWx0SW5kZXhdO1xuICAgICAgY29uc3QgeyB0cmFuc2NyaXB0IH0gPSBjdXJyZW50UmVzdWx0WzBdO1xuICAgICAgaXNGaW5hbC52YWx1ZSA9IGN1cnJlbnRSZXN1bHQuaXNGaW5hbDtcbiAgICAgIHJlc3VsdC52YWx1ZSA9IHRyYW5zY3JpcHQ7XG4gICAgICBlcnJvci52YWx1ZSA9IHZvaWQgMDtcbiAgICB9O1xuICAgIHJlY29nbml0aW9uLm9uZXJyb3IgPSAoZXZlbnQpID0+IHtcbiAgICAgIGVycm9yLnZhbHVlID0gZXZlbnQ7XG4gICAgfTtcbiAgICByZWNvZ25pdGlvbi5vbmVuZCA9ICgpID0+IHtcbiAgICAgIGlzTGlzdGVuaW5nLnZhbHVlID0gZmFsc2U7XG4gICAgICByZWNvZ25pdGlvbi5sYW5nID0gdG9WYWx1ZShsYW5nKTtcbiAgICB9O1xuICAgIHdhdGNoKGlzTGlzdGVuaW5nLCAobmV3VmFsdWUsIG9sZFZhbHVlKSA9PiB7XG4gICAgICBpZiAobmV3VmFsdWUgPT09IG9sZFZhbHVlKVxuICAgICAgICByZXR1cm47XG4gICAgICBpZiAobmV3VmFsdWUpXG4gICAgICAgIHJlY29nbml0aW9uLnN0YXJ0KCk7XG4gICAgICBlbHNlXG4gICAgICAgIHJlY29nbml0aW9uLnN0b3AoKTtcbiAgICB9KTtcbiAgfVxuICB0cnlPblNjb3BlRGlzcG9zZSgoKSA9PiB7XG4gICAgc3RvcCgpO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBpc0xpc3RlbmluZyxcbiAgICBpc0ZpbmFsLFxuICAgIHJlY29nbml0aW9uLFxuICAgIHJlc3VsdCxcbiAgICBlcnJvcixcbiAgICB0b2dnbGUsXG4gICAgc3RhcnQsXG4gICAgc3RvcFxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VTcGVlY2hTeW50aGVzaXModGV4dCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBwaXRjaCA9IDEsXG4gICAgcmF0ZSA9IDEsXG4gICAgdm9sdW1lID0gMSxcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93LFxuICAgIG9uQm91bmRhcnlcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHN5bnRoID0gd2luZG93ICYmIHdpbmRvdy5zcGVlY2hTeW50aGVzaXM7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHN5bnRoKTtcbiAgY29uc3QgaXNQbGF5aW5nID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGNvbnN0IHN0YXR1cyA9IHNoYWxsb3dSZWYoXCJpbml0XCIpO1xuICBjb25zdCBzcG9rZW5UZXh0ID0gdG9SZWYodGV4dCB8fCBcIlwiKTtcbiAgY29uc3QgbGFuZyA9IHRvUmVmKG9wdGlvbnMubGFuZyB8fCBcImVuLVVTXCIpO1xuICBjb25zdCBlcnJvciA9IHNoYWxsb3dSZWYodm9pZCAwKTtcbiAgY29uc3QgdG9nZ2xlID0gKHZhbHVlID0gIWlzUGxheWluZy52YWx1ZSkgPT4ge1xuICAgIGlzUGxheWluZy52YWx1ZSA9IHZhbHVlO1xuICB9O1xuICBjb25zdCBiaW5kRXZlbnRzRm9yVXR0ZXJhbmNlID0gKHV0dGVyYW5jZTIpID0+IHtcbiAgICB1dHRlcmFuY2UyLmxhbmcgPSB0b1ZhbHVlKGxhbmcpO1xuICAgIHV0dGVyYW5jZTIudm9pY2UgPSB0b1ZhbHVlKG9wdGlvbnMudm9pY2UpIHx8IG51bGw7XG4gICAgdXR0ZXJhbmNlMi5waXRjaCA9IHRvVmFsdWUocGl0Y2gpO1xuICAgIHV0dGVyYW5jZTIucmF0ZSA9IHRvVmFsdWUocmF0ZSk7XG4gICAgdXR0ZXJhbmNlMi52b2x1bWUgPSB0b1ZhbHVlKHZvbHVtZSk7XG4gICAgdXR0ZXJhbmNlMi5vbnN0YXJ0ID0gKCkgPT4ge1xuICAgICAgaXNQbGF5aW5nLnZhbHVlID0gdHJ1ZTtcbiAgICAgIHN0YXR1cy52YWx1ZSA9IFwicGxheVwiO1xuICAgIH07XG4gICAgdXR0ZXJhbmNlMi5vbnBhdXNlID0gKCkgPT4ge1xuICAgICAgaXNQbGF5aW5nLnZhbHVlID0gZmFsc2U7XG4gICAgICBzdGF0dXMudmFsdWUgPSBcInBhdXNlXCI7XG4gICAgfTtcbiAgICB1dHRlcmFuY2UyLm9ucmVzdW1lID0gKCkgPT4ge1xuICAgICAgaXNQbGF5aW5nLnZhbHVlID0gdHJ1ZTtcbiAgICAgIHN0YXR1cy52YWx1ZSA9IFwicGxheVwiO1xuICAgIH07XG4gICAgdXR0ZXJhbmNlMi5vbmVuZCA9ICgpID0+IHtcbiAgICAgIGlzUGxheWluZy52YWx1ZSA9IGZhbHNlO1xuICAgICAgc3RhdHVzLnZhbHVlID0gXCJlbmRcIjtcbiAgICB9O1xuICAgIHV0dGVyYW5jZTIub25lcnJvciA9IChldmVudCkgPT4ge1xuICAgICAgZXJyb3IudmFsdWUgPSBldmVudDtcbiAgICB9O1xuICAgIHV0dGVyYW5jZTIub25ib3VuZGFyeSA9IChldmVudCkgPT4ge1xuICAgICAgb25Cb3VuZGFyeSA9PSBudWxsID8gdm9pZCAwIDogb25Cb3VuZGFyeShldmVudCk7XG4gICAgfTtcbiAgfTtcbiAgY29uc3QgdXR0ZXJhbmNlID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGlzUGxheWluZy52YWx1ZSA9IGZhbHNlO1xuICAgIHN0YXR1cy52YWx1ZSA9IFwiaW5pdFwiO1xuICAgIGNvbnN0IG5ld1V0dGVyYW5jZSA9IG5ldyBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2Uoc3Bva2VuVGV4dC52YWx1ZSk7XG4gICAgYmluZEV2ZW50c0ZvclV0dGVyYW5jZShuZXdVdHRlcmFuY2UpO1xuICAgIHJldHVybiBuZXdVdHRlcmFuY2U7XG4gIH0pO1xuICBjb25zdCBzcGVhayA9ICgpID0+IHtcbiAgICBzeW50aC5jYW5jZWwoKTtcbiAgICBpZiAodXR0ZXJhbmNlKVxuICAgICAgc3ludGguc3BlYWsodXR0ZXJhbmNlLnZhbHVlKTtcbiAgfTtcbiAgY29uc3Qgc3RvcCA9ICgpID0+IHtcbiAgICBzeW50aC5jYW5jZWwoKTtcbiAgICBpc1BsYXlpbmcudmFsdWUgPSBmYWxzZTtcbiAgfTtcbiAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlKSB7XG4gICAgYmluZEV2ZW50c0ZvclV0dGVyYW5jZSh1dHRlcmFuY2UudmFsdWUpO1xuICAgIHdhdGNoKGxhbmcsIChsYW5nMikgPT4ge1xuICAgICAgaWYgKHV0dGVyYW5jZS52YWx1ZSAmJiAhaXNQbGF5aW5nLnZhbHVlKVxuICAgICAgICB1dHRlcmFuY2UudmFsdWUubGFuZyA9IGxhbmcyO1xuICAgIH0pO1xuICAgIGlmIChvcHRpb25zLnZvaWNlKSB7XG4gICAgICB3YXRjaChvcHRpb25zLnZvaWNlLCAoKSA9PiB7XG4gICAgICAgIHN5bnRoLmNhbmNlbCgpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHdhdGNoKGlzUGxheWluZywgKCkgPT4ge1xuICAgICAgaWYgKGlzUGxheWluZy52YWx1ZSlcbiAgICAgICAgc3ludGgucmVzdW1lKCk7XG4gICAgICBlbHNlXG4gICAgICAgIHN5bnRoLnBhdXNlKCk7XG4gICAgfSk7XG4gIH1cbiAgdHJ5T25TY29wZURpc3Bvc2UoKCkgPT4ge1xuICAgIGlzUGxheWluZy52YWx1ZSA9IGZhbHNlO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBpc1BsYXlpbmcsXG4gICAgc3RhdHVzLFxuICAgIHV0dGVyYW5jZSxcbiAgICBlcnJvcixcbiAgICBzdG9wLFxuICAgIHRvZ2dsZSxcbiAgICBzcGVha1xuICB9O1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlU3RlcHBlcihzdGVwcywgaW5pdGlhbFN0ZXApIHtcbiAgY29uc3Qgc3RlcHNSZWYgPSByZWYoc3RlcHMpO1xuICBjb25zdCBzdGVwTmFtZXMgPSBjb21wdXRlZCgoKSA9PiBBcnJheS5pc0FycmF5KHN0ZXBzUmVmLnZhbHVlKSA/IHN0ZXBzUmVmLnZhbHVlIDogT2JqZWN0LmtleXMoc3RlcHNSZWYudmFsdWUpKTtcbiAgY29uc3QgaW5kZXggPSByZWYoc3RlcE5hbWVzLnZhbHVlLmluZGV4T2YoaW5pdGlhbFN0ZXAgIT0gbnVsbCA/IGluaXRpYWxTdGVwIDogc3RlcE5hbWVzLnZhbHVlWzBdKSk7XG4gIGNvbnN0IGN1cnJlbnQgPSBjb21wdXRlZCgoKSA9PiBhdChpbmRleC52YWx1ZSkpO1xuICBjb25zdCBpc0ZpcnN0ID0gY29tcHV0ZWQoKCkgPT4gaW5kZXgudmFsdWUgPT09IDApO1xuICBjb25zdCBpc0xhc3QgPSBjb21wdXRlZCgoKSA9PiBpbmRleC52YWx1ZSA9PT0gc3RlcE5hbWVzLnZhbHVlLmxlbmd0aCAtIDEpO1xuICBjb25zdCBuZXh0ID0gY29tcHV0ZWQoKCkgPT4gc3RlcE5hbWVzLnZhbHVlW2luZGV4LnZhbHVlICsgMV0pO1xuICBjb25zdCBwcmV2aW91cyA9IGNvbXB1dGVkKCgpID0+IHN0ZXBOYW1lcy52YWx1ZVtpbmRleC52YWx1ZSAtIDFdKTtcbiAgZnVuY3Rpb24gYXQoaW5kZXgyKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoc3RlcHNSZWYudmFsdWUpKVxuICAgICAgcmV0dXJuIHN0ZXBzUmVmLnZhbHVlW2luZGV4Ml07XG4gICAgcmV0dXJuIHN0ZXBzUmVmLnZhbHVlW3N0ZXBOYW1lcy52YWx1ZVtpbmRleDJdXTtcbiAgfVxuICBmdW5jdGlvbiBnZXQoc3RlcCkge1xuICAgIGlmICghc3RlcE5hbWVzLnZhbHVlLmluY2x1ZGVzKHN0ZXApKVxuICAgICAgcmV0dXJuO1xuICAgIHJldHVybiBhdChzdGVwTmFtZXMudmFsdWUuaW5kZXhPZihzdGVwKSk7XG4gIH1cbiAgZnVuY3Rpb24gZ29UbyhzdGVwKSB7XG4gICAgaWYgKHN0ZXBOYW1lcy52YWx1ZS5pbmNsdWRlcyhzdGVwKSlcbiAgICAgIGluZGV4LnZhbHVlID0gc3RlcE5hbWVzLnZhbHVlLmluZGV4T2Yoc3RlcCk7XG4gIH1cbiAgZnVuY3Rpb24gZ29Ub05leHQoKSB7XG4gICAgaWYgKGlzTGFzdC52YWx1ZSlcbiAgICAgIHJldHVybjtcbiAgICBpbmRleC52YWx1ZSsrO1xuICB9XG4gIGZ1bmN0aW9uIGdvVG9QcmV2aW91cygpIHtcbiAgICBpZiAoaXNGaXJzdC52YWx1ZSlcbiAgICAgIHJldHVybjtcbiAgICBpbmRleC52YWx1ZS0tO1xuICB9XG4gIGZ1bmN0aW9uIGdvQmFja1RvKHN0ZXApIHtcbiAgICBpZiAoaXNBZnRlcihzdGVwKSlcbiAgICAgIGdvVG8oc3RlcCk7XG4gIH1cbiAgZnVuY3Rpb24gaXNOZXh0KHN0ZXApIHtcbiAgICByZXR1cm4gc3RlcE5hbWVzLnZhbHVlLmluZGV4T2Yoc3RlcCkgPT09IGluZGV4LnZhbHVlICsgMTtcbiAgfVxuICBmdW5jdGlvbiBpc1ByZXZpb3VzKHN0ZXApIHtcbiAgICByZXR1cm4gc3RlcE5hbWVzLnZhbHVlLmluZGV4T2Yoc3RlcCkgPT09IGluZGV4LnZhbHVlIC0gMTtcbiAgfVxuICBmdW5jdGlvbiBpc0N1cnJlbnQoc3RlcCkge1xuICAgIHJldHVybiBzdGVwTmFtZXMudmFsdWUuaW5kZXhPZihzdGVwKSA9PT0gaW5kZXgudmFsdWU7XG4gIH1cbiAgZnVuY3Rpb24gaXNCZWZvcmUoc3RlcCkge1xuICAgIHJldHVybiBpbmRleC52YWx1ZSA8IHN0ZXBOYW1lcy52YWx1ZS5pbmRleE9mKHN0ZXApO1xuICB9XG4gIGZ1bmN0aW9uIGlzQWZ0ZXIoc3RlcCkge1xuICAgIHJldHVybiBpbmRleC52YWx1ZSA+IHN0ZXBOYW1lcy52YWx1ZS5pbmRleE9mKHN0ZXApO1xuICB9XG4gIHJldHVybiB7XG4gICAgc3RlcHM6IHN0ZXBzUmVmLFxuICAgIHN0ZXBOYW1lcyxcbiAgICBpbmRleCxcbiAgICBjdXJyZW50LFxuICAgIG5leHQsXG4gICAgcHJldmlvdXMsXG4gICAgaXNGaXJzdCxcbiAgICBpc0xhc3QsXG4gICAgYXQsXG4gICAgZ2V0LFxuICAgIGdvVG8sXG4gICAgZ29Ub05leHQsXG4gICAgZ29Ub1ByZXZpb3VzLFxuICAgIGdvQmFja1RvLFxuICAgIGlzTmV4dCxcbiAgICBpc1ByZXZpb3VzLFxuICAgIGlzQ3VycmVudCxcbiAgICBpc0JlZm9yZSxcbiAgICBpc0FmdGVyXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZVN0b3JhZ2VBc3luYyhrZXksIGluaXRpYWxWYWx1ZSwgc3RvcmFnZSwgb3B0aW9ucyA9IHt9KSB7XG4gIHZhciBfYTtcbiAgY29uc3Qge1xuICAgIGZsdXNoID0gXCJwcmVcIixcbiAgICBkZWVwID0gdHJ1ZSxcbiAgICBsaXN0ZW5Ub1N0b3JhZ2VDaGFuZ2VzID0gdHJ1ZSxcbiAgICB3cml0ZURlZmF1bHRzID0gdHJ1ZSxcbiAgICBtZXJnZURlZmF1bHRzID0gZmFsc2UsXG4gICAgc2hhbGxvdyxcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93LFxuICAgIGV2ZW50RmlsdGVyLFxuICAgIG9uRXJyb3IgPSAoZSkgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICB9LFxuICAgIG9uUmVhZHlcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHJhd0luaXQgPSB0b1ZhbHVlKGluaXRpYWxWYWx1ZSk7XG4gIGNvbnN0IHR5cGUgPSBndWVzc1NlcmlhbGl6ZXJUeXBlKHJhd0luaXQpO1xuICBjb25zdCBkYXRhID0gKHNoYWxsb3cgPyBzaGFsbG93UmVmIDogcmVmKSh0b1ZhbHVlKGluaXRpYWxWYWx1ZSkpO1xuICBjb25zdCBzZXJpYWxpemVyID0gKF9hID0gb3B0aW9ucy5zZXJpYWxpemVyKSAhPSBudWxsID8gX2EgOiBTdG9yYWdlU2VyaWFsaXplcnNbdHlwZV07XG4gIGlmICghc3RvcmFnZSkge1xuICAgIHRyeSB7XG4gICAgICBzdG9yYWdlID0gZ2V0U1NSSGFuZGxlcihcImdldERlZmF1bHRTdG9yYWdlQXN5bmNcIiwgKCkgPT4ge1xuICAgICAgICB2YXIgX2EyO1xuICAgICAgICByZXR1cm4gKF9hMiA9IGRlZmF1bHRXaW5kb3cpID09IG51bGwgPyB2b2lkIDAgOiBfYTIubG9jYWxTdG9yYWdlO1xuICAgICAgfSkoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBvbkVycm9yKGUpO1xuICAgIH1cbiAgfVxuICBhc3luYyBmdW5jdGlvbiByZWFkKGV2ZW50KSB7XG4gICAgaWYgKCFzdG9yYWdlIHx8IGV2ZW50ICYmIGV2ZW50LmtleSAhPT0ga2V5KVxuICAgICAgcmV0dXJuO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByYXdWYWx1ZSA9IGV2ZW50ID8gZXZlbnQubmV3VmFsdWUgOiBhd2FpdCBzdG9yYWdlLmdldEl0ZW0oa2V5KTtcbiAgICAgIGlmIChyYXdWYWx1ZSA9PSBudWxsKSB7XG4gICAgICAgIGRhdGEudmFsdWUgPSByYXdJbml0O1xuICAgICAgICBpZiAod3JpdGVEZWZhdWx0cyAmJiByYXdJbml0ICE9PSBudWxsKVxuICAgICAgICAgIGF3YWl0IHN0b3JhZ2Uuc2V0SXRlbShrZXksIGF3YWl0IHNlcmlhbGl6ZXIud3JpdGUocmF3SW5pdCkpO1xuICAgICAgfSBlbHNlIGlmIChtZXJnZURlZmF1bHRzKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgc2VyaWFsaXplci5yZWFkKHJhd1ZhbHVlKTtcbiAgICAgICAgaWYgKHR5cGVvZiBtZXJnZURlZmF1bHRzID09PSBcImZ1bmN0aW9uXCIpXG4gICAgICAgICAgZGF0YS52YWx1ZSA9IG1lcmdlRGVmYXVsdHModmFsdWUsIHJhd0luaXQpO1xuICAgICAgICBlbHNlIGlmICh0eXBlID09PSBcIm9iamVjdFwiICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSlcbiAgICAgICAgICBkYXRhLnZhbHVlID0geyAuLi5yYXdJbml0LCAuLi52YWx1ZSB9O1xuICAgICAgICBlbHNlIGRhdGEudmFsdWUgPSB2YWx1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGEudmFsdWUgPSBhd2FpdCBzZXJpYWxpemVyLnJlYWQocmF3VmFsdWUpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIG9uRXJyb3IoZSk7XG4gICAgfVxuICB9XG4gIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIHJlYWQoKS50aGVuKCgpID0+IHtcbiAgICAgIG9uUmVhZHkgPT0gbnVsbCA/IHZvaWQgMCA6IG9uUmVhZHkoZGF0YS52YWx1ZSk7XG4gICAgICByZXNvbHZlKGRhdGEpO1xuICAgIH0pO1xuICB9KTtcbiAgaWYgKHdpbmRvdyAmJiBsaXN0ZW5Ub1N0b3JhZ2VDaGFuZ2VzKVxuICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcInN0b3JhZ2VcIiwgKGUpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gcmVhZChlKSksIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcbiAgaWYgKHN0b3JhZ2UpIHtcbiAgICB3YXRjaFdpdGhGaWx0ZXIoXG4gICAgICBkYXRhLFxuICAgICAgYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmIChkYXRhLnZhbHVlID09IG51bGwpXG4gICAgICAgICAgICBhd2FpdCBzdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTtcbiAgICAgICAgICBlbHNlXG4gICAgICAgICAgICBhd2FpdCBzdG9yYWdlLnNldEl0ZW0oa2V5LCBhd2FpdCBzZXJpYWxpemVyLndyaXRlKGRhdGEudmFsdWUpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIG9uRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGZsdXNoLFxuICAgICAgICBkZWVwLFxuICAgICAgICBldmVudEZpbHRlclxuICAgICAgfVxuICAgICk7XG4gIH1cbiAgT2JqZWN0LmFzc2lnbihkYXRhLCB7XG4gICAgdGhlbjogcHJvbWlzZS50aGVuLmJpbmQocHJvbWlzZSksXG4gICAgY2F0Y2g6IHByb21pc2UuY2F0Y2guYmluZChwcm9taXNlKVxuICB9KTtcbiAgcmV0dXJuIGRhdGE7XG59XG5cbmxldCBfaWQgPSAwO1xuZnVuY3Rpb24gdXNlU3R5bGVUYWcoY3NzLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3QgaXNMb2FkZWQgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3Qge1xuICAgIGRvY3VtZW50ID0gZGVmYXVsdERvY3VtZW50LFxuICAgIGltbWVkaWF0ZSA9IHRydWUsXG4gICAgbWFudWFsID0gZmFsc2UsXG4gICAgaWQgPSBgdnVldXNlX3N0eWxldGFnXyR7KytfaWR9YFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgY3NzUmVmID0gc2hhbGxvd1JlZihjc3MpO1xuICBsZXQgc3RvcCA9ICgpID0+IHtcbiAgfTtcbiAgY29uc3QgbG9hZCA9ICgpID0+IHtcbiAgICBpZiAoIWRvY3VtZW50KVxuICAgICAgcmV0dXJuO1xuICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzdHlsZVwiKTtcbiAgICBpZiAoIWVsLmlzQ29ubmVjdGVkKSB7XG4gICAgICBlbC5pZCA9IGlkO1xuICAgICAgaWYgKG9wdGlvbnMubm9uY2UpXG4gICAgICAgIGVsLm5vbmNlID0gb3B0aW9ucy5ub25jZTtcbiAgICAgIGlmIChvcHRpb25zLm1lZGlhKVxuICAgICAgICBlbC5tZWRpYSA9IG9wdGlvbnMubWVkaWE7XG4gICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGVsKTtcbiAgICB9XG4gICAgaWYgKGlzTG9hZGVkLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIHN0b3AgPSB3YXRjaChcbiAgICAgIGNzc1JlZixcbiAgICAgICh2YWx1ZSkgPT4ge1xuICAgICAgICBlbC50ZXh0Q29udGVudCA9IHZhbHVlO1xuICAgICAgfSxcbiAgICAgIHsgaW1tZWRpYXRlOiB0cnVlIH1cbiAgICApO1xuICAgIGlzTG9hZGVkLnZhbHVlID0gdHJ1ZTtcbiAgfTtcbiAgY29uc3QgdW5sb2FkID0gKCkgPT4ge1xuICAgIGlmICghZG9jdW1lbnQgfHwgIWlzTG9hZGVkLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIHN0b3AoKTtcbiAgICBkb2N1bWVudC5oZWFkLnJlbW92ZUNoaWxkKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSk7XG4gICAgaXNMb2FkZWQudmFsdWUgPSBmYWxzZTtcbiAgfTtcbiAgaWYgKGltbWVkaWF0ZSAmJiAhbWFudWFsKVxuICAgIHRyeU9uTW91bnRlZChsb2FkKTtcbiAgaWYgKCFtYW51YWwpXG4gICAgdHJ5T25TY29wZURpc3Bvc2UodW5sb2FkKTtcbiAgcmV0dXJuIHtcbiAgICBpZCxcbiAgICBjc3M6IGNzc1JlZixcbiAgICB1bmxvYWQsXG4gICAgbG9hZCxcbiAgICBpc0xvYWRlZDogcmVhZG9ubHkoaXNMb2FkZWQpXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZVN3aXBlKHRhcmdldCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB0aHJlc2hvbGQgPSA1MCxcbiAgICBvblN3aXBlLFxuICAgIG9uU3dpcGVFbmQsXG4gICAgb25Td2lwZVN0YXJ0LFxuICAgIHBhc3NpdmUgPSB0cnVlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBjb29yZHNTdGFydCA9IHJlYWN0aXZlKHsgeDogMCwgeTogMCB9KTtcbiAgY29uc3QgY29vcmRzRW5kID0gcmVhY3RpdmUoeyB4OiAwLCB5OiAwIH0pO1xuICBjb25zdCBkaWZmWCA9IGNvbXB1dGVkKCgpID0+IGNvb3Jkc1N0YXJ0LnggLSBjb29yZHNFbmQueCk7XG4gIGNvbnN0IGRpZmZZID0gY29tcHV0ZWQoKCkgPT4gY29vcmRzU3RhcnQueSAtIGNvb3Jkc0VuZC55KTtcbiAgY29uc3QgeyBtYXgsIGFicyB9ID0gTWF0aDtcbiAgY29uc3QgaXNUaHJlc2hvbGRFeGNlZWRlZCA9IGNvbXB1dGVkKCgpID0+IG1heChhYnMoZGlmZlgudmFsdWUpLCBhYnMoZGlmZlkudmFsdWUpKSA+PSB0aHJlc2hvbGQpO1xuICBjb25zdCBpc1N3aXBpbmcgPSBzaGFsbG93UmVmKGZhbHNlKTtcbiAgY29uc3QgZGlyZWN0aW9uID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGlmICghaXNUaHJlc2hvbGRFeGNlZWRlZC52YWx1ZSlcbiAgICAgIHJldHVybiBcIm5vbmVcIjtcbiAgICBpZiAoYWJzKGRpZmZYLnZhbHVlKSA+IGFicyhkaWZmWS52YWx1ZSkpIHtcbiAgICAgIHJldHVybiBkaWZmWC52YWx1ZSA+IDAgPyBcImxlZnRcIiA6IFwicmlnaHRcIjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGRpZmZZLnZhbHVlID4gMCA/IFwidXBcIiA6IFwiZG93blwiO1xuICAgIH1cbiAgfSk7XG4gIGNvbnN0IGdldFRvdWNoRXZlbnRDb29yZHMgPSAoZSkgPT4gW2UudG91Y2hlc1swXS5jbGllbnRYLCBlLnRvdWNoZXNbMF0uY2xpZW50WV07XG4gIGNvbnN0IHVwZGF0ZUNvb3Jkc1N0YXJ0ID0gKHgsIHkpID0+IHtcbiAgICBjb29yZHNTdGFydC54ID0geDtcbiAgICBjb29yZHNTdGFydC55ID0geTtcbiAgfTtcbiAgY29uc3QgdXBkYXRlQ29vcmRzRW5kID0gKHgsIHkpID0+IHtcbiAgICBjb29yZHNFbmQueCA9IHg7XG4gICAgY29vcmRzRW5kLnkgPSB5O1xuICB9O1xuICBjb25zdCBsaXN0ZW5lck9wdGlvbnMgPSB7IHBhc3NpdmUsIGNhcHR1cmU6ICFwYXNzaXZlIH07XG4gIGNvbnN0IG9uVG91Y2hFbmQgPSAoZSkgPT4ge1xuICAgIGlmIChpc1N3aXBpbmcudmFsdWUpXG4gICAgICBvblN3aXBlRW5kID09IG51bGwgPyB2b2lkIDAgOiBvblN3aXBlRW5kKGUsIGRpcmVjdGlvbi52YWx1ZSk7XG4gICAgaXNTd2lwaW5nLnZhbHVlID0gZmFsc2U7XG4gIH07XG4gIGNvbnN0IHN0b3BzID0gW1xuICAgIHVzZUV2ZW50TGlzdGVuZXIodGFyZ2V0LCBcInRvdWNoc3RhcnRcIiwgKGUpID0+IHtcbiAgICAgIGlmIChlLnRvdWNoZXMubGVuZ3RoICE9PSAxKVxuICAgICAgICByZXR1cm47XG4gICAgICBjb25zdCBbeCwgeV0gPSBnZXRUb3VjaEV2ZW50Q29vcmRzKGUpO1xuICAgICAgdXBkYXRlQ29vcmRzU3RhcnQoeCwgeSk7XG4gICAgICB1cGRhdGVDb29yZHNFbmQoeCwgeSk7XG4gICAgICBvblN3aXBlU3RhcnQgPT0gbnVsbCA/IHZvaWQgMCA6IG9uU3dpcGVTdGFydChlKTtcbiAgICB9LCBsaXN0ZW5lck9wdGlvbnMpLFxuICAgIHVzZUV2ZW50TGlzdGVuZXIodGFyZ2V0LCBcInRvdWNobW92ZVwiLCAoZSkgPT4ge1xuICAgICAgaWYgKGUudG91Y2hlcy5sZW5ndGggIT09IDEpXG4gICAgICAgIHJldHVybjtcbiAgICAgIGNvbnN0IFt4LCB5XSA9IGdldFRvdWNoRXZlbnRDb29yZHMoZSk7XG4gICAgICB1cGRhdGVDb29yZHNFbmQoeCwgeSk7XG4gICAgICBpZiAobGlzdGVuZXJPcHRpb25zLmNhcHR1cmUgJiYgIWxpc3RlbmVyT3B0aW9ucy5wYXNzaXZlICYmIE1hdGguYWJzKGRpZmZYLnZhbHVlKSA+IE1hdGguYWJzKGRpZmZZLnZhbHVlKSlcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgaWYgKCFpc1N3aXBpbmcudmFsdWUgJiYgaXNUaHJlc2hvbGRFeGNlZWRlZC52YWx1ZSlcbiAgICAgICAgaXNTd2lwaW5nLnZhbHVlID0gdHJ1ZTtcbiAgICAgIGlmIChpc1N3aXBpbmcudmFsdWUpXG4gICAgICAgIG9uU3dpcGUgPT0gbnVsbCA/IHZvaWQgMCA6IG9uU3dpcGUoZSk7XG4gICAgfSwgbGlzdGVuZXJPcHRpb25zKSxcbiAgICB1c2VFdmVudExpc3RlbmVyKHRhcmdldCwgW1widG91Y2hlbmRcIiwgXCJ0b3VjaGNhbmNlbFwiXSwgb25Ub3VjaEVuZCwgbGlzdGVuZXJPcHRpb25zKVxuICBdO1xuICBjb25zdCBzdG9wID0gKCkgPT4gc3RvcHMuZm9yRWFjaCgocykgPT4gcygpKTtcbiAgcmV0dXJuIHtcbiAgICBpc1N3aXBpbmcsXG4gICAgZGlyZWN0aW9uLFxuICAgIGNvb3Jkc1N0YXJ0LFxuICAgIGNvb3Jkc0VuZCxcbiAgICBsZW5ndGhYOiBkaWZmWCxcbiAgICBsZW5ndGhZOiBkaWZmWSxcbiAgICBzdG9wLFxuICAgIC8vIFRPRE86IFJlbW92ZSBpbiB0aGUgbmV4dCBtYWpvciB2ZXJzaW9uXG4gICAgaXNQYXNzaXZlRXZlbnRTdXBwb3J0ZWQ6IHRydWVcbiAgfTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZVRlbXBsYXRlUmVmc0xpc3QoKSB7XG4gIGNvbnN0IHJlZnMgPSByZWYoW10pO1xuICByZWZzLnZhbHVlLnNldCA9IChlbCkgPT4ge1xuICAgIGlmIChlbClcbiAgICAgIHJlZnMudmFsdWUucHVzaChlbCk7XG4gIH07XG4gIG9uQmVmb3JlVXBkYXRlKCgpID0+IHtcbiAgICByZWZzLnZhbHVlLmxlbmd0aCA9IDA7XG4gIH0pO1xuICByZXR1cm4gcmVmcztcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZVRleHREaXJlY3Rpb24ob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBkb2N1bWVudCA9IGRlZmF1bHREb2N1bWVudCxcbiAgICBzZWxlY3RvciA9IFwiaHRtbFwiLFxuICAgIG9ic2VydmUgPSBmYWxzZSxcbiAgICBpbml0aWFsVmFsdWUgPSBcImx0clwiXG4gIH0gPSBvcHRpb25zO1xuICBmdW5jdGlvbiBnZXRWYWx1ZSgpIHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIHJldHVybiAoX2IgPSAoX2EgPSBkb2N1bWVudCA9PSBudWxsID8gdm9pZCAwIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvcikpID09IG51bGwgPyB2b2lkIDAgOiBfYS5nZXRBdHRyaWJ1dGUoXCJkaXJcIikpICE9IG51bGwgPyBfYiA6IGluaXRpYWxWYWx1ZTtcbiAgfVxuICBjb25zdCBkaXIgPSByZWYoZ2V0VmFsdWUoKSk7XG4gIHRyeU9uTW91bnRlZCgoKSA9PiBkaXIudmFsdWUgPSBnZXRWYWx1ZSgpKTtcbiAgaWYgKG9ic2VydmUgJiYgZG9jdW1lbnQpIHtcbiAgICB1c2VNdXRhdGlvbk9ic2VydmVyKFxuICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvciksXG4gICAgICAoKSA9PiBkaXIudmFsdWUgPSBnZXRWYWx1ZSgpLFxuICAgICAgeyBhdHRyaWJ1dGVzOiB0cnVlIH1cbiAgICApO1xuICB9XG4gIHJldHVybiBjb21wdXRlZCh7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGRpci52YWx1ZTtcbiAgICB9LFxuICAgIHNldCh2KSB7XG4gICAgICB2YXIgX2EsIF9iO1xuICAgICAgZGlyLnZhbHVlID0gdjtcbiAgICAgIGlmICghZG9jdW1lbnQpXG4gICAgICAgIHJldHVybjtcbiAgICAgIGlmIChkaXIudmFsdWUpXG4gICAgICAgIChfYSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpKSA9PSBudWxsID8gdm9pZCAwIDogX2Euc2V0QXR0cmlidXRlKFwiZGlyXCIsIGRpci52YWx1ZSk7XG4gICAgICBlbHNlXG4gICAgICAgIChfYiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpKSA9PSBudWxsID8gdm9pZCAwIDogX2IucmVtb3ZlQXR0cmlidXRlKFwiZGlyXCIpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldFJhbmdlc0Zyb21TZWxlY3Rpb24oc2VsZWN0aW9uKSB7XG4gIHZhciBfYTtcbiAgY29uc3QgcmFuZ2VDb3VudCA9IChfYSA9IHNlbGVjdGlvbi5yYW5nZUNvdW50KSAhPSBudWxsID8gX2EgOiAwO1xuICByZXR1cm4gQXJyYXkuZnJvbSh7IGxlbmd0aDogcmFuZ2VDb3VudCB9LCAoXywgaSkgPT4gc2VsZWN0aW9uLmdldFJhbmdlQXQoaSkpO1xufVxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZVRleHRTZWxlY3Rpb24ob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93XG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBzZWxlY3Rpb24gPSByZWYobnVsbCk7XG4gIGNvbnN0IHRleHQgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICByZXR1cm4gKF9iID0gKF9hID0gc2VsZWN0aW9uLnZhbHVlKSA9PSBudWxsID8gdm9pZCAwIDogX2EudG9TdHJpbmcoKSkgIT0gbnVsbCA/IF9iIDogXCJcIjtcbiAgfSk7XG4gIGNvbnN0IHJhbmdlcyA9IGNvbXB1dGVkKCgpID0+IHNlbGVjdGlvbi52YWx1ZSA/IGdldFJhbmdlc0Zyb21TZWxlY3Rpb24oc2VsZWN0aW9uLnZhbHVlKSA6IFtdKTtcbiAgY29uc3QgcmVjdHMgPSBjb21wdXRlZCgoKSA9PiByYW5nZXMudmFsdWUubWFwKChyYW5nZSkgPT4gcmFuZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpKTtcbiAgZnVuY3Rpb24gb25TZWxlY3Rpb25DaGFuZ2UoKSB7XG4gICAgc2VsZWN0aW9uLnZhbHVlID0gbnVsbDtcbiAgICBpZiAod2luZG93KVxuICAgICAgc2VsZWN0aW9uLnZhbHVlID0gd2luZG93LmdldFNlbGVjdGlvbigpO1xuICB9XG4gIGlmICh3aW5kb3cpXG4gICAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3cuZG9jdW1lbnQsIFwic2VsZWN0aW9uY2hhbmdlXCIsIG9uU2VsZWN0aW9uQ2hhbmdlLCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gIHJldHVybiB7XG4gICAgdGV4dCxcbiAgICByZWN0cyxcbiAgICByYW5nZXMsXG4gICAgc2VsZWN0aW9uXG4gIH07XG59XG5cbmZ1bmN0aW9uIHRyeVJlcXVlc3RBbmltYXRpb25GcmFtZSh3aW5kb3cgPSBkZWZhdWx0V2luZG93LCBmbikge1xuICBpZiAod2luZG93ICYmIHR5cGVvZiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZuKTtcbiAgfSBlbHNlIHtcbiAgICBmbigpO1xuICB9XG59XG5mdW5jdGlvbiB1c2VUZXh0YXJlYUF1dG9zaXplKG9wdGlvbnMgPSB7fSkge1xuICB2YXIgX2EsIF9iO1xuICBjb25zdCB7IHdpbmRvdyA9IGRlZmF1bHRXaW5kb3cgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHRleHRhcmVhID0gdG9SZWYob3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5lbGVtZW50KTtcbiAgY29uc3QgaW5wdXQgPSB0b1JlZigoX2EgPSBvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLmlucHV0KSAhPSBudWxsID8gX2EgOiBcIlwiKTtcbiAgY29uc3Qgc3R5bGVQcm9wID0gKF9iID0gb3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5zdHlsZVByb3ApICE9IG51bGwgPyBfYiA6IFwiaGVpZ2h0XCI7XG4gIGNvbnN0IHRleHRhcmVhU2Nyb2xsSGVpZ2h0ID0gc2hhbGxvd1JlZigxKTtcbiAgY29uc3QgdGV4dGFyZWFPbGRXaWR0aCA9IHNoYWxsb3dSZWYoMCk7XG4gIGZ1bmN0aW9uIHRyaWdnZXJSZXNpemUoKSB7XG4gICAgdmFyIF9hMjtcbiAgICBpZiAoIXRleHRhcmVhLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIGxldCBoZWlnaHQgPSBcIlwiO1xuICAgIHRleHRhcmVhLnZhbHVlLnN0eWxlW3N0eWxlUHJvcF0gPSBcIjFweFwiO1xuICAgIHRleHRhcmVhU2Nyb2xsSGVpZ2h0LnZhbHVlID0gKF9hMiA9IHRleHRhcmVhLnZhbHVlKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLnNjcm9sbEhlaWdodDtcbiAgICBjb25zdCBfc3R5bGVUYXJnZXQgPSB0b1ZhbHVlKG9wdGlvbnMgPT0gbnVsbCA/IHZvaWQgMCA6IG9wdGlvbnMuc3R5bGVUYXJnZXQpO1xuICAgIGlmIChfc3R5bGVUYXJnZXQpXG4gICAgICBfc3R5bGVUYXJnZXQuc3R5bGVbc3R5bGVQcm9wXSA9IGAke3RleHRhcmVhU2Nyb2xsSGVpZ2h0LnZhbHVlfXB4YDtcbiAgICBlbHNlXG4gICAgICBoZWlnaHQgPSBgJHt0ZXh0YXJlYVNjcm9sbEhlaWdodC52YWx1ZX1weGA7XG4gICAgdGV4dGFyZWEudmFsdWUuc3R5bGVbc3R5bGVQcm9wXSA9IGhlaWdodDtcbiAgfVxuICB3YXRjaChbaW5wdXQsIHRleHRhcmVhXSwgKCkgPT4gbmV4dFRpY2sodHJpZ2dlclJlc2l6ZSksIHsgaW1tZWRpYXRlOiB0cnVlIH0pO1xuICB3YXRjaCh0ZXh0YXJlYVNjcm9sbEhlaWdodCwgKCkgPT4ge1xuICAgIHZhciBfYTI7XG4gICAgcmV0dXJuIChfYTIgPSBvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLm9uUmVzaXplKSA9PSBudWxsID8gdm9pZCAwIDogX2EyLmNhbGwob3B0aW9ucyk7XG4gIH0pO1xuICB1c2VSZXNpemVPYnNlcnZlcih0ZXh0YXJlYSwgKFt7IGNvbnRlbnRSZWN0IH1dKSA9PiB7XG4gICAgaWYgKHRleHRhcmVhT2xkV2lkdGgudmFsdWUgPT09IGNvbnRlbnRSZWN0LndpZHRoKVxuICAgICAgcmV0dXJuO1xuICAgIHRyeVJlcXVlc3RBbmltYXRpb25GcmFtZSh3aW5kb3csICgpID0+IHtcbiAgICAgIHRleHRhcmVhT2xkV2lkdGgudmFsdWUgPSBjb250ZW50UmVjdC53aWR0aDtcbiAgICAgIHRyaWdnZXJSZXNpemUoKTtcbiAgICB9KTtcbiAgfSk7XG4gIGlmIChvcHRpb25zID09IG51bGwgPyB2b2lkIDAgOiBvcHRpb25zLndhdGNoKVxuICAgIHdhdGNoKG9wdGlvbnMud2F0Y2gsIHRyaWdnZXJSZXNpemUsIHsgaW1tZWRpYXRlOiB0cnVlLCBkZWVwOiB0cnVlIH0pO1xuICByZXR1cm4ge1xuICAgIHRleHRhcmVhLFxuICAgIGlucHV0LFxuICAgIHRyaWdnZXJSZXNpemVcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlVGhyb3R0bGVkUmVmSGlzdG9yeShzb3VyY2UsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7IHRocm90dGxlID0gMjAwLCB0cmFpbGluZyA9IHRydWUgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGZpbHRlciA9IHRocm90dGxlRmlsdGVyKHRocm90dGxlLCB0cmFpbGluZyk7XG4gIGNvbnN0IGhpc3RvcnkgPSB1c2VSZWZIaXN0b3J5KHNvdXJjZSwgeyAuLi5vcHRpb25zLCBldmVudEZpbHRlcjogZmlsdGVyIH0pO1xuICByZXR1cm4ge1xuICAgIC4uLmhpc3RvcnlcbiAgfTtcbn1cblxuY29uc3QgREVGQVVMVF9VTklUUyA9IFtcbiAgeyBtYXg6IDZlNCwgdmFsdWU6IDFlMywgbmFtZTogXCJzZWNvbmRcIiB9LFxuICB7IG1heDogMjc2ZTQsIHZhbHVlOiA2ZTQsIG5hbWU6IFwibWludXRlXCIgfSxcbiAgeyBtYXg6IDcyZTYsIHZhbHVlOiAzNmU1LCBuYW1lOiBcImhvdXJcIiB9LFxuICB7IG1heDogNTE4NGU1LCB2YWx1ZTogODY0ZTUsIG5hbWU6IFwiZGF5XCIgfSxcbiAgeyBtYXg6IDI0MTkyZTUsIHZhbHVlOiA2MDQ4ZTUsIG5hbWU6IFwid2Vla1wiIH0sXG4gIHsgbWF4OiAyODUxMmU2LCB2YWx1ZTogMjU5MmU2LCBuYW1lOiBcIm1vbnRoXCIgfSxcbiAgeyBtYXg6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwgdmFsdWU6IDMxNTM2ZTYsIG5hbWU6IFwieWVhclwiIH1cbl07XG5jb25zdCBERUZBVUxUX01FU1NBR0VTID0ge1xuICBqdXN0Tm93OiBcImp1c3Qgbm93XCIsXG4gIHBhc3Q6IChuKSA9PiBuLm1hdGNoKC9cXGQvKSA/IGAke259IGFnb2AgOiBuLFxuICBmdXR1cmU6IChuKSA9PiBuLm1hdGNoKC9cXGQvKSA/IGBpbiAke259YCA6IG4sXG4gIG1vbnRoOiAobiwgcGFzdCkgPT4gbiA9PT0gMSA/IHBhc3QgPyBcImxhc3QgbW9udGhcIiA6IFwibmV4dCBtb250aFwiIDogYCR7bn0gbW9udGgke24gPiAxID8gXCJzXCIgOiBcIlwifWAsXG4gIHllYXI6IChuLCBwYXN0KSA9PiBuID09PSAxID8gcGFzdCA/IFwibGFzdCB5ZWFyXCIgOiBcIm5leHQgeWVhclwiIDogYCR7bn0geWVhciR7biA+IDEgPyBcInNcIiA6IFwiXCJ9YCxcbiAgZGF5OiAobiwgcGFzdCkgPT4gbiA9PT0gMSA/IHBhc3QgPyBcInllc3RlcmRheVwiIDogXCJ0b21vcnJvd1wiIDogYCR7bn0gZGF5JHtuID4gMSA/IFwic1wiIDogXCJcIn1gLFxuICB3ZWVrOiAobiwgcGFzdCkgPT4gbiA9PT0gMSA/IHBhc3QgPyBcImxhc3Qgd2Vla1wiIDogXCJuZXh0IHdlZWtcIiA6IGAke259IHdlZWske24gPiAxID8gXCJzXCIgOiBcIlwifWAsXG4gIGhvdXI6IChuKSA9PiBgJHtufSBob3VyJHtuID4gMSA/IFwic1wiIDogXCJcIn1gLFxuICBtaW51dGU6IChuKSA9PiBgJHtufSBtaW51dGUke24gPiAxID8gXCJzXCIgOiBcIlwifWAsXG4gIHNlY29uZDogKG4pID0+IGAke259IHNlY29uZCR7biA+IDEgPyBcInNcIiA6IFwiXCJ9YCxcbiAgaW52YWxpZDogXCJcIlxufTtcbmZ1bmN0aW9uIERFRkFVTFRfRk9STUFUVEVSKGRhdGUpIHtcbiAgcmV0dXJuIGRhdGUudG9JU09TdHJpbmcoKS5zbGljZSgwLCAxMCk7XG59XG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlVGltZUFnbyh0aW1lLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGNvbnRyb2xzOiBleHBvc2VDb250cm9scyA9IGZhbHNlLFxuICAgIHVwZGF0ZUludGVydmFsID0gM2U0XG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCB7IG5vdywgLi4uY29udHJvbHMgfSA9IHVzZU5vdyh7IGludGVydmFsOiB1cGRhdGVJbnRlcnZhbCwgY29udHJvbHM6IHRydWUgfSk7XG4gIGNvbnN0IHRpbWVBZ28gPSBjb21wdXRlZCgoKSA9PiBmb3JtYXRUaW1lQWdvKG5ldyBEYXRlKHRvVmFsdWUodGltZSkpLCBvcHRpb25zLCB0b1ZhbHVlKG5vdykpKTtcbiAgaWYgKGV4cG9zZUNvbnRyb2xzKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRpbWVBZ28sXG4gICAgICAuLi5jb250cm9sc1xuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHRpbWVBZ287XG4gIH1cbn1cbmZ1bmN0aW9uIGZvcm1hdFRpbWVBZ28oZnJvbSwgb3B0aW9ucyA9IHt9LCBub3cgPSBEYXRlLm5vdygpKSB7XG4gIHZhciBfYTtcbiAgY29uc3Qge1xuICAgIG1heCxcbiAgICBtZXNzYWdlcyA9IERFRkFVTFRfTUVTU0FHRVMsXG4gICAgZnVsbERhdGVGb3JtYXR0ZXIgPSBERUZBVUxUX0ZPUk1BVFRFUixcbiAgICB1bml0cyA9IERFRkFVTFRfVU5JVFMsXG4gICAgc2hvd1NlY29uZCA9IGZhbHNlLFxuICAgIHJvdW5kaW5nID0gXCJyb3VuZFwiXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCByb3VuZEZuID0gdHlwZW9mIHJvdW5kaW5nID09PSBcIm51bWJlclwiID8gKG4pID0+ICtuLnRvRml4ZWQocm91bmRpbmcpIDogTWF0aFtyb3VuZGluZ107XG4gIGNvbnN0IGRpZmYgPSArbm93IC0gK2Zyb207XG4gIGNvbnN0IGFic0RpZmYgPSBNYXRoLmFicyhkaWZmKTtcbiAgZnVuY3Rpb24gZ2V0VmFsdWUoZGlmZjIsIHVuaXQpIHtcbiAgICByZXR1cm4gcm91bmRGbihNYXRoLmFicyhkaWZmMikgLyB1bml0LnZhbHVlKTtcbiAgfVxuICBmdW5jdGlvbiBmb3JtYXQoZGlmZjIsIHVuaXQpIHtcbiAgICBjb25zdCB2YWwgPSBnZXRWYWx1ZShkaWZmMiwgdW5pdCk7XG4gICAgY29uc3QgcGFzdCA9IGRpZmYyID4gMDtcbiAgICBjb25zdCBzdHIgPSBhcHBseUZvcm1hdCh1bml0Lm5hbWUsIHZhbCwgcGFzdCk7XG4gICAgcmV0dXJuIGFwcGx5Rm9ybWF0KHBhc3QgPyBcInBhc3RcIiA6IFwiZnV0dXJlXCIsIHN0ciwgcGFzdCk7XG4gIH1cbiAgZnVuY3Rpb24gYXBwbHlGb3JtYXQobmFtZSwgdmFsLCBpc1Bhc3QpIHtcbiAgICBjb25zdCBmb3JtYXR0ZXIgPSBtZXNzYWdlc1tuYW1lXTtcbiAgICBpZiAodHlwZW9mIGZvcm1hdHRlciA9PT0gXCJmdW5jdGlvblwiKVxuICAgICAgcmV0dXJuIGZvcm1hdHRlcih2YWwsIGlzUGFzdCk7XG4gICAgcmV0dXJuIGZvcm1hdHRlci5yZXBsYWNlKFwiezB9XCIsIHZhbC50b1N0cmluZygpKTtcbiAgfVxuICBpZiAoYWJzRGlmZiA8IDZlNCAmJiAhc2hvd1NlY29uZClcbiAgICByZXR1cm4gbWVzc2FnZXMuanVzdE5vdztcbiAgaWYgKHR5cGVvZiBtYXggPT09IFwibnVtYmVyXCIgJiYgYWJzRGlmZiA+IG1heClcbiAgICByZXR1cm4gZnVsbERhdGVGb3JtYXR0ZXIobmV3IERhdGUoZnJvbSkpO1xuICBpZiAodHlwZW9mIG1heCA9PT0gXCJzdHJpbmdcIikge1xuICAgIGNvbnN0IHVuaXRNYXggPSAoX2EgPSB1bml0cy5maW5kKChpKSA9PiBpLm5hbWUgPT09IG1heCkpID09IG51bGwgPyB2b2lkIDAgOiBfYS5tYXg7XG4gICAgaWYgKHVuaXRNYXggJiYgYWJzRGlmZiA+IHVuaXRNYXgpXG4gICAgICByZXR1cm4gZnVsbERhdGVGb3JtYXR0ZXIobmV3IERhdGUoZnJvbSkpO1xuICB9XG4gIGZvciAoY29uc3QgW2lkeCwgdW5pdF0gb2YgdW5pdHMuZW50cmllcygpKSB7XG4gICAgY29uc3QgdmFsID0gZ2V0VmFsdWUoZGlmZiwgdW5pdCk7XG4gICAgaWYgKHZhbCA8PSAwICYmIHVuaXRzW2lkeCAtIDFdKVxuICAgICAgcmV0dXJuIGZvcm1hdChkaWZmLCB1bml0c1tpZHggLSAxXSk7XG4gICAgaWYgKGFic0RpZmYgPCB1bml0Lm1heClcbiAgICAgIHJldHVybiBmb3JtYXQoZGlmZiwgdW5pdCk7XG4gIH1cbiAgcmV0dXJuIG1lc3NhZ2VzLmludmFsaWQ7XG59XG5cbmNvbnN0IFVOSVRTID0gW1xuICB7IG5hbWU6IFwieWVhclwiLCBtczogMzE1MzZlNiB9LFxuICB7IG5hbWU6IFwibW9udGhcIiwgbXM6IDI1OTJlNiB9LFxuICB7IG5hbWU6IFwid2Vla1wiLCBtczogNjA0OGU1IH0sXG4gIHsgbmFtZTogXCJkYXlcIiwgbXM6IDg2NGU1IH0sXG4gIHsgbmFtZTogXCJob3VyXCIsIG1zOiAzNmU1IH0sXG4gIHsgbmFtZTogXCJtaW51dGVcIiwgbXM6IDZlNCB9LFxuICB7IG5hbWU6IFwic2Vjb25kXCIsIG1zOiAxZTMgfVxuXTtcbmZ1bmN0aW9uIHVzZVRpbWVBZ29JbnRsKHRpbWUsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgY29udHJvbHM6IGV4cG9zZUNvbnRyb2xzID0gZmFsc2UsXG4gICAgdXBkYXRlSW50ZXJ2YWwgPSAzZTRcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHsgbm93LCAuLi5jb250cm9scyB9ID0gdXNlTm93KHsgaW50ZXJ2YWw6IHVwZGF0ZUludGVydmFsLCBjb250cm9sczogdHJ1ZSB9KTtcbiAgY29uc3QgcmVzdWx0ID0gY29tcHV0ZWQoXG4gICAgKCkgPT4gZ2V0VGltZUFnb0ludGxSZXN1bHQobmV3IERhdGUodG9WYWx1ZSh0aW1lKSksIG9wdGlvbnMsIHRvVmFsdWUobm93KSlcbiAgKTtcbiAgY29uc3QgcGFydHMgPSBjb21wdXRlZCgoKSA9PiByZXN1bHQudmFsdWUucGFydHMpO1xuICBjb25zdCB0aW1lQWdvSW50bCA9IGNvbXB1dGVkKFxuICAgICgpID0+IGZvcm1hdFRpbWVBZ29JbnRsUGFydHMocGFydHMudmFsdWUsIHtcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgICBsb2NhbGU6IHJlc3VsdC52YWx1ZS5yZXNvbHZlZExvY2FsZVxuICAgIH0pXG4gICk7XG4gIHJldHVybiBleHBvc2VDb250cm9scyA/IHsgdGltZUFnb0ludGwsIHBhcnRzLCAuLi5jb250cm9scyB9IDogdGltZUFnb0ludGw7XG59XG5mdW5jdGlvbiBmb3JtYXRUaW1lQWdvSW50bChmcm9tLCBvcHRpb25zID0ge30sIG5vdyA9IERhdGUubm93KCkpIHtcbiAgY29uc3QgeyBwYXJ0cywgcmVzb2x2ZWRMb2NhbGUgfSA9IGdldFRpbWVBZ29JbnRsUmVzdWx0KGZyb20sIG9wdGlvbnMsIG5vdyk7XG4gIHJldHVybiBmb3JtYXRUaW1lQWdvSW50bFBhcnRzKHBhcnRzLCB7XG4gICAgLi4ub3B0aW9ucyxcbiAgICBsb2NhbGU6IHJlc29sdmVkTG9jYWxlXG4gIH0pO1xufVxuZnVuY3Rpb24gZ2V0VGltZUFnb0ludGxSZXN1bHQoZnJvbSwgb3B0aW9ucyA9IHt9LCBub3cgPSBEYXRlLm5vdygpKSB7XG4gIGNvbnN0IHtcbiAgICBsb2NhbGUsXG4gICAgcmVsYXRpdmVUaW1lRm9ybWF0T3B0aW9ucyA9IHsgbnVtZXJpYzogXCJhdXRvXCIgfVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgcnRmID0gbmV3IEludGwuUmVsYXRpdmVUaW1lRm9ybWF0KGxvY2FsZSwgcmVsYXRpdmVUaW1lRm9ybWF0T3B0aW9ucyk7XG4gIGNvbnN0IHsgbG9jYWxlOiByZXNvbHZlZExvY2FsZSB9ID0gcnRmLnJlc29sdmVkT3B0aW9ucygpO1xuICBjb25zdCBkaWZmID0gK2Zyb20gLSArbm93O1xuICBjb25zdCBhYnNEaWZmID0gTWF0aC5hYnMoZGlmZik7XG4gIGZvciAoY29uc3QgeyBuYW1lLCBtcyB9IG9mIFVOSVRTKSB7XG4gICAgaWYgKGFic0RpZmYgPj0gbXMpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHJlc29sdmVkTG9jYWxlLFxuICAgICAgICBwYXJ0czogcnRmLmZvcm1hdFRvUGFydHMoTWF0aC5yb3VuZChkaWZmIC8gbXMpLCBuYW1lKVxuICAgICAgfTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHtcbiAgICByZXNvbHZlZExvY2FsZSxcbiAgICBwYXJ0czogcnRmLmZvcm1hdFRvUGFydHMoMCwgXCJzZWNvbmRcIilcbiAgfTtcbn1cbmZ1bmN0aW9uIGZvcm1hdFRpbWVBZ29JbnRsUGFydHMocGFydHMsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgaW5zZXJ0U3BhY2UgPSB0cnVlLFxuICAgIGpvaW5QYXJ0cyxcbiAgICBsb2NhbGVcbiAgfSA9IG9wdGlvbnM7XG4gIGlmICh0eXBlb2Ygam9pblBhcnRzID09PSBcImZ1bmN0aW9uXCIpXG4gICAgcmV0dXJuIGpvaW5QYXJ0cyhwYXJ0cywgbG9jYWxlKTtcbiAgaWYgKCFpbnNlcnRTcGFjZSlcbiAgICByZXR1cm4gcGFydHMubWFwKChwYXJ0KSA9PiBwYXJ0LnZhbHVlKS5qb2luKFwiXCIpO1xuICByZXR1cm4gcGFydHMubWFwKChwYXJ0KSA9PiBwYXJ0LnZhbHVlLnRyaW0oKSkuam9pbihcIiBcIik7XG59XG5cbmZ1bmN0aW9uIHVzZVRpbWVvdXRQb2xsKGZuLCBpbnRlcnZhbCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBpbW1lZGlhdGUgPSB0cnVlLFxuICAgIGltbWVkaWF0ZUNhbGxiYWNrID0gZmFsc2VcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHsgc3RhcnQgfSA9IHVzZVRpbWVvdXRGbihsb29wLCBpbnRlcnZhbCwgeyBpbW1lZGlhdGUgfSk7XG4gIGNvbnN0IGlzQWN0aXZlID0gc2hhbGxvd1JlZihmYWxzZSk7XG4gIGFzeW5jIGZ1bmN0aW9uIGxvb3AoKSB7XG4gICAgaWYgKCFpc0FjdGl2ZS52YWx1ZSlcbiAgICAgIHJldHVybjtcbiAgICBhd2FpdCBmbigpO1xuICAgIHN0YXJ0KCk7XG4gIH1cbiAgZnVuY3Rpb24gcmVzdW1lKCkge1xuICAgIGlmICghaXNBY3RpdmUudmFsdWUpIHtcbiAgICAgIGlzQWN0aXZlLnZhbHVlID0gdHJ1ZTtcbiAgICAgIGlmIChpbW1lZGlhdGVDYWxsYmFjaylcbiAgICAgICAgZm4oKTtcbiAgICAgIHN0YXJ0KCk7XG4gICAgfVxuICB9XG4gIGZ1bmN0aW9uIHBhdXNlKCkge1xuICAgIGlzQWN0aXZlLnZhbHVlID0gZmFsc2U7XG4gIH1cbiAgaWYgKGltbWVkaWF0ZSAmJiBpc0NsaWVudClcbiAgICByZXN1bWUoKTtcbiAgdHJ5T25TY29wZURpc3Bvc2UocGF1c2UpO1xuICByZXR1cm4ge1xuICAgIGlzQWN0aXZlLFxuICAgIHBhdXNlLFxuICAgIHJlc3VtZVxuICB9O1xufVxuXG5mdW5jdGlvbiB1c2VUaW1lc3RhbXAob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBjb250cm9sczogZXhwb3NlQ29udHJvbHMgPSBmYWxzZSxcbiAgICBvZmZzZXQgPSAwLFxuICAgIGltbWVkaWF0ZSA9IHRydWUsXG4gICAgaW50ZXJ2YWwgPSBcInJlcXVlc3RBbmltYXRpb25GcmFtZVwiLFxuICAgIGNhbGxiYWNrXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCB0cyA9IHNoYWxsb3dSZWYodGltZXN0YW1wKCkgKyBvZmZzZXQpO1xuICBjb25zdCB1cGRhdGUgPSAoKSA9PiB0cy52YWx1ZSA9IHRpbWVzdGFtcCgpICsgb2Zmc2V0O1xuICBjb25zdCBjYiA9IGNhbGxiYWNrID8gKCkgPT4ge1xuICAgIHVwZGF0ZSgpO1xuICAgIGNhbGxiYWNrKHRzLnZhbHVlKTtcbiAgfSA6IHVwZGF0ZTtcbiAgY29uc3QgY29udHJvbHMgPSBpbnRlcnZhbCA9PT0gXCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWVcIiA/IHVzZVJhZkZuKGNiLCB7IGltbWVkaWF0ZSB9KSA6IHVzZUludGVydmFsRm4oY2IsIGludGVydmFsLCB7IGltbWVkaWF0ZSB9KTtcbiAgaWYgKGV4cG9zZUNvbnRyb2xzKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRpbWVzdGFtcDogdHMsXG4gICAgICAuLi5jb250cm9sc1xuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHRzO1xuICB9XG59XG5cbmZ1bmN0aW9uIHVzZVRpdGxlKG5ld1RpdGxlID0gbnVsbCwgb3B0aW9ucyA9IHt9KSB7XG4gIHZhciBfYSwgX2IsIF9jO1xuICBjb25zdCB7XG4gICAgZG9jdW1lbnQgPSBkZWZhdWx0RG9jdW1lbnQsXG4gICAgcmVzdG9yZU9uVW5tb3VudCA9ICh0KSA9PiB0XG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBvcmlnaW5hbFRpdGxlID0gKF9hID0gZG9jdW1lbnQgPT0gbnVsbCA/IHZvaWQgMCA6IGRvY3VtZW50LnRpdGxlKSAhPSBudWxsID8gX2EgOiBcIlwiO1xuICBjb25zdCB0aXRsZSA9IHRvUmVmKChfYiA9IG5ld1RpdGxlICE9IG51bGwgPyBuZXdUaXRsZSA6IGRvY3VtZW50ID09IG51bGwgPyB2b2lkIDAgOiBkb2N1bWVudC50aXRsZSkgIT0gbnVsbCA/IF9iIDogbnVsbCk7XG4gIGNvbnN0IGlzUmVhZG9ubHkgPSAhIShuZXdUaXRsZSAmJiB0eXBlb2YgbmV3VGl0bGUgPT09IFwiZnVuY3Rpb25cIik7XG4gIGZ1bmN0aW9uIGZvcm1hdCh0KSB7XG4gICAgaWYgKCEoXCJ0aXRsZVRlbXBsYXRlXCIgaW4gb3B0aW9ucykpXG4gICAgICByZXR1cm4gdDtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IG9wdGlvbnMudGl0bGVUZW1wbGF0ZSB8fCBcIiVzXCI7XG4gICAgcmV0dXJuIHR5cGVvZiB0ZW1wbGF0ZSA9PT0gXCJmdW5jdGlvblwiID8gdGVtcGxhdGUodCkgOiB0b1ZhbHVlKHRlbXBsYXRlKS5yZXBsYWNlKC8lcy9nLCB0KTtcbiAgfVxuICB3YXRjaChcbiAgICB0aXRsZSxcbiAgICAobmV3VmFsdWUsIG9sZFZhbHVlKSA9PiB7XG4gICAgICBpZiAobmV3VmFsdWUgIT09IG9sZFZhbHVlICYmIGRvY3VtZW50KVxuICAgICAgICBkb2N1bWVudC50aXRsZSA9IGZvcm1hdChuZXdWYWx1ZSAhPSBudWxsID8gbmV3VmFsdWUgOiBcIlwiKTtcbiAgICB9LFxuICAgIHsgaW1tZWRpYXRlOiB0cnVlIH1cbiAgKTtcbiAgaWYgKG9wdGlvbnMub2JzZXJ2ZSAmJiAhb3B0aW9ucy50aXRsZVRlbXBsYXRlICYmIGRvY3VtZW50ICYmICFpc1JlYWRvbmx5KSB7XG4gICAgdXNlTXV0YXRpb25PYnNlcnZlcihcbiAgICAgIChfYyA9IGRvY3VtZW50LmhlYWQpID09IG51bGwgPyB2b2lkIDAgOiBfYy5xdWVyeVNlbGVjdG9yKFwidGl0bGVcIiksXG4gICAgICAoKSA9PiB7XG4gICAgICAgIGlmIChkb2N1bWVudCAmJiBkb2N1bWVudC50aXRsZSAhPT0gdGl0bGUudmFsdWUpXG4gICAgICAgICAgdGl0bGUudmFsdWUgPSBmb3JtYXQoZG9jdW1lbnQudGl0bGUpO1xuICAgICAgfSxcbiAgICAgIHsgY2hpbGRMaXN0OiB0cnVlIH1cbiAgICApO1xuICB9XG4gIHRyeU9uU2NvcGVEaXNwb3NlKCgpID0+IHtcbiAgICBpZiAocmVzdG9yZU9uVW5tb3VudCkge1xuICAgICAgY29uc3QgcmVzdG9yZWRUaXRsZSA9IHJlc3RvcmVPblVubW91bnQob3JpZ2luYWxUaXRsZSwgdGl0bGUudmFsdWUgfHwgXCJcIik7XG4gICAgICBpZiAocmVzdG9yZWRUaXRsZSAhPSBudWxsICYmIGRvY3VtZW50KVxuICAgICAgICBkb2N1bWVudC50aXRsZSA9IHJlc3RvcmVkVGl0bGU7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIHRpdGxlO1xufVxuXG5jb25zdCBfVHJhbnNpdGlvblByZXNldHMgPSB7XG4gIGVhc2VJblNpbmU6IFswLjEyLCAwLCAwLjM5LCAwXSxcbiAgZWFzZU91dFNpbmU6IFswLjYxLCAxLCAwLjg4LCAxXSxcbiAgZWFzZUluT3V0U2luZTogWzAuMzcsIDAsIDAuNjMsIDFdLFxuICBlYXNlSW5RdWFkOiBbMC4xMSwgMCwgMC41LCAwXSxcbiAgZWFzZU91dFF1YWQ6IFswLjUsIDEsIDAuODksIDFdLFxuICBlYXNlSW5PdXRRdWFkOiBbMC40NSwgMCwgMC41NSwgMV0sXG4gIGVhc2VJbkN1YmljOiBbMC4zMiwgMCwgMC42NywgMF0sXG4gIGVhc2VPdXRDdWJpYzogWzAuMzMsIDEsIDAuNjgsIDFdLFxuICBlYXNlSW5PdXRDdWJpYzogWzAuNjUsIDAsIDAuMzUsIDFdLFxuICBlYXNlSW5RdWFydDogWzAuNSwgMCwgMC43NSwgMF0sXG4gIGVhc2VPdXRRdWFydDogWzAuMjUsIDEsIDAuNSwgMV0sXG4gIGVhc2VJbk91dFF1YXJ0OiBbMC43NiwgMCwgMC4yNCwgMV0sXG4gIGVhc2VJblF1aW50OiBbMC42NCwgMCwgMC43OCwgMF0sXG4gIGVhc2VPdXRRdWludDogWzAuMjIsIDEsIDAuMzYsIDFdLFxuICBlYXNlSW5PdXRRdWludDogWzAuODMsIDAsIDAuMTcsIDFdLFxuICBlYXNlSW5FeHBvOiBbMC43LCAwLCAwLjg0LCAwXSxcbiAgZWFzZU91dEV4cG86IFswLjE2LCAxLCAwLjMsIDFdLFxuICBlYXNlSW5PdXRFeHBvOiBbMC44NywgMCwgMC4xMywgMV0sXG4gIGVhc2VJbkNpcmM6IFswLjU1LCAwLCAxLCAwLjQ1XSxcbiAgZWFzZU91dENpcmM6IFswLCAwLjU1LCAwLjQ1LCAxXSxcbiAgZWFzZUluT3V0Q2lyYzogWzAuODUsIDAsIDAuMTUsIDFdLFxuICBlYXNlSW5CYWNrOiBbMC4zNiwgMCwgMC42NiwgLTAuNTZdLFxuICBlYXNlT3V0QmFjazogWzAuMzQsIDEuNTYsIDAuNjQsIDFdLFxuICBlYXNlSW5PdXRCYWNrOiBbMC42OCwgLTAuNiwgMC4zMiwgMS42XVxufTtcbmNvbnN0IFRyYW5zaXRpb25QcmVzZXRzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5hc3NpZ24oe30sIHsgbGluZWFyOiBpZGVudGl0eSB9LCBfVHJhbnNpdGlvblByZXNldHMpO1xuZnVuY3Rpb24gY3JlYXRlRWFzaW5nRnVuY3Rpb24oW3AwLCBwMSwgcDIsIHAzXSkge1xuICBjb25zdCBhID0gKGExLCBhMikgPT4gMSAtIDMgKiBhMiArIDMgKiBhMTtcbiAgY29uc3QgYiA9IChhMSwgYTIpID0+IDMgKiBhMiAtIDYgKiBhMTtcbiAgY29uc3QgYyA9IChhMSkgPT4gMyAqIGExO1xuICBjb25zdCBjYWxjQmV6aWVyID0gKHQsIGExLCBhMikgPT4gKChhKGExLCBhMikgKiB0ICsgYihhMSwgYTIpKSAqIHQgKyBjKGExKSkgKiB0O1xuICBjb25zdCBnZXRTbG9wZSA9ICh0LCBhMSwgYTIpID0+IDMgKiBhKGExLCBhMikgKiB0ICogdCArIDIgKiBiKGExLCBhMikgKiB0ICsgYyhhMSk7XG4gIGNvbnN0IGdldFRmb3JYID0gKHgpID0+IHtcbiAgICBsZXQgYUd1ZXNzVCA9IHg7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyArK2kpIHtcbiAgICAgIGNvbnN0IGN1cnJlbnRTbG9wZSA9IGdldFNsb3BlKGFHdWVzc1QsIHAwLCBwMik7XG4gICAgICBpZiAoY3VycmVudFNsb3BlID09PSAwKVxuICAgICAgICByZXR1cm4gYUd1ZXNzVDtcbiAgICAgIGNvbnN0IGN1cnJlbnRYID0gY2FsY0JlemllcihhR3Vlc3NULCBwMCwgcDIpIC0geDtcbiAgICAgIGFHdWVzc1QgLT0gY3VycmVudFggLyBjdXJyZW50U2xvcGU7XG4gICAgfVxuICAgIHJldHVybiBhR3Vlc3NUO1xuICB9O1xuICByZXR1cm4gKHgpID0+IHAwID09PSBwMSAmJiBwMiA9PT0gcDMgPyB4IDogY2FsY0JlemllcihnZXRUZm9yWCh4KSwgcDEsIHAzKTtcbn1cbmZ1bmN0aW9uIGxlcnAoYSwgYiwgYWxwaGEpIHtcbiAgcmV0dXJuIGEgKyBhbHBoYSAqIChiIC0gYSk7XG59XG5mdW5jdGlvbiB0b1ZlYyh0KSB7XG4gIHJldHVybiAodHlwZW9mIHQgPT09IFwibnVtYmVyXCIgPyBbdF0gOiB0KSB8fCBbXTtcbn1cbmZ1bmN0aW9uIGV4ZWN1dGVUcmFuc2l0aW9uKHNvdXJjZSwgZnJvbSwgdG8sIG9wdGlvbnMgPSB7fSkge1xuICB2YXIgX2EsIF9iO1xuICBjb25zdCB7XG4gICAgd2luZG93ID0gZGVmYXVsdFdpbmRvd1xuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgZnJvbVZhbCA9IHRvVmFsdWUoZnJvbSk7XG4gIGNvbnN0IHRvVmFsID0gdG9WYWx1ZSh0byk7XG4gIGNvbnN0IHYxID0gdG9WZWMoZnJvbVZhbCk7XG4gIGNvbnN0IHYyID0gdG9WZWModG9WYWwpO1xuICBjb25zdCBkdXJhdGlvbiA9IChfYSA9IHRvVmFsdWUob3B0aW9ucy5kdXJhdGlvbikpICE9IG51bGwgPyBfYSA6IDFlMztcbiAgY29uc3Qgc3RhcnRlZEF0ID0gRGF0ZS5ub3coKTtcbiAgY29uc3QgZW5kQXQgPSBEYXRlLm5vdygpICsgZHVyYXRpb247XG4gIGNvbnN0IHRyYW5zID0gdHlwZW9mIG9wdGlvbnMudHJhbnNpdGlvbiA9PT0gXCJmdW5jdGlvblwiID8gb3B0aW9ucy50cmFuc2l0aW9uIDogKF9iID0gdG9WYWx1ZShvcHRpb25zLnRyYW5zaXRpb24pKSAhPSBudWxsID8gX2IgOiBpZGVudGl0eTtcbiAgY29uc3QgZWFzZSA9IHR5cGVvZiB0cmFucyA9PT0gXCJmdW5jdGlvblwiID8gdHJhbnMgOiBjcmVhdGVFYXNpbmdGdW5jdGlvbih0cmFucyk7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIHNvdXJjZS52YWx1ZSA9IGZyb21WYWw7XG4gICAgY29uc3QgdGljayA9ICgpID0+IHtcbiAgICAgIHZhciBfYTI7XG4gICAgICBpZiAoKF9hMiA9IG9wdGlvbnMuYWJvcnQpID09IG51bGwgPyB2b2lkIDAgOiBfYTIuY2FsbChvcHRpb25zKSkge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICBjb25zdCBhbHBoYSA9IGVhc2UoKG5vdyAtIHN0YXJ0ZWRBdCkgLyBkdXJhdGlvbik7XG4gICAgICBjb25zdCBhcnIgPSB0b1ZlYyhzb3VyY2UudmFsdWUpLm1hcCgobiwgaSkgPT4gbGVycCh2MVtpXSwgdjJbaV0sIGFscGhhKSk7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShzb3VyY2UudmFsdWUpKVxuICAgICAgICBzb3VyY2UudmFsdWUgPSBhcnIubWFwKChuLCBpKSA9PiB7XG4gICAgICAgICAgdmFyIF9hMywgX2IyO1xuICAgICAgICAgIHJldHVybiBsZXJwKChfYTMgPSB2MVtpXSkgIT0gbnVsbCA/IF9hMyA6IDAsIChfYjIgPSB2MltpXSkgIT0gbnVsbCA/IF9iMiA6IDAsIGFscGhhKTtcbiAgICAgICAgfSk7XG4gICAgICBlbHNlIGlmICh0eXBlb2Ygc291cmNlLnZhbHVlID09PSBcIm51bWJlclwiKVxuICAgICAgICBzb3VyY2UudmFsdWUgPSBhcnJbMF07XG4gICAgICBpZiAobm93IDwgZW5kQXQpIHtcbiAgICAgICAgd2luZG93ID09IG51bGwgPyB2b2lkIDAgOiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc291cmNlLnZhbHVlID0gdG9WYWw7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRpY2soKTtcbiAgfSk7XG59XG5mdW5jdGlvbiB1c2VUcmFuc2l0aW9uKHNvdXJjZSwgb3B0aW9ucyA9IHt9KSB7XG4gIGxldCBjdXJyZW50SWQgPSAwO1xuICBjb25zdCBzb3VyY2VWYWwgPSAoKSA9PiB7XG4gICAgY29uc3QgdiA9IHRvVmFsdWUoc291cmNlKTtcbiAgICByZXR1cm4gdHlwZW9mIHYgPT09IFwibnVtYmVyXCIgPyB2IDogdi5tYXAodG9WYWx1ZSk7XG4gIH07XG4gIGNvbnN0IG91dHB1dFJlZiA9IHJlZihzb3VyY2VWYWwoKSk7XG4gIHdhdGNoKHNvdXJjZVZhbCwgYXN5bmMgKHRvKSA9PiB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBpZiAodG9WYWx1ZShvcHRpb25zLmRpc2FibGVkKSlcbiAgICAgIHJldHVybjtcbiAgICBjb25zdCBpZCA9ICsrY3VycmVudElkO1xuICAgIGlmIChvcHRpb25zLmRlbGF5KVxuICAgICAgYXdhaXQgcHJvbWlzZVRpbWVvdXQodG9WYWx1ZShvcHRpb25zLmRlbGF5KSk7XG4gICAgaWYgKGlkICE9PSBjdXJyZW50SWQpXG4gICAgICByZXR1cm47XG4gICAgY29uc3QgdG9WYWwgPSBBcnJheS5pc0FycmF5KHRvKSA/IHRvLm1hcCh0b1ZhbHVlKSA6IHRvVmFsdWUodG8pO1xuICAgIChfYSA9IG9wdGlvbnMub25TdGFydGVkKSA9PSBudWxsID8gdm9pZCAwIDogX2EuY2FsbChvcHRpb25zKTtcbiAgICBhd2FpdCBleGVjdXRlVHJhbnNpdGlvbihvdXRwdXRSZWYsIG91dHB1dFJlZi52YWx1ZSwgdG9WYWwsIHtcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgICBhYm9ydDogKCkgPT4ge1xuICAgICAgICB2YXIgX2EyO1xuICAgICAgICByZXR1cm4gaWQgIT09IGN1cnJlbnRJZCB8fCAoKF9hMiA9IG9wdGlvbnMuYWJvcnQpID09IG51bGwgPyB2b2lkIDAgOiBfYTIuY2FsbChvcHRpb25zKSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgKF9iID0gb3B0aW9ucy5vbkZpbmlzaGVkKSA9PSBudWxsID8gdm9pZCAwIDogX2IuY2FsbChvcHRpb25zKTtcbiAgfSwgeyBkZWVwOiB0cnVlIH0pO1xuICB3YXRjaCgoKSA9PiB0b1ZhbHVlKG9wdGlvbnMuZGlzYWJsZWQpLCAoZGlzYWJsZWQpID0+IHtcbiAgICBpZiAoZGlzYWJsZWQpIHtcbiAgICAgIGN1cnJlbnRJZCsrO1xuICAgICAgb3V0cHV0UmVmLnZhbHVlID0gc291cmNlVmFsKCk7XG4gICAgfVxuICB9KTtcbiAgdHJ5T25TY29wZURpc3Bvc2UoKCkgPT4ge1xuICAgIGN1cnJlbnRJZCsrO1xuICB9KTtcbiAgcmV0dXJuIGNvbXB1dGVkKCgpID0+IHRvVmFsdWUob3B0aW9ucy5kaXNhYmxlZCkgPyBzb3VyY2VWYWwoKSA6IG91dHB1dFJlZi52YWx1ZSk7XG59XG5cbmZ1bmN0aW9uIHVzZVVybFNlYXJjaFBhcmFtcyhtb2RlID0gXCJoaXN0b3J5XCIsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgaW5pdGlhbFZhbHVlID0ge30sXG4gICAgcmVtb3ZlTnVsbGlzaFZhbHVlcyA9IHRydWUsXG4gICAgcmVtb3ZlRmFsc3lWYWx1ZXMgPSBmYWxzZSxcbiAgICB3cml0ZTogZW5hYmxlV3JpdGUgPSB0cnVlLFxuICAgIHdyaXRlTW9kZSA9IFwicmVwbGFjZVwiLFxuICAgIHdpbmRvdyA9IGRlZmF1bHRXaW5kb3csXG4gICAgc3RyaW5naWZ5ID0gKHBhcmFtcykgPT4gcGFyYW1zLnRvU3RyaW5nKClcbiAgfSA9IG9wdGlvbnM7XG4gIGlmICghd2luZG93KVxuICAgIHJldHVybiByZWFjdGl2ZShpbml0aWFsVmFsdWUpO1xuICBjb25zdCBzdGF0ZSA9IHJlYWN0aXZlKHt9KTtcbiAgZnVuY3Rpb24gZ2V0UmF3UGFyYW1zKCkge1xuICAgIGlmIChtb2RlID09PSBcImhpc3RvcnlcIikge1xuICAgICAgcmV0dXJuIHdpbmRvdy5sb2NhdGlvbi5zZWFyY2ggfHwgXCJcIjtcbiAgICB9IGVsc2UgaWYgKG1vZGUgPT09IFwiaGFzaFwiKSB7XG4gICAgICBjb25zdCBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2ggfHwgXCJcIjtcbiAgICAgIGNvbnN0IGluZGV4ID0gaGFzaC5pbmRleE9mKFwiP1wiKTtcbiAgICAgIHJldHVybiBpbmRleCA+IDAgPyBoYXNoLnNsaWNlKGluZGV4KSA6IFwiXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAod2luZG93LmxvY2F0aW9uLmhhc2ggfHwgXCJcIikucmVwbGFjZSgvXiMvLCBcIlwiKTtcbiAgICB9XG4gIH1cbiAgZnVuY3Rpb24gY29uc3RydWN0UXVlcnkocGFyYW1zKSB7XG4gICAgY29uc3Qgc3RyaW5naWZpZWQgPSBzdHJpbmdpZnkocGFyYW1zKTtcbiAgICBpZiAobW9kZSA9PT0gXCJoaXN0b3J5XCIpXG4gICAgICByZXR1cm4gYCR7c3RyaW5naWZpZWQgPyBgPyR7c3RyaW5naWZpZWR9YCA6IFwiXCJ9JHt3aW5kb3cubG9jYXRpb24uaGFzaCB8fCBcIlwifWA7XG4gICAgaWYgKG1vZGUgPT09IFwiaGFzaC1wYXJhbXNcIilcbiAgICAgIHJldHVybiBgJHt3aW5kb3cubG9jYXRpb24uc2VhcmNoIHx8IFwiXCJ9JHtzdHJpbmdpZmllZCA/IGAjJHtzdHJpbmdpZmllZH1gIDogXCJcIn1gO1xuICAgIGNvbnN0IGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaCB8fCBcIiNcIjtcbiAgICBjb25zdCBpbmRleCA9IGhhc2guaW5kZXhPZihcIj9cIik7XG4gICAgaWYgKGluZGV4ID4gMClcbiAgICAgIHJldHVybiBgJHt3aW5kb3cubG9jYXRpb24uc2VhcmNoIHx8IFwiXCJ9JHtoYXNoLnNsaWNlKDAsIGluZGV4KX0ke3N0cmluZ2lmaWVkID8gYD8ke3N0cmluZ2lmaWVkfWAgOiBcIlwifWA7XG4gICAgcmV0dXJuIGAke3dpbmRvdy5sb2NhdGlvbi5zZWFyY2ggfHwgXCJcIn0ke2hhc2h9JHtzdHJpbmdpZmllZCA/IGA/JHtzdHJpbmdpZmllZH1gIDogXCJcIn1gO1xuICB9XG4gIGZ1bmN0aW9uIHJlYWQoKSB7XG4gICAgcmV0dXJuIG5ldyBVUkxTZWFyY2hQYXJhbXMoZ2V0UmF3UGFyYW1zKCkpO1xuICB9XG4gIGZ1bmN0aW9uIHVwZGF0ZVN0YXRlKHBhcmFtcykge1xuICAgIGNvbnN0IHVudXNlZEtleXMgPSBuZXcgU2V0KE9iamVjdC5rZXlzKHN0YXRlKSk7XG4gICAgZm9yIChjb25zdCBrZXkgb2YgcGFyYW1zLmtleXMoKSkge1xuICAgICAgY29uc3QgcGFyYW1zRm9yS2V5ID0gcGFyYW1zLmdldEFsbChrZXkpO1xuICAgICAgc3RhdGVba2V5XSA9IHBhcmFtc0ZvcktleS5sZW5ndGggPiAxID8gcGFyYW1zRm9yS2V5IDogcGFyYW1zLmdldChrZXkpIHx8IFwiXCI7XG4gICAgICB1bnVzZWRLZXlzLmRlbGV0ZShrZXkpO1xuICAgIH1cbiAgICBBcnJheS5mcm9tKHVudXNlZEtleXMpLmZvckVhY2goKGtleSkgPT4gZGVsZXRlIHN0YXRlW2tleV0pO1xuICB9XG4gIGNvbnN0IHsgcGF1c2UsIHJlc3VtZSB9ID0gcGF1c2FibGVXYXRjaChcbiAgICBzdGF0ZSxcbiAgICAoKSA9PiB7XG4gICAgICBjb25zdCBwYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKFwiXCIpO1xuICAgICAgT2JqZWN0LmtleXMoc3RhdGUpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICBjb25zdCBtYXBFbnRyeSA9IHN0YXRlW2tleV07XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1hcEVudHJ5KSlcbiAgICAgICAgICBtYXBFbnRyeS5mb3JFYWNoKCh2YWx1ZSkgPT4gcGFyYW1zLmFwcGVuZChrZXksIHZhbHVlKSk7XG4gICAgICAgIGVsc2UgaWYgKHJlbW92ZU51bGxpc2hWYWx1ZXMgJiYgbWFwRW50cnkgPT0gbnVsbClcbiAgICAgICAgICBwYXJhbXMuZGVsZXRlKGtleSk7XG4gICAgICAgIGVsc2UgaWYgKHJlbW92ZUZhbHN5VmFsdWVzICYmICFtYXBFbnRyeSlcbiAgICAgICAgICBwYXJhbXMuZGVsZXRlKGtleSk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICBwYXJhbXMuc2V0KGtleSwgbWFwRW50cnkpO1xuICAgICAgfSk7XG4gICAgICB3cml0ZShwYXJhbXMsIGZhbHNlKTtcbiAgICB9LFxuICAgIHsgZGVlcDogdHJ1ZSB9XG4gICk7XG4gIGZ1bmN0aW9uIHdyaXRlKHBhcmFtcywgc2hvdWxkVXBkYXRlLCBzaG91bGRXcml0ZUhpc3RvcnkgPSB0cnVlKSB7XG4gICAgcGF1c2UoKTtcbiAgICBpZiAoc2hvdWxkVXBkYXRlKVxuICAgICAgdXBkYXRlU3RhdGUocGFyYW1zKTtcbiAgICBpZiAod3JpdGVNb2RlID09PSBcInJlcGxhY2VcIikge1xuICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKFxuICAgICAgICB3aW5kb3cuaGlzdG9yeS5zdGF0ZSxcbiAgICAgICAgd2luZG93LmRvY3VtZW50LnRpdGxlLFxuICAgICAgICB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyBjb25zdHJ1Y3RRdWVyeShwYXJhbXMpXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoc2hvdWxkV3JpdGVIaXN0b3J5KSB7XG4gICAgICAgIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZShcbiAgICAgICAgICB3aW5kb3cuaGlzdG9yeS5zdGF0ZSxcbiAgICAgICAgICB3aW5kb3cuZG9jdW1lbnQudGl0bGUsXG4gICAgICAgICAgd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lICsgY29uc3RydWN0UXVlcnkocGFyYW1zKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICBuZXh0VGljaygoKSA9PiByZXN1bWUoKSk7XG4gIH1cbiAgZnVuY3Rpb24gb25DaGFuZ2VkKCkge1xuICAgIGlmICghZW5hYmxlV3JpdGUpXG4gICAgICByZXR1cm47XG4gICAgd3JpdGUocmVhZCgpLCB0cnVlLCBmYWxzZSk7XG4gIH1cbiAgY29uc3QgbGlzdGVuZXJPcHRpb25zID0geyBwYXNzaXZlOiB0cnVlIH07XG4gIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcInBvcHN0YXRlXCIsIG9uQ2hhbmdlZCwgbGlzdGVuZXJPcHRpb25zKTtcbiAgaWYgKG1vZGUgIT09IFwiaGlzdG9yeVwiKVxuICAgIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcImhhc2hjaGFuZ2VcIiwgb25DaGFuZ2VkLCBsaXN0ZW5lck9wdGlvbnMpO1xuICBjb25zdCBpbml0aWFsID0gcmVhZCgpO1xuICBpZiAoaW5pdGlhbC5rZXlzKCkubmV4dCgpLnZhbHVlKVxuICAgIHVwZGF0ZVN0YXRlKGluaXRpYWwpO1xuICBlbHNlXG4gICAgT2JqZWN0LmFzc2lnbihzdGF0ZSwgaW5pdGlhbFZhbHVlKTtcbiAgcmV0dXJuIHN0YXRlO1xufVxuXG5mdW5jdGlvbiB1c2VVc2VyTWVkaWEob3B0aW9ucyA9IHt9KSB7XG4gIHZhciBfYSwgX2I7XG4gIGNvbnN0IGVuYWJsZWQgPSBzaGFsbG93UmVmKChfYSA9IG9wdGlvbnMuZW5hYmxlZCkgIT0gbnVsbCA/IF9hIDogZmFsc2UpO1xuICBjb25zdCBhdXRvU3dpdGNoID0gc2hhbGxvd1JlZigoX2IgPSBvcHRpb25zLmF1dG9Td2l0Y2gpICE9IG51bGwgPyBfYiA6IHRydWUpO1xuICBjb25zdCBjb25zdHJhaW50cyA9IHJlZihvcHRpb25zLmNvbnN0cmFpbnRzKTtcbiAgY29uc3QgeyBuYXZpZ2F0b3IgPSBkZWZhdWx0TmF2aWdhdG9yIH0gPSBvcHRpb25zO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiB7XG4gICAgdmFyIF9hMjtcbiAgICByZXR1cm4gKF9hMiA9IG5hdmlnYXRvciA9PSBudWxsID8gdm9pZCAwIDogbmF2aWdhdG9yLm1lZGlhRGV2aWNlcykgPT0gbnVsbCA/IHZvaWQgMCA6IF9hMi5nZXRVc2VyTWVkaWE7XG4gIH0pO1xuICBjb25zdCBzdHJlYW0gPSBzaGFsbG93UmVmKCk7XG4gIGZ1bmN0aW9uIGdldERldmljZU9wdGlvbnModHlwZSkge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBcInZpZGVvXCI6IHtcbiAgICAgICAgaWYgKGNvbnN0cmFpbnRzLnZhbHVlKVxuICAgICAgICAgIHJldHVybiBjb25zdHJhaW50cy52YWx1ZS52aWRlbyB8fCBmYWxzZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlIFwiYXVkaW9cIjoge1xuICAgICAgICBpZiAoY29uc3RyYWludHMudmFsdWUpXG4gICAgICAgICAgcmV0dXJuIGNvbnN0cmFpbnRzLnZhbHVlLmF1ZGlvIHx8IGZhbHNlO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgYXN5bmMgZnVuY3Rpb24gX3N0YXJ0KCkge1xuICAgIGlmICghaXNTdXBwb3J0ZWQudmFsdWUgfHwgc3RyZWFtLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIHN0cmVhbS52YWx1ZSA9IGF3YWl0IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHtcbiAgICAgIHZpZGVvOiBnZXREZXZpY2VPcHRpb25zKFwidmlkZW9cIiksXG4gICAgICBhdWRpbzogZ2V0RGV2aWNlT3B0aW9ucyhcImF1ZGlvXCIpXG4gICAgfSk7XG4gICAgcmV0dXJuIHN0cmVhbS52YWx1ZTtcbiAgfVxuICBmdW5jdGlvbiBfc3RvcCgpIHtcbiAgICB2YXIgX2EyO1xuICAgIChfYTIgPSBzdHJlYW0udmFsdWUpID09IG51bGwgPyB2b2lkIDAgOiBfYTIuZ2V0VHJhY2tzKCkuZm9yRWFjaCgodCkgPT4gdC5zdG9wKCkpO1xuICAgIHN0cmVhbS52YWx1ZSA9IHZvaWQgMDtcbiAgfVxuICBmdW5jdGlvbiBzdG9wKCkge1xuICAgIF9zdG9wKCk7XG4gICAgZW5hYmxlZC52YWx1ZSA9IGZhbHNlO1xuICB9XG4gIGFzeW5jIGZ1bmN0aW9uIHN0YXJ0KCkge1xuICAgIGF3YWl0IF9zdGFydCgpO1xuICAgIGlmIChzdHJlYW0udmFsdWUpXG4gICAgICBlbmFibGVkLnZhbHVlID0gdHJ1ZTtcbiAgICByZXR1cm4gc3RyZWFtLnZhbHVlO1xuICB9XG4gIGFzeW5jIGZ1bmN0aW9uIHJlc3RhcnQoKSB7XG4gICAgX3N0b3AoKTtcbiAgICByZXR1cm4gYXdhaXQgc3RhcnQoKTtcbiAgfVxuICB3YXRjaChcbiAgICBlbmFibGVkLFxuICAgICh2KSA9PiB7XG4gICAgICBpZiAodilcbiAgICAgICAgX3N0YXJ0KCk7XG4gICAgICBlbHNlIF9zdG9wKCk7XG4gICAgfSxcbiAgICB7IGltbWVkaWF0ZTogdHJ1ZSB9XG4gICk7XG4gIHdhdGNoKFxuICAgIGNvbnN0cmFpbnRzLFxuICAgICgpID0+IHtcbiAgICAgIGlmIChhdXRvU3dpdGNoLnZhbHVlICYmIHN0cmVhbS52YWx1ZSlcbiAgICAgICAgcmVzdGFydCgpO1xuICAgIH0sXG4gICAgeyBpbW1lZGlhdGU6IHRydWUgfVxuICApO1xuICB0cnlPblNjb3BlRGlzcG9zZSgoKSA9PiB7XG4gICAgc3RvcCgpO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBpc1N1cHBvcnRlZCxcbiAgICBzdHJlYW0sXG4gICAgc3RhcnQsXG4gICAgc3RvcCxcbiAgICByZXN0YXJ0LFxuICAgIGNvbnN0cmFpbnRzLFxuICAgIGVuYWJsZWQsXG4gICAgYXV0b1N3aXRjaFxuICB9O1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlVk1vZGVsKHByb3BzLCBrZXksIGVtaXQsIG9wdGlvbnMgPSB7fSkge1xuICB2YXIgX2EsIF9iLCBfYztcbiAgY29uc3Qge1xuICAgIGNsb25lID0gZmFsc2UsXG4gICAgcGFzc2l2ZSA9IGZhbHNlLFxuICAgIGV2ZW50TmFtZSxcbiAgICBkZWVwID0gZmFsc2UsXG4gICAgZGVmYXVsdFZhbHVlLFxuICAgIHNob3VsZEVtaXRcbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IHZtID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7XG4gIGNvbnN0IF9lbWl0ID0gZW1pdCB8fCAodm0gPT0gbnVsbCA/IHZvaWQgMCA6IHZtLmVtaXQpIHx8ICgoX2EgPSB2bSA9PSBudWxsID8gdm9pZCAwIDogdm0uJGVtaXQpID09IG51bGwgPyB2b2lkIDAgOiBfYS5iaW5kKHZtKSkgfHwgKChfYyA9IChfYiA9IHZtID09IG51bGwgPyB2b2lkIDAgOiB2bS5wcm94eSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9iLiRlbWl0KSA9PSBudWxsID8gdm9pZCAwIDogX2MuYmluZCh2bSA9PSBudWxsID8gdm9pZCAwIDogdm0ucHJveHkpKTtcbiAgbGV0IGV2ZW50ID0gZXZlbnROYW1lO1xuICBpZiAoIWtleSkge1xuICAgIGtleSA9IFwibW9kZWxWYWx1ZVwiO1xuICB9XG4gIGV2ZW50ID0gZXZlbnQgfHwgYHVwZGF0ZToke2tleS50b1N0cmluZygpfWA7XG4gIGNvbnN0IGNsb25lRm4gPSAodmFsKSA9PiAhY2xvbmUgPyB2YWwgOiB0eXBlb2YgY2xvbmUgPT09IFwiZnVuY3Rpb25cIiA/IGNsb25lKHZhbCkgOiBjbG9uZUZuSlNPTih2YWwpO1xuICBjb25zdCBnZXRWYWx1ZSA9ICgpID0+IGlzRGVmKHByb3BzW2tleV0pID8gY2xvbmVGbihwcm9wc1trZXldKSA6IGRlZmF1bHRWYWx1ZTtcbiAgY29uc3QgdHJpZ2dlckVtaXQgPSAodmFsdWUpID0+IHtcbiAgICBpZiAoc2hvdWxkRW1pdCkge1xuICAgICAgaWYgKHNob3VsZEVtaXQodmFsdWUpKVxuICAgICAgICBfZW1pdChldmVudCwgdmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBfZW1pdChldmVudCwgdmFsdWUpO1xuICAgIH1cbiAgfTtcbiAgaWYgKHBhc3NpdmUpIHtcbiAgICBjb25zdCBpbml0aWFsVmFsdWUgPSBnZXRWYWx1ZSgpO1xuICAgIGNvbnN0IHByb3h5ID0gcmVmKGluaXRpYWxWYWx1ZSk7XG4gICAgbGV0IGlzVXBkYXRpbmcgPSBmYWxzZTtcbiAgICB3YXRjaChcbiAgICAgICgpID0+IHByb3BzW2tleV0sXG4gICAgICAodikgPT4ge1xuICAgICAgICBpZiAoIWlzVXBkYXRpbmcpIHtcbiAgICAgICAgICBpc1VwZGF0aW5nID0gdHJ1ZTtcbiAgICAgICAgICBwcm94eS52YWx1ZSA9IGNsb25lRm4odik7XG4gICAgICAgICAgbmV4dFRpY2soKCkgPT4gaXNVcGRhdGluZyA9IGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gICAgd2F0Y2goXG4gICAgICBwcm94eSxcbiAgICAgICh2KSA9PiB7XG4gICAgICAgIGlmICghaXNVcGRhdGluZyAmJiAodiAhPT0gcHJvcHNba2V5XSB8fCBkZWVwKSlcbiAgICAgICAgICB0cmlnZ2VyRW1pdCh2KTtcbiAgICAgIH0sXG4gICAgICB7IGRlZXAgfVxuICAgICk7XG4gICAgcmV0dXJuIHByb3h5O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBjb21wdXRlZCh7XG4gICAgICBnZXQoKSB7XG4gICAgICAgIHJldHVybiBnZXRWYWx1ZSgpO1xuICAgICAgfSxcbiAgICAgIHNldCh2YWx1ZSkge1xuICAgICAgICB0cmlnZ2VyRW1pdCh2YWx1ZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZVZNb2RlbHMocHJvcHMsIGVtaXQsIG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCByZXQgPSB7fTtcbiAgZm9yIChjb25zdCBrZXkgaW4gcHJvcHMpIHtcbiAgICByZXRba2V5XSA9IHVzZVZNb2RlbChcbiAgICAgIHByb3BzLFxuICAgICAga2V5LFxuICAgICAgZW1pdCxcbiAgICAgIG9wdGlvbnNcbiAgICApO1xuICB9XG4gIHJldHVybiByZXQ7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VWaWJyYXRlKG9wdGlvbnMpIHtcbiAgY29uc3Qge1xuICAgIHBhdHRlcm4gPSBbXSxcbiAgICBpbnRlcnZhbCA9IDAsXG4gICAgbmF2aWdhdG9yID0gZGVmYXVsdE5hdmlnYXRvclxuICB9ID0gb3B0aW9ucyB8fCB7fTtcbiAgY29uc3QgaXNTdXBwb3J0ZWQgPSB1c2VTdXBwb3J0ZWQoKCkgPT4gdHlwZW9mIG5hdmlnYXRvciAhPT0gXCJ1bmRlZmluZWRcIiAmJiBcInZpYnJhdGVcIiBpbiBuYXZpZ2F0b3IpO1xuICBjb25zdCBwYXR0ZXJuUmVmID0gdG9SZWYocGF0dGVybik7XG4gIGxldCBpbnRlcnZhbENvbnRyb2xzO1xuICBjb25zdCB2aWJyYXRlID0gKHBhdHRlcm4yID0gcGF0dGVyblJlZi52YWx1ZSkgPT4ge1xuICAgIGlmIChpc1N1cHBvcnRlZC52YWx1ZSlcbiAgICAgIG5hdmlnYXRvci52aWJyYXRlKHBhdHRlcm4yKTtcbiAgfTtcbiAgY29uc3Qgc3RvcCA9ICgpID0+IHtcbiAgICBpZiAoaXNTdXBwb3J0ZWQudmFsdWUpXG4gICAgICBuYXZpZ2F0b3IudmlicmF0ZSgwKTtcbiAgICBpbnRlcnZhbENvbnRyb2xzID09IG51bGwgPyB2b2lkIDAgOiBpbnRlcnZhbENvbnRyb2xzLnBhdXNlKCk7XG4gIH07XG4gIGlmIChpbnRlcnZhbCA+IDApIHtcbiAgICBpbnRlcnZhbENvbnRyb2xzID0gdXNlSW50ZXJ2YWxGbihcbiAgICAgIHZpYnJhdGUsXG4gICAgICBpbnRlcnZhbCxcbiAgICAgIHtcbiAgICAgICAgaW1tZWRpYXRlOiBmYWxzZSxcbiAgICAgICAgaW1tZWRpYXRlQ2FsbGJhY2s6IGZhbHNlXG4gICAgICB9XG4gICAgKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIGlzU3VwcG9ydGVkLFxuICAgIHBhdHRlcm4sXG4gICAgaW50ZXJ2YWxDb250cm9scyxcbiAgICB2aWJyYXRlLFxuICAgIHN0b3BcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlVmlydHVhbExpc3QobGlzdCwgb3B0aW9ucykge1xuICBjb25zdCB7IGNvbnRhaW5lclN0eWxlLCB3cmFwcGVyUHJvcHMsIHNjcm9sbFRvLCBjYWxjdWxhdGVSYW5nZSwgY3VycmVudExpc3QsIGNvbnRhaW5lclJlZiB9ID0gXCJpdGVtSGVpZ2h0XCIgaW4gb3B0aW9ucyA/IHVzZVZlcnRpY2FsVmlydHVhbExpc3Qob3B0aW9ucywgbGlzdCkgOiB1c2VIb3Jpem9udGFsVmlydHVhbExpc3Qob3B0aW9ucywgbGlzdCk7XG4gIHJldHVybiB7XG4gICAgbGlzdDogY3VycmVudExpc3QsXG4gICAgc2Nyb2xsVG8sXG4gICAgY29udGFpbmVyUHJvcHM6IHtcbiAgICAgIHJlZjogY29udGFpbmVyUmVmLFxuICAgICAgb25TY3JvbGw6ICgpID0+IHtcbiAgICAgICAgY2FsY3VsYXRlUmFuZ2UoKTtcbiAgICAgIH0sXG4gICAgICBzdHlsZTogY29udGFpbmVyU3R5bGVcbiAgICB9LFxuICAgIHdyYXBwZXJQcm9wc1xuICB9O1xufVxuZnVuY3Rpb24gdXNlVmlydHVhbExpc3RSZXNvdXJjZXMobGlzdCkge1xuICBjb25zdCBjb250YWluZXJSZWYgPSBzaGFsbG93UmVmKG51bGwpO1xuICBjb25zdCBzaXplID0gdXNlRWxlbWVudFNpemUoY29udGFpbmVyUmVmKTtcbiAgY29uc3QgY3VycmVudExpc3QgPSByZWYoW10pO1xuICBjb25zdCBzb3VyY2UgPSBzaGFsbG93UmVmKGxpc3QpO1xuICBjb25zdCBzdGF0ZSA9IHJlZih7IHN0YXJ0OiAwLCBlbmQ6IDEwIH0pO1xuICByZXR1cm4geyBzdGF0ZSwgc291cmNlLCBjdXJyZW50TGlzdCwgc2l6ZSwgY29udGFpbmVyUmVmIH07XG59XG5mdW5jdGlvbiBjcmVhdGVHZXRWaWV3Q2FwYWNpdHkoc3RhdGUsIHNvdXJjZSwgaXRlbVNpemUpIHtcbiAgcmV0dXJuIChjb250YWluZXJTaXplKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBpdGVtU2l6ZSA9PT0gXCJudW1iZXJcIilcbiAgICAgIHJldHVybiBNYXRoLmNlaWwoY29udGFpbmVyU2l6ZSAvIGl0ZW1TaXplKTtcbiAgICBjb25zdCB7IHN0YXJ0ID0gMCB9ID0gc3RhdGUudmFsdWU7XG4gICAgbGV0IHN1bSA9IDA7XG4gICAgbGV0IGNhcGFjaXR5ID0gMDtcbiAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBzb3VyY2UudmFsdWUubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNpemUgPSBpdGVtU2l6ZShpKTtcbiAgICAgIHN1bSArPSBzaXplO1xuICAgICAgY2FwYWNpdHkgPSBpO1xuICAgICAgaWYgKHN1bSA+IGNvbnRhaW5lclNpemUpXG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gY2FwYWNpdHkgLSBzdGFydDtcbiAgfTtcbn1cbmZ1bmN0aW9uIGNyZWF0ZUdldE9mZnNldChzb3VyY2UsIGl0ZW1TaXplKSB7XG4gIHJldHVybiAoc2Nyb2xsRGlyZWN0aW9uKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBpdGVtU2l6ZSA9PT0gXCJudW1iZXJcIilcbiAgICAgIHJldHVybiBNYXRoLmZsb29yKHNjcm9sbERpcmVjdGlvbiAvIGl0ZW1TaXplKSArIDE7XG4gICAgbGV0IHN1bSA9IDA7XG4gICAgbGV0IG9mZnNldCA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzb3VyY2UudmFsdWUubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNpemUgPSBpdGVtU2l6ZShpKTtcbiAgICAgIHN1bSArPSBzaXplO1xuICAgICAgaWYgKHN1bSA+PSBzY3JvbGxEaXJlY3Rpb24pIHtcbiAgICAgICAgb2Zmc2V0ID0gaTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvZmZzZXQgKyAxO1xuICB9O1xufVxuZnVuY3Rpb24gY3JlYXRlQ2FsY3VsYXRlUmFuZ2UodHlwZSwgb3ZlcnNjYW4sIGdldE9mZnNldCwgZ2V0Vmlld0NhcGFjaXR5LCB7IGNvbnRhaW5lclJlZiwgc3RhdGUsIGN1cnJlbnRMaXN0LCBzb3VyY2UgfSkge1xuICByZXR1cm4gKCkgPT4ge1xuICAgIGNvbnN0IGVsZW1lbnQgPSBjb250YWluZXJSZWYudmFsdWU7XG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIGNvbnN0IG9mZnNldCA9IGdldE9mZnNldCh0eXBlID09PSBcInZlcnRpY2FsXCIgPyBlbGVtZW50LnNjcm9sbFRvcCA6IGVsZW1lbnQuc2Nyb2xsTGVmdCk7XG4gICAgICBjb25zdCB2aWV3Q2FwYWNpdHkgPSBnZXRWaWV3Q2FwYWNpdHkodHlwZSA9PT0gXCJ2ZXJ0aWNhbFwiID8gZWxlbWVudC5jbGllbnRIZWlnaHQgOiBlbGVtZW50LmNsaWVudFdpZHRoKTtcbiAgICAgIGNvbnN0IGZyb20gPSBvZmZzZXQgLSBvdmVyc2NhbjtcbiAgICAgIGNvbnN0IHRvID0gb2Zmc2V0ICsgdmlld0NhcGFjaXR5ICsgb3ZlcnNjYW47XG4gICAgICBzdGF0ZS52YWx1ZSA9IHtcbiAgICAgICAgc3RhcnQ6IGZyb20gPCAwID8gMCA6IGZyb20sXG4gICAgICAgIGVuZDogdG8gPiBzb3VyY2UudmFsdWUubGVuZ3RoID8gc291cmNlLnZhbHVlLmxlbmd0aCA6IHRvXG4gICAgICB9O1xuICAgICAgY3VycmVudExpc3QudmFsdWUgPSBzb3VyY2UudmFsdWUuc2xpY2Uoc3RhdGUudmFsdWUuc3RhcnQsIHN0YXRlLnZhbHVlLmVuZCkubWFwKChlbGUsIGluZGV4KSA9PiAoe1xuICAgICAgICBkYXRhOiBlbGUsXG4gICAgICAgIGluZGV4OiBpbmRleCArIHN0YXRlLnZhbHVlLnN0YXJ0XG4gICAgICB9KSk7XG4gICAgfVxuICB9O1xufVxuZnVuY3Rpb24gY3JlYXRlR2V0RGlzdGFuY2UoaXRlbVNpemUsIHNvdXJjZSkge1xuICByZXR1cm4gKGluZGV4KSA9PiB7XG4gICAgaWYgKHR5cGVvZiBpdGVtU2l6ZSA9PT0gXCJudW1iZXJcIikge1xuICAgICAgY29uc3Qgc2l6ZTIgPSBpbmRleCAqIGl0ZW1TaXplO1xuICAgICAgcmV0dXJuIHNpemUyO1xuICAgIH1cbiAgICBjb25zdCBzaXplID0gc291cmNlLnZhbHVlLnNsaWNlKDAsIGluZGV4KS5yZWR1Y2UoKHN1bSwgXywgaSkgPT4gc3VtICsgaXRlbVNpemUoaSksIDApO1xuICAgIHJldHVybiBzaXplO1xuICB9O1xufVxuZnVuY3Rpb24gdXNlV2F0Y2hGb3JTaXplcyhzaXplLCBsaXN0LCBjb250YWluZXJSZWYsIGNhbGN1bGF0ZVJhbmdlKSB7XG4gIHdhdGNoKFtzaXplLndpZHRoLCBzaXplLmhlaWdodCwgKCkgPT4gdG9WYWx1ZShsaXN0KSwgY29udGFpbmVyUmVmXSwgKCkgPT4ge1xuICAgIGNhbGN1bGF0ZVJhbmdlKCk7XG4gIH0pO1xufVxuZnVuY3Rpb24gY3JlYXRlQ29tcHV0ZWRUb3RhbFNpemUoaXRlbVNpemUsIHNvdXJjZSkge1xuICByZXR1cm4gY29tcHV0ZWQoKCkgPT4ge1xuICAgIGlmICh0eXBlb2YgaXRlbVNpemUgPT09IFwibnVtYmVyXCIpXG4gICAgICByZXR1cm4gc291cmNlLnZhbHVlLmxlbmd0aCAqIGl0ZW1TaXplO1xuICAgIHJldHVybiBzb3VyY2UudmFsdWUucmVkdWNlKChzdW0sIF8sIGluZGV4KSA9PiBzdW0gKyBpdGVtU2l6ZShpbmRleCksIDApO1xuICB9KTtcbn1cbmNvbnN0IHNjcm9sbFRvRGljdGlvbmFyeUZvckVsZW1lbnRTY3JvbGxLZXkgPSB7XG4gIGhvcml6b250YWw6IFwic2Nyb2xsTGVmdFwiLFxuICB2ZXJ0aWNhbDogXCJzY3JvbGxUb3BcIlxufTtcbmZ1bmN0aW9uIGNyZWF0ZVNjcm9sbFRvKHR5cGUsIGNhbGN1bGF0ZVJhbmdlLCBnZXREaXN0YW5jZSwgY29udGFpbmVyUmVmKSB7XG4gIHJldHVybiAoaW5kZXgpID0+IHtcbiAgICBpZiAoY29udGFpbmVyUmVmLnZhbHVlKSB7XG4gICAgICBjb250YWluZXJSZWYudmFsdWVbc2Nyb2xsVG9EaWN0aW9uYXJ5Rm9yRWxlbWVudFNjcm9sbEtleVt0eXBlXV0gPSBnZXREaXN0YW5jZShpbmRleCk7XG4gICAgICBjYWxjdWxhdGVSYW5nZSgpO1xuICAgIH1cbiAgfTtcbn1cbmZ1bmN0aW9uIHVzZUhvcml6b250YWxWaXJ0dWFsTGlzdChvcHRpb25zLCBsaXN0KSB7XG4gIGNvbnN0IHJlc291cmNlcyA9IHVzZVZpcnR1YWxMaXN0UmVzb3VyY2VzKGxpc3QpO1xuICBjb25zdCB7IHN0YXRlLCBzb3VyY2UsIGN1cnJlbnRMaXN0LCBzaXplLCBjb250YWluZXJSZWYgfSA9IHJlc291cmNlcztcbiAgY29uc3QgY29udGFpbmVyU3R5bGUgPSB7IG92ZXJmbG93WDogXCJhdXRvXCIgfTtcbiAgY29uc3QgeyBpdGVtV2lkdGgsIG92ZXJzY2FuID0gNSB9ID0gb3B0aW9ucztcbiAgY29uc3QgZ2V0Vmlld0NhcGFjaXR5ID0gY3JlYXRlR2V0Vmlld0NhcGFjaXR5KHN0YXRlLCBzb3VyY2UsIGl0ZW1XaWR0aCk7XG4gIGNvbnN0IGdldE9mZnNldCA9IGNyZWF0ZUdldE9mZnNldChzb3VyY2UsIGl0ZW1XaWR0aCk7XG4gIGNvbnN0IGNhbGN1bGF0ZVJhbmdlID0gY3JlYXRlQ2FsY3VsYXRlUmFuZ2UoXCJob3Jpem9udGFsXCIsIG92ZXJzY2FuLCBnZXRPZmZzZXQsIGdldFZpZXdDYXBhY2l0eSwgcmVzb3VyY2VzKTtcbiAgY29uc3QgZ2V0RGlzdGFuY2VMZWZ0ID0gY3JlYXRlR2V0RGlzdGFuY2UoaXRlbVdpZHRoLCBzb3VyY2UpO1xuICBjb25zdCBvZmZzZXRMZWZ0ID0gY29tcHV0ZWQoKCkgPT4gZ2V0RGlzdGFuY2VMZWZ0KHN0YXRlLnZhbHVlLnN0YXJ0KSk7XG4gIGNvbnN0IHRvdGFsV2lkdGggPSBjcmVhdGVDb21wdXRlZFRvdGFsU2l6ZShpdGVtV2lkdGgsIHNvdXJjZSk7XG4gIHVzZVdhdGNoRm9yU2l6ZXMoc2l6ZSwgbGlzdCwgY29udGFpbmVyUmVmLCBjYWxjdWxhdGVSYW5nZSk7XG4gIGNvbnN0IHNjcm9sbFRvID0gY3JlYXRlU2Nyb2xsVG8oXCJob3Jpem9udGFsXCIsIGNhbGN1bGF0ZVJhbmdlLCBnZXREaXN0YW5jZUxlZnQsIGNvbnRhaW5lclJlZik7XG4gIGNvbnN0IHdyYXBwZXJQcm9wcyA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgc3R5bGU6IHtcbiAgICAgICAgaGVpZ2h0OiBcIjEwMCVcIixcbiAgICAgICAgd2lkdGg6IGAke3RvdGFsV2lkdGgudmFsdWUgLSBvZmZzZXRMZWZ0LnZhbHVlfXB4YCxcbiAgICAgICAgbWFyZ2luTGVmdDogYCR7b2Zmc2V0TGVmdC52YWx1ZX1weGAsXG4gICAgICAgIGRpc3BsYXk6IFwiZmxleFwiXG4gICAgICB9XG4gICAgfTtcbiAgfSk7XG4gIHJldHVybiB7XG4gICAgc2Nyb2xsVG8sXG4gICAgY2FsY3VsYXRlUmFuZ2UsXG4gICAgd3JhcHBlclByb3BzLFxuICAgIGNvbnRhaW5lclN0eWxlLFxuICAgIGN1cnJlbnRMaXN0LFxuICAgIGNvbnRhaW5lclJlZlxuICB9O1xufVxuZnVuY3Rpb24gdXNlVmVydGljYWxWaXJ0dWFsTGlzdChvcHRpb25zLCBsaXN0KSB7XG4gIGNvbnN0IHJlc291cmNlcyA9IHVzZVZpcnR1YWxMaXN0UmVzb3VyY2VzKGxpc3QpO1xuICBjb25zdCB7IHN0YXRlLCBzb3VyY2UsIGN1cnJlbnRMaXN0LCBzaXplLCBjb250YWluZXJSZWYgfSA9IHJlc291cmNlcztcbiAgY29uc3QgY29udGFpbmVyU3R5bGUgPSB7IG92ZXJmbG93WTogXCJhdXRvXCIgfTtcbiAgY29uc3QgeyBpdGVtSGVpZ2h0LCBvdmVyc2NhbiA9IDUgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGdldFZpZXdDYXBhY2l0eSA9IGNyZWF0ZUdldFZpZXdDYXBhY2l0eShzdGF0ZSwgc291cmNlLCBpdGVtSGVpZ2h0KTtcbiAgY29uc3QgZ2V0T2Zmc2V0ID0gY3JlYXRlR2V0T2Zmc2V0KHNvdXJjZSwgaXRlbUhlaWdodCk7XG4gIGNvbnN0IGNhbGN1bGF0ZVJhbmdlID0gY3JlYXRlQ2FsY3VsYXRlUmFuZ2UoXCJ2ZXJ0aWNhbFwiLCBvdmVyc2NhbiwgZ2V0T2Zmc2V0LCBnZXRWaWV3Q2FwYWNpdHksIHJlc291cmNlcyk7XG4gIGNvbnN0IGdldERpc3RhbmNlVG9wID0gY3JlYXRlR2V0RGlzdGFuY2UoaXRlbUhlaWdodCwgc291cmNlKTtcbiAgY29uc3Qgb2Zmc2V0VG9wID0gY29tcHV0ZWQoKCkgPT4gZ2V0RGlzdGFuY2VUb3Aoc3RhdGUudmFsdWUuc3RhcnQpKTtcbiAgY29uc3QgdG90YWxIZWlnaHQgPSBjcmVhdGVDb21wdXRlZFRvdGFsU2l6ZShpdGVtSGVpZ2h0LCBzb3VyY2UpO1xuICB1c2VXYXRjaEZvclNpemVzKHNpemUsIGxpc3QsIGNvbnRhaW5lclJlZiwgY2FsY3VsYXRlUmFuZ2UpO1xuICBjb25zdCBzY3JvbGxUbyA9IGNyZWF0ZVNjcm9sbFRvKFwidmVydGljYWxcIiwgY2FsY3VsYXRlUmFuZ2UsIGdldERpc3RhbmNlVG9wLCBjb250YWluZXJSZWYpO1xuICBjb25zdCB3cmFwcGVyUHJvcHMgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0eWxlOiB7XG4gICAgICAgIHdpZHRoOiBcIjEwMCVcIixcbiAgICAgICAgaGVpZ2h0OiBgJHt0b3RhbEhlaWdodC52YWx1ZSAtIG9mZnNldFRvcC52YWx1ZX1weGAsXG4gICAgICAgIG1hcmdpblRvcDogYCR7b2Zmc2V0VG9wLnZhbHVlfXB4YFxuICAgICAgfVxuICAgIH07XG4gIH0pO1xuICByZXR1cm4ge1xuICAgIGNhbGN1bGF0ZVJhbmdlLFxuICAgIHNjcm9sbFRvLFxuICAgIGNvbnRhaW5lclN0eWxlLFxuICAgIHdyYXBwZXJQcm9wcyxcbiAgICBjdXJyZW50TGlzdCxcbiAgICBjb250YWluZXJSZWZcbiAgfTtcbn1cblxuLy8gQF9fTk9fU0lERV9FRkZFQ1RTX19cbmZ1bmN0aW9uIHVzZVdha2VMb2NrKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgbmF2aWdhdG9yID0gZGVmYXVsdE5hdmlnYXRvcixcbiAgICBkb2N1bWVudCA9IGRlZmF1bHREb2N1bWVudFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgcmVxdWVzdGVkVHlwZSA9IHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBzZW50aW5lbCA9IHNoYWxsb3dSZWYobnVsbCk7XG4gIGNvbnN0IGRvY3VtZW50VmlzaWJpbGl0eSA9IHVzZURvY3VtZW50VmlzaWJpbGl0eSh7IGRvY3VtZW50IH0pO1xuICBjb25zdCBpc1N1cHBvcnRlZCA9IHVzZVN1cHBvcnRlZCgoKSA9PiBuYXZpZ2F0b3IgJiYgXCJ3YWtlTG9ja1wiIGluIG5hdmlnYXRvcik7XG4gIGNvbnN0IGlzQWN0aXZlID0gY29tcHV0ZWQoKCkgPT4gISFzZW50aW5lbC52YWx1ZSAmJiBkb2N1bWVudFZpc2liaWxpdHkudmFsdWUgPT09IFwidmlzaWJsZVwiKTtcbiAgaWYgKGlzU3VwcG9ydGVkLnZhbHVlKSB7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcihzZW50aW5lbCwgXCJyZWxlYXNlXCIsICgpID0+IHtcbiAgICAgIHZhciBfYSwgX2I7XG4gICAgICByZXF1ZXN0ZWRUeXBlLnZhbHVlID0gKF9iID0gKF9hID0gc2VudGluZWwudmFsdWUpID09IG51bGwgPyB2b2lkIDAgOiBfYS50eXBlKSAhPSBudWxsID8gX2IgOiBmYWxzZTtcbiAgICB9LCB7IHBhc3NpdmU6IHRydWUgfSk7XG4gICAgd2hlbmV2ZXIoXG4gICAgICAoKSA9PiBkb2N1bWVudFZpc2liaWxpdHkudmFsdWUgPT09IFwidmlzaWJsZVwiICYmIChkb2N1bWVudCA9PSBudWxsID8gdm9pZCAwIDogZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlKSA9PT0gXCJ2aXNpYmxlXCIgJiYgcmVxdWVzdGVkVHlwZS52YWx1ZSxcbiAgICAgICh0eXBlKSA9PiB7XG4gICAgICAgIHJlcXVlc3RlZFR5cGUudmFsdWUgPSBmYWxzZTtcbiAgICAgICAgZm9yY2VSZXF1ZXN0KHR5cGUpO1xuICAgICAgfVxuICAgICk7XG4gIH1cbiAgYXN5bmMgZnVuY3Rpb24gZm9yY2VSZXF1ZXN0KHR5cGUpIHtcbiAgICB2YXIgX2E7XG4gICAgYXdhaXQgKChfYSA9IHNlbnRpbmVsLnZhbHVlKSA9PSBudWxsID8gdm9pZCAwIDogX2EucmVsZWFzZSgpKTtcbiAgICBzZW50aW5lbC52YWx1ZSA9IGlzU3VwcG9ydGVkLnZhbHVlID8gYXdhaXQgbmF2aWdhdG9yLndha2VMb2NrLnJlcXVlc3QodHlwZSkgOiBudWxsO1xuICB9XG4gIGFzeW5jIGZ1bmN0aW9uIHJlcXVlc3QodHlwZSkge1xuICAgIGlmIChkb2N1bWVudFZpc2liaWxpdHkudmFsdWUgPT09IFwidmlzaWJsZVwiKVxuICAgICAgYXdhaXQgZm9yY2VSZXF1ZXN0KHR5cGUpO1xuICAgIGVsc2VcbiAgICAgIHJlcXVlc3RlZFR5cGUudmFsdWUgPSB0eXBlO1xuICB9XG4gIGFzeW5jIGZ1bmN0aW9uIHJlbGVhc2UoKSB7XG4gICAgcmVxdWVzdGVkVHlwZS52YWx1ZSA9IGZhbHNlO1xuICAgIGNvbnN0IHMgPSBzZW50aW5lbC52YWx1ZTtcbiAgICBzZW50aW5lbC52YWx1ZSA9IG51bGw7XG4gICAgYXdhaXQgKHMgPT0gbnVsbCA/IHZvaWQgMCA6IHMucmVsZWFzZSgpKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIHNlbnRpbmVsLFxuICAgIGlzU3VwcG9ydGVkLFxuICAgIGlzQWN0aXZlLFxuICAgIHJlcXVlc3QsXG4gICAgZm9yY2VSZXF1ZXN0LFxuICAgIHJlbGVhc2VcbiAgfTtcbn1cblxuZnVuY3Rpb24gdXNlV2ViTm90aWZpY2F0aW9uKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgd2luZG93ID0gZGVmYXVsdFdpbmRvdyxcbiAgICByZXF1ZXN0UGVybWlzc2lvbnM6IF9yZXF1ZXN0Rm9yUGVybWlzc2lvbnMgPSB0cnVlXG4gIH0gPSBvcHRpb25zO1xuICBjb25zdCBkZWZhdWx0V2ViTm90aWZpY2F0aW9uT3B0aW9ucyA9IG9wdGlvbnM7XG4gIGNvbnN0IGlzU3VwcG9ydGVkID0gdXNlU3VwcG9ydGVkKCgpID0+IHtcbiAgICBpZiAoIXdpbmRvdyB8fCAhKFwiTm90aWZpY2F0aW9uXCIgaW4gd2luZG93KSlcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICBpZiAoTm90aWZpY2F0aW9uLnBlcm1pc3Npb24gPT09IFwiZ3JhbnRlZFwiKVxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbjIgPSBuZXcgTm90aWZpY2F0aW9uKFwiXCIpO1xuICAgICAgbm90aWZpY2F0aW9uMi5vbnNob3cgPSAoKSA9PiB7XG4gICAgICAgIG5vdGlmaWNhdGlvbjIuY2xvc2UoKTtcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUubmFtZSA9PT0gXCJUeXBlRXJyb3JcIilcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSk7XG4gIGNvbnN0IHBlcm1pc3Npb25HcmFudGVkID0gc2hhbGxvd1JlZihpc1N1cHBvcnRlZC52YWx1ZSAmJiBcInBlcm1pc3Npb25cIiBpbiBOb3RpZmljYXRpb24gJiYgTm90aWZpY2F0aW9uLnBlcm1pc3Npb24gPT09IFwiZ3JhbnRlZFwiKTtcbiAgY29uc3Qgbm90aWZpY2F0aW9uID0gcmVmKG51bGwpO1xuICBjb25zdCBlbnN1cmVQZXJtaXNzaW9ucyA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoIWlzU3VwcG9ydGVkLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIGlmICghcGVybWlzc2lvbkdyYW50ZWQudmFsdWUgJiYgTm90aWZpY2F0aW9uLnBlcm1pc3Npb24gIT09IFwiZGVuaWVkXCIpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IE5vdGlmaWNhdGlvbi5yZXF1ZXN0UGVybWlzc2lvbigpO1xuICAgICAgaWYgKHJlc3VsdCA9PT0gXCJncmFudGVkXCIpXG4gICAgICAgIHBlcm1pc3Npb25HcmFudGVkLnZhbHVlID0gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHBlcm1pc3Npb25HcmFudGVkLnZhbHVlO1xuICB9O1xuICBjb25zdCB7IG9uOiBvbkNsaWNrLCB0cmlnZ2VyOiBjbGlja1RyaWdnZXIgfSA9IGNyZWF0ZUV2ZW50SG9vaygpO1xuICBjb25zdCB7IG9uOiBvblNob3csIHRyaWdnZXI6IHNob3dUcmlnZ2VyIH0gPSBjcmVhdGVFdmVudEhvb2soKTtcbiAgY29uc3QgeyBvbjogb25FcnJvciwgdHJpZ2dlcjogZXJyb3JUcmlnZ2VyIH0gPSBjcmVhdGVFdmVudEhvb2soKTtcbiAgY29uc3QgeyBvbjogb25DbG9zZSwgdHJpZ2dlcjogY2xvc2VUcmlnZ2VyIH0gPSBjcmVhdGVFdmVudEhvb2soKTtcbiAgY29uc3Qgc2hvdyA9IGFzeW5jIChvdmVycmlkZXMpID0+IHtcbiAgICBpZiAoIWlzU3VwcG9ydGVkLnZhbHVlIHx8ICFwZXJtaXNzaW9uR3JhbnRlZC52YWx1ZSlcbiAgICAgIHJldHVybjtcbiAgICBjb25zdCBvcHRpb25zMiA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRXZWJOb3RpZmljYXRpb25PcHRpb25zLCBvdmVycmlkZXMpO1xuICAgIG5vdGlmaWNhdGlvbi52YWx1ZSA9IG5ldyBOb3RpZmljYXRpb24ob3B0aW9uczIudGl0bGUgfHwgXCJcIiwgb3B0aW9uczIpO1xuICAgIG5vdGlmaWNhdGlvbi52YWx1ZS5vbmNsaWNrID0gY2xpY2tUcmlnZ2VyO1xuICAgIG5vdGlmaWNhdGlvbi52YWx1ZS5vbnNob3cgPSBzaG93VHJpZ2dlcjtcbiAgICBub3RpZmljYXRpb24udmFsdWUub25lcnJvciA9IGVycm9yVHJpZ2dlcjtcbiAgICBub3RpZmljYXRpb24udmFsdWUub25jbG9zZSA9IGNsb3NlVHJpZ2dlcjtcbiAgICByZXR1cm4gbm90aWZpY2F0aW9uLnZhbHVlO1xuICB9O1xuICBjb25zdCBjbG9zZSA9ICgpID0+IHtcbiAgICBpZiAobm90aWZpY2F0aW9uLnZhbHVlKVxuICAgICAgbm90aWZpY2F0aW9uLnZhbHVlLmNsb3NlKCk7XG4gICAgbm90aWZpY2F0aW9uLnZhbHVlID0gbnVsbDtcbiAgfTtcbiAgaWYgKF9yZXF1ZXN0Rm9yUGVybWlzc2lvbnMpXG4gICAgdHJ5T25Nb3VudGVkKGVuc3VyZVBlcm1pc3Npb25zKTtcbiAgdHJ5T25TY29wZURpc3Bvc2UoY2xvc2UpO1xuICBpZiAoaXNTdXBwb3J0ZWQudmFsdWUgJiYgd2luZG93KSB7XG4gICAgY29uc3QgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcihkb2N1bWVudCwgXCJ2aXNpYmlsaXR5Y2hhbmdlXCIsIChlKSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBpZiAoZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlID09PSBcInZpc2libGVcIikge1xuICAgICAgICBjbG9zZSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIHJldHVybiB7XG4gICAgaXNTdXBwb3J0ZWQsXG4gICAgbm90aWZpY2F0aW9uLFxuICAgIGVuc3VyZVBlcm1pc3Npb25zLFxuICAgIHBlcm1pc3Npb25HcmFudGVkLFxuICAgIHNob3csXG4gICAgY2xvc2UsXG4gICAgb25DbGljayxcbiAgICBvblNob3csXG4gICAgb25FcnJvcixcbiAgICBvbkNsb3NlXG4gIH07XG59XG5cbmNvbnN0IERFRkFVTFRfUElOR19NRVNTQUdFID0gXCJwaW5nXCI7XG5mdW5jdGlvbiByZXNvbHZlTmVzdGVkT3B0aW9ucyhvcHRpb25zKSB7XG4gIGlmIChvcHRpb25zID09PSB0cnVlKVxuICAgIHJldHVybiB7fTtcbiAgcmV0dXJuIG9wdGlvbnM7XG59XG5mdW5jdGlvbiB1c2VXZWJTb2NrZXQodXJsLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIG9uQ29ubmVjdGVkLFxuICAgIG9uRGlzY29ubmVjdGVkLFxuICAgIG9uRXJyb3IsXG4gICAgb25NZXNzYWdlLFxuICAgIGltbWVkaWF0ZSA9IHRydWUsXG4gICAgYXV0b0Nvbm5lY3QgPSB0cnVlLFxuICAgIGF1dG9DbG9zZSA9IHRydWUsXG4gICAgcHJvdG9jb2xzID0gW11cbiAgfSA9IG9wdGlvbnM7XG4gIGNvbnN0IGRhdGEgPSByZWYobnVsbCk7XG4gIGNvbnN0IHN0YXR1cyA9IHNoYWxsb3dSZWYoXCJDTE9TRURcIik7XG4gIGNvbnN0IHdzUmVmID0gcmVmKCk7XG4gIGNvbnN0IHVybFJlZiA9IHRvUmVmKHVybCk7XG4gIGxldCBoZWFydGJlYXRQYXVzZTtcbiAgbGV0IGhlYXJ0YmVhdFJlc3VtZTtcbiAgbGV0IGV4cGxpY2l0bHlDbG9zZWQgPSBmYWxzZTtcbiAgbGV0IHJldHJpZWQgPSAwO1xuICBsZXQgYnVmZmVyZWREYXRhID0gW107XG4gIGxldCByZXRyeVRpbWVvdXQ7XG4gIGxldCBwb25nVGltZW91dFdhaXQ7XG4gIGNvbnN0IF9zZW5kQnVmZmVyID0gKCkgPT4ge1xuICAgIGlmIChidWZmZXJlZERhdGEubGVuZ3RoICYmIHdzUmVmLnZhbHVlICYmIHN0YXR1cy52YWx1ZSA9PT0gXCJPUEVOXCIpIHtcbiAgICAgIGZvciAoY29uc3QgYnVmZmVyIG9mIGJ1ZmZlcmVkRGF0YSlcbiAgICAgICAgd3NSZWYudmFsdWUuc2VuZChidWZmZXIpO1xuICAgICAgYnVmZmVyZWREYXRhID0gW107XG4gICAgfVxuICB9O1xuICBjb25zdCByZXNldFJldHJ5ID0gKCkgPT4ge1xuICAgIGlmIChyZXRyeVRpbWVvdXQgIT0gbnVsbCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHJldHJ5VGltZW91dCk7XG4gICAgICByZXRyeVRpbWVvdXQgPSB2b2lkIDA7XG4gICAgfVxuICB9O1xuICBjb25zdCByZXNldEhlYXJ0YmVhdCA9ICgpID0+IHtcbiAgICBjbGVhclRpbWVvdXQocG9uZ1RpbWVvdXRXYWl0KTtcbiAgICBwb25nVGltZW91dFdhaXQgPSB2b2lkIDA7XG4gIH07XG4gIGNvbnN0IGNsb3NlID0gKGNvZGUgPSAxZTMsIHJlYXNvbikgPT4ge1xuICAgIHJlc2V0UmV0cnkoKTtcbiAgICBpZiAoIWlzQ2xpZW50ICYmICFpc1dvcmtlciB8fCAhd3NSZWYudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgZXhwbGljaXRseUNsb3NlZCA9IHRydWU7XG4gICAgcmVzZXRIZWFydGJlYXQoKTtcbiAgICBoZWFydGJlYXRQYXVzZSA9PSBudWxsID8gdm9pZCAwIDogaGVhcnRiZWF0UGF1c2UoKTtcbiAgICB3c1JlZi52YWx1ZS5jbG9zZShjb2RlLCByZWFzb24pO1xuICAgIHdzUmVmLnZhbHVlID0gdm9pZCAwO1xuICB9O1xuICBjb25zdCBzZW5kID0gKGRhdGEyLCB1c2VCdWZmZXIgPSB0cnVlKSA9PiB7XG4gICAgaWYgKCF3c1JlZi52YWx1ZSB8fCBzdGF0dXMudmFsdWUgIT09IFwiT1BFTlwiKSB7XG4gICAgICBpZiAodXNlQnVmZmVyKVxuICAgICAgICBidWZmZXJlZERhdGEucHVzaChkYXRhMik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIF9zZW5kQnVmZmVyKCk7XG4gICAgd3NSZWYudmFsdWUuc2VuZChkYXRhMik7XG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG4gIGNvbnN0IF9pbml0ID0gKCkgPT4ge1xuICAgIGlmIChleHBsaWNpdGx5Q2xvc2VkIHx8IHR5cGVvZiB1cmxSZWYudmFsdWUgPT09IFwidW5kZWZpbmVkXCIpXG4gICAgICByZXR1cm47XG4gICAgY29uc3Qgd3MgPSBuZXcgV2ViU29ja2V0KHVybFJlZi52YWx1ZSwgcHJvdG9jb2xzKTtcbiAgICB3c1JlZi52YWx1ZSA9IHdzO1xuICAgIHN0YXR1cy52YWx1ZSA9IFwiQ09OTkVDVElOR1wiO1xuICAgIHdzLm9ub3BlbiA9ICgpID0+IHtcbiAgICAgIHN0YXR1cy52YWx1ZSA9IFwiT1BFTlwiO1xuICAgICAgcmV0cmllZCA9IDA7XG4gICAgICBvbkNvbm5lY3RlZCA9PSBudWxsID8gdm9pZCAwIDogb25Db25uZWN0ZWQod3MpO1xuICAgICAgaGVhcnRiZWF0UmVzdW1lID09IG51bGwgPyB2b2lkIDAgOiBoZWFydGJlYXRSZXN1bWUoKTtcbiAgICAgIF9zZW5kQnVmZmVyKCk7XG4gICAgfTtcbiAgICB3cy5vbmNsb3NlID0gKGV2KSA9PiB7XG4gICAgICBzdGF0dXMudmFsdWUgPSBcIkNMT1NFRFwiO1xuICAgICAgcmVzZXRIZWFydGJlYXQoKTtcbiAgICAgIGhlYXJ0YmVhdFBhdXNlID09IG51bGwgPyB2b2lkIDAgOiBoZWFydGJlYXRQYXVzZSgpO1xuICAgICAgb25EaXNjb25uZWN0ZWQgPT0gbnVsbCA/IHZvaWQgMCA6IG9uRGlzY29ubmVjdGVkKHdzLCBldik7XG4gICAgICBpZiAoIWV4cGxpY2l0bHlDbG9zZWQgJiYgb3B0aW9ucy5hdXRvUmVjb25uZWN0ICYmICh3c1JlZi52YWx1ZSA9PSBudWxsIHx8IHdzID09PSB3c1JlZi52YWx1ZSkpIHtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIHJldHJpZXMgPSAtMSxcbiAgICAgICAgICBkZWxheSA9IDFlMyxcbiAgICAgICAgICBvbkZhaWxlZFxuICAgICAgICB9ID0gcmVzb2x2ZU5lc3RlZE9wdGlvbnMob3B0aW9ucy5hdXRvUmVjb25uZWN0KTtcbiAgICAgICAgY29uc3QgY2hlY2tSZXRpcmVzID0gdHlwZW9mIHJldHJpZXMgPT09IFwiZnVuY3Rpb25cIiA/IHJldHJpZXMgOiAoKSA9PiB0eXBlb2YgcmV0cmllcyA9PT0gXCJudW1iZXJcIiAmJiAocmV0cmllcyA8IDAgfHwgcmV0cmllZCA8IHJldHJpZXMpO1xuICAgICAgICBpZiAoY2hlY2tSZXRpcmVzKHJldHJpZWQpKSB7XG4gICAgICAgICAgcmV0cmllZCArPSAxO1xuICAgICAgICAgIHJldHJ5VGltZW91dCA9IHNldFRpbWVvdXQoX2luaXQsIGRlbGF5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvbkZhaWxlZCA9PSBudWxsID8gdm9pZCAwIDogb25GYWlsZWQoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gICAgd3Mub25lcnJvciA9IChlKSA9PiB7XG4gICAgICBvbkVycm9yID09IG51bGwgPyB2b2lkIDAgOiBvbkVycm9yKHdzLCBlKTtcbiAgICB9O1xuICAgIHdzLm9ubWVzc2FnZSA9IChlKSA9PiB7XG4gICAgICBpZiAob3B0aW9ucy5oZWFydGJlYXQpIHtcbiAgICAgICAgcmVzZXRIZWFydGJlYXQoKTtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIG1lc3NhZ2UgPSBERUZBVUxUX1BJTkdfTUVTU0FHRSxcbiAgICAgICAgICByZXNwb25zZU1lc3NhZ2UgPSBtZXNzYWdlXG4gICAgICAgIH0gPSByZXNvbHZlTmVzdGVkT3B0aW9ucyhvcHRpb25zLmhlYXJ0YmVhdCk7XG4gICAgICAgIGlmIChlLmRhdGEgPT09IHRvVmFsdWUocmVzcG9uc2VNZXNzYWdlKSlcbiAgICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBkYXRhLnZhbHVlID0gZS5kYXRhO1xuICAgICAgb25NZXNzYWdlID09IG51bGwgPyB2b2lkIDAgOiBvbk1lc3NhZ2Uod3MsIGUpO1xuICAgIH07XG4gIH07XG4gIGlmIChvcHRpb25zLmhlYXJ0YmVhdCkge1xuICAgIGNvbnN0IHtcbiAgICAgIG1lc3NhZ2UgPSBERUZBVUxUX1BJTkdfTUVTU0FHRSxcbiAgICAgIGludGVydmFsID0gMWUzLFxuICAgICAgcG9uZ1RpbWVvdXQgPSAxZTNcbiAgICB9ID0gcmVzb2x2ZU5lc3RlZE9wdGlvbnMob3B0aW9ucy5oZWFydGJlYXQpO1xuICAgIGNvbnN0IHsgcGF1c2UsIHJlc3VtZSB9ID0gdXNlSW50ZXJ2YWxGbihcbiAgICAgICgpID0+IHtcbiAgICAgICAgc2VuZCh0b1ZhbHVlKG1lc3NhZ2UpLCBmYWxzZSk7XG4gICAgICAgIGlmIChwb25nVGltZW91dFdhaXQgIT0gbnVsbClcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIHBvbmdUaW1lb3V0V2FpdCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGNsb3NlKCk7XG4gICAgICAgICAgZXhwbGljaXRseUNsb3NlZCA9IGZhbHNlO1xuICAgICAgICB9LCBwb25nVGltZW91dCk7XG4gICAgICB9LFxuICAgICAgaW50ZXJ2YWwsXG4gICAgICB7IGltbWVkaWF0ZTogZmFsc2UgfVxuICAgICk7XG4gICAgaGVhcnRiZWF0UGF1c2UgPSBwYXVzZTtcbiAgICBoZWFydGJlYXRSZXN1bWUgPSByZXN1bWU7XG4gIH1cbiAgaWYgKGF1dG9DbG9zZSkge1xuICAgIGlmIChpc0NsaWVudClcbiAgICAgIHVzZUV2ZW50TGlzdGVuZXIoXCJiZWZvcmV1bmxvYWRcIiwgKCkgPT4gY2xvc2UoKSwgeyBwYXNzaXZlOiB0cnVlIH0pO1xuICAgIHRyeU9uU2NvcGVEaXNwb3NlKGNsb3NlKTtcbiAgfVxuICBjb25zdCBvcGVuID0gKCkgPT4ge1xuICAgIGlmICghaXNDbGllbnQgJiYgIWlzV29ya2VyKVxuICAgICAgcmV0dXJuO1xuICAgIGNsb3NlKCk7XG4gICAgZXhwbGljaXRseUNsb3NlZCA9IGZhbHNlO1xuICAgIHJldHJpZWQgPSAwO1xuICAgIF9pbml0KCk7XG4gIH07XG4gIGlmIChpbW1lZGlhdGUpXG4gICAgb3BlbigpO1xuICBpZiAoYXV0b0Nvbm5lY3QpXG4gICAgd2F0Y2godXJsUmVmLCBvcGVuKTtcbiAgcmV0dXJuIHtcbiAgICBkYXRhLFxuICAgIHN0YXR1cyxcbiAgICBjbG9zZSxcbiAgICBzZW5kLFxuICAgIG9wZW4sXG4gICAgd3M6IHdzUmVmXG4gIH07XG59XG5cbmZ1bmN0aW9uIHVzZVdlYldvcmtlcihhcmcwLCB3b3JrZXJPcHRpb25zLCBvcHRpb25zKSB7XG4gIGNvbnN0IHtcbiAgICB3aW5kb3cgPSBkZWZhdWx0V2luZG93XG4gIH0gPSBvcHRpb25zICE9IG51bGwgPyBvcHRpb25zIDoge307XG4gIGNvbnN0IGRhdGEgPSByZWYobnVsbCk7XG4gIGNvbnN0IHdvcmtlciA9IHNoYWxsb3dSZWYoKTtcbiAgY29uc3QgcG9zdCA9ICguLi5hcmdzKSA9PiB7XG4gICAgaWYgKCF3b3JrZXIudmFsdWUpXG4gICAgICByZXR1cm47XG4gICAgd29ya2VyLnZhbHVlLnBvc3RNZXNzYWdlKC4uLmFyZ3MpO1xuICB9O1xuICBjb25zdCB0ZXJtaW5hdGUgPSBmdW5jdGlvbiB0ZXJtaW5hdGUyKCkge1xuICAgIGlmICghd29ya2VyLnZhbHVlKVxuICAgICAgcmV0dXJuO1xuICAgIHdvcmtlci52YWx1ZS50ZXJtaW5hdGUoKTtcbiAgfTtcbiAgaWYgKHdpbmRvdykge1xuICAgIGlmICh0eXBlb2YgYXJnMCA9PT0gXCJzdHJpbmdcIilcbiAgICAgIHdvcmtlci52YWx1ZSA9IG5ldyBXb3JrZXIoYXJnMCwgd29ya2VyT3B0aW9ucyk7XG4gICAgZWxzZSBpZiAodHlwZW9mIGFyZzAgPT09IFwiZnVuY3Rpb25cIilcbiAgICAgIHdvcmtlci52YWx1ZSA9IGFyZzAoKTtcbiAgICBlbHNlXG4gICAgICB3b3JrZXIudmFsdWUgPSBhcmcwO1xuICAgIHdvcmtlci52YWx1ZS5vbm1lc3NhZ2UgPSAoZSkgPT4ge1xuICAgICAgZGF0YS52YWx1ZSA9IGUuZGF0YTtcbiAgICB9O1xuICAgIHRyeU9uU2NvcGVEaXNwb3NlKCgpID0+IHtcbiAgICAgIGlmICh3b3JrZXIudmFsdWUpXG4gICAgICAgIHdvcmtlci52YWx1ZS50ZXJtaW5hdGUoKTtcbiAgICB9KTtcbiAgfVxuICByZXR1cm4ge1xuICAgIGRhdGEsXG4gICAgcG9zdCxcbiAgICB0ZXJtaW5hdGUsXG4gICAgd29ya2VyXG4gIH07XG59XG5cbmZ1bmN0aW9uIGRlcHNQYXJzZXIoZGVwcywgbG9jYWxEZXBzKSB7XG4gIGlmIChkZXBzLmxlbmd0aCA9PT0gMCAmJiBsb2NhbERlcHMubGVuZ3RoID09PSAwKVxuICAgIHJldHVybiBcIlwiO1xuICBjb25zdCBkZXBzU3RyaW5nID0gZGVwcy5tYXAoKGRlcCkgPT4gYCcke2RlcH0nYCkudG9TdHJpbmcoKTtcbiAgY29uc3QgZGVwc0Z1bmN0aW9uU3RyaW5nID0gbG9jYWxEZXBzLmZpbHRlcigoZGVwKSA9PiB0eXBlb2YgZGVwID09PSBcImZ1bmN0aW9uXCIpLm1hcCgoZm4pID0+IHtcbiAgICBjb25zdCBzdHIgPSBmbi50b1N0cmluZygpO1xuICAgIGlmIChzdHIudHJpbSgpLnN0YXJ0c1dpdGgoXCJmdW5jdGlvblwiKSkge1xuICAgICAgcmV0dXJuIHN0cjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbmFtZSA9IGZuLm5hbWU7XG4gICAgICByZXR1cm4gYGNvbnN0ICR7bmFtZX0gPSAke3N0cn1gO1xuICAgIH1cbiAgfSkuam9pbihcIjtcIik7XG4gIGNvbnN0IGltcG9ydFN0cmluZyA9IGBpbXBvcnRTY3JpcHRzKCR7ZGVwc1N0cmluZ30pO2A7XG4gIHJldHVybiBgJHtkZXBzU3RyaW5nLnRyaW0oKSA9PT0gXCJcIiA/IFwiXCIgOiBpbXBvcnRTdHJpbmd9ICR7ZGVwc0Z1bmN0aW9uU3RyaW5nfWA7XG59XG5cbmZ1bmN0aW9uIGpvYlJ1bm5lcih1c2VyRnVuYykge1xuICByZXR1cm4gKGUpID0+IHtcbiAgICBjb25zdCB1c2VyRnVuY0FyZ3MgPSBlLmRhdGFbMF07XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1c2VyRnVuYy5hcHBseSh2b2lkIDAsIHVzZXJGdW5jQXJncykpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgcG9zdE1lc3NhZ2UoW1wiU1VDQ0VTU1wiLCByZXN1bHRdKTtcbiAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgIHBvc3RNZXNzYWdlKFtcIkVSUk9SXCIsIGVycm9yXSk7XG4gICAgfSk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVdvcmtlckJsb2JVcmwoZm4sIGRlcHMsIGxvY2FsRGVwcykge1xuICBjb25zdCBibG9iQ29kZSA9IGAke2RlcHNQYXJzZXIoZGVwcywgbG9jYWxEZXBzKX07IG9ubWVzc2FnZT0oJHtqb2JSdW5uZXJ9KSgke2ZufSlgO1xuICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2Jsb2JDb2RlXSwgeyB0eXBlOiBcInRleHQvamF2YXNjcmlwdFwiIH0pO1xuICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuICByZXR1cm4gdXJsO1xufVxuXG5mdW5jdGlvbiB1c2VXZWJXb3JrZXJGbihmbiwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBkZXBlbmRlbmNpZXMgPSBbXSxcbiAgICBsb2NhbERlcGVuZGVuY2llcyA9IFtdLFxuICAgIHRpbWVvdXQsXG4gICAgd2luZG93ID0gZGVmYXVsdFdpbmRvd1xuICB9ID0gb3B0aW9ucztcbiAgY29uc3Qgd29ya2VyID0gcmVmKCk7XG4gIGNvbnN0IHdvcmtlclN0YXR1cyA9IHNoYWxsb3dSZWYoXCJQRU5ESU5HXCIpO1xuICBjb25zdCBwcm9taXNlID0gcmVmKHt9KTtcbiAgY29uc3QgdGltZW91dElkID0gc2hhbGxvd1JlZigpO1xuICBjb25zdCB3b3JrZXJUZXJtaW5hdGUgPSAoc3RhdHVzID0gXCJQRU5ESU5HXCIpID0+IHtcbiAgICBpZiAod29ya2VyLnZhbHVlICYmIHdvcmtlci52YWx1ZS5fdXJsICYmIHdpbmRvdykge1xuICAgICAgd29ya2VyLnZhbHVlLnRlcm1pbmF0ZSgpO1xuICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh3b3JrZXIudmFsdWUuX3VybCk7XG4gICAgICBwcm9taXNlLnZhbHVlID0ge307XG4gICAgICB3b3JrZXIudmFsdWUgPSB2b2lkIDA7XG4gICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRpbWVvdXRJZC52YWx1ZSk7XG4gICAgICB3b3JrZXJTdGF0dXMudmFsdWUgPSBzdGF0dXM7XG4gICAgfVxuICB9O1xuICB3b3JrZXJUZXJtaW5hdGUoKTtcbiAgdHJ5T25TY29wZURpc3Bvc2Uod29ya2VyVGVybWluYXRlKTtcbiAgY29uc3QgZ2VuZXJhdGVXb3JrZXIgPSAoKSA9PiB7XG4gICAgY29uc3QgYmxvYlVybCA9IGNyZWF0ZVdvcmtlckJsb2JVcmwoZm4sIGRlcGVuZGVuY2llcywgbG9jYWxEZXBlbmRlbmNpZXMpO1xuICAgIGNvbnN0IG5ld1dvcmtlciA9IG5ldyBXb3JrZXIoYmxvYlVybCk7XG4gICAgbmV3V29ya2VyLl91cmwgPSBibG9iVXJsO1xuICAgIG5ld1dvcmtlci5vbm1lc3NhZ2UgPSAoZSkgPT4ge1xuICAgICAgY29uc3QgeyByZXNvbHZlID0gKCkgPT4ge1xuICAgICAgfSwgcmVqZWN0ID0gKCkgPT4ge1xuICAgICAgfSB9ID0gcHJvbWlzZS52YWx1ZTtcbiAgICAgIGNvbnN0IFtzdGF0dXMsIHJlc3VsdF0gPSBlLmRhdGE7XG4gICAgICBzd2l0Y2ggKHN0YXR1cykge1xuICAgICAgICBjYXNlIFwiU1VDQ0VTU1wiOlxuICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICB3b3JrZXJUZXJtaW5hdGUoc3RhdHVzKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICByZWplY3QocmVzdWx0KTtcbiAgICAgICAgICB3b3JrZXJUZXJtaW5hdGUoXCJFUlJPUlwiKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9O1xuICAgIG5ld1dvcmtlci5vbmVycm9yID0gKGUpID0+IHtcbiAgICAgIGNvbnN0IHsgcmVqZWN0ID0gKCkgPT4ge1xuICAgICAgfSB9ID0gcHJvbWlzZS52YWx1ZTtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIHJlamVjdChlKTtcbiAgICAgIHdvcmtlclRlcm1pbmF0ZShcIkVSUk9SXCIpO1xuICAgIH07XG4gICAgaWYgKHRpbWVvdXQpIHtcbiAgICAgIHRpbWVvdXRJZC52YWx1ZSA9IHNldFRpbWVvdXQoXG4gICAgICAgICgpID0+IHdvcmtlclRlcm1pbmF0ZShcIlRJTUVPVVRfRVhQSVJFRFwiKSxcbiAgICAgICAgdGltZW91dFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ld1dvcmtlcjtcbiAgfTtcbiAgY29uc3QgY2FsbFdvcmtlciA9ICguLi5mbkFyZ3MpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICB2YXIgX2E7XG4gICAgcHJvbWlzZS52YWx1ZSA9IHtcbiAgICAgIHJlc29sdmUsXG4gICAgICByZWplY3RcbiAgICB9O1xuICAgIChfYSA9IHdvcmtlci52YWx1ZSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnBvc3RNZXNzYWdlKFtbLi4uZm5BcmdzXV0pO1xuICAgIHdvcmtlclN0YXR1cy52YWx1ZSA9IFwiUlVOTklOR1wiO1xuICB9KTtcbiAgY29uc3Qgd29ya2VyRm4gPSAoLi4uZm5BcmdzKSA9PiB7XG4gICAgaWYgKHdvcmtlclN0YXR1cy52YWx1ZSA9PT0gXCJSVU5OSU5HXCIpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgIFwiW3VzZVdlYldvcmtlckZuXSBZb3UgY2FuIG9ubHkgcnVuIG9uZSBpbnN0YW5jZSBvZiB0aGUgd29ya2VyIGF0IGEgdGltZS5cIlxuICAgICAgKTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgpO1xuICAgIH1cbiAgICB3b3JrZXIudmFsdWUgPSBnZW5lcmF0ZVdvcmtlcigpO1xuICAgIHJldHVybiBjYWxsV29ya2VyKC4uLmZuQXJncyk7XG4gIH07XG4gIHJldHVybiB7XG4gICAgd29ya2VyRm4sXG4gICAgd29ya2VyU3RhdHVzLFxuICAgIHdvcmtlclRlcm1pbmF0ZVxuICB9O1xufVxuXG4vLyBAX19OT19TSURFX0VGRkVDVFNfX1xuZnVuY3Rpb24gdXNlV2luZG93Rm9jdXMob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHsgd2luZG93ID0gZGVmYXVsdFdpbmRvdyB9ID0gb3B0aW9ucztcbiAgaWYgKCF3aW5kb3cpXG4gICAgcmV0dXJuIHNoYWxsb3dSZWYoZmFsc2UpO1xuICBjb25zdCBmb2N1c2VkID0gc2hhbGxvd1JlZih3aW5kb3cuZG9jdW1lbnQuaGFzRm9jdXMoKSk7XG4gIGNvbnN0IGxpc3RlbmVyT3B0aW9ucyA9IHsgcGFzc2l2ZTogdHJ1ZSB9O1xuICB1c2VFdmVudExpc3RlbmVyKHdpbmRvdywgXCJibHVyXCIsICgpID0+IHtcbiAgICBmb2N1c2VkLnZhbHVlID0gZmFsc2U7XG4gIH0sIGxpc3RlbmVyT3B0aW9ucyk7XG4gIHVzZUV2ZW50TGlzdGVuZXIod2luZG93LCBcImZvY3VzXCIsICgpID0+IHtcbiAgICBmb2N1c2VkLnZhbHVlID0gdHJ1ZTtcbiAgfSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgcmV0dXJuIGZvY3VzZWQ7XG59XG5cbmZ1bmN0aW9uIHVzZVdpbmRvd1Njcm9sbChvcHRpb25zID0ge30pIHtcbiAgY29uc3QgeyB3aW5kb3cgPSBkZWZhdWx0V2luZG93LCAuLi5yZXN0IH0gPSBvcHRpb25zO1xuICByZXR1cm4gdXNlU2Nyb2xsKHdpbmRvdywgcmVzdCk7XG59XG5cbi8vIEBfX05PX1NJREVfRUZGRUNUU19fXG5mdW5jdGlvbiB1c2VXaW5kb3dTaXplKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgd2luZG93ID0gZGVmYXVsdFdpbmRvdyxcbiAgICBpbml0aWFsV2lkdGggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksXG4gICAgaW5pdGlhbEhlaWdodCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSxcbiAgICBsaXN0ZW5PcmllbnRhdGlvbiA9IHRydWUsXG4gICAgaW5jbHVkZVNjcm9sbGJhciA9IHRydWUsXG4gICAgdHlwZSA9IFwiaW5uZXJcIlxuICB9ID0gb3B0aW9ucztcbiAgY29uc3Qgd2lkdGggPSBzaGFsbG93UmVmKGluaXRpYWxXaWR0aCk7XG4gIGNvbnN0IGhlaWdodCA9IHNoYWxsb3dSZWYoaW5pdGlhbEhlaWdodCk7XG4gIGNvbnN0IHVwZGF0ZSA9ICgpID0+IHtcbiAgICBpZiAod2luZG93KSB7XG4gICAgICBpZiAodHlwZSA9PT0gXCJvdXRlclwiKSB7XG4gICAgICAgIHdpZHRoLnZhbHVlID0gd2luZG93Lm91dGVyV2lkdGg7XG4gICAgICAgIGhlaWdodC52YWx1ZSA9IHdpbmRvdy5vdXRlckhlaWdodDtcbiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gXCJ2aXN1YWxcIiAmJiB3aW5kb3cudmlzdWFsVmlld3BvcnQpIHtcbiAgICAgICAgY29uc3QgeyB3aWR0aDogdmlzdWFsVmlld3BvcnRXaWR0aCwgaGVpZ2h0OiB2aXN1YWxWaWV3cG9ydEhlaWdodCwgc2NhbGUgfSA9IHdpbmRvdy52aXN1YWxWaWV3cG9ydDtcbiAgICAgICAgd2lkdGgudmFsdWUgPSBNYXRoLnJvdW5kKHZpc3VhbFZpZXdwb3J0V2lkdGggKiBzY2FsZSk7XG4gICAgICAgIGhlaWdodC52YWx1ZSA9IE1hdGgucm91bmQodmlzdWFsVmlld3BvcnRIZWlnaHQgKiBzY2FsZSk7XG4gICAgICB9IGVsc2UgaWYgKGluY2x1ZGVTY3JvbGxiYXIpIHtcbiAgICAgICAgd2lkdGgudmFsdWUgPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgICAgICAgaGVpZ2h0LnZhbHVlID0gd2luZG93LmlubmVySGVpZ2h0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd2lkdGgudmFsdWUgPSB3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoO1xuICAgICAgICBoZWlnaHQudmFsdWUgPSB3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDtcbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIHVwZGF0ZSgpO1xuICB0cnlPbk1vdW50ZWQodXBkYXRlKTtcbiAgY29uc3QgbGlzdGVuZXJPcHRpb25zID0geyBwYXNzaXZlOiB0cnVlIH07XG4gIHVzZUV2ZW50TGlzdGVuZXIoXCJyZXNpemVcIiwgdXBkYXRlLCBsaXN0ZW5lck9wdGlvbnMpO1xuICBpZiAod2luZG93ICYmIHR5cGUgPT09IFwidmlzdWFsXCIgJiYgd2luZG93LnZpc3VhbFZpZXdwb3J0KSB7XG4gICAgdXNlRXZlbnRMaXN0ZW5lcih3aW5kb3cudmlzdWFsVmlld3BvcnQsIFwicmVzaXplXCIsIHVwZGF0ZSwgbGlzdGVuZXJPcHRpb25zKTtcbiAgfVxuICBpZiAobGlzdGVuT3JpZW50YXRpb24pIHtcbiAgICBjb25zdCBtYXRjaGVzID0gdXNlTWVkaWFRdWVyeShcIihvcmllbnRhdGlvbjogcG9ydHJhaXQpXCIpO1xuICAgIHdhdGNoKG1hdGNoZXMsICgpID0+IHVwZGF0ZSgpKTtcbiAgfVxuICByZXR1cm4geyB3aWR0aCwgaGVpZ2h0IH07XG59XG5cbmV4cG9ydCB7IERlZmF1bHRNYWdpY0tleXNBbGlhc01hcCwgU3RvcmFnZVNlcmlhbGl6ZXJzLCBUcmFuc2l0aW9uUHJlc2V0cywgY29tcHV0ZWRBc3luYyBhcyBhc3luY0NvbXB1dGVkLCBicmVha3BvaW50c0FudERlc2lnbiwgYnJlYWtwb2ludHNCb290c3RyYXBWNSwgYnJlYWtwb2ludHNFbGVtZW50LCBicmVha3BvaW50c01hc3RlckNzcywgYnJlYWtwb2ludHNQcmltZUZsZXgsIGJyZWFrcG9pbnRzUXVhc2FyLCBicmVha3BvaW50c1NlbWF0aWMsIGJyZWFrcG9pbnRzVGFpbHdpbmQsIGJyZWFrcG9pbnRzVnVldGlmeSwgYnJlYWtwb2ludHNWdWV0aWZ5VjIsIGJyZWFrcG9pbnRzVnVldGlmeVYzLCBjbG9uZUZuSlNPTiwgY29tcHV0ZWRBc3luYywgY29tcHV0ZWRJbmplY3QsIGNyZWF0ZUZldGNoLCBjcmVhdGVSZXVzYWJsZVRlbXBsYXRlLCBjcmVhdGVUZW1wbGF0ZVByb21pc2UsIGNyZWF0ZVVucmVmRm4sIGN1c3RvbVN0b3JhZ2VFdmVudE5hbWUsIGRlZmF1bHREb2N1bWVudCwgZGVmYXVsdExvY2F0aW9uLCBkZWZhdWx0TmF2aWdhdG9yLCBkZWZhdWx0V2luZG93LCBleGVjdXRlVHJhbnNpdGlvbiwgZm9ybWF0VGltZUFnbywgZm9ybWF0VGltZUFnb0ludGwsIGZvcm1hdFRpbWVBZ29JbnRsUGFydHMsIGdldFNTUkhhbmRsZXIsIG1hcEdhbWVwYWRUb1hib3gzNjBDb250cm9sbGVyLCBvbkNsaWNrT3V0c2lkZSwgb25FbGVtZW50UmVtb3ZhbCwgb25LZXlEb3duLCBvbktleVByZXNzZWQsIG9uS2V5U3Ryb2tlLCBvbktleVVwLCBvbkxvbmdQcmVzcywgb25TdGFydFR5cGluZywgcHJvdmlkZVNTUldpZHRoLCBzZXRTU1JIYW5kbGVyLCB0ZW1wbGF0ZVJlZiwgdW5yZWZFbGVtZW50LCB1c2VBY3RpdmVFbGVtZW50LCB1c2VBbmltYXRlLCB1c2VBc3luY1F1ZXVlLCB1c2VBc3luY1N0YXRlLCB1c2VCYXNlNjQsIHVzZUJhdHRlcnksIHVzZUJsdWV0b290aCwgdXNlQnJlYWtwb2ludHMsIHVzZUJyb2FkY2FzdENoYW5uZWwsIHVzZUJyb3dzZXJMb2NhdGlvbiwgdXNlQ2FjaGVkLCB1c2VDbGlwYm9hcmQsIHVzZUNsaXBib2FyZEl0ZW1zLCB1c2VDbG9uZWQsIHVzZUNvbG9yTW9kZSwgdXNlQ29uZmlybURpYWxvZywgdXNlQ291bnRkb3duLCB1c2VDc3NWYXIsIHVzZUN1cnJlbnRFbGVtZW50LCB1c2VDeWNsZUxpc3QsIHVzZURhcmssIHVzZURlYm91bmNlZFJlZkhpc3RvcnksIHVzZURldmljZU1vdGlvbiwgdXNlRGV2aWNlT3JpZW50YXRpb24sIHVzZURldmljZVBpeGVsUmF0aW8sIHVzZURldmljZXNMaXN0LCB1c2VEaXNwbGF5TWVkaWEsIHVzZURvY3VtZW50VmlzaWJpbGl0eSwgdXNlRHJhZ2dhYmxlLCB1c2VEcm9wWm9uZSwgdXNlRWxlbWVudEJvdW5kaW5nLCB1c2VFbGVtZW50QnlQb2ludCwgdXNlRWxlbWVudEhvdmVyLCB1c2VFbGVtZW50U2l6ZSwgdXNlRWxlbWVudFZpc2liaWxpdHksIHVzZUV2ZW50QnVzLCB1c2VFdmVudExpc3RlbmVyLCB1c2VFdmVudFNvdXJjZSwgdXNlRXllRHJvcHBlciwgdXNlRmF2aWNvbiwgdXNlRmV0Y2gsIHVzZUZpbGVEaWFsb2csIHVzZUZpbGVTeXN0ZW1BY2Nlc3MsIHVzZUZvY3VzLCB1c2VGb2N1c1dpdGhpbiwgdXNlRnBzLCB1c2VGdWxsc2NyZWVuLCB1c2VHYW1lcGFkLCB1c2VHZW9sb2NhdGlvbiwgdXNlSWRsZSwgdXNlSW1hZ2UsIHVzZUluZmluaXRlU2Nyb2xsLCB1c2VJbnRlcnNlY3Rpb25PYnNlcnZlciwgdXNlS2V5TW9kaWZpZXIsIHVzZUxvY2FsU3RvcmFnZSwgdXNlTWFnaWNLZXlzLCB1c2VNYW51YWxSZWZIaXN0b3J5LCB1c2VNZWRpYUNvbnRyb2xzLCB1c2VNZWRpYVF1ZXJ5LCB1c2VNZW1vaXplLCB1c2VNZW1vcnksIHVzZU1vdW50ZWQsIHVzZU1vdXNlLCB1c2VNb3VzZUluRWxlbWVudCwgdXNlTW91c2VQcmVzc2VkLCB1c2VNdXRhdGlvbk9ic2VydmVyLCB1c2VOYXZpZ2F0b3JMYW5ndWFnZSwgdXNlTmV0d29yaywgdXNlTm93LCB1c2VPYmplY3RVcmwsIHVzZU9mZnNldFBhZ2luYXRpb24sIHVzZU9ubGluZSwgdXNlUGFnZUxlYXZlLCB1c2VQYXJhbGxheCwgdXNlUGFyZW50RWxlbWVudCwgdXNlUGVyZm9ybWFuY2VPYnNlcnZlciwgdXNlUGVybWlzc2lvbiwgdXNlUG9pbnRlciwgdXNlUG9pbnRlckxvY2ssIHVzZVBvaW50ZXJTd2lwZSwgdXNlUHJlZmVycmVkQ29sb3JTY2hlbWUsIHVzZVByZWZlcnJlZENvbnRyYXN0LCB1c2VQcmVmZXJyZWREYXJrLCB1c2VQcmVmZXJyZWRMYW5ndWFnZXMsIHVzZVByZWZlcnJlZFJlZHVjZWRNb3Rpb24sIHVzZVByZWZlcnJlZFJlZHVjZWRUcmFuc3BhcmVuY3ksIHVzZVByZXZpb3VzLCB1c2VSYWZGbiwgdXNlUmVmSGlzdG9yeSwgdXNlUmVzaXplT2JzZXJ2ZXIsIHVzZVNTUldpZHRoLCB1c2VTY3JlZW5PcmllbnRhdGlvbiwgdXNlU2NyZWVuU2FmZUFyZWEsIHVzZVNjcmlwdFRhZywgdXNlU2Nyb2xsLCB1c2VTY3JvbGxMb2NrLCB1c2VTZXNzaW9uU3RvcmFnZSwgdXNlU2hhcmUsIHVzZVNvcnRlZCwgdXNlU3BlZWNoUmVjb2duaXRpb24sIHVzZVNwZWVjaFN5bnRoZXNpcywgdXNlU3RlcHBlciwgdXNlU3RvcmFnZSwgdXNlU3RvcmFnZUFzeW5jLCB1c2VTdHlsZVRhZywgdXNlU3VwcG9ydGVkLCB1c2VTd2lwZSwgdXNlVGVtcGxhdGVSZWZzTGlzdCwgdXNlVGV4dERpcmVjdGlvbiwgdXNlVGV4dFNlbGVjdGlvbiwgdXNlVGV4dGFyZWFBdXRvc2l6ZSwgdXNlVGhyb3R0bGVkUmVmSGlzdG9yeSwgdXNlVGltZUFnbywgdXNlVGltZUFnb0ludGwsIHVzZVRpbWVvdXRQb2xsLCB1c2VUaW1lc3RhbXAsIHVzZVRpdGxlLCB1c2VUcmFuc2l0aW9uLCB1c2VVcmxTZWFyY2hQYXJhbXMsIHVzZVVzZXJNZWRpYSwgdXNlVk1vZGVsLCB1c2VWTW9kZWxzLCB1c2VWaWJyYXRlLCB1c2VWaXJ0dWFsTGlzdCwgdXNlV2FrZUxvY2ssIHVzZVdlYk5vdGlmaWNhdGlvbiwgdXNlV2ViU29ja2V0LCB1c2VXZWJXb3JrZXIsIHVzZVdlYldvcmtlckZuLCB1c2VXaW5kb3dGb2N1cywgdXNlV2luZG93U2Nyb2xsLCB1c2VXaW5kb3dTaXplIH07XG4iLCI8c2NyaXB0IGxhbmc9XCJ0c1wiIHNldHVwPlxuaW1wb3J0IHsgdXNlQ3VycmVudEVsZW1lbnQgfSBmcm9tICdAdnVldXNlL2NvcmUnO1xuaW1wb3J0IHsgdHlwZSBBcGlSZXR1cm4sIHJvdXRlLCBzaW1wbGVBbGVydCwgdXNlSHR0cENsaWVudCwgdXNlU3lzdGVtVXJpIH0gZnJvbSAnQHdpbmR3YWxrZXItaW8vdW5pY29ybi1uZXh0JztcbmltcG9ydCB7IGNvbXB1dGVkLCBvbk1vdW50ZWQsIHJlZiB9IGZyb20gJ3Z1ZSc7XG5cbmNvbnN0IHByb3BzID0gd2l0aERlZmF1bHRzKFxuICBkZWZpbmVQcm9wczx7XG4gICAgaWQ/OiBzdHJpbmc7XG4gICAgYWNjZXB0ZWQ/OiBzdHJpbmdbXTtcbiAgfT4oKSwge1xuICAgIGFjY2VwdGVkOiAoKSA9PiBbXG4gICAgICAnaW1hZ2UvanBlZycsXG4gICAgICAnaW1hZ2UvcG5nJyxcbiAgICAgICdpbWFnZS9naWYnLFxuICAgICAgJ2ltYWdlL3dlYnAnLFxuICAgICAgJ2ltYWdlL3N2ZycsXG4gICAgICAnaW1hZ2Uvc3ZnK3htbCcsXG4gICAgICAnaW1hZ2UvYXZpZicsXG4gICAgXVxuICB9KTtcblxuY29uc3QgdXJsID0gZGVmaW5lTW9kZWwoe1xuICByZXF1aXJlZDogZmFsc2UsXG4gIGRlZmF1bHQ6ICcnXG59KTtcbmNvbnN0IGxvYWRpbmdJbWFnZSA9IHJlZihyb3V0ZSgnbG9hZGluZ19pbWFnZScpKTtcbmNvbnN0IHVwbG9hZGluZyA9IHJlZihmYWxzZSk7XG5jb25zdCBlbCA9IHVzZUN1cnJlbnRFbGVtZW50PEhUTUxEaXZFbGVtZW50PigpO1xuY29uc3QgYWNjZXB0ZWQgPSBjb21wdXRlZCgoKSA9PiBwcm9wcy5hY2NlcHRlZCk7XG5jb25zdCB1cmkgPSB1c2VTeXN0ZW1VcmkoKTtcblxub25Nb3VudGVkKCgpID0+IHtcbiAgaWYgKCFlbC52YWx1ZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGVsLnZhbHVlLmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdvdmVyJywgKGV2ZW50KSA9PiB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBlbC52YWx1ZS5jbGFzc0xpc3QuYWRkKCdjLXNpbmdsZS1pbWFnZS11cGxvYWRlci0taG92ZXInKTtcbiAgfSk7XG5cbiAgZWwudmFsdWUuYWRkRXZlbnRMaXN0ZW5lcignZHJhZ2xlYXZlJywgKGV2ZW50KSA9PiB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBlbC52YWx1ZS5jbGFzc0xpc3QucmVtb3ZlKCdjLXNpbmdsZS1pbWFnZS11cGxvYWRlci0taG92ZXInKTtcbiAgfSk7XG5cbiAgZWwudmFsdWUuYWRkRXZlbnRMaXN0ZW5lcignZHJvcCcsIChldmVudDogYW55KSA9PiB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBlbC52YWx1ZS5jbGFzc0xpc3QucmVtb3ZlKCdjLXNpbmdsZS1pbWFnZS11cGxvYWRlci0taG92ZXInKTtcbiAgICBjb25zdCBmaWxlcyA9IGV2ZW50LnRhcmdldC5maWxlcyB8fCBldmVudC5kYXRhVHJhbnNmZXIuZmlsZXM7XG4gICAgdXBsb2FkRmlsZShmaWxlc1swXSk7XG4gIH0pO1xufSk7XG5cbmZ1bmN0aW9uIGNob29zZUZpbGUoKSB7XG4gIGNvbnN0IGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTtcbiAgaW5wdXQudHlwZSA9ICdmaWxlJztcbiAgaW5wdXQuYWNjZXB0ID0gYWNjZXB0ZWQudmFsdWUuam9pbignLCcpO1xuICBpbnB1dC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZXZlbnQpID0+IHtcbiAgICBjb25zdCBmaWxlcyA9IGlucHV0LmZpbGVzIHx8IChldmVudCBhcyBhbnkpLmRhdGFUcmFuc2Zlci5maWxlcztcbiAgICB1cGxvYWRGaWxlKGZpbGVzWzBdKTtcbiAgfSk7XG4gIGVsLnZhbHVlPy5hcHBlbmRDaGlsZChpbnB1dCk7XG4gIGlucHV0LmNsaWNrKCk7XG5cbiAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgaW5wdXQucGFyZW50Tm9kZT8ucmVtb3ZlQ2hpbGQoaW5wdXQpO1xuICB9LCAxMDAwKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcGFzdGVGcm9tQnV0dG9uKCkge1xuICB0cnkge1xuICAgIGxldCBpdGVtcyA9IGF3YWl0IG5hdmlnYXRvci5jbGlwYm9hcmQucmVhZCgpO1xuXG4gICAgY29uc3QgdHlwZSA9IGl0ZW1zWzBdLnR5cGVzWzFdO1xuXG4gICAgbGV0IGJsb2IgPSBhd2FpdCBpdGVtc1swXS5nZXRUeXBlKHR5cGUpO1xuICAgIGF3YWl0IHVwbG9hZEZpbGUobmV3IEZpbGUoW2Jsb2JdLCAnaW1hZ2UucG5nJywgeyB0eXBlOiBibG9iLnR5cGUgfSkpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS53YXJuKCdVbmFibGUgdG8gcGFzdGUgdGhpcyBkYXRhJyk7XG4gICAgY29uc29sZS53YXJuKGUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHBhc3RlRmlsZShldmVudDogQ2xpcGJvYXJkRXZlbnQpIHtcbiAgaWYgKGV2ZW50LmNsaXBib2FyZERhdGE/Lml0ZW1zWzBdICYmIGV2ZW50LmNsaXBib2FyZERhdGEuaXRlbXNbMF0ua2luZCA9PT0gJ2ZpbGUnKSB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICBjb25zdCBpdGVtID0gZXZlbnQuY2xpcGJvYXJkRGF0YS5pdGVtc1swXTtcblxuICAgIGlmICghaXRlbSkge1xuICAgICAgY29uc29sZS5lcnJvcignTm8gcGFzdGUgaXRlbScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHVwbG9hZEZpbGUoaXRlbS5nZXRBc0ZpbGUoKSEpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUoZmlsZTogRmlsZSk6IFByb21pc2U8dm9pZD4ge1xuICBpZiAoIWNoZWNrRmlsZShmaWxlKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG5cbiAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgZmlsZSk7XG4gIHVwbG9hZGluZy52YWx1ZSA9IHRydWU7XG4gIGNvbnN0IHsgcG9zdCwgaXNBeGlvc0Vycm9yIH0gPSBhd2FpdCB1c2VIdHRwQ2xpZW50KCk7XG5cbiAgdHJ5IHtcbiAgICBsZXQgcmVzID0gYXdhaXQgcG9zdDxBcGlSZXR1cm48e1xuICAgICAgdXJsOiBzdHJpbmc7XG4gICAgfT4+KCdAZmlsZV91cGxvYWQnLCBmb3JtRGF0YSk7XG5cbiAgICBsZXQgZmlsZVVybCA9IHJlcy5kYXRhLmRhdGEudXJsO1xuXG4gICAgaWYgKGZpbGVVcmwuaW5jbHVkZXModXJpLnJvb3QoKSkpIHtcbiAgICAgIGZpbGVVcmwgPSBmaWxlVXJsLnN1YnN0cmluZyh1cmkucm9vdCgpLmxlbmd0aCk7XG4gICAgfVxuXG4gICAgdXJsLnZhbHVlID0gZmlsZVVybDtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChpc0F4aW9zRXJyb3IoZSkpIHtcbiAgICAgIHNpbXBsZUFsZXJ0KGUubWVzc2FnZSk7XG4gICAgfVxuXG4gICAgY29uc29sZS5lcnJvcihlKTtcbiAgfSBmaW5hbGx5IHtcbiAgICB1cGxvYWRpbmcudmFsdWUgPSBmYWxzZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjaGVja0ZpbGUoZmlsZTogRmlsZSkge1xuICBpZiAoYWNjZXB0ZWQudmFsdWUuaW5kZXhPZihmaWxlLnR5cGUpIDwgMCkge1xuICAgIGFsZXJ0KCdJbnZhbGlkIGZpbGUgZm9ybWF0Jyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBjbGVhclVybCgpIHtcbiAgdXJsLnZhbHVlID0gJyc7XG59XG5cbmNvbnN0IHByZXZpZXdVcmwgPSBjb21wdXRlZCgoKSA9PiB7XG4gIGxldCBmaWxlVXJsID0gdXJsLnZhbHVlO1xuXG4gIGlmICghZmlsZVVybCkge1xuICAgIHJldHVybiBmaWxlVXJsO1xuICB9XG5cbiAgaWYgKGZpbGVVcmwuaW5kZXhPZignaHR0cCcpICE9PSAwICYmIGZpbGVVcmwuaW5kZXhPZignLycpICE9PSAwKSB7XG4gICAgcmV0dXJuIHVyaS5yb290KGZpbGVVcmwpO1xuICB9XG5cbiAgcmV0dXJuIGZpbGVVcmw7XG59KTtcbjwvc2NyaXB0PlxuXG48dGVtcGxhdGU+XG4gIDxkaXYgcmVmPVwiZWxcIiBjbGFzcz1cImMtc2luZ2xlLWltYWdlLXVwbG9hZGVyXCI+XG4gICAgPGRpdiBjbGFzcz1cImZvcm0tZ3JvdXAgbWItMyBjLXNpbmdsZS1pbWFnZS1wcmV2aWV3IHRleHQtY2VudGVyXCJcbiAgICAgIHYtaWY9XCJ1cmwgIT09ICcnICYmICF1cGxvYWRpbmdcIj5cbiAgICAgIDxpbWcgOnNyYz1cInByZXZpZXdVcmxcIiBhbHQ9XCJJbWFnZVwiIGNsYXNzPVwiaW1nLWZsdWlkIHJvdW5kZWRcIiBzdHlsZT1cIm1heC1oZWlnaHQ6IDQ1MHB4O1wiPlxuICAgIDwvZGl2PlxuXG4gICAgPGRpdiBjbGFzcz1cImMtc2luZ2xlLWltYWdlLXBsYWNlaG9sZGVyIHRleHQtY2VudGVyIHAtNCBtYi0zIGJvcmRlciByb3VuZGVkXCJcbiAgICAgIHYtaWY9XCJ1cmwgPT09ICcnICYmICF1cGxvYWRpbmdcIj5cbiAgICAgIDxzbWFsbCBjbGFzcz1cInRleHQtbXV0ZWRcIj5EcmFnIEltYWdlIEhlcmU8L3NtYWxsPlxuICAgIDwvZGl2PlxuXG4gICAgPGRpdiBjbGFzcz1cImZvcm0tZ3JvdXAgbWItMyBkLWZsZXggYWxpZ24taXRlbXMtY2VudGVyIGp1c3RpZnktY29udGVudC1jZW50ZXJcIlxuICAgICAgdi1pZj1cInVwbG9hZGluZ1wiIHN0eWxlPVwibWluLWhlaWdodDogNDUwcHg7XCI+XG4gICAgICA8ZGl2IGNsYXNzPVwic3Bpbm5lci1ib3JkZXJcIj48L2Rpdj5cbiAgICA8L2Rpdj5cblxuICAgIDxkaXYgY2xhc3M9XCJmb3JtLWdyb3VwIG1iLTNcIj5cbiAgICAgIDxkaXYgY2xhc3M9XCJpbnB1dC1ncm91cFwiPlxuICAgICAgICA8aW5wdXQgOmlkPVwiaWRcIlxuICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICB2LW1vZGVsPVwidXJsXCJcbiAgICAgICAgICBjbGFzcz1cImZvcm0tY29udHJvbFwiXG4gICAgICAgICAgOmRpc2FibGVkPVwidXBsb2FkaW5nXCJcbiAgICAgICAgICBAcGFzdGU9XCJwYXN0ZUZpbGVcIlxuICAgICAgICAvPlxuICAgICAgICA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBjbGFzcz1cImJ0biBidG4tcHJpbWFyeVwiIEBjbGljaz1cImNob29zZUZpbGUoKVwiXG4gICAgICAgICAgOmRpc2FibGVkPVwidXBsb2FkaW5nXCJcbiAgICAgICAgPlxuICAgICAgICAgIDxpIGNsYXNzPVwiZmEgZmEtdXBsb2FkXCI+PC9pPlxuICAgICAgICAgIFVwbG9hZFxuICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgY2xhc3M9XCJidG4gYnRuLXByaW1hcnlcIiBAY2xpY2s9XCJwYXN0ZUZyb21CdXR0b25cIlxuICAgICAgICAgIDpkaXNhYmxlZD1cInVwbG9hZGluZ1wiXG4gICAgICAgICAgdi10b29sdGlwXG4gICAgICAgICAgdGl0bGU9XCJQYXN0ZVwiPlxuICAgICAgICAgIDxzcGFuIGNsYXNzPVwiZmEgZmEtcGFzdGVcIj48L3NwYW4+XG4gICAgICAgIDwvYnV0dG9uPlxuICAgICAgICA8YnV0dG9uIHYtaWY9XCJ1cmwgIT09ICcnXCIgdHlwZT1cImJ1dHRvblwiIGNsYXNzPVwiYnRuIGJ0bi1wcmltYXJ5XCIgQGNsaWNrLnN0b3A9XCJjbGVhclVybFwiXG4gICAgICAgICAgOmRpc2FibGVkPVwidXBsb2FkaW5nXCI+XG4gICAgICAgICAgPHNwYW4gY2xhc3M9XCJmYSBmYS10aW1lc1wiPjwvc3Bhbj5cbiAgICAgICAgPC9idXR0b24+XG4gICAgICA8L2Rpdj5cbiAgICAgIDxzbWFsbCBjbGFzcz1cImZvcm0tdGV4dCB0ZXh0LW11dGVkXCI+XG4gICAgICAgIFBhc3RlIGltYWdlIHVybC9maWxlIG9yIGRyYWcgYW5kIHVwbG9hZCBpbWFnZSBoZXJlLlxuICAgICAgPC9zbWFsbD5cbiAgICA8L2Rpdj5cbiAgPC9kaXY+XG48L3RlbXBsYXRlPlxuXG48c3R5bGUgc2NvcGVkPlxuXG48L3N0eWxlPlxuIl0sIm5hbWVzIjpbIl91c2VNb2RlbCIsIl9vcGVuQmxvY2siLCJfY3JlYXRlRWxlbWVudEJsb2NrIiwiX2NyZWF0ZUVsZW1lbnRWTm9kZSIsIl9jcmVhdGVDb21tZW50Vk5vZGUiLCJfd2l0aERpcmVjdGl2ZXMiLCJfY3JlYXRlVGV4dFZOb2RlIiwiX3dpdGhNb2RpZmllcnMiXSwibWFwcGluZ3MiOiI7OztBQWNBLFNBQVMsb0JBQW9CLFFBQVEsSUFBSSxVQUFVLENBQUEsR0FBSTtBQUNyRCxNQUFJLElBQUk7QUFDUixNQUFJO0FBQ0osTUFBSTtBQUNKLE1BQUksUUFBUTtBQUNaLFFBQU0sU0FBUyxNQUFNO0FBQ25CLFlBQVE7QUFDUixZQUFPO0FBQUEsRUFDVDtBQUNBLFFBQU0sUUFBUSxRQUFRLEVBQUUsT0FBTyxRQUFRLEdBQUcsU0FBUztBQUNuRCxRQUFNLE1BQU0sT0FBTyxPQUFPLGFBQWEsS0FBSyxHQUFHO0FBQy9DLFFBQU0sTUFBTSxPQUFPLE9BQU8sYUFBYSxTQUFTLEdBQUc7QUFDbkQsUUFBTSxTQUFTLFVBQVUsQ0FBQyxRQUFRLGFBQWE7QUFDN0MsWUFBUTtBQUNSLGNBQVU7QUFDVixXQUFPO0FBQUEsTUFDTCxNQUFNO0FBQ0osWUFBSSxPQUFPO0FBQ1QsY0FBSSxJQUFJLENBQUM7QUFDVCxrQkFBUTtBQUFBLFFBQ1Y7QUFDQSxjQUFLO0FBQ0wsZUFBTztBQUFBLE1BQ1Q7QUFBQSxNQUNBLElBQUksSUFBSTtBQUNOLGVBQU8sT0FBTyxTQUFTLElBQUksRUFBRTtBQUFBLE1BQy9CO0FBQUEsSUFDTjtBQUFBLEVBQ0UsQ0FBQztBQUNELFNBQU8sVUFBVTtBQUNqQixTQUFPO0FBQ1Q7QUFFQSxTQUFTLGtCQUFrQixJQUFJO0FBQzdCLE1BQUksZ0JBQWUsR0FBSTtBQUNyQixtQkFBZSxFQUFFO0FBQ2pCLFdBQU87QUFBQSxFQUNUO0FBQ0EsU0FBTztBQUNUO0FBbVBBLE1BQU0sV0FBVyxPQUFPLFdBQVcsZUFBZSxPQUFPLGFBQWE7QUFDckQsT0FBTyxzQkFBc0IsZUFBZSxzQkFBc0I7QUFPbkYsTUFBTSxXQUFXLE9BQU8sVUFBVTtBQUNsQyxNQUFNLFdBQVcsQ0FBQyxRQUFRLFNBQVMsS0FBSyxHQUFHLE1BQU07QUF1UGpELFNBQVMsUUFBUSxPQUFPO0FBQ3RCLFNBQU8sTUFBTSxRQUFRLEtBQUssSUFBSSxRQUFRLENBQUMsS0FBSztBQUM5QztBQTQ5QkEsU0FBUyxlQUFlLFFBQVEsSUFBSSxTQUFTO0FBQzNDLFNBQU87QUFBQSxJQUNMO0FBQUEsSUFDQTtBQUFBLElBQ0E7QUFBQSxNQUNFLEdBQUc7QUFBQSxNQUNILFdBQVc7QUFBQSxJQUNqQjtBQUFBLEVBQ0E7QUFDQTtBQzkxQ0EsTUFBTSxnQkFBZ0IsV0FBVyxTQUFTO0FBSzFDLFNBQVMsYUFBYSxPQUFPO0FBQzNCLE1BQUk7QUFDSixRQUFNLFFBQVEsUUFBUSxLQUFLO0FBQzNCLFVBQVEsS0FBSyxTQUFTLE9BQU8sU0FBUyxNQUFNLFFBQVEsT0FBTyxLQUFLO0FBQ2xFO0FBRUEsU0FBUyxvQkFBb0IsTUFBTTtBQUNqQyxRQUFNLFdBQVcsQ0FBQTtBQUNqQixRQUFNLFVBQVUsTUFBTTtBQUNwQixhQUFTLFFBQVEsQ0FBQyxPQUFPLEdBQUEsQ0FBSTtBQUM3QixhQUFTLFNBQVM7QUFBQSxFQUNwQjtBQUNBLFFBQU0sV0FBVyxDQUFDLElBQUksT0FBTyxVQUFVLFlBQVk7QUFDakQsT0FBRyxpQkFBaUIsT0FBTyxVQUFVLE9BQU87QUFDNUMsV0FBTyxNQUFNLEdBQUcsb0JBQW9CLE9BQU8sVUFBVSxPQUFPO0FBQUEsRUFDOUQ7QUFDQSxRQUFNLG9CQUFvQixTQUFTLE1BQU07QUFDdkMsVUFBTSxPQUFPLFFBQVEsUUFBUSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLE1BQU0sS0FBSyxJQUFJO0FBQzlELFdBQU8sS0FBSyxNQUFNLENBQUMsTUFBTSxPQUFPLE1BQU0sUUFBUSxJQUFJLE9BQU87QUFBQSxFQUMzRCxDQUFDO0FBQ0QsUUFBTSxZQUFZO0FBQUEsSUFDaEIsTUFBTTtBQUNKLFVBQUksSUFBSTtBQUNSLGFBQU87QUFBQSxTQUNKLE1BQU0sS0FBSyxrQkFBa0IsVUFBVSxPQUFPLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxhQUFhLENBQUMsQ0FBQyxNQUFNLE9BQU8sS0FBSyxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsTUFBTSxLQUFLLElBQUk7QUFBQSxRQUM5SSxRQUFRLFFBQVEsa0JBQWtCLFFBQVEsS0FBSyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQztBQUFBLFFBQzVELFFBQVEsTUFBTSxrQkFBa0IsUUFBUSxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQUE7QUFBQSxRQUUxRCxRQUFRLGtCQUFrQixRQUFRLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDO0FBQUEsTUFBQTtBQUFBLElBRXZEO0FBQUEsSUFDQSxDQUFDLENBQUMsYUFBYSxZQUFZLGVBQWUsV0FBVyxNQUFNO0FBQ3pELGNBQUE7QUFDQSxVQUFJLEVBQUUsZUFBZSxPQUFPLFNBQVMsWUFBWSxXQUFXLEVBQUUsY0FBYyxPQUFPLFNBQVMsV0FBVyxXQUFXLEVBQUUsaUJBQWlCLE9BQU8sU0FBUyxjQUFjO0FBQ2pLO0FBQ0YsWUFBTSxlQUFlLFNBQVMsV0FBVyxJQUFJLEVBQUUsR0FBRyxnQkFBZ0I7QUFDbEUsZUFBUztBQUFBLFFBQ1AsR0FBRyxZQUFZO0FBQUEsVUFDYixDQUFDLE9BQU8sV0FBVztBQUFBLFlBQ2pCLENBQUMsVUFBVSxjQUFjLElBQUksQ0FBQyxhQUFhLFNBQVMsSUFBSSxPQUFPLFVBQVUsWUFBWSxDQUFDO0FBQUEsVUFBQTtBQUFBLFFBQ3hGO0FBQUEsTUFDRjtBQUFBLElBRUo7QUFBQSxJQUNBLEVBQUUsT0FBTyxPQUFBO0FBQUEsRUFBTztBQUVsQixRQUFNLE9BQU8sTUFBTTtBQUNqQixjQUFBO0FBQ0EsWUFBQTtBQUFBLEVBQ0Y7QUFDQSxvQkFBa0IsT0FBTztBQUN6QixTQUFPO0FBQ1Q7QUEwOERBLFNBQVMsa0JBQWtCLGVBQWU7QUFDeEMsUUFBTSxLQUFLLG1CQUFBO0FBQ1gsUUFBTSxpQkFBaUI7QUFBQSxJQUNyQixNQUFNO0FBQUEsSUFDTixNQUFvRCxHQUFHLE1BQU07QUFBQSxFQUFBO0FBRS9ELFlBQVUsZUFBZSxPQUFPO0FBQ2hDLFlBQVUsZUFBZSxPQUFPO0FBQ2hDLFNBQU87QUFDVDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FDeHJFQSxVQUFNLFFBQVE7QUFnQmQsVUFBTSxNQUFNQSw4QkFHWDtBQUNELFVBQU0sZUFBZSxJQUFJLE1BQU0sZUFBZSxDQUFDO0FBQy9DLFVBQU0sWUFBWSxJQUFJLEtBQUs7QUFDM0IsVUFBTSxLQUFLLGtCQUFBO0FBQ1gsVUFBTSxXQUFXLFNBQVMsTUFBTSxNQUFNLFFBQVE7QUFDOUMsVUFBTSxNQUFNLGFBQUE7QUFFWixjQUFVLE1BQU07QUFDZCxVQUFJLENBQUMsR0FBRyxPQUFPO0FBQ2I7QUFBQSxNQUNGO0FBRUEsU0FBRyxNQUFNLGlCQUFpQixZQUFZLENBQUMsVUFBVTtBQUMvQyxjQUFNLGdCQUFBO0FBQ04sY0FBTSxlQUFBO0FBQ04sV0FBRyxNQUFNLFVBQVUsSUFBSSxnQ0FBZ0M7QUFBQSxNQUN6RCxDQUFDO0FBRUQsU0FBRyxNQUFNLGlCQUFpQixhQUFhLENBQUMsVUFBVTtBQUNoRCxjQUFNLGdCQUFBO0FBQ04sY0FBTSxlQUFBO0FBQ04sV0FBRyxNQUFNLFVBQVUsT0FBTyxnQ0FBZ0M7QUFBQSxNQUM1RCxDQUFDO0FBRUQsU0FBRyxNQUFNLGlCQUFpQixRQUFRLENBQUMsVUFBZTtBQUNoRCxjQUFNLGdCQUFBO0FBQ04sY0FBTSxlQUFBO0FBQ04sV0FBRyxNQUFNLFVBQVUsT0FBTyxnQ0FBZ0M7QUFDMUQsY0FBTSxRQUFRLE1BQU0sT0FBTyxTQUFTLE1BQU0sYUFBYTtBQUN2RCxtQkFBVyxNQUFNLENBQUMsQ0FBQztBQUFBLE1BQ3JCLENBQUM7QUFBQSxJQUNILENBQUM7QUFFRCxhQUFTLGFBQWE7QUFDcEIsWUFBTSxRQUFRLFNBQVMsY0FBYyxPQUFPO0FBQzVDLFlBQU0sT0FBTztBQUNiLFlBQU0sU0FBUyxTQUFTLE1BQU0sS0FBSyxHQUFHO0FBQ3RDLFlBQU0sTUFBTSxVQUFVO0FBQ3RCLFlBQU0saUJBQWlCLFVBQVUsQ0FBQyxVQUFVO0FBQzFDLGNBQU0sUUFBUSxNQUFNLFNBQVUsTUFBYyxhQUFhO0FBQ3pELG1CQUFXLE1BQU0sQ0FBQyxDQUFDO0FBQUEsTUFDckIsQ0FBQztBQUNELFNBQUcsT0FBTyxZQUFZLEtBQUs7QUFDM0IsWUFBTSxNQUFBO0FBRU4saUJBQVcsTUFBTTtBQUNmLGNBQU0sWUFBWSxZQUFZLEtBQUs7QUFBQSxNQUNyQyxHQUFHLEdBQUk7QUFBQSxJQUNUO0FBRUEsbUJBQWUsa0JBQWtCO0FBQy9CLFVBQUk7QUFDRixZQUFJLFFBQVEsTUFBTSxVQUFVLFVBQVUsS0FBQTtBQUV0QyxjQUFNLE9BQU8sTUFBTSxDQUFDLEVBQUUsTUFBTSxDQUFDO0FBRTdCLFlBQUksT0FBTyxNQUFNLE1BQU0sQ0FBQyxFQUFFLFFBQVEsSUFBSTtBQUN0QyxjQUFNLFdBQVcsSUFBSSxLQUFLLENBQUMsSUFBSSxHQUFHLGFBQWEsRUFBRSxNQUFNLEtBQUssS0FBQSxDQUFNLENBQUM7QUFBQSxNQUNyRSxTQUFTLEdBQUc7QUFDVixnQkFBUSxLQUFLLDJCQUEyQjtBQUN4QyxnQkFBUSxLQUFLLENBQUM7QUFBQSxNQUNoQjtBQUFBLElBQ0Y7QUFFQSxhQUFTLFVBQVUsT0FBdUI7QUFDeEMsVUFBSSxNQUFNLGVBQWUsTUFBTSxDQUFDLEtBQUssTUFBTSxjQUFjLE1BQU0sQ0FBQyxFQUFFLFNBQVMsUUFBUTtBQUNqRixjQUFNLGVBQUE7QUFDTixjQUFNLGdCQUFBO0FBQ04sY0FBTSxPQUFPLE1BQU0sY0FBYyxNQUFNLENBQUM7QUFFeEMsWUFBSSxDQUFDLE1BQU07QUFDVCxrQkFBUSxNQUFNLGVBQWU7QUFDN0I7QUFBQSxRQUNGO0FBRUEsbUJBQVcsS0FBSyxXQUFZO0FBQUEsTUFDOUI7QUFBQSxJQUNGO0FBRUEsbUJBQWUsV0FBVyxNQUEyQjtBQUNuRCxVQUFJLENBQUMsVUFBVSxJQUFJLEdBQUc7QUFDcEI7QUFBQSxNQUNGO0FBRUEsWUFBTSxXQUFXLElBQUksU0FBQTtBQUVyQixlQUFTLE9BQU8sUUFBUSxJQUFJO0FBQzVCLGdCQUFVLFFBQVE7QUFDbEIsWUFBTSxFQUFFLE1BQU0sYUFBQSxJQUFpQixNQUFNLGNBQUE7QUFFckMsVUFBSTtBQUNGLFlBQUksTUFBTSxNQUFNLEtBRVosZ0JBQWdCLFFBQVE7QUFFNUIsWUFBSSxVQUFVLElBQUksS0FBSyxLQUFLO0FBRTVCLFlBQUksUUFBUSxTQUFTLElBQUksS0FBQSxDQUFNLEdBQUc7QUFDaEMsb0JBQVUsUUFBUSxVQUFVLElBQUksS0FBQSxFQUFPLE1BQU07QUFBQSxRQUMvQztBQUVBLFlBQUksUUFBUTtBQUFBLE1BQ2QsU0FBUyxHQUFHO0FBQ1YsWUFBSSxhQUFhLENBQUMsR0FBRztBQUNuQixzQkFBWSxFQUFFLE9BQU87QUFBQSxRQUN2QjtBQUVBLGdCQUFRLE1BQU0sQ0FBQztBQUFBLE1BQ2pCLFVBQUE7QUFDRSxrQkFBVSxRQUFRO0FBQUEsTUFDcEI7QUFBQSxJQUNGO0FBRUEsYUFBUyxVQUFVLE1BQVk7QUFDN0IsVUFBSSxTQUFTLE1BQU0sUUFBUSxLQUFLLElBQUksSUFBSSxHQUFHO0FBQ3pDLGNBQU0scUJBQXFCO0FBQzNCLGVBQU87QUFBQSxNQUNUO0FBQ0EsYUFBTztBQUFBLElBQ1Q7QUFFQSxhQUFTLFdBQVc7QUFDbEIsVUFBSSxRQUFRO0FBQUEsSUFDZDtBQUVBLFVBQU0sYUFBYSxTQUFTLE1BQU07QUFDaEMsVUFBSSxVQUFVLElBQUk7QUFFbEIsVUFBSSxDQUFDLFNBQVM7QUFDWixlQUFPO0FBQUEsTUFDVDtBQUVBLFVBQUksUUFBUSxRQUFRLE1BQU0sTUFBTSxLQUFLLFFBQVEsUUFBUSxHQUFHLE1BQU0sR0FBRztBQUMvRCxlQUFPLElBQUksS0FBSyxPQUFPO0FBQUEsTUFDekI7QUFFQSxhQUFPO0FBQUEsSUFDVCxDQUFDOzs7Ozs7O0VBSU0sS0FBSTtBQUFBLEVBQUssT0FBTTs7OztFQUNiLE9BQU07Ozs7O0VBS04sT0FBTTs7OztFQUtOLE9BQU07QUFBQSxFQUNRLE9BQUEsRUFBQSxjQUFBLFFBQUE7O0FBSWQsTUFBQSxhQUFBLEVBQUEsT0FBTSxrQkFBQTtBQUNKLE1BQUEsYUFBQSxFQUFBLE9BQU0sY0FBQTs7Ozs7OztBQWpCZixTQUFBQyxVQUFBLEdBQUFDLG1CQThDTSxPQTlDTixZQThDTTtBQUFBLElBNUNJLE9BQUEsUUFBRyxNQUFBLENBQVksT0FBQSxhQUFBRCxhQUR2QkMsbUJBR00sT0FITixZQUdNO0FBQUEsTUFESkMsbUJBQXdGLE9BQUE7QUFBQSxRQUFsRixLQUFLLE9BQUE7QUFBQSxRQUFZLEtBQUk7QUFBQSxRQUFRLE9BQU07QUFBQSxRQUFvQixPQUFBLEVBQUEsY0FBQSxRQUFBO0FBQUEsTUFBQSxHQUFBLE1BQUEsR0FBQSxVQUFBO0FBQUE7O0lBSXZELE9BQUEsUUFBRyxNQUFBLENBQVksT0FBQSxhQUFBRixhQUR2QkMsbUJBR00sT0FITixZQUdNLENBQUEsR0FBQSxPQUFBLENBQUEsTUFBQSxPQUFBLENBQUEsSUFBQTtBQUFBLE1BREpDLG1CQUFpRCxTQUFBLEVBQTFDLE9BQU0sYUFBQSxHQUFhLG1CQUFlLEVBQUE7QUFBQSxJQUFBLEVBQUEsQ0FBQSxLQUFBQyxtQkFBQSxJQUFBLElBQUE7QUFBQTtJQUluQyxPQUFBLGFBQUFILGFBRFJDLG1CQUdNLE9BSE4sWUFHTSxDQUFBLEdBQUEsT0FBQSxDQUFBLE1BQUEsT0FBQSxDQUFBLElBQUE7QUFBQSxNQURKQyxtQkFBa0MsT0FBQSxFQUE3QixPQUFNLGlCQUFBLEdBQWdCLE1BQUEsRUFBQTtBQUFBLElBQUEsRUFBQSxDQUFBLEtBQUFDLG1CQUFBLElBQUEsSUFBQTtBQUFBO0lBRzdCRCxtQkE2Qk0sT0E3Qk4sWUE2Qk07QUFBQSxNQTVCSkEsbUJBd0JNLE9BeEJOLFlBd0JNO0FBQUEsUUFBQUUsZUF2QkpGLG1CQU1FLFNBQUE7QUFBQSxVQU5NLElBQUksT0FBQTtBQUFBLFVBQ1YsTUFBSztBQUFBLFVBQUEsdUJBQUEsT0FBQSxDQUFBLE1BQUEsT0FBQSxDQUFBLElBQUEsQ0FBQSxXQUNJLE9BQUEsTUFBRztBQUFBLFVBQ1osT0FBTTtBQUFBLFVBQ0wsVUFBVSxPQUFBO0FBQUEsVUFDVixTQUFPLE9BQUE7QUFBQSxRQUFBLEdBQUEsTUFBQSxJQUFBLFVBQUEsR0FBQTtBQUFBLHVCQUhDLE9BQUEsR0FBRztBQUFBLFFBQUEsQ0FBQTtBQUFBO1FBS2RBLG1CQUtTLFVBQUE7QUFBQSxVQUxELE1BQUs7QUFBQSxVQUFTLE9BQU07QUFBQSxVQUFtQixTQUFLLHNDQUFFLE9BQUE7VUFDbkQsVUFBVSxPQUFBO0FBQUEsUUFBQSxHQUFBLENBQUEsR0FBQSxPQUFBLENBQUEsTUFBQSxPQUFBLENBQUEsSUFBQTtBQUFBLFVBRVhBLG1CQUE0QixLQUFBLEVBQXpCLE9BQU0sZUFBQSxHQUFjLE1BQUEsRUFBQTtBQUFBLFVBQUFHLGdCQUFLLGdDQUU5QixFQUFBO0FBQUEsUUFBQSxFQUFBLEdBQUEsR0FBQSxVQUFBO0FBQUE7cUNBQ0FKLG1CQUtTLFVBQUE7QUFBQSxVQUxELE1BQUs7QUFBQSxVQUFTLE9BQU07QUFBQSxVQUFtQixTQUFPLE9BQUE7QUFBQSxVQUNuRCxVQUFVLE9BQUE7QUFBQSxVQUVYLE9BQU07QUFBQSxRQUFBLEdBQUEsQ0FBQSxHQUFBLE9BQUEsQ0FBQSxNQUFBLE9BQUEsQ0FBQSxJQUFBO0FBQUEsVUFDTkMsbUJBQWlDLFFBQUEsRUFBM0IsT0FBTSxjQUFBLEdBQWEsTUFBQSxFQUFBO0FBQUEsUUFBQSxFQUFBLEdBQUEsR0FBQSxXQUFBLElBQUE7QUFBQTs7O1FBRWIsT0FBQSxRQUFHLG1CQUFqQkQsbUJBR1MsVUFBQTtBQUFBLFVBQUEsS0FBQTtBQUFBLFVBSGlCLE1BQUs7QUFBQSxVQUFTLE9BQU07QUFBQSxVQUFtQixTQUFLSyxjQUFPLE9BQUEsVUFBUSxDQUFBLE1BQUEsQ0FBQTtBQUFBLFVBQ2xGLFVBQVUsT0FBQTtBQUFBLFFBQUEsR0FBQSxDQUFBLEdBQUEsT0FBQSxDQUFBLE1BQUEsT0FBQSxDQUFBLElBQUE7QUFBQSxVQUNYSixtQkFBaUMsUUFBQSxFQUEzQixPQUFNLGNBQUEsR0FBYSxNQUFBLEVBQUE7QUFBQSxRQUFBLEVBQUEsR0FBQSxHQUFBLFdBQUEsS0FBQUMsbUJBQUEsSUFBQSxJQUFBO0FBQUE7O01BRzdCLE9BQUEsRUFBQSxNQUFBLE9BQUEsRUFBQSxJQUFBRCxtQkFFUSxTQUFBLEVBRkQsT0FBTSwwQkFBdUIseUVBRXBDLEVBQUE7QUFBQSxJQUFBLENBQUE7QUFBQTs7OyIsInhfZ29vZ2xlX2lnbm9yZUxpc3QiOlswLDFdfQ==
