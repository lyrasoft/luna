{"version":3,"file":"captcha.js","sources":["../../src/modules/captcha.ts"],"sourcesContent":["import { __, addQuery, module, simpleAlert, uid, useScriptImport, useUniDirective } from '@windwalker-io/unicorn-next';\n\nclass GragwarCaptcha {\n  public $image!: HTMLImageElement;\n  public $input!: HTMLInputElement;\n  public $refreshButton!: HTMLButtonElement;\n  public $buttonIcon!: HTMLSpanElement;\n\n  constructor(public $element: Element, public options: any = {}) {\n    this.$image = this.$element.querySelector<HTMLImageElement>('[data-captcha-image]')!;\n    this.$input = this.$element.querySelector<HTMLInputElement>('[data-captcha-input]')!;\n    this.$refreshButton = this.$element.querySelector<HTMLButtonElement>('[data-captcha-refresh]')!;\n    this.$buttonIcon = this.$element.querySelector<HTMLSpanElement>('[data-refresh-icon]')!;\n\n    this.$refreshButton.addEventListener('click', () => {\n      this.refresh();\n    });\n  }\n\n  refresh() {\n    this.$buttonIcon.classList.add('fa-spin');\n\n    let src = this.$image.dataset.image || '';\n    const t = uid();\n\n    src = addQuery(src, { t });\n\n    this.$image.addEventListener('load', () => {\n      this.$buttonIcon.classList.remove('fa-spin');\n      this.$input.value = '';\n    }, { once: true });\n\n    this.$image.src = src;\n  }\n\n  clear() {\n    this.$input.value = '';\n  }\n}\n\nuseUniDirective<HTMLElement>('captcha-gregwar', {\n  mounted(el) {\n    module(el, 'captcha.grwgwar', (el) => new GragwarCaptcha(el));\n  }\n});\n\nclass RecaptchaCaptcha {\n  public key: string;\n  public callbackName: string;\n  public jsVerify: string;\n\n  constructor(public el: HTMLElement, public type: string) {\n    useScriptImport('https://www.google.com/recaptcha/api.js');\n\n    this.key = this.el.dataset.key || '';\n    this.callbackName = this.el.dataset.callback || '';\n\n    this.jsVerify = this.el.dataset.jsVerify || '';\n\n    if (this.jsVerify) {\n      const form = this.el.closest('form');\n\n      if (!form) {\n        return;\n      }\n\n      if (type === 'invisible') {\n        form.addEventListener('submit', (e) => {\n          if (form.dataset.passCaptcha) {\n            return;\n          }\n\n          e.preventDefault();\n          e.stopPropagation();\n          e.stopImmediatePropagation();\n\n          grecaptcha.execute();\n        });\n\n        // @ts-ignore\n        window[this.callbackName] = function (response: any) {\n          form.dataset.passCaptcha = 'true';\n          form.requestSubmit();\n        };\n      } else {\n        form.addEventListener('submit', (e) => {\n          if (form.dataset.passCaptcha) {\n            return;\n          }\n\n          e.preventDefault();\n          e.stopPropagation();\n          e.stopImmediatePropagation();\n\n          simpleAlert(__('luna.field.captcha.message.please.check.first'));\n        });\n\n        // @ts-ignore\n        window[this.callbackName] = function (response: any) {\n          form.dataset.passCaptcha = 'true';\n        };\n      }\n    }\n  }\n}\n\nuseUniDirective<HTMLElement>('captcha-recaptcha', {\n  mounted(el, { value }) {\n    module(\n      el,\n      'captcha.recaptcha',\n      (el) => new RecaptchaCaptcha(el as HTMLElement, value)\n    );\n  }\n});\n\n\n"],"names":["el"],"mappings":";AAEA,MAAM,eAAe;AAAA,EAMnB,YAAmB,UAA0B,UAAe,IAAI;AAA7C,SAAA,WAAA;AAA0B,SAAA,UAAA;AAC3C,SAAK,SAAS,KAAK,SAAS,cAAgC,sBAAsB;AAClF,SAAK,SAAS,KAAK,SAAS,cAAgC,sBAAsB;AAClF,SAAK,iBAAiB,KAAK,SAAS,cAAiC,wBAAwB;AAC7F,SAAK,cAAc,KAAK,SAAS,cAA+B,qBAAqB;AAErF,SAAK,eAAe,iBAAiB,SAAS,MAAM;AAClD,WAAK,QAAA;AAAA,IACP,CAAC;AAAA,EACH;AAAA,EAdO;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EAaP,UAAU;AACR,SAAK,YAAY,UAAU,IAAI,SAAS;AAExC,QAAI,MAAM,KAAK,OAAO,QAAQ,SAAS;AACvC,UAAM,IAAI,IAAA;AAEV,UAAM,SAAS,KAAK,EAAE,EAAA,CAAG;AAEzB,SAAK,OAAO,iBAAiB,QAAQ,MAAM;AACzC,WAAK,YAAY,UAAU,OAAO,SAAS;AAC3C,WAAK,OAAO,QAAQ;AAAA,IACtB,GAAG,EAAE,MAAM,MAAM;AAEjB,SAAK,OAAO,MAAM;AAAA,EACpB;AAAA,EAEA,QAAQ;AACN,SAAK,OAAO,QAAQ;AAAA,EACtB;AACF;AAEA,gBAA6B,mBAAmB;AAAA,EAC9C,QAAQ,IAAI;AACV,WAAO,IAAI,mBAAmB,CAACA,QAAO,IAAI,eAAeA,GAAE,CAAC;AAAA,EAC9D;AACF,CAAC;AAED,MAAM,iBAAiB;AAAA,EAKrB,YAAmB,IAAwB,MAAc;AAAtC,SAAA,KAAA;AAAwB,SAAA,OAAA;AACzC,oBAAgB,yCAAyC;AAEzD,SAAK,MAAM,KAAK,GAAG,QAAQ,OAAO;AAClC,SAAK,eAAe,KAAK,GAAG,QAAQ,YAAY;AAEhD,SAAK,WAAW,KAAK,GAAG,QAAQ,YAAY;AAE5C,QAAI,KAAK,UAAU;AACjB,YAAM,OAAO,KAAK,GAAG,QAAQ,MAAM;AAEnC,UAAI,CAAC,MAAM;AACT;AAAA,MACF;AAEA,UAAI,SAAS,aAAa;AACxB,aAAK,iBAAiB,UAAU,CAAC,MAAM;AACrC,cAAI,KAAK,QAAQ,aAAa;AAC5B;AAAA,UACF;AAEA,YAAE,eAAA;AACF,YAAE,gBAAA;AACF,YAAE,yBAAA;AAEF,qBAAW,QAAA;AAAA,QACb,CAAC;AAGD,eAAO,KAAK,YAAY,IAAI,SAAU,UAAe;AACnD,eAAK,QAAQ,cAAc;AAC3B,eAAK,cAAA;AAAA,QACP;AAAA,MACF,OAAO;AACL,aAAK,iBAAiB,UAAU,CAAC,MAAM;AACrC,cAAI,KAAK,QAAQ,aAAa;AAC5B;AAAA,UACF;AAEA,YAAE,eAAA;AACF,YAAE,gBAAA;AACF,YAAE,yBAAA;AAEF,sBAAY,GAAG,+CAA+C,CAAC;AAAA,QACjE,CAAC;AAGD,eAAO,KAAK,YAAY,IAAI,SAAU,UAAe;AACnD,eAAK,QAAQ,cAAc;AAAA,QAC7B;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAAA,EAxDO;AAAA,EACA;AAAA,EACA;AAuDT;AAEA,gBAA6B,qBAAqB;AAAA,EAChD,QAAQ,IAAI,EAAE,SAAS;AACrB;AAAA,MACE;AAAA,MACA;AAAA,MACA,CAACA,QAAO,IAAI,iBAAiBA,KAAmB,KAAK;AAAA,IAAA;AAAA,EAEzD;AACF,CAAC;"}