{"version":3,"file":"captcha.js","sources":["../../src/modules/captcha.ts"],"sourcesContent":["import { __, addQuery, module, simpleAlert, uid, useScriptImport, useUniDirective } from '@windwalker-io/unicorn-next';\r\n\r\nclass GragwarCaptcha {\r\n  public $image!: HTMLImageElement;\r\n  public $input!: HTMLInputElement;\r\n  public $refreshButton!: HTMLButtonElement;\r\n  public $buttonIcon!: HTMLSpanElement;\r\n\r\n  constructor(public $element: Element, public options: any = {}) {\r\n    this.$image = this.$element.querySelector<HTMLImageElement>('[data-captcha-image]')!;\r\n    this.$input = this.$element.querySelector<HTMLInputElement>('[data-captcha-input]')!;\r\n    this.$refreshButton = this.$element.querySelector<HTMLButtonElement>('[data-captcha-refresh]')!;\r\n    this.$buttonIcon = this.$element.querySelector<HTMLSpanElement>('[data-refresh-icon]')!;\r\n\r\n    this.$refreshButton.addEventListener('click', () => {\r\n      this.refresh();\r\n    });\r\n  }\r\n\r\n  refresh() {\r\n    this.$buttonIcon.classList.add('fa-spin');\r\n\r\n    let src = this.$image.dataset.image || '';\r\n    const t = uid();\r\n\r\n    src = addQuery(src, { t });\r\n\r\n    this.$image.addEventListener('load', () => {\r\n      this.$buttonIcon.classList.remove('fa-spin');\r\n      this.$input.value = '';\r\n    }, { once: true });\r\n\r\n    this.$image.src = src;\r\n  }\r\n\r\n  clear() {\r\n    this.$input.value = '';\r\n  }\r\n}\r\n\r\nuseUniDirective<HTMLElement>('captcha-gregwar', {\r\n  mounted(el) {\r\n    module(el, 'captcha.grwgwar', (el) => new GragwarCaptcha(el));\r\n  }\r\n});\r\n\r\nclass RecaptchaCaptcha {\r\n  public key: string;\r\n  public callbackName: string;\r\n  public jsVerify: string;\r\n\r\n  constructor(public el: HTMLElement, public type: string) {\r\n    useScriptImport('https://www.google.com/recaptcha/api.js');\r\n\r\n    this.key = this.el.dataset.key || '';\r\n    this.callbackName = this.el.dataset.callback || '';\r\n\r\n    this.jsVerify = this.el.dataset.jsVerify || '';\r\n\r\n    if (this.jsVerify) {\r\n      const form = this.el.closest('form');\r\n\r\n      if (!form) {\r\n        return;\r\n      }\r\n\r\n      if (type === 'invisible') {\r\n        form.addEventListener('submit', (e) => {\r\n          if (form.dataset.passCaptcha) {\r\n            return;\r\n          }\r\n\r\n          e.preventDefault();\r\n          e.stopPropagation();\r\n          e.stopImmediatePropagation();\r\n\r\n          grecaptcha.execute();\r\n        });\r\n\r\n        // @ts-ignore\r\n        window[this.callbackName] = function (response: any) {\r\n          form.dataset.passCaptcha = 'true';\r\n          form.requestSubmit();\r\n        };\r\n      } else {\r\n        form.addEventListener('submit', (e) => {\r\n          if (form.dataset.passCaptcha) {\r\n            return;\r\n          }\r\n\r\n          e.preventDefault();\r\n          e.stopPropagation();\r\n          e.stopImmediatePropagation();\r\n\r\n          simpleAlert(__('luna.field.captcha.message.please.check.first'));\r\n        });\r\n\r\n        // @ts-ignore\r\n        window[this.callbackName] = function (response: any) {\r\n          form.dataset.passCaptcha = 'true';\r\n        };\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nuseUniDirective<HTMLElement>('captcha-recaptcha', {\r\n  mounted(el, { value }) {\r\n    module(\r\n      el,\r\n      'captcha.recaptcha',\r\n      (el) => new RecaptchaCaptcha(el as HTMLElement, value)\r\n    );\r\n  }\r\n});\r\n\r\n\r\n"],"names":["module","el"],"mappings":";AAEA,MAAM,eAAe;AAAA,EAMnB,YAAmB,UAA0B,UAAe,IAAI;AAA7C,SAAA,WAAA;AAA0B,SAAA,UAAA;AAC3C,SAAK,SAAS,KAAK,SAAS,cAAgC,sBAAsB;AAClF,SAAK,SAAS,KAAK,SAAS,cAAgC,sBAAsB;AAClF,SAAK,iBAAiB,KAAK,SAAS,cAAiC,wBAAwB;AAC7F,SAAK,cAAc,KAAK,SAAS,cAA+B,qBAAqB;AAErF,SAAK,eAAe,iBAAiB,SAAS,MAAM;AAClD,WAAK,QAAA;AAAA,IACP,CAAC;AAAA,EACH;AAAA,EAdO;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EAaP,UAAU;AACR,SAAK,YAAY,UAAU,IAAI,SAAS;AAExC,QAAI,MAAM,KAAK,OAAO,QAAQ,SAAS;AACvC,UAAM,IAAI,IAAA;AAEV,UAAM,SAAS,KAAK,EAAE,EAAA,CAAG;AAEzB,SAAK,OAAO,iBAAiB,QAAQ,MAAM;AACzC,WAAK,YAAY,UAAU,OAAO,SAAS;AAC3C,WAAK,OAAO,QAAQ;AAAA,IACtB,GAAG,EAAE,MAAM,MAAM;AAEjB,SAAK,OAAO,MAAM;AAAA,EACpB;AAAA,EAEA,QAAQ;AACN,SAAK,OAAO,QAAQ;AAAA,EACtB;AACF;AAEA,gBAA6B,mBAAmB;AAAA,EAC9C,QAAQ,IAAI;AACVA,aAAO,IAAI,mBAAmB,CAACC,QAAO,IAAI,eAAeA,GAAE,CAAC;AAAA,EAC9D;AACF,CAAC;AAED,MAAM,iBAAiB;AAAA,EAKrB,YAAmB,IAAwB,MAAc;AAAtC,SAAA,KAAA;AAAwB,SAAA,OAAA;AACzC,oBAAgB,yCAAyC;AAEzD,SAAK,MAAM,KAAK,GAAG,QAAQ,OAAO;AAClC,SAAK,eAAe,KAAK,GAAG,QAAQ,YAAY;AAEhD,SAAK,WAAW,KAAK,GAAG,QAAQ,YAAY;AAE5C,QAAI,KAAK,UAAU;AACjB,YAAM,OAAO,KAAK,GAAG,QAAQ,MAAM;AAEnC,UAAI,CAAC,MAAM;AACT;AAAA,MACF;AAEA,UAAI,SAAS,aAAa;AACxB,aAAK,iBAAiB,UAAU,CAAC,MAAM;AACrC,cAAI,KAAK,QAAQ,aAAa;AAC5B;AAAA,UACF;AAEA,YAAE,eAAA;AACF,YAAE,gBAAA;AACF,YAAE,yBAAA;AAEF,qBAAW,QAAA;AAAA,QACb,CAAC;AAGD,eAAO,KAAK,YAAY,IAAI,SAAU,UAAe;AACnD,eAAK,QAAQ,cAAc;AAC3B,eAAK,cAAA;AAAA,QACP;AAAA,MACF,OAAO;AACL,aAAK,iBAAiB,UAAU,CAAC,MAAM;AACrC,cAAI,KAAK,QAAQ,aAAa;AAC5B;AAAA,UACF;AAEA,YAAE,eAAA;AACF,YAAE,gBAAA;AACF,YAAE,yBAAA;AAEF,sBAAY,GAAG,+CAA+C,CAAC;AAAA,QACjE,CAAC;AAGD,eAAO,KAAK,YAAY,IAAI,SAAU,UAAe;AACnD,eAAK,QAAQ,cAAc;AAAA,QAC7B;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAAA,EAxDO;AAAA,EACA;AAAA,EACA;AAuDT;AAEA,gBAA6B,qBAAqB;AAAA,EAChD,QAAQ,IAAI,EAAE,SAAS;AACrBD;AAAAA,MACE;AAAA,MACA;AAAA,MACA,CAACC,QAAO,IAAI,iBAAiBA,KAAmB,KAAK;AAAA,IAAA;AAAA,EAEzD;AACF,CAAC;"}