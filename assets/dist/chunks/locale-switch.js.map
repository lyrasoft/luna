{"version":3,"file":"locale-switch.js","sources":["../../src/modules/locale-switch.ts"],"sourcesContent":["import { __, module, useForm, useFormValidationSync, useUniDirective } from '@windwalker-io/unicorn-next';\n\ninterface LocaleSwitchOptions {\n  type: string;\n  table: string;\n  routeName: string;\n  currentId: string;\n  defaultId: string;\n  inputId: string;\n  langField: string;\n  titleField: string;\n  triggerInputName: string;\n}\n\nexport class LocaleSwitchModal {\n  public options: LocaleSwitchOptions = {\n    type: '',\n    table: '',\n    routeName: '',\n    currentId: '',\n    defaultId: '',\n    inputId: '',\n    langField: '',\n    titleField: '',\n    triggerInputName: 'lang_assoc'\n  };\n\n  constructor(public el: HTMLElement, options: Partial<LocaleSwitchOptions> = {}) {\n    // the modal element\n    this.options = Object.assign({}, this.options, options);\n\n    let buttons = this.el.querySelectorAll<HTMLButtonElement|HTMLAnchorElement>('[data-task=create_lang_version]');\n\n    for (const button of buttons) {\n      button.addEventListener('click', (e) => {\n        this.saveCurrentAndCreateLang(button);\n      });\n    }\n\n    buttons = this.el.querySelectorAll<HTMLButtonElement|HTMLAnchorElement>('[data-task=switch_lang]');\n\n    for (const button of buttons) {\n      button.addEventListener('click', (e) => {\n        this.switchLang(button);\n      });\n    }\n  }\n\n  validateForm() {\n    const input = document.querySelector<HTMLInputElement>('#' + this.options.inputId)!;\n\n    const form = input.form;\n\n    if (!form) {\n      return undefined;\n    }\n\n    const validation = useFormValidationSync(form)!;\n\n    const valid = validation.validateAll();\n\n    if (!valid) {\n      alert(__('luna.field.locale.switch.message.form.invalid'));\n      throw new Error('Form invalid');\n    }\n\n    return form;\n  }\n\n  /**\n   * @param {HTMLButtonElement} button\n   */\n  saveCurrentAndCreateLang(button: HTMLAnchorElement | HTMLButtonElement) {\n    const form = this.validateForm()!;\n\n    useForm(form)?.post(\n      null,\n      {\n        [this.options.triggerInputName]: {\n          task: 'create',\n          type: this.options.type,\n          table: this.options.table,\n          routeName: this.options.routeName,\n          code: button.dataset.lang,\n          copy: button.dataset.copy,\n          langField: this.options.langField,\n          titleField: this.options.titleField,\n          currentId: this.options.currentId,\n          defaultId: this.options.defaultId\n        }\n      }\n    );\n  }\n\n  switchLang(button: HTMLAnchorElement | HTMLButtonElement) {\n    const form = this.validateForm()!;\n\n    useForm(form)?.post(\n      null,\n      {\n        [this.options.triggerInputName]: {\n          task: 'switch',\n          table: this.options.table,\n          routeName: this.options.routeName,\n          targetId: button.dataset.targetId\n        }\n      }\n    );\n  }\n}\n\nuseUniDirective(\n  'locale-switch-modal',\n  {\n    mounted(el, { value }) {\n      const options = JSON.parse(value);\n\n      module(el, 'locale.switch', () => new LocaleSwitchModal(el as HTMLElement, options));\n    }\n  }\n);\n\n"],"names":[],"mappings":";AAcO,MAAM,kBAAkB;AAAA,EAa7B,YAAmB,IAAiB,UAAwC,IAAI;AAA7D,SAAA,KAAA;AAEjB,SAAK,UAAU,OAAO,OAAO,CAAA,GAAI,KAAK,SAAS,OAAO;AAEtD,QAAI,UAAU,KAAK,GAAG,iBAAsD,iCAAiC;AAE7G,eAAW,UAAU,SAAS;AAC5B,aAAO,iBAAiB,SAAS,CAAC,MAAM;AACtC,aAAK,yBAAyB,MAAM;AAAA,MACtC,CAAC;AAAA,IACH;AAEA,cAAU,KAAK,GAAG,iBAAsD,yBAAyB;AAEjG,eAAW,UAAU,SAAS;AAC5B,aAAO,iBAAiB,SAAS,CAAC,MAAM;AACtC,aAAK,WAAW,MAAM;AAAA,MACxB,CAAC;AAAA,IACH;AAAA,EACF;AAAA,EA/BO,UAA+B;AAAA,IACpC,MAAM;AAAA,IACN,OAAO;AAAA,IACP,WAAW;AAAA,IACX,WAAW;AAAA,IACX,WAAW;AAAA,IACX,SAAS;AAAA,IACT,WAAW;AAAA,IACX,YAAY;AAAA,IACZ,kBAAkB;AAAA,EAAA;AAAA,EAwBpB,eAAe;AACb,UAAM,QAAQ,SAAS,cAAgC,MAAM,KAAK,QAAQ,OAAO;AAEjF,UAAM,OAAO,MAAM;AAEnB,QAAI,CAAC,MAAM;AACT,aAAO;AAAA,IACT;AAEA,UAAM,aAAa,sBAAsB,IAAI;AAE7C,UAAM,QAAQ,WAAW,YAAA;AAEzB,QAAI,CAAC,OAAO;AACV,YAAM,GAAG,+CAA+C,CAAC;AACzD,YAAM,IAAI,MAAM,cAAc;AAAA,IAChC;AAEA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,yBAAyB,QAA+C;AACtE,UAAM,OAAO,KAAK,aAAA;AAElB,YAAQ,IAAI,GAAG;AAAA,MACb;AAAA,MACA;AAAA,QACE,CAAC,KAAK,QAAQ,gBAAgB,GAAG;AAAA,UAC/B,MAAM;AAAA,UACN,MAAM,KAAK,QAAQ;AAAA,UACnB,OAAO,KAAK,QAAQ;AAAA,UACpB,WAAW,KAAK,QAAQ;AAAA,UACxB,MAAM,OAAO,QAAQ;AAAA,UACrB,MAAM,OAAO,QAAQ;AAAA,UACrB,WAAW,KAAK,QAAQ;AAAA,UACxB,YAAY,KAAK,QAAQ;AAAA,UACzB,WAAW,KAAK,QAAQ;AAAA,UACxB,WAAW,KAAK,QAAQ;AAAA,QAAA;AAAA,MAC1B;AAAA,IACF;AAAA,EAEJ;AAAA,EAEA,WAAW,QAA+C;AACxD,UAAM,OAAO,KAAK,aAAA;AAElB,YAAQ,IAAI,GAAG;AAAA,MACb;AAAA,MACA;AAAA,QACE,CAAC,KAAK,QAAQ,gBAAgB,GAAG;AAAA,UAC/B,MAAM;AAAA,UACN,OAAO,KAAK,QAAQ;AAAA,UACpB,WAAW,KAAK,QAAQ;AAAA,UACxB,UAAU,OAAO,QAAQ;AAAA,QAAA;AAAA,MAC3B;AAAA,IACF;AAAA,EAEJ;AACF;AAEA;AAAA,EACE;AAAA,EACA;AAAA,IACE,QAAQ,IAAI,EAAE,SAAS;AACrB,YAAM,UAAU,KAAK,MAAM,KAAK;AAEhC,aAAO,IAAI,iBAAiB,MAAM,IAAI,kBAAkB,IAAmB,OAAO,CAAC;AAAA,IACrF;AAAA,EAAA;AAEJ;"}