import { _ as __vitePreload } from "../page-builder.js";
import "@windwalker-io/unicorn-next";
import "vue";
import "./SingleImage.js";
import "./SliderInput.js";
import "vue-draggable-plus";
import "bootstrap";
import "./BoxOffset.js";
import "./RwdGroup.js";
import "./ButtonRadio.js";
import "./RwdTitleOptions.js";
import "./UnicornSwitcher.js";
function isPlainObject(val) {
  return val && typeof val === "object" && !Array.isArray(val);
}
function mergeDeep(target, ...sources) {
  let out = isPlainObject(target) ? { ...target } : target;
  for (const source of sources) {
    if (Array.isArray(source)) {
      out = Array.isArray(out) ? out.concat(source) : source;
      continue;
    }
    if (isPlainObject(source)) {
      out = { ...isPlainObject(out) ? out : {} };
      for (const key of Object.keys(source)) {
        out[key] = key in out ? mergeDeep(out[key], source[key]) : source[key];
      }
      continue;
    }
    out = source;
  }
  return out;
}
class Stack {
  constructor(store = []) {
    this.store = store;
    this.observers = [];
  }
  push(value) {
    const r = this.store.push(value ?? true);
    this.notice();
    return r;
  }
  pop() {
    const r = this.store.pop();
    this.notice();
    return r;
  }
  clear() {
    this.store = [];
    this.notice();
    return this;
  }
  isEmpty() {
    return this.store.length === 0;
  }
  get length() {
    return this.store.length;
  }
  peek() {
    return this.store;
  }
  observe(handler) {
    this.observers.push({
      handler,
      once: false
    });
    return () => {
      this.off(handler);
    };
  }
  once(handler) {
    this.observers.push({
      handler,
      once: true
    });
    return () => {
      this.off(handler);
    };
  }
  notice() {
    this.observers.forEach((observer) => {
      observer.handler(this, this.length);
    });
    this.observers = this.observers.filter((observer) => observer.once !== true);
    return this;
  }
  off(callback) {
    this.observers = this.observers.filter((observer) => observer.handler !== callback);
    return this;
  }
}
function stack(store = []) {
  return new Stack(store);
}
function useScriptImport(src, attrs = {}) {
  const script = document.createElement("script");
  script.src = resolveUrl(src);
  for (const key in attrs) {
    script.setAttribute(key, attrs[key]);
  }
  return new Promise((resolve, reject) => {
    script.onload = () => {
      resolve();
      document.body.removeChild(script);
    };
    script.onerror = (e) => {
      reject(e);
      document.body.removeChild(script);
    };
    document.body.appendChild(script);
  });
}
let importMap;
function parseImportMap() {
  const importMapScript = document.querySelector('script[type="importmap"]');
  if (importMapScript) {
    try {
      return JSON.parse(importMapScript.textContent || "{}").imports || {};
    } catch (e) {
      console.error("Failed to parse import map:", e);
    }
  }
  return {};
}
function resolveUrl(specifier) {
  importMap ??= parseImportMap();
  for (const [prefix, target] of Object.entries(importMap)) {
    if (specifier === prefix) {
      return target;
    }
  }
  for (const [prefix, target] of Object.entries(importMap)) {
    if (specifier.startsWith(prefix)) {
      return specifier.replace(prefix, target);
    }
  }
  return specifier;
}
async function useHttpClient(config) {
  const { createHttpClient } = await __vitePreload(async () => {
    const { createHttpClient: createHttpClient2 } = await import("./http-client.js");
    return { createHttpClient: createHttpClient2 };
  }, true ? [] : void 0);
  return createHttpClient(config);
}
const stacks = {};
function useStack(name = "default", store = []) {
  return stacks[name] ??= createStack(store);
}
function createStack(store = []) {
  return stack(store);
}
const instances = {};
let hooks = [];
let imported = false;
async function get(selector, options = {}) {
  return instances[selector] ??= await create(document.querySelector(selector), options);
}
async function create(selector, options = {}) {
  const tinymce2 = await loadTinymce();
  let el;
  if (typeof selector === "string") {
    el = document.querySelector(selector);
  } else {
    el = selector;
  }
  return new TinymceController(tinymce2, el, options);
}
function destroy(selector) {
  delete instances[selector];
}
function addHook(handler) {
  hooks.push(handler);
}
function clearHooks() {
  hooks = [];
}
async function loadTinymce() {
  if (imported) {
    return tinymce;
  }
  await useScriptImport("@tinymce");
  for (const hook of hooks) {
    hook(tinymce);
  }
  await registerDragPlugin(tinymce);
  imported = true;
  return tinymce;
}
const defaultOptions = {};
class TinymceController {
  constructor(tinymce2, element, options) {
    this.tinymce = tinymce2;
    this.element = element;
    options.target = element;
    this.options = mergeDeep(
      {
        unicorn: {
          stack_name: "uploading"
        }
      },
      defaultOptions,
      this.prepareOptions(options, tinymce2.majorVersion)
    );
    tinymce2.EditorManager.init(this.options).then((editor) => {
      this.editor = editor[0];
    });
  }
  editor;
  options = {};
  prepareOptions(options, version = "6") {
    const defaults = {};
    if (options.images_upload_url) {
      defaults.paste_data_images = true;
      defaults.remove_script_host = false;
      defaults.relative_urls = false;
      if (Number(version) >= 6) {
        defaults.images_upload_handler = (blobInfo, progress) => this.imageUploadHandler(blobInfo, progress);
      } else {
        options.plugins.push("paste");
        defaults.images_upload_handler = (blobInfo, success, failure, progress) => this.imageUploadHandler(blobInfo, progress).then((url) => {
          success(url);
          return url;
        }).catch((e) => {
          failure(e.message, { remove: true });
          throw e;
        });
      }
    }
    defaults.plugins = defaults.plugins || [];
    defaults.setup = (editor) => {
      editor.on("change", () => {
        this.tinymce.triggerSave();
      });
    };
    options = mergeDeep({}, defaults, options);
    if (options.plugins.indexOf("unicorndragdrop") === -1) {
      options.plugins.push("unicorndragdrop");
    }
    return options;
  }
  insert(text) {
    this.editor?.insertContent(text);
  }
  getValue() {
    return this.editor?.getContent() ?? "";
  }
  setValue(text) {
    this.editor?.setContent(text);
  }
  // filePickerCallback(callback, value, meta) {
  //   const input = document.createElement('input');
  //   input.setAttribute('type', 'file');
  //   input.style.display = 'none';
  //
  //   if (meta.filetype === 'image') {
  //     input.setAttribute('accept', `image/\*`);
  //   }
  //
  //   document.body.appendChild(input);
  //
  //   input.onchange = function () {
  //     const file = this.files[0];
  //
  //     const reader = new FileReader();
  //     reader.onload = function () {
  //       const id = 'blobid' + (new Date()).getTime();
  //       const blobCache =  tinymce.activeEditor.editorUpload.blobCache;
  //       const base64 = reader.result.split(',')[1];
  //       const blobInfo = blobCache.create(id, file, base64);
  //       blobCache.add(blobInfo);
  //
  //       /* call the callback and populate the Title field with the file name */
  //       callback(blobInfo.blobUri(), { title: file.name, text: file.name });
  //     };
  //     reader.readAsDataURL(file);
  //     input.remove();
  //   };
  //
  //   input.click();
  // }
  async imageUploadHandler(blobInfo, progress) {
    const element = this.element;
    element.dispatchEvent(new CustomEvent("upload-start"));
    const formData = new FormData();
    formData.append("file", blobInfo.blob(), blobInfo.filename());
    const stack2 = useStack(this.options.unicorn.stack_name);
    stack2.push(true);
    const { post, isAxiosError } = await useHttpClient();
    try {
      let res = await post(
        this.options.images_upload_url,
        formData,
        {
          withCredentials: false,
          onUploadProgress: (e) => {
            progress(e.loaded / e.total * 100);
          }
        }
      );
      element.dispatchEvent(new CustomEvent("upload-success"));
      return res.data.data.url;
    } catch (err) {
      if (isAxiosError(err)) {
        const message = err?.response?.data?.message || err.message;
        console.error(err?.response?.data?.message || err.message, err);
        element.dispatchEvent(new CustomEvent("upload-error", { detail: err }));
        return Promise.reject({ message, remove: true });
      }
      throw err;
    } finally {
      element.dispatchEvent(new CustomEvent("upload-complete"));
      stack2.pop();
    }
  }
}
function registerDragPlugin(tinymce2) {
  tinymce2.PluginManager.add("unicorndragdrop", function(editor) {
    tinymce2.DOM.bind(document, "dragleave", function(e) {
      e.stopPropagation();
      e.preventDefault();
      if (tinymce2.activeEditor) {
        tinymce2.activeEditor.contentAreaContainer.style.transition = "all .3s";
        tinymce2.activeEditor.contentAreaContainer.style.borderWidth = "";
      }
      return false;
    });
    if (typeof FormData !== "undefined") {
      editor.on("dragenter", (e) => {
        e.stopPropagation();
        return false;
      });
      editor.on("dragover", (e) => {
        e.preventDefault();
        if (tinymce2.activeEditor) {
          tinymce2.activeEditor.contentAreaContainer.style.transition = "all .3s";
          tinymce2.activeEditor.contentAreaContainer.style.border = "3px dashed rgba(0, 0, 0, .35)";
        }
        return false;
      });
      editor.on("drop", (e) => {
        editor.contentAreaContainer.style.borderWidth = "";
        editor.contentAreaContainer.style.borderWidth = "";
      });
    }
  });
  return Promise.resolve();
}
export {
  TinymceController,
  addHook,
  clearHooks,
  create,
  destroy,
  get
};


//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQ08sU0FBUyxjQUFjLEtBQXNDO0FBQ2xFLFNBQU8sT0FBTyxPQUFPLFFBQVEsWUFBWSxDQUFDLE1BQU0sUUFBUSxHQUFHO0FBQzdEO0FBRU8sU0FBUyxVQUFtQyxXQUF1QixTQUFtQjtBQUMzRixNQUFJLE1BQVcsY0FBYyxNQUFNLElBQUksRUFBRSxHQUFHLFdBQVc7QUFFdkQsYUFBVyxVQUFVLFNBQVM7QUFDNUIsUUFBSSxNQUFNLFFBQVEsTUFBTSxHQUFHO0FBQ3pCLFlBQU8sTUFBTSxRQUFRLEdBQUcsSUFBSSxJQUFJLE9BQU8sTUFBTSxJQUFJO0FBQ2pEO0FBQUEsSUFDRjtBQUNBLFFBQUksY0FBYyxNQUFNLEdBQUc7QUFDekIsWUFBTSxFQUFFLEdBQUksY0FBYyxHQUFHLElBQUksTUFBTSxHQUFDO0FBQ3hDLGlCQUFXLE9BQU8sT0FBTyxLQUFLLE1BQU0sR0FBRztBQUNyQyxZQUFJLEdBQUcsSUFDTCxPQUFPLE1BQU0sVUFBVSxJQUFJLEdBQUcsR0FBRyxPQUFPLEdBQUcsQ0FBQyxJQUFJLE9BQU8sR0FBRztBQUFBLE1BQzlEO0FBQ0E7QUFBQSxJQUNGO0FBQ0EsVUFBTTtBQUFBLEVBQ1I7QUFDQSxTQUFPO0FBQ1Q7QUNwQk8sTUFBTSxNQUFlO0FBQUEsRUFHMUIsWUFBc0IsUUFBeUIsSUFBSTtBQUE3QjtBQUZ0QixxQkFBMkQ7QUFBQSxFQUkzRDtBQUFBLEVBRUEsS0FBSyxPQUFtQjtBQUN0QixVQUFNLElBQUksS0FBSyxNQUFNLEtBQUssU0FBUyxJQUFJO0FBRXZDLFNBQUs7QUFFTCxXQUFPO0FBQUEsRUFDVDtBQUFBLEVBRUEsTUFBNEI7QUFDMUIsVUFBTSxJQUFJLEtBQUssTUFBTTtBQUVyQixTQUFLO0FBRUwsV0FBTztBQUFBLEVBQ1Q7QUFBQSxFQUVBLFFBQWM7QUFDWixTQUFLLFFBQVE7QUFFYixTQUFLO0FBRUwsV0FBTztBQUFBLEVBQ1Q7QUFBQSxFQUVBLFVBQW1CO0FBQ2pCLFdBQU8sS0FBSyxNQUFNLFdBQVc7QUFBQSxFQUMvQjtBQUFBLEVBRUEsSUFBSSxTQUFTO0FBQ1gsV0FBTyxLQUFLLE1BQU07QUFBQSxFQUNwQjtBQUFBLEVBRUEsT0FBd0I7QUFDdEIsV0FBTyxLQUFLO0FBQUEsRUFDZDtBQUFBLEVBRUEsUUFBUSxTQUE2RDtBQUNuRSxTQUFLLFVBQVUsS0FBSztBQUFBLE1BQ2xCO0FBQUEsTUFDQSxNQUFNO0FBQUEsS0FDUDtBQUVELFdBQU8sTUFBTTtBQUNYLFdBQUssSUFBSSxPQUFPO0FBQUEsSUFDbEI7QUFBQSxFQUNGO0FBQUEsRUFFQSxLQUFLLFNBQXNDO0FBQ3pDLFNBQUssVUFBVSxLQUFLO0FBQUEsTUFDbEI7QUFBQSxNQUNBLE1BQU07QUFBQSxLQUNQO0FBRUQsV0FBTyxNQUFNO0FBQ1gsV0FBSyxJQUFJLE9BQU87QUFBQSxJQUNsQjtBQUFBLEVBQ0Y7QUFBQSxFQUVBLFNBQWU7QUFDYixTQUFLLFVBQVUsUUFBUSxDQUFDLGFBQWE7QUFDbkMsZUFBUyxRQUFRLE1BQU0sS0FBSyxNQUFNO0FBQUEsSUFDcEMsQ0FBQztBQUVELFNBQUssWUFBWSxLQUFLLFVBQVUsT0FBTyxDQUFDLGFBQWEsU0FBUyxTQUFTLElBQUk7QUFFM0UsV0FBTztBQUFBLEVBQ1Q7QUFBQSxFQUVBLElBQUksVUFBa0M7QUFDcEMsU0FBSyxZQUFZLEtBQUssVUFBVSxPQUFPLENBQUMsYUFBYSxTQUFTLFlBQVksUUFBUTtBQUNsRixXQUFPO0FBQUEsRUFDVDtBQUNGO0FBRU8sU0FBUyxNQUFlLFFBQWUsSUFBSTtBQUNoRCxTQUFPLElBQUksTUFBUyxLQUFLO0FBQzNCO0FDcEZPLFNBQVMsZ0JBQWdCLEtBQWEsUUFBZ0MsSUFBbUI7QUFDOUYsUUFBTSxTQUFTLFNBQVMsY0FBYyxRQUFRO0FBQzlDLFNBQU8sTUFBTSxXQUFXLEdBQUc7QUFFM0IsYUFBVyxPQUFPLE9BQU87QUFDdkIsV0FBTyxhQUFhLEtBQUssTUFBTSxHQUFHLENBQUM7QUFBQSxFQUNyQztBQUVBLFNBQU8sSUFBSSxRQUFRLENBQUMsU0FBUyxXQUFXO0FBQ3RDLFdBQU8sU0FBUyxNQUFNO0FBQ3BCO0FBQ0EsZUFBUyxLQUFLLFlBQVksTUFBTTtBQUFBLElBQ2xDO0FBQ0EsV0FBTyxVQUFVLENBQUMsTUFBTTtBQUN0QixhQUFPLENBQUM7QUFDUixlQUFTLEtBQUssWUFBWSxNQUFNO0FBQUEsSUFDbEM7QUFFQSxhQUFTLEtBQUssWUFBWSxNQUFNO0FBQUEsRUFDbEMsQ0FBQztBQUNIO0FBbUdBLElBQUk7QUFFSixTQUFTLGlCQUFpQjtBQUN4QixRQUFNLGtCQUFrQixTQUFTLGNBQWMsMEJBQTBCO0FBQ3pFLE1BQUksaUJBQWlCO0FBQ25CLFFBQUk7QUFDRixhQUFPLEtBQUssTUFBTSxnQkFBZ0IsZUFBZSxJQUFJLEVBQUUsV0FBVztBQUFBLElBQ3BFLFNBQVMsR0FBRztBQUNWLGNBQVEsTUFBTSwrQkFBK0IsQ0FBQztBQUFBLElBQ2hEO0FBQUEsRUFDRjtBQUNBLFNBQU87QUFDVDtBQUVBLFNBQVMsV0FBVyxXQUFtQjtBQUNyQyxnQkFBYztBQUVkLGFBQVcsQ0FBQyxRQUFRLE1BQU0sS0FBSyxPQUFPLFFBQVEsU0FBUyxHQUFHO0FBQ3hELFFBQUksY0FBYyxRQUFRO0FBQ3hCLGFBQU87QUFBQSxJQUNUO0FBQUEsRUFDRjtBQUVBLGFBQVcsQ0FBQyxRQUFRLE1BQU0sS0FBSyxPQUFPLFFBQVEsU0FBUyxHQUFHO0FBQ3hELFFBQUksVUFBVSxXQUFXLE1BQU0sR0FBRztBQUNoQyxhQUFPLFVBQVUsUUFBUSxRQUFRLE1BQU07QUFBQSxJQUN6QztBQUFBLEVBQ0Y7QUFDQSxTQUFPO0FBQ1Q7QUNuSkEsZUFBc0IsY0FBYyxRQUEwRTtBQUM1RyxRQUFNLEVBQUUscUJBQXFCOzBEQUFNLE9BQU8sa0JBQXVCO0FBQUEsK0JBQUFBLGtCQUFBO0FBQUE7QUFFakUsU0FBTyxpQkFBaUIsTUFBeUM7QUFDbkU7QUNKQSxNQUFNLFNBQTRCO0FBRTNCLFNBQVMsU0FBa0IsT0FBZSxXQUFXLFFBQWUsSUFBYztBQUN2RixTQUFPLE9BQU8sSUFBSSxNQUFNLFlBQWUsS0FBSztBQUM5QztBQUVPLFNBQVMsWUFBcUIsUUFBZSxJQUFjO0FBQ2hFLFNBQU8sTUFBUyxLQUFLO0FBQ3ZCO0FDTkEsTUFBTSxZQUEyQztBQUNqRCxJQUFJLFFBQXFEO0FBRXpELElBQUksV0FBVztBQUlmLGVBQXNCLElBQ3BCLFVBQ0EsVUFBK0IsSUFDSDtBQUM1QixTQUFPLFVBQVUsUUFBUSxNQUFNLE1BQU0sT0FBTyxTQUFTLGNBQTJCLFFBQVEsR0FBSSxPQUFPO0FBQ3JHO0FBRUEsZUFBc0IsT0FDcEIsVUFDQSxVQUErQixJQUNIO0FBQzVCLFFBQU1DLFdBQVUsTUFBTTtBQUN0QixNQUFJO0FBRUosTUFBSSxPQUFPLGFBQWEsVUFBVTtBQUNoQyxTQUFLLFNBQVMsY0FBMkIsUUFBUTtBQUFBLEVBQ25ELE9BQU87QUFDTCxTQUFLO0FBQUEsRUFDUDtBQUVBLFNBQU8sSUFBSSxrQkFBa0JBLFVBQVMsSUFBSSxPQUFPO0FBQ25EO0FBRU8sU0FBUyxRQUFRLFVBQXdCO0FBQzlDLFNBQU8sVUFBVSxRQUFRO0FBQzNCO0FBRU8sU0FBUyxRQUFRLFNBQW9EO0FBQzFFLFFBQU0sS0FBSyxPQUFPO0FBQ3BCO0FBRU8sU0FBUyxhQUFhO0FBQzNCLFVBQVE7QUFDVjtBQUVBLGVBQWUsY0FBZ0M7QUFDN0MsTUFBSSxVQUFVO0FBQ1osV0FBTztBQUFBLEVBQ1Q7QUFFQSxRQUFNLGdCQUFnQixVQUFVO0FBRWhDLGFBQVcsUUFBUSxPQUFPO0FBQ3hCLFNBQUssT0FBTztBQUFBLEVBQ2Q7QUFDQSxRQUFNLG1CQUFtQixPQUFPO0FBQ2hDLGFBQVc7QUFDWCxTQUFPO0FBQ1Q7QUFFQSxNQUFNLGlCQUFzQztBQUVyQyxNQUFNLGtCQUFrQjtBQUFBLEVBSTdCLFlBQXNCQSxVQUF5QixTQUFzQixTQUE4QjtBQUE3RSxtQkFBQUE7QUFBeUI7QUFDN0MsWUFBUSxTQUFTO0FBRWpCLFNBQUssVUFBVTtBQUFBLE1BQ2I7QUFBQSxRQUNFLFNBQVM7QUFBQSxVQUNQLFlBQVk7QUFBQTtBQUFBLE1BQ2Q7QUFBQSxNQUVGO0FBQUEsTUFDQSxLQUFLLGVBQWUsU0FBU0EsU0FBUSxZQUFZO0FBQUE7QUFHbkRBLGFBQVEsY0FBYyxLQUFLLEtBQUssT0FBTyxFQUFFLEtBQUssQ0FBQyxXQUFXO0FBQ3hELFdBQUssU0FBUyxPQUFPLENBQUM7QUFBQSxJQUN4QixDQUFDO0FBQUEsRUFDSDtBQUFBLEVBbkJBO0FBQUEsRUFDQSxVQUErQjtBQUFBLEVBb0IvQixlQUFlLFNBQThCLFVBQVUsS0FBSztBQUMxRCxVQUFNLFdBQW1DO0FBRXpDLFFBQUksUUFBUSxtQkFBbUI7QUFDN0IsZUFBUyxvQkFBb0I7QUFDN0IsZUFBUyxxQkFBcUI7QUFDOUIsZUFBUyxnQkFBZ0I7QUFFekIsVUFBSSxPQUFPLE9BQU8sS0FBSyxHQUFHO0FBQ3hCLGlCQUFTLHdCQUF3QixDQUFDLFVBQVUsYUFDMUMsS0FBSyxtQkFBbUIsVUFBVSxRQUFRO0FBQUEsTUFDOUMsT0FBTztBQUNMLGdCQUFRLFFBQVEsS0FBSyxPQUFPO0FBRzVCLGlCQUFTLHdCQUF3QixDQUFDLFVBQVUsU0FBUyxTQUFTLGFBQzVELEtBQUssbUJBQW1CLFVBQVUsUUFBUSxFQUN2QyxLQUFLLENBQUMsUUFBUTtBQUNiLGtCQUFRLEdBQUc7QUFDWCxpQkFBTztBQUFBLFFBQ1QsQ0FBQyxFQUNBLE1BQU0sQ0FBQyxNQUFNO0FBQ1osa0JBQVEsRUFBRSxTQUFTLEVBQUUsUUFBUSxNQUFNO0FBQ25DLGdCQUFNO0FBQUEsUUFDUixDQUFDO0FBQUEsTUFDUDtBQUFBLElBQ0Y7QUFJQSxhQUFTLFVBQVUsU0FBUyxXQUFXO0FBRXZDLGFBQVMsUUFBUSxDQUFDLFdBQVc7QUFDM0IsYUFBTyxHQUFHLFVBQVUsTUFBTTtBQUN4QixhQUFLLFFBQVE7QUFBQSxNQUNmLENBQUM7QUFBQSxJQUNIO0FBRUEsY0FBVSxVQUFVLElBQUksVUFBVSxPQUFPO0FBRXpDLFFBQUksUUFBUSxRQUFRLFFBQVEsaUJBQWlCLE1BQU0sSUFBSTtBQUNyRCxjQUFRLFFBQVEsS0FBSyxpQkFBaUI7QUFBQSxJQUN4QztBQUVBLFdBQU87QUFBQSxFQUNUO0FBQUEsRUFFQSxPQUFPLE1BQWM7QUFDbkIsU0FBSyxRQUFRLGNBQWMsSUFBSTtBQUFBLEVBQ2pDO0FBQUEsRUFFQSxXQUFtQjtBQUNqQixXQUFPLEtBQUssUUFBUSxnQkFBZ0I7QUFBQSxFQUN0QztBQUFBLEVBRUEsU0FBUyxNQUFvQjtBQUMzQixTQUFLLFFBQVEsV0FBVyxJQUFJO0FBQUEsRUFDOUI7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBa0NBLE1BQU0sbUJBQW1CLFVBQWtDLFVBQWtDO0FBQzNGLFVBQU0sVUFBVSxLQUFLO0FBRXJCLFlBQVEsY0FBYyxJQUFJLFlBQVksY0FBYyxDQUFDO0FBRXJELFVBQU0sV0FBVyxJQUFJO0FBQ3JCLGFBQVMsT0FBTyxRQUFRLFNBQVMsUUFBUSxTQUFTLFVBQVU7QUFFNUQsVUFBTUMsU0FBUSxTQUFTLEtBQUssUUFBUSxRQUFRLFVBQVU7QUFDdEQsSUFBQUEsT0FBTSxLQUFLLElBQUk7QUFFZixVQUFNLEVBQUUsTUFBTSxpQkFBaUIsTUFBTTtBQUVyQyxRQUFJO0FBQ0YsVUFBSSxNQUFNLE1BQU07QUFBQSxRQUNkLEtBQUssUUFBUTtBQUFBLFFBQ2I7QUFBQSxRQUNBO0FBQUEsVUFDRSxpQkFBaUI7QUFBQSxVQUNqQixrQkFBa0IsQ0FBQyxNQUFNO0FBQ3ZCLHFCQUFTLEVBQUUsU0FBUyxFQUFFLFFBQVMsR0FBRztBQUFBLFVBQ3BDO0FBQUE7QUFBQSxNQUNGO0FBRUYsY0FBUSxjQUFjLElBQUksWUFBWSxnQkFBZ0IsQ0FBQztBQUV2RCxhQUFPLElBQUksS0FBSyxLQUFLO0FBQUEsSUFDdkIsU0FBUyxLQUFLO0FBQ1osVUFBSSxhQUFhLEdBQUcsR0FBRztBQUNyQixjQUFNLFVBQVUsS0FBSyxVQUFVLE1BQU0sV0FBVyxJQUFJO0FBQ3BELGdCQUFRLE1BQU0sS0FBSyxVQUFVLE1BQU0sV0FBVyxJQUFJLFNBQVMsR0FBRztBQUM5RCxnQkFBUSxjQUFjLElBQUksWUFBWSxnQkFBZ0IsRUFBRSxRQUFRLEtBQUssQ0FBQztBQUV0RSxlQUFPLFFBQVEsT0FBTyxFQUFFLFNBQVMsUUFBUSxNQUFNO0FBQUEsTUFDakQ7QUFFQSxZQUFNO0FBQUEsSUFDUjtBQUNFLGNBQVEsY0FBYyxJQUFJLFlBQVksaUJBQWlCLENBQUM7QUFDeEQsTUFBQUEsT0FBTTtBQUFBLElBQ1I7QUFBQSxFQUNGO0FBQ0Y7QUFFQSxTQUFTLG1CQUFtQkQsVUFBa0I7QUFDNUNBLFdBQVEsY0FBYyxJQUFJLG1CQUFtQixTQUFVLFFBQVE7QUFFN0RBLGFBQVEsSUFBSSxLQUFLLFVBQVUsYUFBYSxTQUFVLEdBQUc7QUFDbkQsUUFBRTtBQUNGLFFBQUU7QUFFRixVQUFJQSxTQUFRLGNBQWM7QUFDeEJBLGlCQUFRLGFBQWEscUJBQXFCLE1BQU0sYUFBYTtBQUM3REEsaUJBQVEsYUFBYSxxQkFBcUIsTUFBTSxjQUFjO0FBQUEsTUFDaEU7QUFFQSxhQUFPO0FBQUEsSUFDVCxDQUFDO0FBRUQsUUFBSSxPQUFPLGFBQWEsYUFBYTtBQUduQyxhQUFPLEdBQUcsYUFBYSxPQUFLO0FBQzFCLFVBQUU7QUFDRixlQUFPO0FBQUEsTUFDVCxDQUFDO0FBR0QsYUFBTyxHQUFHLFlBQVksT0FBSztBQUN6QixVQUFFO0FBRUYsWUFBSUEsU0FBUSxjQUFjO0FBQ3hCQSxtQkFBUSxhQUFhLHFCQUFxQixNQUFNLGFBQWE7QUFDN0RBLG1CQUFRLGFBQWEscUJBQXFCLE1BQU0sU0FBUztBQUFBLFFBQzNEO0FBRUEsZUFBTztBQUFBLE1BQ1QsQ0FBQztBQUVELGFBQU8sR0FBRyxRQUFRLE9BQUs7QUFDckIsZUFBTyxxQkFBcUIsTUFBTSxjQUFjO0FBQ2hELGVBQU8scUJBQXFCLE1BQU0sY0FBYztBQUFBLE1BQ2xELENBQUM7QUFBQSxJQUNIO0FBQUEsRUFDRixDQUFDO0FBRUQsU0FBTyxRQUFRO0FBQ2pCIiwibmFtZXMiOlsiY3JlYXRlSHR0cENsaWVudCIsInRpbnltY2UiLCJzdGFjayJdLCJpZ25vcmVMaXN0IjpbMV0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vd2luZHdhbGtlci91bmljb3JuL2Fzc2V0cy9zcmMvdXRpbGl0aWVzL2Fyci50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AbHlyYXNvZnQvdHMtdG9vbGtpdC9zcmMvZ2VuZXJpYy9zdGFjay50cyIsIi4uLy4uLy4uLy4uLy4uL3dpbmR3YWxrZXIvdW5pY29ybi9hc3NldHMvc3JjL3NlcnZpY2UvbG9hZGVyLnRzIiwiLi4vLi4vLi4vLi4vLi4vd2luZHdhbGtlci91bmljb3JuL2Fzc2V0cy9zcmMvY29tcG9zYWJsZS91c2VIdHRwLnRzIiwiLi4vLi4vLi4vLi4vLi4vd2luZHdhbGtlci91bmljb3JuL2Fzc2V0cy9zcmMvY29tcG9zYWJsZS91c2VTdGFjay50cyIsIi4uLy4uLy4uLy4uLy4uL3dpbmR3YWxrZXIvdW5pY29ybi9hc3NldHMvc3JjL21vZHVsZS90aW55bWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIlxuZXhwb3J0IGZ1bmN0aW9uIGlzUGxhaW5PYmplY3QodmFsOiBhbnkpOiB2YWwgaXMgUmVjb3JkPHN0cmluZywgYW55PiB7XG4gIHJldHVybiB2YWwgJiYgdHlwZW9mIHZhbCA9PT0gXCJvYmplY3RcIiAmJiAhQXJyYXkuaXNBcnJheSh2YWwpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VEZWVwPFQgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+Pih0YXJnZXQ6IFBhcnRpYWw8VD4sIC4uLnNvdXJjZXM6IGFueVtdKTogVCB7XG4gIGxldCBvdXQ6IGFueSA9IGlzUGxhaW5PYmplY3QodGFyZ2V0KSA/IHsgLi4udGFyZ2V0IH0gOiB0YXJnZXQ7XG5cbiAgZm9yIChjb25zdCBzb3VyY2Ugb2Ygc291cmNlcykge1xuICAgIGlmIChBcnJheS5pc0FycmF5KHNvdXJjZSkpIHtcbiAgICAgIG91dCA9IChBcnJheS5pc0FycmF5KG91dCkgPyBvdXQuY29uY2F0KHNvdXJjZSkgOiBzb3VyY2UpIGFzIFQ7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgaWYgKGlzUGxhaW5PYmplY3Qoc291cmNlKSkge1xuICAgICAgb3V0ID0geyAuLi4oaXNQbGFpbk9iamVjdChvdXQpID8gb3V0IDoge30pIH07XG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhzb3VyY2UpKSB7XG4gICAgICAgIG91dFtrZXldID1cbiAgICAgICAgICBrZXkgaW4gb3V0ID8gbWVyZ2VEZWVwKG91dFtrZXldLCBzb3VyY2Vba2V5XSkgOiBzb3VyY2Vba2V5XTtcbiAgICAgIH1cbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBvdXQgPSBzb3VyY2UgYXMgVDtcbiAgfVxuICByZXR1cm4gb3V0O1xufVxuIiwiZGVjbGFyZSB0eXBlIFN0YWNrSGFuZGxlcjxUPiA9IChzdGFjazogU3RhY2s8VD4sIGxlbmd0aDogbnVtYmVyKSA9PiB2b2lkO1xuXG5kZWNsYXJlIHR5cGUgU3RhY2tWYWx1ZTxWPiA9IFYgfCB0cnVlO1xuXG5leHBvcnQgY2xhc3MgU3RhY2s8VCA9IGFueT4ge1xuICBvYnNlcnZlcnM6IHsgaGFuZGxlcjogU3RhY2tIYW5kbGVyPFQ+LCBvbmNlOiBib29sZWFuIH1bXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBzdG9yZTogU3RhY2tWYWx1ZTxUPltdID0gW10pIHtcbiAgICAvL1xuICB9XG5cbiAgcHVzaCh2YWx1ZT86IFQpOiBudW1iZXIge1xuICAgIGNvbnN0IHIgPSB0aGlzLnN0b3JlLnB1c2godmFsdWUgPz8gdHJ1ZSk7XG5cbiAgICB0aGlzLm5vdGljZSgpO1xuXG4gICAgcmV0dXJuIHI7XG4gIH1cblxuICBwb3AoKTogVCB8IHRydWUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHIgPSB0aGlzLnN0b3JlLnBvcCgpO1xuXG4gICAgdGhpcy5ub3RpY2UoKTtcblxuICAgIHJldHVybiByO1xuICB9XG5cbiAgY2xlYXIoKTogdGhpcyB7XG4gICAgdGhpcy5zdG9yZSA9IFtdO1xuXG4gICAgdGhpcy5ub3RpY2UoKTtcblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgaXNFbXB0eSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5sZW5ndGggPT09IDA7XG4gIH1cblxuICBnZXQgbGVuZ3RoKCkge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLmxlbmd0aDtcbiAgfVxuXG4gIHBlZWsoKTogU3RhY2tWYWx1ZTxUPltdIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZTtcbiAgfVxuXG4gIG9ic2VydmUoaGFuZGxlcjogKHN0YWNrOiBTdGFjaywgbGVuZ3RoOiBudW1iZXIpID0+IHZvaWQpOiAoKSA9PiB2b2lkIHtcbiAgICB0aGlzLm9ic2VydmVycy5wdXNoKHtcbiAgICAgIGhhbmRsZXIsXG4gICAgICBvbmNlOiBmYWxzZVxuICAgIH0pO1xuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIHRoaXMub2ZmKGhhbmRsZXIpO1xuICAgIH07XG4gIH1cblxuICBvbmNlKGhhbmRsZXI6IFN0YWNrSGFuZGxlcjxUPik6ICgpID0+IHZvaWQge1xuICAgIHRoaXMub2JzZXJ2ZXJzLnB1c2goe1xuICAgICAgaGFuZGxlcixcbiAgICAgIG9uY2U6IHRydWVcbiAgICB9KTtcblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICB0aGlzLm9mZihoYW5kbGVyKTtcbiAgICB9O1xuICB9XG5cbiAgbm90aWNlKCk6IHRoaXMge1xuICAgIHRoaXMub2JzZXJ2ZXJzLmZvckVhY2goKG9ic2VydmVyKSA9PiB7XG4gICAgICBvYnNlcnZlci5oYW5kbGVyKHRoaXMsIHRoaXMubGVuZ3RoKTtcbiAgICB9KTtcblxuICAgIHRoaXMub2JzZXJ2ZXJzID0gdGhpcy5vYnNlcnZlcnMuZmlsdGVyKChvYnNlcnZlcikgPT4gb2JzZXJ2ZXIub25jZSAhPT0gdHJ1ZSk7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIG9mZihjYWxsYmFjaz86IFN0YWNrSGFuZGxlcjxUPik6IHRoaXMge1xuICAgIHRoaXMub2JzZXJ2ZXJzID0gdGhpcy5vYnNlcnZlcnMuZmlsdGVyKChvYnNlcnZlcikgPT4gb2JzZXJ2ZXIuaGFuZGxlciAhPT0gY2FsbGJhY2spO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdGFjazxUID0gYW55PihzdG9yZTogYW55W10gPSBbXSkge1xuICByZXR1cm4gbmV3IFN0YWNrPFQ+KHN0b3JlKTtcbn1cbiIsImltcG9ydCB7IERpY3Rpb25hcnkgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBpbmplY3RDc3NUb0RvY3VtZW50IH0gZnJvbSAnLi8nO1xuXG5leHBvcnQgZnVuY3Rpb24gdXNlU2NyaXB0SW1wb3J0KHNyYzogc3RyaW5nLCBhdHRyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9KTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICBzY3JpcHQuc3JjID0gcmVzb2x2ZVVybChzcmMpO1xuXG4gIGZvciAoY29uc3Qga2V5IGluIGF0dHJzKSB7XG4gICAgc2NyaXB0LnNldEF0dHJpYnV0ZShrZXksIGF0dHJzW2tleV0pO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBzY3JpcHQub25sb2FkID0gKCkgPT4ge1xuICAgICAgcmVzb2x2ZSgpO1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzY3JpcHQpO1xuICAgIH07XG4gICAgc2NyaXB0Lm9uZXJyb3IgPSAoZSkgPT4ge1xuICAgICAgcmVqZWN0KGUpO1xuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzY3JpcHQpO1xuICAgIH07XG5cbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZG9JbXBvcnQ8VCA9IGFueT4oc3JjOiBzdHJpbmcpOiBQcm9taXNlPFQ+IHtcbiAgcmV0dXJuIGltcG9ydCgvKiBAdml0ZS1pZ25vcmUgKi9zcmMpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXNlSW1wb3J0KC4uLnNyYzogYW55W10pOiBQcm9taXNlPGFueT47XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXNlSW1wb3J0PFQgZXh0ZW5kcyBhbnlbXT4oLi4uc3JjOiBzdHJpbmdbXSk6IFByb21pc2U8VD47XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXNlSW1wb3J0PFQgPSBhbnk+KHNyYzogc3RyaW5nKTogUHJvbWlzZTx7IGRlZmF1bHQ6IFQgfT47XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXNlSW1wb3J0PEQgPSBhbnksIEMgPSBhbnk+KHNyYzogc3RyaW5nKTogUHJvbWlzZTx7IGRlZmF1bHQ6IEQgfSAmIERpY3Rpb25hcnk8Qz4+O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVzZUltcG9ydCguLi5zcmM6IGFueVtdKTogUHJvbWlzZTxhbnk+IHtcbiAgaWYgKHNyYy5sZW5ndGggPT09IDEpIHtcbiAgICByZXR1cm4gZG9JbXBvcnQoc3JjWzBdKTtcbiAgfVxuXG4gIGNvbnN0IHByb21pc2VzOiBQcm9taXNlPGFueT5bXSA9IFtdO1xuXG4gIHNyYy5mb3JFYWNoKChsaW5rKSA9PiB7XG4gICAgcHJvbWlzZXMucHVzaChcbiAgICAgIGxpbmsgaW5zdGFuY2VvZiBQcm9taXNlID8gbGluayA6IGRvSW1wb3J0KGxpbmspXG4gICAgKTtcbiAgfSk7XG5cbiAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVzZVNlcmllc0ltcG9ydCguLi5zcmM6IGFueVtdKTogUHJvbWlzZTxhbnk+O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVzZVNlcmllc0ltcG9ydDxUIGV4dGVuZHMgYW55W10+KC4uLnNyYzogc3RyaW5nW10pOiBQcm9taXNlPFQ+O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVzZVNlcmllc0ltcG9ydDxUID0gYW55PihzcmM6IHN0cmluZyk6IFByb21pc2U8eyBkZWZhdWx0OiBUIH0+O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVzZVNlcmllc0ltcG9ydDxEID0gYW55LCBDID0gYW55PihzcmM6IHN0cmluZyk6IFByb21pc2U8eyBkZWZhdWx0OiBEIH0gJiBEaWN0aW9uYXJ5PEM+PjtcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1c2VTZXJpZXNJbXBvcnQoLi4uc3JjOiBhbnlbXSk6IFByb21pc2U8YW55PiB7XG4gIGNvbnN0IG1vZHVsZXM6IGFueVtdID0gW107XG5cbiAgZm9yIChjb25zdCBzb3VyY2Ugb2Ygc3JjKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoc291cmNlKSkge1xuICAgICAgY29uc3QgbSA9IGF3YWl0IHVzZUltcG9ydCguLi5zb3VyY2UpO1xuICAgICAgbW9kdWxlcy5wdXNoKG0pO1xuXG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBjb25zdCBtID0gYXdhaXQgdXNlSW1wb3J0KHNvdXJjZSk7XG5cbiAgICBtb2R1bGVzLnB1c2gobSk7XG4gIH1cblxuICByZXR1cm4gbW9kdWxlcztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVzZUNzc0luY2x1ZGVzKC4uLmhyZWZzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZFtdPiB7XG4gIGNvbnN0IHByb21pc2VzID0gaHJlZnMubWFwKChocmVmKSA9PiB7XG4gICAgaHJlZiA9IHJlc29sdmVVcmwoaHJlZik7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTtcbiAgICAgIGxpbmsucmVsID0gJ3N0eWxlc2hlZXQnO1xuICAgICAgbGluay5ocmVmID0gaHJlZjtcbiAgICAgIGxpbmsub25sb2FkID0gKCkgPT4gcmVzb2x2ZSgpO1xuICAgICAgbGluay5vbmVycm9yID0gKGUpID0+IHJlamVjdChlKTtcblxuICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsaW5rKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbn1cblxuY29uc3QgaW1wb3J0ZWRTaGVldHM6IFJlY29yZDxzdHJpbmcsIFByb21pc2U8eyBkZWZhdWx0OiBDU1NTdHlsZVNoZWV0IH0+PiA9IHt9O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXNlQ3NzSW1wb3J0KC4uLmhyZWZzOiBzdHJpbmdbXSk6IFByb21pc2U8Q1NTU3R5bGVTaGVldFtdPiB7XG4gIC8vIFRvZG86IFVzZSBgeyBhc3NlcnQ6IHsgdHlwZTogXCJjc3NcIiB9YCBhZnRlciBhbGwgYnJvd3NlcnMgc3VwcG9ydCBpdC5cbiAgY29uc3QgbW9kdWxlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgIGhyZWZzLm1hcCgoaHJlZikgPT4ge1xuICAgICAgaWYgKCFpbXBvcnRlZFNoZWV0c1tocmVmXSkge1xuICAgICAgICBpbXBvcnRlZFNoZWV0c1tocmVmXSA9IHNpbXVsYXRlQ3NzSW1wb3J0KGhyZWYpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gaW1wb3J0ZWRTaGVldHNbaHJlZl07XG4gICAgfSlcbiAgKTtcbiAgY29uc3Qgc3R5bGVzID0gbW9kdWxlcy5tYXAobW9kdWxlID0+IG1vZHVsZS5kZWZhdWx0KTtcblxuICByZXR1cm4gaW5qZWN0Q3NzVG9Eb2N1bWVudCguLi5zdHlsZXMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaW11bGF0ZUNzc0ltcG9ydChocmVmOiBzdHJpbmcpIHtcbiAgaHJlZiA9IHJlc29sdmVVcmwoaHJlZik7XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChocmVmKTtcbiAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGxvYWQgQ1NTOiAke2hyZWZ9YCk7XG4gIH1cbiAgY29uc3QgY3NzVGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcblxuICBjb25zdCBzaGVldCA9IG5ldyBDU1NTdHlsZVNoZWV0KCk7XG4gIGF3YWl0IHNoZWV0LnJlcGxhY2UoY3NzVGV4dCk7XG4gIHJldHVybiB7IGRlZmF1bHQ6IHNoZWV0IH07XG59XG5cbmxldCBpbXBvcnRNYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbmZ1bmN0aW9uIHBhcnNlSW1wb3J0TWFwKCkge1xuICBjb25zdCBpbXBvcnRNYXBTY3JpcHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdzY3JpcHRbdHlwZT1cImltcG9ydG1hcFwiXScpO1xuICBpZiAoaW1wb3J0TWFwU2NyaXB0KSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKGltcG9ydE1hcFNjcmlwdC50ZXh0Q29udGVudCB8fCAne30nKS5pbXBvcnRzIHx8IHt9O1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBpbXBvcnQgbWFwOicsIGUpO1xuICAgIH1cbiAgfVxuICByZXR1cm4ge307XG59XG5cbmZ1bmN0aW9uIHJlc29sdmVVcmwoc3BlY2lmaWVyOiBzdHJpbmcpIHtcbiAgaW1wb3J0TWFwID8/PSBwYXJzZUltcG9ydE1hcCgpO1xuXG4gIGZvciAoY29uc3QgW3ByZWZpeCwgdGFyZ2V0XSBvZiBPYmplY3QuZW50cmllcyhpbXBvcnRNYXApKSB7XG4gICAgaWYgKHNwZWNpZmllciA9PT0gcHJlZml4KSB7XG4gICAgICByZXR1cm4gdGFyZ2V0O1xuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgW3ByZWZpeCwgdGFyZ2V0XSBvZiBPYmplY3QuZW50cmllcyhpbXBvcnRNYXApKSB7XG4gICAgaWYgKHNwZWNpZmllci5zdGFydHNXaXRoKHByZWZpeCkpIHtcbiAgICAgIHJldHVybiBzcGVjaWZpZXIucmVwbGFjZShwcmVmaXgsIHRhcmdldCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBzcGVjaWZpZXI7XG59XG4iLCJpbXBvcnQgdHlwZSB7IFVuaWNvcm5IdHRwQ2xpZW50IH0gZnJvbSAnLi4vbW9kdWxlL2h0dHAtY2xpZW50JztcbmltcG9ydCB0eXBlIHsgQXhpb3NJbnN0YW5jZSwgQ3JlYXRlQXhpb3NEZWZhdWx0cyB9IGZyb20gJ2F4aW9zJztcbmV4cG9ydCB0eXBlIHsgQXBpUmV0dXJuLCBVbmljb3JuSHR0cENsaWVudCB9IGZyb20gJy4uL21vZHVsZS9odHRwLWNsaWVudCc7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1c2VIdHRwQ2xpZW50KGNvbmZpZz86IENyZWF0ZUF4aW9zRGVmYXVsdHMgfCBBeGlvc0luc3RhbmNlKTogUHJvbWlzZTxVbmljb3JuSHR0cENsaWVudD4ge1xuICBjb25zdCB7IGNyZWF0ZUh0dHBDbGllbnQgfSA9IGF3YWl0IGltcG9ydCgnLi4vbW9kdWxlL2h0dHAtY2xpZW50Jyk7XG5cbiAgcmV0dXJuIGNyZWF0ZUh0dHBDbGllbnQoY29uZmlnIGFzIENyZWF0ZUF4aW9zRGVmYXVsdHMgfCB1bmRlZmluZWQpO1xufVxuIiwiXG5pbXBvcnQgeyBEaWN0aW9uYXJ5IH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgU3RhY2ssIHN0YWNrIH0gZnJvbSAnQGx5cmFzb2Z0L3RzLXRvb2xraXQvZ2VuZXJpYyc7XG5cbmNvbnN0IHN0YWNrczogRGljdGlvbmFyeTxTdGFjaz4gPSB7fTtcblxuZXhwb3J0IGZ1bmN0aW9uIHVzZVN0YWNrPFQgPSBhbnk+KG5hbWU6IHN0cmluZyA9ICdkZWZhdWx0Jywgc3RvcmU6IGFueVtdID0gW10pOiBTdGFjazxUPiB7XG4gIHJldHVybiBzdGFja3NbbmFtZV0gPz89IGNyZWF0ZVN0YWNrPFQ+KHN0b3JlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVN0YWNrPFQgPSBhbnk+KHN0b3JlOiBhbnlbXSA9IFtdKTogU3RhY2s8VD4ge1xuICByZXR1cm4gc3RhY2s8VD4oc3RvcmUpO1xufVxuIiwiaW1wb3J0IHR5cGUgeyBFZGl0b3IsIEVkaXRvck9wdGlvbnMsIFRpbnlNQ0UgfSBmcm9tICd0aW55bWNlJztcbmltcG9ydCB7IHVzZUh0dHBDbGllbnQsIHVzZVN0YWNrIH0gZnJvbSAnLi4vY29tcG9zYWJsZSc7XG5pbXBvcnQgeyB1c2VJbXBvcnQsIHVzZVNjcmlwdEltcG9ydCB9IGZyb20gJy4uL3NlcnZpY2UnO1xuaW1wb3J0IHsgRGljdGlvbmFyeSwgTWF5YmVQcm9taXNlIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgbWVyZ2VEZWVwIH0gZnJvbSAnLi4vdXRpbGl0aWVzJztcblxuY29uc3QgaW5zdGFuY2VzOiBEaWN0aW9uYXJ5PFRpbnltY2VDb250cm9sbGVyPiA9IHt9O1xubGV0IGhvb2tzOiAoKHRpbnltY2U6IFRpbnlNQ0UpID0+IE1heWJlUHJvbWlzZTxhbnk+KVtdID0gW107XG5cbmxldCBpbXBvcnRlZCA9IGZhbHNlO1xuXG5kZWNsYXJlIHR5cGUgVXBsb2FkSGFuZGxlclBhcmFtcyA9IFBhcmFtZXRlcnM8Tm9uTnVsbGFibGU8RWRpdG9yT3B0aW9uc1snaW1hZ2VzX3VwbG9hZF9oYW5kbGVyJ10+PjtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldChcbiAgc2VsZWN0b3I6IHN0cmluZyxcbiAgb3B0aW9uczogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9XG4pOiBQcm9taXNlPFRpbnltY2VDb250cm9sbGVyPiB7XG4gIHJldHVybiBpbnN0YW5jZXNbc2VsZWN0b3JdID8/PSBhd2FpdCBjcmVhdGUoZG9jdW1lbnQucXVlcnlTZWxlY3RvcjxIVE1MRWxlbWVudD4oc2VsZWN0b3IpISwgb3B0aW9ucyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGUoXG4gIHNlbGVjdG9yOiBzdHJpbmcgfCBIVE1MRWxlbWVudCxcbiAgb3B0aW9uczogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9XG4pOiBQcm9taXNlPFRpbnltY2VDb250cm9sbGVyPiB7XG4gIGNvbnN0IHRpbnltY2UgPSBhd2FpdCBsb2FkVGlueW1jZSgpO1xuICBsZXQgZWw6IEhUTUxFbGVtZW50O1xuXG4gIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7XG4gICAgZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yPEhUTUxFbGVtZW50PihzZWxlY3RvcikhO1xuICB9IGVsc2Uge1xuICAgIGVsID0gc2VsZWN0b3I7XG4gIH1cblxuICByZXR1cm4gbmV3IFRpbnltY2VDb250cm9sbGVyKHRpbnltY2UsIGVsLCBvcHRpb25zKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlc3Ryb3koc2VsZWN0b3I6IHN0cmluZyk6IHZvaWQge1xuICBkZWxldGUgaW5zdGFuY2VzW3NlbGVjdG9yXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZEhvb2soaGFuZGxlcjogKCh0aW55bWNlOiBUaW55TUNFKSA9PiBNYXliZVByb21pc2U8YW55PikpIHtcbiAgaG9va3MucHVzaChoYW5kbGVyKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFySG9va3MoKSB7XG4gIGhvb2tzID0gW107XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvYWRUaW55bWNlKCk6IFByb21pc2U8VGlueU1DRT4ge1xuICBpZiAoaW1wb3J0ZWQpIHtcbiAgICByZXR1cm4gdGlueW1jZTtcbiAgfVxuXG4gIGF3YWl0IHVzZVNjcmlwdEltcG9ydCgnQHRpbnltY2UnKTtcblxuICBmb3IgKGNvbnN0IGhvb2sgb2YgaG9va3MpIHtcbiAgICBob29rKHRpbnltY2UpO1xuICB9XG4gIGF3YWl0IHJlZ2lzdGVyRHJhZ1BsdWdpbih0aW55bWNlKTtcbiAgaW1wb3J0ZWQgPSB0cnVlO1xuICByZXR1cm4gdGlueW1jZTtcbn1cblxuY29uc3QgZGVmYXVsdE9wdGlvbnM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcblxuZXhwb3J0IGNsYXNzIFRpbnltY2VDb250cm9sbGVyIHtcbiAgZWRpdG9yPzogRWRpdG9yO1xuICBvcHRpb25zOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHRpbnltY2U6IFRpbnlNQ0UsIHB1YmxpYyBlbGVtZW50OiBIVE1MRWxlbWVudCwgb3B0aW9uczogUmVjb3JkPHN0cmluZywgYW55Pikge1xuICAgIG9wdGlvbnMudGFyZ2V0ID0gZWxlbWVudDtcblxuICAgIHRoaXMub3B0aW9ucyA9IG1lcmdlRGVlcChcbiAgICAgIHtcbiAgICAgICAgdW5pY29ybjoge1xuICAgICAgICAgIHN0YWNrX25hbWU6ICd1cGxvYWRpbmcnXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBkZWZhdWx0T3B0aW9ucyxcbiAgICAgIHRoaXMucHJlcGFyZU9wdGlvbnMob3B0aW9ucywgdGlueW1jZS5tYWpvclZlcnNpb24pLFxuICAgICk7XG5cbiAgICB0aW55bWNlLkVkaXRvck1hbmFnZXIuaW5pdCh0aGlzLm9wdGlvbnMpLnRoZW4oKGVkaXRvcikgPT4ge1xuICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3JbMF07XG4gICAgfSk7XG4gIH1cblxuICBwcmVwYXJlT3B0aW9ucyhvcHRpb25zOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LCB2ZXJzaW9uID0gJzYnKSB7XG4gICAgY29uc3QgZGVmYXVsdHM6IFBhcnRpYWw8RWRpdG9yT3B0aW9ucz4gPSB7fTtcblxuICAgIGlmIChvcHRpb25zLmltYWdlc191cGxvYWRfdXJsKSB7XG4gICAgICBkZWZhdWx0cy5wYXN0ZV9kYXRhX2ltYWdlcyA9IHRydWU7XG4gICAgICBkZWZhdWx0cy5yZW1vdmVfc2NyaXB0X2hvc3QgPSBmYWxzZTtcbiAgICAgIGRlZmF1bHRzLnJlbGF0aXZlX3VybHMgPSBmYWxzZTtcblxuICAgICAgaWYgKE51bWJlcih2ZXJzaW9uKSA+PSA2KSB7XG4gICAgICAgIGRlZmF1bHRzLmltYWdlc191cGxvYWRfaGFuZGxlciA9IChibG9iSW5mbywgcHJvZ3Jlc3MpID0+XG4gICAgICAgICAgdGhpcy5pbWFnZVVwbG9hZEhhbmRsZXIoYmxvYkluZm8sIHByb2dyZXNzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdGlvbnMucGx1Z2lucy5wdXNoKCdwYXN0ZScpO1xuXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgZGVmYXVsdHMuaW1hZ2VzX3VwbG9hZF9oYW5kbGVyID0gKGJsb2JJbmZvLCBzdWNjZXNzLCBmYWlsdXJlLCBwcm9ncmVzcykgPT5cbiAgICAgICAgICB0aGlzLmltYWdlVXBsb2FkSGFuZGxlcihibG9iSW5mbywgcHJvZ3Jlc3MpXG4gICAgICAgICAgICAudGhlbigodXJsKSA9PiB7XG4gICAgICAgICAgICAgIHN1Y2Nlc3ModXJsKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHVybDtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgICAgZmFpbHVyZShlLm1lc3NhZ2UsIHsgcmVtb3ZlOiB0cnVlIH0pO1xuICAgICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gZGVmYXVsdHMuZmlsZV9waWNrZXJfY2FsbGJhY2sgPSAoLi4uYXJncykgPT4gdGhpcy5maWxlUGlja2VyQ2FsbGJhY2soLi4uYXJncyk7XG5cbiAgICBkZWZhdWx0cy5wbHVnaW5zID0gZGVmYXVsdHMucGx1Z2lucyB8fCBbXTtcblxuICAgIGRlZmF1bHRzLnNldHVwID0gKGVkaXRvcikgPT4ge1xuICAgICAgZWRpdG9yLm9uKCdjaGFuZ2UnLCAoKSA9PiB7XG4gICAgICAgIHRoaXMudGlueW1jZS50cmlnZ2VyU2F2ZSgpO1xuICAgICAgfSk7XG4gICAgfTtcblxuICAgIG9wdGlvbnMgPSBtZXJnZURlZXAoe30sIGRlZmF1bHRzLCBvcHRpb25zKTtcblxuICAgIGlmIChvcHRpb25zLnBsdWdpbnMuaW5kZXhPZigndW5pY29ybmRyYWdkcm9wJykgPT09IC0xKSB7XG4gICAgICBvcHRpb25zLnBsdWdpbnMucHVzaCgndW5pY29ybmRyYWdkcm9wJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9wdGlvbnM7XG4gIH1cblxuICBpbnNlcnQodGV4dDogc3RyaW5nKSB7XG4gICAgdGhpcy5lZGl0b3I/Lmluc2VydENvbnRlbnQodGV4dCk7XG4gIH1cblxuICBnZXRWYWx1ZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmVkaXRvcj8uZ2V0Q29udGVudCgpID8/ICcnO1xuICB9XG5cbiAgc2V0VmFsdWUodGV4dDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5lZGl0b3I/LnNldENvbnRlbnQodGV4dCk7XG4gIH1cblxuICAvLyBmaWxlUGlja2VyQ2FsbGJhY2soY2FsbGJhY2ssIHZhbHVlLCBtZXRhKSB7XG4gIC8vICAgY29uc3QgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAvLyAgIGlucHV0LnNldEF0dHJpYnV0ZSgndHlwZScsICdmaWxlJyk7XG4gIC8vICAgaW5wdXQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgLy9cbiAgLy8gICBpZiAobWV0YS5maWxldHlwZSA9PT0gJ2ltYWdlJykge1xuICAvLyAgICAgaW5wdXQuc2V0QXR0cmlidXRlKCdhY2NlcHQnLCBgaW1hZ2UvXFwqYCk7XG4gIC8vICAgfVxuICAvL1xuICAvLyAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaW5wdXQpO1xuICAvL1xuICAvLyAgIGlucHV0Lm9uY2hhbmdlID0gZnVuY3Rpb24gKCkge1xuICAvLyAgICAgY29uc3QgZmlsZSA9IHRoaXMuZmlsZXNbMF07XG4gIC8vXG4gIC8vICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAvLyAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgLy8gICAgICAgY29uc3QgaWQgPSAnYmxvYmlkJyArIChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG4gIC8vICAgICAgIGNvbnN0IGJsb2JDYWNoZSA9ICB0aW55bWNlLmFjdGl2ZUVkaXRvci5lZGl0b3JVcGxvYWQuYmxvYkNhY2hlO1xuICAvLyAgICAgICBjb25zdCBiYXNlNjQgPSByZWFkZXIucmVzdWx0LnNwbGl0KCcsJylbMV07XG4gIC8vICAgICAgIGNvbnN0IGJsb2JJbmZvID0gYmxvYkNhY2hlLmNyZWF0ZShpZCwgZmlsZSwgYmFzZTY0KTtcbiAgLy8gICAgICAgYmxvYkNhY2hlLmFkZChibG9iSW5mbyk7XG4gIC8vXG4gIC8vICAgICAgIC8qIGNhbGwgdGhlIGNhbGxiYWNrIGFuZCBwb3B1bGF0ZSB0aGUgVGl0bGUgZmllbGQgd2l0aCB0aGUgZmlsZSBuYW1lICovXG4gIC8vICAgICAgIGNhbGxiYWNrKGJsb2JJbmZvLmJsb2JVcmkoKSwgeyB0aXRsZTogZmlsZS5uYW1lLCB0ZXh0OiBmaWxlLm5hbWUgfSk7XG4gIC8vICAgICB9O1xuICAvLyAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSk7XG4gIC8vICAgICBpbnB1dC5yZW1vdmUoKTtcbiAgLy8gICB9O1xuICAvL1xuICAvLyAgIGlucHV0LmNsaWNrKCk7XG4gIC8vIH1cblxuICBhc3luYyBpbWFnZVVwbG9hZEhhbmRsZXIoYmxvYkluZm86IFVwbG9hZEhhbmRsZXJQYXJhbXNbMF0sIHByb2dyZXNzOiBVcGxvYWRIYW5kbGVyUGFyYW1zWzFdKSB7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZWxlbWVudDtcblxuICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3VwbG9hZC1zdGFydCcpKTtcblxuICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgYmxvYkluZm8uYmxvYigpLCBibG9iSW5mby5maWxlbmFtZSgpKTtcblxuICAgIGNvbnN0IHN0YWNrID0gdXNlU3RhY2sodGhpcy5vcHRpb25zLnVuaWNvcm4uc3RhY2tfbmFtZSk7XG4gICAgc3RhY2sucHVzaCh0cnVlKTtcblxuICAgIGNvbnN0IHsgcG9zdCwgaXNBeGlvc0Vycm9yIH0gPSBhd2FpdCB1c2VIdHRwQ2xpZW50KCk7XG5cbiAgICB0cnkge1xuICAgICAgbGV0IHJlcyA9IGF3YWl0IHBvc3QoXG4gICAgICAgIHRoaXMub3B0aW9ucy5pbWFnZXNfdXBsb2FkX3VybCxcbiAgICAgICAgZm9ybURhdGEsXG4gICAgICAgIHtcbiAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IGZhbHNlLFxuICAgICAgICAgIG9uVXBsb2FkUHJvZ3Jlc3M6IChlKSA9PiB7XG4gICAgICAgICAgICBwcm9ncmVzcyhlLmxvYWRlZCAvIGUudG90YWwhICogMTAwKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCd1cGxvYWQtc3VjY2VzcycpKTtcblxuICAgICAgcmV0dXJuIHJlcy5kYXRhLmRhdGEudXJsO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGlzQXhpb3NFcnJvcihlcnIpKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnI/LnJlc3BvbnNlPy5kYXRhPy5tZXNzYWdlIHx8IGVyci5tZXNzYWdlO1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycj8ucmVzcG9uc2U/LmRhdGE/Lm1lc3NhZ2UgfHwgZXJyLm1lc3NhZ2UsIGVycik7XG4gICAgICAgIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3VwbG9hZC1lcnJvcicsIHsgZGV0YWlsOiBlcnIgfSkpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh7IG1lc3NhZ2UsIHJlbW92ZTogdHJ1ZSB9KTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgZXJyO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCd1cGxvYWQtY29tcGxldGUnKSk7XG4gICAgICBzdGFjay5wb3AoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVnaXN0ZXJEcmFnUGx1Z2luKHRpbnltY2U6IFRpbnlNQ0UpIHtcbiAgdGlueW1jZS5QbHVnaW5NYW5hZ2VyLmFkZCgndW5pY29ybmRyYWdkcm9wJywgZnVuY3Rpb24gKGVkaXRvcikge1xuICAgIC8vIFJlc2V0IHRoZSBkcm9wIGFyZWEgYm9yZGVyXG4gICAgdGlueW1jZS5ET00uYmluZChkb2N1bWVudCwgJ2RyYWdsZWF2ZScsIGZ1bmN0aW9uIChlKSB7XG4gICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICBpZiAodGlueW1jZS5hY3RpdmVFZGl0b3IpIHtcbiAgICAgICAgdGlueW1jZS5hY3RpdmVFZGl0b3IuY29udGVudEFyZWFDb250YWluZXIuc3R5bGUudHJhbnNpdGlvbiA9ICdhbGwgLjNzJztcbiAgICAgICAgdGlueW1jZS5hY3RpdmVFZGl0b3IuY29udGVudEFyZWFDb250YWluZXIuc3R5bGUuYm9yZGVyV2lkdGggPSAnJztcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0pO1xuXG4gICAgaWYgKHR5cGVvZiBGb3JtRGF0YSAhPT0gJ3VuZGVmaW5lZCcpIHtcblxuICAgICAgLy8gRml4IGZvciBDaHJvbWVcbiAgICAgIGVkaXRvci5vbignZHJhZ2VudGVyJywgZSA9PiB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBOb3RpZnkgdXNlciB3aGVuIGZpbGUgaXMgb3ZlciB0aGUgZHJvcCBhcmVhXG4gICAgICBlZGl0b3Iub24oJ2RyYWdvdmVyJywgZSA9PiB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICBpZiAodGlueW1jZS5hY3RpdmVFZGl0b3IpIHtcbiAgICAgICAgICB0aW55bWNlLmFjdGl2ZUVkaXRvci5jb250ZW50QXJlYUNvbnRhaW5lci5zdHlsZS50cmFuc2l0aW9uID0gJ2FsbCAuM3MnO1xuICAgICAgICAgIHRpbnltY2UuYWN0aXZlRWRpdG9yLmNvbnRlbnRBcmVhQ29udGFpbmVyLnN0eWxlLmJvcmRlciA9ICczcHggZGFzaGVkIHJnYmEoMCwgMCwgMCwgLjM1KSc7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9KTtcblxuICAgICAgZWRpdG9yLm9uKCdkcm9wJywgZSA9PiB7XG4gICAgICAgIGVkaXRvci5jb250ZW50QXJlYUNvbnRhaW5lci5zdHlsZS5ib3JkZXJXaWR0aCA9ICcnO1xuICAgICAgICBlZGl0b3IuY29udGVudEFyZWFDb250YWluZXIuc3R5bGUuYm9yZGVyV2lkdGggPSAnJztcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRpbnltY2VNb2R1bGUge1xuICBnZXQ6IHR5cGVvZiBnZXQ7XG4gIGNyZWF0ZTogdHlwZW9mIGNyZWF0ZTtcbiAgZGVzdHJveTogdHlwZW9mIGRlc3Ryb3k7XG4gIGFkZEhvb2s6IHR5cGVvZiBhZGRIb29rO1xuICBjbGVhckhvb2tzOiB0eXBlb2YgY2xlYXJIb29rcztcbiAgVGlueW1jZUNvbnRyb2xsZXI6IHR5cGVvZiBUaW55bWNlQ29udHJvbGxlcjtcbn1cblxuZGVjbGFyZSBnbG9iYWwge1xuICB2YXIgdGlueW1jZTogVGlueU1DRTtcbn1cbiJdLCJmaWxlIjoiY2h1bmtzL3RpbnltY2UuanMifQ==